<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PJEP.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.util</a> &gt; <span class="el_source">PJEP.java</span></div><h1>PJEP.java</h1><pre class="source lang-java linenums">/*
 * PJEP.java
 * Copyright 2003 (C) Greg Bingleman &lt;byngl@hotmail.com&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.util;

import java.util.ArrayList;
import java.util.List;
import java.util.Stack;

import pcgen.core.PlayerCharacter;
import pcgen.core.VariableProcessor;
import pcgen.persistence.lst.LstUtils;
import pcgen.system.PluginLoader;

import org.nfunk.jep.ASTFunNode;
import org.nfunk.jep.JEP;
import org.nfunk.jep.Node;
import org.nfunk.jep.ParseException;
import org.nfunk.jep.function.PostfixMathCommand;

/**
 * {@code PJEP}
 *
 *
 * Provides a common interface setup for Singular Systems' Java Mathematical Expression Parser.
 *
 * Provides the following functions:
 *   ceil, floor, getvar, var, max, min, if, roll, cl, charbonusto
 *
 * Provides the following variables:
 *   FALSE, TRUE
 */
public final class PJEP extends JEP
{
	private Object parent;
	private String variableSource;
<span class="fc" id="L52">	private static List&lt;Class&lt;PCGenCommand&gt;&gt; commandList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L53">	private List&lt;PCGenCommand&gt; localCommandList = new ArrayList&lt;&gt;();</span>

	public static void addCommand(Class&lt;PCGenCommand&gt; clazz)
	{
<span class="nc" id="L57">		commandList.add(clazz);</span>
<span class="nc" id="L58">	}</span>

	public static PluginLoader getJepPluginLoader()
	{
<span class="nc" id="L62">		return new PluginLoader()</span>
<span class="nc" id="L63">		{</span>

			@Override
			public void loadPlugin(Class clazz)
			{
<span class="nc" id="L68">				addCommand(clazz);</span>
<span class="nc" id="L69">			}</span>

			@Override
			public Class[] getPluginClasses()
			{
<span class="nc" id="L74">				return new Class[]{PCGenCommand.class};</span>
			}
		};
	}

	public PJEP()
<span class="nc" id="L80">	{</span>
<span class="nc" id="L81">		setAllowUndeclared(true);</span>
<span class="nc" id="L82">		addStandardFunctions();</span>

<span class="nc bnc" id="L84" title="All 2 branches missed.">		for (Class&lt;PCGenCommand&gt; aClass : commandList)</span>
		{
			try
			{
<span class="nc" id="L88">				PCGenCommand com = aClass.newInstance();</span>
<span class="nc" id="L89">				localCommandList.add(com);</span>
<span class="nc" id="L90">				addFunction(com.getFunctionName().toLowerCase(), com);</span>
<span class="nc" id="L91">				addFunction(com.getFunctionName().toUpperCase(), com);</span>
			}
<span class="nc" id="L93">			catch (InstantiationException | IllegalAccessException e)</span>
			{
<span class="nc" id="L95">				Logging.errorPrint(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L96">			}</span>
<span class="nc" id="L97">		}</span>

<span class="nc" id="L99">		addFunction(&quot;cl&quot;, new ClassLevel());</span>

<span class="nc" id="L101">		addVariable(&quot;TRUE&quot;, 1);</span>
<span class="nc" id="L102">		addVariable(&quot;FALSE&quot;, 0);</span>
<span class="nc" id="L103">	}</span>

	@Override
	public Node parseExpression(String expression_in)
	{
<span class="nc bnc" id="L108" title="All 2 branches missed.">		if (updateVariables())</span>
		{
<span class="nc" id="L110">			initSymTab();</span>
		}

<span class="nc" id="L113">		return super.parseExpression(expression_in);</span>
	}

	/**
	 * Identify if the results of the calculation will be cachable.
	 *
	 * @return True if the result would be cachable, false otherwise.
	 */
	public boolean isResultCachable()
	{

<span class="nc" id="L124">		return isResultCachable(getTopNode());</span>
	}

	/**
	 * Identify if results from this node (and its children) are all cachable.
	 *
	 * @param node The node to be checked.
	 * @return True if the result would be cachable, false otherwise.
	 */
	public boolean isResultCachable(Node node)
	{
<span class="nc bnc" id="L135" title="All 2 branches missed.">		if (node instanceof ASTFunNode funcNode)</span>
		{
<span class="nc bnc" id="L137" title="All 2 branches missed.">			if (funcNode.getPFMC() instanceof PCGenCommand cmd)</span>
			{
<span class="nc bnc" id="L139" title="All 2 branches missed.">				if (!cmd.getCachable())</span>
				{
<span class="nc" id="L141">					return false;</span>
				}
			}
		}
<span class="nc bnc" id="L145" title="All 2 branches missed.">		for (int i = 0; i &lt; node.jjtGetNumChildren(); i++)</span>
		{
<span class="nc bnc" id="L147" title="All 2 branches missed.">			if (!isResultCachable(node.jjtGetChild(i)))</span>
			{
<span class="nc" id="L149">				return false;</span>
			}
		}

<span class="nc" id="L153">		return true;</span>
	}

	private boolean updateVariables()
	{
<span class="nc" id="L158">		boolean updated = true;</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">		if (localCommandList != null)</span>
		{
<span class="nc bnc" id="L161" title="All 2 branches missed.">			for (PCGenCommand com : localCommandList)</span>
			{
<span class="nc bnc" id="L163" title="All 4 branches missed.">				updated = updated &amp;&amp; !com.updateVariables(this);</span>
<span class="nc" id="L164">			}</span>
		}
<span class="nc" id="L166">		return updated;</span>
	}

	/**
	 * @deprecated
	 * eg. cl(&quot;Fighter&quot;)
	 * eg. cl(&quot;Fighter&quot;, 21)
	 * eg. cl()
	 */
	@Deprecated
	private final class ClassLevel extends PostfixMathCommand
	{
		private ClassLevel()
<span class="nc" id="L179">		{</span>
<span class="nc" id="L180">			numberOfParameters = -1;</span>
<span class="nc" id="L181">		}</span>

		/**
		 * Runs classlevel on the inStack. The parameter is popped
		 * off the {@code inStack}, and the variable's value is
		 * pushed back to the top of {@code inStack}.
		 * 
		 * @param inStack The stack to process
		 * 
		 * @throws ParseException
		 */
		//		@SuppressWarnings(&quot;unchecked&quot;) //Uses JEP, which doesn't use generics
		@Override
		public void run(Stack inStack) throws ParseException
		{
<span class="nc" id="L196">			LstUtils.deprecationWarning(&quot;Jep function cl deprecated, use classlevel instead&quot;);</span>

			// check the stack
<span class="nc" id="L199">			checkStack(inStack);</span>

			// get the parameter from the stack

<span class="nc" id="L203">			int paramCount = curNumberOfParameters;</span>

			// If there are no parameters and this is used in a CLASS file,
			// then use the class name

<span class="nc bnc" id="L208" title="All 2 branches missed.">			if (paramCount == 0)</span>
			{
<span class="nc" id="L210">				String src = getVariableSource();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">				if (src.startsWith(&quot;CLASS:&quot;))</span>
				{
<span class="nc" id="L213">					src = src.substring(6);</span>
<span class="nc" id="L214">					inStack.push(src);</span>
<span class="nc" id="L215">					++paramCount;</span>
				}
			}

			//
			// have to do this in reverse order...this is a stack afterall
			//
			Object param1;
<span class="nc" id="L223">			Object param2 = null;</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">			if (paramCount == 1)</span>
			{
<span class="nc" id="L226">				param1 = inStack.pop();</span>
			}
<span class="nc bnc" id="L228" title="All 2 branches missed.">			else if (paramCount == 2)</span>
			{
<span class="nc" id="L230">				param2 = inStack.pop();</span>
<span class="nc" id="L231">				param1 = inStack.pop();</span>

<span class="nc bnc" id="L233" title="All 2 branches missed.">				if (param2 instanceof Integer)</span>
				{
					// Nothing to do, it's already an Integer
<span class="nc" id="L236">					Logging.debugPrint(&quot;Nothing to do, it's already an Integer.&quot;);</span>
				}
<span class="nc bnc" id="L238" title="All 2 branches missed.">				else if (param2 instanceof Double)</span>
				{
<span class="nc" id="L240">					param2 = ((Double) param2).intValue();</span>
				}
				else
				{
<span class="nc" id="L244">					throw new ParseException(&quot;Invalid parameter type&quot;);</span>
				}
			}
			else
			{
<span class="nc" id="L249">				throw new ParseException(&quot;Invalid parameter count&quot;);</span>
			}

<span class="nc bnc" id="L252" title="All 2 branches missed.">			if (param1 instanceof String cl)</span>
			{
<span class="nc" id="L254">				PlayerCharacter aPC = null;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">				if (parent instanceof VariableProcessor)</span>
				{
<span class="nc" id="L257">					aPC = ((VariableProcessor) parent).getPc();</span>
				}
<span class="nc bnc" id="L259" title="All 2 branches missed.">				else if (parent instanceof PlayerCharacter)</span>
				{
<span class="nc" id="L261">					aPC = (PlayerCharacter) parent;</span>
				}
<span class="nc bnc" id="L263" title="All 2 branches missed.">				if (aPC == null)</span>
				{
<span class="nc" id="L265">					throw new ParseException(&quot;Invalid parent (no PC): &quot; + parent.getClass().getName());</span>
				}

				// &quot;;BEFORELEVEL=&quot;
<span class="nc bnc" id="L269" title="All 2 branches missed.">				if (param2 != null)</span>
				{
<span class="nc" id="L271">					cl += &quot;;BEFORELEVEL=&quot; + param2.toString();</span>
				}

<span class="nc" id="L274">				inStack.push(Double.valueOf(aPC.getClassLevelString(cl, false)));</span>
<span class="nc" id="L275">			}</span>
			else
			{
<span class="nc" id="L278">				throw new ParseException(&quot;Invalid parameter type&quot;);</span>
			}
<span class="nc" id="L280">		}</span>
	}

	/**
	 * @deprecated
	 * @return Returns the variableSource.
	 */
	@Deprecated
	private String getVariableSource()
	{
<span class="nc" id="L290">		return variableSource;</span>
	}

	/**
	 * @param variableSource The variableSource to set.
	 */
	protected void setVariableSource(String variableSource)
	{
<span class="nc" id="L298">		this.variableSource = variableSource;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">		for (PCGenCommand com : localCommandList)</span>
		{
<span class="nc" id="L301">			com.setVariableSource(variableSource);</span>
<span class="nc" id="L302">		}</span>
<span class="nc" id="L303">	}</span>

	/**
	 * @param parent The parent to set.
	 */
	public void setParent(Object parent)
	{
<span class="nc" id="L310">		this.parent = parent;</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">		for (PCGenCommand com : localCommandList)</span>
		{
<span class="nc" id="L313">			com.setParent(parent);</span>
<span class="nc" id="L314">		}</span>
<span class="nc" id="L315">	}</span>

	public static void clear()
	{
<span class="fc" id="L319">		commandList.clear();</span>
<span class="fc" id="L320">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>