<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EquipmentChoiceDriver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.core.analysis</a> &gt; <span class="el_source">EquipmentChoiceDriver.java</span></div><h1>EquipmentChoiceDriver.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2008 (C) Tom Parker &lt;thpr@users.sourceforge.net&gt;
 * Copyright 2001 (C) Bryan McRoberts &lt;merton_monk@yahoo.com&gt;
 * 
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 * 
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.core.analysis;

import java.util.ArrayList;
import java.util.List;

import pcgen.cdom.enumeration.StringKey;
import pcgen.core.Equipment;
import pcgen.core.EquipmentChoice;
import pcgen.core.EquipmentModifier;
import pcgen.core.PlayerCharacter;
import pcgen.core.chooser.CDOMChooserFacadeImpl;
import pcgen.facade.core.ChooserFacade.ChooserTreeViewType;
import pcgen.system.LanguageBundle;
import pcgen.util.SignedInteger;
import pcgen.util.chooser.ChooserFactory;

public final class EquipmentChoiceDriver
{
	private EquipmentChoiceDriver()
	{
	}

	/**
	 * @param pool
	 * @param parent
	 * @param bAdd being added
	 * @return an integer where apparently (from how it's used) only 0 is significant
	 */
	public static boolean getChoice(final int pool, final Equipment parent, EquipmentModifier eqMod, final boolean bAdd,
		PlayerCharacter pc)
	{
<span class="nc" id="L50">		String choiceString = eqMod.getSafe(StringKey.CHOICE_STRING);</span>

<span class="nc bnc" id="L52" title="All 2 branches missed.">		if (choiceString.isEmpty())</span>
		{
<span class="nc" id="L54">			return true;</span>
		}

<span class="nc" id="L57">		final boolean forEqBuilder = choiceString.startsWith(&quot;EQBUILDER.&quot;);</span>

<span class="nc bnc" id="L59" title="All 4 branches missed.">		if (bAdd &amp;&amp; forEqBuilder)</span>
		{
<span class="nc" id="L61">			return true;</span>
		}

<span class="nc" id="L64">		List&lt;Object&gt; selectedList = new ArrayList&lt;&gt;(parent.getAssociationList(eqMod));</span>

<span class="nc" id="L66">		final EquipmentChoice equipChoice =</span>
<span class="nc" id="L67">				buildEquipmentChoice(pool, parent, eqMod, bAdd, forEqBuilder, selectedList.size(), pc);</span>

		int effectiveChoices;
<span class="nc bnc" id="L70" title="All 2 branches missed.">		if (equipChoice.isBAdd())</span>
		{
<span class="nc" id="L72">			effectiveChoices = selectedList.size() + equipChoice.getMaxSelect();</span>
		}
		else
		{
<span class="nc" id="L76">			effectiveChoices = selectedList.size();</span>
		}

<span class="nc" id="L79">		String title = LanguageBundle.getFormattedString(&quot;in_equipChoiceMod&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L80">			equipChoice.getTitle(), eqMod.getDisplayName(), &quot;|&quot;);</span>
<span class="nc" id="L81">		CDOMChooserFacadeImpl&lt;Object&gt; chooserFacade =</span>
<span class="nc" id="L82">				new CDOMChooserFacadeImpl&lt;&gt;(title, equipChoice.getAvailableList(), selectedList, effectiveChoices);</span>
<span class="nc" id="L83">		chooserFacade.setDefaultView(ChooserTreeViewType.NAME);</span>
<span class="nc" id="L84">		chooserFacade.setAllowsDups(equipChoice.isAllowDuplicates());</span>
<span class="nc" id="L85">		ChooserFactory.getDelegate().showGeneralChooser(chooserFacade);</span>

<span class="nc" id="L87">		selectedList = chooserFacade.getFinalSelected();</span>

<span class="nc" id="L89">		setChoice(parent, eqMod, selectedList, equipChoice);</span>

<span class="nc" id="L91">		return parent.hasAssociations(eqMod);</span>
	}

	public static void setChoice(Equipment parent, EquipmentModifier eqMod, final String choice,
		final EquipmentChoice equipChoice)
	{
<span class="nc" id="L97">		final List&lt;Object&gt; tempList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L98">		tempList.add(choice);</span>
<span class="nc" id="L99">		setChoice(parent, eqMod, tempList, equipChoice);</span>
<span class="nc" id="L100">	}</span>

	private static void setChoice(Equipment parent, EquipmentModifier eqMod, final List&lt;Object&gt; selectedList,
		final EquipmentChoice equipChoice)
	{
<span class="nc" id="L105">		parent.removeAllAssociations(eqMod);</span>

<span class="nc bnc" id="L107" title="All 2 branches missed.">        for (Object o : selectedList)</span>
        {
<span class="nc" id="L109">            String aString = String.valueOf(o);</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (equipChoice.getMinValue() &lt; equipChoice.getMaxValue())</span>
            {
<span class="nc" id="L113">                final int idx = aString.indexOf('|');</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (idx &lt; 0)</span>
                {
<span class="nc" id="L117">                    final List&lt;SignedInteger&gt; secondaryChoice = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L119" title="All 2 branches missed.">                    for (int j = equipChoice.getMinValue();j &lt;= equipChoice.getMaxValue();j +=</span>
<span class="nc" id="L120">                            equipChoice.getIncValue())</span>
                    {
<span class="nc bnc" id="L122" title="All 2 branches missed.">                        if (j != 0)</span>
                        {
<span class="nc" id="L124">                            secondaryChoice.add(new SignedInteger(j));</span>
                        }
                    }

<span class="nc" id="L128">                    String title = LanguageBundle.getFormattedString(&quot;in_equipChoiceSelectMod&quot;, aString); //$NON-NLS-1$</span>
<span class="nc" id="L129">                    CDOMChooserFacadeImpl&lt;SignedInteger&gt; chooserFacade =</span>
                            new CDOMChooserFacadeImpl&lt;&gt;(title, secondaryChoice, new ArrayList&lt;&gt;(), 1);
<span class="nc" id="L131">                    chooserFacade.setDefaultView(ChooserTreeViewType.NAME);</span>
<span class="nc" id="L132">                    chooserFacade.setAllowsDups(equipChoice.isAllowDuplicates());</span>
<span class="nc" id="L133">                    ChooserFactory.getDelegate().showGeneralChooser(chooserFacade);</span>

<span class="nc" id="L135">                    List&lt;SignedInteger&gt; chosenList = chooserFacade.getFinalSelected();</span>

<span class="nc bnc" id="L137" title="All 2 branches missed.">                    if (chosenList.isEmpty())</span>
                    {
<span class="nc" id="L139">                        continue;</span>
                    }

<span class="nc" id="L142">                    aString += ('|' + chosenList.get(0).toString());</span>
                }
            }

<span class="nc bnc" id="L146" title="All 4 branches missed.">            if (equipChoice.isAllowDuplicates() || !parent.containsAssociated(eqMod, aString))</span>
            {
<span class="nc" id="L148">                parent.addAssociation(eqMod, aString);</span>
            }
<span class="nc" id="L150">        }</span>
<span class="nc" id="L151">	}</span>

	/**
	 * Build up the details of a required choice
	 *
	 * @param   pool
	 * @param   parent the equipment this modifer will be applied to
	 * @param   bAdd is a choice being added or removed
	 * @param   forEqBuilder
	 * @param   numSelected
	 *
	 * @return  A populated EquipmentChoice object
	 */
	public static EquipmentChoice buildEquipmentChoice(final int pool, final Equipment parent, EquipmentModifier eqMod,
		final boolean bAdd, final boolean forEqBuilder, final int numSelected, PlayerCharacter pc)
	{
<span class="nc" id="L167">		final EquipmentChoice equipChoice = new EquipmentChoice(bAdd, pool);</span>
<span class="nc" id="L168">		String choiceString = eqMod.getSafe(StringKey.CHOICE_STRING);</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">		if (choiceString.isEmpty())</span>
		{
<span class="nc" id="L172">			return equipChoice;</span>
		}

<span class="nc" id="L175">		equipChoice.constructFromChoiceString(choiceString, parent, pool, numSelected, forEqBuilder, pc);</span>

<span class="nc" id="L177">		return equipChoice;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>