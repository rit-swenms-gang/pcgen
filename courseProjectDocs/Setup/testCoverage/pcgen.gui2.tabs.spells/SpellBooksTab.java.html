<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SpellBooksTab.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.tabs.spells</a> &gt; <span class="el_source">SpellBooksTab.java</span></div><h1>SpellBooksTab.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2011 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 * 
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 * 
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 * 
 */
package pcgen.gui2.tabs.spells;

import java.awt.BorderLayout;
import java.awt.event.ActionEvent;
import java.util.List;

import javax.swing.AbstractAction;
import javax.swing.Box;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTree;
import javax.swing.tree.TreePath;

import pcgen.core.PCClass;
import pcgen.facade.core.CharacterFacade;
import pcgen.facade.core.SpellFacade;
import pcgen.facade.core.SpellSupportFacade;
import pcgen.facade.core.SpellSupportFacade.RootNode;
import pcgen.facade.core.SpellSupportFacade.SpellNode;
import pcgen.facade.core.SpellSupportFacade.SuperNode;
import pcgen.facade.util.ListFacade;
import pcgen.gui2.filter.Filter;
import pcgen.gui2.filter.FilterBar;
import pcgen.gui2.filter.FilterButton;
import pcgen.gui2.filter.FilterUtilities;
import pcgen.gui2.filter.FilteredTreeViewTable;
import pcgen.gui2.filter.SearchFilterPanel;
import pcgen.gui2.tabs.CharacterInfoTab;
import pcgen.gui2.tabs.TabTitle;
import pcgen.gui2.tabs.models.CharacterComboBoxModel;
import pcgen.gui2.tools.FlippingSplitPane;
import pcgen.gui2.tools.Icons;
import pcgen.gui2.tools.InfoPane;
import pcgen.gui2.util.JTreeViewTable;
import pcgen.gui2.util.table.SortableTableModel;
import pcgen.gui2.util.table.SortableTableRowSorter;
import pcgen.gui2.util.treeview.TreeViewModel;
import pcgen.system.LanguageBundle;
import pcgen.util.enumeration.Tab;

import org.apache.commons.lang3.StringUtils;

@SuppressWarnings(&quot;serial&quot;)
public class SpellBooksTab extends FlippingSplitPane implements CharacterInfoTab
{

<span class="nc" id="L68">	private final TabTitle tabTitle = new TabTitle(Tab.SPELLBOOKS);</span>
	private final FilteredTreeViewTable&lt;CharacterFacade, SuperNode&gt; availableTable;
	private final JTreeViewTable&lt;SuperNode&gt; selectedTable;
	private final QualifiedSpellTreeCellRenderer spellRenderer;
	private final JButton addButton;
	private final JButton removeButton;
	private final FilterButton&lt;CharacterFacade, SuperNode&gt; qFilterButton;
	private final InfoPane spellsPane;
	private final InfoPane classPane;
	private final JComboBox defaultBookCombo;

	public SpellBooksTab()
<span class="nc" id="L80">	{</span>
<span class="nc" id="L81">		this.availableTable = new FilteredTreeViewTable&lt;&gt;();</span>
<span class="nc" id="L82">		this.selectedTable = new JTreeViewTable&lt;&gt;()</span>
<span class="nc" id="L83">		{</span>

			@Override
			public void setTreeViewModel(TreeViewModel&lt;SuperNode&gt; viewModel)
			{
<span class="nc" id="L88">				super.setTreeViewModel(viewModel);</span>
<span class="nc" id="L89">				sortModel();</span>
<span class="nc" id="L90">			}</span>

		};
<span class="nc" id="L93">		this.spellRenderer = new QualifiedSpellTreeCellRenderer();</span>
<span class="nc" id="L94">		this.addButton = new JButton();</span>
<span class="nc" id="L95">		this.removeButton = new JButton();</span>
<span class="nc" id="L96">		this.qFilterButton = new FilterButton&lt;&gt;(&quot;SpellBooksQualified&quot;);</span>
<span class="nc" id="L97">		this.spellsPane = new InfoPane(LanguageBundle.getString(&quot;InfoSpells.spell.info&quot;));</span>
<span class="nc" id="L98">		this.classPane = new InfoPane(LanguageBundle.getString(&quot;InfoSpells.class.info&quot;));</span>
<span class="nc" id="L99">		this.defaultBookCombo = new JComboBox();</span>
<span class="nc" id="L100">		initComponents();</span>
<span class="nc" id="L101">	}</span>

	private void initComponents()
	{
<span class="nc" id="L105">		availableTable.setTreeCellRenderer(spellRenderer);</span>
<span class="nc" id="L106">		selectedTable.setTreeCellRenderer(spellRenderer);</span>
<span class="nc" id="L107">		selectedTable.setRowSorter(new SortableTableRowSorter()</span>
<span class="nc" id="L108">		{</span>

			@Override
			public SortableTableModel getModel()
			{
<span class="nc" id="L113">				return (SortableTableModel) selectedTable.getModel();</span>
			}

		});
<span class="nc" id="L117">		selectedTable.getRowSorter().toggleSortOrder(0);</span>
<span class="nc" id="L118">		FilterBar&lt;CharacterFacade, SuperNode&gt; filterBar = new FilterBar&lt;&gt;();</span>
<span class="nc" id="L119">		filterBar.addDisplayableFilter(new SearchFilterPanel());</span>
<span class="nc" id="L120">		qFilterButton.setText(LanguageBundle.getString(&quot;in_igQualFilter&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L121">		filterBar.addDisplayableFilter(qFilterButton);</span>

<span class="nc" id="L123">		FlippingSplitPane upperPane = new FlippingSplitPane();</span>
<span class="nc" id="L124">		JPanel availPanel = FilterUtilities.configureFilteredTreeViewPane(availableTable, filterBar);</span>
		{
<span class="nc" id="L126">			JPanel bottomPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L127">			bottomPanel.add(new JLabel(LanguageBundle.getString(&quot;InfoSpells.set.auto.book&quot;)), BorderLayout.WEST);</span>
<span class="nc" id="L128">			bottomPanel.add(defaultBookCombo, BorderLayout.CENTER);</span>
<span class="nc" id="L129">			bottomPanel.add(addButton, BorderLayout.EAST);</span>
<span class="nc" id="L130">			availPanel.add(bottomPanel, BorderLayout.SOUTH);</span>
		}
<span class="nc" id="L132">		upperPane.setLeftComponent(availPanel);</span>

<span class="nc" id="L134">		JPanel rightPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L135">		rightPanel.add(new JScrollPane(selectedTable), BorderLayout.CENTER);</span>
		{
<span class="nc" id="L137">			Box hbox = Box.createHorizontalBox();</span>
<span class="nc" id="L138">			hbox.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L139">			hbox.add(removeButton);</span>
<span class="nc" id="L140">			hbox.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L141">			rightPanel.add(hbox, BorderLayout.SOUTH);</span>
		}
<span class="nc" id="L143">		upperPane.setRightComponent(rightPanel);</span>
<span class="nc" id="L144">		upperPane.setResizeWeight(0);</span>
<span class="nc" id="L145">		setTopComponent(upperPane);</span>

<span class="nc" id="L147">		FlippingSplitPane bottomPane = new FlippingSplitPane();</span>
<span class="nc" id="L148">		bottomPane.setLeftComponent(spellsPane);</span>
<span class="nc" id="L149">		bottomPane.setRightComponent(classPane);</span>
<span class="nc" id="L150">		setBottomComponent(bottomPane);</span>
<span class="nc" id="L151">		setOrientation(VERTICAL_SPLIT);</span>
<span class="nc" id="L152">	}</span>

	@Override
	public ModelMap createModels(final CharacterFacade character)
	{
<span class="nc" id="L157">		ModelMap models = new ModelMap();</span>
<span class="nc" id="L158">		models.put(TreeViewModelHandler.class, new TreeViewModelHandler(character));</span>
<span class="nc" id="L159">		models.put(AddSpellAction.class, new AddSpellAction(character));</span>
<span class="nc" id="L160">		models.put(RemoveSpellAction.class, new RemoveSpellAction(character));</span>
<span class="nc" id="L161">		models.put(SpellInfoHandler.class, new SpellInfoHandler(character, availableTable, selectedTable, spellsPane));</span>
<span class="nc" id="L162">		models.put(ClassInfoHandler.class, new ClassInfoHandler(character, availableTable, selectedTable, classPane));</span>
<span class="nc" id="L163">		models.put(SpellBookModel.class, new SpellBookModel(character));</span>
<span class="nc" id="L164">		models.put(SpellFilterHandler.class, new SpellFilterHandler(character));</span>
<span class="nc" id="L165">		return models;</span>
	}

	@Override
	public void restoreModels(ModelMap models)
	{
<span class="nc" id="L171">		models.get(SpellFilterHandler.class).install();</span>
<span class="nc" id="L172">		models.get(TreeViewModelHandler.class).install();</span>
<span class="nc" id="L173">		models.get(SpellInfoHandler.class).install();</span>
<span class="nc" id="L174">		models.get(ClassInfoHandler.class).install();</span>
<span class="nc" id="L175">		models.get(AddSpellAction.class).install();</span>
<span class="nc" id="L176">		models.get(RemoveSpellAction.class).install();</span>
<span class="nc" id="L177">		defaultBookCombo.setModel(models.get(SpellBookModel.class));</span>
<span class="nc" id="L178">	}</span>

	@Override
	public void storeModels(ModelMap models)
	{
<span class="nc" id="L183">		models.get(SpellInfoHandler.class).uninstall();</span>
<span class="nc" id="L184">		models.get(ClassInfoHandler.class).uninstall();</span>
<span class="nc" id="L185">		models.get(AddSpellAction.class).uninstall();</span>
<span class="nc" id="L186">		models.get(RemoveSpellAction.class).uninstall();</span>
<span class="nc" id="L187">		models.get(TreeViewModelHandler.class).uninstall();</span>
<span class="nc" id="L188">	}</span>

	@Override
	public TabTitle getTabTitle()
	{
<span class="nc" id="L193">		return tabTitle;</span>
	}

	/**
	 * Identify the current spell book, being the spell book that spells should
	 * be added to. If no books exist then return an empty string.
	 *
	 * @return The name of the 'current' spell book, or empty string if none
	 *         exist.
	 */
	String getCurrentSpellBookName()
	{
<span class="nc" id="L205">		String spellList = &quot;&quot;;</span>
<span class="nc" id="L206">		Object selectedObject = selectedTable.getSelectedObject();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">		if (selectedObject != null)</span>
		{
<span class="nc bnc" id="L209" title="All 2 branches missed.">			if (selectedObject instanceof SpellNode)</span>
			{
<span class="nc" id="L211">				spellList = ((SpellNode) selectedObject).getRootNode().getName();</span>
			}
<span class="nc bnc" id="L213" title="All 2 branches missed.">			else if (selectedObject instanceof RootNode)</span>
			{
<span class="nc" id="L215">				spellList = ((RootNode) selectedObject).getName();</span>
			}
			else
			{
<span class="nc" id="L219">				JTree tree = selectedTable.getTree();</span>
<span class="nc" id="L220">				TreePath path = tree.getSelectionPath();</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">				while (path.getParentPath() != null &amp;&amp; (path.getParentPath().getParentPath() != null))</span>
				{
<span class="nc" id="L223">					path = path.getParentPath();</span>
				}
<span class="nc" id="L225">				spellList = path.getLastPathComponent().toString();</span>
			}
		}
<span class="nc bnc" id="L228" title="All 2 branches missed.">		if (StringUtils.isEmpty(spellList))</span>
		{
<span class="nc" id="L230">			ListFacade&lt;?&gt; data = selectedTable.getTreeViewModel().getDataModel();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">			if (!data.isEmpty())</span>
			{
<span class="nc" id="L233">				Object firstElem = data.getElementAt(0);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">				if (firstElem instanceof SpellNode)</span>
				{
<span class="nc" id="L236">					spellList = ((SpellNode) firstElem).getRootNode().getName();</span>
				}
			}
		}
<span class="nc" id="L240">		return spellList;</span>
	}

	private static class SpellBookModel extends CharacterComboBoxModel&lt;String&gt;
	{

		private final SpellSupportFacade spellSupport;

		public SpellBookModel(CharacterFacade character)
<span class="nc" id="L249">		{</span>
<span class="nc" id="L250">			this.spellSupport = character.getSpellSupport();</span>
<span class="nc" id="L251">			setListFacade(spellSupport.getSpellbooks());</span>
<span class="nc" id="L252">			setReference(spellSupport.getDefaultSpellBookRef());</span>
<span class="nc" id="L253">		}</span>

		@Override
		public void setSelectedItem(Object anItem)
		{
<span class="nc" id="L258">			spellSupport.setDefaultSpellBook((String) anItem);</span>
<span class="nc" id="L259">		}</span>
	}

	private class AddSpellAction extends AbstractAction
	{

		private final CharacterFacade character;

		public AddSpellAction(CharacterFacade character)
<span class="nc" id="L268">		{</span>
<span class="nc" id="L269">			this.character = character;</span>
<span class="nc" id="L270">			putValue(SMALL_ICON, Icons.Forward16.getImageIcon());</span>
<span class="nc" id="L271">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L276">			List&lt;?&gt; data = availableTable.getSelectedData();</span>
<span class="nc" id="L277">			String bookname = getCurrentSpellBookName();</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">			for (Object object : data)</span>
			{
<span class="nc bnc" id="L280" title="All 2 branches missed.">				if (object instanceof SpellNode)</span>
				{
<span class="nc" id="L282">					character.getSpellSupport().addToSpellBook((SpellNode) object, bookname);</span>
				}
<span class="nc" id="L284">			}</span>
<span class="nc" id="L285">		}</span>

		public void install()
		{
<span class="nc" id="L289">			availableTable.addActionListener(this);</span>
<span class="nc" id="L290">			addButton.setAction(this);</span>
<span class="nc" id="L291">		}</span>

		public void uninstall()
		{
<span class="nc" id="L295">			availableTable.removeActionListener(this);</span>
<span class="nc" id="L296">		}</span>

	}

	private class RemoveSpellAction extends AbstractAction
	{

		private final CharacterFacade character;

		public RemoveSpellAction(CharacterFacade character)
<span class="nc" id="L306">		{</span>
<span class="nc" id="L307">			this.character = character;</span>
<span class="nc" id="L308">			putValue(SMALL_ICON, Icons.Back16.getImageIcon());</span>
<span class="nc" id="L309">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L314">			List&lt;?&gt; data = selectedTable.getSelectedData();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">			for (Object object : data)</span>
			{
<span class="nc bnc" id="L317" title="All 2 branches missed.">				if (object instanceof SpellNode node)</span>
				{
<span class="nc" id="L319">					character.getSpellSupport().removeFromSpellBook(node, node.getRootNode().getName());</span>
				}
<span class="nc" id="L321">			}</span>
<span class="nc" id="L322">		}</span>

		public void install()
		{
<span class="nc" id="L326">			selectedTable.addActionListener(this);</span>
<span class="nc" id="L327">			removeButton.setAction(this);</span>
<span class="nc" id="L328">		}</span>

		public void uninstall()
		{
<span class="nc" id="L332">			selectedTable.removeActionListener(this);</span>
<span class="nc" id="L333">		}</span>

	}

	private class TreeViewModelHandler
	{

		private final SpellTreeViewModel availableModel;
		private final SpellTreeViewModel selectedModel;
		private final CharacterFacade character;

		public TreeViewModelHandler(CharacterFacade character)
<span class="nc" id="L345">		{</span>
<span class="nc" id="L346">			this.character = character;</span>
<span class="nc" id="L347">			availableModel = new SpellTreeViewModel(character.getSpellSupport().getKnownSpellNodes(), false,</span>
<span class="nc" id="L348">				&quot;SpellBooksAva&quot;, character.getInfoFactory());</span>
<span class="nc" id="L349">			selectedModel = new SpellTreeViewModel(character.getSpellSupport().getBookSpellNodes(), true,</span>
<span class="nc" id="L350">				&quot;SpellBooksSel&quot;, character.getInfoFactory());</span>
<span class="nc" id="L351">		}</span>

		public void install()
		{
<span class="nc" id="L355">			spellRenderer.setCharacter(character);</span>
<span class="nc" id="L356">			availableTable.setTreeViewModel(availableModel);</span>
<span class="nc" id="L357">			selectedTable.setTreeViewModel(selectedModel);</span>
<span class="nc" id="L358">		}</span>

		public void uninstall()
		{
<span class="nc" id="L362">			spellRenderer.setCharacter(null);</span>
<span class="nc" id="L363">		}</span>

	}

	private class SpellFilterHandler implements Filter&lt;CharacterFacade, SuperNode&gt;
	{

		private final CharacterFacade character;

		public SpellFilterHandler(CharacterFacade character)
<span class="nc" id="L373">		{</span>
<span class="nc" id="L374">			this.character = character;</span>
<span class="nc" id="L375">		}</span>

		public void install()
		{
<span class="nc" id="L379">			qFilterButton.setFilter(this);</span>
<span class="nc" id="L380">		}</span>

		@Override
		public boolean accept(CharacterFacade context, SuperNode element)
		{
<span class="nc bnc" id="L385" title="All 2 branches missed.">			if (element instanceof SpellNode spellNode)</span>
			{
<span class="nc" id="L387">				SpellFacade spell = spellNode.getSpell();</span>
<span class="nc" id="L388">				PCClass pcClass = spellNode.getSpellcastingClass();</span>
<span class="nc" id="L389">				return character.isQualifiedFor(spell, pcClass);</span>
			}
<span class="nc" id="L391">			return true;</span>
		}

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>