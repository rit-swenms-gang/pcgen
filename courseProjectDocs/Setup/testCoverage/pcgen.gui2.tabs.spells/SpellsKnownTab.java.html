<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SpellsKnownTab.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.tabs.spells</a> &gt; <span class="el_source">SpellsKnownTab.java</span></div><h1>SpellsKnownTab.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2011 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 * 
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 * 
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 * 
 */
package pcgen.gui2.tabs.spells;

import java.awt.BorderLayout;
import java.awt.event.ActionEvent;
import java.io.File;
import java.util.List;

import javax.swing.AbstractAction;
import javax.swing.Box;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTextField;

import org.apache.commons.io.FilenameUtils;
import pcgen.core.PCClass;
import pcgen.facade.core.CharacterFacade;
import pcgen.facade.core.SpellFacade;
import pcgen.facade.core.SpellSupportFacade.SpellNode;
import pcgen.facade.core.SpellSupportFacade.SuperNode;
import pcgen.gui2.filter.Filter;
import pcgen.gui2.filter.FilterBar;
import pcgen.gui2.filter.FilterButton;
import pcgen.gui2.filter.FilterUtilities;
import pcgen.gui2.filter.FilteredTreeViewTable;
import pcgen.gui2.filter.SearchFilterPanel;
import pcgen.gui2.tabs.CharacterInfoTab;
import pcgen.gui2.tabs.TabTitle;
import pcgen.gui2.tools.FlippingSplitPane;
import pcgen.gui2.tools.Icons;
import pcgen.gui2.tools.InfoPane;
import pcgen.gui2.util.JTreeViewTable;
import pcgen.gui2.util.table.SortableTableModel;
import pcgen.gui2.util.table.SortableTableRowSorter;
import pcgen.gui2.util.treeview.TreeViewModel;
import pcgen.system.ConfigurationSettings;
import pcgen.system.LanguageBundle;
import pcgen.system.PCGenSettings;
import pcgen.util.enumeration.Tab;

import javafx.stage.FileChooser;

@SuppressWarnings(&quot;serial&quot;)
public class SpellsKnownTab extends FlippingSplitPane implements CharacterInfoTab
{
<span class="nc" id="L65">	private final TabTitle tabTitle = new TabTitle(Tab.KNOWN_SPELLS);</span>
	private final FilteredTreeViewTable&lt;CharacterFacade, SuperNode&gt; availableTable;
	private final JTreeViewTable&lt;SuperNode&gt; selectedTable;
	private final QualifiedSpellTreeCellRenderer spellRenderer;
	private final JButton addButton;
	private final JButton removeButton;
	private final FilterButton&lt;CharacterFacade, SuperNode&gt; qFilterButton;
	private final JCheckBox autoKnownBox;
	private final JCheckBox slotsBox;
	private final JTextField spellSheetField;
	private final InfoPane spellsPane;
	private final InfoPane classPane;
	private JButton previewSpellsButton;
	private JButton exportSpellsButton;

	public SpellsKnownTab()
<span class="nc" id="L81">	{</span>
<span class="nc" id="L82">		this.availableTable = new FilteredTreeViewTable&lt;&gt;();</span>
<span class="nc" id="L83">		this.selectedTable = new JTreeViewTable&lt;&gt;()</span>
<span class="nc" id="L84">		{</span>
			@Override
			public void setTreeViewModel(TreeViewModel&lt;SuperNode&gt; viewModel)
			{
<span class="nc" id="L88">				super.setTreeViewModel(viewModel);</span>
<span class="nc" id="L89">				sortModel();</span>
<span class="nc" id="L90">			}</span>
		};
<span class="nc" id="L92">		this.spellRenderer = new QualifiedSpellTreeCellRenderer();</span>
<span class="nc" id="L93">		this.addButton = new JButton();</span>
<span class="nc" id="L94">		this.removeButton = new JButton();</span>
<span class="nc" id="L95">		this.qFilterButton = new FilterButton&lt;&gt;(&quot;SpellsKnownQualified&quot;);</span>
<span class="nc" id="L96">		this.autoKnownBox = new JCheckBox();</span>
<span class="nc" id="L97">		this.slotsBox = new JCheckBox();</span>
<span class="nc" id="L98">		this.spellSheetField = new JTextField();</span>
<span class="nc" id="L99">		this.spellsPane = new InfoPane(LanguageBundle.getString(&quot;InfoSpells.spell.info&quot;));</span>
<span class="nc" id="L100">		this.classPane = new InfoPane(LanguageBundle.getString(&quot;InfoSpells.class.info&quot;));</span>
<span class="nc" id="L101">		initComponents();</span>
<span class="nc" id="L102">	}</span>

	private void initComponents()
	{
<span class="nc" id="L106">		availableTable.setTreeCellRenderer(spellRenderer);</span>
<span class="nc" id="L107">		selectedTable.setTreeCellRenderer(spellRenderer);</span>
<span class="nc" id="L108">		selectedTable.setRowSorter(new SortableTableRowSorter()</span>
<span class="nc" id="L109">		{</span>
			@Override
			public SortableTableModel getModel()
			{
<span class="nc" id="L113">				return (SortableTableModel) selectedTable.getModel();</span>
			}
		});
<span class="nc" id="L116">		selectedTable.getRowSorter().toggleSortOrder(0);</span>
<span class="nc" id="L117">		FilterBar&lt;CharacterFacade, SuperNode&gt; filterBar = new FilterBar&lt;&gt;();</span>
<span class="nc" id="L118">		filterBar.addDisplayableFilter(new SearchFilterPanel());</span>
<span class="nc" id="L119">		qFilterButton.setText(LanguageBundle.getString(&quot;in_igQualFilter&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L120">		filterBar.addDisplayableFilter(qFilterButton);</span>

<span class="nc" id="L122">		FlippingSplitPane upperPane = new FlippingSplitPane();</span>
<span class="nc" id="L123">		JPanel availPanel = FilterUtilities.configureFilteredTreeViewPane(availableTable, filterBar);</span>

<span class="nc" id="L125">		Box box = Box.createVerticalBox();</span>
		{
<span class="nc" id="L127">			Box hbox = Box.createHorizontalBox();</span>
<span class="nc" id="L128">			hbox.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L129">			hbox.add(autoKnownBox);</span>
<span class="nc" id="L130">			hbox.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L131">			box.add(hbox);</span>
		}
		{
<span class="nc" id="L134">			Box hbox = Box.createHorizontalBox();</span>
<span class="nc" id="L135">			hbox.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L136">			hbox.add(slotsBox);</span>
<span class="nc" id="L137">			hbox.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L138">			hbox.add(Box.createHorizontalStrut(10));</span>
<span class="nc" id="L139">			hbox.add(addButton);</span>
<span class="nc" id="L140">			box.add(hbox);</span>
		}
<span class="nc" id="L142">		availPanel.add(box, BorderLayout.SOUTH);</span>
<span class="nc" id="L143">		upperPane.setLeftComponent(availPanel);</span>

<span class="nc" id="L145">		JPanel rightPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L146">		rightPanel.add(new JScrollPane(selectedTable), BorderLayout.CENTER);</span>
		{
<span class="nc" id="L148">			Box hbox = Box.createHorizontalBox();</span>
<span class="nc" id="L149">			hbox.add(removeButton);</span>
<span class="nc" id="L150">			hbox.add(Box.createHorizontalStrut(10));</span>

<span class="nc" id="L152">			JButton spellSheetButton = new JButton(LanguageBundle.getString(&quot;InfoSpells.select.spellsheet&quot;));</span>
<span class="nc" id="L153">			spellSheetButton.addActionListener(e -&gt; selectSpellSheetButton());</span>
<span class="nc" id="L154">			hbox.add(spellSheetButton);</span>
<span class="nc" id="L155">			hbox.add(Box.createHorizontalStrut(3));</span>

<span class="nc" id="L157">			String text = FilenameUtils.getName(PCGenSettings.getSelectedSpellSheet());</span>
<span class="nc" id="L158">			spellSheetField.setEditable(false);</span>
<span class="nc" id="L159">			spellSheetField.setText(text);</span>
<span class="nc" id="L160">			spellSheetField.setToolTipText(text);</span>
<span class="nc" id="L161">			hbox.add(spellSheetField);</span>
<span class="nc" id="L162">			hbox.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L163">			previewSpellsButton = new JButton(Icons.PrintPreview16.getImageIcon());</span>
<span class="nc" id="L164">			hbox.add(previewSpellsButton);</span>
<span class="nc" id="L165">			hbox.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L166">			exportSpellsButton = new JButton(Icons.Print16.getImageIcon());</span>
<span class="nc" id="L167">			hbox.add(exportSpellsButton);</span>
<span class="nc" id="L168">			rightPanel.add(hbox, BorderLayout.SOUTH);</span>
		}
<span class="nc" id="L170">		upperPane.setRightComponent(rightPanel);</span>
<span class="nc" id="L171">		upperPane.setResizeWeight(0);</span>
<span class="nc" id="L172">		setTopComponent(upperPane);</span>

<span class="nc" id="L174">		FlippingSplitPane bottomPane = new FlippingSplitPane();</span>
<span class="nc" id="L175">		bottomPane.setLeftComponent(spellsPane);</span>
<span class="nc" id="L176">		bottomPane.setRightComponent(classPane);</span>
<span class="nc" id="L177">		setBottomComponent(bottomPane);</span>
<span class="nc" id="L178">		setOrientation(VERTICAL_SPLIT);</span>
<span class="nc" id="L179">	}</span>

	@Override
	public ModelMap createModels(CharacterFacade character)
	{
<span class="nc" id="L184">		ModelMap models = new ModelMap();</span>
<span class="nc" id="L185">		models.put(TreeViewModelHandler.class, new TreeViewModelHandler(character));</span>
<span class="nc" id="L186">		models.put(AddSpellAction.class, new AddSpellAction(character));</span>
<span class="nc" id="L187">		models.put(RemoveSpellAction.class, new RemoveSpellAction(character));</span>
<span class="nc" id="L188">		models.put(AutoAddSpellsAction.class, new AutoAddSpellsAction(character));</span>
<span class="nc" id="L189">		models.put(UseHigherSlotsAction.class, new UseHigherSlotsAction(character));</span>
<span class="nc" id="L190">		models.put(PreviewSpellsAction.class, new PreviewSpellsAction(character));</span>
<span class="nc" id="L191">		models.put(ExportSpellsAction.class, new ExportSpellsAction(character));</span>
<span class="nc" id="L192">		models.put(SpellInfoHandler.class, new SpellInfoHandler(character, availableTable, selectedTable, spellsPane));</span>
<span class="nc" id="L193">		models.put(ClassInfoHandler.class, new ClassInfoHandler(character, availableTable, selectedTable, classPane));</span>
<span class="nc" id="L194">		models.put(SpellFilterHandler.class, new SpellFilterHandler(character));</span>

<span class="nc" id="L196">		return models;</span>
	}

	@Override
	public void restoreModels(ModelMap models)
	{
<span class="nc" id="L202">		models.get(SpellFilterHandler.class).install();</span>
<span class="nc" id="L203">		models.get(TreeViewModelHandler.class).install();</span>
<span class="nc" id="L204">		models.get(SpellInfoHandler.class).install();</span>
<span class="nc" id="L205">		models.get(ClassInfoHandler.class).install();</span>
<span class="nc" id="L206">		models.get(AddSpellAction.class).install();</span>
<span class="nc" id="L207">		models.get(RemoveSpellAction.class).install();</span>
<span class="nc" id="L208">		models.get(AutoAddSpellsAction.class).install();</span>
<span class="nc" id="L209">		models.get(UseHigherSlotsAction.class).install();</span>
<span class="nc" id="L210">		previewSpellsButton.setAction(models.get(PreviewSpellsAction.class));</span>
<span class="nc" id="L211">		exportSpellsButton.setAction(models.get(ExportSpellsAction.class));</span>
<span class="nc" id="L212">	}</span>

	@Override
	public void storeModels(ModelMap models)
	{
<span class="nc" id="L217">		models.get(SpellInfoHandler.class).uninstall();</span>
<span class="nc" id="L218">		models.get(ClassInfoHandler.class).uninstall();</span>
<span class="nc" id="L219">		models.get(AddSpellAction.class).uninstall();</span>
<span class="nc" id="L220">		models.get(RemoveSpellAction.class).uninstall();</span>
<span class="nc" id="L221">		models.get(TreeViewModelHandler.class).uninstall();</span>
<span class="nc" id="L222">	}</span>

	@Override
	public TabTitle getTabTitle()
	{
<span class="nc" id="L227">		return tabTitle;</span>
	}

	/**
	 * Select a spell output sheet
	 */
	private void selectSpellSheetButton()
	{
<span class="nc" id="L235">		FileChooser fileChooser = new FileChooser();</span>
<span class="nc" id="L236">		fileChooser.setTitle(LanguageBundle.getString(&quot;InfoSpells.select.output.sheet&quot;));</span>
<span class="nc" id="L237">		fileChooser.setInitialDirectory(new File(ConfigurationSettings.getOutputSheetsDir()));</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">		if (PCGenSettings.getSelectedSpellSheet() != null)</span>
		{
<span class="nc" id="L240">			fileChooser.setInitialFileName(PCGenSettings.getSelectedSpellSheet());</span>
		}
<span class="nc" id="L242">		File selectedFile = fileChooser.showOpenDialog(null);</span>

<span class="nc bnc" id="L244" title="All 2 branches missed.">		if (selectedFile != null)</span>
		{
<span class="nc" id="L246">			PCGenSettings.getInstance().setProperty(PCGenSettings.SELECTED_SPELL_SHEET_PATH,</span>
<span class="nc" id="L247">				selectedFile.getAbsolutePath());</span>
<span class="nc" id="L248">			spellSheetField.setText(selectedFile.getName());</span>
<span class="nc" id="L249">			spellSheetField.setToolTipText(selectedFile.getName());</span>
		}
<span class="nc" id="L251">	}</span>

	private class AddSpellAction extends AbstractAction
	{

		private final CharacterFacade character;

		public AddSpellAction(CharacterFacade character)
<span class="nc" id="L259">		{</span>
<span class="nc" id="L260">			this.character = character;</span>
<span class="nc" id="L261">			putValue(SMALL_ICON, Icons.Forward16.getImageIcon());</span>
<span class="nc" id="L262">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L267">			List&lt;?&gt; data = availableTable.getSelectedData();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">			for (Object object : data)</span>
			{
<span class="nc bnc" id="L270" title="All 2 branches missed.">				if (object instanceof SpellNode)</span>
				{
<span class="nc" id="L272">					character.getSpellSupport().addKnownSpell((SpellNode) object);</span>
				}
<span class="nc" id="L274">			}</span>
<span class="nc" id="L275">		}</span>

		public void install()
		{
<span class="nc" id="L279">			availableTable.addActionListener(this);</span>
<span class="nc" id="L280">			addButton.setAction(this);</span>
<span class="nc" id="L281">		}</span>

		public void uninstall()
		{
<span class="nc" id="L285">			availableTable.removeActionListener(this);</span>
<span class="nc" id="L286">		}</span>

	}

	private class RemoveSpellAction extends AbstractAction
	{

		private final CharacterFacade character;

		public RemoveSpellAction(CharacterFacade character)
<span class="nc" id="L296">		{</span>
<span class="nc" id="L297">			this.character = character;</span>
<span class="nc" id="L298">			putValue(SMALL_ICON, Icons.Back16.getImageIcon());</span>
<span class="nc" id="L299">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L304">			List&lt;?&gt; data = selectedTable.getSelectedData();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">			for (Object object : data)</span>
			{
<span class="nc bnc" id="L307" title="All 2 branches missed.">				if (object instanceof SpellNode)</span>
				{
<span class="nc" id="L309">					character.getSpellSupport().removeKnownSpell((SpellNode) object);</span>
				}
<span class="nc" id="L311">			}</span>
<span class="nc" id="L312">		}</span>

		public void install()
		{
<span class="nc" id="L316">			selectedTable.addActionListener(this);</span>
<span class="nc" id="L317">			removeButton.setAction(this);</span>
<span class="nc" id="L318">		}</span>

		public void uninstall()
		{
<span class="nc" id="L322">			selectedTable.removeActionListener(this);</span>
<span class="nc" id="L323">		}</span>

	}

	private class AutoAddSpellsAction extends AbstractAction
	{

		private final CharacterFacade character;

		public AutoAddSpellsAction(CharacterFacade character)
<span class="nc" id="L333">		{</span>
<span class="nc" id="L334">			super(LanguageBundle.getString(&quot;InfoSpells.autoload&quot;));</span>
<span class="nc" id="L335">			this.character = character;</span>
<span class="nc" id="L336">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L341">			character.getSpellSupport().setAutoSpells(autoKnownBox.isSelected());</span>
<span class="nc" id="L342">		}</span>

		public void install()
		{
<span class="nc" id="L346">			autoKnownBox.setAction(this);</span>
<span class="nc" id="L347">			autoKnownBox.setSelected(character.getSpellSupport().isAutoSpells());</span>
<span class="nc" id="L348">		}</span>

	}

	private class UseHigherSlotsAction extends AbstractAction
	{

		private final CharacterFacade character;

		public UseHigherSlotsAction(CharacterFacade character)
<span class="nc" id="L358">		{</span>
<span class="nc" id="L359">			super(LanguageBundle.getString(&quot;InfoKnownSpells.canUseHigherSlots&quot;));</span>
<span class="nc" id="L360">			this.character = character;</span>
<span class="nc" id="L361">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L366">			character.getSpellSupport().setUseHigherKnownSlots(slotsBox.isSelected());</span>
<span class="nc" id="L367">		}</span>

		public void install()
		{
<span class="nc" id="L371">			slotsBox.setAction(this);</span>
<span class="nc" id="L372">			slotsBox.setSelected(character.getSpellSupport().isUseHigherKnownSlots());</span>
<span class="nc" id="L373">		}</span>

	}

	private static class PreviewSpellsAction extends AbstractAction
	{

		private final CharacterFacade character;

		public PreviewSpellsAction(CharacterFacade character)
<span class="nc" id="L383">		{</span>
<span class="nc" id="L384">			this.character = character;</span>
<span class="nc" id="L385">			putValue(SMALL_ICON, Icons.PrintPreview16.getImageIcon());</span>
<span class="nc" id="L386">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L391">			character.getSpellSupport().previewSpells();</span>
<span class="nc" id="L392">		}</span>

	}

	private static class ExportSpellsAction extends AbstractAction
	{

		private final CharacterFacade character;

		public ExportSpellsAction(CharacterFacade character)
<span class="nc" id="L402">		{</span>
<span class="nc" id="L403">			this.character = character;</span>
<span class="nc" id="L404">			putValue(SMALL_ICON, Icons.Print16.getImageIcon());</span>
<span class="nc" id="L405">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L410">			character.getSpellSupport().exportSpells();</span>
<span class="nc" id="L411">		}</span>

	}

	private class TreeViewModelHandler
	{

		private final SpellTreeViewModel availableModel;
		private final SpellTreeViewModel selectedModel;
		private final CharacterFacade character;

		public TreeViewModelHandler(CharacterFacade character)
<span class="nc" id="L423">		{</span>
<span class="nc" id="L424">			this.character = character;</span>
<span class="nc" id="L425">			availableModel = new SpellTreeViewModel(character.getSpellSupport().getAvailableSpellNodes(), false,</span>
<span class="nc" id="L426">				&quot;SpellsKnownAva&quot;, character.getInfoFactory());</span>
<span class="nc" id="L427">			selectedModel = new SpellTreeViewModel(character.getSpellSupport().getAllKnownSpellNodes(), true,</span>
<span class="nc" id="L428">				&quot;SpellsKnownSel&quot;, character.getInfoFactory());</span>
<span class="nc" id="L429">		}</span>

		public void install()
		{
<span class="nc" id="L433">			spellRenderer.setCharacter(character);</span>
<span class="nc" id="L434">			availableTable.setTreeViewModel(availableModel);</span>
<span class="nc" id="L435">			selectedTable.setTreeViewModel(selectedModel);</span>
<span class="nc" id="L436">		}</span>

		public void uninstall()
		{
<span class="nc" id="L440">			spellRenderer.setCharacter(null);</span>
<span class="nc" id="L441">		}</span>

	}

	private class SpellFilterHandler implements Filter&lt;CharacterFacade, SuperNode&gt;
	{

		private final CharacterFacade character;

		public SpellFilterHandler(CharacterFacade character)
<span class="nc" id="L451">		{</span>
<span class="nc" id="L452">			this.character = character;</span>
<span class="nc" id="L453">		}</span>

		public void install()
		{
<span class="nc" id="L457">			qFilterButton.setFilter(this);</span>
<span class="nc" id="L458">		}</span>

		@Override
		public boolean accept(CharacterFacade context, SuperNode element)
		{
<span class="nc bnc" id="L463" title="All 2 branches missed.">			if (element instanceof SpellNode spellNode)</span>
			{
<span class="nc" id="L465">				SpellFacade spell = spellNode.getSpell();</span>
<span class="nc" id="L466">				PCClass pcClass = spellNode.getSpellcastingClass();</span>
<span class="nc" id="L467">				return character.isQualifiedFor(spell, pcClass);</span>
			}
<span class="nc" id="L469">			return true;</span>
		}

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>