<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PreCSkillTester.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">plugin.pretokens.test</a> &gt; <span class="el_source">PreCSkillTester.java</span></div><h1>PreCSkillTester.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2001 (C) Bryan McRoberts &lt;merton_monk@yahoo.com&gt;
 * Copyright 2005 (C) Thomas Clegg &lt;TN_Clegg@lycos.com&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	   See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package plugin.pretokens.test;

import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;

import pcgen.cdom.base.CDOMObject;
import pcgen.cdom.base.CDOMReference;
import pcgen.cdom.enumeration.ListKey;
import pcgen.core.Globals;
import pcgen.core.PlayerCharacter;
import pcgen.core.Skill;
import pcgen.core.prereq.AbstractPrerequisiteTest;
import pcgen.core.prereq.Prerequisite;
import pcgen.core.prereq.PrerequisiteOperator;
import pcgen.system.LanguageBundle;

<span class="nc" id="L38">public class PreCSkillTester extends AbstractPrerequisiteTest</span>
{
	@Override
	public int passes(final Prerequisite prereq, final PlayerCharacter character, CDOMObject source)
	{
<span class="nc" id="L43">		final int reqnumber = Integer.parseInt(prereq.getOperand());</span>
<span class="nc" id="L44">		int runningTotal = 0;</span>
<span class="nc" id="L45">		Map&lt;Skill, Set&lt;Skill&gt;&gt; serveAsSkills = new HashMap&lt;&gt;();</span>
<span class="nc" id="L46">		Collection&lt;Skill&gt; imitators = new HashSet&lt;&gt;();</span>
<span class="nc" id="L47">		PreCSkillTester.getImitators(serveAsSkills, imitators);</span>

		// Compute the skill name from the Prerequisite
<span class="nc" id="L50">		String requiredSkillKey = prereq.getKey().toUpperCase();</span>

<span class="nc bnc" id="L52" title="All 2 branches missed.">		if (prereq.getSubKey() != null)</span>
		{
<span class="nc" id="L54">			requiredSkillKey += &quot; (&quot; + prereq.getSubKey().toUpperCase() + ')'; //$NON-NLS-1$ </span>
		}

<span class="nc" id="L57">		final boolean isType = (</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">				requiredSkillKey.startsWith(&quot;TYPE.&quot;) //$NON-NLS-1$</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">				|| requiredSkillKey.startsWith(&quot;TYPE=&quot;)); //$NON-NLS-1$</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">		if (isType)</span>
		{
<span class="nc" id="L62">			requiredSkillKey = requiredSkillKey.substring(5);</span>
		}
<span class="nc" id="L64">		final String skillKey = requiredSkillKey;</span>
<span class="nc" id="L65">		Set&lt;Skill&gt; skillMatches = new HashSet&lt;&gt;();</span>

<span class="nc bnc" id="L67" title="All 2 branches missed.">		if (isType)</span>
		{
			//Skill name is actually type to compare for

			//loop through skill list checking for type and class skill
<span class="nc bnc" id="L72" title="All 2 branches missed.">			for (Skill skill : Globals.getContext().getReferenceContext().getConstructedCDOMObjects(Skill.class))</span>
			{
<span class="nc bnc" id="L74" title="All 4 branches missed.">				if (skill.isType(skillKey) &amp;&amp; character.isClassSkill(skill))</span>
				{
<span class="nc" id="L76">					skillMatches.add(skill);</span>
<span class="nc" id="L77">					runningTotal++;</span>
				}

<span class="nc" id="L80">			}</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">			if (runningTotal &lt; reqnumber)</span>
			{
<span class="nc" id="L83">				if (serveAsSkills.entrySet()</span>
<span class="nc" id="L84">				                 .stream()</span>
<span class="nc" id="L85">				                 .filter(entry -&gt; character.isClassSkill(entry.getKey()))</span>
<span class="nc" id="L86">				                 .flatMap(entry -&gt; entry.getValue().stream())</span>
				                 // We already counted this skill in the above
				                 // calculation.  We DONT want to match it
				                 // a second time
<span class="nc bnc" id="L90" title="All 2 branches missed.">				                 .takeWhile(mock -&gt; !skillMatches.contains(mock))</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">				                 .anyMatch(mock -&gt; mock.isType(skillKey)))</span>
				{
<span class="nc" id="L93">					runningTotal++;</span>
				}
			}
		}
		else
		{
			Skill skill =
<span class="nc" id="L100">					Globals.getContext().getReferenceContext().silentlyGetConstructedCDOMObject(Skill.class, skillKey);</span>
<span class="nc bnc" id="L101" title="All 4 branches missed.">			if ((skill != null) &amp;&amp; character.isClassSkill(skill))</span>
			{
<span class="nc" id="L103">				runningTotal++;</span>
			}
			else
			{
<span class="nc" id="L107">				if (imitators.stream()</span>
<span class="nc bnc" id="L108" title="All 6 branches missed.">				             .anyMatch(mock -&gt; character.isClassSkill(mock) &amp;&amp; serveAsSkills.get(mock).contains(skill)))</span>
				{
<span class="nc" id="L110">					runningTotal++;</span>
				}
			}
		}

<span class="nc" id="L115">		runningTotal = prereq.getOperator().compare(runningTotal, reqnumber);</span>
<span class="nc" id="L116">		return countedTotal(prereq, runningTotal);</span>
	}

	/**
	 * @param serveAsSkills
	 * @param imitators
	 */
	private static void getImitators(Map&lt;? super Skill, ? super Set&lt;Skill&gt;&gt; serveAsSkills, Collection&lt;? super Skill&gt; imitators)
	{
<span class="nc bnc" id="L125" title="All 2 branches missed.">		for (Skill aSkill : Globals.getContext().getReferenceContext().getConstructedCDOMObjects(Skill.class))</span>
		{
<span class="nc" id="L127">			HashSet&lt;Skill&gt; servesAs = new HashSet&lt;&gt;();</span>
<span class="nc" id="L128">			aSkill.getSafeListFor(ListKey.SERVES_AS_SKILL)</span>
<span class="nc" id="L129">			      .stream()</span>
<span class="nc" id="L130">			      .map(CDOMReference::getContainedObjects)</span>
<span class="nc" id="L131">			      .forEach(servesAs::addAll);</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">			if (!servesAs.isEmpty())</span>
			{
<span class="nc" id="L135">				imitators.add(aSkill);</span>
<span class="nc" id="L136">				serveAsSkills.put(aSkill, servesAs);</span>
			}
<span class="nc" id="L138">		}</span>
<span class="nc" id="L139">	}</span>

	/**
	 * Get the type of prerequisite handled by this token.
	 * @return the type of prerequisite handled by this token.
	 */
	@Override
	public String kindHandled()
	{
<span class="nc" id="L148">		return &quot;CSKILL&quot;; //$NON-NLS-1$</span>
	}

	@Override
	public String toHtmlString(final Prerequisite prereq)
	{
<span class="nc" id="L154">		String skillName = prereq.getKey();</span>
<span class="nc bnc" id="L155" title="All 4 branches missed.">		if ((prereq.getSubKey() != null) &amp;&amp; !prereq.getSubKey().isEmpty()) //$NON-NLS-1$</span>
		{
<span class="nc" id="L157">			skillName += &quot; (&quot; + prereq.getSubKey() + ')'; //$NON-NLS-1$</span>

		}

		String htmlString;
<span class="nc bnc" id="L162" title="All 4 branches missed.">		if (prereq.getOperand().equals(&quot;1&quot;) &amp;&amp; prereq.getOperator() == PrerequisiteOperator.GTEQ)</span>
		{
<span class="nc" id="L164">			htmlString = LanguageBundle.getFormattedString(&quot;PreCSkill.single.toHtml&quot;, //$NON-NLS-1$</span>
				skillName);
		}
		else
		{
<span class="nc" id="L169">			htmlString = LanguageBundle.getFormattedString(&quot;PreCSkill.toHtml&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L170">				prereq.getOperator().toDisplayString(), prereq.getOperand(), skillName);</span>
		}
<span class="nc" id="L172">		return htmlString;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>