<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PreSkillTester.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">plugin.pretokens.test</a> &gt; <span class="el_source">PreSkillTester.java</span></div><h1>PreSkillTester.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2001 (C) Bryan McRoberts &lt;merton_monk@yahoo.com&gt;
 * Copyright 2003 (C) Chris Ward &lt;frugal@purplewombat.co.uk&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	   See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 *
 *
 *
 */package plugin.pretokens.test;

import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import pcgen.cdom.base.CDOMObject;
import pcgen.cdom.base.CDOMReference;
import pcgen.cdom.enumeration.ListKey;
import pcgen.cdom.enumeration.Type;
import pcgen.core.PlayerCharacter;
import pcgen.core.Skill;
import pcgen.core.analysis.SkillRankControl;
import pcgen.core.display.CharacterDisplay;
import pcgen.core.prereq.AbstractPrerequisiteTest;
import pcgen.core.prereq.Prerequisite;
import pcgen.core.prereq.PrerequisiteOperator;
import pcgen.core.prereq.PrerequisiteTest;
import pcgen.system.LanguageBundle;

<span class="nc" id="L43">public class PreSkillTester extends AbstractPrerequisiteTest implements PrerequisiteTest</span>
{

	@SuppressWarnings(&quot;unused&quot;)
	@Override
	public int passes(final Prerequisite prereq, final PlayerCharacter character, CDOMObject source)
	{
<span class="nc" id="L50">		CharacterDisplay display = character.getDisplay();</span>
<span class="nc" id="L51">		final int requiredRanks = Integer.parseInt(prereq.getOperand());</span>
		// Compute the skill name from the Prerequisite
<span class="nc" id="L53">		String requiredSkillKey = prereq.getKey().toUpperCase();</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">		if (prereq.getSubKey() != null)</span>
		{
<span class="nc" id="L56">			requiredSkillKey += &quot; (&quot; + prereq.getSubKey().toUpperCase() + ')'; //$NON-NLS-1$ </span>
		}
<span class="nc" id="L58">		final boolean isType =</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">				(requiredSkillKey.startsWith(&quot;TYPE.&quot;)</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">						|| requiredSkillKey.startsWith(&quot;TYPE=&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">		if (isType)</span>
		{
<span class="nc" id="L63">			requiredSkillKey = requiredSkillKey.substring(5);</span>
		}
<span class="nc" id="L65">		final String skillKey = requiredSkillKey;</span>
		// Now locate all instances of this skillname and test them
<span class="nc" id="L67">		final int percentageSignPosition = skillKey.lastIndexOf('%');</span>
<span class="nc" id="L68">		HashMap&lt;Skill, Set&lt;Skill&gt;&gt; serveAsSkills = new HashMap&lt;&gt;();</span>
<span class="nc" id="L69">		Set&lt;Skill&gt; imitators = new HashSet&lt;&gt;();</span>
<span class="nc" id="L70">		this.getImitators(serveAsSkills, imitators, display);</span>
<span class="nc" id="L71">		int runningTotal = 0;</span>
<span class="nc" id="L72">		boolean foundMatch = false;</span>
<span class="nc" id="L73">		boolean foundSkill = false;</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">		for (Skill aSkill : display.getSkillSet())</span>
		{
<span class="nc" id="L76">			final String aSkillKey = aSkill.getKeyName().toUpperCase();</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">			if (isType)</span>
			{
<span class="nc bnc" id="L79" title="All 2 branches missed.">				if (percentageSignPosition &gt;= 0)</span>
				{
<span class="nc" id="L81">					foundMatch = matchesTypeWildCard(skillKey, percentageSignPosition, foundSkill, aSkill);</span>
<span class="nc" id="L82">					foundSkill = foundMatch;</span>
<span class="nc" id="L83">					runningTotal = getRunningTotal(aSkill, character, prereq, foundMatch, runningTotal, requiredRanks);</span>
				}
<span class="nc bnc" id="L85" title="All 2 branches missed.">				else if (aSkill.isType(skillKey))</span>
				{
<span class="nc" id="L87">					foundMatch = true;</span>
<span class="nc" id="L88">					foundSkill = true;</span>
<span class="nc" id="L89">					runningTotal = getRunningTotal(aSkill, character, prereq, true, runningTotal, requiredRanks);</span>
				}
				// If there wasn't a match, then check other skills of the type
<span class="nc bnc" id="L92" title="All 2 branches missed.">				if (runningTotal == 0)</span>
				{
<span class="nc" id="L94">					foundMatch = false;</span>
				}
			}
<span class="nc bnc" id="L97" title="All 4 branches missed.">			else if (aSkillKey.equals(skillKey) || ((percentageSignPosition &gt;= 0)</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">				&amp;&amp; aSkillKey.startsWith(skillKey.substring(0, percentageSignPosition))))</span>
			{
<span class="nc" id="L100">				foundMatch = true;</span>
<span class="nc" id="L101">				foundSkill = true;</span>
<span class="nc" id="L102">				runningTotal = getRunningTotal(aSkill, character, prereq, true, runningTotal, requiredRanks);</span>
			}

<span class="nc bnc" id="L105" title="All 4 branches missed.">			if (prereq.isCountMultiples() || prereq.isTotalValues())</span>
			{
				// For counted totals we want to count all occurances, not just the first
<span class="nc" id="L108">				foundMatch = false;</span>
			}
<span class="nc bnc" id="L110" title="All 2 branches missed.">			if (foundMatch)</span>
			{
<span class="nc" id="L112">				break;</span>
			}
<span class="nc" id="L114">		}</span>
<span class="nc bnc" id="L115" title="All 4 branches missed.">		if (!isType &amp;&amp; !foundSkill)</span>
		{
<span class="nc bnc" id="L117" title="All 2 branches missed.">			for (final Map.Entry&lt;Skill, Set&lt;Skill&gt;&gt; entry : serveAsSkills.entrySet())</span>
			{
<span class="nc" id="L119">				Skill mock = entry.getKey();</span>
<span class="nc" id="L120">				Set&lt;Skill&gt; targets = entry.getValue();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">				for (Skill target : targets)</span>
				{
<span class="nc bnc" id="L123" title="All 2 branches missed.">					if (foundSkill)</span>
					{
<span class="nc" id="L125">						break;</span>
					}
<span class="nc" id="L127">					final String aSkillKey = target.getKeyName().toUpperCase();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">					if (target.getDisplayName().equalsIgnoreCase(skillKey))</span>
					{
<span class="nc" id="L130">						foundSkill = true;</span>
<span class="nc" id="L131">						int theTotal =</span>
<span class="nc" id="L132">								getRunningTotal(mock, character, prereq, true, runningTotal, requiredRanks);</span>
<span class="nc" id="L133">						runningTotal += theTotal;</span>
<span class="nc" id="L134">					}</span>
<span class="nc bnc" id="L135" title="All 4 branches missed.">					else if (aSkillKey.equals(skillKey) || ((percentageSignPosition &gt;= 0)</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">						&amp;&amp; aSkillKey.startsWith(skillKey.substring(0, percentageSignPosition))))</span>
					{
<span class="nc" id="L138">						foundSkill = true;</span>
<span class="nc" id="L139">						int theTotal =</span>
<span class="nc" id="L140">								getRunningTotal(mock, character, prereq, true, runningTotal, requiredRanks);</span>
<span class="nc" id="L141">						runningTotal += theTotal;</span>
					}
<span class="nc" id="L143">				}</span>
<span class="nc" id="L144">			}</span>
		}
<span class="nc bnc" id="L146" title="All 4 branches missed.">		else if (isType &amp;&amp; !foundSkill)</span>
		{
<span class="nc bnc" id="L148" title="All 2 branches missed.">			for (final Map.Entry&lt;Skill, Set&lt;Skill&gt;&gt; entry : serveAsSkills.entrySet())</span>
			{
<span class="nc" id="L150">				Skill mock = entry.getKey();</span>
<span class="nc" id="L151">				Set&lt;Skill&gt; targets = entry.getValue();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">				for (Skill target : targets)</span>
				{
<span class="nc bnc" id="L154" title="All 2 branches missed.">					if (foundSkill)</span>
					{
<span class="nc" id="L156">						break;</span>
					}
<span class="nc bnc" id="L158" title="All 2 branches missed.">					if (target.isType(skillKey))</span>
					{
<span class="nc" id="L160">						foundSkill = true;</span>
<span class="nc" id="L161">						int theTotal =</span>
<span class="nc" id="L162">								getRunningTotal(mock, character, prereq, true, runningTotal, requiredRanks);</span>
<span class="nc" id="L163">						runningTotal += theTotal;</span>
<span class="nc" id="L164">					}</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">					else if ((percentageSignPosition &gt;= 0))</span>
					{
<span class="nc" id="L167">						List&lt;Type&gt; mockTypes = target.getTrueTypeList(true);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">						for (Type mockType : mockTypes)</span>
						{
<span class="nc" id="L170">							foundMatch = matchesTypeWildCard(skillKey, percentageSignPosition, false, target);</span>
<span class="nc" id="L171">							foundSkill = foundMatch;</span>
<span class="nc" id="L172">							runningTotal =</span>
<span class="nc" id="L173">									getRunningTotal(mock, character, prereq, foundMatch, runningTotal, requiredRanks);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">							if (foundSkill)</span>
							{
<span class="nc" id="L176">								break;</span>
							}
<span class="nc" id="L178">						}</span>
					}
<span class="nc" id="L180">				}</span>
<span class="nc" id="L181">			}</span>
		}

		// If we are looking for a negative test i.e. !PRESKILL and the PC
		// doesn't have the skill we have to return a match
<span class="nc bnc" id="L186" title="All 2 branches missed.">		if (!foundSkill)</span>
		{
<span class="nc bnc" id="L188" title="All 2 branches missed.">			if (prereq.getOperator() == PrerequisiteOperator.LT)</span>
			{
<span class="nc" id="L190">				runningTotal++;</span>
			}
		}
<span class="nc" id="L193">		return countedTotal(prereq, runningTotal);</span>
	}

	private void getImitators(HashMap&lt;Skill, Set&lt;Skill&gt;&gt; serveAsSkills, Set&lt;Skill&gt; imitators, CharacterDisplay display)
	{
<span class="nc" id="L198">		Set&lt;Skill&gt; skillSet = new HashSet&lt;&gt;(display.getSkillSet());</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">		for (Skill aSkill : skillSet)</span>
		{
<span class="nc" id="L201">			Set&lt;Skill&gt; servesAs = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">			for (CDOMReference&lt;Skill&gt; ref : aSkill.getSafeListFor(ListKey.SERVES_AS_SKILL))</span>
			{
<span class="nc" id="L204">				servesAs.addAll(ref.getContainedObjects());</span>
<span class="nc" id="L205">			}</span>

<span class="nc bnc" id="L207" title="All 2 branches missed.">			if (!servesAs.isEmpty())</span>
			{
<span class="nc" id="L209">				imitators.add(aSkill);</span>
<span class="nc" id="L210">				serveAsSkills.put(aSkill, servesAs);</span>
			}
<span class="nc" id="L212">		}</span>
<span class="nc" id="L213">	}</span>

	/**
	 * Get the type of prerequisite handled by this token.
	 * @return the type of prerequisite handled by this token.
	 */
	@Override
	public String kindHandled()
	{
<span class="nc" id="L222">		return &quot;SKILL&quot;; //$NON-NLS-1$</span>
	}

	@Override
	public String toHtmlString(final Prerequisite prereq)
	{
<span class="nc" id="L228">		String skillName = prereq.getKey();</span>
<span class="nc bnc" id="L229" title="All 4 branches missed.">		if (prereq.getSubKey() != null &amp;&amp; !prereq.getSubKey().equals(&quot;&quot;)) //$NON-NLS-1$</span>
		{
<span class="nc" id="L231">			skillName += &quot; (&quot; + prereq.getSubKey() + ')'; //$NON-NLS-1$ </span>

		}

<span class="nc" id="L235">		return LanguageBundle.getFormattedString(&quot;PreSkill.toHtml&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L236">			prereq.getOperator().toDisplayString(), prereq.getOperand(), skillName);</span>
	}

	/**
	 * Check if the skill's types match the supplied pattern.
	 *  
	 * Mar 6, 2008 - Joe.Frazier
	 * @param skillKey Upper case key to be matched.
	 * @param percentageSignPosition Spot in the key which has the percentage sign
	 * @param found Has a match already been found?
	 * @param aSkill The skill to be checked.
	 * @return boolean.
	 */
	private boolean matchesTypeWildCard(final String skillKey, final int percentageSignPosition, boolean found,
		Skill aSkill)
	{
<span class="nc bnc" id="L252" title="All 2 branches missed.">		for (Type type : aSkill.getTrueTypeList(false))</span>
		{
<span class="nc bnc" id="L254" title="All 2 branches missed.">			if (type.toString().toUpperCase().startsWith(skillKey.substring(0, percentageSignPosition)))</span>
			{
<span class="nc" id="L256">				found = true;</span>
<span class="nc" id="L257">				break;</span>
			}
<span class="nc" id="L259">		}</span>
<span class="nc" id="L260">		return found;</span>
	}

	private int getRunningTotal(Skill aSkill, PlayerCharacter character, Prerequisite prereq, boolean foundMatch,
		int runningTotal, int requiredRanks)
	{
<span class="nc bnc" id="L266" title="All 2 branches missed.">		if (foundMatch)</span>
		{
<span class="nc bnc" id="L268" title="All 2 branches missed.">			if (prereq.isTotalValues())</span>
			{
<span class="nc" id="L270">				runningTotal += SkillRankControl.getTotalRank(character, aSkill).intValue();</span>
			}
			else
			{
<span class="nc bnc" id="L274" title="All 2 branches missed.">				if (prereq.getOperator().compare(SkillRankControl.getTotalRank(character, aSkill).intValue(),</span>
					requiredRanks) &gt; 0)
				{
<span class="nc" id="L277">					runningTotal++;</span>
				}
			}
		}
<span class="nc" id="L281">		return runningTotal;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>