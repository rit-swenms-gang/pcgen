<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BioSet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.core</a> &gt; <span class="el_source">BioSet.java</span></div><h1>BioSet.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2002 (C) Bryan McRoberts &lt;merton_monk@yahoo.com&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.core;

import java.net.URI;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.SortedMap;
import java.util.StringTokenizer;
import java.util.TreeMap;
import java.util.TreeSet;

import pcgen.base.util.CaseInsensitiveMap;
import pcgen.base.util.DoubleKeyMap;
import pcgen.base.util.TripleKeyMapToList;
import pcgen.cdom.base.Constants;
import pcgen.cdom.base.NonInteractive;
import pcgen.cdom.enumeration.Region;
import pcgen.cdom.util.CControl;
import pcgen.output.channel.ChannelUtilities;
import pcgen.output.channel.compat.HairColorCompat;
import pcgen.output.channel.compat.HeightCompat;
import pcgen.util.Logging;

<span class="fc" id="L44">public final class BioSet extends PObject implements NonInteractive</span>
{
	/**
	 * The Map that contains the AgeSet objects (stored by their Region and index).
	 */
<span class="fc" id="L49">	private DoubleKeyMap&lt;Optional&lt;Region&gt;, Integer, AgeSet&gt; ageMap = new DoubleKeyMap&lt;&gt;();</span>

<span class="fc" id="L51">	private CaseInsensitiveMap&lt;Integer&gt; ageNames = new CaseInsensitiveMap&lt;&gt;();</span>

	/**
	 * The entries that appear in the BioSet, sorted by Region and Race
	 */
<span class="fc" id="L56">	private TripleKeyMapToList&lt;Optional&lt;Region&gt;, String, String, String&gt; userMap = new TripleKeyMapToList&lt;&gt;();</span>

	/**
	 * Returns the AgeSet for the given Region and AgeSet index. Will return the AgeSet of
	 * the given index for no region if a specific AgeSet for the given Region does not
	 * exist.
	 * 
	 * @param region
	 *            The Region for which the AgeSet of the given index should be returned
	 * @param index
	 *            The index to determine the AgeSet to be returned.
	 * @return The AgeSet for the given Region and AgeSet index
	 */
	public AgeSet getAgeSet(Optional&lt;Region&gt; region, int index)
	{
<span class="fc" id="L71">		AgeSet ageSet = ageMap.get(region, index);</span>

<span class="pc bpc" id="L73" title="3 of 4 branches missed.">		if ((ageSet == null) || !ageSet.hasBonuses())</span>
		{
<span class="fc" id="L75">			ageSet = ageMap.get(Optional.empty(), index);</span>
		}

<span class="fc" id="L78">		return ageSet;</span>
	}

	/**
	 * Get the Age Set named
	 * @param ageCategory
	 * @return age set named
	 */
	public int getAgeSetNamed(final String ageCategory)
	{
<span class="nc" id="L88">		Integer cat = ageNames.get(ageCategory);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">		return (cat == null) ? -1 : cat;</span>
	}

	/**
	 * Builds a string describing the bio settings for the specified race (for no Region)
	 * This string is formatted so that it can be read in by BioSetLoader
	 *
	 * @param race   The name of the race to be output
	 * @return String A lst string describing the region's biosets.
	 */
	public String getBaseRegionPCCText(String race)
	{
<span class="nc" id="L101">		final StringBuilder sb = new StringBuilder(1000);</span>
<span class="nc" id="L102">		sb.append(&quot;REGION:&quot;).append(Constants.NONE).append(&quot;\n\n&quot;);</span>

<span class="nc" id="L104">		final SortedMap&lt;Integer, SortedMap&lt;String, SortedMap&lt;String, String&gt;&gt;&gt; ageSets = getRaceTagsByAge(race);</span>

<span class="nc" id="L106">		return appendAgesetInfo(Optional.empty(), ageSets, sb);</span>
	}

	/**
	 * Add the supplied line to the user map. The user map contains an array with
	 * an entry for each age set. The supplied index is used to ensure that the
	 * value is placed in the correct age bracket.
	 *
	 * @param region The region the race is defined in.
	 * @param race The race to be updated.
	 * @param tag The tag to be entered. Must be in the form key:value
	 * @param ageSetIndex The age set to be updated.
	 */
	public void addToUserMap(Optional&lt;Region&gt; region, final String race, final String tag, final int ageSetIndex)
	{
<span class="nc" id="L121">		final int x = tag.indexOf(':');</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">		if (x &lt; 0)</span>
		{
<span class="nc" id="L125">			Logging.errorPrint(&quot;Invalid value sent to map: &quot; + tag + &quot; (for Race &quot; + race + &quot;)&quot;);</span>

<span class="nc" id="L127">			return; // invalid tag</span>
		}

<span class="nc" id="L130">		String key = tag.substring(0, x);</span>
<span class="nc" id="L131">		List&lt;String&gt; r = userMap.getListFor(region, race, key);</span>
<span class="nc bnc" id="L132" title="All 4 branches missed.">		for (int i = (r == null) ? 0 : r.size(); i &lt; ageSetIndex; i++)</span>
		{
<span class="nc" id="L134">			userMap.addToListFor(region, race, key, &quot;0&quot;);</span>
		}
<span class="nc" id="L136">		userMap.addToListFor(region, race, key, tag.substring(x + 1));</span>
<span class="nc" id="L137">	}</span>

	/**
	 * Clear the user map
	 */
	public void clearUserMap()
	{
<span class="nc" id="L144">		userMap.clear();</span>
<span class="nc" id="L145">	}</span>

	/**
	 * Randomizes the values of the passed in attributes.
	 *
	 * @param randomizeStr .-delimited list of attributes to randomize.
	 * 						(AGE.HT.WT.EYES.HAIR.SKIN are the possible values.)
	 * @param pc The Player Character
	 */
	public void randomize(final String randomizeStr, final PlayerCharacter pc)
	{
<span class="pc bpc" id="L156" title="1 of 4 branches missed.">		if ((pc == null) || (pc.getRace() == null))</span>
		{
<span class="fc" id="L158">			return;</span>
		}

<span class="fc" id="L161">		final List&lt;String&gt; ranList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L162">		final StringTokenizer lineTok = new StringTokenizer(randomizeStr, &quot;.&quot;, false);</span>

<span class="fc bfc" id="L164" title="All 2 branches covered.">		while (lineTok.hasMoreTokens())</span>
		{
<span class="fc" id="L166">			final String aString = lineTok.nextToken();</span>

<span class="pc bpc" id="L168" title="1 of 2 branches missed.">			if (aString.startsWith(&quot;AGECAT&quot;))</span>
			{
<span class="nc" id="L170">				generateAge(Integer.parseInt(aString.substring(6)), false, pc);</span>
			}
			else
			{
<span class="fc" id="L174">				ranList.add(aString);</span>
			}
<span class="fc" id="L176">		}</span>

<span class="pc bpc" id="L178" title="1 of 2 branches missed.">		if (ranList.contains(&quot;AGE&quot;))</span>
		{
<span class="fc" id="L180">			generateAge(0, true, pc);</span>
		}

<span class="pc bpc" id="L183" title="3 of 4 branches missed.">		if (ranList.contains(&quot;HT&quot;) || ranList.contains(&quot;WT&quot;))</span>
		{
<span class="fc" id="L185">			generateHeightWeight(pc);</span>
		}

<span class="pc bpc" id="L188" title="1 of 2 branches missed.">		if (ranList.contains(&quot;EYES&quot;))</span>
		{
<span class="nc" id="L190">			pc.setEyeColor(generateBioValue(&quot;EYES&quot;, pc));</span>
		}

<span class="pc bpc" id="L193" title="1 of 2 branches missed.">		if (ranList.contains(&quot;HAIR&quot;))</span>
		{
<span class="nc" id="L195">			HairColorCompat.setCurrentHairColor(pc.getCharID(), generateBioValue(&quot;HAIR&quot;, pc));</span>
		}

<span class="pc bpc" id="L198" title="1 of 2 branches missed.">		if (ranList.contains(&quot;SKIN&quot;))</span>
		{
<span class="nc" id="L200">			ChannelUtilities.setControlledChannel(pc.getCharID(),</span>
<span class="nc" id="L201">				CControl.SKINCOLORINPUT, generateBioValue(&quot;SKINTONE&quot;, pc));</span>
		}
<span class="fc" id="L203">	}</span>

	@Override
	public String toString()
	{

<span class="nc" id="L209">        return &quot;AgeMap: &quot; + ageMap + &quot;\n&quot;</span>
                + &quot;UserMap: &quot; + userMap + &quot;\n&quot;;
	}

	private static String replaceString(final String argInput, final String replacement, final int value)
	{
<span class="nc" id="L215">		String input = argInput;</span>
<span class="nc" id="L216">		final int x = input.indexOf(replacement);</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">		if (x &gt;= 0)</span>
		{
<span class="nc" id="L220">			final String output = input.substring(0, x);</span>
<span class="nc" id="L221">			final String appendage = input.substring(x + replacement.length());</span>
<span class="nc" id="L222">			input = output + value + appendage;</span>
		}

<span class="nc" id="L225">		return input;</span>
	}

	/**
	 * Retrieves a collection of the tags defined for a race grouped by
	 * the age brackets.
	 *
	 * @param race   The name of the race.
	 * @return SortedMap A map of the gae brackets. Within each age bracket is a
	 * sorted map of the races (one only) and wihtin this is the tags for that
	 * race and age.
	 */
	private SortedMap&lt;Integer, SortedMap&lt;String, SortedMap&lt;String, String&gt;&gt;&gt; getRaceTagsByAge(String race)
	{
		// setup a mapped structure
<span class="nc" id="L240">		final SortedMap&lt;Integer, SortedMap&lt;String, SortedMap&lt;String, String&gt;&gt;&gt; ageSets = new TreeMap&lt;&gt;();</span>
		// Read in the user settings, split where necessary and add to the appropriate age bracket
<span class="nc bnc" id="L242" title="All 2 branches missed.">		for (String key : userMap.getTertiaryKeySet(Optional.empty(), race))</span>
		{
<span class="nc" id="L244">			addTagToAgeSet(ageSets, race, key, userMap.getListFor(Optional.empty(), race, key));</span>
<span class="nc" id="L245">		}</span>

<span class="nc" id="L247">		return ageSets;</span>
	}

	private String getTokenNumberInMaps(final String addKey, final int tokenNum, Optional&lt;Region&gt; region, String raceName)
	{
<span class="fc" id="L252">		final List&lt;String&gt; r = getValueInMaps(region, raceName, addKey);</span>

<span class="pc bpc" id="L254" title="1 of 2 branches missed.">		if (r == null)</span>
		{
<span class="fc" id="L256">			return null;</span>
		}

<span class="nc bnc" id="L259" title="All 2 branches missed.">		if (r.size() &lt;= tokenNum)</span>
		{
<span class="nc" id="L261">			return &quot;0&quot;;</span>
		}

<span class="nc" id="L264">		return r.get(tokenNum);</span>
	}

	/**
	 * Returns the List of items in the BioSet for the given Region, Race and token key.
	 * 
	 * @param region
	 *            The Region for which the information should be returned
	 * @param argRaceName
	 *            The name of the Race for which the info should be returned
	 * @param addKey
	 *            The token key of the information to be returned
	 * @return The List of items in the BioSet for the given parameters
	 */
	public List&lt;String&gt; getValueInMaps(Optional&lt;Region&gt; region, final String argRaceName, final String addKey)
	{
		final String anotherRaceName;

<span class="pc bpc" id="L282" title="1 of 2 branches missed.">		if (argRaceName.indexOf('(') &gt;= 0)</span>
		{
<span class="nc" id="L284">			anotherRaceName = argRaceName.substring(0, argRaceName.indexOf('(')).trim() + '%';</span>
		}
		else
		{
<span class="fc" id="L288">			anotherRaceName = argRaceName + '%';</span>
		}
<span class="fc" id="L290">		return mapFind(userMap, region, argRaceName, addKey, anotherRaceName);</span>
	}

	/**
	 * Adds the tag (key &amp; value) to the supplied ageSets collection. It is
	 * assumed that the ageSet already has an entry for each age bracket and
	 * that this entry will be a SortedMap of races. Each race will contain a
	 * SortedMap of tags and their values.&lt;br&gt; The key is assumed to be of the
	 * form region.race.tag eg &quot;Custom.Human%.MAXAGE&quot; The value is assumed to be
	 * either a list of values or a single value, depending on the tag. eg
	 * &quot;[34,52,69,110]&quot; or &quot;Blond|Brown&quot; If a single value, it will be added to
	 * the first age set. Multiple values are split amongst the age sets in
	 * order, with any values not matching an age set being ignored.
	 * 
	 * @param ageSets
	 *            The collection of age brackets.
	 * @param key
	 *            The region.race.tag specifier.
	 * @param value
	 *            The value of the tag.
	 */
	private void addTagToAgeSet(final SortedMap&lt;Integer, SortedMap&lt;String, SortedMap&lt;String, String&gt;&gt;&gt; ageSets,
		String race, String key, final List&lt;String&gt; value)
	{
<span class="nc" id="L314">		final Iterator&lt;String&gt; iter = value.iterator();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">		for (int ageBracket : ageNames.values())</span>
		{
<span class="nc bnc" id="L317" title="All 2 branches missed.">			if (!iter.hasNext())</span>
			{
<span class="nc" id="L319">				break;</span>
			}
<span class="nc" id="L321">			final String tagValue = iter.next();</span>
<span class="nc" id="L322">			SortedMap&lt;String, SortedMap&lt;String, String&gt;&gt; races = ageSets.get(ageBracket);</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">			if (races == null)</span>
			{
<span class="nc" id="L325">				races = new TreeMap&lt;&gt;();</span>
<span class="nc" id="L326">				ageSets.put(ageBracket, races);</span>
			}
<span class="nc" id="L328">			SortedMap&lt;String, String&gt; tags = races.get(race);</span>

<span class="nc bnc" id="L330" title="All 2 branches missed.">			if (tags == null)</span>
			{
<span class="nc" id="L332">				tags = new TreeMap&lt;&gt;();</span>
<span class="nc" id="L333">				races.put(race, tags);</span>
			}

<span class="nc" id="L336">			tags.put(key, tagValue);</span>
<span class="nc" id="L337">		}</span>
<span class="nc" id="L338">	}</span>

	private String appendAgesetInfo(Optional&lt;Region&gt; region,
		final SortedMap&lt;Integer, SortedMap&lt;String, SortedMap&lt;String, String&gt;&gt;&gt; ageSets, final StringBuilder sb)
	{
<span class="nc" id="L343">		Set&lt;Integer&gt; ageIndices = new TreeSet&lt;&gt;();</span>
<span class="nc" id="L344">		ageIndices.addAll(ageSets.keySet());</span>
<span class="nc" id="L345">		ageIndices.addAll(ageNames.values());</span>
		// Iterate through ages, outputing the info
<span class="nc bnc" id="L347" title="All 2 branches missed.">		for (Integer key : ageIndices)</span>
		{
<span class="nc" id="L349">			final SortedMap&lt;String, SortedMap&lt;String, String&gt;&gt; races = ageSets.get(key);</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">			if (races == null)</span>
			{
<span class="nc" id="L352">				continue;</span>
			}

<span class="nc" id="L355">			sb.append(&quot;AGESET:&quot;);</span>
<span class="nc" id="L356">			sb.append(ageMap.get(region, key).getLSTformat()).append(&quot;\n&quot;);</span>

<span class="nc bnc" id="L358" title="All 2 branches missed.">			for (final Map.Entry&lt;String, SortedMap&lt;String, String&gt;&gt; stringSortedMapEntry : races.entrySet())</span>
			{
<span class="nc bnc" id="L360" title="All 2 branches missed.">				if (!&quot;AGESET&quot;.equals(stringSortedMapEntry.getKey()))</span>
				{
<span class="nc" id="L362">					final SortedMap&lt;String, String&gt; tags = stringSortedMapEntry.getValue();</span>

<span class="nc bnc" id="L364" title="All 2 branches missed.">					for (final Map.Entry&lt;String, String&gt; stringStringEntry : tags.entrySet())</span>
					{
<span class="nc" id="L366">						sb.append(&quot;RACENAME:&quot;).append(stringSortedMapEntry.getKey()).append(&quot;\t\t&quot;);</span>
<span class="nc" id="L367">						sb.append(stringStringEntry.getKey()).append(':').append(stringStringEntry.getValue())</span>
<span class="nc" id="L368">							.append(&quot;\n&quot;);</span>
<span class="nc" id="L369">					}</span>
				}
<span class="nc" id="L371">			}</span>

<span class="nc" id="L373">			sb.append(&quot;\n&quot;);</span>
<span class="nc" id="L374">		}</span>

<span class="nc" id="L376">		return sb.toString();</span>
	}

	private void generateAge(final int ageCategory, final boolean useClassOnly, final PlayerCharacter pc)
	{
		// Can't find a base age for the category,
		// then there's nothing to do
<span class="fc" id="L383">		final String age = getTokenNumberInMaps(&quot;BASEAGE&quot;, ageCategory, pc.getDisplay().getRegion(),</span>
<span class="fc" id="L384">			pc.getRace().getKeyName().trim());</span>

<span class="pc bpc" id="L386" title="1 of 2 branches missed.">		if (age == null)</span>
		{
<span class="fc" id="L388">			return;</span>
		}

		// First check for class age modification information
<span class="nc" id="L392">		final int baseAge = Integer.parseInt(age);</span>
<span class="nc" id="L393">		int ageAdd = -1;</span>

<span class="nc" id="L395">		String aClass = getTokenNumberInMaps(&quot;CLASS&quot;, ageCategory, pc.getDisplay().getRegion(),</span>
<span class="nc" id="L396">			pc.getRace().getKeyName().trim());</span>

<span class="nc bnc" id="L398" title="All 4 branches missed.">		if (aClass != null &amp;&amp; !aClass.equals(&quot;0&quot;))</span>
		{
			// aClass looks like:
			// Barbarian,Rogue,Sorcerer[BASEAGEADD:3d6]|Bard,Fighter,Paladin,Ranger[BASEAGEADD:1d6]
			// So first, get the BASEAGEADD
<span class="nc" id="L403">			final StringTokenizer aTok = new StringTokenizer(aClass, &quot;|&quot;);</span>

<span class="nc bnc" id="L405" title="All 2 branches missed.">			while (aTok.hasMoreTokens())</span>
			{
				// String looks like:
				// Barbarian,Rogue,Sorcerer[BASEAGEADD:3d6]
<span class="nc" id="L409">				String aString = aTok.nextToken();</span>

<span class="nc" id="L411">				final int start = aString.indexOf('[');</span>
<span class="nc" id="L412">				final int end = aString.indexOf(']');</span>

				// should be BASEAGEADD:xdy
<span class="nc" id="L415">				String dieString = aString.substring(start + 1, end);</span>

<span class="nc bnc" id="L417" title="All 2 branches missed.">				if (dieString.startsWith(&quot;BASEAGEADD:&quot;))</span>
				{
<span class="nc" id="L419">					dieString = dieString.substring(11);</span>
				}

				// Remove the dieString
<span class="nc" id="L423">				aString = aString.substring(0, start);</span>

<span class="nc" id="L425">				final StringTokenizer bTok = new StringTokenizer(aString, &quot;,&quot;);</span>

<span class="nc bnc" id="L427" title="All 4 branches missed.">				while (bTok.hasMoreTokens() &amp;&amp; (ageAdd &lt; 0))</span>
				{
<span class="nc" id="L429">					final String tClass = bTok.nextToken();</span>

<span class="nc bnc" id="L431" title="All 2 branches missed.">					if (pc.getClassKeyed(tClass) != null)</span>
					{
<span class="nc" id="L433">						ageAdd = RollingMethods.roll(dieString);</span>
					}
<span class="nc" id="L435">				}</span>
<span class="nc" id="L436">			}</span>
		}

		// If there was no class age modification,
		// then generate a number based on the .LST
<span class="nc bnc" id="L441" title="All 4 branches missed.">		if ((ageAdd &lt; 0) &amp;&amp; !useClassOnly)</span>
		{
<span class="nc" id="L443">			aClass = getTokenNumberInMaps(&quot;AGEDIEROLL&quot;, ageCategory, pc.getDisplay().getRegion(),</span>
<span class="nc" id="L444">				pc.getRace().getKeyName().trim());</span>

<span class="nc bnc" id="L446" title="All 2 branches missed.">			if (aClass != null)</span>
			{
<span class="nc" id="L448">				ageAdd = RollingMethods.roll(aClass);</span>
			}
		}

<span class="nc bnc" id="L452" title="All 4 branches missed.">		if ((ageAdd &gt;= 0) &amp;&amp; (baseAge &gt; 0))</span>
		{
<span class="nc" id="L454">			final String maxage = getTokenNumberInMaps(&quot;MAXAGE&quot;, ageCategory, pc.getDisplay().getRegion(),</span>
<span class="nc" id="L455">				pc.getRace().getKeyName().trim());</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">			if (maxage != null)</span>
			{
<span class="nc" id="L458">				final int maxAge = Integer.parseInt(maxage);</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">				if (baseAge + ageAdd &gt; maxAge)</span>
				{
<span class="nc" id="L461">					ageAdd = maxAge - baseAge;</span>
				}
			}
<span class="nc" id="L464">			ChannelUtilities.setControlledChannel(pc.getCharID(), CControl.AGEINPUT, baseAge + ageAdd);</span>
		}
<span class="nc" id="L466">	}</span>

	private String generateBioValue(final String addKey, final PlayerCharacter pc)
	{
<span class="nc" id="L470">		final String line =</span>
<span class="nc" id="L471">				getTokenNumberInMaps(addKey, 0, pc.getDisplay().getRegion(), pc.getRace().getKeyName().trim());</span>
		final String rv;

<span class="nc bnc" id="L474" title="All 4 branches missed.">		if (line != null &amp;&amp; !line.isEmpty())</span>
		{
<span class="nc" id="L476">			final StringTokenizer aTok = new StringTokenizer(line, &quot;|&quot;);</span>
<span class="nc" id="L477">			final List&lt;String&gt; aList = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L479" title="All 2 branches missed.">			while (aTok.hasMoreTokens())</span>
			{
<span class="nc" id="L481">				aList.add(aTok.nextToken());</span>
			}

<span class="nc" id="L484">			final int roll = RollingMethods.roll(1, aList.size()) - 1; // needs to be 0-offset</span>
<span class="nc" id="L485">			rv = aList.get(roll);</span>
<span class="nc" id="L486">		}</span>
		else
		{
<span class="nc" id="L489">			rv = &quot;&quot;;</span>
		}

<span class="nc" id="L492">		return rv;</span>
	}

	private void generateHeightWeight(final PlayerCharacter pc)
	{
<span class="fc" id="L497">		int baseHeight = 0;</span>
<span class="fc" id="L498">		int baseWeight = 0;</span>
<span class="fc" id="L499">		int htAdd = 0;</span>
<span class="fc" id="L500">		int wtAdd = 0;</span>
<span class="fc" id="L501">		String totalWeight = null;</span>
<span class="fc" id="L502">		final String htwt =</span>
<span class="fc" id="L503">				getTokenNumberInMaps(&quot;SEX&quot;, 0, pc.getDisplay().getRegion(), pc.getRace().getKeyName().trim());</span>

<span class="pc bpc" id="L505" title="3 of 4 branches missed.">		if (htwt == null || &quot;0&quot;.equals(htwt))</span>
		{
<span class="fc" id="L507">			return;</span>
		}

<span class="nc" id="L510">		final StringTokenizer genderTok = new StringTokenizer(htwt, &quot;[]&quot;, false);</span>

<span class="nc bnc" id="L512" title="All 2 branches missed.">		while (genderTok.hasMoreTokens())</span>
		{
<span class="nc bnc" id="L514" title="All 2 branches missed.">			if (genderTok.nextToken().equals(pc.getGenderString()))</span>
			{
<span class="nc" id="L516">				final String htWtLine = genderTok.nextToken();</span>
<span class="nc" id="L517">				final StringTokenizer htwtTok = new StringTokenizer(htWtLine, &quot;|&quot;, false);</span>

<span class="nc bnc" id="L519" title="All 2 branches missed.">				while (htwtTok.hasMoreTokens())</span>
				{
<span class="nc" id="L521">					final String tag = htwtTok.nextToken();</span>

<span class="nc bnc" id="L523" title="All 2 branches missed.">					if (tag.startsWith(&quot;BASEHT:&quot;))</span>
					{
<span class="nc" id="L525">						baseHeight = Integer.parseInt(tag.substring(7));</span>
					}
<span class="nc bnc" id="L527" title="All 2 branches missed.">					else if (tag.startsWith(&quot;BASEWT:&quot;))</span>
					{
<span class="nc" id="L529">						baseWeight = Integer.parseInt(tag.substring(7));</span>
					}
<span class="nc bnc" id="L531" title="All 2 branches missed.">					else if (tag.startsWith(&quot;HTDIEROLL:&quot;))</span>
					{
<span class="nc" id="L533">						htAdd = RollingMethods.roll(tag.substring(10));</span>
					}
<span class="nc bnc" id="L535" title="All 2 branches missed.">					else if (tag.startsWith(&quot;WTDIEROLL:&quot;))</span>
					{
<span class="nc" id="L537">						wtAdd = RollingMethods.roll(tag.substring(10));</span>
					}
<span class="nc bnc" id="L539" title="All 2 branches missed.">					else if (tag.startsWith(&quot;TOTALWT:&quot;))</span>
					{
<span class="nc" id="L541">						totalWeight = tag.substring(8);</span>
					}
<span class="nc" id="L543">				}</span>

<span class="nc bnc" id="L545" title="All 4 branches missed.">				if ((baseHeight != 0) &amp;&amp; (htAdd != 0))</span>
				{
<span class="nc" id="L547">					HeightCompat.setCurrentHeight(pc.getCharID(), baseHeight + htAdd);</span>
				}

<span class="nc bnc" id="L550" title="All 6 branches missed.">				if ((totalWeight != null) &amp;&amp; (baseWeight != 0) &amp;&amp; (wtAdd != 0))</span>
				{
<span class="nc" id="L552">					totalWeight = replaceString(totalWeight, &quot;HTDIEROLL&quot;, htAdd);</span>
<span class="nc" id="L553">					totalWeight = replaceString(totalWeight, &quot;BASEWT&quot;, baseWeight);</span>
<span class="nc" id="L554">					totalWeight = replaceString(totalWeight, &quot;WTDIEROLL&quot;, wtAdd);</span>
<span class="nc" id="L555">					pc.setWeight(pc.getVariableValue(totalWeight, &quot;&quot;).intValue());</span>
				}

				break;
			}
		}
<span class="nc" id="L561">	}</span>

	private List&lt;String&gt; mapFind(final TripleKeyMapToList&lt;Optional&lt;Region&gt;, String, String, String&gt; argMap,
		Optional&lt;Region&gt; region, final String argRaceName, final String addKey, final String altRaceName)
	{
		// First check for region.racename.key
<span class="fc" id="L567">		List&lt;String&gt; r = argMap.getListFor(region, argRaceName, addKey);</span>
<span class="pc bpc" id="L568" title="3 of 4 branches missed.">		if (r != null &amp;&amp; !r.isEmpty())</span>
		{
<span class="nc" id="L570">			return r;</span>
		}
		//
		// If not found, try the race name without any parenthesis
		//
<span class="fc" id="L575">		final int altRaceLength = altRaceName.length();</span>

<span class="pc bpc" id="L577" title="1 of 2 branches missed.">		if (altRaceLength != 0)</span>
		{
<span class="fc" id="L579">			r = argMap.getListFor(region, altRaceName, addKey);</span>

<span class="pc bpc" id="L581" title="1 of 2 branches missed.">			if (r != null)</span>
			{
<span class="nc" id="L583">				return r;</span>
			}
		}
		//
		// If still not found, try the same two searches again without a region
		//
<span class="pc bpc" id="L589" title="1 of 2 branches missed.">		if (region.isPresent())</span>
		{
<span class="nc" id="L591">			return mapFind(argMap, Optional.empty(), argRaceName, addKey, altRaceName);</span>
		}
<span class="fc" id="L593">		return r;</span>
	}

	/**
	 * Adds the given AgeSet to this BioSet for the given Region
	 * @param region The Region for which the given BioSet should be added
	 * @param ageSet The AgeSet to be added to this BioSet for the given Region
	 * @param sourceURI The URI indicating the location of the AgeSet in the data
	 * @return
	 */
	public AgeSet addToAgeMap(Optional&lt;Region&gt; region, AgeSet ageSet, URI sourceURI)
	{
<span class="nc" id="L605">		AgeSet old = ageMap.get(region, ageSet.getIndex());</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">		if (old != null)</span>
		{
<span class="nc bnc" id="L608" title="All 6 branches missed.">			if (ageSet.hasBonuses() || !ageSet.getKits().isEmpty() || !ageSet.getKeyName().equals(old.getKeyName()))</span>
			{
<span class="nc" id="L610">				Logging.errorPrint(</span>
					&quot;Found second (non-identical) AGESET &quot; + &quot;in Bio Settings &quot; + sourceURI + &quot; for Region: &quot;
<span class="nc" id="L612">						+ region.orElse(Region.NONE) + &quot; Index: &quot; + ageSet.getIndex() + &quot; using the existing &quot; + old.getLSTformat());</span>
			}
<span class="nc" id="L614">			return old;</span>
		}
<span class="nc" id="L616">		ageMap.put(region, ageSet.getIndex(), ageSet);</span>
<span class="nc" id="L617">		return ageSet;</span>
	}

	public Integer addToNameMap(AgeSet ageSet)
	{
<span class="nc" id="L622">		return ageNames.put(ageSet.getKeyName(), ageSet.getIndex());</span>
	}

	public Set&lt;String&gt; getAgeCategories()
	{
<span class="nc" id="L627">		Set&lt;String&gt; set = new TreeSet&lt;&gt;();</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">		for (Object o : ageNames.keySet())</span>
		{
<span class="nc" id="L630">			set.add(o.toString());</span>
<span class="nc" id="L631">		}</span>
<span class="nc" id="L632">		return set;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>