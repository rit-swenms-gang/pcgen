<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Globals.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.core</a> &gt; <span class="el_source">Globals.java</span></div><h1>Globals.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2001 (C) Bryan McRoberts &lt;merton_monk@yahoo.com&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.core;

import java.io.File;
import java.io.IOException;
import java.net.URI;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.StringTokenizer;
import java.util.logging.Level;
import java.util.stream.Collectors;
import javax.swing.JFrame;
import pcgen.cdom.base.CDOMObject;
import pcgen.cdom.base.SortKeyRequired;
import pcgen.cdom.content.BaseDice;
import pcgen.cdom.content.CNAbilityFactory;
import pcgen.cdom.enumeration.FactKey;
import pcgen.cdom.enumeration.FactSetKey;
import pcgen.cdom.enumeration.MovementType;
import pcgen.cdom.enumeration.RaceType;
import pcgen.cdom.enumeration.SourceFormat;
import pcgen.cdom.enumeration.Type;
import pcgen.core.character.EquipSlot;
import pcgen.core.chooser.CDOMChooserFacadeImpl;
import pcgen.facade.core.ChooserFacade;
import pcgen.gui2.facade.Gui2InfoFactory;
import pcgen.rules.context.AbstractReferenceContext;
import pcgen.rules.context.LoadContext;
import pcgen.system.ConfigurationSettings;
import pcgen.system.PCGenSettings;
import pcgen.util.Logging;
import pcgen.util.chooser.ChooserFactory;
import pcgen.util.enumeration.VisionType;

/**
 * This is like the top level model container. However,
 * it is build from static methods rather than instantiated.
 */
public final class Globals
{
	/** These are changed during normal operation */
<span class="fc" id="L63">	private static final List&lt;PlayerCharacter&gt; PC_LIST = new ArrayList&lt;&gt;();</span>

	/** NOTE: The defaultPath is duplicated in LstSystemLoader. */
<span class="fc" id="L66">	private static final String DEFAULT_PCG_PATH = getUserFilesPath() + File.separator + &quot;characters&quot;; //$NON-NLS-1$</span>

<span class="fc" id="L68">	private static final List&lt;String&gt; CUST_COLUMN_WIDTH = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L69">	private static SourceFormat sourceDisplay = SourceFormat.LONG;</span>
<span class="fc" id="L70">	private static int selectedPaper = -1;</span>

	/** we need maps for efficient lookups */
<span class="fc" id="L73">	private static final Map&lt;URI, Campaign&gt; CAMPAIGN_MAP = new HashMap&lt;&gt;();</span>
<span class="fc" id="L74">	private static final Map&lt;String, Integer&gt; EQ_SLOT_MAP = new HashMap&lt;&gt;();</span>

	// end of filter creation sets
	private static JFrame rootFrame;

	/** whether or not the GUI is used (false for command line) */
<span class="fc" id="L80">	private static boolean useGUI = true;</span>

	// Optimizations used by any code needing empty arrays.  All empty arrays
	// of the same type are idempotent.

	private Globals()
	{
	}

	/**
	 * This method is used to locate a Campaign object based on its file
	 * name (in URL syntax).
	 *
	 * @param aName           String name of file, in URL.toString() format
	 * @param complainOnError boolean true to log an error if the campaign
	 *                        cannot be found
	 * @return Campaign loaded from the given filename, or null if it
	 *         cannot be found
	 */
	public static Campaign getCampaignByURI(final URI aName, final boolean complainOnError)
	{
<span class="nc" id="L101">		final Campaign campaign = CAMPAIGN_MAP.get(aName);</span>

<span class="nc bnc" id="L103" title="All 4 branches missed.">		if ((campaign == null) &amp;&amp; complainOnError)</span>
		{
<span class="nc" id="L105">			Logging.errorPrint(&quot;Could not find campaign by filename: &quot; + aName);</span>
		}

<span class="nc" id="L108">		return campaign;</span>
	}

	/**
	 * Get campaign list
	 * @return campaign list
	 */
	public static List&lt;Campaign&gt; getCampaignList()
	{
<span class="nc" id="L117">		return List.copyOf(CAMPAIGN_MAP.values());</span>
	}

	/**
	 * Get campaign by key
	 * @param aKey
	 * @return Campaign
	 */
	public static Campaign getCampaignKeyed(final String aKey)
	{
<span class="nc" id="L127">		final Campaign campaign = getCampaignKeyedSilently(aKey);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">		if (campaign == null)</span>
		{
<span class="nc" id="L130">			Logging.errorPrint(&quot;Could not find campaign: &quot; + aKey);</span>
		}

<span class="nc" id="L133">		return campaign;</span>
	}

	/**
	 * Get campaign by key
	 * @param aKey
	 * @return Campaign
	 */
	public static Campaign getCampaignKeyedSilently(final String aKey)
	{
<span class="nc" id="L143">		return getCampaignList().stream()</span>
<span class="nc" id="L144">		                    .filter(campaign -&gt; campaign.getKeyName().equalsIgnoreCase(aKey))</span>
<span class="nc" id="L145">		                    .findFirst()</span>
<span class="nc" id="L146">		                    .orElse(null);</span>

	}

	/**
	 * Finds all PObjects that match the passed in type.  All the types listed
	 * in aType must match for the object to be returned.
	 * @param aPObjectList List of PObjects to search
	 * @param aType A &quot;.&quot; separated list of TYPEs to match
	 * @return List of PObjects matching all TYPEs
	 */
	public static &lt;T extends CDOMObject&gt; List&lt;T&gt; getPObjectsOfType(final Collection&lt;T&gt; aPObjectList, final String aType)
	{
<span class="nc" id="L159">		final ArrayList&lt;T&gt; ret = new ArrayList&lt;&gt;(aPObjectList.size());</span>

<span class="nc" id="L161">		final List&lt;String&gt; typeList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L162">		final StringTokenizer tok = new StringTokenizer(aType, &quot;.&quot;);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">		while (tok.hasMoreTokens())</span>
		{
<span class="nc" id="L165">			typeList.add(tok.nextToken());</span>
		}

<span class="nc bnc" id="L168" title="All 2 branches missed.">		for (final T anObject : aPObjectList)</span>
		{
<span class="nc bnc" id="L170" title="All 2 branches missed.">			if (isMatch(typeList, anObject))</span>
			{
<span class="nc" id="L172">				ret.add(anObject);</span>
			}
<span class="nc" id="L174">		}</span>
<span class="nc" id="L175">		ret.trimToSize();</span>
<span class="nc" id="L176">		return ret;</span>
	}

	private static &lt;T extends CDOMObject&gt; boolean isMatch(List&lt;String&gt; typeList, T anObject)
	{
<span class="nc bnc" id="L181" title="All 2 branches missed.">		for (final String type : typeList)</span>
		{
<span class="nc bnc" id="L183" title="All 2 branches missed.">			final boolean sense = (type.charAt(0) != '!');</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">			if (anObject.isType(type) != sense)</span>
			{
<span class="nc" id="L186">				return false;</span>
			}
<span class="nc" id="L188">		}</span>
<span class="nc" id="L189">		return true;</span>
	}

	// END Game Modes Section.

	/**
	 * Get the default path
	 * @return default path
	 */
	public static String getDefaultPath()
	{
<span class="fc" id="L200">		return ConfigurationSettings.getUserDir();</span>
	}

	/**
	 * Get the default path
	 * @return default path
	 */
	private static String getUserFilesPath()
	{
<span class="fc" id="L209">		return expandRelativePath(System.getProperty(&quot;user.home&quot;) + File.separator + &quot;.pcgen&quot;);</span>
	}

	/**
	 * Returns the name of the Default Spell Book, or null if there is no default spell book.
	 * @return default spellbook
	 */
	public static String getDefaultSpellBook()
	{
<span class="fc" id="L218">		GameMode game = SettingsHandler.getGameAsProperty().get();</span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">		if (game != null)</span>
		{
<span class="fc" id="L221">			return game.getDefaultSpellBook();</span>
		}

<span class="nc" id="L224">		return null;</span>
	}

	/**
	 * Get equipment slot by name
	 * @param aName
	 * @return equipment slot
	 */
	public static EquipSlot getEquipSlotByName(final String aName)
	{
<span class="nc" id="L234">		return SystemCollections.getUnmodifiableEquipSlotList()</span>
<span class="nc" id="L235">		                        .stream()</span>
<span class="nc" id="L236">		                        .filter(es -&gt; es.getSlotName().equals(aName))</span>
<span class="nc" id="L237">		                        .findFirst()</span>
<span class="nc" id="L238">		                        .orElse(null);</span>
	}

	/**
	 * Set equipment slot type count
	 * @param aString
	 * @param aNum
	 */
	public static void setEquipSlotTypeCount(final String aString, final int aNum)
	{
<span class="nc" id="L248">		EQ_SLOT_MAP.put(aString, aNum);</span>
<span class="nc" id="L249">	}</span>

	/**
	 * returns the # of slots for an equipmentslots Type
	 * The number of slots is define by the NUMSLOTS: line
	 * in the game mode file equipmentslots.lst
	 * @param aType
	 * @return equipment slot type count
	 */
	public static int getEquipSlotTypeCount(final String aType)
	{
<span class="nc" id="L260">		return EQ_SLOT_MAP.computeIfAbsent(aType, s -&gt; 0);</span>
	}

	/**
	 * Get the game mode point pool name
	 * @return game mode point pool name
	 */
	public static String getGameModePointPoolName()
	{
<span class="nc" id="L269">		return SettingsHandler.getGameAsProperty().get().getPointPoolName();</span>
	}

	/**
	 * TRUE if the game mode has a point pool
	 * @return TRUE if the game mode has a point pool
	 */
	public static boolean getGameModeHasPointPool()
	{
<span class="nc bnc" id="L278" title="All 2 branches missed.">		return !getGameModePointPoolName().isEmpty();</span>
	}

	/**
	 * Get game mode unit set
	 * @return game mode unit set
	 */
	public static UnitSet getGameModeUnitSet()
	{
<span class="nc" id="L287">		return SettingsHandler.getGameAsProperty().get().getUnitSet();</span>
	}

	/**
	 * Get PC List
	 * @return List of Pcs
	 */
	public static List&lt;PlayerCharacter&gt; getPCList()
	{
<span class="nc" id="L296">		return PC_LIST;</span>
	}

	/**
	 * Get paper count
	 * @return paper count
	 */
	public static int getPaperCount()
	{
<span class="nc" id="L305">		return SettingsHandler.getGameAsProperty().get().getModeContext().getReferenceContext()</span>
<span class="nc" id="L306">			.getConstructedObjectCount(PaperInfo.class);</span>
	}

	/**
	 * Get paper info
	 * @param infoType
	 * @return paper info
	 */
	public static String getPaperInfo(final int infoType)
	{
<span class="nc" id="L316">		return getPaperInfo(selectedPaper, infoType);</span>
	}

	/**
	 * Get paper info
	 * @param idx
	 * @param infoType
	 * @return paper info
	 */
	public static String getPaperInfo(final int idx, final int infoType)
	{
<span class="nc bnc" id="L327" title="All 4 branches missed.">		if ((idx &lt; 0) || (idx &gt;= getPaperCount()))</span>
		{
<span class="nc" id="L329">			return null;</span>
		}

<span class="nc" id="L332">		return getSortedPaperInfo().get(idx).getPaperInfo(infoType);</span>
	}

	private static List&lt;PaperInfo&gt; getSortedPaperInfo()
	{
<span class="nc" id="L337">		List&lt;PaperInfo&gt; items = new ArrayList&lt;&gt;(SettingsHandler.getGameAsProperty().get().getModeContext().getReferenceContext()</span>
<span class="nc" id="L338">			.getConstructedCDOMObjects(PaperInfo.class));</span>
<span class="nc" id="L339">		items.sort(Comparator.comparing(SortKeyRequired::getSortKey));</span>
<span class="nc" id="L340">		return items;</span>
	}

	/**
	 * Sets the root frame
	 * The root frame is the container in which all
	 * other panels, frame etc are placed.
	 *
	 * @param frame the {@code PCGen_Frame1} which is to be root
	 */
	public static void setRootFrame(final JFrame frame)
	{
<span class="nc" id="L352">		rootFrame = frame;</span>
<span class="nc" id="L353">	}</span>

	/**
	 * Returns the current root frame.
	 *
	 * @return the {@code rootFrame} property
	 */
	public static JFrame getRootFrame()
	{
<span class="nc" id="L362">		return rootFrame;</span>
	}

	/**
	 * Get selected paper
	 * @return selected paper
	 */
	public static int getSelectedPaper()
	{
<span class="nc" id="L371">		return selectedPaper;</span>
	}

	/**
	 * Set source display
	 * @param sourceType
	 */
	public static void setSourceDisplay(final SourceFormat sourceType)
	{
<span class="nc" id="L380">		sourceDisplay = sourceType;</span>
<span class="nc" id="L381">	}</span>

	/**
	 * Get source display
	 * @return source display
	 */
	public static SourceFormat getSourceDisplay()
	{
<span class="nc" id="L389">		return sourceDisplay;</span>
	}

	/**
	 * Sets whether to use the GUI or not
	 * @param aBool
	 */
	public static void setUseGUI(final boolean aBool)
	{
<span class="fc" id="L398">		useGUI = aBool;</span>
<span class="fc" id="L399">	}</span>

	/**
	 * TRUE if using UI
	 * @return TRUE if using UI
	 */
	static boolean getUseGUI()
	{
<span class="nc" id="L407">		return useGUI;</span>
	}

	/**
	 * This method is called by the persistence layer to
	 * add a campaign that it has located to the globl campaign list.
	 *
	 * @param campaign Campaign loaded from persistence to add to the
	 *                 Global campaign list
	 */
	public static void addCampaign(final Campaign campaign)
	{
<span class="nc" id="L419">		CAMPAIGN_MAP.put(campaign.getSourceURI(), campaign);</span>
<span class="nc" id="L420">	}</span>

	/**
	 * Adjust damage
	 * @param aDamage
	 * @return adjusted damage
	 */
	public static String adjustDamage(String aDamage, int sizeDiff)
	{
<span class="nc bnc" id="L429" title="All 2 branches missed.">		if (aDamage.isEmpty())</span>
		{
<span class="nc" id="L431">			return aDamage;</span>
		}
<span class="nc" id="L433">		final AbstractReferenceContext ref = getContext().getReferenceContext();</span>
<span class="nc" id="L434">		BaseDice bd = ref.silentlyGetConstructedCDOMObject(BaseDice.class, aDamage);</span>
<span class="nc" id="L435">		int multiplier = 0;</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">		if (bd == null)</span>
		{
			//Need to test for higher dice
<span class="nc" id="L439">			final RollInfo aRollInfo = new RollInfo(aDamage);</span>
<span class="nc" id="L440">			final String baseDice = &quot;1d&quot; + Integer.toString(aRollInfo.sides);</span>
<span class="nc" id="L441">			bd = ref.silentlyGetConstructedCDOMObject(BaseDice.class, baseDice);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">			if (bd != null)</span>
			{
<span class="nc" id="L444">				multiplier = aRollInfo.times;</span>
			}
<span class="nc" id="L446">		}</span>
		else
		{
<span class="nc" id="L449">			multiplier = 1;</span>
		}
		RollInfo bi;
<span class="nc bnc" id="L452" title="All 2 branches missed.">		if (bd == null)</span>
		{
<span class="nc" id="L454">			bi = new RollInfo(aDamage);</span>
		}
		else
		{
			List&lt;RollInfo&gt; steps;
<span class="nc bnc" id="L459" title="All 2 branches missed.">			if (sizeDiff &gt; 0)</span>
			{
<span class="nc" id="L461">				steps = bd.getUpSteps();</span>
			}
<span class="nc bnc" id="L463" title="All 2 branches missed.">			else if (sizeDiff &lt; 0)</span>
			{
<span class="nc" id="L465">				steps = bd.getDownSteps();</span>
			}
			else
			{
				// Not a warning?
<span class="nc" id="L470">				return aDamage;</span>
			}
<span class="nc" id="L472">			final int difference = Math.abs(sizeDiff);</span>

			final int index;
<span class="nc bnc" id="L475" title="All 2 branches missed.">			if (steps.size() &gt; difference)</span>
			{
<span class="nc" id="L477">				index = difference - 1;</span>
			}
			else
			{
<span class="nc" id="L481">				index = steps.size() - 1;</span>
			}
<span class="nc" id="L483">			bi = steps.get(index);</span>
		}
<span class="nc bnc" id="L485" title="All 2 branches missed.">		if (multiplier &gt; 1)</span>
		{
			// Ugh, have to do this for &quot;cloning&quot; to avoid polluting the master
			// RollInfo
<span class="nc" id="L489">			bi = new RollInfo(bi.toString());</span>
<span class="nc" id="L490">			bi.times *= multiplier;</span>
		}
<span class="nc" id="L492">		return bi.toString();</span>
	}

	/**
	 * Return true if resizing the equipment will have any &quot;noticable&quot; effect
	 * checks for cost modification, armor bonus, weight, capacity
	 * @param typeList
	 * @return TRUE or FALSE
	 */
	public static boolean canResizeHaveEffect(List&lt;String&gt; typeList)
	{
<span class="nc" id="L503">		final List&lt;String&gt; resizeTypeList = SettingsHandler.getGameAsProperty().get().getResizableTypeList().stream()</span>
<span class="nc" id="L504">			.map(Type::toString).map(String::toUpperCase).collect(Collectors.toList());</span>
<span class="nc" id="L505">		return typeList.stream().map(String::toUpperCase).anyMatch(resizeTypeList::contains);</span>
	}

	/**
	 * Find out the state of a PRERULE check
	 * @param aKey
	 * @return true or false
	 */
	public static boolean checkRule(final String aKey)
	{
<span class="fc" id="L515">		final RuleCheck rule = SettingsHandler.getGameAsProperty().get().getModeContext().getReferenceContext()</span>
<span class="fc" id="L516">			.silentlyGetConstructedCDOMObject(RuleCheck.class, aKey);</span>
<span class="pc bpc" id="L517" title="1 of 2 branches missed.">		if (rule == null)</span>
		{
<span class="fc" id="L519">			return false;</span>
		}
<span class="nc bnc" id="L521" title="All 2 branches missed.">		if (SettingsHandler.hasRuleCheck(aKey))</span>
		{
<span class="nc" id="L523">			return SettingsHandler.getRuleCheck(aKey);</span>
		}
		else
		{
<span class="nc" id="L527">			return rule.getDefault();</span>
		}
	}

	/**
	 * This method is called by the persistence layer to clear the global
	 * campaigns for a refresh.
	 */
	public static void clearCampaignsForRefresh()
	{
<span class="nc" id="L537">		emptyLists();</span>
<span class="nc" id="L538">		CAMPAIGN_MAP.clear();</span>
<span class="nc" id="L539">	}</span>

	/**
	 * Check if enough data has been loaded to support character creation.
	 * Will also report to the log the number of items of each of the 
	 * necessary types that are currently loaded.  
	 * @return true or false
	 */
	public static boolean displayListsHappy()
	{
		// NOTE: If you add something here be sure to update the log output below
<span class="nc" id="L550">		final boolean listsHappy = checkListsHappy();</span>

<span class="nc bnc" id="L552" title="All 2 branches missed.">		final Level logLevel = listsHappy ? Logging.DEBUG : Logging.WARNING;</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">		if (Logging.isLoggable(logLevel))</span>
		{
<span class="nc" id="L555">			Logging.log(logLevel, &quot;Number of objects loaded. The following should &quot; + &quot;all be greater than 0:&quot;);</span>
<span class="nc" id="L556">			AbstractReferenceContext referenceContext = getContext().getReferenceContext();</span>
<span class="nc" id="L557">			Logging.log(logLevel, &quot;Races=&quot; + referenceContext.getConstructedCDOMObjects(Race.class).size());</span>
<span class="nc" id="L558">			Logging.log(logLevel, &quot;Classes=&quot; + referenceContext.getConstructedCDOMObjects(PCClass.class).size());</span>
<span class="nc" id="L559">			Logging.log(logLevel, &quot;Skills=&quot; + referenceContext.getConstructedCDOMObjects(Skill.class).size());</span>
<span class="nc" id="L560">			AbilityCategory featCategory = referenceContext.get(AbilityCategory.class, &quot;FEAT&quot;);</span>
<span class="nc" id="L561">			Logging.log(logLevel,</span>
<span class="nc" id="L562">				&quot;Feats=&quot; + referenceContext.getManufacturerId(featCategory).getConstructedObjectCount());</span>
<span class="nc" id="L563">			Logging.log(logLevel, &quot;Equipment=&quot; + referenceContext.getConstructedCDOMObjects(Equipment.class).size());</span>
<span class="nc" id="L564">			Logging.log(logLevel, &quot;ArmorProfs=&quot; + referenceContext.getConstructedCDOMObjects(ArmorProf.class).size());</span>
<span class="nc" id="L565">			Logging.log(logLevel, &quot;ShieldProfs=&quot; + referenceContext.getConstructedCDOMObjects(ShieldProf.class).size());</span>
<span class="nc" id="L566">			Logging.log(logLevel, &quot;WeaponProfs=&quot; + referenceContext.getConstructedCDOMObjects(WeaponProf.class).size());</span>
<span class="nc" id="L567">			Logging.log(logLevel, &quot;Kits=&quot; + referenceContext.getConstructedCDOMObjects(Kit.class).size());</span>
<span class="nc" id="L568">			Logging.log(logLevel, &quot;Templates=&quot; + referenceContext.getConstructedCDOMObjects(PCTemplate.class).size());</span>
		}
<span class="nc" id="L570">		return listsHappy;</span>
	}

	/**
	 * Check if enough data has been loaded to support character creation.
	 * @return true or false
	 */
	private static boolean checkListsHappy()
	{
		// NOTE: If you add something here be sure to update the log output in displayListsHappy above
<span class="nc bnc" id="L580" title="All 2 branches missed.">		return !((getContext().getReferenceContext().getConstructedCDOMObjects(Race.class).isEmpty())</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">			|| (getContext().getReferenceContext().getConstructedCDOMObjects(PCClass.class).isEmpty())</span>
			//				|| (getContext().ref.getConstructedCDOMObjects(Skill.class).size() == 0)
			//				|| (getContext().ref.getManufacturer(
			//						Ability.class, AbilityCategory.FEAT).getConstructedObjectCount() == 0)
<span class="nc bnc" id="L585" title="All 2 branches missed.">			|| (getContext().getReferenceContext().getConstructedCDOMObjects(Equipment.class).isEmpty())</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">			|| (getContext().getReferenceContext().getConstructedCDOMObjects(WeaponProf.class).isEmpty()));</span>
	}

	/**
	 * Clears all lists of game data.
	 */
	public static void emptyLists()
	{
		// These lists do not need cleared; they are tied to game mode
		// alignmentList
		// checkList
		// gameModeList
		// campaignList
		// statList
		// All other lists should be cleared!!!
		//////////////////////////////////////
		// DO NOT CLEAR THESE HERE!!!
		// They only get loaded once.
		//
		//birthplaceList.clear();
		//cityList.clear();
		//hairStyleList.clear();
		//helpContextFileList.clear();
		//interestsList.clear();
		//locationList.clear();
		//paperInfo.clear();
		//phobiaList.clear();
		//phraseList.clear();
		//schoolsList.clear();
		//sizeAdjustmentList.clear();
		//specialsList.clear();
		//speechList.clear();
		//traitList.clear();
		//unitSet.clear();
		//////////////////////////////////////

		// Clear Maps (not strictly necessary, but done for consistency)
<span class="fc" id="L623">		VisionType.clearConstants();</span>
<span class="fc" id="L624">		FactKey.clearConstants();</span>
<span class="fc" id="L625">		FactSetKey.clearConstants();</span>

		// Perform other special cleanup
<span class="fc" id="L628">		Equipment.clearEquipmentTypes();</span>
<span class="fc" id="L629">		SettingsHandler.getGameAsProperty().get().clearLoadContext();</span>

<span class="fc" id="L631">		RaceType.clearConstants();</span>
<span class="fc" id="L632">		CNAbilityFactory.reset();</span>
<span class="fc" id="L633">		MovementType.clearConstants();</span>
<span class="fc" id="L634">	}</span>

	/**
	 * Execute post export commands for standard files
	 * @param fileName
	 */
	public static void executePostExportCommandStandard(final String fileName)
	{
<span class="nc" id="L642">		final String postExportCommand = SettingsHandler.getPostExportCommandStandard();</span>
<span class="nc" id="L643">		executePostExportCommand(fileName, postExportCommand);</span>
<span class="nc" id="L644">	}</span>

	/**
	 * Execute post export commands for PDF
	 * @param fileName
	 */
	public static void executePostExportCommandPDF(final String fileName)
	{
<span class="nc" id="L652">		final String postExportCommand = SettingsHandler.getPostExportCommandPDF();</span>
<span class="nc" id="L653">		executePostExportCommand(fileName, postExportCommand);</span>
<span class="nc" id="L654">	}</span>

	/**
	 * Execute any post export commands
	 * @param fileName
	 * @param postExportCommand
	 */
	private static void executePostExportCommand(final String fileName, final String postExportCommand)
	{
<span class="nc" id="L663">		final List&lt;String&gt; aList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L664">		final StringTokenizer aTok = new StringTokenizer(postExportCommand, &quot; &quot;);</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">		while (aTok.hasMoreTokens())</span>
		{
<span class="nc" id="L667">			aList.add(aTok.nextToken());</span>
		}
<span class="nc" id="L669">		final String[] cmdArray = new String[aList.size()];</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">		for (int idx = 0; idx &lt; aList.size(); idx++)</span>
		{
<span class="nc" id="L672">			final String s = aList.get(idx);</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">			if (s.contains(&quot;%&quot;))</span>
			{
<span class="nc" id="L675">				final String beforeString = s.substring(0, s.indexOf('%'));</span>
<span class="nc" id="L676">				final String afterString = s.substring(s.indexOf('%') + 1);</span>
<span class="nc" id="L677">				cmdArray[idx] = beforeString + fileName + afterString;</span>
<span class="nc" id="L678">			}</span>
			else
			{
<span class="nc" id="L681">				cmdArray[idx] = s;</span>
			}
		}

<span class="nc bnc" id="L685" title="All 2 branches missed.">		if (cmdArray.length &gt; 0)</span>
		{
			try
			{
<span class="nc" id="L689">				Runtime.getRuntime().exec(cmdArray);</span>
			}
<span class="nc" id="L691">			catch (final IOException ex)</span>
			{
<span class="nc" id="L693">				Logging.errorPrint(&quot;Could not run &quot; + postExportCommand + &quot; after exporting &quot; + fileName, ex);</span>
<span class="nc" id="L694">			}</span>
		}
<span class="nc" id="L696">	}</span>

	/**
	 * Select the paper
	 * @param paperName
	 * @return TRUE if OK
	 */
	public static boolean selectPaper(final String paperName)
	{
<span class="nc" id="L705">		List&lt;PaperInfo&gt; paperInfoObjects = getSortedPaperInfo();</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">		for (int i = 0; i &lt; paperInfoObjects.size(); i++)</span>
		{
<span class="nc" id="L708">			final PaperInfo pi = paperInfoObjects.get(i);</span>

<span class="nc bnc" id="L710" title="All 2 branches missed.">			if (pi.getName().equals(paperName))</span>
			{
<span class="nc" id="L712">				selectedPaper = i;</span>
<span class="nc" id="L713">				PCGenSettings.getInstance().setProperty(PCGenSettings.PAPERSIZE, paperName);</span>

<span class="nc" id="L715">				return true;</span>
			}
		}

<span class="nc" id="L719">		selectedPaper = -1;</span>

<span class="nc" id="L721">		return false;</span>
	}

	/**
	 * Apply the user's preferences to the initial state of the Globals.  
	 */
	public static void initPreferences()
	{
<span class="nc bnc" id="L729" title="All 2 branches missed.">		if (selectedPaper != -1)</span>
		{
			// Already initialized
<span class="nc" id="L732">			return;</span>
		}
<span class="nc" id="L734">		final String papersize = PCGenSettings.getInstance().initProperty(PCGenSettings.PAPERSIZE, &quot;A4&quot;);</span>
<span class="nc" id="L735">		selectPaper(papersize);</span>
<span class="nc" id="L736">	}</span>

	/**
	 * Sorts chooser lists using the appropriate method, based on the type of the first item in either list.
	 * Not pretty, but it works.
	 *
	 * @param availableList
	 * @param selectedList
	 */
	public static void sortChooserLists(final List availableList, final List selectedList)
	{
		final boolean nonPObjectInList;

<span class="nc bnc" id="L749" title="All 2 branches missed.">		if (!availableList.isEmpty())</span>
		{
<span class="nc bnc" id="L751" title="All 2 branches missed.">			nonPObjectInList = !(availableList.get(0) instanceof CDOMObject);</span>
		}
<span class="nc bnc" id="L753" title="All 2 branches missed.">		else if (!selectedList.isEmpty())</span>
		{
<span class="nc bnc" id="L755" title="All 2 branches missed.">			nonPObjectInList = !(selectedList.get(0) instanceof CDOMObject);</span>
		}
		else
		{
<span class="nc" id="L759">			nonPObjectInList = false;</span>
		}

<span class="nc bnc" id="L762" title="All 2 branches missed.">		if (nonPObjectInList)</span>
		{
<span class="nc" id="L764">			Collections.sort(availableList);</span>
			// NOCHOICE feats add nulls to the selectedList
<span class="nc bnc" id="L766" title="All 4 branches missed.">			if ((!selectedList.isEmpty()) &amp;&amp; (selectedList.get(0) != null))</span>
			{
<span class="nc" id="L768">				Collections.sort(selectedList);</span>
			}
		}
		else
		{
<span class="nc" id="L773">			sortPObjectListByName(availableList);</span>
<span class="nc" id="L774">			sortPObjectListByName(selectedList);</span>
		}
<span class="nc" id="L776">	}</span>

	/**
	 * Sort Pcgen Object list
	 * @param aList
	 * @return Sorted list of Pcgen Objects
	 */
	static List&lt;? extends CDOMObject&gt; sortPObjectList(final List&lt;? extends CDOMObject&gt; aList)
	{
<span class="nc" id="L785">		aList.sort(CDOMObject.P_OBJECT_COMP);</span>

<span class="nc" id="L787">		return aList;</span>
	}

	/**
	 * Sort Pcgen Object list by name
	 * @param &lt;T&gt; 
	 * 
	 * @param aList
	 * @return Sorted list of Pcgen Objects
	 */
	public static &lt;T extends CDOMObject&gt; List&lt;T&gt; sortPObjectListByName(final List&lt;T&gt; aList)
	{
<span class="nc" id="L799">		aList.sort(CDOMObject.P_OBJECT_NAME_COMP);</span>

<span class="nc" id="L801">		return aList;</span>
	}

	static String getBonusFeatString()
	{
<span class="nc" id="L806">		final List&lt;String&gt; bonusFeatLevels = SettingsHandler.getGameAsProperty().get().getBonusFeatLevels();</span>
<span class="nc bnc" id="L807" title="All 4 branches missed.">		if ((bonusFeatLevels == null) || bonusFeatLevels.isEmpty())</span>
		{
			// Default to no bonus feats.
<span class="nc" id="L810">			return &quot;9999|0&quot;;</span>
		}
<span class="nc" id="L812">		return bonusFeatLevels.get(0);</span>
	}

	static int getBonusStatsForLevel(final int level, final PlayerCharacter aPC)
	{
<span class="nc" id="L817">		int num = 0;</span>

<span class="nc bnc" id="L819" title="All 2 branches missed.">		for (final String s : SettingsHandler.getGameAsProperty().get().getBonusStatLevels())</span>
		{
<span class="nc" id="L821">			num = bonusParsing(s, level, num, aPC);</span>
<span class="nc" id="L822">		}</span>

<span class="nc" id="L824">		return num;</span>
	}

	/**
	 * Get a choice from a list
	 * @param title The title of the chooser dialog.
	 * @param choiceList The list of possible choices.
	 * @param selectedList The values already selected (none of which should be in the available list).
	 * @param pool The number of choices the user can make.
	 * @param pc The character the choice is being made for.
	 * @return a choice
	 */
	public static &lt;T&gt; List&lt;T&gt; getChoiceFromList(final String title, final List&lt;T&gt; choiceList,
		final List&lt;T&gt; selectedList, final int pool, final PlayerCharacter pc)
	{
<span class="nc" id="L839">		return getChoiceFromList(title, choiceList, selectedList, pool, false, false, pc);</span>
	}

	/**
	 * Ask the user for a choice from a list.
	 * @param title The title of the chooser dialog.
	 * @param choiceList The list of possible choices.
	 * @param selectedList The values already selected (none of which should be in the available list).
	 * @param pool The number of choices the user can make.
	 * @param forceChoice true if the user will be forced to make all choices.
	 * @param preferRadioSelection true if this would be better presented as a radio button list
	 * @param pc The character the choice is being made for.
	 * @return The list of choices made by the user.
	 */
	public static &lt;T&gt; List&lt;T&gt; getChoiceFromList(final String title, final List&lt;T&gt; choiceList,
		final List&lt;T&gt; selectedList, final int pool, final boolean forceChoice, final boolean preferRadioSelection,
		final PlayerCharacter pc)
	{
<span class="nc" id="L857">		List&lt;T&gt; startingSelectedList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">		if (selectedList != null)</span>
		{
<span class="nc" id="L860">			startingSelectedList = selectedList;</span>
		}

<span class="nc" id="L863">		final CDOMChooserFacadeImpl&lt;T&gt; chooserFacade =</span>
				new CDOMChooserFacadeImpl&lt;&gt;(title, choiceList, startingSelectedList, pool);
<span class="nc" id="L865">		chooserFacade.setAllowsDups(false);</span>
<span class="nc" id="L866">		chooserFacade.setRequireCompleteSelection(forceChoice);</span>
<span class="nc" id="L867">		chooserFacade.setInfoFactory(new Gui2InfoFactory(pc));</span>
<span class="nc" id="L868">		chooserFacade.setDefaultView(ChooserFacade.ChooserTreeViewType.NAME);</span>
<span class="nc" id="L869">		chooserFacade.setPreferRadioSelection(preferRadioSelection);</span>
<span class="nc" id="L870">		ChooserFactory.getDelegate().showGeneralChooser(chooserFacade);</span>

<span class="nc" id="L872">		return chooserFacade.getFinalSelected();</span>
	}

	static List&lt;String&gt; getCustColumnWidth()
	{
<span class="nc" id="L877">		return CUST_COLUMN_WIDTH;</span>
	}

	static String getDefaultPcgPath()
	{
<span class="nc" id="L882">		return expandRelativePath(DEFAULT_PCG_PATH);</span>
	}

	/**
	 * returns the location of the &quot;filepaths.ini&quot; file
	 * which could be one of several locations
	 * depending on the OS and user preferences
	 * @return option path
	 */
	static String getFilepathsPath()
	{

		// first see if it was specified on the command line
<span class="fc" id="L895">		String aPath = System.getProperty(&quot;pcgen.filepaths&quot;); //$NON-NLS-1$</span>

<span class="pc bpc" id="L897" title="1 of 2 branches missed.">		if (aPath == null)</span>
		{
<span class="fc" id="L899">			aPath = System.getProperty(&quot;user.dir&quot;) + File.separator + &quot;filepaths.ini&quot;; //$NON-NLS-1$ //$NON-NLS-2$;</span>
		}
		else
		{
<span class="nc" id="L903">			File testPath = new File(expandRelativePath(aPath));</span>
<span class="nc bnc" id="L904" title="All 4 branches missed.">			if (testPath.exists() &amp;&amp; testPath.isDirectory())</span>
			{
<span class="nc" id="L906">				aPath = testPath.getAbsolutePath() + File.separator + &quot;filepaths.ini&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L907">				testPath = new File(aPath);</span>
			}
<span class="nc bnc" id="L909" title="All 4 branches missed.">			if (testPath.exists() &amp;&amp; !testPath.canWrite())</span>
			{
<span class="nc" id="L911">				Logging.errorPrint(&quot;WARNING: The filepaths file you specified is not updatable. &quot;</span>
<span class="nc" id="L912">					+ &quot;Filepath changes will not be saved. File is &quot; + testPath.getAbsolutePath());</span>
			}
		}

<span class="fc" id="L916">		return expandRelativePath(aPath);</span>
	}

	/**
	 * returns the location of the &quot;filter.ini&quot; file
	 * which could be one of several locations
	 * depending on the OS and user preferences
	 * @return filter path
	 */
	static String getFilterPath()
	{

		// first see if it was specified on the command line
<span class="nc" id="L929">		String aPath = System.getProperty(&quot;pcgen.filter&quot;);</span>

<span class="nc bnc" id="L931" title="All 2 branches missed.">		if (aPath == null)</span>
		{
<span class="nc" id="L933">			aPath = getFilePath(&quot;filter.ini&quot;);</span>
		}
		else
		{
<span class="nc" id="L937">			File testPath = new File(expandRelativePath(aPath));</span>
<span class="nc bnc" id="L938" title="All 4 branches missed.">			if (testPath.exists() &amp;&amp; testPath.isDirectory())</span>
			{
<span class="nc" id="L940">				aPath = testPath.getAbsolutePath() + File.separator + &quot;filter.ini&quot;;</span>
<span class="nc" id="L941">				testPath = new File(aPath);</span>
			}
<span class="nc bnc" id="L943" title="All 4 branches missed.">			if (testPath.exists() &amp;&amp; !testPath.canWrite())</span>
			{
<span class="nc" id="L945">				Logging.errorPrint(&quot;WARNING: The filter file you specified is not updatable. &quot;</span>
<span class="nc" id="L946">					+ &quot;Filter changes will not be saved. File is &quot; + testPath.getAbsolutePath());</span>
			}
		}

<span class="nc" id="L950">		return expandRelativePath(aPath);</span>
	}

	/**
	 * returns the location of the &quot;options.ini&quot; file
	 * which could be one of several locations
	 * depending on the OS and user preferences
	 * @return option path
	 */
	static String getOptionsPath()
	{

		// first see if it was specified on the command line
<span class="nc" id="L963">		String aPath = System.getProperty(&quot;pcgen.options&quot;);</span>

<span class="nc bnc" id="L965" title="All 2 branches missed.">		if (aPath == null)</span>
		{
<span class="nc" id="L967">			aPath = getFilePath(&quot;options.ini&quot;);</span>
		}
		else
		{
<span class="nc" id="L971">			File testPath = new File(expandRelativePath(aPath));</span>
<span class="nc bnc" id="L972" title="All 4 branches missed.">			if (testPath.exists() &amp;&amp; testPath.isDirectory())</span>
			{
<span class="nc" id="L974">				aPath = testPath.getAbsolutePath() + File.separator + &quot;options.ini&quot;;</span>
<span class="nc" id="L975">				testPath = new File(aPath);</span>
			}
<span class="nc bnc" id="L977" title="All 4 branches missed.">			if (testPath.exists() &amp;&amp; !testPath.canWrite())</span>
			{
<span class="nc" id="L979">				Logging.errorPrint(&quot;WARNING: The options file you specified is not updatable. &quot;</span>
<span class="nc" id="L980">					+ &quot;Settings changes will not be saved. File is &quot; + testPath.getAbsolutePath());</span>
			}
		}

<span class="nc" id="L984">		return expandRelativePath(aPath);</span>
	}

	public static int getSkillMultiplierForLevel(final int level)
	{
<span class="nc" id="L989">		final List&lt;String&gt; sml = SettingsHandler.getGameAsProperty().get().getSkillMultiplierLevels();</span>

<span class="nc bnc" id="L991" title="All 4 branches missed.">		if ((level &gt; sml.size()) || (level &lt;= 0))</span>
		{
<span class="nc" id="L993">			return 1;</span>
		}

<span class="nc" id="L996">		return Integer.parseInt(sml.get(level - 1));</span>
	}

	/**
	 * Get a writable path for storing files
	 * First check to see if it's been set in-program
	 * Then check user home directory
	 * Else use directory pcgen started from
	 * @param aString
	 * @return file path
	 */
	private static String getFilePath(final String aString)
	{
<span class="nc" id="L1009">		final String fType = SettingsHandler.getFilePaths();</span>

<span class="nc bnc" id="L1011" title="All 4 branches missed.">		if ((fType == null) || fType.equals(&quot;pcgen&quot;))</span>
		{
			// we are either running PCGen for the first
			// time or user wants default file locations
<span class="nc" id="L1015">			return System.getProperty(&quot;user.dir&quot;) + File.separator + aString;</span>
		}
<span class="nc bnc" id="L1017" title="All 2 branches missed.">		else if (fType.equals(&quot;user&quot;))</span>
		{
			// use the users &quot;home&quot; directory + .pcgen
<span class="nc" id="L1020">			return System.getProperty(&quot;user.home&quot;) + File.separator + &quot;.pcgen&quot; + File.separator + aString;</span>
		}
<span class="nc bnc" id="L1022" title="All 2 branches missed.">		else if (fType.equals(&quot;mac_user&quot;))</span>
		{
			// use the users &quot;home&quot; directory + standard Mac settings
<span class="nc" id="L1025">			return System.getProperty(&quot;user.home&quot;) + &quot;/Library/Preferences/pcgen&quot; + File.separator + aString;</span>
		}
		else
		{
			// use the specified directory
<span class="nc" id="L1030">			return fType + File.separator + aString;</span>
		}
	}

	private static int bonusParsing(final String l, final int level, int num, final PlayerCharacter aPC)
	{
		// should be in format levelnum,rangenum[,numchoices] 
<span class="nc" id="L1037">		final StringTokenizer aTok = new StringTokenizer(l, &quot;|&quot;, false);</span>
<span class="nc" id="L1038">		final int startLevel = Integer.parseInt(aTok.nextToken());</span>
<span class="nc" id="L1039">		final String rangeLevelFormula = aTok.nextToken();</span>
<span class="nc" id="L1040">		final int rangeLevel = aPC.getVariableValue(rangeLevelFormula, &quot;&quot;).intValue();</span>
<span class="nc" id="L1041">		int numChoices = 1;</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">		if (aTok.hasMoreTokens())</span>
		{
<span class="nc" id="L1044">			numChoices = Integer.parseInt(aTok.nextToken());</span>
		}

<span class="nc bnc" id="L1047" title="All 8 branches missed.">		if ((level == startLevel)</span>
			|| ((level &gt; startLevel) &amp;&amp; (rangeLevel &gt; 0) &amp;&amp; (((level - startLevel) % rangeLevel) == 0)))
		{
<span class="nc" id="L1050">			num += numChoices;</span>
		}

<span class="nc" id="L1053">		return num;</span>
	}

	private static String expandRelativePath(String path)
	{
<span class="pc bpc" id="L1058" title="1 of 2 branches missed.">		if (path.startsWith(&quot;@&quot;))</span>
		{
<span class="nc" id="L1060">			path = System.getProperty(&quot;user.dir&quot;) + File.separator + path.substring(1);</span>
		}

<span class="fc" id="L1063">		return path;</span>
	}

	public static LoadContext getContext()
	{
<span class="fc" id="L1068">		return SettingsHandler.getGameAsProperty().get().getContext();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>