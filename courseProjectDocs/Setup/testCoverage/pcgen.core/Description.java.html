<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Description.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.core</a> &gt; <span class="el_source">Description.java</span></div><h1>Description.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2006 (C) Aaron Divinsky &lt;boomer70@yahoo.com&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.core;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

import pcgen.base.lang.StringUtil;
import pcgen.cdom.base.ChooseDriver;
import pcgen.cdom.base.ConcretePrereqObject;
import pcgen.cdom.base.Constants;
import pcgen.cdom.content.CNAbility;
import pcgen.io.EntityEncoder;
import pcgen.persistence.lst.output.prereq.PrerequisiteWriter;
import pcgen.util.Logging;

/**
 * This class represents a generic description field.
 * 
 * &lt;p&gt;The class supports the description object having one or more prerequisites
 * as well as performing variable substitution on the string itself.
 * 
 * &lt;p&gt;Variable substitution is performed by replacing a placeholder indicated
 * by %# with the #th variable in the variable list.  For example, the string
 * &lt;br&gt;{@code &quot;This is %1 variable %3 %2&quot;}
 * &lt;br&gt;would be replaced with the string &amp;quot;This is a variable substitution
 * string&amp;quot; if the variable list was &amp;quot;a&amp;quot;,&amp;quot;string&amp;quot;, 
 * &amp;quot;substitution&amp;quot;.
 */
public class Description extends ConcretePrereqObject
{
<span class="fc" id="L49">	private Collection&lt;String&gt; theComponents = new ArrayList&lt;&gt;();</span>
	private List&lt;String&gt; theVariables;

	private static final String VAR_NAME = &quot;%NAME&quot;; //$NON-NLS-1$
	private static final String VAR_CHOICE = &quot;%CHOICE&quot;; //$NON-NLS-1$
	private static final String VAR_LIST = &quot;%LIST&quot;; //$NON-NLS-1$
	private static final String VAR_FEATS = &quot;%FEAT=&quot;; //$NON-NLS-1$

	private static final String VAR_MARKER = &quot;$$VAR:&quot;; //$NON-NLS-1$

	/**
	 * Default constructor.
	 * 
	 * @param aString The description string.
	 */
	public Description(final String aString)
<span class="fc" id="L65">	{</span>
<span class="fc" id="L66">		int currentInd = 0;</span>
		int percentInd;
<span class="fc bfc" id="L68" title="All 2 branches covered.">		while ((percentInd = aString.indexOf('%', currentInd)) != -1)</span>
		{
<span class="fc" id="L70">			final String preText = aString.substring(currentInd, percentInd);</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">			if (!preText.isEmpty())</span>
			{
<span class="fc" id="L73">				theComponents.add(preText);</span>
			}
<span class="fc bfc" id="L75" title="All 2 branches covered.">			if (percentInd == aString.length() - 1)</span>
			{
<span class="fc" id="L77">				theComponents.add(&quot;%&quot;); //$NON-NLS-1$</span>
<span class="fc" id="L78">				return;</span>
			}
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">			if (aString.charAt(percentInd + 1) == '{')</span>
			{
				// This is a bracketed placeholder.  The replacement parameter
				// is contained within the {}
<span class="nc" id="L84">				currentInd = aString.indexOf('}', percentInd + 1) + 1;</span>
<span class="nc" id="L85">				final String replacement = aString.substring(percentInd + 1, currentInd);</span>
				// For the time being we will only support numerics here.
				try
				{
<span class="nc" id="L89">					Integer.parseInt(replacement);</span>
				}
<span class="nc" id="L91">				catch (NumberFormatException nfe)</span>
				{
<span class="nc" id="L93">					Logging.errorPrintLocalised(</span>
						&quot;Errors.Description.InvalidVariableReplacement&quot;, replacement); //$NON-NLS-1$
<span class="nc" id="L95">				}</span>
<span class="nc" id="L96">				theComponents.add(VAR_MARKER + replacement);</span>
<span class="nc" id="L97">			}</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">			else if (aString.charAt(percentInd + 1) == '%')</span>
			{
				// This is an escape sequence so we can actually print a %
<span class="fc" id="L101">				currentInd = percentInd + 2;</span>
<span class="fc" id="L102">				theComponents.add(&quot;%&quot;); //$NON-NLS-1$</span>
			}
			else
			{
				// In this case we have an unbracketed placeholder.  We will
				// walk the string until such time as we no longer have a number
<span class="fc" id="L108">				currentInd = percentInd + 1;</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">				while (currentInd &lt; aString.length())</span>
				{
<span class="fc" id="L111">					final char val = aString.charAt(currentInd);</span>
					try
					{
<span class="fc" id="L114">						Integer.parseInt(String.valueOf(val));</span>
<span class="fc" id="L115">						currentInd++;</span>
					}
<span class="fc" id="L117">					catch (NumberFormatException nfe)</span>
					{
<span class="fc" id="L119">						break;</span>
<span class="fc" id="L120">					}</span>
<span class="fc" id="L121">				}</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">				if (currentInd &gt; percentInd + 1)</span>
				{
<span class="fc" id="L124">					theComponents.add(VAR_MARKER + aString.substring(percentInd + 1, currentInd));</span>
				}
				else
				{
					// We broke out of the variable finding loop without finding
					// even a single integer.  Assume we have a DESC field that
					// is using a % unescaped.
<span class="fc" id="L131">					theComponents.add(aString.substring(percentInd, percentInd + 1));</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">					if (Logging.isLoggable(Logging.LST_WARNING))</span>
					{
<span class="fc" id="L134">						Logging.log(Logging.LST_WARNING, &quot;The % without a number in the description '&quot; + aString</span>
							+ &quot;' should be either escaped e.g. %% or made into a parameter reference e.g. %1 .&quot;);
					}
				}
			}
<span class="fc" id="L139">		}</span>
<span class="fc" id="L140">		theComponents.add(aString.substring(currentInd));</span>
<span class="fc" id="L141">	}</span>

	/**
	 * Adds a variable to use in variable substitution.
	 * 
	 * @param aVariable
	 */
	public void addVariable(final String aVariable)
	{
<span class="fc bfc" id="L150" title="All 2 branches covered.">		if (theVariables == null)</span>
		{
<span class="fc" id="L152">			theVariables = new ArrayList&lt;&gt;();</span>
		}
<span class="fc" id="L154">		theVariables.add(aVariable);</span>
<span class="fc" id="L155">	}</span>

	/**
	 * Gets the description string after having tested all prereqs and 
	 * substituting all variables.
	 * 
	 * @param aPC The PlayerCharacter used to evaluate formulas.
	 * 
	 * @return The fully substituted description string.
	 */
	public String getDescription(final PlayerCharacter aPC, List&lt;? extends Object&gt; objList)
	{
<span class="nc bnc" id="L167" title="All 2 branches missed.">		if (objList.isEmpty())</span>
		{
<span class="nc" id="L169">			return Constants.EMPTY_STRING;</span>
		}
		PObject sampleObject;
<span class="nc" id="L172">		Object b = objList.get(0);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">		if (b instanceof PObject)</span>
		{
<span class="nc" id="L175">			sampleObject = (PObject) b;</span>
		}
<span class="nc bnc" id="L177" title="All 2 branches missed.">		else if (b instanceof CNAbility)</span>
		{
<span class="nc" id="L179">			sampleObject = ((CNAbility) b).getAbility();</span>
		}
		else
		{
<span class="nc" id="L183">			Logging.errorPrint(&quot;Unable to resolve Description with object of type: &quot; + b.getClass().getName());</span>
<span class="nc" id="L184">			return Constants.EMPTY_STRING;</span>
		}

<span class="nc" id="L187">		final StringBuilder buf = new StringBuilder(250);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">		if (this.qualifies(aPC, sampleObject))</span>
		{
<span class="nc bnc" id="L190" title="All 2 branches missed.">			for (final String comp : theComponents)</span>
			{
<span class="nc bnc" id="L192" title="All 2 branches missed.">				if (comp.startsWith(VAR_MARKER))</span>
				{
<span class="nc" id="L194">					final int ind = Integer.parseInt(comp.substring(VAR_MARKER.length()));</span>
<span class="nc bnc" id="L195" title="All 4 branches missed.">					if (theVariables == null || ind &gt; theVariables.size())</span>
					{
<span class="nc" id="L197">						continue;</span>
					}
<span class="nc" id="L199">					final String var = theVariables.get(ind - 1);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">					if (var.equals(VAR_NAME))</span>
					{
<span class="nc bnc" id="L202" title="All 2 branches missed.">						if (sampleObject != null)</span>
						{
<span class="nc" id="L204">							buf.append(sampleObject.getOutputName());</span>
						}
					}
<span class="nc bnc" id="L207" title="All 2 branches missed.">					else if (var.equals(VAR_CHOICE))</span>
					{
<span class="nc bnc" id="L209" title="All 2 branches missed.">						if (b instanceof ChooseDriver object)</span>
						{
<span class="nc bnc" id="L211" title="All 2 branches missed.">							if (aPC.hasAssociations(object))</span>
							{
								//TODO This is ill defined
<span class="nc" id="L214">								buf.append(aPC.getAssociationExportList(object).get(0));</span>
							}
						}
						else
						{
<span class="nc" id="L219">							Logging.errorPrint(&quot;In Description resolution, &quot; + &quot;Ignoring object of type: &quot;</span>
<span class="nc" id="L220">								+ b.getClass().getName() + &quot; because &quot; + VAR_CHOICE</span>
								+ &quot; was requested but the object does not support CHOOSE&quot;);
<span class="nc" id="L222">							continue;</span>
						}
					}
<span class="nc bnc" id="L225" title="All 2 branches missed.">					else if (var.equals(VAR_LIST))</span>
					{
<span class="nc" id="L227">						List&lt;String&gt; assocList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">						for (Object obj : objList)</span>
						{
<span class="nc bnc" id="L230" title="All 2 branches missed.">							if (obj instanceof ChooseDriver object)</span>
							{
<span class="nc bnc" id="L232" title="All 2 branches missed.">								if (aPC.hasAssociations(object))</span>
								{
<span class="nc" id="L234">									assocList.addAll(aPC.getAssociationExportList(object));</span>
								}
							}
							else
							{
<span class="nc" id="L239">								Logging.errorPrint(&quot;In Description resolution, &quot; + &quot;Ignoring object of type: &quot;</span>
<span class="nc" id="L240">									+ b.getClass().getName() + &quot; because &quot; + VAR_CHOICE</span>
									+ &quot; was requested but the object does not support CHOOSE&quot;);
<span class="nc" id="L242">								continue;</span>
							}
<span class="nc" id="L244">						}</span>
						String joinString;
<span class="nc bnc" id="L246" title="All 2 branches missed.">						if (assocList.size() == 2)</span>
						{
<span class="nc" id="L248">							joinString = &quot; and &quot;;</span>
						}
						else
						{
<span class="nc" id="L252">							joinString = &quot;, &quot;;</span>
						}
<span class="nc" id="L254">						Collections.sort(assocList);</span>
<span class="nc" id="L255">						buf.append(StringUtil.join(assocList, joinString));</span>
<span class="nc" id="L256">					}</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">					else if (var.startsWith(VAR_FEATS))</span>
					{
<span class="nc" id="L259">						final String featName = var.substring(VAR_FEATS.length());</span>
						List&lt;CNAbility&gt; feats;
<span class="nc bnc" id="L261" title="All 4 branches missed.">						if (featName.startsWith(&quot;TYPE=&quot;) || featName.startsWith(&quot;TYPE.&quot;))</span>
						{
<span class="nc" id="L263">							feats = aPC.getCNAbilities(AbilityCategory.FEAT);</span>
						}
						else
						{
<span class="nc" id="L267">							Ability feat = Globals.getContext().getReferenceContext()</span>
<span class="nc" id="L268">								.getManufacturerId(AbilityCategory.FEAT).getActiveObject(featName);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">							if (feat == null)</span>
							{
<span class="nc" id="L271">								Logging.errorPrint(&quot;Found invalid Feat reference in Description: &quot; + featName);</span>
							}
<span class="nc" id="L273">							feats = aPC.getMatchingCNAbilities(feat);</span>
						}
<span class="nc" id="L275">						boolean needSpace = false;</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">						for (final CNAbility cna : feats)</span>
						{
<span class="nc bnc" id="L278" title="All 2 branches missed.">							if (cna.getAbility().isType(featName.substring(5)))</span>
							{
<span class="nc bnc" id="L280" title="All 2 branches missed.">								if (needSpace)</span>
								{
<span class="nc" id="L282">									buf.append(' ');</span>
								}
<span class="nc" id="L284">								buf.append(aPC.getDescription(Collections.singletonList(cna)));</span>
<span class="nc" id="L285">								needSpace = true;</span>
							}
<span class="nc" id="L287">						}</span>
<span class="nc" id="L288">					}</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">					else if (var.startsWith(&quot;\&quot;&quot;)) //$NON-NLS-1$</span>
					{
<span class="nc" id="L291">						buf.append(var.substring(1, var.length() - 1));</span>
					}
					else
					{
<span class="nc" id="L295">						buf.append(aPC.getVariableValue(var, &quot;Description&quot;).intValue()); //$NON-NLS-1$</span>
					}
<span class="nc" id="L297">				}</span>
				else
				{
<span class="nc" id="L300">					buf.append(comp);</span>
				}
<span class="nc" id="L302">			}</span>
		}
<span class="nc" id="L304">		return buf.toString();</span>
	}

	/**
	 * Gets the Description tag in PCC format.
	 * 
	 * @return A String in LST file format for this description.
	 * 
	 */
	public String getPCCText()
	{
<span class="fc" id="L315">		final StringBuilder buf = new StringBuilder(250);</span>

<span class="fc bfc" id="L317" title="All 2 branches covered.">		for (final String str : theComponents)</span>
		{
<span class="fc bfc" id="L319" title="All 2 branches covered.">			if (str.startsWith(VAR_MARKER))</span>
			{
<span class="fc" id="L321">				final int ind = Integer.parseInt(str.substring(VAR_MARKER.length()));</span>
<span class="fc" id="L322">				buf.append('%').append(String.valueOf(ind));</span>
<span class="fc" id="L323">			}</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">			else if (str.equals(&quot;%&quot;))</span>
			{
				//reescape
<span class="fc" id="L327">				buf.append(&quot;%%&quot;);</span>
			}
			else
			{
<span class="fc" id="L331">				buf.append(EntityEncoder.encodeLight(str));</span>
			}
<span class="fc" id="L333">		}</span>
<span class="fc bfc" id="L334" title="All 2 branches covered.">		if (theVariables != null)</span>
		{
<span class="fc bfc" id="L336" title="All 2 branches covered.">			for (final String var : theVariables)</span>
			{
<span class="fc" id="L338">				buf.append(Constants.PIPE);</span>
<span class="fc" id="L339">				buf.append(var);</span>
<span class="fc" id="L340">			}</span>
		}

<span class="fc bfc" id="L343" title="All 2 branches covered.">		if (hasPrerequisites())</span>
		{
<span class="fc" id="L345">			buf.append(Constants.PIPE);</span>
<span class="fc" id="L346">			buf.append(new PrerequisiteWriter().getPrerequisiteString(getPrerequisiteList(), Constants.PIPE));</span>
		}
<span class="fc" id="L348">		return buf.toString();</span>
	}

	@Override
	public String toString()
	{
<span class="nc" id="L354">		return getPCCText();</span>
	}

	@Override
	public int hashCode()
	{
<span class="nc" id="L360">		return theComponents.size() + 7 * getPrerequisiteCount()</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">			+ 31 * (theVariables == null ? 0 : theVariables.size());</span>
	}

	@Override
	public boolean equals(Object o)
	{
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">		if (o == this)</span>
		{
<span class="nc" id="L369">			return true;</span>
		}
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">		if (!(o instanceof Description other))</span>
		{
<span class="nc" id="L373">			return false;</span>
		}
<span class="fc bfc" id="L375" title="All 2 branches covered.">		if (theVariables == null)</span>
		{
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">			if (other.theVariables != null)</span>
			{
<span class="nc" id="L379">				return false;</span>
			}
		}
<span class="pc bpc" id="L382" title="1 of 4 branches missed.">		return theComponents.equals(other.theComponents)</span>
<span class="pc bpc" id="L383" title="2 of 4 branches missed.">			&amp;&amp; (theVariables == null || theVariables.equals(other.theVariables)) &amp;&amp; equalsPrereqObject(other);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>