<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DamageReduction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.cdom.content</a> &gt; <span class="el_source">DamageReduction.java</span></div><h1>DamageReduction.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2006 (C) Aaron Divinsky &lt;boomer70@yahoo.com&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.cdom.content;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.StringTokenizer;

import pcgen.base.formula.Formula;
import pcgen.cdom.base.ConcretePrereqObject;
import pcgen.cdom.base.QualifyingObject;

/**
 * Encapsulates a single DamageReduction entity. This class encapsulates a
 * DamageReduction entity and provides utility methods to manipulate and combine
 * multiple DamageReductions together. The consensus seems to be that brevity
 * over clarity is preferred in the output so that is what the methods attempt
 * to provide.
 * 
 * 
 */
public class DamageReduction extends ConcretePrereqObject implements QualifyingObject
{
	private final Formula theReduction;
	private final String theBypass;

	/**
	 * Constructs a DamageReduction object. The reduction is stored as a string
	 * to allow use of JEP formulas and variables.
	 * 
	 * @param aReduction
	 *            The reduction to set
	 * @param aBypass
	 *            The bypass type to set.
	 */
	public DamageReduction(final Formula aReduction, final String aBypass)
<span class="fc" id="L56">	{</span>
<span class="fc" id="L57">		theReduction = aReduction;</span>
<span class="fc" id="L58">		theBypass = aBypass;</span>
<span class="fc" id="L59">	}</span>

	/**
	 * Gets the string of damage types that bypass this DR.
	 * 
	 * @return Returns the bypass.
	 */
	public String getBypass()
	{
<span class="fc" id="L68">		return theBypass;</span>
	}

	/**
	 * Gets the String representation of the amount of damage this DR reduces.
	 * 
	 * @return Returns the amount of reduction.
	 */
	public Formula getReduction()
	{
<span class="fc" id="L78">		return theReduction;</span>
	}

	/**
	 * Gets the actual reduction this DR will apply. If the reduction is
	 * variable and requires the PC to process, this will return -1
	 * 
	 * @return Amount of damage this DR reduces
	 */
	public int getRawReductionValue()
	{
<span class="nc bnc" id="L89" title="All 2 branches missed.">		return theReduction.isStatic() ? theReduction.resolveStatic().intValue() : -1;</span>
	}

	/**
	 * Gets a list of Damage Types that bypass this DR. This is just a raw list
	 * of types.
	 * 
	 * @return Collection of unique types converted to lower case
	 */
	public Collection&lt;String&gt; getBypassList()
	{
<span class="fc" id="L100">		StringTokenizer tok = new StringTokenizer(theBypass, &quot; &quot;);</span>
<span class="fc" id="L101">		Set&lt;String&gt; ret = new HashSet&lt;&gt;();</span>

<span class="fc bfc" id="L103" title="All 2 branches covered.">		while (tok.hasMoreTokens())</span>
		{
<span class="fc" id="L105">			final String val = tok.nextToken();</span>
<span class="pc bpc" id="L106" title="1 of 4 branches missed.">			if (!(&quot;or&quot;.equalsIgnoreCase(val) || &quot;and&quot;.equalsIgnoreCase(val)))</span>
			{
<span class="fc" id="L108">				ret.add(val.toLowerCase());</span>
			}
<span class="fc" id="L110">		}</span>
<span class="fc" id="L111">		return Collections.unmodifiableSet(ret);</span>
	}

	/**
	 * Returns a String representation of this DamageReduction object.
	 * 
	 * @return String
	 */
	@Override
	public String toString()
	{
<span class="nc" id="L122">		String reductionString = theReduction.toString();</span>
<span class="nc" id="L123">		int val = getRawReductionValue();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">		if (val &lt; 0)</span>
		{
<span class="nc" id="L126">			reductionString = &quot;variable&quot;;</span>
		}
<span class="nc" id="L128">		return reductionString + &quot;/&quot; + theBypass;</span>
	}

	/**
	 * Tests if two DR objects are the same. The test checks that all bypasses
	 * are present in any order and that the values are the same
	 * 
	 * @param other
	 *            The DR to test against.
	 * @return true if the DRs are the same.
	 */
	@Override
	public boolean equals(Object other)
	{
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">		if (!(other instanceof DamageReduction))</span>
		{
<span class="nc" id="L144">			return false;</span>
		}
<span class="fc" id="L146">		Collection&lt;String&gt; coll1 = getBypassList();</span>
<span class="fc" id="L147">		Collection&lt;String&gt; coll2 = ((DamageReduction) other).getBypassList();</span>
<span class="pc bpc" id="L148" title="1 of 4 branches missed.">		if (coll1.containsAll(coll2) &amp;&amp; coll2.containsAll(coll1))</span>
		{
<span class="fc" id="L150">			return theReduction.equals(((DamageReduction) other).theReduction);</span>
		}
<span class="fc" id="L152">		return false;</span>
	}

	/**
	 * Returns a hash code to use for this object. This method is overridden to
	 * return the same hashcode for the same DR object. That is if
	 * dr.equals(dr1) the hashcodes must be the same
	 * 
	 * @return A hashcode
	 */
	@Override
	public int hashCode()
	{
<span class="nc" id="L165">		List&lt;String&gt; list = new ArrayList&lt;&gt;(getBypassList());</span>
<span class="nc" id="L166">		Collections.sort(list);</span>

<span class="nc" id="L168">		int hash = list.stream()</span>
<span class="nc" id="L169">		    .mapToInt(Object::hashCode)</span>
<span class="nc" id="L170">		    .sum();</span>
<span class="nc" id="L171">		return theReduction.hashCode() + hash;</span>
	}

	public String getLSTformat()
	{
<span class="fc" id="L176">        return String.valueOf(theReduction)</span>
                + '/'
                + theBypass;
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>