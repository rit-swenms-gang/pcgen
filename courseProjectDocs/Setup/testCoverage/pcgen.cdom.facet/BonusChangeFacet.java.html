<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BonusChangeFacet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.cdom.facet</a> &gt; <span class="el_source">BonusChangeFacet.java</span></div><h1>BonusChangeFacet.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) Thomas Parker, 2009.
 * 
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA
 */
package pcgen.cdom.facet;

import java.util.Collection;
import java.util.List;

import pcgen.base.util.DoubleKeyMap;
import pcgen.base.util.DoubleKeyMapToList;
import pcgen.cdom.enumeration.CharID;
import pcgen.cdom.facet.base.AbstractStorageFacet;

/**
 * BonusChangeFacet tracks changes to Bonus values on a PlayerCharacter and
 * allows other classes to listen to changes in Bonuses on a Player Character.
 * 
 */
<span class="fc" id="L33">public class BonusChangeFacet extends AbstractStorageFacet&lt;CharID&gt;</span>
{
	/**
	 * The BonusChangeSupport object that manages the listeners that receive
	 * BonusChangeEvents from this BonusChangeFacet.
	 */
<span class="fc" id="L39">	private final BonusChangeSupport support = new BonusChangeSupport();</span>

	private BonusCheckingFacet bonusCheckingFacet;

	/**
	 * Performs a check against the previously known values of the bonuses for
	 * the Player Character identified by the given CharID. If any Bonus values
	 * have changed, then this will throw a BonusChangeEvent to any
	 * BonusChangeListener objects which have subscribed to receive updates for
	 * the Bonus name and Bonus type where the value changed.
	 * 
	 * @param id
	 *            The CharID identifying the Player Character for which the
	 *            check for changes in bonus values should be performed
	 */
	public void reset(CharID id)
	{
<span class="fc" id="L56">		DoubleKeyMap&lt;String, String, Double&gt; map = getConstructingInfo(id);</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">		for (String type : support.getBonusTypes())</span>
		{
<span class="fc bfc" id="L59" title="All 2 branches covered.">			for (String name : support.getBonusNames(type))</span>
			{
<span class="fc" id="L61">				Double newValue = bonusCheckingFacet.getBonus(id, type, name);</span>
<span class="fc" id="L62">				Double oldValue = map.get(type, name);</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">				if (!newValue.equals(oldValue))</span>
				{
<span class="fc" id="L65">					map.put(type, name, newValue);</span>
<span class="fc" id="L66">					support.fireBonusChange(id, type, name, oldValue, newValue);</span>
				}
<span class="fc" id="L68">			}</span>
<span class="fc" id="L69">		}</span>
<span class="fc" id="L70">	}</span>

	/**
	 * Returns a DoubleKeyMap of Bonus values for this BonusChangeFacet and the
	 * PlayerCharacter represented by the given CharID. Will create a new empty
	 * DoubleKeyMap for the PlayerCharacter represented by the given CharID if
	 * no information has been set in this BonusChangeFacet for the given
	 * CharID. Will not return null.
	 * 
	 * Note that this method SHOULD NOT be public. The DoubleKeyMap object is
	 * owned by BonusChangeFacet, and since it can be modified, a reference to
	 * that DoubleKeyMap should not be exposed to any object other than
	 * BonusChangeFacet.
	 * 
	 * @param id
	 *            The CharID for which the DoubleKeyMap of bonus values should
	 *            be returned
	 * @return The DoubleKeyMap of Bonus values for the Player Character
	 *         represented by the given CharID
	 */
	private DoubleKeyMap&lt;String, String, Double&gt; getConstructingInfo(CharID id)
	{
<span class="fc" id="L92">		DoubleKeyMap&lt;String, String, Double&gt; map = getInfo(id);</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">		if (map == null)</span>
		{
<span class="fc" id="L95">			map = new DoubleKeyMap&lt;&gt;();</span>
<span class="fc" id="L96">			setCache(id, map);</span>
		}
<span class="fc" id="L98">		return map;</span>
	}

	/**
	 * Returns a DoubleKeyMap of Bonus values for this BonusChangeFacet and the
	 * PlayerCharacter represented by the given CharID. May return null if no
	 * information has been set in this BonusChangeFacet for the given CharID.
	 * 
	 * Note that this method SHOULD NOT be public. The DoubleKeyMap object is
	 * owned by BonusChangeFacet, and since it can be modified, a reference to
	 * that DoubleKeyMap should not be exposed to any object other than
	 * BonusChangeFacet.
	 * 
	 * @param id
	 *            The CharID for which the DoubleKeyMap of bonus values should
	 *            be returned
	 * @return The DoubleKeyMap of Bonus values for the Player Character
	 *         represented by the given CharID
	 */
	private DoubleKeyMap&lt;String, String, Double&gt; getInfo(CharID id)
	{
<span class="fc" id="L119">		return (DoubleKeyMap&lt;String, String, Double&gt;) getCache(id);</span>
	}

	/**
	 * BonusChangeListener is the interface that must be implemented by a class
	 * for it to receive BonusChangeEvents from the BonusChangeFacet when a
	 * Bonus value has changed for a Player Character.
	 * 
	 */
	@FunctionalInterface
	public interface BonusChangeListener
	{

		/**
		 * Method called when a Bonus value has changed on a Player Character.
		 * The BonusChangeEvent contains the relevant details of the Bonus value
		 * change.
		 * 
		 * @param bce
		 *            The BonusChangeEvent containing the details of the Bonus
		 *            value change for a Player Character
		 */
		void bonusChange(BonusChangeEvent bce);

	}

	/**
	 * BonusChangeEvent is an event sent to a BonusChangeListener when a Bonus
	 * value changes on a Player Character.
	 * 
	 */
	public static class BonusChangeEvent
	{

		/**
		 * The CharID identifying the Player Character on which the Bonus value
		 * change took place.
		 */
		private final CharID charID;

		/**
		 * The Bonus type indicating which Bonus value changed on the Player
		 * Character.
		 */
		private final String bonusType;

		/**
		 * The Bonus name indicating which Bonus value changed on the Player
		 * Character.
		 */
		private final String bonusName;

		/**
		 * The previous value of the Bonus value
		 */
		private final Number oldVal;

		/**
		 * The new value of the Bonus value
		 */
		private final Number newVal;

		/**
		 * Constructs a new BonusChangeEvent indicating a Bonus value change
		 * took place on the Player Character identified by the given CharId.
		 * The Bonus name, type, old value, and new value are provided.
		 * 
		 * @param id
		 *            The CharID indicating the Player Character on which the
		 *            Bonus value change took place
		 * @param type
		 *            The Bonus type for the Bonus value that changed
		 * @param name
		 *            The Bonus name for the Bonus value that changed
		 * @param oldValue
		 *            The previous value of the Bonus value
		 * @param newValue
		 *            The new value of the Bonus value
		 */
		public BonusChangeEvent(CharID id, String type, String name, Number oldValue, Number newValue)
<span class="fc" id="L199">		{</span>
<span class="fc" id="L200">			charID = id;</span>
<span class="fc" id="L201">			bonusType = type;</span>
<span class="fc" id="L202">			bonusName = name;</span>
<span class="fc" id="L203">			oldVal = oldValue;</span>
<span class="fc" id="L204">			newVal = newValue;</span>
<span class="fc" id="L205">		}</span>

		public CharID getCharID()
		{
<span class="fc" id="L209">			return charID;</span>
		}

		public String getBonusType()
		{
<span class="nc" id="L214">			return bonusType;</span>
		}

		public String getBonusName()
		{
<span class="nc" id="L219">			return bonusName;</span>
		}

		public Number getOldVal()
		{
<span class="nc" id="L224">			return oldVal;</span>
		}

		public Number getNewVal()
		{
<span class="nc" id="L229">			return newVal;</span>
		}

	}

	/**
	 * BonusChangeSupport is a support class that provides the actual structure
	 * for adding and removing listeners to a class that can provide updates for
	 * changes to Bonus values on a Player Character.
	 * 
	 */
<span class="fc" id="L240">	public static class BonusChangeSupport</span>
	{
<span class="fc" id="L242">		private DoubleKeyMapToList&lt;String, String, BonusChangeListener&gt; listeners = new DoubleKeyMapToList&lt;&gt;();</span>

		/**
		 * Adds a new BonusChangeListener to receive BonusChangeEventas from the
		 * change source. The given BonusChangeListener is subscribed to Bonus
		 * value changes for the given Bonus type and Bonus name.
		 * 
		 * Note that the BonusChangeListeners are a list, meaning a given
		 * BonusChangeListener can be added more than once at a given priority,
		 * and if that occurs, it must be removed an equivalent number of times
		 * in order to no longer receive events from this BonusChangeSupport.
		 * 
		 * @param listener
		 *            The BonusChangeListener to receive BonusChangeEvents from
		 *            this BonusChangeSupport
		 * @param type
		 *            The Bonus type for the Bonus value changes for which the
		 *            given listener will be added to the list of listeners
		 * @param name
		 *            The Bonus name for the Bonus value changes for which the
		 *            given listener will be added to the list of listeners
		 */
		public synchronized void addBonusChangeListener(BonusChangeListener listener, String type, String name)
		{
<span class="fc" id="L266">			listeners.addToListFor(type, name, listener);</span>
<span class="fc" id="L267">		}</span>

		public Collection&lt;String&gt; getBonusTypes()
		{
<span class="fc" id="L271">			return listeners.getKeySet();</span>
		}

		public Collection&lt;String&gt; getBonusNames(String type)
		{
<span class="fc" id="L276">			return listeners.getSecondaryKeySet(type);</span>
		}

		/**
		 * Removes a BonusChangeListener so that it will no longer receive
		 * BonusChangeEvents from the source DataFacet. This will remove the
		 * data facet change listener from receiving events for the given Bonus
		 * type and Bonus name.
		 * 
		 * Note that if the given BonusChangeListener has been registered under
		 * a different Bonus type and Bonus name, it will continue to receive
		 * events for those Bonus value changes.
		 * 
		 * @param listener
		 *            The BonusChangeListener to be removed
		 * @param type
		 *            The Bonus type for the Bonus value changes for which the
		 *            given listener will be removed from the list of listeners
		 * @param name
		 *            The Bonus name for the Bonus value changes for which the
		 *            given listener will be removed from the list of listeners
		 */
		public synchronized void removeBonusChangeListener(BonusChangeListener listener, String type, String name)
		{
<span class="nc" id="L300">			listeners.removeFromListFor(type, name, listener);</span>
<span class="nc" id="L301">		}</span>

		public synchronized BonusChangeListener[] getBonusChangeListeners(String type, String name)
		{
<span class="nc" id="L305">			List&lt;BonusChangeListener&gt; listFor = listeners.getListFor(type, name);</span>
<span class="nc" id="L306">			return (listFor.toArray(new BonusChangeListener[0]));</span>
		}

		/**
		 * Sends a BonusChangeEvent to the BonusChangeListeners that are
		 * receiving BonusChangeEvents from the change source.
		 * 
		 * @param id
		 *            The CharID identifying the Player Character to which the
		 *            BonusChangeEvent relates.
		 * @param type
		 *            The Bonus type for the Bonus value that changed
		 * @param name
		 *            The Bonus name for the Bonus value that changed
		 * @param oldValue
		 *            The previous value of the Bonus value
		 * @param newValue
		 *            The new value of the Bonus value
		 */
		public void fireBonusChange(CharID id, String type, String name, Number oldValue, Number newValue)
		{
<span class="fc" id="L327">			BonusChangeEvent bce = new BonusChangeEvent(id, type, name, oldValue, newValue);</span>

<span class="fc" id="L329">			List&lt;BonusChangeListener&gt; localListeners = listeners.getListFor(type, name);</span>
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">			if (localListeners != null)</span>
			{
<span class="fc bfc" id="L332" title="All 2 branches covered.">				for (BonusChangeListener target : localListeners)</span>
				{
<span class="fc" id="L334">					target.bonusChange(bce);</span>
<span class="fc" id="L335">				}</span>
			}
<span class="fc" id="L337">		}</span>
	}

	/**
	 * Adds a new BonusChangeListener to receive BonusChangeEvents from
	 * BonusChangeFacet. The given BonusChangeListener subscribed to changes for
	 * the given Bonus type and Bonus name.
	 * 
	 * Note that the BonusChangeListeners are a list, meaning a given
	 * BonusChangeListener can be added more than once for a given Bonus type
	 * and Bonus name, and if that occurs, it must be removed an equivalent
	 * number of times in order to no longer receive events from this
	 * BonusChangeFacet.
	 * 
	 * @param listener
	 *            The BonusChangeListener to receive BonusChangeEvents from this
	 *            BonusChangeFacet
	 * @param type
	 *            The Bonus type for the Bonus value changes for which the given
	 *            listener will be added to the list of listeners
	 * @param name
	 *            The Bonus name for the Bonus value changes for which the given
	 *            listener will be added to the list of listeners
	 */
	public void addBonusChangeListener(BonusChangeListener listener, String type, String name)
	{
<span class="fc" id="L363">		support.addBonusChangeListener(listener, type, name);</span>
<span class="fc" id="L364">	}</span>

	/**
	 * Removes a BonusChangeListener so that it will no longer receive
	 * BonusChangeEvents from BonusChangeFacet. This will remove the data facet
	 * change listener from the list of listeners only for the given Bonus type
	 * and Bonus name.
	 * 
	 * Note that if the given BonusChangeListener has been registered under a
	 * different Bonus type and Bonus name, it will continue to receive events
	 * for those Bonus value changes.
	 * 
	 * @param listener
	 *            The BonusChangeListener to be removed
	 * @param type
	 *            The Bonus type for the Bonus value changes for which the given
	 *            listener will be removed from the list of listeners
	 * @param name
	 *            The Bonus name for the Bonus value changes for which the given
	 *            listener will be removed from the list of listeners
	 */
	public void removeBonusChangeListener(BonusChangeListener listener, String type, String name)
	{
<span class="nc" id="L387">		support.removeBonusChangeListener(listener, type, name);</span>
<span class="nc" id="L388">	}</span>

	public void setBonusCheckingFacet(BonusCheckingFacet bonusCheckingFacet)
	{
<span class="fc" id="L392">		this.bonusCheckingFacet = bonusCheckingFacet;</span>
<span class="fc" id="L393">	}</span>

	/**
	 * Copies the contents of the BonusChangeFacet from one Player Character to
	 * another Player Character, based on the given CharIDs representing those
	 * Player Characters.
	 * 
	 * This is a method in BonusChangeFacet in order to avoid exposing the
	 * mutable DoubleKeyMap object to other classes. This should not be inlined,
	 * as the DoubleKeyMap is internal information to AbstractListFacet and
	 * should not be exposed to other classes.
	 * 
	 * Note also the copy is a one-time event and no references are maintained
	 * between the Player Characters represented by the given CharIDs (meaning
	 * once this copy takes place, any change to the BonusChangeFacet of one
	 * Player Character will only impact the Player Character where the
	 * BonusChangeFacet was changed).
	 * 
	 * @param source
	 *            The CharID representing the Player Character from which the
	 *            information should be copied
	 * @param copy
	 *            The CharID representing the Player Character to which the
	 *            information should be copied
	 */
	@Override
	public void copyContents(CharID source, CharID copy)
	{
<span class="nc" id="L421">		DoubleKeyMap&lt;String, String, Double&gt; map = getInfo(source);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">		if (map != null)</span>
		{
<span class="nc" id="L424">			getConstructingInfo(copy).putAll(map);</span>
		}
<span class="nc" id="L426">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>