<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AddedTemplateFacet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.cdom.facet</a> &gt; <span class="el_source">AddedTemplateFacet.java</span></div><h1>AddedTemplateFacet.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) Thomas Parker, 2009.
 * 
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA
 */
package pcgen.cdom.facet;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.Set;

import pcgen.cdom.base.CDOMObject;
import pcgen.cdom.base.CDOMReference;
import pcgen.cdom.enumeration.CharID;
import pcgen.cdom.enumeration.ListKey;
import pcgen.cdom.facet.base.AbstractSourcedListFacet;
import pcgen.cdom.facet.event.DataFacetChangeEvent;
import pcgen.cdom.facet.event.DataFacetChangeListener;
import pcgen.core.Globals;
import pcgen.core.PCTemplate;
import pcgen.core.PlayerCharacter;
import pcgen.util.Logging;

/**
 * AddedTemplateFacet is a Facet that tracks the Templates that have been added
 * to a Player Character.
 * 
 */
<span class="fc" id="L43">public class AddedTemplateFacet extends AbstractSourcedListFacet&lt;CharID, PCTemplate&gt;</span>
		implements DataFacetChangeListener&lt;CharID, CDOMObject&gt;
{

	private PrerequisiteFacet prerequisiteFacet;

<span class="fc" id="L49">	private final PlayerCharacterTrackingFacet trackingFacet =</span>
<span class="fc" id="L50">			FacetLibrary.getFacet(PlayerCharacterTrackingFacet.class);</span>

	private CDOMObjectConsolidationFacet consolidationFacet;

	/**
	 * Establishes the list of PCTemplates to be added to the PlayerCharacter
	 * identified by the given CharID. Does not actually perform the addition of
	 * the PCTemplates to the Player Character. The given CDOMObject is the
	 * source of the PCTemplates to be added to the Player Character.
	 * 
	 * @param id
	 *            The CharID identifying the Player Character to which the
	 *            PCTemplates will be added.
	 * @param po
	 *            The CDOMObject which grants the PCTemplates that will be added
	 *            to the Player Character.
	 * @return The list of PCTemplates to be added to the PlayerCharacter
	 *         identified by the given CharID.
	 */
	public Collection&lt;PCTemplate&gt; select(CharID id, CDOMObject po)
	{
<span class="fc" id="L71">		List&lt;PCTemplate&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L72">		removeAll(id, po);</span>
<span class="fc" id="L73">		PlayerCharacter pc = trackingFacet.getPC(id);</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">		if (!pc.isImporting())</span>
		{
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">			for (CDOMReference&lt;PCTemplate&gt; ref : po.getSafeListFor(ListKey.TEMPLATE))</span>
			{
<span class="nc bnc" id="L78" title="All 2 branches missed.">				for (PCTemplate pct : ref.getContainedObjects())</span>
				{
<span class="nc" id="L80">					add(id, pct, po);</span>
<span class="nc" id="L81">					list.add(pct);</span>
<span class="nc" id="L82">				}</span>
<span class="nc" id="L83">			}</span>
<span class="fc" id="L84">			List&lt;PCTemplate&gt; added = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">			for (CDOMReference&lt;PCTemplate&gt; ref : po.getSafeListFor(ListKey.TEMPLATE_ADDCHOICE))</span>
			{
<span class="nc" id="L87">				added.addAll(ref.getContainedObjects());</span>
<span class="nc" id="L88">			}</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">			for (CDOMReference&lt;PCTemplate&gt; ref : po.getSafeListFor(ListKey.TEMPLATE_CHOOSE))</span>
			{
<span class="nc" id="L91">				List&lt;PCTemplate&gt; chooseList = new ArrayList&lt;&gt;(added);</span>
<span class="nc" id="L92">				chooseList.addAll(ref.getContainedObjects());</span>
<span class="nc" id="L93">				PCTemplate selected = chooseTemplate(po, chooseList, true, id);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">				if (selected != null)</span>
				{
<span class="nc" id="L96">					add(id, selected, po);</span>
<span class="nc" id="L97">					list.add(selected);</span>
				}
<span class="nc" id="L99">			}</span>
		}
<span class="fc" id="L101">		return list;</span>
	}

	/**
	 * Returns a list of Templates to be removed from the Player Character as
	 * defined by TEMPLATE:REMOVE
	 * 
	 * @param id
	 *            The CharID identifying the PlayerCharacter being processed.
	 * @param po
	 *            The owning CDOMObject being processed to determine if there is
	 *            any content defined by TEMPLATE:REMOVE:
	 * 
	 * @return The Collection of objects defined in TEMPLATE:REMOVE: of the
	 *         given CDOMObject
	 */
	public Collection&lt;PCTemplate&gt; remove(CharID id, CDOMObject po)
	{
<span class="fc" id="L119">		List&lt;PCTemplate&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L120">		PlayerCharacter pc = trackingFacet.getPC(id);</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">		if (!pc.isImporting())</span>
		{
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">			for (CDOMReference&lt;PCTemplate&gt; ref : po.getSafeListFor(ListKey.REMOVE_TEMPLATES))</span>
			{
<span class="nc" id="L125">				list.addAll(ref.getContainedObjects());</span>
<span class="nc" id="L126">			}</span>
		}
<span class="fc" id="L128">		return list;</span>
	}

	/**
	 * Drives selection of a PCTemplate from the given list of choices.
	 * 
	 * @param anOwner
	 *            The owning CDOMObject that is driving the Template selection
	 * @param list
	 *            The list of PCTemplates available to be selected
	 * @param forceChoice
	 *            true if the user is forced to make a choice of a PCTemplate;
	 *            false otherwise
	 * @param id
	 *            The CharID for which the PCTempalte selection is being made.
	 * @return The PCTemplate selected
	 */
	public PCTemplate chooseTemplate(CDOMObject anOwner, List&lt;PCTemplate&gt; list, boolean forceChoice, CharID id)
	{
<span class="nc" id="L147">		final List&lt;PCTemplate&gt; availableList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">		for (PCTemplate pct : list)</span>
		{
<span class="nc bnc" id="L150" title="All 2 branches missed.">			if (prerequisiteFacet.qualifies(id, pct, anOwner))</span>
			{
<span class="nc" id="L152">				availableList.add(pct);</span>
			}
<span class="nc" id="L154">		}</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">		if(list.isEmpty())</span>
		{
<span class="nc" id="L157">			Logging.log(Logging.WARNING, &quot;CHOOSE entry in &quot; + anOwner.getDisplayName()</span>
					+ &quot; contains no valid templates&quot;);
		}
<span class="nc bnc" id="L160" title="All 2 branches missed.">		if (availableList.size() == 1)</span>
		{
<span class="nc" id="L162">			return availableList.get(0);</span>
		}
		// If we are left without a choice, don't show the chooser.
<span class="nc bnc" id="L165" title="All 2 branches missed.">		if (availableList.isEmpty())</span>
		{
<span class="nc bnc" id="L167" title="All 2 branches missed.">			if(!list.isEmpty())</span>
			{
				// We have entries, but none of them apply to our target. Typically fine, but occasionally undesired.
<span class="nc" id="L170">				Logging.log(Logging.INFO, &quot;CHOOSE entry in &quot; + anOwner.getDisplayName()</span>
						+ &quot; contains templates, but none qualify&quot;);
			}
<span class="nc" id="L173">			return null;</span>
		}
<span class="nc" id="L175">		List&lt;PCTemplate&gt; selectedList = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L176">		String title = &quot;Template Choice&quot;;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">		if (anOwner != null)</span>
		{
<span class="nc" id="L179">			title += &quot; (&quot; + anOwner.getDisplayName() + &quot;)&quot;;</span>
		}
<span class="nc" id="L181">		selectedList = Globals.getChoiceFromList(title, availableList, selectedList, 1, forceChoice, false,</span>
<span class="nc" id="L182">			trackingFacet.getPC(id));</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">		if (selectedList.size() == 1)</span>
		{
<span class="nc" id="L185">			return selectedList.get(0);</span>
		}

<span class="nc" id="L188">		return null;</span>
	}

	/**
	 * Returns a non-null copy of the Collection of PCTemplates added from the
	 * given CDOMObject source to the Player Character identified by the given
	 * CharID
	 * 
	 * @param id
	 *            The CharID identifying the Player Character for which the
	 *            added PCTemplates will be returned
	 * @param cdo
	 *            The source CDOMObject which granted the PCTemplates to be
	 *            returned
	 * @return A non-null copy of the Collection of PCTemplates added from the
	 *         given CDOMObject source to the Player Character identified by the
	 *         given CharID
	 */
	public Collection&lt;PCTemplate&gt; getFromSource(CharID id, CDOMObject cdo)
	{
<span class="fc" id="L208">		List&lt;PCTemplate&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L209">		Map&lt;PCTemplate, Set&lt;Object&gt;&gt; map = getCachedMap(id);</span>
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">		if (map != null)</span>
		{
<span class="nc bnc" id="L212" title="All 2 branches missed.">			for (Map.Entry&lt;PCTemplate, Set&lt;Object&gt;&gt; me : map.entrySet())</span>
			{
<span class="nc" id="L214">				Set&lt;Object&gt; sourceSet = me.getValue();</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">				if (sourceSet.contains(cdo))</span>
				{
<span class="nc" id="L217">					list.add(me.getKey());</span>
				}
<span class="nc" id="L219">			}</span>
		}
<span class="fc" id="L221">		return list;</span>
	}

	/**
	 * Adds and removes (as appropriate) the PCTemplates associated with a
	 * CDOMObject which is granted to a Player Character.
	 * 
	 * Triggered when one of the Facets to which AddedTemplateFacet listens
	 * fires a DataFacetChangeEvent to indicate a CDOMObject was added to a
	 * Player Character.
	 * 
	 * @param dfce
	 *            The DataFacetChangeEvent containing the information about the
	 *            change
	 */
	@Override
	public void dataAdded(DataFacetChangeEvent&lt;CharID, CDOMObject&gt; dfce)
	{
<span class="fc" id="L239">		CharID id = dfce.getCharID();</span>
<span class="fc" id="L240">		CDOMObject cdo = dfce.getCDOMObject();</span>
<span class="fc" id="L241">		PlayerCharacter pc = trackingFacet.getPC(id);</span>
<span class="fc" id="L242">		Collection&lt;PCTemplate&gt; list = getFromSource(id, cdo);</span>
		/*
		 * If someone pre-set the list, then we use the preset list. If not, we
		 * need to do selections
		 */
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">		if (list.isEmpty())</span>
		{
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">			for (PCTemplate pct : select(id, cdo))</span>
			{
<span class="nc" id="L251">				pc.addTemplate(pct);</span>
<span class="nc" id="L252">			}</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">			for (PCTemplate pct : remove(id, cdo))</span>
			{
<span class="nc" id="L255">				pc.removeTemplate(pct);</span>
<span class="pc" id="L256">			}</span>
		}
		else
		{
<span class="nc bnc" id="L260" title="All 2 branches missed.">			for (PCTemplate pct : list)</span>
			{
<span class="nc" id="L262">				pc.addTemplate(pct);</span>
<span class="nc" id="L263">			}</span>
		}
<span class="fc" id="L265">	}</span>

	/**
	 * Adds and removes (as appropriate - opposite of the action defined in the
	 * LST files) the PCTemplates associated with a CDOMObject which is removed
	 * from a Player Character.
	 * 
	 * Triggered when one of the Facets to which AddedTemplateFacet listens
	 * fires a DataFacetChangeEvent to indicate a CDOMObject was removed from a
	 * Player Character.
	 * 
	 * @param dfce
	 *            The DataFacetChangeEvent containing the information about the
	 *            change
	 */
	@Override
	public void dataRemoved(DataFacetChangeEvent&lt;CharID, CDOMObject&gt; dfce)
	{
<span class="fc" id="L283">		CDOMObject cdo = dfce.getCDOMObject();</span>
<span class="fc" id="L284">		CharID id = dfce.getCharID();</span>
<span class="fc" id="L285">		PlayerCharacter pc = trackingFacet.getPC(id);</span>
<span class="fc" id="L286">		Collection&lt;PCTemplate&gt; list = getFromSource(id, cdo);</span>
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">		if (list != null)</span>
		{
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">			for (PCTemplate pct : list)</span>
			{
<span class="nc" id="L291">				pc.removeTemplate(pct);</span>
<span class="nc" id="L292">			}</span>
		}
<span class="fc" id="L294">		removeAll(id, cdo);</span>

<span class="fc" id="L296">		Collection&lt;CDOMReference&lt;PCTemplate&gt;&gt; refList = cdo.getListFor(ListKey.TEMPLATE);</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">		if (refList != null)</span>
		{
<span class="nc bnc" id="L299" title="All 2 branches missed.">			for (CDOMReference&lt;PCTemplate&gt; pctr : refList)</span>
			{
<span class="nc bnc" id="L301" title="All 2 branches missed.">				for (PCTemplate pct : pctr.getContainedObjects())</span>
				{
<span class="nc" id="L303">					pc.removeTemplate(pct);</span>
<span class="nc" id="L304">				}</span>
<span class="nc" id="L305">			}</span>
		}
<span class="fc" id="L307">	}</span>

	public void setPrerequisiteFacet(PrerequisiteFacet prerequisiteFacet)
	{
<span class="fc" id="L311">		this.prerequisiteFacet = prerequisiteFacet;</span>
<span class="fc" id="L312">	}</span>

	public void setConsolidationFacet(CDOMObjectConsolidationFacet consolidationFacet)
	{
<span class="fc" id="L316">		this.consolidationFacet = consolidationFacet;</span>
<span class="fc" id="L317">	}</span>

	/**
	 * Initializes the connections for AddedTemplateFacet to other facets.
	 * 
	 * This method is automatically called by the Spring framework during
	 * initialization of the AddedTemplateFacet.
	 */
	public void init()
	{
<span class="fc" id="L327">		consolidationFacet.addDataFacetChangeListener(this);</span>
<span class="fc" id="L328">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>