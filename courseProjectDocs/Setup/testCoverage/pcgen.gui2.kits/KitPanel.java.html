<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KitPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.kits</a> &gt; <span class="el_source">KitPanel.java</span></div><h1>KitPanel.java</h1><pre class="source lang-java linenums">/*
 * Copyright James Dempsey, 2012
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.gui2.kits;

import java.awt.BorderLayout;
import java.awt.event.ActionEvent;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

import javax.swing.AbstractAction;
import javax.swing.Box;
import javax.swing.JButton;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.SwingConstants;
import javax.swing.border.EmptyBorder;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;

import pcgen.core.Kit;
import pcgen.facade.core.CharacterFacade;
import pcgen.facade.util.DefaultListFacade;
import pcgen.facade.util.ListFacade;
import pcgen.facade.util.event.ListEvent;
import pcgen.facade.util.event.ListListener;
import pcgen.gui2.filter.Filter;
import pcgen.gui2.filter.FilterBar;
import pcgen.gui2.filter.FilterButton;
import pcgen.gui2.filter.FilterUtilities;
import pcgen.gui2.filter.FilteredListFacade;
import pcgen.gui2.filter.FilteredTreeViewTable;
import pcgen.gui2.filter.SearchFilterPanel;
import pcgen.gui2.tabs.models.QualifiedTreeCellRenderer;
import pcgen.gui2.tools.FlippingSplitPane;
import pcgen.gui2.tools.Icons;
import pcgen.gui2.tools.InfoPane;
import pcgen.gui2.util.treeview.DataView;
import pcgen.gui2.util.treeview.DataViewColumn;
import pcgen.gui2.util.treeview.DefaultDataViewColumn;
import pcgen.gui2.util.treeview.TreeView;
import pcgen.gui2.util.treeview.TreeViewModel;
import pcgen.gui2.util.treeview.TreeViewPath;
import pcgen.system.LanguageBundle;

/**
 * The Class {@code KitPanel} displays an available/selected table pair to
 * allow the allocation of kit to the currently selected character. 
 *
 * 
 */
@SuppressWarnings(&quot;serial&quot;)
public class KitPanel extends FlippingSplitPane
{

	private final FilteredTreeViewTable&lt;Object, Kit&gt; availableTable;
	private final FilteredTreeViewTable&lt;Object, Kit&gt; selectedTable;
	private final JButton addButton;
	private final InfoPane infoPane;
	private final CharacterFacade character;
	private final QualifiedTreeCellRenderer renderer;
	private final AddAction addAction;
	private final FilterButton&lt;Object, Kit&gt; qFilterButton;

	/**
	 * Create a new instance of KitPanel for a character.
	 * @param character The character being displayed.
	 */
	public KitPanel(CharacterFacade character)
<span class="nc" id="L85">	{</span>
<span class="nc" id="L86">		this.character = character;</span>
<span class="nc" id="L87">		this.availableTable = new FilteredTreeViewTable&lt;&gt;();</span>
<span class="nc" id="L88">		this.selectedTable = new FilteredTreeViewTable&lt;&gt;();</span>
<span class="nc" id="L89">		this.addButton = new JButton();</span>
<span class="nc" id="L90">		this.infoPane = new InfoPane(LanguageBundle.getString(&quot;in_kitInfo&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L91">		this.renderer = new QualifiedTreeCellRenderer();</span>
<span class="nc" id="L92">		this.addAction = new AddAction(character);</span>
<span class="nc" id="L93">		this.qFilterButton = new FilterButton&lt;&gt;(&quot;KitQualified&quot;);</span>

<span class="nc" id="L95">		initComponents();</span>
<span class="nc" id="L96">		initDefaults();</span>
<span class="nc" id="L97">	}</span>

	private void initComponents()
	{
<span class="nc" id="L101">		renderer.setCharacter(character);</span>
<span class="nc" id="L102">		FlippingSplitPane topPane = new FlippingSplitPane();</span>
<span class="nc" id="L103">		setTopComponent(topPane);</span>
<span class="nc" id="L104">		setOrientation(VERTICAL_SPLIT);</span>

<span class="nc" id="L106">		FilterBar&lt;Object, Kit&gt; bar = new FilterBar&lt;&gt;();</span>
<span class="nc" id="L107">		bar.addDisplayableFilter(new SearchFilterPanel());</span>
<span class="nc" id="L108">		qFilterButton.setText(LanguageBundle.getString(&quot;in_igQualFilter&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L109">		bar.addDisplayableFilter(qFilterButton);</span>

<span class="nc" id="L111">		availableTable.setTreeViewModel(new KitTreeViewModel(character, true));</span>
<span class="nc" id="L112">		availableTable.setTreeCellRenderer(renderer);</span>

<span class="nc" id="L114">		JPanel availPanel = FilterUtilities.configureFilteredTreeViewPane(availableTable, bar);</span>

<span class="nc" id="L116">		Box box = Box.createHorizontalBox();</span>
<span class="nc" id="L117">		box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L118">		addButton.setHorizontalTextPosition(SwingConstants.LEADING);</span>
<span class="nc" id="L119">		addButton.setAction(addAction);</span>
<span class="nc" id="L120">		box.add(addButton);</span>
<span class="nc" id="L121">		box.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L122">		box.setBorder(new EmptyBorder(0, 0, 5, 0));</span>
<span class="nc" id="L123">		availPanel.add(box, BorderLayout.SOUTH);</span>

<span class="nc" id="L125">		topPane.setLeftComponent(availPanel);</span>

<span class="nc" id="L127">		JPanel selPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L128">		FilterBar&lt;Object, Kit&gt; filterBar = new FilterBar&lt;&gt;();</span>
<span class="nc" id="L129">		filterBar.addDisplayableFilter(new SearchFilterPanel());</span>

<span class="nc" id="L131">		selectedTable.setDisplayableFilter(filterBar);</span>
<span class="nc" id="L132">		selectedTable.setTreeViewModel(new KitTreeViewModel(character, false));</span>
<span class="nc" id="L133">		selectedTable.setTreeCellRenderer(renderer);</span>
<span class="nc" id="L134">		selPanel.add(new JScrollPane(selectedTable), BorderLayout.CENTER);</span>

<span class="nc" id="L136">		topPane.setRightComponent(selPanel);</span>
<span class="nc" id="L137">		setBottomComponent(infoPane);</span>
<span class="nc" id="L138">		setResizeWeight(0.75);</span>
<span class="nc" id="L139">	}</span>

	private void initDefaults()
	{
<span class="nc" id="L143">		InfoHandler infoHandler = new InfoHandler(character);</span>
<span class="nc" id="L144">		availableTable.getSelectionModel().addListSelectionListener(infoHandler);</span>
<span class="nc" id="L145">		selectedTable.getSelectionModel().addListSelectionListener(infoHandler);</span>

<span class="nc" id="L147">		KitFilterHandler kitFilterHandler = new KitFilterHandler(character);</span>
<span class="nc" id="L148">		kitFilterHandler.install();</span>

<span class="nc" id="L150">		availableTable.addActionListener(addAction);</span>
<span class="nc" id="L151">	}</span>

	private class KitFilterHandler
	{

<span class="nc" id="L156">		private final Filter&lt;Object, Kit&gt; qFilter = new Filter&lt;&gt;()</span>
<span class="nc" id="L157">		{</span>
			@Override
			public boolean accept(Object context, Kit element)
			{
<span class="nc" id="L161">				return character.isQualifiedFor(element);</span>
			}

		};
		private final CharacterFacade character;

		public KitFilterHandler(CharacterFacade character)
<span class="nc" id="L168">		{</span>
<span class="nc" id="L169">			this.character = character;</span>
<span class="nc" id="L170">		}</span>

		public void install()
		{
<span class="nc" id="L174">			qFilterButton.setFilter(qFilter);</span>
<span class="nc" id="L175">		}</span>

	}

	private class InfoHandler implements ListSelectionListener
	{

		private final CharacterFacade character;

		public InfoHandler(CharacterFacade character)
<span class="nc" id="L185">		{</span>
<span class="nc" id="L186">			this.character = character;</span>
<span class="nc" id="L187">		}</span>

		@Override
		public void valueChanged(ListSelectionEvent e)
		{
<span class="nc bnc" id="L192" title="All 2 branches missed.">			if (!e.getValueIsAdjusting())</span>
			{
<span class="nc" id="L194">				Object obj = null;</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">				if (e.getSource() == availableTable.getSelectionModel())</span>
				{
<span class="nc" id="L197">					int selectedRow = availableTable.getSelectedRow();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">					if (selectedRow != -1)</span>
					{
<span class="nc" id="L200">						obj = availableTable.getModel().getValueAt(selectedRow, 0);</span>
					}
<span class="nc" id="L202">				}</span>
				else
				{
<span class="nc" id="L205">					int selectedRow = selectedTable.getSelectedRow();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">					if (selectedRow != -1)</span>
					{
<span class="nc" id="L208">						obj = selectedTable.getModel().getValueAt(selectedRow, 0);</span>
					}
				}
<span class="nc bnc" id="L211" title="All 2 branches missed.">				if (obj instanceof Kit)</span>
				{
<span class="nc" id="L213">					infoPane.setText(character.getInfoFactory().getHTMLInfo((Kit) obj));</span>
				}
			}
<span class="nc" id="L216">		}</span>

	}

	private class AddAction extends AbstractAction
	{

		private final CharacterFacade character;

		public AddAction(CharacterFacade character)
<span class="nc" id="L226">		{</span>
<span class="nc" id="L227">			super(LanguageBundle.getString(&quot;in_kitApply&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L228">			this.character = character;</span>
<span class="nc" id="L229">			putValue(SMALL_ICON, Icons.Forward16.getImageIcon());</span>
<span class="nc" id="L230">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L235">			List&lt;Object&gt; data = availableTable.getSelectedData();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">			for (Object kit : data)</span>
			{
<span class="nc bnc" id="L238" title="All 2 branches missed.">				if (kit instanceof Kit)</span>
				{
<span class="nc" id="L240">					character.addKit((Kit) kit);</span>
<span class="nc" id="L241">					return;</span>
				}
<span class="nc" id="L243">			}</span>
<span class="nc" id="L244">		}</span>

	}

	private static class KitTreeViewModel implements TreeViewModel&lt;Kit&gt;, DataView&lt;Kit&gt;,
			Filter&lt;CharacterFacade, Kit&gt;, ListListener&lt;Kit&gt;
	{

<span class="nc" id="L252">		private static final DefaultListFacade&lt;? extends TreeView&lt;Kit&gt;&gt; TREE_VIEWS =</span>
<span class="nc" id="L253">				new DefaultListFacade&lt;&gt;(Arrays.asList(KitTreeView.values()));</span>
		private final List&lt;DefaultDataViewColumn&gt; columns;
		private final CharacterFacade character;
		private final boolean isAvailModel;
		private final FilteredListFacade&lt;CharacterFacade, Kit&gt; kits;

		public KitTreeViewModel(CharacterFacade character, boolean isAvailModel)
<span class="nc" id="L260">		{</span>
<span class="nc" id="L261">			this.character = character;</span>
<span class="nc" id="L262">			this.isAvailModel = isAvailModel;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">			if (isAvailModel)</span>
			{
<span class="nc" id="L265">				kits = new FilteredListFacade&lt;&gt;();</span>
<span class="nc" id="L266">				kits.setContext(character);</span>
<span class="nc" id="L267">				kits.setFilter(this);</span>
<span class="nc" id="L268">				ListFacade&lt;Kit&gt; kitList = new DefaultListFacade&lt;&gt;(character.getAvailableKits());</span>
<span class="nc" id="L269">				kits.setDelegate(kitList);</span>
<span class="nc" id="L270">				character.getKits().addListListener(this);</span>
<span class="nc" id="L271">				columns = Arrays.asList(new DefaultDataViewColumn(&quot;in_descrip&quot;, String.class, false), //$NON-NLS-1$</span>
					new DefaultDataViewColumn(&quot;in_source&quot;, String.class, false)); //$NON-NLS-1$
<span class="nc" id="L273">			}</span>
			else
			{
<span class="nc" id="L276">				kits = null;</span>
<span class="nc" id="L277">				columns = Arrays.asList(new DefaultDataViewColumn(&quot;in_descrip&quot;, String.class, false), //$NON-NLS-1$</span>
					new DefaultDataViewColumn(&quot;in_source&quot;, String.class, false)); //$NON-NLS-1$
			}
<span class="nc" id="L280">		}</span>

		@Override
		public ListFacade&lt;? extends TreeView&lt;Kit&gt;&gt; getTreeViews()
		{
<span class="nc" id="L285">			return TREE_VIEWS;</span>
		}

		@Override
		public int getDefaultTreeViewIndex()
		{
<span class="nc" id="L291">			return 0;</span>
		}

		@Override
		public DataView&lt;Kit&gt; getDataView()
		{
<span class="nc" id="L297">			return this;</span>
		}

		@Override
		public ListFacade&lt;Kit&gt; getDataModel()
		{
<span class="nc bnc" id="L303" title="All 2 branches missed.">			if (isAvailModel)</span>
			{
<span class="nc" id="L305">				return kits;</span>
			}
			else
			{
<span class="nc" id="L309">				return character.getKits();</span>
			}
		}

		@Override
		public Object getData(Kit element, int column)
		{
<span class="nc bnc" id="L316" title="All 3 branches missed.">			return switch (column)</span>
					{
<span class="nc" id="L318">						case 0 -&gt; character.getInfoFactory().getDescription(element);</span>
<span class="nc" id="L319">						case 1 -&gt; element.getSource();</span>
<span class="nc" id="L320">						default -&gt; null;</span>
					};
		}

		@Override
		public void setData(Object value, Kit element, int column)
		{
<span class="nc" id="L327">		}</span>

		@Override
		public List&lt;? extends DataViewColumn&gt; getDataColumns()
		{
<span class="nc" id="L332">			return columns;</span>
		}

		@Override
		public void elementAdded(ListEvent&lt;Kit&gt; e)
		{
<span class="nc" id="L338">			kits.refilter();</span>
<span class="nc" id="L339">		}</span>

		@Override
		public void elementRemoved(ListEvent&lt;Kit&gt; e)
		{
<span class="nc" id="L344">			kits.refilter();</span>
<span class="nc" id="L345">		}</span>

		@Override
		public void elementsChanged(ListEvent&lt;Kit&gt; e)
		{
<span class="nc" id="L350">			kits.refilter();</span>
<span class="nc" id="L351">		}</span>

		@Override
		public void elementModified(ListEvent&lt;Kit&gt; e)
		{
<span class="nc" id="L356">			kits.refilter();</span>
<span class="nc" id="L357">		}</span>

		@Override
		public boolean accept(CharacterFacade context, Kit element)
		{
<span class="nc bnc" id="L362" title="All 4 branches missed.">			return !element.isPermanent() || !context.getKits().containsElement(element);</span>
		}

		@Override
		public String getPrefsKey()
		{
<span class="nc bnc" id="L368" title="All 2 branches missed.">			return isAvailModel ? &quot;KitTreeAvail&quot; : &quot;KitTreeSelected&quot;; //$NON-NLS-1$//$NON-NLS-2$</span>
		}

	}

<span class="nc" id="L373">	private enum KitTreeView implements TreeView&lt;Kit&gt;</span>
	{

<span class="nc" id="L376">		NAME(LanguageBundle.getString(&quot;in_nameLabel&quot;)), //$NON-NLS-1$</span>
<span class="nc" id="L377">		TYPE_NAME(LanguageBundle.getString(&quot;in_typeName&quot;)), //$NON-NLS-1$</span>
<span class="nc" id="L378">		SOURCE_NAME(LanguageBundle.getString(&quot;in_sourceName&quot;)); //$NON-NLS-1$</span>
		private final String name;

		private KitTreeView(String name)
<span class="nc" id="L382">		{</span>
<span class="nc" id="L383">			this.name = name;</span>
<span class="nc" id="L384">		}</span>

		@Override
		public String getViewName()
		{
<span class="nc" id="L389">			return name;</span>
		}

		@SuppressWarnings(&quot;unchecked&quot;)
		@Override
		public List&lt;TreeViewPath&lt;Kit&gt;&gt; getPaths(Kit pobj)
		{
<span class="nc bnc" id="L396" title="All 4 branches missed.">			switch (this)</span>
			{
				case NAME:
<span class="nc" id="L399">					return Collections.singletonList(new TreeViewPath&lt;&gt;(pobj));</span>
				case TYPE_NAME:
<span class="nc" id="L401">					TreeViewPath&lt;Kit&gt; path =</span>
<span class="nc" id="L402">							createTreeViewPath(pobj, (Object[]) pobj.getDisplayType().split(&quot;\\.&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L403">					return Collections.singletonList(path);</span>
				case SOURCE_NAME:
<span class="nc" id="L405">					return Collections.singletonList(new TreeViewPath&lt;&gt;(pobj, pobj.getSource()));</span>
				default:
<span class="nc" id="L407">					throw new InternalError();</span>
			}
		}

		/**
		 * Create a TreeViewPath for the kit and paths. 
		 * @param pobj The skill
		 * @param path The paths under which the kit should be shown.
		 * @return The TreeViewPath.
		 */
		private static TreeViewPath&lt;Kit&gt; createTreeViewPath(Kit pobj, Object... path)
		{
<span class="nc bnc" id="L419" title="All 2 branches missed.">			if (path.length == 0)</span>
			{
<span class="nc" id="L421">				return new TreeViewPath&lt;&gt;(pobj);</span>
			}
<span class="nc" id="L423">			return new TreeViewPath&lt;&gt;(pobj, path);</span>
		}

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>