<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CharacterDisplay.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.core.display</a> &gt; <span class="el_source">CharacterDisplay.java</span></div><h1>CharacterDisplay.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2012 (C) Tom Parker &lt;thpr@users.sourceforge.net&gt;
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.core.display;

import java.awt.Rectangle;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.SortedSet;
import java.util.TreeSet;
import java.util.stream.Collectors;

import pcgen.base.formula.Formula;
import pcgen.base.util.NamedValue;
import pcgen.cdom.base.CDOMList;
import pcgen.cdom.base.CDOMObject;
import pcgen.cdom.base.CDOMObjectUtilities;
import pcgen.cdom.base.Constants;
import pcgen.cdom.content.HitDie;
import pcgen.cdom.content.LevelCommandFactory;
import pcgen.cdom.enumeration.CharID;
import pcgen.cdom.enumeration.IntegerKey;
import pcgen.cdom.enumeration.ListKey;
import pcgen.cdom.enumeration.MovementType;
import pcgen.cdom.enumeration.ObjectKey;
import pcgen.cdom.enumeration.PCStringKey;
import pcgen.cdom.enumeration.RaceSubType;
import pcgen.cdom.enumeration.RaceType;
import pcgen.cdom.enumeration.Region;
import pcgen.cdom.enumeration.SkillFilter;
import pcgen.cdom.facet.ActiveSpellsFacet;
import pcgen.cdom.facet.AutoLanguageGrantedFacet;
import pcgen.cdom.facet.AutoLanguageUnconditionalFacet;
import pcgen.cdom.facet.DamageReductionFacet;
import pcgen.cdom.facet.EquipSetFacet;
import pcgen.cdom.facet.EquipmentFacet;
import pcgen.cdom.facet.EquippedEquipmentFacet;
import pcgen.cdom.facet.FacetLibrary;
import pcgen.cdom.facet.FormulaResolvingFacet;
import pcgen.cdom.facet.HitPointFacet;
import pcgen.cdom.facet.KitFacet;
import pcgen.cdom.facet.LevelInfoFacet;
import pcgen.cdom.facet.MasterFacet;
import pcgen.cdom.facet.NoteItemFacet;
import pcgen.cdom.facet.PrimaryWeaponFacet;
import pcgen.cdom.facet.SecondaryWeaponFacet;
import pcgen.cdom.facet.SkillRankFacet;
import pcgen.cdom.facet.SpellBookFacet;
import pcgen.cdom.facet.SpellListFacet;
import pcgen.cdom.facet.StartingLanguageFacet;
import pcgen.cdom.facet.StatBonusFacet;
import pcgen.cdom.facet.StatCalcFacet;
import pcgen.cdom.facet.StatValueFacet;
import pcgen.cdom.facet.SubClassFacet;
import pcgen.cdom.facet.SubstitutionClassFacet;
import pcgen.cdom.facet.XPTableFacet;
import pcgen.cdom.facet.analysis.AgeSetFacet;
import pcgen.cdom.facet.analysis.ArmorClassFacet;
import pcgen.cdom.facet.analysis.BaseMovementFacet;
import pcgen.cdom.facet.analysis.ChallengeRatingFacet;
import pcgen.cdom.facet.analysis.FavoredClassFacet;
import pcgen.cdom.facet.analysis.FollowerOptionFacet;
import pcgen.cdom.facet.analysis.HasAnyFavoredClassFacet;
import pcgen.cdom.facet.analysis.InitiativeFacet;
import pcgen.cdom.facet.analysis.LegsFacet;
import pcgen.cdom.facet.analysis.LevelFacet;
import pcgen.cdom.facet.analysis.LevelTableFacet;
import pcgen.cdom.facet.analysis.LoadFacet;
import pcgen.cdom.facet.analysis.MovementResultFacet;
import pcgen.cdom.facet.analysis.MultiClassFacet;
import pcgen.cdom.facet.analysis.NonAbilityFacet;
import pcgen.cdom.facet.analysis.NonProficiencyPenaltyFacet;
import pcgen.cdom.facet.analysis.RaceTypeFacet;
import pcgen.cdom.facet.analysis.RacialSubTypesFacet;
import pcgen.cdom.facet.analysis.ResultFacet;
import pcgen.cdom.facet.analysis.SpecialAbilityFacet;
import pcgen.cdom.facet.analysis.SubRaceFacet;
import pcgen.cdom.facet.analysis.TotalWeightFacet;
import pcgen.cdom.facet.analysis.UnarmedDamageFacet;
import pcgen.cdom.facet.analysis.VisionFacet;
import pcgen.cdom.facet.fact.ChronicleEntryFacet;
import pcgen.cdom.facet.fact.FactFacet;
import pcgen.cdom.facet.fact.FollowerFacet;
import pcgen.cdom.facet.fact.PortraitThumbnailRectFacet;
import pcgen.cdom.facet.fact.PreviewSheetFacet;
import pcgen.cdom.facet.fact.RegionFacet;
import pcgen.cdom.facet.fact.SkillFilterFacet;
import pcgen.cdom.facet.fact.WeightFacet;
import pcgen.cdom.facet.input.ProhibitedSchoolFacet;
import pcgen.cdom.facet.input.UserSpecialAbilityFacet;
import pcgen.cdom.facet.model.ArmorProfProviderFacet;
import pcgen.cdom.facet.model.BioSetFacet;
import pcgen.cdom.facet.model.ClassFacet;
import pcgen.cdom.facet.model.DomainFacet;
import pcgen.cdom.facet.model.LanguageFacet;
import pcgen.cdom.facet.model.RaceFacet;
import pcgen.cdom.facet.model.ShieldProfProviderFacet;
import pcgen.cdom.facet.model.SkillFacet;
import pcgen.cdom.facet.model.StatFacet;
import pcgen.cdom.facet.model.TemplateFacet;
import pcgen.cdom.facet.model.WeaponProfModelFacet;
import pcgen.cdom.helper.ProfProvider;
import pcgen.cdom.inst.PCClassLevel;
import pcgen.core.AgeSet;
import pcgen.core.ArmorProf;
import pcgen.core.BioSet;
import pcgen.core.ChronicleEntry;
import pcgen.core.Domain;
import pcgen.core.Equipment;
import pcgen.core.FollowerOption;
import pcgen.core.Kit;
import pcgen.core.Language;
import pcgen.core.NoteItem;
import pcgen.core.PCAlignment;
import pcgen.core.PCClass;
import pcgen.core.PCStat;
import pcgen.core.PCTemplate;
import pcgen.core.Race;
import pcgen.core.SettingsHandler;
import pcgen.core.ShieldProf;
import pcgen.core.Skill;
import pcgen.core.SpecialAbility;
import pcgen.core.SpellProhibitor;
import pcgen.core.SubClass;
import pcgen.core.Vision;
import pcgen.core.WeaponProf;
import pcgen.core.character.CharacterSpell;
import pcgen.core.character.EquipSet;
import pcgen.core.character.Follower;
import pcgen.core.character.SpellBook;
import pcgen.core.pclevelinfo.PCLevelInfo;
import pcgen.core.spell.Spell;
import pcgen.output.channel.compat.AlignmentCompat;
import pcgen.util.enumeration.Load;
import pcgen.util.enumeration.View;
import pcgen.util.enumeration.VisionType;

public class CharacterDisplay
{

	private final CharID id;

<span class="fc" id="L164">	private FactFacet factFacet = FacetLibrary.getFacet(FactFacet.class);</span>
<span class="fc" id="L165">	private LevelFacet levelFacet = FacetLibrary.getFacet(LevelFacet.class);</span>
<span class="fc" id="L166">	private RaceTypeFacet raceTypeFacet = FacetLibrary.getFacet(RaceTypeFacet.class);</span>
<span class="fc" id="L167">	private RegionFacet regionFacet = FacetLibrary.getFacet(RegionFacet.class);</span>
<span class="fc" id="L168">	private SpellBookFacet spellBookFacet = FacetLibrary.getFacet(SpellBookFacet.class);</span>
<span class="fc" id="L169">	private ChronicleEntryFacet chronicleEntryFacet = FacetLibrary.getFacet(ChronicleEntryFacet.class);</span>
<span class="fc" id="L170">	private AgeSetFacet ageSetFacet = FacetLibrary.getFacet(AgeSetFacet.class);</span>
<span class="fc" id="L171">	private ActiveSpellsFacet activeSpellsFacet = FacetLibrary.getFacet(ActiveSpellsFacet.class);</span>
<span class="fc" id="L172">	private TemplateFacet templateFacet = FacetLibrary.getFacet(TemplateFacet.class);</span>
<span class="fc" id="L173">	private VisionFacet visionFacet = FacetLibrary.getFacet(VisionFacet.class);</span>
<span class="fc" id="L174">	private FormulaResolvingFacet formulaResolvingFacet = FacetLibrary.getFacet(FormulaResolvingFacet.class);</span>
<span class="fc" id="L175">	private ArmorClassFacet armorClassFacet = FacetLibrary.getFacet(ArmorClassFacet.class);</span>
<span class="fc" id="L176">	private MovementResultFacet moveResultFacet = FacetLibrary.getFacet(MovementResultFacet.class);</span>
<span class="fc" id="L177">	private RaceFacet raceFacet = FacetLibrary.getFacet(RaceFacet.class);</span>
<span class="fc" id="L178">	private ClassFacet classFacet = FacetLibrary.getFacet(ClassFacet.class);</span>
<span class="fc" id="L179">	private SubClassFacet subClassFacet = FacetLibrary.getFacet(SubClassFacet.class);</span>
<span class="fc" id="L180">	private FavoredClassFacet favClassFacet = FacetLibrary.getFacet(FavoredClassFacet.class);</span>
<span class="fc" id="L181">	private HasAnyFavoredClassFacet hasAnyFavoredFacet = FacetLibrary.getFacet(HasAnyFavoredClassFacet.class);</span>
<span class="fc" id="L182">	private StartingLanguageFacet startingLangFacet = FacetLibrary.getFacet(StartingLanguageFacet.class);</span>
<span class="fc" id="L183">	private BioSetFacet bioSetFacet = FacetLibrary.getFacet(BioSetFacet.class);</span>
<span class="fc" id="L184">	private BaseMovementFacet baseMovementFacet = FacetLibrary.getFacet(BaseMovementFacet.class);</span>
<span class="fc" id="L185">	private LegsFacet legsFacet = FacetLibrary.getFacet(LegsFacet.class);</span>
<span class="fc" id="L186">	private StatValueFacet statValueFacet = FacetLibrary.getFacet(StatValueFacet.class);</span>
<span class="fc" id="L187">	private SubstitutionClassFacet substitutionClassFacet = FacetLibrary.getFacet(SubstitutionClassFacet.class);</span>
<span class="fc" id="L188">	private EquippedEquipmentFacet equippedFacet = FacetLibrary.getFacet(EquippedEquipmentFacet.class);</span>
<span class="fc" id="L189">	private ArmorProfProviderFacet armorProfFacet = FacetLibrary.getFacet(ArmorProfProviderFacet.class);</span>
<span class="fc" id="L190">	private SpellListFacet spellListFacet = FacetLibrary.getFacet(SpellListFacet.class);</span>
<span class="fc" id="L191">	private HitPointFacet hitPointFacet = FacetLibrary.getFacet(HitPointFacet.class);</span>
<span class="fc" id="L192">	private FollowerFacet followerFacet = FacetLibrary.getFacet(FollowerFacet.class);</span>
<span class="fc" id="L193">	private LoadFacet loadFacet = FacetLibrary.getFacet(LoadFacet.class);</span>
<span class="fc" id="L194">	private StatFacet statFacet = FacetLibrary.getFacet(StatFacet.class);</span>
<span class="fc" id="L195">	private TotalWeightFacet totalWeightFacet = FacetLibrary.getFacet(TotalWeightFacet.class);</span>
<span class="fc" id="L196">	private MultiClassFacet multiClassFacet = FacetLibrary.getFacet(MultiClassFacet.class);</span>
<span class="fc" id="L197">	private LevelTableFacet levelTableFacet = FacetLibrary.getFacet(LevelTableFacet.class);</span>
<span class="fc" id="L198">	private DamageReductionFacet drFacet = FacetLibrary.getFacet(DamageReductionFacet.class);</span>
<span class="fc" id="L199">	private UnarmedDamageFacet unarmedDamageFacet = FacetLibrary.getFacet(UnarmedDamageFacet.class);</span>
<span class="fc" id="L200">	private StatBonusFacet statBonusFacet = FacetLibrary.getFacet(StatBonusFacet.class);</span>
<span class="fc" id="L201">	private NonAbilityFacet nonAbilityFacet = FacetLibrary.getFacet(NonAbilityFacet.class);</span>
<span class="fc" id="L202">	private LevelInfoFacet levelInfoFacet = FacetLibrary.getFacet(LevelInfoFacet.class);</span>
<span class="fc" id="L203">	private KitFacet kitFacet = FacetLibrary.getFacet(KitFacet.class);</span>
<span class="fc" id="L204">	private AutoLanguageGrantedFacet autoLangGrantedFacet = FacetLibrary.getFacet(AutoLanguageGrantedFacet.class);</span>
<span class="fc" id="L205">	private AutoLanguageUnconditionalFacet autoLangUnconditionalFacet =</span>
<span class="fc" id="L206">			FacetLibrary.getFacet(AutoLanguageUnconditionalFacet.class);</span>
<span class="fc" id="L207">	private XPTableFacet xpTableFacet = FacetLibrary.getFacet(XPTableFacet.class);</span>
<span class="fc" id="L208">	private WeightFacet weightFacet = FacetLibrary.getFacet(WeightFacet.class);</span>
<span class="fc" id="L209">	private NoteItemFacet noteItemFacet = FacetLibrary.getFacet(NoteItemFacet.class);</span>
<span class="fc" id="L210">	private SubRaceFacet subRaceFacet = FacetLibrary.getFacet(SubRaceFacet.class);</span>
<span class="fc" id="L211">	private UserSpecialAbilityFacet userSpecialAbilityFacet = FacetLibrary.getFacet(UserSpecialAbilityFacet.class);</span>
<span class="fc" id="L212">	private SkillRankFacet skillRankFacet = FacetLibrary.getFacet(SkillRankFacet.class);</span>
<span class="fc" id="L213">	private ShieldProfProviderFacet shieldProfFacet = FacetLibrary.getFacet(ShieldProfProviderFacet.class);</span>
<span class="fc" id="L214">	private SpecialAbilityFacet specialAbilityFacet = FacetLibrary.getFacet(SpecialAbilityFacet.class);</span>
<span class="fc" id="L215">	private SecondaryWeaponFacet secondaryWeaponFacet = FacetLibrary.getFacet(SecondaryWeaponFacet.class);</span>
<span class="fc" id="L216">	private PrimaryWeaponFacet primaryWeaponFacet = FacetLibrary.getFacet(PrimaryWeaponFacet.class);</span>
<span class="fc" id="L217">	private NonProficiencyPenaltyFacet nonppFacet = FacetLibrary.getFacet(NonProficiencyPenaltyFacet.class);</span>
<span class="fc" id="L218">	private MasterFacet masterFacet = FacetLibrary.getFacet(MasterFacet.class);</span>
<span class="fc" id="L219">	private FollowerOptionFacet foFacet = FacetLibrary.getFacet(FollowerOptionFacet.class);</span>
<span class="fc" id="L220">	private StatCalcFacet statCalcFacet = FacetLibrary.getFacet(StatCalcFacet.class);</span>
<span class="fc" id="L221">	private EquipmentFacet equipmentFacet = FacetLibrary.getFacet(EquipmentFacet.class);</span>
<span class="fc" id="L222">	private EquipSetFacet equipSetFacet = FacetLibrary.getFacet(EquipSetFacet.class);</span>
<span class="fc" id="L223">	private SkillFacet skillFacet = FacetLibrary.getFacet(SkillFacet.class);</span>
<span class="fc" id="L224">	private DomainFacet domainFacet = FacetLibrary.getFacet(DomainFacet.class);</span>
<span class="fc" id="L225">	private ChallengeRatingFacet crFacet = FacetLibrary.getFacet(ChallengeRatingFacet.class);</span>
<span class="fc" id="L226">	private ProhibitedSchoolFacet prohibitedSchoolFacet = FacetLibrary.getFacet(ProhibitedSchoolFacet.class);</span>
<span class="fc" id="L227">	private RacialSubTypesFacet subTypesFacet = FacetLibrary.getFacet(RacialSubTypesFacet.class);</span>
	//private SizeFacet sizeFacet = FacetLibrary.getFacet(SizeFacet.class);
<span class="fc" id="L229">	private WeaponProfModelFacet weaponProfFacet = FacetLibrary.getFacet(WeaponProfModelFacet.class);</span>
<span class="fc" id="L230">	private LanguageFacet languageFacet = FacetLibrary.getFacet(LanguageFacet.class);</span>
<span class="fc" id="L231">	private InitiativeFacet initiativeFacet = FacetLibrary.getFacet(InitiativeFacet.class);</span>
<span class="fc" id="L232">	private PortraitThumbnailRectFacet portraitThumbnailRectFacet =</span>
<span class="fc" id="L233">			FacetLibrary.getFacet(PortraitThumbnailRectFacet.class);</span>
<span class="fc" id="L234">	private PreviewSheetFacet previewSheetFacet = FacetLibrary.getFacet(PreviewSheetFacet.class);</span>
<span class="fc" id="L235">	private SkillFilterFacet skillFilterFacet = FacetLibrary.getFacet(SkillFilterFacet.class);</span>
<span class="fc" id="L236">	private final ResultFacet resultFacet = FacetLibrary.getFacet(ResultFacet.class);</span>

	public CharacterDisplay(CharID id)
<span class="fc" id="L239">	{</span>
<span class="fc" id="L240">		this.id = id;</span>
<span class="fc" id="L241">	}</span>

	/**
	 * Gets a 'safe' String representation
	 * 
	 * @param key
	 * @return a 'safe' String
	 */
	public String getSafeStringFor(PCStringKey key)
	{
<span class="nc" id="L251">		String s = factFacet.get(id, key);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">		if (s == null)</span>
		{
<span class="nc" id="L254">			s = Constants.EMPTY_STRING;</span>
		}
<span class="nc" id="L256">		return s;</span>
	}

	/**
	 * Get the BIO.
	 * 
	 * @return the BIO
	 */
	public String getBio()
	{
<span class="nc" id="L266">		return getSafeStringFor(PCStringKey.BIO);</span>
	}

	/**
	 * Get the catchphrase.
	 * 
	 * @return catchphrase
	 */
	public String getCatchPhrase()
	{
<span class="nc" id="L276">		return getSafeStringFor(PCStringKey.CATCHPHRASE);</span>
	}

	/**
	 * Returns the character's handedness string.
	 * 
	 * @return A String for handedness.
	 */
	public String getHanded()
	{
<span class="nc" id="L286">		return getSafeStringFor(PCStringKey.HANDED);</span>
	}

	/**
	 * Gets a string of interests for the character.
	 * 
	 * @return A String of interests or an empty string.
	 */
	public String getInterests()
	{
<span class="nc" id="L296">		return getSafeStringFor(PCStringKey.INTERESTS);</span>
	}

	/**
	 * Gets the character's location.
	 * 
	 * @return The character's location.
	 */
	public String getLocation()
	{
<span class="nc" id="L306">		return getSafeStringFor(PCStringKey.LOCATION);</span>
	}

	/**
	 * Get speech tendency.
	 * 
	 * @return speech tendency
	 */
	public String getSpeechTendency()
	{
<span class="nc" id="L316">		return getSafeStringFor(PCStringKey.SPEECHTENDENCY);</span>
	}

	/**
	 * Get tab name.
	 * 
	 * @return name on tab
	 */
	public String getTabName()
	{
<span class="nc" id="L326">		return getSafeStringFor(PCStringKey.TABNAME);</span>
	}

	/**
	 * Get trait 1.
	 * 
	 * @return trait 1
	 */
	public String getTrait1()
	{
<span class="nc" id="L336">		return getSafeStringFor(PCStringKey.PERSONALITY1);</span>
	}

	/**
	 * Get trait 2.
	 * 
	 * @return trait 2
	 */
	public String getTrait2()
	{
<span class="nc" id="L346">		return getSafeStringFor(PCStringKey.PERSONALITY2);</span>
	}

	public Collection&lt;Vision&gt; getVisionList()
	{
<span class="nc" id="L351">		return visionFacet.getActiveVision(id);</span>
	}

	/**
	 * Returns a String with the characters Race Type (e.g. Humanoid).
	 * 
	 * @return The character's race type or &amp;quot;None&amp;quot;
	 */
	public String getRaceType()
	{
<span class="nc" id="L361">		RaceType rt = raceTypeFacet.getRaceType(id);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">		return (rt == null) ? Constants.NONE : rt.toString();</span>
	}

	public int getTotalLevels()
	{
<span class="nc" id="L367">		return levelFacet.getTotalLevels(id);</span>
	}

	/**
	 * Get the Spell Resistance granted by the given template to a character at a
	 * given level (Class and Hit Dice). This will include the absolute
	 * adjustment made with {@literal SR:, LEVEL:&lt;num&gt;:SR and HD:&lt;num&gt;:SR tags}
	 * 
	 * Note: unlike DR and CR, the value returned here includes the PCs own
	 * Spell Resistance.
	 * 
	 * @param pct
	 * 			The PCTemplate for which the Spell Resistance will be returned.
	 * @param level
	 *            The level to calculate the SR for
	 * @param hitdice
	 *            The Hit dice to calculate the SR for
	 * 
	 * @return the Spell Resistance granted by the given Template at the given level
	 *         and HD
	 */
	public int getTemplateSR(PCTemplate pct, int level, int hitdice)
	{
<span class="nc" id="L390">		String qualifiedKey = pct.getQualifiedKey();</span>
<span class="nc" id="L391">		Formula reduction = pct.getSafe(ObjectKey.SR).getReduction();</span>
<span class="nc" id="L392">		int aSR = formulaResolvingFacet.resolve(id, reduction, qualifiedKey).intValue();</span>

<span class="nc bnc" id="L394" title="All 2 branches missed.">		for (PCTemplate rlt : pct.getSafeListFor(ListKey.REPEATLEVEL_TEMPLATES))</span>
		{
<span class="nc bnc" id="L396" title="All 2 branches missed.">			for (PCTemplate lt : rlt.getSafeListFor(ListKey.LEVEL_TEMPLATES))</span>
			{
<span class="nc bnc" id="L398" title="All 2 branches missed.">				if (lt.get(IntegerKey.LEVEL) &lt;= level)</span>
				{
<span class="nc" id="L400">					Formula ltReduction = lt.getSafe(ObjectKey.SR).getReduction();</span>
<span class="nc" id="L401">					int ltSR = formulaResolvingFacet.resolve(id, ltReduction, qualifiedKey).intValue();</span>
<span class="nc" id="L402">					aSR = Math.max(aSR, ltSR);</span>
				}
<span class="nc" id="L404">			}</span>
<span class="nc" id="L405">		}</span>

<span class="nc bnc" id="L407" title="All 2 branches missed.">		for (PCTemplate lt : pct.getSafeListFor(ListKey.LEVEL_TEMPLATES))</span>
		{
<span class="nc bnc" id="L409" title="All 2 branches missed.">			if (lt.get(IntegerKey.LEVEL) &lt;= level)</span>
			{
<span class="nc" id="L411">				Formula ltReduction = lt.getSafe(ObjectKey.SR).getReduction();</span>
<span class="nc" id="L412">				int ltSR = formulaResolvingFacet.resolve(id, ltReduction, qualifiedKey).intValue();</span>
<span class="nc" id="L413">				aSR = Math.max(aSR, ltSR);</span>
			}
<span class="nc" id="L415">		}</span>

<span class="nc bnc" id="L417" title="All 2 branches missed.">		for (PCTemplate lt : pct.getSafeListFor(ListKey.HD_TEMPLATES))</span>
		{
<span class="nc bnc" id="L419" title="All 4 branches missed.">			if ((lt.get(IntegerKey.HD_MAX) &lt;= hitdice) &amp;&amp; (lt.get(IntegerKey.HD_MIN) &gt;= hitdice))</span>
			{
<span class="nc" id="L421">				Formula ltReduction = lt.getSafe(ObjectKey.SR).getReduction();</span>
<span class="nc" id="L422">				int ltSR = formulaResolvingFacet.resolve(id, ltReduction, qualifiedKey).intValue();</span>
<span class="nc" id="L423">				aSR = Math.max(aSR, ltSR);</span>
			}
<span class="nc" id="L425">		}</span>

<span class="nc" id="L427">		return aSR;</span>
	}

	/**
	 * Retrieve a list of the templates applied to this PC that should be
	 * visible on output.
	 * 
	 * @return The list of templates visible on output sheets.
	 */
	@Deprecated
	public List&lt;PCTemplate&gt; getOutputVisibleTemplateList()
	{
<span class="nc" id="L439">		return getVisibleToTemplateList(View.VISIBLE_EXPORT);</span>
	}

	/**
	 * Retrieve a list of the templates applied to this PC that should be
	 * visible on display.
	 * 
	 * @return The list of templates visible in the UI.
	 */
	public List&lt;PCTemplate&gt; getDisplayVisibleTemplateList()
	{
<span class="nc" id="L450">		return getVisibleToTemplateList(View.VISIBLE_DISPLAY);</span>
	}

	private List&lt;PCTemplate&gt; getVisibleToTemplateList(View v)
	{

<span class="nc" id="L456">		Collection&lt;PCTemplate&gt; treeSet = new TreeSet&lt;&gt;(CDOMObjectUtilities::compareKeys);</span>
<span class="nc" id="L457">		templateFacet.getSet(id).stream()</span>
<span class="nc" id="L458">		             .filter(template -&gt; template.getSafe(ObjectKey.VISIBILITY).isVisibleTo(v))</span>
<span class="nc" id="L459">					 .forEach(treeSet::add);</span>
<span class="nc" id="L460">		return new ArrayList&lt;&gt;(treeSet);</span>
	}

	/**
	 * Get the Character's Region
	 * 
	 * @return character region
	 */
	public String getRegionString()
	{
<span class="nc" id="L470">		return regionFacet.getRegionString(id);</span>
	}

	/**
	 * Get the Character's Region
	 * 
	 * @return character region
	 */
	public Optional&lt;Region&gt; getRegion()
	{
<span class="fc" id="L480">		return regionFacet.getRegion(id);</span>
	}

	/**
	 * Get the Character's SubRegion
	 * 
	 * @return character sub region
	 */
	public Optional&lt;String&gt; getSubRegion()
	{
<span class="nc" id="L490">		return regionFacet.getSubRegion(id);</span>
	}

	public int getSpellBookCount()
	{
<span class="nc" id="L495">		return spellBookFacet.getCount(id);</span>
	}

	/**
	 * Get spell books.
	 * 
	 * @return spellBooks
	 */
	public List&lt;String&gt; getSpellBookNames()
	{
<span class="nc" id="L505">		return new ArrayList&lt;&gt;(spellBookFacet.getBookNames(id));</span>
	}

	/**
	 * Retrieve a spell book object given the name of the spell book.
	 * 
	 * @param name
	 *            The name of the spell book to be retrieved.
	 * @return The spellbook (or null if not present).
	 */
	public SpellBook getSpellBookByName(final String name)
	{
<span class="nc" id="L517">		return spellBookFacet.getBookNamed(id, name);</span>
	}

	@Deprecated
	public int calcACOfType(String type)
	{
<span class="nc" id="L523">		return armorClassFacet.calcACOfType(id, type);</span>
	}

	public int getBaseMovement(MovementType moveType, Load load)
	{
<span class="nc" id="L528">		return moveResultFacet.getBaseMovement(id, moveType, load);</span>
	}

	public boolean hasMovement(MovementType moveType)
	{
<span class="nc" id="L533">		return moveResultFacet.hasMovement(id, moveType);</span>
	}

	public List&lt;NamedValue&gt; getMovementValues()
	{
<span class="nc" id="L538">		return moveResultFacet.getMovementValues(id);</span>
	}

	public int getNumberOfMovements()
	{
<span class="nc" id="L543">		return moveResultFacet.countMovementTypes(id);</span>
	}

	public Race getRace()
	{
<span class="nc" id="L548">		return raceFacet.get(id);</span>
	}

	public String getPreviewSheet()
	{
<span class="nc" id="L553">		return previewSheetFacet.get(id);</span>
	}

	public SkillFilter getSkillFilter()
	{
<span class="nc" id="L558">		return skillFilterFacet.get(id);</span>
	}

	/**
	 * Gets the Set of PCClass objects for this Character.
	 * @return a set of PCClass objects
	 */
	public Set&lt;PCClass&gt; getClassSet()
	{
<span class="nc" id="L567">		return classFacet.getSet(id);</span>
	}

	public String getSubClassName(PCClass cl)
	{
<span class="nc" id="L572">		return subClassFacet.get(id, cl);</span>
	}

	public final int getLevel(PCClass pcc)
	{
<span class="nc" id="L577">		return classFacet.getLevel(id, pcc);</span>
	}

	@Deprecated
	public SortedSet&lt;PCClass&gt; getFavoredClasses()
	{
<span class="nc" id="L583">		SortedSet&lt;PCClass&gt; favored = new TreeSet&lt;&gt;(CDOMObjectUtilities::compareKeys);</span>
<span class="nc" id="L584">		favored.addAll(favClassFacet.getSet(id));</span>
<span class="nc" id="L585">		return favored;</span>
	}

	@Deprecated
	public boolean hasAnyFavoredClass()
	{
<span class="nc" id="L591">		return hasAnyFavoredFacet.contains(id, Boolean.TRUE);</span>
	}

	public Collection&lt;Follower&gt; getFollowerList()
	{
<span class="nc" id="L596">		return followerFacet.getSet(id);</span>
	}

	/**
	 * Get a sorted list of the languages that this character knows.
	 * @return a sorted list of language objects
	 */
	@Deprecated
	public Set&lt;Language&gt; getSortedLanguageSet()
	{
<span class="nc" id="L606">		return new TreeSet&lt;&gt;(languageFacet.getSet(id));</span>
	}

	@Deprecated
	public int processOldInitiativeMod()
	{
<span class="nc" id="L612">		return initiativeFacet.getInitiative(id);</span>
	}

	public SortedSet&lt;WeaponProf&gt; getSortedWeaponProfs()
	{
<span class="nc" id="L617">		return Collections.unmodifiableSortedSet(new TreeSet&lt;&gt;(weaponProfFacet.getSet(id)));</span>
	}

	public Collection&lt;RaceSubType&gt; getRacialSubTypes()
	{
<span class="nc" id="L622">		return subTypesFacet.getRacialSubTypes(id);</span>
	}

	public Collection&lt;? extends SpellProhibitor&gt; getProhibitedSchools(Object source)
	{
<span class="nc" id="L627">		return prohibitedSchoolFacet.getSet(id, source);</span>
	}

	public String getPortraitPath()
	{
<span class="nc" id="L632">		return getSafeStringFor(PCStringKey.PORTRAIT_PATH);</span>
	}

	public Rectangle getPortraitThumbnailRect()
	{
<span class="nc" id="L637">		Rectangle rect = portraitThumbnailRectFacet.get(id);</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">		return (rect == null) ? null : (Rectangle) rect.clone();</span>
	}

	public String getName()
	{
<span class="nc" id="L643">		return getSafeStringFor(PCStringKey.NAME);</span>
	}

	public String getFileName()
	{
<span class="nc" id="L648">		return getSafeStringFor(PCStringKey.FILE_NAME);</span>
	}

	public String getPlayersName()
	{
<span class="nc" id="L653">		return getSafeStringFor(PCStringKey.PLAYERSNAME);</span>
	}

	public Integer calcCR()
	{
<span class="nc" id="L658">		return crFacet.getCR(id);</span>
	}

	public Integer calcBaseCR()
	{
<span class="nc" id="L663">		return crFacet.calcRaceCR(id);</span>
	}

	public float getBaseHD()
	{
<span class="nc" id="L668">		return crFacet.getBaseHD(id);</span>
	}

	public int getXPAward()
	{
<span class="nc" id="L673">		return crFacet.getXPAward(id);</span>
	}

	public int getRacialHDSize()
	{
<span class="nc" id="L678">		int hdSize = 0;</span>
<span class="nc" id="L679">		LevelCommandFactory lcf = getRace().get(ObjectKey.MONSTER_CLASS);</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">		if (lcf != null)</span>
		{
<span class="nc" id="L682">			hdSize = getLevelHitDie(lcf.getPCClass(), 1).getDie();</span>
		}
<span class="nc" id="L684">		return hdSize;</span>
	}

	public Set&lt;Domain&gt; getSortedDomainSet()
	{
<span class="nc" id="L689">		SortedSet&lt;Domain&gt; domains = new TreeSet&lt;&gt;(CDOMObjectUtilities::compareKeys);</span>
<span class="nc" id="L690">		domains.addAll(domainFacet.getSet(id));</span>
<span class="nc" id="L691">		return domains;</span>
	}

	/**
	 * Retrieve those skills in the character's skill list that match the
	 * supplied visibility level.
	 * 
	 * @param v What level of visibility skills are desired.
	 * 
	 * @return A list of the character's skills matching the visibility
	 *         criteria.
	 */
	public List&lt;Skill&gt; getPartialSkillList(View v)
	{
		// Now select the required set of skills, based on their visibility.
<span class="nc" id="L706">		return skillFacet.getSet(id)</span>
<span class="nc" id="L707">		                 .stream()</span>
<span class="nc" id="L708">		                 .filter(po -&gt; po.getSafe(ObjectKey.VISIBILITY).isVisibleTo(v))</span>
<span class="nc" id="L709">		                 .collect(Collectors.toList());</span>
	}

	/**
	 * Alignment of this PC.
	 * 
	 * @return alignment
	 */
	public PCAlignment getPCAlignment()
	{
<span class="nc" id="L719">		return AlignmentCompat.getCurrentAlignment(getCharID());</span>
	}

	public Object getGlobal(String varName)
	{
<span class="nc" id="L724">		return resultFacet.getGlobalVariable(id, varName);</span>
	}

	/**
	 * Get the class list.
	 * 
	 * @return classList
	 */
	public ArrayList&lt;PCClass&gt; getClassList()
	{
		/*
		 * TODO This is a discussion we have to have about where items are sorted
		 */
<span class="nc" id="L737">		return new ArrayList&lt;&gt;(getClassSet());</span>
	}

	/**
	 * Get the current equipment set name.
	 * 
	 * @return equipment set name
	 */
	public String getCurrentEquipSetName()
	{
<span class="nc" id="L747">		return getSafeStringFor(PCStringKey.CURRENT_EQUIP_SET_NAME);</span>
	}

	/**
	 * Get the list of equipment sets.
	 * 
	 * @return List
	 */
	public Collection&lt;EquipSet&gt; getEquipSet()
	{
<span class="nc" id="L757">		return equipSetFacet.getSet(id);</span>
	}

	/**
	 * Get the equipment set indexed by path.
	 * 
	 * @param path the &quot;path&quot; of the equipSet to return
	 * @return EquipSet
	 */
	public EquipSet getEquipSetByIdPath(final String path)
	{
<span class="nc" id="L768">		return equipSetFacet.getEquipSetByIdPath(id, path);</span>
	}

	/**
	 * Get equipment set.
	 * 
	 * @return equipment set
	 */
	public Set&lt;Equipment&gt; getEquipmentSet()
	{
<span class="nc" id="L778">		return equipmentFacet.getSet(id);</span>
	}

	/**
	 * Gets the character's list of languages.
	 * 
	 * @return An unmodifiable language set.
	 */
	public Set&lt;Language&gt; getLanguageSet()
	{
<span class="nc" id="L788">		return languageFacet.getSet(id);</span>
	}

	/**
	 * Gets the list of potential followers of a given type.
	 * 
	 * @param aType
	 *            Type of follower to retrieve list for e.g. Familiar
	 * @param comp
	 *            the comparator that will be used to order the returned map.
	 * @return A MAP of FollowerOption objects representing the possible list
	 *         of follower choices.
	 */
	public Map&lt;FollowerOption, CDOMObject&gt; getAvailableFollowers(final String aType, Comparator&lt;FollowerOption&gt; comp)
	{
<span class="nc" id="L803">		return foFacet.getAvailableFollowers(id, aType, comp);</span>
	}

	/**
	 * Get the Follower object that is the &quot;master&quot; for this object.
	 * 
	 * @return follower master
	 */
	public Follower getMaster()
	{
<span class="nc" id="L813">		return masterFacet.get(id);</span>
	}

	/**
	 * @return nonProficiencyPenalty. Searches templates first.
	 */
	public int getNonProficiencyPenalty()
	{
<span class="nc" id="L821">		return nonppFacet.getPenalty(id);</span>
	}

	/**
	 * Selector gets the character's primary weapons.
	 * 
	 * @return primary weapons
	 */
	public Collection&lt;Equipment&gt; getPrimaryWeapons()
	{
<span class="nc" id="L831">		return primaryWeaponFacet.getSet(id);</span>
	}

	public boolean hasPrimaryWeapons()
	{
<span class="nc bnc" id="L836" title="All 2 branches missed.">		return !primaryWeaponFacet.isEmpty(id);</span>
	}

	public boolean hasSecondaryWeapons()
	{
<span class="nc bnc" id="L841" title="All 2 branches missed.">		return !secondaryWeaponFacet.isEmpty(id);</span>
	}

	/**
	 * Get the character's secondary weapons.
	 * 
	 * @return secondary weapons
	 */
	public Collection&lt;Equipment&gt; getSecondaryWeapons()
	{
<span class="nc" id="L851">		return secondaryWeaponFacet.getSet(id);</span>
	}

	/**
	 * Get skill list.
	 * 
	 * @return list of skills
	 */
	public Collection&lt;Skill&gt; getSkillSet()
	{
<span class="nc" id="L861">		return skillFacet.getSet(id);</span>
	}

	@Deprecated
	public List&lt;SpecialAbility&gt; getResolvedSpecialAbilities(CDOMObject cdo)
	{
<span class="nc" id="L867">		return specialAbilityFacet.getResolved(id, cdo);</span>
	}

	@Deprecated
	public List&lt;SpecialAbility&gt; getResolvedUserSpecialAbilities(CDOMObject cdo)
	{
<span class="nc" id="L873">		return userSpecialAbilityFacet.getResolved(id, cdo);</span>
	}

	/**
	 * Get the name of the spellbook to auto add new known spells to.
	 * 
	 * @return spellbook name
	 */
	public String getSpellBookNameToAutoAddKnown()
	{
<span class="nc" id="L883">		return getSafeStringFor(PCStringKey.SPELLBOOK_AUTO_ADD_KNOWN);</span>
	}

	/**
	 * Get spell books.
	 * 
	 * @return spellBooks
	 */
	public Collection&lt;SpellBook&gt; getSpellBooks()
	{
<span class="nc" id="L893">		return spellBookFacet.getBooks(id);</span>
	}

	/**
	 * Accessor, Gets the sub-race of the character.
	 * @return character subrace.
	 */
	@Deprecated
	public String getSubRace()
	{
<span class="nc" id="L903">		return subRaceFacet.getSubRace(id);</span>
	}

	/**
	 * Get a set of the templates applies to this pc.
	 * @return the set of Templates.
	 */
	public Collection&lt;PCTemplate&gt; getTemplateSet()
	{
<span class="nc" id="L912">		return templateFacet.getSet(id);</span>
	}

	/**
	 * Gets the character's weight in pounds.
	 * 
	 * @return The character's weight.
	 */
	public int getWeight()
	{
<span class="nc" id="L922">		return weightFacet.getWeight(id);</span>
	}

	public String getXPTableName()
	{
<span class="nc" id="L927">		return xpTableFacet.get(id).getName();</span>
	}

	/**
	 * Check whether this PC has this WeaponProf.
	 * @param wp The WeaponProf to check.
	 * @return True if the PC has the WeaponProf
	 */
	public boolean hasWeaponProf(final WeaponProf wp)
	{
<span class="nc" id="L937">		return weaponProfFacet.containsProf(id, wp);</span>
	}

	public Set&lt;Language&gt; getAutoLanguages()
	{
<span class="nc" id="L942">		Set&lt;Language&gt; languages = new HashSet&lt;&gt;();</span>
<span class="nc" id="L943">		languages.addAll(autoLangGrantedFacet.getSet(id));</span>
<span class="nc" id="L944">		languages.addAll(autoLangUnconditionalFacet.getSet(id));</span>
<span class="nc" id="L945">		return languages;</span>
	}

	/**
	 * Returns the character's Effective Character Level.
	 * 
	 * &lt;p&gt;
	 * The level is calculated by adding total non-monster levels, total
	 * hitdice, and level adjustment.
	 * 
	 * @return The ECL of the character.
	 */
	public int getECL()
	{
<span class="nc" id="L959">		return levelFacet.getECL(id);</span>
	}

	public Collection&lt;Kit&gt; getKitInfo()
	{
<span class="nc" id="L964">		return kitFacet.getSet(id);</span>
	}

	public Collection&lt;PCLevelInfo&gt; getLevelInfo()
	{
<span class="nc" id="L969">		return levelInfoFacet.getSet(id);</span>
	}

	public PCLevelInfo getLevelInfo(int index)
	{
<span class="nc" id="L974">		return levelInfoFacet.get(id, index);</span>
	}

	public int getLevelInfoSize()
	{
<span class="nc" id="L979">		return levelInfoFacet.getCount(id);</span>
	}

	public String getLevelInfoClassKeyName(final int idx)
	{
<span class="nc bnc" id="L984" title="All 4 branches missed.">		if ((idx &gt;= 0) &amp;&amp; (idx &lt; getLevelInfoSize()))</span>
		{
<span class="nc" id="L986">			return levelInfoFacet.get(id, idx).getClassKeyName();</span>
		}

<span class="nc" id="L989">		return Constants.EMPTY_STRING;</span>
	}

	public int getLevelInfoClassLevel(final int idx)
	{
<span class="nc bnc" id="L994" title="All 4 branches missed.">		if ((idx &gt;= 0) &amp;&amp; (idx &lt; getLevelInfoSize()))</span>
		{
<span class="nc" id="L996">			return levelInfoFacet.get(id, idx).getClassLevel();</span>
		}

<span class="nc" id="L999">		return 0;</span>
	}

	/**
	 * Checks if the stat is a non ability.
	 * 
	 * @return true, if is non ability
	 */
	public boolean isNonAbility(PCStat stat)
	{
<span class="nc" id="L1009">		return nonAbilityFacet.isNonAbility(id, stat);</span>
	}

	/*
	 * returns true if Equipment is in the secondary weapon list
	 */
	public boolean isSecondaryWeapon(final Equipment eq)
	{
<span class="nc bnc" id="L1017" title="All 2 branches missed.">		if (eq == null)</span>
		{
<span class="nc" id="L1019">			return false;</span>
		}

<span class="nc" id="L1022">		return secondaryWeaponFacet.getSet(id)</span>
<span class="nc" id="L1023">		                           .stream()</span>
<span class="nc" id="L1024">		                           .anyMatch(eqB -&gt; itemEquals(eq, eqB));</span>
	}

	/**
	 * Calculates total bonus from all stats
	 * 
	 * @param aType
	 * @param aName
	 * @return stat bonus to
	 */
	public double getStatBonusTo(String aType, String aName)
	{
<span class="nc" id="L1036">		return statBonusFacet.getStatBonusTo(id, aType, aName);</span>
	}

	public String getUDamForRace()
	{
<span class="nc" id="L1041">		return unarmedDamageFacet.getUDamForRace(id);</span>
	}

	public Set&lt;List&lt;String&gt;&gt; getUnarmedDamage()
	{
<span class="nc" id="L1046">		return unarmedDamageFacet.getSet(id);</span>
	}

	/**
	 * Get all possible sources of Damage Resistance and calculate
	 * 
	 * @return DR
	 */
	public String calcDR()
	{
<span class="nc" id="L1056">		return drFacet.getDRString(id);</span>
	}

	/*
	 * returns true if Equipment is in the primary weapon list
	 */
	public boolean isPrimaryWeapon(final Equipment eq)
	{
<span class="nc bnc" id="L1064" title="All 2 branches missed.">		if (eq == null)</span>
		{
<span class="nc" id="L1066">			return false;</span>
		}

<span class="nc" id="L1069">		return primaryWeaponFacet.getSet(id)</span>
<span class="nc" id="L1070">		                         .stream()</span>
<span class="nc" id="L1071">		                         .anyMatch(eqB -&gt; itemEquals(eq, eqB));</span>
	}

	public int minXPForNextECL()
	{
<span class="nc" id="L1076">		return levelTableFacet.minXPForLevel(levelFacet.getECL(id) + 1, id);</span>
	}

	public double multiclassXPMultiplier()
	{
<span class="nc" id="L1081">		return multiClassFacet.getMultiClassXPMultiplier(id);</span>
	}

	public int totalHitDice()
	{
<span class="nc" id="L1086">		return levelFacet.getMonsterLevelCount(id);</span>
	}

	public int totalNonMonsterLevels()
	{
<span class="nc" id="L1091">		return levelFacet.getNonMonsterLevelCount(id);</span>
	}

	public Float totalWeight()
	{
<span class="nc" id="L1096">		return totalWeightFacet.getTotalWeight(id);</span>
	}

	public boolean hasKit(Kit kit)
	{
<span class="nc" id="L1101">		return kitFacet.contains(id, kit);</span>
	}

	public boolean hasSkill(Skill skill)
	{
<span class="nc" id="L1106">		return skillFacet.contains(id, skill);</span>
	}

	public boolean hasTemplate(PCTemplate template)
	{
<span class="nc" id="L1111">		return templateFacet.contains(id, template);</span>
	}

	public Collection&lt;PCStat&gt; getStatSet()
	{
<span class="nc" id="L1116">		return statFacet.getSet(id);</span>
	}

	public boolean hasDomain(Domain domain)
	{
<span class="nc" id="L1121">		return domainFacet.contains(id, domain);</span>
	}

	public boolean hasDomains()
	{
<span class="nc bnc" id="L1126" title="All 2 branches missed.">		return !domainFacet.isEmpty(id);</span>
	}

	public int getDomainCount()
	{
<span class="nc" id="L1131">		return domainFacet.getCount(id);</span>
	}

	public Set&lt;Domain&gt; getDomainSet()
	{
<span class="nc" id="L1136">		return domainFacet.getSet(id);</span>
	}

	public int getStatCount()
	{
<span class="nc" id="L1141">		return statFacet.getCount(id);</span>
	}

	public PCClassLevel getActiveClassLevel(PCClass pcc, int lvl)
	{
<span class="nc" id="L1146">		return classFacet.getClassLevel(id, pcc, lvl);</span>
	}

	public int getClassCount()
	{
<span class="nc" id="L1151">		return classFacet.getCount(id);</span>
	}

	/*
	 * Size is taken into account for the currentPC via getLoadMultForSize
	 */
	public Float getMaxLoad()
	{
<span class="nc" id="L1159">		return loadFacet.getMaxLoad(id);</span>
	}

	public Float getMaxLoad(double mult)
	{
<span class="nc" id="L1164">		return loadFacet.getMaxLoad(id, mult);</span>
	}

	public Load getLoadType()
	{
<span class="nc" id="L1169">		return loadFacet.getLoadType(id);</span>
	}

	public double getMovementOfType(MovementType moveType)
	{
<span class="nc" id="L1174">		return moveResultFacet.getMovementOfType(id, moveType);</span>
	}

	public boolean hasEquipSet()
	{
<span class="nc bnc" id="L1179" title="All 2 branches missed.">		return !equipSetFacet.isEmpty(id);</span>
	}

	public Collection&lt;? extends CharacterSpell&gt; getCharacterSpells(CDOMObject cdo)
	{
<span class="nc" id="L1184">		return activeSpellsFacet.getSet(id, cdo);</span>
	}

	public AgeSet getAgeSet()
	{
<span class="nc" id="L1189">		return ageSetFacet.get(id);</span>
	}

	/**
	 * Retrieve the set of the character's chronicle entries.
	 * @return The character's chronicle entries.
	 */
	public Collection&lt;ChronicleEntry&gt; getChronicleEntries()
	{
<span class="nc" id="L1198">		return chronicleEntryFacet.getSet(id);</span>
	}

	public HitDie getLevelHitDie(PCClass pcClass, final int classLevel)
	{
<span class="nc" id="L1203">		return hitPointFacet.getLevelHitDie(id, pcClass, classLevel);</span>
	}

	public List&lt;? extends CDOMList&lt;Spell&gt;&gt; getSpellLists(CDOMObject cdo)
	{
<span class="nc" id="L1208">		return spellListFacet.getSet(id, cdo);</span>
	}

	/**
	 * @return display name
	 */
	public String getDisplayName()
	{
<span class="nc" id="L1216">		final String custom = getSafeStringFor(PCStringKey.TABNAME);</span>

<span class="nc bnc" id="L1218" title="All 4 branches missed.">		if (custom != null &amp;&amp; !custom.isEmpty())</span>
		{
<span class="nc" id="L1220">			return custom;</span>
		}

<span class="nc" id="L1223">		return getName();</span>
	}

	public String getDisplayClassName(PCClass pcClass)
	{
<span class="nc bnc" id="L1228" title="All 2 branches missed.">		if (pcClass != null)</span>
		{
<span class="nc" id="L1230">			String subClassKey = getSubClassName(pcClass);</span>
<span class="nc bnc" id="L1231" title="All 6 branches missed.">			if ((subClassKey != null) &amp;&amp; (!subClassKey.isEmpty()) &amp;&amp; !subClassKey.equals(Constants.NONE))</span>
			{
<span class="nc" id="L1233">				SubClass sc = pcClass.getSubClassKeyed(subClassKey);</span>
<span class="nc bnc" id="L1234" title="All 2 branches missed.">				if (sc != null)</span>
				{
<span class="nc" id="L1236">					return sc.getDisplayName();</span>
				}
			}
		}

<span class="nc" id="L1241">		return pcClass.getDisplayName();</span>
	}

	/**
	 * Get the value of the weight token in format WEIGHT.X
	 * @param type Encumbrance type 
	 * @return The value of the weight token.
	 */
	public double getLoadToken(String type)
	{
<span class="nc" id="L1251">		Float mult = SettingsHandler.getGameAsProperty().get().getLoadInfo().getLoadMultiplier(type.toUpperCase());</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">		if (mult != null)</span>
		{
<span class="nc" id="L1254">			return getMaxLoad(mult).intValue();</span>
		}
<span class="nc" id="L1256">		return 0.0;</span>
	}

	/**
	 * Get the armor proficiency list.
	 * 
	 * @return armor proficiency list
	 */
	public Collection&lt;ProfProvider&lt;ArmorProf&gt;&gt; getArmorProfList()
	{
<span class="nc" id="L1266">		return armorProfFacet.getQualifiedSet(id);</span>
	}

	/**
	 * Get the character's &quot;equipped&quot; equipment.
	 * @return a set of the &quot;equipped&quot; equipment
	 */
	public Set&lt;Equipment&gt; getEquippedEquipmentSet()
	{
<span class="nc" id="L1275">		return equippedFacet.getSet(id);</span>
	}

	/**
	 * Returns a region (including subregion) string for the character.
	 * 
	 * &lt;p&gt; Build on-the-fly so removing templates won't mess up region
	 * 
	 * @return character region
	 */
	public String getFullRegion()
	{
<span class="nc" id="L1287">		return regionFacet.getFullRegion(id);</span>
	}

	public Vision getVision(VisionType type)
	{
<span class="nc" id="L1292">		return visionFacet.getActiveVision(id, type);</span>
	}

	public String getSubstitutionClassName(PCClassLevel lvl)
	{
<span class="nc" id="L1297">		return substitutionClassFacet.get(id, lvl);</span>
	}

	public int getStat(PCStat stat)
	{
<span class="nc" id="L1302">		return statValueFacet.get(id, stat).intValue();</span>
	}

	public boolean containsRacialSubType(RaceSubType st)
	{
<span class="nc" id="L1307">		return subTypesFacet.contains(id, st);</span>
	}

	/**
	 * Determine the number of legs the character has.
	 * 
	 * @return The number of legs.
	 */
	public int getPreFormulaLegs()
	{
<span class="nc" id="L1317">		return legsFacet.getLegs(id);</span>
	}

	public Integer getDR(String key)
	{
<span class="nc" id="L1322">		return drFacet.getDR(id, key);</span>
	}

	public boolean hasMovement()
	{
<span class="nc bnc" id="L1327" title="All 2 branches missed.">		return !baseMovementFacet.isEmpty(id);</span>
	}

	public Collection&lt;WeaponProf&gt; getWeaponProfSet()
	{
<span class="nc" id="L1332">		return weaponProfFacet.getSet(id);</span>
	}

	public List&lt;? extends SpecialAbility&gt; getUserSpecialAbilityList(CDOMObject source)
	{
<span class="nc" id="L1337">		return userSpecialAbilityFacet.getSet(id, source);</span>
	}

	public Integer getHP(PCClassLevel pcl)
	{
<span class="nc" id="L1342">		return hitPointFacet.get(id, pcl);</span>
	}

	public BioSet getBioSet()
	{
<span class="nc" id="L1347">		return bioSetFacet.get(id);</span>
	}

	public int getAgeSetIndex()
	{
<span class="nc" id="L1352">		return ageSetFacet.getAgeSetIndex(id);</span>
	}

	public boolean hasFollowers()
	{
<span class="nc bnc" id="L1357" title="All 2 branches missed.">		return !followerFacet.isEmpty(id);</span>
	}

	public boolean hasEquipment()
	{
<span class="nc bnc" id="L1362" title="All 2 branches missed.">		return !equipmentFacet.isEmpty(id);</span>
	}

	public boolean hasLanguage(Language lang)
	{
<span class="nc" id="L1367">		return languageFacet.contains(id, lang);</span>
	}

	public int getLanguageCount()
	{
<span class="nc" id="L1372">		return languageFacet.getCount(id);</span>
	}

	public boolean hasTemplates()
	{
<span class="nc bnc" id="L1377" title="All 2 branches missed.">		return !templateFacet.isEmpty(id);</span>
	}

	/**
	 * Get list of shield proficiencies.
	 * 
	 * @return shield prof list
	 */
	public Collection&lt;ProfProvider&lt;ShieldProf&gt;&gt; getShieldProfList()
	{
<span class="nc" id="L1387">		return shieldProfFacet.getQualifiedSet(id);</span>
	}

	public int getTotalStatFor(PCStat stat)
	{
<span class="nc" id="L1392">		return statCalcFacet.getTotalStatFor(id, stat);</span>
	}

	public int getStatModFor(PCStat stat)
	{
<span class="nc" id="L1397">		return statCalcFacet.getStatModFor(id, stat);</span>
	}

	public int getBaseStatFor(PCStat stat)
	{
<span class="nc" id="L1402">		return statCalcFacet.getBaseStatFor(id, stat);</span>
	}

	public int getFollowerCount()
	{
<span class="nc" id="L1407">		return followerFacet.getCount(id);</span>
	}

	public int getRacialSubTypeCount()
	{
<span class="nc" id="L1412">		return subTypesFacet.getCount(id);</span>
	}

	public int getVisionCount()
	{
<span class="nc" id="L1417">		return visionFacet.getVisionCount(id);</span>
	}

	public int getBaseMovement()
	{
<span class="nc" id="L1422">		return baseMovementFacet.getSet(id).iterator().next().getMovement();</span>
	}

	public double movementOfType(MovementType moveType)
	{
<span class="nc" id="L1427">		return moveResultFacet.movementOfType(id, moveType);</span>
	}

	public int getNotesCount()
	{
<span class="nc" id="L1432">		return noteItemFacet.getCount(id);</span>
	}

	/**
	 * Gets a list of notes associated with the character.
	 * 
	 * @return A list of &lt;tt&gt;NoteItem&lt;/tt&gt; objects.
	 */
	public Collection&lt;NoteItem&gt; getNotesList()
	{
<span class="nc" id="L1442">		return noteItemFacet.getSet(id);</span>
	}

	/**
	 * Calculates the level of the character's favored class
	 * 
	 * @return level
	 */
	public int getFavoredClassLevel()
	{
<span class="nc" id="L1452">		return favClassFacet.getFavoredClassLevel(id);</span>
	}

	/**
	 * returns ranks taken specifically in skill
	 * 
	 * @return ranks taken in skill
	 */
	public Float getRank(Skill sk)
	{
<span class="nc" id="L1462">		return skillRankFacet.getRank(id, sk);</span>
	}

	/**
	 * Return a list of bonus languages which the character may select from.
	 * This function is not efficient, but is sufficient for it's current use of
	 * only being called when the user requests the bonus language selection
	 * list. Note: A check will be made for the ALL language and it will be
	 * replaced with the current list of languages in globals. These should be
	 * further restricted by the prerequisites of the languages to ensure that
	 * 'secret' languages are not offered.
	 * 
	 * @return List of bonus languages for the character.
	 */
	public Set&lt;Language&gt; getLanguageBonusSelectionList()
	{
<span class="nc" id="L1478">		return startingLangFacet.getSet(id);</span>
	}

	public boolean isProficientWithArmor(final Equipment eq)
	{
<span class="nc" id="L1483">		return armorProfFacet.isProficientWithArmor(id, eq);</span>
	}

	private static boolean itemEquals(Equipment eqA, Equipment eqB)
	{
<span class="nc bnc" id="L1488" title="All 2 branches missed.">		return eqA.getName().equalsIgnoreCase(eqB.getName())</span>
<span class="nc bnc" id="L1489" title="All 2 branches missed.">				&amp;&amp; (eqA.getLocation() == eqB.getLocation());</span>
	}

	/**
	 * WARNING: Use this method SPARINGLY... and only for transition to the
	 * facet model. It is NOT an excuse to throw around a CharacterDisplay
	 * object when unnecessary
	 * 
	 * @return The id of the character as used by the facets.
	 */
	public CharID getCharID()
	{
<span class="nc" id="L1501">		return id;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>