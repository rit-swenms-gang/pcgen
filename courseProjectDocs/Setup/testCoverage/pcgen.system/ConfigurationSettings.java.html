<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfigurationSettings.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.system</a> &gt; <span class="el_source">ConfigurationSettings.java</span></div><h1>ConfigurationSettings.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2009 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 *
 */
package pcgen.system;

import java.io.File;

import org.apache.commons.lang3.SystemUtils;

public final class ConfigurationSettings extends PropertyContext
{
	private static final String USER_LANGUAGE = &quot;language&quot;;
	private static final String USER_COUNTRY = &quot;country&quot;;
	public static final String SETTINGS_FILES_PATH = &quot;settingsPath&quot;;
	public static final String SYSTEMS_DIR = &quot;systemsPath&quot;;
	public static final String OUTPUT_SHEETS_DIR = &quot;osPath&quot;;
	private static final String PLUGINS_DIR = &quot;pluginsPath&quot;;
	public static final String PREVIEW_DIR = &quot;previewPath&quot;;
	public static final String VENDOR_DATA_DIR = &quot;vendordataPath&quot;;
	public static final String HOMEBREW_DATA_DIR = &quot;homebrewdataPath&quot;;
	public static final String DOCS_DIR = &quot;docsPath&quot;;
	public static final String PCC_FILES_DIR = &quot;pccFilesPath&quot;;
	public static final String CUSTOM_DATA_DIR = &quot;customPath&quot;;
<span class="fc" id="L39">	private static ConfigurationSettings instance = null;</span>
	/** APPLICATION directory name, used in &lt;em&gt;~/.&amp;lt;APPLICATION&amp;gt;&lt;/em&gt;, etc. */
	private static final String APPLICATION = &quot;pcgen&quot;; // $NON-NLS-1$

	private ConfigurationSettings(String configFileName)
	{
<span class="fc" id="L45">		super(configFileName);</span>
		//Initialize defaults
<span class="fc" id="L47">		setProperty(USER_LANGUAGE, SystemUtils.USER_LANGUAGE);</span>
<span class="fc" id="L48">		setProperty(USER_COUNTRY, SystemUtils.USER_COUNTRY);</span>
<span class="fc" id="L49">		setProperty(SYSTEMS_DIR, &quot;@system&quot;);</span>
<span class="fc" id="L50">		setProperty(OUTPUT_SHEETS_DIR, &quot;@outputsheets&quot;);</span>
<span class="fc" id="L51">		setProperty(PLUGINS_DIR, &quot;@plugins&quot;);</span>
<span class="fc" id="L52">		setProperty(PREVIEW_DIR, &quot;@preview&quot;);</span>
<span class="fc" id="L53">		setProperty(DOCS_DIR, &quot;@docs&quot;);</span>
<span class="fc" id="L54">		setProperty(PCC_FILES_DIR, &quot;@data&quot;);</span>
<span class="fc" id="L55">	}</span>

	@Override
	protected void beforePropertiesSaved()
	{
<span class="nc" id="L60">		relativize(SYSTEMS_DIR);</span>
<span class="nc" id="L61">		relativize(OUTPUT_SHEETS_DIR);</span>
<span class="nc" id="L62">		relativize(PLUGINS_DIR);</span>
<span class="nc" id="L63">		relativize(PREVIEW_DIR);</span>
<span class="nc" id="L64">		relativize(DOCS_DIR);</span>
<span class="nc" id="L65">		relativize(PCC_FILES_DIR);</span>
<span class="nc" id="L66">	}</span>

	public static String getLanguage()
	{
<span class="nc" id="L70">		return getSystemProperty(USER_LANGUAGE);</span>
	}

	public static void setLanguage(String language)
	{
<span class="nc" id="L75">		setSystemProperty(USER_LANGUAGE, language);</span>
<span class="nc" id="L76">	}</span>

	static String getCountry()
	{
<span class="nc" id="L80">		return getSystemProperty(USER_COUNTRY);</span>
	}

	public static void setCountry(String country)
	{
<span class="nc" id="L85">		setSystemProperty(USER_COUNTRY, country);</span>
<span class="nc" id="L86">	}</span>

	/**
	 * @return the current user directory
	 */
	public static String getUserDir()
	{
<span class="fc" id="L93">		return SystemUtils.USER_DIR;</span>
	}

	public static ConfigurationSettings getInstance()
	{
<span class="fc" id="L98">		return getInstance(null);</span>
	}

	public static ConfigurationSettings getInstance(String configFileName)
	{
<span class="fc bfc" id="L103" title="All 2 branches covered.">		if (instance == null)</span>
		{
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">			instance = new ConfigurationSettings(configFileName == null ? &quot;config.ini&quot; : configFileName);</span>
		}
<span class="fc" id="L107">		return instance;</span>
	}

	public static String getSystemsDir()
	{
<span class="fc" id="L112">		return getDirectory(SYSTEMS_DIR);</span>
	}

	public static String getOutputSheetsDir()
	{
<span class="nc" id="L117">		return getDirectory(OUTPUT_SHEETS_DIR);</span>
	}

	static String getPluginsDir()
	{
<span class="nc" id="L122">		return getDirectory(PLUGINS_DIR);</span>
	}

	public static String getPreviewDir()
	{
<span class="nc" id="L127">		return getDirectory(PREVIEW_DIR);</span>
	}

	public static String getDocsDir()
	{
<span class="nc" id="L132">		return getDirectory(DOCS_DIR);</span>
	}

	public static String getPccFilesDir()
	{
<span class="fc" id="L137">		return getDirectory(PCC_FILES_DIR);</span>
	}

	public static String getSettingsDir()
	{
<span class="nc" id="L142">		return getDirectory(SETTINGS_FILES_PATH);</span>
	}

	public static String getSystemProperty(String key)
	{
<span class="fc" id="L147">		return getInstance().getProperty(key);</span>
	}

	public static Object setSystemProperty(String key, String value)
	{
<span class="nc" id="L152">		return getInstance().setProperty(key, value);</span>
	}

	private static String getDirectory(String key)
	{
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">		if (SETTINGS_FILES_PATH.equals(key))</span>
		{
<span class="nc" id="L159">			return getSettingsDirFromFilePath(getSystemProperty(key));</span>
		}
<span class="fc" id="L161">		return expandRelativePath(getSystemProperty(key));</span>
	}

	private static String expandRelativePath(String path)
	{
		// TODO: a dirty hack for Mac bundles only
<span class="pc bpc" id="L167" title="3 of 4 branches missed.">		if (SystemUtils.USER_DIR.endsWith(&quot;MacOS&quot;) &amp;&amp; path.startsWith(&quot;@&quot;))</span>
		{
<span class="nc" id="L169">			path = SystemUtils.USER_DIR + File.separator + &quot;..&quot; + File.separator + &quot;app&quot; + File.separator + path.substring(1);</span>
		}
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">		else if (path.startsWith(&quot;@&quot;))</span>
		{
<span class="fc" id="L173">			path = SystemUtils.USER_DIR + File.separator + path.substring(1);</span>
		}
<span class="fc" id="L175">		return path;</span>
	}

	private static String unexpandRelativePath(String path)
	{
<span class="nc bnc" id="L180" title="All 2 branches missed.">		if (path.startsWith(SystemUtils.USER_DIR + File.separator))</span>
		{
<span class="nc" id="L182">			path = '@' + path.substring(SystemUtils.USER_DIR.length() + 1);</span>
		}
<span class="nc" id="L184">		return path;</span>
	}

	private static void relativize(String property)
	{
<span class="nc" id="L189">		setSystemProperty(property, unexpandRelativePath(getSystemProperty(property)));</span>
<span class="nc" id="L190">	}</span>

<span class="nc" id="L192">	public enum SettingsFilesPath</span>
	{

		/** User Directory */
<span class="nc" id="L196">		user,</span>
		/** Indicates PCGen directory */
<span class="nc" id="L198">		pcgen,</span>
		/** Freedesktop configuration directories */
<span class="nc" id="L200">		FD_USER,</span>
		/** Indicate MAC specific directories */
<span class="nc" id="L202">		mac_user;</span>

		public String getSettingsDir()
		{
<span class="nc bnc" id="L206" title="All 5 branches missed.">			switch (this)</span>
			{
				case user:
<span class="nc" id="L209">					return SystemUtils.USER_HOME + File.separator + '.' + APPLICATION; // $NON-NLS-1$</span>
				case pcgen:
<span class="nc" id="L211">					return SystemUtils.USER_DIR + File.separator + &quot;settings&quot;; // $NON-NLS-1$</span>
				case mac_user:
<span class="nc" id="L213">					return SystemUtils.USER_HOME + &quot;/Library/Preferences/&quot; + APPLICATION; // $NON-NLS-1$</span>
				case FD_USER:
<span class="nc" id="L215">					String config = System.getenv(&quot;XDG_CONFIG_HOME&quot;); // $NON-NLS-1$</span>
<span class="nc bnc" id="L216" title="All 4 branches missed.">					if ((config == null) || config.isEmpty())</span>
					{
<span class="nc" id="L218">						config = SystemUtils.USER_HOME + File.separator + &quot;.config&quot;; // $NON-NLS-1$</span>
					}
<span class="nc" id="L220">					return config + File.separator + APPLICATION;</span>
				default:
<span class="nc" id="L222">					throw new InternalError();</span>
			}
		}

	}

	public static String getSettingsDirFromFilePath(String fType)
	{
<span class="nc bnc" id="L230" title="All 4 branches missed.">		if ((fType == null) || (fType.length() &lt; 1))</span>
		{
			// make sure we have a default
<span class="nc" id="L233">			fType = getDefaultSettingsFilesPath();</span>
		}
		String path;
		try
		{
			//Check to see if this path is one of the standard path types
<span class="nc" id="L239">			path = SettingsFilesPath.valueOf(fType).getSettingsDir();</span>
		}
<span class="nc" id="L241">		catch (IllegalArgumentException ex)</span>
		{
			//It must be a custom filepath
<span class="nc" id="L244">			path = fType;</span>
<span class="nc" id="L245">		}</span>
<span class="nc" id="L246">		return path;</span>
	}

	/**
	 * @return A default Settings Files Path value.
	 */
	public static String getDefaultSettingsFilesPath()
	{
		String fType;
<span class="nc bnc" id="L255" title="All 2 branches missed.">		if (SystemUtils.IS_OS_MAC_OSX)</span>
		{
<span class="nc" id="L257">			fType = SettingsFilesPath.mac_user.name();</span>
		}
<span class="nc bnc" id="L259" title="All 2 branches missed.">		else if (SystemUtils.IS_OS_UNIX)</span>
		{
<span class="nc" id="L261">			fType = SettingsFilesPath.FD_USER.name();</span>
		}
		else
		{
<span class="nc" id="L265">			fType = SettingsFilesPath.user.name();</span>
		}
<span class="nc" id="L267">		return fType;</span>
	}

	/**
	 * @return &quot;User Dir&quot; dir Settings Files Path value.
	 */
	public static String getUserSettingsDirFromFilePath()
	{
<span class="nc" id="L275">		return getSettingsDirFromFilePath(getDefaultSettingsFilesPath());</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>