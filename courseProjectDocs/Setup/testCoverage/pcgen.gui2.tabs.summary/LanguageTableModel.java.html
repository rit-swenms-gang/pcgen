<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LanguageTableModel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.tabs.summary</a> &gt; <span class="el_source">LanguageTableModel.java</span></div><h1>LanguageTableModel.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2010 (C) Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 *
 */
package pcgen.gui2.tabs.summary;

import java.awt.CardLayout;
import java.awt.Component;
import java.awt.Frame;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;

import javax.swing.AbstractCellEditor;
import javax.swing.Box;
import javax.swing.JButton;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JTable;
import javax.swing.table.AbstractTableModel;
import javax.swing.table.TableCellEditor;
import javax.swing.table.TableCellRenderer;

import pcgen.core.Language;
import pcgen.facade.core.CharacterFacade;
import pcgen.facade.core.LanguageChooserFacade;
import pcgen.facade.util.ListFacade;
import pcgen.facade.util.event.ListEvent;
import pcgen.facade.util.event.ListListener;
import pcgen.gui2.UIPropertyContext;
import pcgen.gui2.dialog.LanguageChooserDialog;
import pcgen.gui2.tabs.Utilities;
import pcgen.gui2.util.SignIcon.Sign;
import pcgen.gui2.util.table.TableCellUtilities;
import pcgen.gui3.utilty.ColorUtilty;
import pcgen.system.LanguageBundle;

public class LanguageTableModel extends AbstractTableModel implements ListListener&lt;Language&gt;
{

	private ListFacade&lt;Language&gt; languages;
	private ListFacade&lt;LanguageChooserFacade&gt; choosers;
	private CharacterFacade character;
	private JTable table;
<span class="nc" id="L61">	private int dirtyRow = -1;</span>
<span class="nc" id="L62">	private MouseListener mouseListener = new MouseListener();</span>
<span class="nc" id="L63">	private Renderer renderer = new Renderer();</span>
<span class="nc" id="L64">	private Editor editor = new Editor();</span>

	public LanguageTableModel(CharacterFacade character, JTable table)
	{
<span class="nc" id="L68">		super();</span>
<span class="nc" id="L69">		this.table = table;</span>
<span class="nc" id="L70">		this.character = character;</span>
<span class="nc" id="L71">		languages = character.getLanguages();</span>
<span class="nc" id="L72">		choosers = character.getLanguageChoosers();</span>
<span class="nc" id="L73">		languages.addListListener(this);</span>
<span class="nc" id="L74">	}</span>

	public static void initializeTable(JTable table)
	{
<span class="nc" id="L78">		table.setCellSelectionEnabled(false);</span>
<span class="nc" id="L79">		table.setRowSelectionAllowed(false);</span>
<span class="nc" id="L80">		table.setColumnSelectionAllowed(false);</span>
<span class="nc" id="L81">		table.setFocusable(false);</span>
<span class="nc" id="L82">		table.setRowHeight(21);</span>
<span class="nc" id="L83">		table.getTableHeader().setReorderingAllowed(false);</span>
<span class="nc" id="L84">	}</span>

	public void install()
	{
<span class="nc" id="L88">		table.addMouseListener(mouseListener);</span>
<span class="nc" id="L89">		table.addMouseMotionListener(mouseListener);</span>
<span class="nc" id="L90">		table.setModel(this);</span>

<span class="nc" id="L92">		table.setDefaultRenderer(Object.class, renderer);</span>
<span class="nc" id="L93">		table.setDefaultEditor(Object.class, editor);</span>
<span class="nc" id="L94">	}</span>

	public void uninstall()
	{
<span class="nc" id="L98">		table.removeMouseListener(mouseListener);</span>
<span class="nc" id="L99">		table.removeMouseMotionListener(mouseListener);</span>
<span class="nc" id="L100">		dirtyRow = -1;</span>
<span class="nc" id="L101">	}</span>

	@Override
	public int getRowCount()
	{
<span class="nc" id="L106">		return languages.getSize() + choosers.getSize();</span>
	}

	@Override
	public String getColumnName(int column)
	{
<span class="nc" id="L112">		return LanguageBundle.getString(&quot;in_sumLanguages&quot;); //$NON-NLS-1$</span>
	}

	@Override
	public int getColumnCount()
	{
<span class="nc" id="L118">		return 1;</span>
	}

	@Override
	public Object getValueAt(int rowIndex, int columnIndex)
	{
<span class="nc bnc" id="L124" title="All 2 branches missed.">		if (rowIndex &lt; languages.getSize())</span>
		{
<span class="nc" id="L126">			return languages.getElementAt(rowIndex);</span>
		}
		else
		{
<span class="nc" id="L130">			return choosers.getElementAt(rowIndex - languages.getSize());</span>
		}
	}

	@Override
	public boolean isCellEditable(int rowIndex, int columnIndex)
	{
<span class="nc bnc" id="L137" title="All 4 branches missed.">        return rowIndex &gt;= languages.getSize() || character.isRemovable(languages.getElementAt(rowIndex));</span>
    }

	@Override
	public void elementAdded(ListEvent&lt;Language&gt; e)
	{
<span class="nc" id="L143">		fireTableRowsInserted(e.getIndex(), e.getIndex());</span>
<span class="nc" id="L144">		editor.cancelCellEditing();</span>
<span class="nc" id="L145">	}</span>

	@Override
	public void elementRemoved(ListEvent&lt;Language&gt; e)
	{
<span class="nc" id="L150">		fireTableRowsDeleted(e.getIndex(), e.getIndex());</span>
<span class="nc" id="L151">		editor.cancelCellEditing();</span>
<span class="nc" id="L152">	}</span>

	@Override
	public void elementsChanged(ListEvent&lt;Language&gt; e)
	{
<span class="nc" id="L157">		fireTableDataChanged();</span>
<span class="nc" id="L158">		editor.cancelCellEditing();</span>
<span class="nc" id="L159">	}</span>

	@Override
	public void elementModified(ListEvent&lt;Language&gt; e)
	{
<span class="nc" id="L164">		fireTableRowsUpdated(e.getIndex(), e.getIndex());</span>
<span class="nc" id="L165">	}</span>

<span class="nc" id="L167">	private class MouseListener extends MouseAdapter</span>
	{

		@Override
		public void mouseExited(MouseEvent e)
		{
<span class="nc" id="L173">			table.repaint(table.getCellRect(dirtyRow, 0, true));</span>
<span class="nc" id="L174">			dirtyRow = -1;</span>
<span class="nc" id="L175">		}</span>

		@Override
		public void mouseMoved(MouseEvent e)
		{
<span class="nc" id="L180">			int row = table.rowAtPoint(e.getPoint());</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">			if (row != dirtyRow)</span>
			{
<span class="nc" id="L183">				editor.cancelCellEditing();</span>
<span class="nc" id="L184">				table.repaint(table.getCellRect(dirtyRow, 0, true));</span>
<span class="nc" id="L185">				dirtyRow = row;</span>
<span class="nc" id="L186">				table.repaint(table.getCellRect(dirtyRow, 0, true));</span>
			}
<span class="nc" id="L188">		}</span>

	}

	private class Editor extends AbstractCellEditor implements TableCellEditor, ActionListener
	{

		private static final String ADD_ID = &quot;Add&quot;;
		private static final String REMOVE_ID = &quot;Remove&quot;;
<span class="nc" id="L197">		private JPanel cellPanel = new JPanel();</span>
<span class="nc" id="L198">		private CardLayout cardLayout = new CardLayout();</span>
<span class="nc" id="L199">		private JLabel addLabel = new JLabel();</span>
<span class="nc" id="L200">		private JLabel cellLabel = new JLabel();</span>

		public Editor()
<span class="nc" id="L203">		{</span>
<span class="nc" id="L204">			cellPanel.setLayout(cardLayout);</span>
<span class="nc" id="L205">			cellPanel.setOpaque(true);</span>

<span class="nc" id="L207">			JButton addButton = Utilities.createSignButton(Sign.Plus);</span>
<span class="nc" id="L208">			JButton removeButton = Utilities.createSignButton(Sign.Minus);</span>
<span class="nc" id="L209">			addButton.setActionCommand(ADD_ID);</span>
<span class="nc" id="L210">			removeButton.setActionCommand(REMOVE_ID);</span>
<span class="nc" id="L211">			addButton.setFocusable(false);</span>
<span class="nc" id="L212">			removeButton.setFocusable(false);</span>
<span class="nc" id="L213">			addButton.addActionListener(this);</span>
<span class="nc" id="L214">			removeButton.addActionListener(this);</span>
<span class="nc" id="L215">			Box box = Box.createHorizontalBox();</span>
<span class="nc" id="L216">			box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L217">			box.add(addLabel);</span>
<span class="nc" id="L218">			box.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L219">			box.add(addButton);</span>
<span class="nc" id="L220">			box.add(Box.createHorizontalStrut(2));</span>
<span class="nc" id="L221">			cellPanel.add(box, ADD_ID);</span>

<span class="nc" id="L223">			box = Box.createHorizontalBox();</span>
<span class="nc" id="L224">			box.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L225">			box.add(cellLabel);</span>
<span class="nc" id="L226">			box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L227">			box.add(removeButton);</span>
<span class="nc" id="L228">			box.add(Box.createHorizontalStrut(2));</span>
<span class="nc" id="L229">			cellPanel.add(box, REMOVE_ID);</span>
<span class="nc" id="L230">		}</span>

		@Override
		public Component getTableCellEditorComponent(JTable jTable, Object value, boolean isSelected, int row,
			int column)
		{
<span class="nc" id="L236">			TableCellUtilities.setToRowBackground(cellPanel, jTable, row);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">			if (row &gt;= languages.getSize())</span>
			{
<span class="nc" id="L239">				addLabel.setForeground(jTable.getForeground());</span>
<span class="nc" id="L240">				addLabel.setFont(jTable.getFont());</span>
<span class="nc" id="L241">				addLabel.setText(((LanguageChooserFacade) value).getName());</span>
<span class="nc" id="L242">				cardLayout.show(cellPanel, ADD_ID);</span>
			}
			else
			{
<span class="nc" id="L246">				cellLabel.setForeground(jTable.getForeground());</span>
<span class="nc" id="L247">				cellLabel.setFont(jTable.getFont());</span>
<span class="nc" id="L248">				cellLabel.setText(value.toString());</span>
<span class="nc" id="L249">				cardLayout.show(cellPanel, REMOVE_ID);</span>
			}
<span class="nc" id="L251">			return cellPanel;</span>
		}

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc bnc" id="L257" title="All 2 branches missed.">			if (ADD_ID.equals(e.getActionCommand()))</span>
			{
<span class="nc" id="L259">				Frame frame = JOptionPane.getFrameForComponent(table);</span>
<span class="nc" id="L260">				LanguageChooserFacade chooser = choosers.getElementAt(table.getEditingRow() - languages.getSize());</span>
<span class="nc" id="L261">				LanguageChooserDialog dialog = new LanguageChooserDialog(frame, chooser);</span>
<span class="nc" id="L262">				dialog.setLocationRelativeTo(frame);</span>
<span class="nc" id="L263">				dialog.setVisible(true);</span>
<span class="nc" id="L264">			}</span>
			else
			{
<span class="nc" id="L267">				Language lang = (Language) getValueAt(table.getEditingRow(), 0);</span>
<span class="nc" id="L268">				character.removeLanguage(lang);</span>
			}
<span class="nc" id="L270">			cancelCellEditing();</span>
<span class="nc" id="L271">		}</span>

		@Override
		public Object getCellEditorValue()
		{
<span class="nc" id="L276">			return null;</span>
		}

	}

	private class Renderer extends JPanel implements TableCellRenderer
	{

		private static final String ADD_ID = &quot;Add&quot;;
		private static final String REMOVE_ID = &quot;Remove&quot;;
<span class="nc" id="L286">		private CardLayout cardLayout = new CardLayout();</span>
		//private JPanel cellPanel = new JPanel();
<span class="nc" id="L288">		private JLabel cellLabel = new JLabel();</span>
<span class="nc" id="L289">		private JButton addButton = Utilities.createSignButton(Sign.Plus);</span>
<span class="nc" id="L290">		private JButton removeButton = Utilities.createSignButton(Sign.Minus);</span>
<span class="nc" id="L291">		private JLabel addLabel = new JLabel();</span>

		public Renderer()
<span class="nc" id="L294">		{</span>
<span class="nc" id="L295">			setLayout(cardLayout);</span>
<span class="nc" id="L296">			Box box = Box.createHorizontalBox();</span>
<span class="nc" id="L297">			box.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L298">			box.add(cellLabel);</span>
<span class="nc" id="L299">			box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L300">			box.add(removeButton);</span>
<span class="nc" id="L301">			box.add(Box.createHorizontalStrut(2));</span>
<span class="nc" id="L302">			add(box, REMOVE_ID);</span>

<span class="nc" id="L304">			box = Box.createHorizontalBox();</span>
<span class="nc" id="L305">			box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L306">			box.add(addLabel);</span>
<span class="nc" id="L307">			box.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L308">			box.add(addButton);</span>
<span class="nc" id="L309">			box.add(Box.createHorizontalStrut(2));</span>
<span class="nc" id="L310">			add(box, ADD_ID);</span>
<span class="nc" id="L311">		}</span>

		@Override
		public Component getTableCellRendererComponent(JTable jTable, Object value, boolean isSelected,
			boolean hasFocus, int row, int column)
		{
<span class="nc" id="L317">			TableCellUtilities.setToRowBackground(this, jTable, row);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">			if (row &lt; languages.getSize())</span>
			{
<span class="nc bnc" id="L320" title="All 4 branches missed.">				boolean automatic = value instanceof Language &amp;&amp; character.isAutomatic((Language) value);</span>
<span class="nc bnc" id="L321" title="All 4 branches missed.">				boolean removable = value instanceof Language &amp;&amp; character.isRemovable((Language) value);</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">				if (automatic)</span>
				{
<span class="nc" id="L324">					cellLabel.setForeground(ColorUtilty.colorToAWTColor(UIPropertyContext.getAutomaticColor()));</span>
				}
				else
				{
<span class="nc" id="L328">					cellLabel.setForeground(jTable.getForeground());</span>
				}
<span class="nc" id="L330">				cellLabel.setText(value.toString());</span>
<span class="nc" id="L331">				cellLabel.setFont(jTable.getFont());</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">				removeButton.setEnabled(dirtyRow == row);</span>
<span class="nc" id="L333">				removeButton.setVisible(removable);</span>
<span class="nc" id="L334">				cardLayout.show(this, REMOVE_ID);</span>
<span class="nc" id="L335">			}</span>
			else
			{
<span class="nc" id="L338">				addLabel.setText(((LanguageChooserFacade) value).getName());</span>
<span class="nc" id="L339">				addLabel.setFont(jTable.getFont());</span>
<span class="nc" id="L340">				addLabel.setForeground(jTable.getForeground());</span>
<span class="nc" id="L341">				cardLayout.show(this, ADD_ID);</span>
			}
<span class="nc" id="L343">			return this;</span>
		}

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>