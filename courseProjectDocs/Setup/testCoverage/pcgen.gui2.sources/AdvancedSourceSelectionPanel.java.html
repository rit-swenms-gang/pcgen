<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdvancedSourceSelectionPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.sources</a> &gt; <span class="el_source">AdvancedSourceSelectionPanel.java</span></div><h1>AdvancedSourceSelectionPanel.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2009 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 * 
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 * 
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 * 
 */
package pcgen.gui2.sources;

import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Objects;

import javax.swing.AbstractAction;
import javax.swing.Box;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JSplitPane;
import javax.swing.JTree;
import javax.swing.SwingConstants;
import javax.swing.border.EmptyBorder;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.tree.DefaultMutableTreeNode;

import pcgen.cdom.enumeration.ListKey;
import pcgen.cdom.enumeration.ObjectKey;
import pcgen.cdom.enumeration.StringKey;
import pcgen.core.Campaign;
import pcgen.core.GameMode;
import pcgen.facade.core.GameModeDisplayFacade;
import pcgen.facade.core.SourceSelectionFacade;
import pcgen.facade.util.DefaultListFacade;
import pcgen.facade.util.ListFacade;
import pcgen.facade.util.ListFacades;
import pcgen.facade.util.event.ListEvent;
import pcgen.facade.util.event.ListListener;
import pcgen.gui2.PCGenFrame;
import pcgen.gui2.UIContext;
import pcgen.gui2.UIPropertyContext;
import pcgen.gui2.filter.FilterBar;
import pcgen.gui2.filter.FilteredTreeViewTable;
import pcgen.gui2.filter.SearchFilterPanel;
import pcgen.gui2.tools.FlippingSplitPane;
import pcgen.gui2.tools.Icons;
import pcgen.gui2.tools.InfoPane;
import pcgen.gui2.tools.InfoPaneLinkAction;
import pcgen.gui2.util.FacadeComboBoxModel;
import pcgen.gui2.util.TreeColumnCellRenderer;
import pcgen.gui2.util.table.DynamicTableColumnModel;
import pcgen.gui2.util.table.TableCellUtilities;
import pcgen.gui2.util.treeview.DataView;
import pcgen.gui2.util.treeview.DataViewColumn;
import pcgen.gui2.util.treeview.DefaultDataViewColumn;
import pcgen.gui2.util.treeview.TreeView;
import pcgen.gui2.util.treeview.TreeViewModel;
import pcgen.gui2.util.treeview.TreeViewPath;
import pcgen.gui3.utilty.ColorUtilty;
import pcgen.system.FacadeFactory;
import pcgen.system.LanguageBundle;
import pcgen.util.Comparators;
import pcgen.util.Logging;

import org.apache.commons.lang3.StringUtils;

class AdvancedSourceSelectionPanel extends JPanel
		implements ListSelectionListener, ListListener&lt;Campaign&gt;, ActionListener
{

<span class="nc" id="L92">	private static final UIPropertyContext CONTEXT = </span>
<span class="nc" id="L93">			UIPropertyContext.createContext(&quot;advancedSourceSelectionPanel&quot;); //$NON-NLS-1$</span>
	private static final String PROP_SELECTED_GAME = &quot;selectedGame&quot;; //$NON-NLS-1$
	private static final String PROP_SELECTED_SOURCES = &quot;selectedSources.&quot;; //$NON-NLS-1$

	private final FilteredTreeViewTable&lt;Object, Campaign&gt; availableTable;
	private final FilteredTreeViewTable&lt;Object, Campaign&gt; selectedTable;
	private final SourceTreeViewModel availTreeViewModel;
	private final SourceTreeViewModel selTreeViewModel;
	private final InfoPane infoPane;
	private GameMode gameMode;
	private final JComboBox gameModeList;
	private final InfoPaneLinkAction linkAction;
	private final JButton unloadAllButton;
	private final JButton addButton;
	private final JButton removeButton;
	private final DefaultListFacade&lt;Campaign&gt; selectedCampaigns;
	private final PCGenFrame frame;

	/**
	 * The context indicating what items are currently loaded/being processed in the UI
	 */
	private final UIContext uiContext;
	
	public AdvancedSourceSelectionPanel(PCGenFrame frame, UIContext uiContext)
<span class="nc" id="L117">	{</span>
<span class="nc" id="L118">		this.uiContext = Objects.requireNonNull(uiContext);</span>
<span class="nc" id="L119">		this.frame = frame;</span>
<span class="nc" id="L120">		this.availableTable = new FilteredTreeViewTable&lt;&gt;();</span>
<span class="nc" id="L121">		this.selectedTable = new FilteredTreeViewTable&lt;&gt;();</span>
<span class="nc" id="L122">		this.selectedCampaigns = new DefaultListFacade&lt;&gt;();</span>
<span class="nc" id="L123">		this.availTreeViewModel = new SourceTreeViewModel();</span>
<span class="nc" id="L124">		this.selTreeViewModel = new SourceTreeViewModel(selectedCampaigns);</span>
<span class="nc" id="L125">		this.gameModeList = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L126">		this.unloadAllButton = new JButton();</span>
<span class="nc" id="L127">		this.addButton = new JButton();</span>
<span class="nc" id="L128">		this.removeButton = new JButton();</span>
<span class="nc" id="L129">		this.infoPane = new InfoPane(LanguageBundle.getString(&quot;in_src_info&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L130">		this.linkAction = new InfoPaneLinkAction(infoPane);</span>

<span class="nc" id="L132">		initComponents();</span>
<span class="nc" id="L133">		initDefaults();</span>
<span class="nc" id="L134">		selectedCampaigns.addListListener(this);</span>
<span class="nc" id="L135">	}</span>

	private void initComponents()
	{
<span class="nc" id="L139">		FlippingSplitPane mainPane = new FlippingSplitPane(JSplitPane.VERTICAL_SPLIT);</span>
<span class="nc" id="L140">		FlippingSplitPane topPane = new FlippingSplitPane();</span>
<span class="nc" id="L141">		topPane.setResizeWeight(0.6);</span>
<span class="nc" id="L142">		JPanel panel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L143">		panel.add(new JLabel(LanguageBundle.getString(&quot;in_src_gameLabel&quot;)), BorderLayout.WEST); //$NON-NLS-1$</span>

<span class="nc" id="L145">		FacadeComboBoxModel&lt;GameModeDisplayFacade&gt; gameModes = new FacadeComboBoxModel&lt;&gt;();</span>
<span class="nc" id="L146">		gameModes.setListFacade(FacadeFactory.getGameModeDisplays());</span>
<span class="nc" id="L147">		gameModeList.setModel(gameModes);</span>
<span class="nc" id="L148">		gameModeList.addActionListener(this);</span>
<span class="nc" id="L149">		panel.add(gameModeList, BorderLayout.CENTER);</span>

<span class="nc" id="L151">		FilterBar&lt;Object, Campaign&gt; bar = new FilterBar&lt;&gt;(false);</span>
<span class="nc" id="L152">		bar.add(panel, BorderLayout.WEST);</span>
<span class="nc" id="L153">		bar.addDisplayableFilter(new SearchFilterPanel());</span>
<span class="nc" id="L154">		panel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L155">		panel.add(bar, BorderLayout.NORTH);</span>

<span class="nc" id="L157">		availableTable.setDisplayableFilter(bar);</span>
<span class="nc" id="L158">		availableTable.setTreeViewModel(availTreeViewModel);</span>
<span class="nc" id="L159">		availableTable.getSelectionModel().addListSelectionListener(this);</span>
<span class="nc" id="L160">		availableTable.setTreeCellRenderer(new CampaignRenderer());</span>
<span class="nc" id="L161">		((DynamicTableColumnModel) availableTable.getColumnModel()).getAvailableColumns().get(2)</span>
<span class="nc" id="L162">			.setCellRenderer(new TableCellUtilities.AlignRenderer(SwingConstants.CENTER));</span>

<span class="nc" id="L164">		JScrollPane pane = new JScrollPane(availableTable);</span>
<span class="nc" id="L165">		pane.setPreferredSize(new Dimension(600, 310));</span>
<span class="nc" id="L166">		panel.add(pane, BorderLayout.CENTER);</span>

<span class="nc" id="L168">		Box box = Box.createHorizontalBox();</span>
<span class="nc" id="L169">		unloadAllButton.setAction(new UnloadAllAction());</span>
<span class="nc" id="L170">		box.add(unloadAllButton);</span>
<span class="nc" id="L171">		box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L172">		addButton.setHorizontalTextPosition(SwingConstants.LEADING);</span>
<span class="nc" id="L173">		addButton.setAction(new AddAction());</span>
<span class="nc" id="L174">		box.add(addButton);</span>
<span class="nc" id="L175">		box.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L176">		box.setBorder(new EmptyBorder(0, 0, 5, 0));</span>
<span class="nc" id="L177">		panel.add(box, BorderLayout.SOUTH);</span>

<span class="nc" id="L179">		topPane.setLeftComponent(panel);</span>

<span class="nc" id="L181">		JPanel selPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L182">		FilterBar&lt;Object, Campaign&gt; filterBar = new FilterBar&lt;&gt;();</span>
<span class="nc" id="L183">		filterBar.addDisplayableFilter(new SearchFilterPanel());</span>
<span class="nc" id="L184">		selectedTable.setDisplayableFilter(filterBar);</span>

<span class="nc" id="L186">		selectedTable.setTreeViewModel(selTreeViewModel);</span>
<span class="nc" id="L187">		selectedTable.getSelectionModel().addListSelectionListener(this);</span>
<span class="nc" id="L188">		selectedTable.setTreeCellRenderer(new CampaignRenderer());</span>
<span class="nc" id="L189">		((DynamicTableColumnModel) selectedTable.getColumnModel()).getAvailableColumns().get(2)</span>
<span class="nc" id="L190">			.setCellRenderer(new TableCellUtilities.AlignRenderer(SwingConstants.CENTER));</span>
<span class="nc" id="L191">		JScrollPane scrollPane = new JScrollPane(selectedTable);</span>
<span class="nc" id="L192">		scrollPane.setPreferredSize(new Dimension(300, 350));</span>
<span class="nc" id="L193">		selPanel.add(scrollPane, BorderLayout.CENTER);</span>
<span class="nc" id="L194">		box = Box.createHorizontalBox();</span>
<span class="nc" id="L195">		box.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L196">		removeButton.setAction(new RemoveAction());</span>
<span class="nc" id="L197">		box.add(removeButton);</span>
<span class="nc" id="L198">		box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L199">		box.setBorder(new EmptyBorder(0, 0, 5, 0));</span>
<span class="nc" id="L200">		selPanel.add(box, BorderLayout.SOUTH);</span>

<span class="nc" id="L202">		topPane.setRightComponent(selPanel);</span>
<span class="nc" id="L203">		mainPane.setTopComponent(topPane);</span>

<span class="nc" id="L205">		linkAction.install();</span>
<span class="nc" id="L206">		infoPane.setPreferredSize(new Dimension(800, 150));</span>
<span class="nc" id="L207">		mainPane.setBottomComponent(infoPane);</span>
<span class="nc" id="L208">		mainPane.setResizeWeight(0.7);</span>
<span class="nc" id="L209">		setLayout(new BorderLayout());</span>
<span class="nc" id="L210">		add(mainPane, BorderLayout.CENTER);</span>
<span class="nc" id="L211">	}</span>

	private void initDefaults()
	{
<span class="nc" id="L215">		String defaultGame = CONTEXT.initProperty(PROP_SELECTED_GAME, &quot;&quot;);</span>
<span class="nc" id="L216">		GameModeDisplayFacade modeDisplay = null;</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">		if (StringUtils.isNotEmpty(defaultGame))</span>
		{
<span class="nc bnc" id="L219" title="All 2 branches missed.">			for (int i = 0; i &lt; gameModeList.getModel().getSize(); i++)</span>
			{
<span class="nc" id="L221">				GameModeDisplayFacade game = (GameModeDisplayFacade) gameModeList.getModel().getElementAt(i);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">				if (defaultGame.equals(game.getGameMode().toString()))</span>
				{
<span class="nc" id="L224">					gameModeList.setSelectedIndex(i);</span>
<span class="nc" id="L225">					modeDisplay = game;</span>
				}
			}
		}
<span class="nc bnc" id="L229" title="All 4 branches missed.">		if (modeDisplay == null &amp;&amp; gameModeList.getModel().getSize() &gt; 0)</span>
		{
<span class="nc" id="L231">			gameModeList.setSelectedIndex(0);</span>
<span class="nc" id="L232">			modeDisplay = (GameModeDisplayFacade) gameModeList.getSelectedItem();</span>
		}
<span class="nc" id="L234">	}</span>

	/**
	 * Add the user's previously selected sources for this gamemode 
	 * to the selected list.  
	 * @param mode The game mode being selected
	 */
	private void selectDefaultSources(GameMode mode)
	{
<span class="nc bnc" id="L243" title="All 2 branches missed.">		if (mode != null)</span>
		{
			List&lt;String&gt; sourceNames;
<span class="nc" id="L246">			String defaultSelectedSources = CONTEXT.initProperty(</span>
<span class="nc" id="L247">				PROP_SELECTED_SOURCES + mode.toString(), &quot;&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L248" title="All 4 branches missed.">			if (defaultSelectedSources == null || &quot;&quot;.equals(defaultSelectedSources))</span>
			{
<span class="nc" id="L250">				sourceNames = mode.getDefaultDataSetList();</span>
			}
			else
			{
<span class="nc" id="L254">				sourceNames = Arrays.asList(defaultSelectedSources.split(&quot;\\|&quot;)); //$NON-NLS-1$</span>
			}

<span class="nc bnc" id="L257" title="All 2 branches missed.">			for (String name : sourceNames)</span>
			{
<span class="nc bnc" id="L259" title="All 2 branches missed.">				for (Campaign camp : FacadeFactory.getSupportedCampaigns(mode))</span>
				{
<span class="nc bnc" id="L261" title="All 2 branches missed.">					if (name.equals(camp.toString()))</span>
					{
<span class="nc" id="L263">						selectedCampaigns.addElement(camp);</span>
<span class="nc" id="L264">						break;</span>
					}
<span class="nc" id="L266">				}</span>
<span class="nc" id="L267">			}</span>
		}
<span class="nc" id="L269">	}</span>

	public GameMode getSelectedGameMode()
	{
<span class="nc" id="L273">		return gameMode;</span>
	}

	public List&lt;Campaign&gt; getSelectedCampaigns()
	{
<span class="nc" id="L278">		return selectedCampaigns.getContents();</span>
	}

	public void setSourceSelection(SourceSelectionFacade sources)
	{
<span class="nc bnc" id="L283" title="All 4 branches missed.">		if (sources == null || sources.getGameMode() == null)</span>
		{
<span class="nc" id="L285">			Logging.errorPrint(&quot;Invalid source selection &quot; + sources + &quot;- ignoring.&quot;);</span>
<span class="nc" id="L286">			return;</span>
		}
<span class="nc" id="L288">		GameMode selectedGame = sources.getGameMode().get();</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">		for (int i = 0; i &lt; gameModeList.getModel().getSize(); i++)</span>
		{
<span class="nc" id="L291">			GameModeDisplayFacade gmdf = (GameModeDisplayFacade) gameModeList.getModel().getElementAt(i);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">			if (gmdf.getGameMode() == selectedGame)</span>
			{
<span class="nc" id="L294">				gameModeList.setSelectedItem(gmdf);</span>
			}
		}
<span class="nc" id="L297">		List&lt;Campaign&gt; wrap = new ArrayList&lt;&gt;(ListFacades.wrap(sources.getCampaigns()));</span>
<span class="nc" id="L298">		wrap.sort(Comparators.toStringIgnoreCaseCollator());</span>
<span class="nc" id="L299">		selectedCampaigns.setContents(wrap);</span>
<span class="nc" id="L300">	}</span>

	private void setSelectedGameMode(GameModeDisplayFacade elementAt)
	{
<span class="nc" id="L304">		this.gameMode = elementAt.getGameMode();</span>
<span class="nc" id="L305">		CONTEXT.setProperty(PROP_SELECTED_GAME, gameMode.toString());</span>
<span class="nc" id="L306">		selectedCampaigns.clearContents();</span>
<span class="nc" id="L307">		availTreeViewModel.setGameModel(elementAt.getGameMode());</span>
<span class="nc" id="L308">		selectDefaultSources(gameMode);</span>
<span class="nc" id="L309">	}</span>

	private void setSelectedCampaign(Campaign source)
	{
<span class="nc" id="L313">		infoPane.setText(FacadeFactory.getCampaignInfoFactory().getHTMLInfo(source, selectedCampaigns.getContents()));</span>
<span class="nc" id="L314">	}</span>

	@Override
	public void valueChanged(ListSelectionEvent e)
	{
<span class="nc bnc" id="L319" title="All 2 branches missed.">		if (!e.getValueIsAdjusting())</span>
		{
<span class="nc bnc" id="L321" title="All 2 branches missed.">			if (e.getSource() == availableTable.getSelectionModel())</span>
			{
<span class="nc" id="L323">				int selectedRow = availableTable.getSelectedRow();</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">				if (selectedRow != -1)</span>
				{
<span class="nc" id="L326">					final Object data = availableTable.getModel().getValueAt(selectedRow, 0);</span>
<span class="nc bnc" id="L327" title="All 4 branches missed.">					if (data != null &amp;&amp; data instanceof Campaign)</span>
					{
<span class="nc" id="L329">						setSelectedCampaign((Campaign) data);</span>
					}
				}
<span class="nc" id="L332">			}</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">			else if (e.getSource() == selectedTable.getSelectionModel())</span>
			{
<span class="nc" id="L335">				int selectedRow = selectedTable.getSelectedRow();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">				if (selectedRow != -1)</span>
				{
<span class="nc" id="L338">					final Object data = selectedTable.getModel().getValueAt(selectedRow, 0);</span>
<span class="nc bnc" id="L339" title="All 4 branches missed.">					if (data != null &amp;&amp; data instanceof Campaign)</span>
					{
<span class="nc" id="L341">						setSelectedCampaign((Campaign) data);</span>
					}
				}
			}
		}
<span class="nc" id="L346">	}</span>

	void refreshDisplay()
	{
<span class="nc" id="L350">		availableTable.refreshModelData();</span>
<span class="nc" id="L351">		selectedTable.refreshModelData();</span>
<span class="nc" id="L352">	}</span>

	@Override
	public void actionPerformed(ActionEvent e)
	{
		// Signal from the game mode conbo that the selection has changed.
<span class="nc" id="L358">		setSelectedGameMode((GameModeDisplayFacade) gameModeList.getSelectedItem());</span>
<span class="nc" id="L359">	}</span>

	@Override
	public void elementAdded(ListEvent&lt;Campaign&gt; e)
	{
		// Refresh displayed rows now that the selection has changed
<span class="nc" id="L365">		availableTable.updateDisplay();</span>
<span class="nc" id="L366">	}</span>

	@Override
	public void elementRemoved(ListEvent&lt;Campaign&gt; e)
	{
		// Refresh displayed rows now that the selection has changed
<span class="nc" id="L372">		availableTable.updateDisplay();</span>
<span class="nc" id="L373">	}</span>

	@Override
	public void elementsChanged(ListEvent&lt;Campaign&gt; e)
	{
		// Refresh displayed rows now that the selection has changed
<span class="nc" id="L379">		availableTable.updateDisplay();</span>
<span class="nc" id="L380">	}</span>

	@Override
	public void elementModified(ListEvent&lt;Campaign&gt; e)
	{
<span class="nc" id="L385">		availableTable.updateDisplay();</span>
<span class="nc" id="L386">	}</span>

	/**
	 * Save the selected sources for the current game mode so they can be 
	 * restored next time we start.
	 */
	void rememberSelectedSources()
	{
<span class="nc" id="L394">		String sources = StringUtils.join(getSelectedCampaigns(), &quot;|&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L395">		CONTEXT.setProperty(PROP_SELECTED_SOURCES + gameMode.toString(), sources);</span>
<span class="nc" id="L396">	}</span>

	private class AddAction extends AbstractAction
	{

		public AddAction()
<span class="nc" id="L402">		{</span>
<span class="nc" id="L403">			super(LanguageBundle.getString(&quot;in_addSelected&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L404">			putValue(SMALL_ICON, Icons.Forward16.getImageIcon());</span>
<span class="nc" id="L405">			availableTable.addActionListener(this);</span>
<span class="nc" id="L406">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L411">			List&lt;Object&gt; list = availableTable.getSelectedData();</span>
<span class="nc bnc" id="L412" title="All 4 branches missed.">			if (list != null &amp;&amp; !list.isEmpty())</span>
			{
<span class="nc bnc" id="L414" title="All 2 branches missed.">				for (Object obj : list)</span>
				{
<span class="nc bnc" id="L416" title="All 2 branches missed.">					if (obj instanceof Campaign camp)</span>
					{
<span class="nc bnc" id="L418" title="All 2 branches missed.">						if (selectedCampaigns.containsElement(camp))</span>
						{
							// Already in the list - ignore
<span class="nc" id="L421">							continue;</span>
						}
<span class="nc" id="L423">						selectedCampaigns.addElement(camp);</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">						if (!FacadeFactory.passesPrereqs(selectedCampaigns.getContents()))</span>
						{
<span class="nc" id="L426">							String prereqDesc = FacadeFactory.getCampaignInfoFactory().getRequirementsHTMLString(camp,</span>
<span class="nc" id="L427">								selectedCampaigns.getContents());</span>
<span class="nc" id="L428">							JOptionPane.showMessageDialog(AdvancedSourceSelectionPanel.this,</span>
<span class="nc" id="L429">								LanguageBundle.getFormattedString(&quot;in_src_badComboMsg&quot;, //$NON-NLS-1$</span>
									prereqDesc),
<span class="nc" id="L431">								LanguageBundle.getString(&quot;in_src_badComboTitle&quot;), //$NON-NLS-1$</span>
								JOptionPane.INFORMATION_MESSAGE);
<span class="nc" id="L433">							selectedCampaigns.removeElement(camp);</span>
						}
					}
<span class="nc" id="L436">				}</span>
<span class="nc" id="L437">				rememberSelectedSources();</span>
			}
<span class="nc" id="L439">		}</span>
	}

	private class RemoveAction extends AbstractAction
	{

		public RemoveAction()
<span class="nc" id="L446">		{</span>
<span class="nc" id="L447">			super(LanguageBundle.getString(&quot;in_removeSelected&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L448">			putValue(SMALL_ICON, Icons.Back16.getImageIcon());</span>
<span class="nc" id="L449">			selectedTable.addActionListener(this);</span>
<span class="nc" id="L450">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L455">			List&lt;Object&gt; list = selectedTable.getSelectedData();</span>
<span class="nc bnc" id="L456" title="All 4 branches missed.">			if (list != null &amp;&amp; !list.isEmpty())</span>
			{
<span class="nc bnc" id="L458" title="All 2 branches missed.">				for (Object obj : list)</span>
				{
<span class="nc bnc" id="L460" title="All 2 branches missed.">					if (obj instanceof Campaign)</span>
					{
<span class="nc" id="L462">						selectedCampaigns.removeElement((Campaign) obj);</span>
					}
<span class="nc" id="L464">				}</span>
<span class="nc" id="L465">				rememberSelectedSources();</span>
			}
<span class="nc" id="L467">		}</span>
	}

	private class UnloadAllAction extends AbstractAction
	{

		public UnloadAllAction()
<span class="nc" id="L474">		{</span>
<span class="nc" id="L475">			super(LanguageBundle.getString(&quot;in_src_unloadAll&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L476">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L481">			frame.unloadSources();</span>
<span class="nc" id="L482">			availableTable.refreshModelData();</span>
<span class="nc" id="L483">			selectedTable.refreshModelData();</span>
<span class="nc" id="L484">		}</span>
	}

	private class SourceTreeViewModel
			implements TreeViewModel&lt;Campaign&gt;, DataView&lt;Campaign&gt;, ListListener&lt;Campaign&gt;
	{

<span class="nc" id="L491">		private final ListFacade&lt;TreeView&lt;Campaign&gt;&gt; views =</span>
<span class="nc" id="L492">				new DefaultListFacade&lt;&gt;(Arrays.asList(SourceTreeView.values()));</span>
		private final DefaultListFacade&lt;Campaign&gt; model;
<span class="nc" id="L494">		private ListFacade&lt;Campaign&gt; baseModel = null;</span>
		private final List&lt;DefaultDataViewColumn&gt; columns;
		private final boolean isAvailModel;

		public SourceTreeViewModel()
<span class="nc" id="L499">		{</span>
<span class="nc" id="L500">			this.model = new DefaultListFacade&lt;&gt;();</span>
<span class="nc" id="L501">			this.isAvailModel = true;</span>
<span class="nc" id="L502">			columns = Arrays.asList(new DefaultDataViewColumn(&quot;in_src_bookType&quot;, String.class, true),</span>
				new DefaultDataViewColumn(&quot;in_src_status&quot;, String.class, true),
				new DefaultDataViewColumn(&quot;in_src_loaded&quot;, String.class, false));
<span class="nc" id="L505">		}</span>

		public SourceTreeViewModel(DefaultListFacade&lt;Campaign&gt; model)
<span class="nc" id="L508">		{</span>
<span class="nc" id="L509">			this.model = model;</span>
<span class="nc" id="L510">			this.isAvailModel = false;</span>
<span class="nc" id="L511">			columns = Arrays.asList(new DefaultDataViewColumn(&quot;in_src_bookType&quot;, String.class, false),</span>
				new DefaultDataViewColumn(&quot;in_src_status&quot;, String.class, false),
				new DefaultDataViewColumn(&quot;in_src_loaded&quot;, String.class, false));
<span class="nc" id="L514">		}</span>

		@Override
		public ListFacade&lt;? extends TreeView&lt;Campaign&gt;&gt; getTreeViews()
		{
<span class="nc" id="L519">			return views;</span>
		}

		@Override
		public int getDefaultTreeViewIndex()
		{
<span class="nc bnc" id="L525" title="All 2 branches missed.">			return isAvailModel ? 2 : 0;</span>
		}

		@Override
		public DataView&lt;Campaign&gt; getDataView()
		{
<span class="nc" id="L531">			return this;</span>
		}

		@Override
		public ListFacade&lt;Campaign&gt; getDataModel()
		{
<span class="nc" id="L537">			return model;</span>
		}

		@Override
		public Object getData(Campaign obj, int column)
		{
<span class="nc" id="L543">			SourceSelectionFacade sourceFacade = uiContext.getCurrentSourceSelectionRef().get();</span>
<span class="nc bnc" id="L544" title="All 4 branches missed.">			boolean isLoaded = (sourceFacade != null) &amp;&amp; sourceFacade.getCampaigns().containsElement(obj);</span>
<span class="nc bnc" id="L545" title="All 4 branches missed.">			return switch (column)</span>
					{
<span class="nc" id="L547">						case 0 -&gt; obj.getListAsString(ListKey.BOOK_TYPE);</span>
<span class="nc" id="L548">						case 1 -&gt; obj.getSafe(ObjectKey.STATUS).toString();</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">						case 2 -&gt; isLoaded ? LanguageBundle.getString(&quot;in_yes&quot;) : LanguageBundle.getString(&quot;in_no&quot;);</span>
<span class="nc" id="L550">						default -&gt; null;</span>
					};
		}

		@Override
		public void setData(Object value, Campaign element, int column)
		{
<span class="nc" id="L557">		}</span>

		@Override
		public List&lt;? extends DataViewColumn&gt; getDataColumns()
		{
<span class="nc" id="L562">			return columns;</span>
		}

		public void setGameModel(GameMode gameMode)
		{
<span class="nc bnc" id="L567" title="All 2 branches missed.">			if (baseModel != null)</span>
			{
<span class="nc" id="L569">				baseModel.removeListListener(this);</span>
			}
<span class="nc" id="L571">			baseModel = FacadeFactory.getSupportedCampaigns(gameMode);</span>
<span class="nc" id="L572">			model.setContents(ListFacades.wrap(baseModel));</span>
<span class="nc" id="L573">			baseModel.addListListener(this);</span>
<span class="nc" id="L574">		}</span>

		@Override
		public void elementAdded(ListEvent&lt;Campaign&gt; e)
		{
<span class="nc" id="L579">			model.addElement(e.getIndex(), e.getElement());</span>
<span class="nc" id="L580">		}</span>

		@Override
		public void elementRemoved(ListEvent&lt;Campaign&gt; e)
		{
<span class="nc" id="L585">			model.removeElement(e.getIndex());</span>
<span class="nc" id="L586">		}</span>

		@Override
		public void elementsChanged(ListEvent&lt;Campaign&gt; e)
		{
<span class="nc" id="L591">			model.setContents(ListFacades.wrap(baseModel));</span>
<span class="nc" id="L592">		}</span>

		@Override
		public void elementModified(ListEvent&lt;Campaign&gt; e)
		{
<span class="nc" id="L597">		}</span>

		@Override
		public String getPrefsKey()
		{
<span class="nc bnc" id="L602" title="All 2 branches missed.">			return isAvailModel ? &quot;SourceAvail&quot; : &quot;SourceSelected&quot;; //$NON-NLS-1$//$NON-NLS-2$</span>
		}

	}

<span class="nc" id="L607">	private static enum SourceTreeView implements TreeView&lt;Campaign&gt;</span>
	{

<span class="nc" id="L610">		NAME(&quot;in_nameLabel&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L611">		PUBLISHER_NAME(&quot;in_src_pubName&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L612">		PUBLISHER_SETTING_NAME(&quot;in_src_pubSetName&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L613">		PUBLISHER_FORMAT_SETTING_NAME(&quot;in_src_pubFmtSetName&quot;); //$NON-NLS-1$</span>
		private final String name;

		private SourceTreeView(String name)
<span class="nc" id="L617">		{</span>
<span class="nc" id="L618">			this.name = LanguageBundle.getString(name);</span>
<span class="nc" id="L619">		}</span>

		@Override
		public String getViewName()
		{
<span class="nc" id="L624">			return name;</span>
		}

		@Override
		public List&lt;TreeViewPath&lt;Campaign&gt;&gt; getPaths(Campaign pobj)
		{
<span class="nc" id="L630">			String publisher = pobj.get(StringKey.DATA_PRODUCER);</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">			if (publisher == null)</span>
			{
<span class="nc" id="L633">				publisher = LanguageBundle.getString(&quot;in_other&quot;); //$NON-NLS-1$</span>
			}
<span class="nc" id="L635">			String setting = pobj.get(StringKey.CAMPAIGN_SETTING);</span>
<span class="nc" id="L636">			String format = pobj.get(StringKey.DATA_FORMAT);</span>
<span class="nc bnc" id="L637" title="All 5 branches missed.">			switch (this)</span>
			{
				case NAME:
<span class="nc" id="L640">					return Collections.singletonList(new TreeViewPath&lt;&gt;(pobj));</span>
				case PUBLISHER_FORMAT_SETTING_NAME:
<span class="nc bnc" id="L642" title="All 4 branches missed.">					if (format != null &amp;&amp; setting != null)</span>
					{
<span class="nc" id="L644">						return Collections</span>
<span class="nc" id="L645">							.singletonList(new TreeViewPath&lt;&gt;(pobj, publisher, format, setting));</span>
					}
<span class="nc bnc" id="L647" title="All 2 branches missed.">					if (format != null)</span>
					{
<span class="nc" id="L649">						return Collections.singletonList(new TreeViewPath&lt;&gt;(pobj, publisher, format));</span>
					}
				case PUBLISHER_SETTING_NAME:
<span class="nc bnc" id="L652" title="All 2 branches missed.">					if (setting != null)</span>
					{
<span class="nc" id="L654">						return Collections.singletonList(new TreeViewPath&lt;&gt;(pobj, publisher, setting));</span>
					}
				case PUBLISHER_NAME:
<span class="nc" id="L657">					return Collections.singletonList(new TreeViewPath&lt;&gt;(pobj, publisher));</span>
				default:
<span class="nc" id="L659">					throw new InternalError();</span>
			}
		}

	}

	/**
	 * The Class {@code CampaignRenderer} displays the tree cells of the
	 * source table.  
	 */
	private class CampaignRenderer extends TreeColumnCellRenderer
	{

		/**
		 * Create a new renderer for the campaign names for a game mode. The 
		 * names will be coloured to show if they are qualified or not.
		 */
		public CampaignRenderer()
<span class="nc" id="L677">		{</span>
<span class="nc" id="L678">			setTextNonSelectionColor(ColorUtilty.colorToAWTColor(UIPropertyContext.getQualifiedColor()));</span>
<span class="nc" id="L679">		}</span>

		@Override
		public Component getTreeCellRendererComponent(JTree tree, Object value, boolean sel, boolean expanded,
			boolean leaf, int row, boolean focus)
		{

<span class="nc" id="L686">			super.getTreeCellRendererComponent(tree, value, sel, expanded, leaf, row, focus);</span>
<span class="nc" id="L687">			Object campaignObj = ((DefaultMutableTreeNode) value).getUserObject();</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">			if (campaignObj instanceof Campaign campaign)</span>
			{
<span class="nc" id="L690">				List&lt;Campaign&gt; testCampaigns = selectedCampaigns.getContents();</span>
<span class="nc" id="L691">				testCampaigns.add(campaign);</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">				if (!FacadeFactory.passesPrereqs(testCampaigns))</span>
				{
<span class="nc" id="L694">					setForeground(ColorUtilty.colorToAWTColor(UIPropertyContext.getNotQualifiedColor()));</span>
				}
			}
<span class="nc" id="L697">			return this;</span>
		}

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>