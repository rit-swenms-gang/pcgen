<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EquipmentModels.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.tabs.equip</a> &gt; <span class="el_source">EquipmentModels.java</span></div><h1>EquipmentModels.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2011 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 * 
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 * 
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 * 
 */
package pcgen.gui2.tabs.equip;

import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.GraphicsEnvironment;
import java.awt.Rectangle;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.List;

import javax.swing.AbstractAction;
import javax.swing.AbstractCellEditor;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JSpinner;
import javax.swing.JTable;
import javax.swing.ScrollPaneConstants;
import javax.swing.SpinnerNumberModel;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.JTableHeader;
import javax.swing.table.TableCellEditor;
import javax.swing.table.TableModel;

import pcgen.base.util.HashMapToList;
import pcgen.base.util.MapToList;
import pcgen.facade.core.CharacterFacade;
import pcgen.facade.core.EquipmentFacade;
import pcgen.facade.core.EquipmentListFacade;
import pcgen.facade.core.EquipmentSetFacade;
import pcgen.facade.util.ReferenceFacade;
import pcgen.facade.util.event.ReferenceEvent;
import pcgen.facade.util.event.ReferenceListener;
import pcgen.gui2.facade.EquipNode;
import pcgen.gui2.filter.DisplayableFilter;
import pcgen.gui2.filter.FilterHandler;
import pcgen.gui2.tools.Icons;
import pcgen.gui2.util.JTableEx;
import pcgen.gui2.util.JTreeTable;
import pcgen.gui2.util.table.TableCellUtilities;
import pcgen.system.LanguageBundle;

/**
 * The container for equipping data for a character. It holds references to the 
 * models for both the left and right tables of gear. It also contains the 
 * processing to manage equipping and unequipping actions.
 *
 *  
 */
public class EquipmentModels
{

<span class="nc" id="L79">	public enum EquipView</span>
	{
<span class="nc" id="L81">		FULL, UNEQUIPPED, EQUIPPED;</span>

		@Override
		public String toString()
		{
<span class="nc bnc" id="L86" title="All 4 branches missed.">			return switch (this)</span>
					{
<span class="nc" id="L88">						case FULL -&gt; LanguageBundle.getString(&quot;in_equipListFull&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L89">						case UNEQUIPPED -&gt; LanguageBundle.getString(&quot;in_equipListUnequipped&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L90">						case EQUIPPED -&gt; LanguageBundle.getString(&quot;in_equipListEquipped&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L91">						default -&gt; throw new InternalError();</span>
					};
		}

	}

	private final CharacterFacade character;
	private final EquipmentTableModel fullModel;
	private final EquipmentTableModel unequippedModel;
	private final EquipmentTableModel equippedModel;
	private final UnequippedList unequippedList;
	private final EquipViewHandler viewHandler;
	private final EquipAction equipAction;
	private final UnequipAction unequipAction;
	private final MoveUpAction moveUpAction;
	private final MoveDownAction moveDownAction;
	private final EquipFilterHandler filterHandler;
	private EquipView selectedView;
	private EquipmentTableModel selectedModel;
	private final JComboBox equipViewBox;
	private final JTableEx equipmentTable;
	private final JTreeTable equipmentSetTable;
	private final JButton equipButton;
	private final JButton unequipButton;
	private final JButton moveUpButton;
	private final JButton moveDownButton;
	private final DisplayableFilter&lt;? super CharacterFacade, ? super EquipmentFacade&gt; filter;

	public EquipmentModels(CharacterFacade character, JComboBox equipBox, JTableEx eqTable,
		DisplayableFilter&lt;? super CharacterFacade, ? super EquipmentFacade&gt; filter, JTreeTable eqSetTable,
		JButton equipButton, JButton unequipButton, JButton moveUpButton, JButton moveDownButton)
<span class="nc" id="L122">	{</span>
<span class="nc" id="L123">		this.character = character;</span>
<span class="nc" id="L124">		this.unequippedList = new UnequippedList(character);</span>
<span class="nc" id="L125">		this.fullModel = new EquippedTableRootModel(character);</span>
<span class="nc" id="L126">		fullModel.setEquipmentList(character.getPurchasedEquipment());</span>
<span class="nc" id="L127">		this.unequippedModel = new EquippedTableRootModel(character);</span>
<span class="nc" id="L128">		unequippedModel.setEquipmentList(unequippedList);</span>
<span class="nc" id="L129">		this.equippedModel = new EquippedTableModel(character);</span>

<span class="nc" id="L131">		selectedModel = fullModel;</span>
<span class="nc" id="L132">		selectedView = EquipView.UNEQUIPPED;</span>

<span class="nc" id="L134">		this.viewHandler = new EquipViewHandler();</span>
<span class="nc" id="L135">		this.equipAction = new EquipAction();</span>
<span class="nc" id="L136">		this.unequipAction = new UnequipAction();</span>
<span class="nc" id="L137">		this.moveUpAction = new MoveUpAction();</span>
<span class="nc" id="L138">		this.moveDownAction = new MoveDownAction();</span>
<span class="nc" id="L139">		this.filterHandler = new EquipFilterHandler();</span>

<span class="nc" id="L141">		this.equipViewBox = equipBox;</span>
<span class="nc" id="L142">		this.equipmentTable = eqTable;</span>
<span class="nc" id="L143">		this.equipmentSetTable = eqSetTable;</span>
<span class="nc" id="L144">		this.filter = filter;</span>
<span class="nc" id="L145">		this.equipButton = equipButton;</span>
<span class="nc" id="L146">		this.unequipButton = unequipButton;</span>
<span class="nc" id="L147">		this.moveUpButton = moveUpButton;</span>
<span class="nc" id="L148">		this.moveDownButton = moveDownButton;</span>
<span class="nc" id="L149">	}</span>

	public void install()
	{
<span class="nc" id="L153">		viewHandler.install();</span>
<span class="nc" id="L154">		equipButton.setAction(equipAction);</span>
<span class="nc" id="L155">		unequipButton.setAction(unequipAction);</span>
<span class="nc" id="L156">		moveUpButton.setAction(moveUpAction);</span>
<span class="nc" id="L157">		moveDownButton.setAction(moveDownAction);</span>
<span class="nc" id="L158">		moveDownAction.install();</span>
<span class="nc" id="L159">		moveUpAction.install();</span>
<span class="nc" id="L160">		equipAction.install();</span>
<span class="nc" id="L161">		unequipAction.install();</span>

<span class="nc" id="L163">		filter.setFilterHandler(filterHandler);</span>
<span class="nc" id="L164">		fullModel.setFilter(filter);</span>
<span class="nc" id="L165">		unequippedModel.setFilter(filter);</span>
<span class="nc" id="L166">		equippedModel.setFilter(filter);</span>
<span class="nc" id="L167">	}</span>

	public void uninstall()
	{
<span class="nc" id="L171">		equipAction.uninstall();</span>
<span class="nc" id="L172">		unequipAction.uninstall();</span>
<span class="nc" id="L173">	}</span>

	private List&lt;EquipNode&gt; getSelectedEquipmentSetNodes()
	{
<span class="nc" id="L177">		int[] rows = equipmentSetTable.getSelectedRows();</span>
<span class="nc" id="L178">		List&lt;EquipNode&gt; paths = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">		for (int row : rows)</span>
		{
<span class="nc" id="L181">			EquipNode path = (EquipNode) equipmentSetTable.getValueAt(row, 0);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">			if (path.getNodeType() == EquipNode.NodeType.EQUIPMENT)</span>
			{
<span class="nc" id="L184">				paths.add(path);</span>
			}
		}
<span class="nc" id="L187">		return paths;</span>
	}

	private void selectNodeInEquipmentSetTable(EquipNode nodeToSelect)
	{
<span class="nc" id="L192">		TableModel model = equipmentSetTable.getModel();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">		for (int i = 0; i &lt; model.getRowCount(); i++)</span>
		{
<span class="nc bnc" id="L195" title="All 2 branches missed.">			if (nodeToSelect == model.getValueAt(i, 0))</span>
			{
<span class="nc" id="L197">				equipmentSetTable.getSelectionModel().setSelectionInterval(i, i);</span>
<span class="nc" id="L198">				break;</span>
			}
		}
<span class="nc" id="L201">	}</span>

	private static JScrollPane prepareScrollPane(JTable table)
	{
<span class="nc" id="L205">		JScrollPane pane = new JScrollPane(table);</span>
<span class="nc" id="L206">		Dimension size = table.getPreferredSize();</span>
<span class="nc" id="L207">		size.height += 30; // account for the header which has not been prepared yet</span>
<span class="nc" id="L208">		final int decorationHeight = 80;</span>
<span class="nc" id="L209">		final int decorationWidth = 70;</span>
<span class="nc" id="L210">		Rectangle screenBounds = GraphicsEnvironment.getLocalGraphicsEnvironment().getMaximumWindowBounds();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">		if (size.height &gt; screenBounds.height - decorationHeight)</span>
		{
<span class="nc" id="L213">			size.height = screenBounds.height - decorationHeight;</span>
		}
<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (size.width &gt; screenBounds.width - decorationWidth)</span>
		{
<span class="nc" id="L217">			size.width = screenBounds.width - decorationWidth;</span>
		}
<span class="nc" id="L219">		pane.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);</span>
<span class="nc" id="L220">		pane.setPreferredSize(size);</span>
<span class="nc" id="L221">		return pane;</span>
	}

<span class="nc" id="L224">	private class EquipFilterHandler implements FilterHandler</span>
	{

		@Override
		public void refilter()
		{
<span class="nc" id="L230">			selectedModel.refilter();</span>
<span class="nc" id="L231">		}</span>

		@Override
		public void setSearchEnabled(boolean enable)
		{
			//do nothing
<span class="nc" id="L237">		}</span>

		@Override
		public void scrollToTop()
		{
			// do nothing
<span class="nc" id="L243">		}</span>

	}

<span class="nc" id="L247">	private class EquipViewHandler extends AbstractAction</span>
	{

		public void install()
		{
<span class="nc" id="L252">			equipViewBox.setAction(this);</span>
<span class="nc" id="L253">			equipViewBox.setSelectedItem(selectedView);</span>
<span class="nc" id="L254">			equipmentTable.setModel(selectedModel);</span>
<span class="nc" id="L255">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L260">			selectedView = (EquipView) equipViewBox.getSelectedItem();</span>
<span class="nc bnc" id="L261" title="All 4 branches missed.">			switch (selectedView)</span>
			{
				case FULL -&gt; {
<span class="nc" id="L264">					selectedModel = fullModel;</span>
<span class="nc" id="L265">					equipAction.setEnabled(true);</span>
<span class="nc" id="L266">				}</span>
				case UNEQUIPPED -&gt; {
<span class="nc" id="L268">					selectedModel = unequippedModel;</span>
<span class="nc" id="L269">					equipAction.setEnabled(true);</span>
<span class="nc" id="L270">				}</span>
				case EQUIPPED -&gt; {
<span class="nc" id="L272">					selectedModel = equippedModel;</span>
<span class="nc" id="L273">					equipAction.setEnabled(false);</span>
<span class="nc" id="L274">				}</span>
				default -&gt; {
				}
				//Case not caught, should this cause an error?
			}
<span class="nc" id="L279">			equipmentTable.setModel(selectedModel);</span>
<span class="nc" id="L280">			filterHandler.refilter();</span>
<span class="nc" id="L281">		}</span>

	}

	private static class EquippedTableModel extends EquipmentTableModel implements ReferenceListener&lt;EquipmentSetFacade&gt;
	{

		public EquippedTableModel(CharacterFacade character)
		{
<span class="nc" id="L290">			super(character);</span>
<span class="nc" id="L291">			ReferenceFacade&lt;EquipmentSetFacade&gt; ref = character.getEquipmentSetRef();</span>
<span class="nc" id="L292">			ref.addReferenceListener(this);</span>
<span class="nc" id="L293">			setEquipmentList(ref.get().getEquippedItems());</span>
<span class="nc" id="L294">			setEquipmentSet(ref.get());</span>
<span class="nc" id="L295">		}</span>

		@Override
		public void referenceChanged(ReferenceEvent&lt;EquipmentSetFacade&gt; e)
		{
<span class="nc" id="L300">			setEquipmentList(e.getNewReference().getEquippedItems());</span>
<span class="nc" id="L301">			setEquipmentSet(e.getNewReference());</span>
<span class="nc" id="L302">		}</span>

	}

	private static class EquippedTableRootModel extends EquipmentTableModel implements ReferenceListener&lt;EquipmentSetFacade&gt;
	{

		public EquippedTableRootModel(CharacterFacade character)
		{
<span class="nc" id="L311">			super(character);</span>
<span class="nc" id="L312">			ReferenceFacade&lt;EquipmentSetFacade&gt; ref = character.getEquipmentSetRef();</span>
<span class="nc" id="L313">			ref.addReferenceListener(this);</span>
<span class="nc" id="L314">			setEquipmentSet(ref.get());</span>
<span class="nc" id="L315">		}</span>

		@Override
		public void referenceChanged(ReferenceEvent&lt;EquipmentSetFacade&gt; e)
		{
<span class="nc" id="L320">			EquipmentSetFacade es = e.getNewReference();</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">			if (es.isRoot())</span>
			{
<span class="nc" id="L323">				setEquipmentSet(e.getNewReference());</span>
			}
<span class="nc" id="L325">		}</span>

	}

	private class UnequipAction extends AbstractAction
	{

		public UnequipAction()
<span class="nc" id="L333">		{</span>
<span class="nc" id="L334">			super(LanguageBundle.getString(&quot;in_equipUnequipSel&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L335">			this.putValue(SMALL_ICON, Icons.Back16.getImageIcon());</span>
<span class="nc" id="L336">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L341">			EquipmentSetFacade equipSet = character.getEquipmentSetRef().get();</span>
<span class="nc" id="L342">			List&lt;EquipNode&gt; paths = getSelectedEquipmentSetNodes();</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">			if (!paths.isEmpty())</span>
			{
<span class="nc" id="L345">				Object[][] data = new Object[paths.size()][3];</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">				for (int i = 0; i &lt; paths.size(); i++)</span>
				{
<span class="nc" id="L348">					EquipNode path = paths.get(i);</span>
<span class="nc" id="L349">					data[i][0] = path.getEquipment();</span>
<span class="nc" id="L350">					data[i][1] = equipSet.getQuantity(path);</span>
				}
<span class="nc" id="L352">				Object[] columns = {LanguageBundle.getString(&quot;in_equipItem&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L353">					LanguageBundle.getString(&quot;in_equipQuantityAbbrev&quot;), //$NON-NLS-1$</span>
				};
<span class="nc" id="L355">				DefaultTableModel tableModel = new DefaultTableModel(data, columns)</span>
<span class="nc" id="L356">				{</span>

					@Override
					public Class&lt;?&gt; getColumnClass(int columnIndex)
					{
<span class="nc bnc" id="L361" title="All 2 branches missed.">						if (columnIndex == 1)</span>
						{
<span class="nc" id="L363">							return Integer.class;</span>
						}
<span class="nc" id="L365">						return Object.class;</span>
					}

					@Override
					public boolean isCellEditable(int row, int column)
					{
<span class="nc bnc" id="L371" title="All 2 branches missed.">						return column != 0;</span>
					}

				};
<span class="nc" id="L375">				JTable table = new JTable(tableModel);</span>
<span class="nc" id="L376">				table.setFocusable(false);</span>
<span class="nc" id="L377">				table.setCellSelectionEnabled(false);</span>
<span class="nc" id="L378">				table.setDefaultRenderer(Integer.class, new TableCellUtilities.SpinnerRenderer());</span>
<span class="nc" id="L379">				table.setDefaultEditor(Integer.class, new SpinnerEditor(equipSet.getEquippedItems()));</span>
<span class="nc" id="L380">				table.setRowHeight(22);</span>
<span class="nc" id="L381">				table.getColumnModel().getColumn(0).setPreferredWidth(140);</span>
<span class="nc" id="L382">				table.getColumnModel().getColumn(1).setPreferredWidth(50);</span>
<span class="nc" id="L383">				table.setPreferredScrollableViewportSize(table.getPreferredSize());</span>
<span class="nc" id="L384">				JTableHeader header = table.getTableHeader();</span>
<span class="nc" id="L385">				header.setReorderingAllowed(false);</span>
<span class="nc" id="L386">				JScrollPane pane = EquipmentModels.prepareScrollPane(table);</span>
<span class="nc" id="L387">				JPanel panel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L388">				JLabel help = new JLabel(LanguageBundle.getString(&quot;in_equipSelectUnequipQty&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L389">				panel.add(help, BorderLayout.NORTH);</span>
<span class="nc" id="L390">				panel.add(pane, BorderLayout.CENTER);</span>
<span class="nc" id="L391">				int res = JOptionPane.showConfirmDialog(JOptionPane.getFrameForComponent(equipmentTable), panel,</span>
<span class="nc" id="L392">					LanguageBundle.getString(&quot;in_equipUnequipSel&quot;), //$NON-NLS-1$</span>
					JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

<span class="nc bnc" id="L395" title="All 2 branches missed.">				if (res == JOptionPane.OK_OPTION)</span>
				{
<span class="nc bnc" id="L397" title="All 2 branches missed.">					for (int i = 0; i &lt; paths.size(); i++)</span>
					{
<span class="nc" id="L399">						equipSet.removeEquipment(paths.get(i), (Integer) tableModel.getValueAt(i, 1));</span>
					}
				}
			}
<span class="nc" id="L403">		}</span>

		public void install()
		{
<span class="nc" id="L407">			equipmentSetTable.addActionListener(this);</span>
<span class="nc" id="L408">		}</span>

		public void uninstall()
		{
<span class="nc" id="L412">			equipmentSetTable.removeActionListener(this);</span>
<span class="nc" id="L413">		}</span>

	}

	public class EquipAction extends AbstractAction
	{

		public EquipAction()
<span class="nc" id="L421">		{</span>
<span class="nc" id="L422">			super(LanguageBundle.getString(&quot;in_equipEquipSel&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L423">			this.putValue(SMALL_ICON, Icons.Forward16.getImageIcon());</span>
<span class="nc" id="L424">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L429">			int[] selectedRows = equipmentTable.getSelectedRows();</span>
<span class="nc" id="L430">			MapToList&lt;EquipmentFacade, EquipNode&gt; equipMap = new HashMapToList&lt;&gt;();</span>
<span class="nc" id="L431">			EquipmentSetFacade equipSet = character.getEquipmentSetRef().get();</span>
<span class="nc" id="L432">			List&lt;EquipmentFacade&gt; equipment = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L434" title="All 2 branches missed.">			for (int selectedRow : selectedRows)</span>
			{
<span class="nc" id="L436">				EquipmentFacade equipmentFacade = selectedModel.getValue(selectedRow);</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">				for (EquipNode path : equipSet.getNodes())</span>
				{
<span class="nc bnc" id="L439" title="All 2 branches missed.">					if (equipSet.canEquip(path, equipmentFacade))</span>
					{
<span class="nc" id="L441">						equipMap.addToListFor(equipmentFacade, path);</span>
					}
<span class="nc" id="L443">				}</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">				if (equipMap.containsListFor(equipmentFacade))</span>
				{
<span class="nc" id="L446">					equipment.add(equipmentFacade);</span>
				}
			}
<span class="nc bnc" id="L449" title="All 2 branches missed.">			if (!equipment.isEmpty())</span>
			{
<span class="nc" id="L451">				Object[][] data = new Object[equipment.size()][3];</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">				for (int i = 0; i &lt; equipment.size(); i++)</span>
				{
<span class="nc" id="L454">					EquipmentFacade equipmentFacade = equipment.get(i);</span>
<span class="nc" id="L455">					data[i][0] = equipmentFacade;</span>
<span class="nc" id="L456">					data[i][1] = unequippedList.getQuantity(equipmentFacade);</span>
<span class="nc" id="L457">					data[i][2] = getInitialNode(equipMap, equipSet, equipmentFacade);</span>
				}
<span class="nc" id="L459">				Object[] columns = {LanguageBundle.getString(&quot;in_equipItem&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L460">					LanguageBundle.getString(&quot;in_equipQuantityAbbrev&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L461">					LanguageBundle.getString(&quot;in_equipContainer&quot;) //$NON-NLS-1$</span>
				};
<span class="nc" id="L463">				DefaultTableModel tableModel = new DefaultTableModel(data, columns)</span>
<span class="nc" id="L464">				{</span>

					@Override
					public Class&lt;?&gt; getColumnClass(int columnIndex)
					{
<span class="nc bnc" id="L469" title="All 2 branches missed.">						if (columnIndex == 1)</span>
						{
<span class="nc" id="L471">							return Integer.class;</span>
						}
<span class="nc" id="L473">						return Object.class;</span>
					}

					@Override
					public boolean isCellEditable(int row, int column)
					{
<span class="nc bnc" id="L479" title="All 2 branches missed.">						return column != 0;</span>
					}

				};
<span class="nc" id="L483">				JTable table = new JTable(tableModel);</span>
<span class="nc" id="L484">				table.setFocusable(false);</span>
<span class="nc" id="L485">				table.setCellSelectionEnabled(false);</span>
<span class="nc" id="L486">				table.setDefaultEditor(Object.class, new ComboEditor(equipMap));</span>
<span class="nc" id="L487">				table.setDefaultRenderer(Integer.class, new TableCellUtilities.SpinnerRenderer());</span>
<span class="nc" id="L488">				table.setDefaultEditor(Integer.class, new SpinnerEditor(unequippedList));</span>
<span class="nc" id="L489">				table.setRowHeight(22);</span>
<span class="nc" id="L490">				table.getColumnModel().getColumn(0).setPreferredWidth(140);</span>
<span class="nc" id="L491">				table.getColumnModel().getColumn(1).setPreferredWidth(50);</span>
<span class="nc" id="L492">				table.getColumnModel().getColumn(2).setPreferredWidth(120);</span>
<span class="nc" id="L493">				table.setPreferredScrollableViewportSize(table.getPreferredSize());</span>
<span class="nc" id="L494">				JTableHeader header = table.getTableHeader();</span>
<span class="nc" id="L495">				header.setReorderingAllowed(false);</span>
<span class="nc" id="L496">				JScrollPane pane = EquipmentModels.prepareScrollPane(table);</span>
<span class="nc" id="L497">				JPanel panel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L498">				JLabel help = new JLabel(LanguageBundle.getString(&quot;in_equipSelectQtyLoc&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L499">				panel.add(help, BorderLayout.NORTH);</span>
<span class="nc" id="L500">				panel.add(pane, BorderLayout.CENTER);</span>
<span class="nc" id="L501">				int res = JOptionPane.showConfirmDialog(JOptionPane.getFrameForComponent(equipmentTable), panel,</span>
<span class="nc" id="L502">					LanguageBundle.getString(&quot;in_equipEquipSel&quot;), //$NON-NLS-1$</span>
					JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

<span class="nc bnc" id="L505" title="All 2 branches missed.">				if (res == JOptionPane.OK_OPTION)</span>
				{
<span class="nc bnc" id="L507" title="All 2 branches missed.">					for (int i = 0; i &lt; equipment.size(); i++)</span>
					{
<span class="nc" id="L509">						EquipNode path = (EquipNode) tableModel.getValueAt(i, 2);</span>
<span class="nc" id="L510">						equipSet.addEquipment(path, equipment.get(i), (Integer) tableModel.getValueAt(i, 1));</span>
					}
				}
			}
<span class="nc" id="L514">		}</span>

		private EquipNode getInitialNode(MapToList&lt;EquipmentFacade, EquipNode&gt; equipMap, EquipmentSetFacade equipSet,
			EquipmentFacade equipmentFacade)
		{
			// First see if the user has selected a suitable node in the equipped tree
<span class="nc" id="L520">			List&lt;EquipNode&gt; possibleNodeList = equipMap.getListFor(equipmentFacade);</span>
<span class="nc" id="L521">			int[] rows = equipmentSetTable.getSelectedRows();</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">			for (int row : rows)</span>
			{
<span class="nc" id="L524">				EquipNode path = (EquipNode) equipmentSetTable.getValueAt(row, 0);</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">				if (possibleNodeList.contains(path))</span>
				{
<span class="nc" id="L527">					return path;</span>
				}
			}

			// Check if the preferred location can be found in the list
<span class="nc" id="L532">			String preferredNodeName = equipSet.getPreferredLoc(equipmentFacade);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">			for (EquipNode node : possibleNodeList)</span>
			{
<span class="nc bnc" id="L535" title="All 2 branches missed.">				if (preferredNodeName.equals(node.toString()))</span>
				{
<span class="nc" id="L537">					return node;</span>
				}
<span class="nc" id="L539">			}</span>

			// Fall back to the first item in the list
<span class="nc" id="L542">			return equipMap.getElementInList(equipmentFacade, 0);</span>
		}

		public void install()
		{
<span class="nc" id="L547">			equipmentTable.addActionListener(this);</span>
<span class="nc" id="L548">		}</span>

		public void uninstall()
		{
<span class="nc" id="L552">			equipmentTable.removeActionListener(this);</span>
<span class="nc" id="L553">		}</span>

	}

	private static class SpinnerEditor extends AbstractCellEditor implements TableCellEditor, ChangeListener
	{

<span class="nc" id="L560">		private JSpinner spinner = new JSpinner();</span>
		private final EquipmentListFacade equipmentList;

		public SpinnerEditor(EquipmentListFacade equipmentList)
<span class="nc" id="L564">		{</span>
<span class="nc" id="L565">			this.equipmentList = equipmentList;</span>
<span class="nc" id="L566">			spinner.addChangeListener(this);</span>
<span class="nc" id="L567">		}</span>

		@Override
		public Object getCellEditorValue()
		{
<span class="nc" id="L572">			return spinner.getValue();</span>
		}

		@Override
		public Component getTableCellEditorComponent(JTable table, Object value, boolean isSelected, int row,
			int column)
		{
<span class="nc" id="L579">			EquipmentFacade equipment = (EquipmentFacade) table.getValueAt(row, 0);</span>
<span class="nc" id="L580">			int maxQuantity = equipmentList.getQuantity(equipment);</span>
<span class="nc" id="L581">			int minQuantity = 1;</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">			if (maxQuantity &lt;= 0)</span>
			{
<span class="nc" id="L584">				minQuantity = maxQuantity = 0;</span>
			}
<span class="nc" id="L586">			SpinnerNumberModel model =</span>
<span class="nc" id="L587">					new SpinnerNumberModel(((Integer) value).intValue(), minQuantity, maxQuantity, 1);</span>
<span class="nc" id="L588">			spinner.setModel(model);</span>
<span class="nc" id="L589">			return spinner;</span>
		}

		@Override
		public void stateChanged(ChangeEvent e)
		{
<span class="nc" id="L595">			stopCellEditing();</span>
<span class="nc" id="L596">		}</span>

		@Override
		public boolean stopCellEditing()
		{
			try
			{
<span class="nc" id="L603">				spinner.commitEdit();</span>
			}
<span class="nc" id="L605">			catch (ParseException ex)</span>
			{
				// Fall through and cancel the edit.
<span class="nc" id="L608">			}</span>
<span class="nc" id="L609">			return super.stopCellEditing();</span>
		}

	}

	private static class ComboEditor extends AbstractCellEditor implements TableCellEditor, ActionListener
	{

<span class="nc" id="L617">		private JComboBox comboBox = null;</span>
		private MapToList&lt;EquipmentFacade, EquipNode&gt; equipMap;

		public ComboEditor(MapToList&lt;EquipmentFacade, EquipNode&gt; equipMap)
<span class="nc" id="L621">		{</span>
<span class="nc" id="L622">			this.equipMap = equipMap;</span>
<span class="nc" id="L623">		}</span>

		@Override
		public Object getCellEditorValue()
		{
<span class="nc" id="L628">			return comboBox.getSelectedItem();</span>
		}

		@Override
		public Component getTableCellEditorComponent(JTable table, Object value, boolean isSelected, int row,
			int column)
		{
<span class="nc" id="L635">			EquipmentFacade equipment = (EquipmentFacade) table.getValueAt(row, 0);</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">			if (comboBox != null)</span>
			{
<span class="nc" id="L638">				comboBox.removeActionListener(this);</span>
			}
<span class="nc" id="L640">			comboBox = new JComboBox&lt;&gt;(equipMap.getListFor(equipment).toArray());</span>
<span class="nc" id="L641">			comboBox.setSelectedItem(value);</span>
<span class="nc" id="L642">			comboBox.addActionListener(this);</span>
<span class="nc" id="L643">			return comboBox;</span>
		}

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L649">			stopCellEditing();</span>
<span class="nc" id="L650">		}</span>

	}

	private class MoveUpAction extends AbstractAction
	{

		public MoveUpAction()
<span class="nc" id="L658">		{</span>
<span class="nc" id="L659">			super(LanguageBundle.getString(&quot;in_equipMoveUpMenuCommand&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L660">			this.putValue(SMALL_ICON, Icons.Up16.getImageIcon());</span>
<span class="nc" id="L661">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L666">			EquipmentSetFacade equipSet = character.getEquipmentSetRef().get();</span>
<span class="nc" id="L667">			List&lt;EquipNode&gt; paths = getSelectedEquipmentSetNodes();</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">			if (!paths.isEmpty())</span>
			{
<span class="nc bnc" id="L670" title="All 2 branches missed.">				for (EquipNode node : paths)</span>
				{
<span class="nc" id="L672">					equipSet.moveEquipment(node, -1);</span>
<span class="nc" id="L673">				}</span>
<span class="nc" id="L674">				selectNodeInEquipmentSetTable(paths.get(0));</span>
			}
<span class="nc" id="L676">		}</span>

		public void install()
		{
<span class="nc" id="L680">			equipmentSetTable.addActionListener(this);</span>
<span class="nc" id="L681">		}</span>

		public void uninstall()
		{
<span class="nc" id="L685">			equipmentSetTable.removeActionListener(this);</span>
<span class="nc" id="L686">		}</span>

	}

	private class MoveDownAction extends AbstractAction
	{

		public MoveDownAction()
<span class="nc" id="L694">		{</span>
<span class="nc" id="L695">			super(LanguageBundle.getString(&quot;in_equipMoveDownMenuCommand&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L696">			this.putValue(SMALL_ICON, Icons.Down16.getImageIcon());</span>
<span class="nc" id="L697">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L702">			EquipmentSetFacade equipSet = character.getEquipmentSetRef().get();</span>
<span class="nc" id="L703">			List&lt;EquipNode&gt; paths = getSelectedEquipmentSetNodes();</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">			if (!paths.isEmpty())</span>
			{
<span class="nc bnc" id="L706" title="All 2 branches missed.">				for (EquipNode node : paths)</span>
				{
<span class="nc" id="L708">					equipSet.moveEquipment(node, 1);</span>
<span class="nc" id="L709">				}</span>
<span class="nc" id="L710">				selectNodeInEquipmentSetTable(paths.get(0));</span>
			}
<span class="nc" id="L712">		}</span>

		public void install()
		{
<span class="nc" id="L716">			equipmentSetTable.addActionListener(this);</span>
<span class="nc" id="L717">		}</span>

		public void uninstall()
		{
<span class="nc" id="L721">			equipmentSetTable.removeActionListener(this);</span>
<span class="nc" id="L722">		}</span>

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>