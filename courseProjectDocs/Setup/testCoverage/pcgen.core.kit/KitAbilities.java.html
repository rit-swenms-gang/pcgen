<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KitAbilities.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.core.kit</a> &gt; <span class="el_source">KitAbilities.java</span></div><h1>KitAbilities.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2005 (C) Andrew Wilson &lt;nuance@sourceforge.net&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.core.kit;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Set;
import java.util.TreeSet;

import pcgen.cdom.base.CDOMReference;
import pcgen.cdom.base.UserSelection;
import pcgen.cdom.content.CNAbility;
import pcgen.cdom.content.CNAbilityFactory;
import pcgen.cdom.enumeration.Nature;
import pcgen.cdom.enumeration.ObjectKey;
import pcgen.cdom.helper.CNAbilitySelection;
import pcgen.cdom.reference.CDOMSingleRef;
import pcgen.cdom.reference.ReferenceUtilities;
import pcgen.core.Ability;
import pcgen.core.AbilityCategory;
import pcgen.core.Globals;
import pcgen.core.Kit;
import pcgen.core.PlayerCharacter;

/**
 * {@code KitAbiltiies}.
 */
<span class="fc" id="L45">public final class KitAbilities extends BaseKit</span>
{
<span class="fc" id="L47">	private Boolean free = null;</span>
	private Integer choiceCount;
<span class="fc" id="L49">	private List&lt;CDOMReference&lt;Ability&gt;&gt; abilities = new ArrayList&lt;&gt;();</span>

	// These members store the state of an instance of this class.  They are
	// not cloned.
<span class="fc" id="L53">	private List&lt;CNAbilitySelection&gt; abilitiesToAdd = null;</span>
	private CDOMSingleRef&lt;AbilityCategory&gt; catRef;

	/**
	 * Set whether the kit is free.
	 *
	 * @param  argFree  true if the kit is free
	 */
	public void setFree(Boolean argFree)
	{
<span class="fc" id="L63">		free = argFree;</span>
<span class="fc" id="L64">	}</span>

	@Override
	public String toString()
	{
<span class="nc" id="L69">		StringBuilder sb = new StringBuilder();</span>

<span class="nc bnc" id="L71" title="All 4 branches missed.">		if ((choiceCount != null) || (abilities.size() != 1))</span>
		{
<span class="nc" id="L73">			sb.append(getSafeCount()).append(&quot; of &quot;);</span>
		}

<span class="nc" id="L76">		boolean firstDone = false;</span>

<span class="nc bnc" id="L78" title="All 2 branches missed.">		for (CDOMReference&lt;Ability&gt; ref : abilities)</span>
		{
<span class="nc bnc" id="L80" title="All 2 branches missed.">			if (firstDone)</span>
			{
<span class="nc" id="L82">				sb.append(&quot;; &quot;);</span>
			}
<span class="nc" id="L84">			firstDone = true;</span>

<span class="nc" id="L86">			String choice = ref.getChoice();</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">			for (Ability a : ref.getContainedObjects())</span>
			{
<span class="nc bnc" id="L89" title="All 2 branches missed.">				if (a != null)</span>
				{
<span class="nc" id="L91">					sb.append(a.getKeyName());</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">					if (choice != null)</span>
					{
<span class="nc" id="L94">						sb.append(&quot; (&quot;);</span>
<span class="nc" id="L95">						sb.append(choice);</span>
<span class="nc" id="L96">						sb.append(')');</span>
					}
				}
<span class="nc" id="L99">			}</span>
<span class="nc" id="L100">		}</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">		if (isFree())</span>
		{
<span class="nc" id="L104">			sb.append(&quot; (free)&quot;);</span>
		}

<span class="nc" id="L107">		return sb.toString();</span>
	}

	@Override
	public boolean testApply(Kit aKit, PlayerCharacter aPC, List&lt;String&gt; warnings)
	{
<span class="nc" id="L113">		abilitiesToAdd = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L114">		double minCost = Double.MAX_VALUE;</span>
<span class="nc" id="L115">		List&lt;AbilitySelection&gt; available = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">		for (CDOMReference&lt;Ability&gt; ref : abilities)</span>
		{
<span class="nc" id="L118">			String choice = ref.getChoice();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">			for (Ability a : ref.getContainedObjects())</span>
			{
<span class="nc bnc" id="L121" title="All 2 branches missed.">				if (a == null)</span>
				{
<span class="nc" id="L123">					warnings.add(&quot;ABILITY: &quot; + ref + &quot; could not be found.&quot;);</span>
<span class="nc" id="L124">					minCost = 0;</span>
<span class="nc" id="L125">					continue;</span>
				}

<span class="nc bnc" id="L128" title="All 2 branches missed.">				if (a.getCost() &lt; minCost)</span>
				{
<span class="nc" id="L130">					minCost = a.getCost();</span>
				}
<span class="nc bnc" id="L132" title="All 4 branches missed.">				if ((choice == null) &amp;&amp; a.getSafe(ObjectKey.MULTIPLE_ALLOWED))</span>
				{
<span class="nc" id="L134">					available.add(new AbilitySelection(a, &quot;&quot;));</span>
				}
				else
				{
<span class="nc" id="L138">					available.add(new AbilitySelection(a, choice));</span>
				}
<span class="nc" id="L140">			}</span>
<span class="nc" id="L141">		}</span>

<span class="nc" id="L143">		int numberOfChoices = getSafeCount();</span>
		// Can't choose more entries than there are...
		// TODO this fails if SELECT != 1
<span class="nc bnc" id="L146" title="All 2 branches missed.">		if (numberOfChoices &gt; available.size())</span>
		{
<span class="nc" id="L148">			numberOfChoices = available.size();</span>
		}

		/*
		 * this section needs to be rewritten once we determine how
		 * the new Ability Pools are going to work
		 */

<span class="nc" id="L156">		AbilityCategory category = catRef.get();</span>
<span class="nc" id="L157">		boolean tooManyAbilities = false;</span>
		// Don't allow choosing of more than allotted number of abilities
<span class="nc bnc" id="L159" title="All 2 branches missed.">		int maxChoices = minCost &gt; 0.0d</span>
<span class="nc" id="L160">			? aPC.getAvailableAbilityPool(category).divide(new BigDecimal(String.valueOf(minCost))).intValue()</span>
<span class="nc" id="L161">				: numberOfChoices;</span>
<span class="nc bnc" id="L162" title="All 4 branches missed.">		if (!isFree() &amp;&amp; numberOfChoices &gt; maxChoices)</span>
		{
<span class="nc" id="L164">			numberOfChoices = maxChoices;</span>
<span class="nc" id="L165">			tooManyAbilities = true;</span>
		}

<span class="nc bnc" id="L168" title="All 4 branches missed.">		if (!isFree() &amp;&amp; numberOfChoices == 0)</span>
		{
<span class="nc" id="L170">			warnings.add(&quot;ABILITY: Not enough &quot; + category.getPluralName() + &quot; available to take \&quot;&quot; + this + &quot;\&quot;&quot;);</span>
<span class="nc" id="L171">			return false;</span>
		}

		List&lt;AbilitySelection&gt; selected;

<span class="nc bnc" id="L176" title="All 2 branches missed.">		if (numberOfChoices == available.size())</span>
		{
<span class="nc" id="L178">			selected = available;</span>
		}
		else
		{
			// Force user to make enough selections
			while (true)
			{
<span class="nc" id="L185">				selected = Globals.getChoiceFromList(&quot;Choose abilities&quot;, available, new ArrayList&lt;&gt;(), numberOfChoices,</span>
					aPC);

<span class="nc bnc" id="L188" title="All 2 branches missed.">				if (!selected.isEmpty())</span>
				{
<span class="nc" id="L190">					break;</span>
				}
			}
		}

		// Add to list of things to add to the character
<span class="nc bnc" id="L196" title="All 2 branches missed.">		for (AbilitySelection as : selected)</span>
		{
<span class="nc" id="L198">			Ability ability = as.ability;</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">			if (isFree())</span>
			{
				// Need to pay for it first
<span class="nc" id="L202">                aPC.adjustAbilities(category, BigDecimal.ONE);</span>
            }
<span class="nc bnc" id="L204" title="All 2 branches missed.">			if (ability.getCost() &gt; aPC.getAvailableAbilityPool(category).doubleValue())</span>
			{
<span class="nc" id="L206">				tooManyAbilities = true;</span>
			}
			else
			{
<span class="nc" id="L210">				CNAbility cna = CNAbilityFactory.getCNAbility(category, Nature.NORMAL, ability);</span>
<span class="nc" id="L211">				CNAbilitySelection cnas = new CNAbilitySelection(cna, as.selection);</span>
<span class="nc" id="L212">				abilitiesToAdd.add(cnas);</span>
<span class="nc" id="L213">				aPC.addAbility(cnas, UserSelection.getInstance(), this);</span>
			}
<span class="nc" id="L215">		}</span>

<span class="nc bnc" id="L217" title="All 2 branches missed.">		if (tooManyAbilities)</span>
		{
<span class="nc" id="L219">			warnings.add(&quot;ABILITY: Some Abilities were not granted -- not enough remaining feats&quot;);</span>
<span class="nc" id="L220">			return false;</span>
		}

<span class="nc" id="L223">		return true;</span>
	}

	@Override
	public void apply(PlayerCharacter aPC)
	{
<span class="nc bnc" id="L229" title="All 2 branches missed.">		for (CNAbilitySelection cnas : abilitiesToAdd)</span>
		{
<span class="nc" id="L231">			aPC.addAbility(cnas, UserSelection.getInstance(), UserSelection.getInstance());</span>

<span class="nc bnc" id="L233" title="All 2 branches missed.">			if (isFree())</span>
			{
<span class="nc" id="L235">				AbilityCategory category = catRef.get();</span>
<span class="nc" id="L236">				aPC.adjustAbilities(category, BigDecimal.ONE);</span>
			}
<span class="nc" id="L238">		}</span>
<span class="nc" id="L239">	}</span>

	/**
	 * Returns if the skill will be purchased for free.
	 * @return {@code true} if the skill will be free
	 */
	public boolean isFree()
	{
<span class="nc bnc" id="L247" title="All 4 branches missed.">		return free != null &amp;&amp; free;</span>
	}

	@Override
	public String getObjectName()
	{
<span class="nc" id="L253">		return &quot;Abilities&quot;;</span>
	}

	public Boolean getFree()
	{
<span class="fc" id="L258">		return free;</span>
	}

	public void setCount(Integer quan)
	{
<span class="fc" id="L263">		choiceCount = quan;</span>
<span class="fc" id="L264">	}</span>

	public Integer getCount()
	{
<span class="fc" id="L268">		return choiceCount;</span>
	}

	public int getSafeCount()
	{
<span class="nc bnc" id="L273" title="All 2 branches missed.">		return choiceCount == null ? 1 : choiceCount;</span>
	}

	public void addAbility(CDOMReference&lt;Ability&gt; ref)
	{
<span class="fc" id="L278">		abilities.add(ref);</span>
<span class="fc" id="L279">	}</span>

	public Collection&lt;CDOMReference&lt;Ability&gt;&gt; getAbilityKeys()
	{
<span class="fc" id="L283">		Set&lt;CDOMReference&lt;Ability&gt;&gt; wc = new TreeSet&lt;&gt;(ReferenceUtilities.REFERENCE_SORTER);</span>
<span class="fc" id="L284">		wc.addAll(abilities);</span>
<span class="fc" id="L285">		return wc;</span>
	}

	private static class AbilitySelection implements Comparable&lt;AbilitySelection&gt;
	{
		public final Ability ability;
		public final String selection;

		public AbilitySelection(Ability a, String sel)
<span class="nc" id="L294">		{</span>
<span class="nc" id="L295">			ability = a;</span>
<span class="nc" id="L296">			selection = sel;</span>
<span class="nc" id="L297">		}</span>

		@Override
		public String toString()
		{
<span class="nc" id="L302">			StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L303">			sb.append(ability.getDisplayName());</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">			if (selection != null)</span>
			{
<span class="nc" id="L306">				sb.append(&quot; (&quot;).append(selection).append(')');</span>
			}
<span class="nc" id="L308">			return sb.toString();</span>
		}

		@Override
		public int compareTo(AbilitySelection o)
		{
<span class="nc" id="L314">			int base = ability.compareTo(o.ability);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">			if (base != 0)</span>
			{
<span class="nc" id="L317">				return base;</span>
			}
<span class="nc bnc" id="L319" title="All 2 branches missed.">			if (selection == null)</span>
			{
<span class="nc bnc" id="L321" title="All 2 branches missed.">				return o.selection == null ? 0 : -1;</span>
			}
<span class="nc bnc" id="L323" title="All 2 branches missed.">			return o.selection == null ? 1 : selection.compareToIgnoreCase(o.selection);</span>
		}
	}

	public void setCategory(CDOMSingleRef&lt;AbilityCategory&gt; ac)
	{
<span class="fc" id="L329">		catRef = ac;</span>
<span class="fc" id="L330">	}</span>

	public CDOMSingleRef&lt;AbilityCategory&gt; getCategory()
	{
<span class="fc" id="L334">		return catRef;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>