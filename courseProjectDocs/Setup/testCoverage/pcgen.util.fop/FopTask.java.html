<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FopTask.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.util.fop</a> &gt; <span class="el_source">FopTask.java</span></div><h1>FopTask.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2016 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 * 
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 * 
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 * 
 */
package pcgen.util.fop;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.util.Date;

import javax.xml.transform.ErrorListener;
import javax.xml.transform.SourceLocator;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.sax.SAXResult;
import javax.xml.transform.stream.StreamSource;

import pcgen.cdom.base.Constants;
import pcgen.system.ConfigurationSettings;
import pcgen.util.Logging;

import org.apache.fop.apps.FOPException;
import org.apache.fop.apps.FOUserAgent;
import org.apache.fop.apps.Fop;
import org.apache.fop.apps.FopConfParser;
import org.apache.fop.apps.FopFactory;
import org.apache.fop.apps.FopFactoryBuilder;
import org.apache.fop.apps.MimeConstants;
import org.apache.fop.events.Event;
import org.apache.fop.events.EventFormatter;
import org.apache.fop.events.EventListener;
import org.apache.fop.events.model.EventSeverity;
import org.apache.fop.render.Renderer;

/**
 * This class is used to generate pdf files from an xml source. There are two ways to define the
 * source of the task: files or inputstreams. The output of this task can either be an OutputStream
 * which you can point to a file, or a Renderer. The Renderer is used by print preview and for
 * direct printing.
 */
public final class FopTask implements Runnable
{
<span class="nc" id="L63">	private static final FopFactory FOP_FACTORY = createFopFactory();</span>
	private static FOUserAgent userAgent;

<span class="nc" id="L66">	private static final TransformerFactory TRANS_FACTORY = TransformerFactory.newInstance();</span>

	private static FopFactory createFopFactory()
	{

		// Allow optional customization with configuration file
<span class="nc" id="L72">		String configPath = ConfigurationSettings.getOutputSheetsDir() + File.separator + &quot;fop.xconf&quot;;</span>
<span class="nc" id="L73">		Logging.log(Logging.INFO, &quot;FoPTask checking for config file at &quot; + configPath);</span>
<span class="nc" id="L74">		File userConfigFile = new File(configPath);</span>
		FopFactoryBuilder builder;
<span class="nc bnc" id="L76" title="All 2 branches missed.">		if (userConfigFile.exists())</span>
		{
<span class="nc" id="L78">			Logging.log(Logging.INFO, &quot;FoPTask using config file &quot; + configPath);</span>
			FopConfParser parser;
			try
			{
<span class="nc" id="L82">				parser = new FopConfParser(userConfigFile);</span>
			}
<span class="nc" id="L84">			catch (Exception e)</span>
			{
<span class="nc" id="L86">				Logging.errorPrint(&quot;FoPTask encountered a problem with FOP configuration &quot; + configPath + &quot;: &quot;, e);</span>
<span class="nc" id="L87">				return null;</span>
<span class="nc" id="L88">			}</span>
<span class="nc" id="L89">			builder = parser.getFopFactoryBuilder();</span>
<span class="nc" id="L90">		}</span>
		else
		{
<span class="nc" id="L93">			Logging.log(Logging.INFO, &quot;FoPTask using default config&quot;);</span>
<span class="nc" id="L94">			builder = new FopFactoryBuilder(new File(&quot;.&quot;).toURI());</span>
<span class="nc" id="L95">			builder.setStrictFOValidation(false);</span>
		}
<span class="nc" id="L97">		return builder.build();</span>
	}

	private final StreamSource inputSource;
	private final StreamSource xsltSource;
	private final Renderer renderer;
	private final OutputStream outputStream;

<span class="nc" id="L105">	private final StringBuilder errorBuilder = new StringBuilder(32);</span>

	private FopTask(StreamSource inputXml, StreamSource xsltSource, Renderer renderer, OutputStream outputStream)
<span class="nc" id="L108">	{</span>
<span class="nc" id="L109">		this.inputSource = inputXml;</span>
<span class="nc" id="L110">		this.xsltSource = xsltSource;</span>
<span class="nc" id="L111">		this.renderer = renderer;</span>
<span class="nc" id="L112">		this.outputStream = outputStream;</span>
<span class="nc" id="L113">	}</span>

	private static StreamSource createXsltStreamSource(File xsltFile) throws FileNotFoundException
	{
<span class="nc bnc" id="L117" title="All 2 branches missed.">		if (xsltFile == null)</span>
		{
<span class="nc" id="L119">			return null;</span>
		}
<span class="nc bnc" id="L121" title="All 2 branches missed.">		if (!xsltFile.exists())</span>
		{
<span class="nc" id="L123">			throw new FileNotFoundException(&quot;xsl file &quot; + xsltFile.getAbsolutePath() + &quot; not found &quot;);</span>
		}
<span class="nc" id="L125">		return new StreamSource(xsltFile);</span>
	}

	public static FopFactory getFactory()
	{
<span class="nc" id="L130">		return FOP_FACTORY;</span>
	}

	/**
	 * Creates a new FopTask that transforms the input stream using the given xsltFile and outputs a
	 * pdf document to the given output stream. The output can be saved to a file if a
	 * FileOutputStream is used.
	 *
	 * @param inputXmlStream the fop xml input stream
	 * @param xsltFile the transform template file, if null then the identity transformer is used
	 * @param outputPdf output stream for pdf document
	 * @return a FopTask to be executed
	 * @throws FileNotFoundException if xsltFile is not null and does not exist
	 */
	public static FopTask newFopTask(InputStream inputXmlStream, File xsltFile, OutputStream outputPdf)
		throws FileNotFoundException
	{
<span class="nc" id="L147">		StreamSource xsltSource = createXsltStreamSource(xsltFile);</span>
<span class="nc" id="L148">		userAgent = FOP_FACTORY.newFOUserAgent();</span>
<span class="nc" id="L149">		return new FopTask(new StreamSource(inputXmlStream), xsltSource, null, outputPdf);</span>
	}

	/**
	 * Creates a new FopTask that transforms the input stream using the given xsltFile and outputs a
	 * pdf document to the given Renderer. This task can be used for both previewing a pdf
	 * document as well as printing a pdf
	 *
	 * @param inputXmlStream the fop xml input stream
	 * @param xsltFile the transform template file, if null then the identity transformer is used
	 * @param renderer the Renderer to output a pdf document to.
	 * @return a FopTask to be executed
	 * @throws FileNotFoundException if xsltFile is not null and does not exist
	 */
	public static FopTask newFopTask(InputStream inputXmlStream, File xsltFile, Renderer renderer)
		throws FileNotFoundException
	{
<span class="nc" id="L166">		StreamSource xsltSource = createXsltStreamSource(xsltFile);</span>
<span class="nc" id="L167">		userAgent = renderer.getUserAgent();</span>
<span class="nc" id="L168">		return new FopTask(new StreamSource(inputXmlStream), xsltSource, renderer, null);</span>
	}

	public String getErrorMessages()
	{
<span class="nc" id="L173">		return errorBuilder.toString();</span>
	}

	/**
	 * Run the FO to PDF/AWT conversion. This automatically closes any provided OutputStream for
	 * this FopTask.
	 */
	@Override
	public void run()
	{
<span class="nc" id="L183">		try (OutputStream out = outputStream)</span>
		{
<span class="nc" id="L185">			userAgent.setProducer(&quot;PC Gen Character Generator&quot;);</span>
<span class="nc" id="L186">			userAgent.setAuthor(System.getProperty(&quot;user.name&quot;));</span>
<span class="nc" id="L187">			userAgent.setCreationDate(Date.from(LocalDateTime.now().toInstant(ZoneOffset.ofHours(0))));</span>

<span class="nc" id="L189">			userAgent.getEventBroadcaster().addEventListener(new FOPEventListener());</span>

			String mimeType;
<span class="nc bnc" id="L192" title="All 2 branches missed.">			if (renderer != null)</span>
			{
<span class="nc" id="L194">				userAgent.setKeywords(&quot;PCGEN FOP PREVIEW&quot;);</span>
<span class="nc" id="L195">				mimeType = MimeConstants.MIME_FOP_AWT_PREVIEW;</span>
			}
			else
			{
<span class="nc" id="L199">				userAgent.setKeywords(&quot;PCGEN FOP PDF&quot;);</span>
<span class="nc" id="L200">				mimeType = org.apache.xmlgraphics.util.MimeConstants.MIME_PDF;</span>
			}
			Fop fop;
<span class="nc bnc" id="L203" title="All 2 branches missed.">			if (out != null)</span>
			{
<span class="nc" id="L205">				fop = FOP_FACTORY.newFop(mimeType, userAgent, out);</span>
			}
			else
			{
<span class="nc" id="L209">				fop = FOP_FACTORY.newFop(mimeType, userAgent);</span>
			}

			Transformer transformer;
<span class="nc bnc" id="L213" title="All 2 branches missed.">			if (xsltSource != null)</span>
			{
<span class="nc" id="L215">				transformer = TRANS_FACTORY.newTransformer(xsltSource);</span>
			}
			else
			{
<span class="nc" id="L219">				transformer = TRANS_FACTORY.newTransformer(); // identity transformer		</span>
			}
<span class="nc" id="L221">			transformer.setErrorListener(new FOPErrorListener());</span>
<span class="nc" id="L222">			transformer.transform(inputSource, new SAXResult(fop.getDefaultHandler()));</span>
		}
<span class="nc" id="L224">		catch (TransformerException | FOPException | IOException e)</span>
		{
<span class="nc" id="L226">			errorBuilder.append(e.getMessage()).append(Constants.LINE_SEPARATOR);</span>
<span class="nc" id="L227">			Logging.errorPrint(&quot;Exception in FopTask:run&quot;, e);</span>
		}
<span class="nc" id="L229">		catch (RuntimeException ex)</span>
		{
<span class="nc" id="L231">			errorBuilder.append(ex.getMessage()).append(Constants.LINE_SEPARATOR);</span>
<span class="nc" id="L232">			Logging.errorPrint(&quot;Unexpected exception in FopTask:run: &quot;, ex);</span>
<span class="nc" id="L233">		}</span>
<span class="nc" id="L234">	}</span>

	/**
	 * The Class {@code FOPErrorListener} listens for notifications of issues when generating
	 * PDF files and responds accordingly.
	 */
	private static class FOPErrorListener implements ErrorListener
	{

		@Override
		public void error(TransformerException exception) throws TransformerException
		{
<span class="nc" id="L246">			SourceLocator locator = exception.getLocator();</span>
<span class="nc" id="L247">			Logging.errorPrint(&quot;FOP Error &quot; + exception.getMessage() + &quot; at &quot; + getLocation(locator));</span>
<span class="nc" id="L248">			throw exception;</span>
		}

		@Override
		public void fatalError(TransformerException exception) throws TransformerException
		{
<span class="nc" id="L254">			SourceLocator locator = exception.getLocator();</span>
<span class="nc" id="L255">			Logging.errorPrint(&quot;FOP Fatal Error &quot; + exception.getMessage() + &quot; at &quot; + getLocation(locator));</span>
<span class="nc" id="L256">			throw exception;</span>
		}

		@Override
		public void warning(TransformerException exception)
		{
<span class="nc" id="L262">			SourceLocator locator = exception.getLocator();</span>
<span class="nc" id="L263">			Logging.log(Logging.WARNING, getLocation(locator) + exception.getMessage());</span>
<span class="nc" id="L264">		}</span>

		private static String getLocation(SourceLocator locator)
		{
<span class="nc bnc" id="L268" title="All 2 branches missed.">			if (locator == null)</span>
			{
<span class="nc" id="L270">				return &quot;Unknown; &quot;;</span>
			}
<span class="nc" id="L272">			StringBuilder builder = new StringBuilder();</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">			if (locator.getSystemId() != null)</span>
			{
<span class="nc" id="L275">				builder.append(locator.getSystemId());</span>
<span class="nc" id="L276">				builder.append(&quot;; &quot;);</span>
			}
<span class="nc bnc" id="L278" title="All 2 branches missed.">			if (locator.getLineNumber() &gt; -1)</span>
			{
<span class="nc" id="L280">				builder.append(&quot;Line#: &quot;);</span>
<span class="nc" id="L281">				builder.append(locator.getLineNumber());</span>
<span class="nc" id="L282">				builder.append(&quot;; &quot;);</span>
			}
<span class="nc bnc" id="L284" title="All 2 branches missed.">			if (locator.getColumnNumber() &gt; -1)</span>
			{
<span class="nc" id="L286">				builder.append(&quot;Column#: &quot;);</span>
<span class="nc" id="L287">				builder.append(locator.getColumnNumber());</span>
<span class="nc" id="L288">				builder.append(&quot;; &quot;);</span>
			}
<span class="nc" id="L290">			return builder.toString();</span>
		}

	}

<span class="nc" id="L295">	private static class FOPEventListener implements EventListener</span>
	{
		/**
		 * @{inheritdoc}
		 */
		@Override
		public void processEvent(final Event event)
		{
<span class="nc" id="L303">			String msg = &quot;[FOP] &quot; + EventFormatter.format(event);</span>

			// filter out some erroneous FOP warnings about not finding internal fonts
			// this is an ancient, but still unfixed FOP bug
			// see https://issues.apache.org/jira/browse/FOP-1667
<span class="nc bnc" id="L308" title="All 6 branches missed.">			if (msg.contains(&quot;not found&quot;) &amp;&amp; (msg.contains(&quot;Symbol,normal&quot;) || msg.contains(&quot;ZapfDingbats,normal&quot;)))</span>
			{
<span class="nc" id="L310">				return;</span>
			}

<span class="nc" id="L313">			EventSeverity severity = event.getSeverity();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">			if (severity == EventSeverity.INFO)</span>
			{
<span class="nc" id="L316">				Logging.log(Logging.INFO, msg);</span>
			}
<span class="nc bnc" id="L318" title="All 2 branches missed.">			else if (severity == EventSeverity.WARN)</span>
			{
<span class="nc" id="L320">				Logging.log(Logging.WARNING, msg);</span>
			}
<span class="nc bnc" id="L322" title="All 4 branches missed.">			else if (severity == EventSeverity.ERROR || severity == EventSeverity.FATAL)</span>
			{
<span class="nc" id="L324">				Logging.log(Logging.ERROR, msg);</span>
			}
			else
			{
<span class="nc" id="L328">				assert false;</span>
			}
<span class="nc" id="L330">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>