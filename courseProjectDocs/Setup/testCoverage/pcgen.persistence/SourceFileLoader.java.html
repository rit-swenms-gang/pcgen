<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SourceFileLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.persistence</a> &gt; <span class="el_source">SourceFileLoader.java</span></div><h1>SourceFileLoader.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2010 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 *
 */
package pcgen.persistence;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.net.URI;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashSet;
import java.util.List;
import java.util.Observable;
import java.util.Observer;
import java.util.Set;
import java.util.logging.Handler;
import java.util.logging.LogRecord;

import pcgen.base.formatmanager.FormatUtilities;
import pcgen.base.formula.base.LegalScope;
import pcgen.base.util.AbstractMapToList;
import pcgen.base.util.FormatManager;
import pcgen.base.util.HashMapToList;
import pcgen.cdom.base.Constants;
import pcgen.cdom.content.fact.FactDefinition;
import pcgen.cdom.content.factset.FactSetDefinition;
import pcgen.cdom.enumeration.IntegerKey;
import pcgen.cdom.enumeration.ListKey;
import pcgen.cdom.enumeration.MapKey;
import pcgen.cdom.enumeration.ObjectKey;
import pcgen.cdom.enumeration.SourceFormat;
import pcgen.cdom.enumeration.StringKey;
import pcgen.cdom.enumeration.Type;
import pcgen.cdom.formula.scope.EquipmentPartScope;
import pcgen.cdom.formula.scope.GlobalPCScope;
import pcgen.cdom.inst.GlobalModifiers;
import pcgen.cdom.util.CControl;
import pcgen.cdom.util.ControlUtilities;
import pcgen.core.Ability;
import pcgen.core.AbilityCategory;
import pcgen.core.ArmorProf;
import pcgen.core.Campaign;
import pcgen.core.CustomData;
import pcgen.core.DataSet;
import pcgen.core.Deity;
import pcgen.core.Description;
import pcgen.core.Domain;
import pcgen.core.Equipment;
import pcgen.core.EquipmentModifier;
import pcgen.core.GameMode;
import pcgen.core.Globals;
import pcgen.core.Kit;
import pcgen.core.Language;
import pcgen.core.PCAlignment;
import pcgen.core.PCCheck;
import pcgen.core.PCStat;
import pcgen.core.PCTemplate;
import pcgen.core.Race;
import pcgen.core.SettingsHandler;
import pcgen.core.ShieldProf;
import pcgen.core.SizeAdjustment;
import pcgen.core.Skill;
import pcgen.core.SystemCollections;
import pcgen.core.WeaponProf;
import pcgen.core.analysis.EqModAttachment;
import pcgen.core.analysis.RaceUtilities;
import pcgen.core.prereq.PrereqHandler;
import pcgen.core.prereq.Prerequisite;
import pcgen.core.spell.Spell;
import pcgen.facade.core.DataSetFacade;
import pcgen.facade.core.UIDelegate;
import pcgen.facade.util.DefaultListFacade;
import pcgen.facade.util.ListFacade;
import pcgen.io.PCGFile;
import pcgen.output.channel.ChannelUtilities;
import pcgen.persistence.lst.AbilityCategoryLoader;
import pcgen.persistence.lst.AbilityLoader;
import pcgen.persistence.lst.BioSetLoader;
import pcgen.persistence.lst.CampaignLoader;
import pcgen.persistence.lst.CampaignSourceEntry;
import pcgen.persistence.lst.CompanionModLoader;
import pcgen.persistence.lst.FeatLoader;
import pcgen.persistence.lst.GenericLoader;
import pcgen.persistence.lst.GenericLocalVariableLoader;
import pcgen.persistence.lst.GlobalModifierLoader;
import pcgen.persistence.lst.KitLoader;
import pcgen.persistence.lst.LstFileLoader;
import pcgen.persistence.lst.LstLineFileLoader;
import pcgen.persistence.lst.LstObjectFileLoader;
import pcgen.persistence.lst.PCClassLoader;
import pcgen.persistence.lst.SourceEntry;
import pcgen.persistence.lst.VariableLoader;
import pcgen.rules.context.AbstractReferenceContext;
import pcgen.rules.context.LoadContext;
import pcgen.rules.context.LoadValidator;
import pcgen.rules.context.ReferenceContextUtilities;
import pcgen.rules.context.VariableContext;
import pcgen.rules.persistence.CDOMControlLoader;
import pcgen.rules.persistence.DynamicLoader;
import pcgen.rules.persistence.TableLoader;
import pcgen.system.ConfigurationSettings;
import pcgen.system.LanguageBundle;
import pcgen.system.PCGenSettings;
import pcgen.system.PCGenTask;
import pcgen.util.Logging;

public class SourceFileLoader extends PCGenTask implements Observer
{

    /*
     * File lists
     */
<span class="nc" id="L129">    private final AbstractMapToList&lt;ListKey&lt;?&gt;, CampaignSourceEntry&gt; fileLists = new HashMapToList&lt;&gt;();</span>

    /*
     * Loaders
     */
<span class="nc" id="L134">    private final PCClassLoader classLoader = new PCClassLoader();</span>
<span class="nc" id="L135">    private final LstObjectFileLoader&lt;Language&gt; languageLoader = new GenericLoader&lt;&gt;(Language.class);</span>
<span class="nc" id="L136">    private final LstLineFileLoader abilityCategoryLoader = new AbilityCategoryLoader();</span>
<span class="nc" id="L137">    private final LstLineFileLoader companionModLoader = new CompanionModLoader();</span>
<span class="nc" id="L138">    private final LstObjectFileLoader&lt;Kit&gt; kitLoader = new KitLoader();</span>
<span class="nc" id="L139">    private final LstLineFileLoader bioLoader = new BioSetLoader();</span>
<span class="nc" id="L140">    private final LstObjectFileLoader&lt;Ability&gt; abilityLoader = new AbilityLoader();</span>
<span class="nc" id="L141">    private final LstObjectFileLoader&lt;Ability&gt; featLoader = new FeatLoader();</span>
<span class="nc" id="L142">    private final LstObjectFileLoader&lt;PCTemplate&gt; templateLoader = new GenericLoader&lt;&gt;(PCTemplate.class);</span>
<span class="nc" id="L143">    private final LstObjectFileLoader&lt;Equipment&gt; equipmentLoader =</span>
            new GenericLocalVariableLoader&lt;&gt;(Equipment.class, &quot;PC.EQUIPMENT&quot;);
<span class="nc" id="L145">    private final LstObjectFileLoader&lt;EquipmentModifier&gt; eqModLoader =</span>
            new GenericLocalVariableLoader&lt;&gt;(EquipmentModifier.class, EquipmentPartScope.PC_EQUIPMENT_PART);
<span class="nc" id="L147">    private final LstObjectFileLoader&lt;Race&gt; raceLoader = new GenericLoader&lt;&gt;(Race.class);</span>
<span class="nc" id="L148">    private final LstObjectFileLoader&lt;Skill&gt; skillLoader = new GenericLocalVariableLoader&lt;&gt;(Skill.class, &quot;PC.SKILL&quot;);</span>
<span class="nc" id="L149">    private final LstObjectFileLoader&lt;WeaponProf&gt; wProfLoader = new GenericLoader&lt;&gt;(WeaponProf.class);</span>
<span class="nc" id="L150">    private final LstObjectFileLoader&lt;ArmorProf&gt; aProfLoader = new GenericLoader&lt;&gt;(ArmorProf.class);</span>
<span class="nc" id="L151">    private final LstObjectFileLoader&lt;ShieldProf&gt; sProfLoader = new GenericLoader&lt;&gt;(ShieldProf.class);</span>
<span class="nc" id="L152">    private final LstObjectFileLoader&lt;Deity&gt; deityLoader = new GenericLoader&lt;&gt;(Deity.class);</span>
<span class="nc" id="L153">    private final LstObjectFileLoader&lt;Domain&gt; domainLoader = new GenericLoader&lt;&gt;(Domain.class);</span>
<span class="nc" id="L154">    private final LstObjectFileLoader&lt;PCCheck&gt; savesLoader = new GenericLocalVariableLoader&lt;&gt;(PCCheck.class, &quot;PC.SAVE&quot;);</span>
<span class="nc" id="L155">    private final LstObjectFileLoader&lt;PCAlignment&gt; alignmentLoader = new GenericLoader&lt;&gt;(PCAlignment.class);</span>
<span class="nc" id="L156">    private final LstObjectFileLoader&lt;PCStat&gt; statLoader = new GenericLocalVariableLoader&lt;&gt;(PCStat.class, &quot;PC.STAT&quot;);</span>
<span class="nc" id="L157">    private final LstObjectFileLoader&lt;SizeAdjustment&gt; sizeLoader =</span>
            new GenericLocalVariableLoader&lt;&gt;(SizeAdjustment.class, &quot;PC.SIZE&quot;);
<span class="nc" id="L159">    private final LstObjectFileLoader&lt;Spell&gt; spellLoader = new GenericLoader&lt;&gt;(Spell.class);</span>
<span class="nc" id="L160">    private final LstLineFileLoader dataControlLoader = new CDOMControlLoader();</span>
<span class="nc" id="L161">    private final VariableLoader variableLoader = new VariableLoader();</span>
<span class="nc" id="L162">    private final LstLineFileLoader tableLoader = new TableLoader();</span>
<span class="nc" id="L163">    private final LstLineFileLoader globalModifierLoader = new GlobalModifierLoader();</span>
<span class="nc" id="L164">    private final LstLineFileLoader dynamicLoader = new DynamicLoader();</span>

    /*
     * Other properties
     */
<span class="nc" id="L169">    private final Collection&lt;CampaignSourceEntry&gt; licenseFiles = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L170">    private final StringBuilder sec15 = new StringBuilder(500);</span>
<span class="nc" id="L171">    private final StringBuilder licensesToDisplayString = new StringBuilder(500);</span>
<span class="nc" id="L172">    private final StringBuilder matureCampaigns = new StringBuilder(100);</span>
<span class="nc" id="L173">    private boolean showLicensed = true;</span>
<span class="nc" id="L174">    private boolean showMature = false;</span>
<span class="nc" id="L175">    private boolean showOGL = false;</span>
<span class="nc" id="L176">    private final List&lt;Campaign&gt; selectedCampaigns = new ArrayList&lt;&gt;();</span>
    private final GameMode selectedGame;
<span class="nc" id="L178">    private DataSet dataset = null;</span>
<span class="nc" id="L179">    private int progress = 0;</span>
    private final UIDelegate uiDelegate;

    public SourceFileLoader(UIDelegate delegate, ListFacade&lt;Campaign&gt; campaigns, String gameModeNamed)
<span class="nc" id="L183">    {</span>
        //Ensure object lists are not null (but rather empty)
<span class="nc" id="L185">        CampaignLoader.OBJECT_FILE_LISTKEY</span>
<span class="nc" id="L186">                .forEach(fileLists::initializeListFor);</span>
<span class="nc" id="L187">        this.uiDelegate = delegate;</span>
<span class="nc" id="L188">        campaigns.forEach(campaign -&gt; selectedCampaigns.add(Globals.getCampaignKeyed(campaign.getKeyName())));</span>
<span class="nc" id="L189">        selectedGame = SystemCollections.getGameModeNamed(gameModeNamed);</span>
        //TODO see if this has any sideeffects
<span class="nc" id="L191">        new CampaignSourceEntry(new Campaign(), URI.create(&quot;file:/System%20Configuration%20Document&quot;));</span>

<span class="nc" id="L193">        abilityCategoryLoader.addObserver(this);</span>
<span class="nc" id="L194">        bioLoader.addObserver(this);</span>
<span class="nc" id="L195">        companionModLoader.addObserver(this);</span>
<span class="nc" id="L196">        deityLoader.addObserver(this);</span>
<span class="nc" id="L197">        domainLoader.addObserver(this);</span>
<span class="nc" id="L198">        equipmentLoader.addObserver(this);</span>
<span class="nc" id="L199">        eqModLoader.addObserver(this);</span>
<span class="nc" id="L200">        abilityLoader.addObserver(this);</span>
<span class="nc" id="L201">        featLoader.addObserver(this);</span>
<span class="nc" id="L202">        kitLoader.addObserver(this);</span>
<span class="nc" id="L203">        languageLoader.addObserver(this);</span>
<span class="nc" id="L204">        classLoader.addObserver(this);</span>
<span class="nc" id="L205">        raceLoader.addObserver(this);</span>
<span class="nc" id="L206">        skillLoader.addObserver(this);</span>
<span class="nc" id="L207">        spellLoader.addObserver(this);</span>
<span class="nc" id="L208">        templateLoader.addObserver(this);</span>
<span class="nc" id="L209">        wProfLoader.addObserver(this);</span>
<span class="nc" id="L210">        aProfLoader.addObserver(this);</span>
<span class="nc" id="L211">        sProfLoader.addObserver(this);</span>
<span class="nc" id="L212">        savesLoader.addObserver(this);</span>
<span class="nc" id="L213">        alignmentLoader.addObserver(this);</span>
<span class="nc" id="L214">        statLoader.addObserver(this);</span>
<span class="nc" id="L215">        dataControlLoader.addObserver(this);</span>
<span class="nc" id="L216">        dynamicLoader.addObserver(this);</span>
<span class="nc" id="L217">    }</span>

    @Override
    public void run()
    {
<span class="nc" id="L222">        Globals.emptyLists();</span>
<span class="nc" id="L223">        SettingsHandler.setGame(selectedGame.getName());</span>
<span class="nc" id="L224">        Globals.initPreferences();</span>
<span class="nc" id="L225">        Globals.emptyLists();</span>

<span class="nc" id="L227">        Handler handler = new LoadHandler();</span>
<span class="nc" id="L228">        Logging.registerHandler(handler);</span>
        try
        {
<span class="nc" id="L231">            loadCampaigns();</span>
<span class="nc" id="L232">        } catch (PersistenceLayerException e)</span>
        {
<span class="nc" id="L234">            Logging.errorPrint(&quot;Failed to load sources&quot;, e);</span>
<span class="nc" id="L235">            uiDelegate.showErrorMessage(Constants.APPLICATION_NAME, &quot;Failed to load sources, see log for details.&quot;);</span>
<span class="nc" id="L236">        }</span>
<span class="nc" id="L237">        Logging.removeHandler(handler);</span>
<span class="nc" id="L238">    }</span>

    public String getOGL()
    {
<span class="nc" id="L242">        return sec15.toString();</span>
    }

    public String getLicenses()
    {
<span class="nc" id="L247">        return licensesToDisplayString.toString();</span>
    }

    /**
     * @return a list of licenses read from the campaign license files
     */
    public Iterable&lt;String&gt; getOtherLicenses()
    {
<span class="nc" id="L255">        Collection&lt;String&gt; licenses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">        for (CampaignSourceEntry licenseFile : licenseFiles)</span>
        {
            try
            {
<span class="nc" id="L260">                String dataBuffer = LstFileLoader.readFromURI(licenseFile.getURI());</span>
<span class="nc" id="L261">                licenses.add(dataBuffer);</span>
<span class="nc" id="L262">            } catch (PersistenceLayerException e)</span>
            {
<span class="nc" id="L264">                Logging.errorPrint(&quot;Could not read license at &quot; + licenseFile, e);</span>
<span class="nc" id="L265">            }</span>
<span class="nc" id="L266">        }</span>
<span class="nc" id="L267">        return licenses;</span>
    }

    public String getMatureInfo()
    {
<span class="nc" id="L272">        return matureCampaigns.toString();</span>
    }

    /**
     * @return the dataSet that contains all of the data that was loaded
     */
    public DataSetFacade getDataSetFacade()
    {
<span class="nc" id="L280">        return dataset;</span>
    }

    /**
     * @return total files to load
     */
    private int countTotalFilesToLoad()
    {
<span class="nc" id="L288">        return fileLists.getKeySet().stream()</span>
<span class="nc" id="L289">                .mapToInt(fileLists::sizeOfListFor)</span>
<span class="nc" id="L290">                .sum();</span>
    }

    private void addCustomFilesToStartOfList()
    {
        CampaignSourceEntry tempSource;

        // The dummy campaign for custom data.
<span class="nc" id="L298">        Campaign customCampaign = new Campaign();</span>
<span class="nc" id="L299">        customCampaign.setName(&quot;Custom&quot;);</span>
<span class="nc" id="L300">        customCampaign.addToListFor(ListKey.DESCRIPTION, new Description(&quot;Custom data&quot;));</span>

        //
        // Add the custom bioset file to the start of the list if it exists
        //
<span class="nc" id="L305">        File bioSetFile = new File(CustomData.customBioSetFilePath(true));</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if (bioSetFile.exists())</span>
        {
<span class="nc" id="L308">            tempSource = new CampaignSourceEntry(customCampaign, bioSetFile.toURI());</span>
<span class="nc" id="L309">            fileLists.removeFromListFor(ListKey.FILE_BIO_SET, tempSource);</span>
<span class="nc" id="L310">            fileLists.addToListFor(ListKey.FILE_BIO_SET, 0, tempSource);</span>
        }

        //
        // Add the custom class file to the start of the list if it exists
        //
<span class="nc" id="L316">        File classFile = new File(CustomData.customClassFilePath(true));</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (classFile.exists())</span>
        {
<span class="nc" id="L319">            tempSource = new CampaignSourceEntry(customCampaign, classFile.toURI());</span>
<span class="nc" id="L320">            fileLists.removeFromListFor(ListKey.FILE_CLASS, tempSource);</span>
<span class="nc" id="L321">            fileLists.addToListFor(ListKey.FILE_CLASS, 0, tempSource);</span>
        }

        //
        // Add the custom deity file to the start of the list if it exists
        //
<span class="nc" id="L327">        File deityFile = new File(CustomData.customDeityFilePath(true));</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (deityFile.exists())</span>
        {
<span class="nc" id="L330">            tempSource = new CampaignSourceEntry(customCampaign, deityFile.toURI());</span>
<span class="nc" id="L331">            fileLists.removeFromListFor(ListKey.FILE_DEITY, tempSource);</span>
<span class="nc" id="L332">            fileLists.addToListFor(ListKey.FILE_DEITY, 0, tempSource);</span>
        }

        //
        // Add the custom domain file to the start of the list if it exists
        //
<span class="nc" id="L338">        File domainFile = new File(CustomData.customDomainFilePath(true));</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (domainFile.exists())</span>
        {
<span class="nc" id="L341">            tempSource = new CampaignSourceEntry(customCampaign, domainFile.toURI());</span>
<span class="nc" id="L342">            fileLists.removeFromListFor(ListKey.FILE_DOMAIN, tempSource);</span>
<span class="nc" id="L343">            fileLists.addToListFor(ListKey.FILE_DOMAIN, 0, tempSource);</span>
        }

        //
        // Add the custom ability file to the start of the list if it exists
        //
<span class="nc" id="L349">        File abilityFile = new File(CustomData.customAbilityFilePath(true));</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (abilityFile.exists())</span>
        {
<span class="nc" id="L352">            tempSource = new CampaignSourceEntry(customCampaign, abilityFile.toURI());</span>
<span class="nc" id="L353">            fileLists.removeFromListFor(ListKey.FILE_ABILITY, tempSource);</span>
<span class="nc" id="L354">            fileLists.addToListFor(ListKey.FILE_ABILITY, 0, tempSource);</span>
        }

        //
        // Add the custom feat file to the start of the list if it exists
        //
<span class="nc" id="L360">        File featFile = new File(CustomData.customFeatFilePath(true));</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">        if (featFile.exists())</span>
        {
<span class="nc" id="L363">            tempSource = new CampaignSourceEntry(customCampaign, featFile.toURI());</span>
<span class="nc" id="L364">            fileLists.removeFromListFor(ListKey.FILE_FEAT, tempSource);</span>
<span class="nc" id="L365">            fileLists.addToListFor(ListKey.FILE_FEAT, 0, tempSource);</span>
        }

        //
        // Add the custom language file to the start of the list if it exists
        //
<span class="nc" id="L371">        File languageFile = new File(CustomData.customLanguageFilePath(true));</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (languageFile.exists())</span>
        {
<span class="nc" id="L374">            tempSource = new CampaignSourceEntry(customCampaign, languageFile.toURI());</span>
<span class="nc" id="L375">            fileLists.removeFromListFor(ListKey.FILE_LANGUAGE, tempSource);</span>
<span class="nc" id="L376">            fileLists.addToListFor(ListKey.FILE_LANGUAGE, 0, tempSource);</span>
        }

        //
        // Add the custom race file to the start of the list if it exists
        //
<span class="nc" id="L382">        File raceFile = new File(CustomData.customRaceFilePath(true));</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">        if (raceFile.exists())</span>
        {
<span class="nc" id="L385">            tempSource = new CampaignSourceEntry(customCampaign, raceFile.toURI());</span>
<span class="nc" id="L386">            fileLists.removeFromListFor(ListKey.FILE_RACE, tempSource);</span>
<span class="nc" id="L387">            fileLists.addToListFor(ListKey.FILE_RACE, 0, tempSource);</span>
        }

        //
        // Add the custom skill file to the start of the list if it exists
        //
<span class="nc" id="L393">        File skillFile = new File(CustomData.customSkillFilePath(true));</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">        if (skillFile.exists())</span>
        {
<span class="nc" id="L396">            tempSource = new CampaignSourceEntry(customCampaign, skillFile.toURI());</span>
<span class="nc" id="L397">            fileLists.removeFromListFor(ListKey.FILE_SKILL, tempSource);</span>
<span class="nc" id="L398">            fileLists.addToListFor(ListKey.FILE_SKILL, 0, tempSource);</span>
        }

        //
        // Add the custom spell file to the start of the list if it exists
        //
<span class="nc" id="L404">        File spellFile = new File(CustomData.customSpellFilePath(true));</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">        if (spellFile.exists())</span>
        {
<span class="nc" id="L407">            tempSource = new CampaignSourceEntry(customCampaign, spellFile.toURI());</span>
<span class="nc" id="L408">            fileLists.removeFromListFor(ListKey.FILE_SPELL, tempSource);</span>
<span class="nc" id="L409">            fileLists.addToListFor(ListKey.FILE_SPELL, 0, tempSource);</span>
        }

        //
        // Add the custom template file to the start of the list if it exists
        //
<span class="nc" id="L415">        File templateFile = new File(CustomData.customTemplateFilePath(true));</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">        if (templateFile.exists())</span>
        {
<span class="nc" id="L418">            tempSource = new CampaignSourceEntry(customCampaign, templateFile.toURI());</span>
<span class="nc" id="L419">            fileLists.removeFromListFor(ListKey.FILE_TEMPLATE, tempSource);</span>
<span class="nc" id="L420">            fileLists.addToListFor(ListKey.FILE_TEMPLATE, 0, tempSource);</span>
        }
<span class="nc" id="L422">    }</span>

    private void addDefaultEquipmentMods(LoadContext context) throws PersistenceLayerException
    {
<span class="nc" id="L426">        URI uri = URI.create(&quot;file:/&quot; + eqModLoader.getClass().getName() + &quot;.java&quot;);</span>
<span class="nc" id="L427">        context.setSourceURI(uri);</span>
<span class="nc" id="L428">        SourceEntry source = new CampaignSourceEntry(new Campaign(), uri);</span>

<span class="nc" id="L430">        LoadContext subContext = context.dropIntoContext(&quot;PC.EQUIPMENT&quot;);</span>

<span class="nc" id="L432">        String addType = &quot;Add Type\tKEY:ADDTYPE\tTYPE:ALL\tCOST:0\tNAMEOPT:NONAME\tSOURCELONG:PCGen Internal\t&quot;</span>
                + &quot;CHOOSE:EQBUILDER.EQTYPE|COUNT=ALL|TITLE=desired TYPE(s)&quot;;
<span class="nc" id="L434">        eqModLoader.parseLine(subContext, null, addType, source);</span>

        //
        // Add internal equipment modifier for adding weapon/armor types to
        // equipment
        //
<span class="nc" id="L440">        String weapon = Constants.INTERNAL_EQMOD_WEAPON + &quot;\tTYPE:Weapon\tVISIBLE:NO\tCHOOSE:NOCHOICE\tNAMEOPT:NONAME&quot;;</span>
<span class="nc" id="L441">        eqModLoader.parseLine(subContext, null, weapon, source);</span>

<span class="nc" id="L443">        String armor = Constants.INTERNAL_EQMOD_ARMOR + &quot;\tTYPE:Armor\tVISIBLE:NO\tCHOOSE:NOCHOICE\tNAMEOPT:NONAME&quot;;</span>
<span class="nc" id="L444">        eqModLoader.parseLine(subContext, null, armor, source);</span>
<span class="nc" id="L445">    }</span>

    private void loadCampaigns() throws PersistenceLayerException
    {
        // Unload the existing campaigns and load our selected campaign
<span class="nc" id="L450">        Globals.emptyLists();</span>
<span class="nc" id="L451">        PersistenceManager pManager = PersistenceManager.getInstance();</span>
<span class="nc" id="L452">        List&lt;URI&gt; uris = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">        for (Campaign campaign : selectedCampaigns)</span>
        {
<span class="nc" id="L455">            uris.add(campaign.getSourceURI());</span>
<span class="nc" id="L456">        }</span>
<span class="nc" id="L457">        pManager.setChosenCampaignSourcefiles(uris);</span>

<span class="nc" id="L459">        licenseFiles.clear();</span>

<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (selectedCampaigns.isEmpty())</span>
        {
<span class="nc" id="L463">            throw new PersistenceLayerException(&quot;You must select at least one campaign to load.&quot;);</span>
        }
        // 21 Nov 2002: Put load inside a try/finally block to make sure
        // that file lines were cleared even if an exception occurred.
        // -- sage_sam
        try
        {
<span class="nc" id="L470">            LoadContext context = Globals.getContext();</span>
<span class="nc" id="L471">            loadCampaigns(selectedGame, selectedCampaigns, context);</span>

            // Load custom items
<span class="nc" id="L474">            loadCustomItems(context);</span>

<span class="nc" id="L476">            finishLoad(selectedGame, selectedCampaigns, context);</span>
            // Check for valid race types
            //			checkRaceTypes();

            // Verify weapons are melee or ranged
<span class="nc" id="L481">            verifyWeaponsMeleeOrRanged(context);</span>

<span class="nc" id="L483">            context.setLoaded(selectedCampaigns);</span>

            /*
             * This needs to happen after auto equipment generation and after
             * context.setLoaded, not in finishLoad
             */
<span class="nc" id="L489">            context.loadCampaignFacets();</span>

<span class="nc" id="L491">            dataset = new DataSet(context, selectedGame, new DefaultListFacade&lt;&gt;(selectedCampaigns));</span>
            //			//  Show the licenses
            //			showLicensesIfNeeded();
<span class="nc" id="L494">        } catch (Throwable thr)</span>
        {
<span class="nc" id="L496">            Logging.errorPrint(&quot;Exception loading files.&quot;, thr);</span>
<span class="nc" id="L497">            uiDelegate.showErrorMessage(Constants.APPLICATION_NAME, &quot;Failed to load campaigns, see log for details.&quot;);</span>
<span class="nc" id="L498">        }</span>
<span class="nc" id="L499">    }</span>

    private void loadCampaigns(GameMode gamemode, final List&lt;Campaign&gt; aSelectedCampaignsList, LoadContext context)
            throws PersistenceLayerException
    {
<span class="nc" id="L504">        Logging.log(Logging.INFO, &quot;Loading game &quot; + gamemode + &quot; and sources &quot; + aSelectedCampaignsList + &quot;.&quot;);</span>

<span class="nc" id="L506">        File gameModeDir = new File(ConfigurationSettings.getSystemsDir(), &quot;gameModes&quot;);</span>

        // Sort the campaigns
<span class="nc" id="L509">        sortCampaignsByRank(aSelectedCampaignsList);</span>

        // Read the campaigns
<span class="nc" id="L512">        Collection&lt;Campaign&gt; loaded = readPccFiles(aSelectedCampaignsList);</span>

        // Add custom campaign files at the start of the lists
<span class="nc" id="L515">        addCustomFilesToStartOfList();</span>

        // Notify our observers of how many files we intend
        // to load in total so that they can set up any
        // progress meters that they want to.
<span class="nc" id="L520">        setMaximum(countTotalFilesToLoad());</span>

        // Load using the new LstFileLoaders
<span class="nc" id="L523">        List&lt;CampaignSourceEntry&gt; dataDefFileList = fileLists.getListFor(ListKey.FILE_DATACTRL);</span>
<span class="nc" id="L524">        dataDefFileList = addDefaultDataControlIfNeeded(dataDefFileList);</span>
<span class="nc" id="L525">        dataControlLoader.loadLstFiles(context, dataDefFileList);</span>
<span class="nc" id="L526">        processFactDefinitions(context);</span>
<span class="nc" id="L527">        tableLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_DATATABLE));</span>

        //Load Variables (foundation for other items)
<span class="nc" id="L530">        variableLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_VARIABLE));</span>
<span class="nc" id="L531">        defineBuiltinVariables(context);</span>
<span class="nc" id="L532">        dynamicLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_DYNAMIC));</span>
<span class="nc" id="L533">        List&lt;CampaignSourceEntry&gt; globalModFileList = fileLists.getListFor(ListKey.FILE_GLOBALMOD);</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">        if (globalModFileList.isEmpty())</span>
        {
<span class="nc" id="L536">            File defaultGameModeDir = new File(gameModeDir, &quot;default&quot;);</span>
<span class="nc" id="L537">            File df = new File(defaultGameModeDir, &quot;compatibilityGlobalModifier.lst&quot;);</span>
<span class="nc" id="L538">            Campaign c = new Campaign();</span>
<span class="nc" id="L539">            c.setName(&quot;Default Global Modifier File&quot;);</span>
<span class="nc" id="L540">            CampaignSourceEntry cse = new CampaignSourceEntry(c, df.toURI());</span>
<span class="nc" id="L541">            globalModFileList.add(cse);</span>
        }
<span class="nc" id="L543">        globalModifierLoader.loadLstFiles(context, globalModFileList);</span>

        // load ability categories first as they used to only be at the game mode
<span class="nc" id="L546">        abilityCategoryLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_ABILITY_CATEGORY));</span>

        //Force all AbilityCategory objects to be imported as manufacturers
<span class="nc bnc" id="L549" title="All 2 branches missed.">        for (AbilityCategory ac : context.getReferenceContext().getConstructedCDOMObjects(AbilityCategory.class))</span>
        {
<span class="nc" id="L551">            context.getReferenceContext().getManufacturerId(ac);</span>
<span class="nc" id="L552">        }</span>

<span class="nc bnc" id="L554" title="All 2 branches missed.">        for (Campaign c : loaded)</span>
        {
<span class="nc" id="L556">            c.applyTo(context.getReferenceContext());</span>
<span class="nc" id="L557">        }</span>

<span class="nc" id="L559">        sizeLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_SIZE));</span>
        //Now load PCC stat, check, alignment
<span class="nc" id="L561">        statLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_STAT));</span>
<span class="nc" id="L562">        savesLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_SAVE));</span>
<span class="nc" id="L563">        alignmentLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_ALIGNMENT));</span>

        // load weapon profs first
<span class="nc" id="L566">        wProfLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_WEAPON_PROF));</span>
<span class="nc" id="L567">        WeaponProf wp =</span>
<span class="nc" id="L568">                context.getReferenceContext().silentlyGetConstructedCDOMObject(WeaponProf.class, &quot;Unarmed Strike&quot;);</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">        if (wp == null)</span>
        {
<span class="nc" id="L571">            wp = new WeaponProf();</span>
<span class="nc" id="L572">            wp.setName(LanguageBundle.getString(&quot;Equipment.UnarmedStrike&quot;));</span>
<span class="nc" id="L573">            wp.put(StringKey.KEY_NAME, &quot;Unarmed Strike&quot;);</span>
<span class="nc" id="L574">            wp.addToListFor(ListKey.TYPE, Type.SIMPLE);</span>
<span class="nc" id="L575">            context.getReferenceContext().importObject(wp);</span>
        }

<span class="nc" id="L578">        aProfLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_ARMOR_PROF));</span>
<span class="nc" id="L579">        sProfLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_SHIELD_PROF));</span>

        // load skills before classes to handle class skills
<span class="nc" id="L582">        skillLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_SKILL));</span>

        // load before races to handle auto known languages
<span class="nc" id="L585">        languageLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_LANGUAGE));</span>

        // load before race or class to handle feats
<span class="nc" id="L588">        featLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_FEAT));</span>

        // load before race or class to handle abilities
<span class="nc" id="L591">        abilityLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_ABILITY));</span>

<span class="nc" id="L593">        raceLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_RACE));</span>

        //Domain must load before CLASS - thpr 10/29/06
<span class="nc" id="L596">        domainLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_DOMAIN));</span>

<span class="nc" id="L598">        spellLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_SPELL));</span>
<span class="nc" id="L599">        deityLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_DEITY));</span>

<span class="nc" id="L601">        classLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_CLASS));</span>

<span class="nc" id="L603">        templateLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_TEMPLATE));</span>

        // loaded before equipment (required)
<span class="nc" id="L606">        eqModLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_EQUIP_MOD));</span>

<span class="nc" id="L608">        equipmentLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_EQUIP));</span>
<span class="nc" id="L609">        companionModLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_COMPANION_MOD));</span>
<span class="nc" id="L610">        kitLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_KIT));</span>

        // Load the bio settings files
<span class="nc" id="L613">        bioLoader.setGameMode(gamemode.getName());</span>
<span class="nc" id="L614">        bioLoader.loadLstFiles(context, fileLists.getListFor(ListKey.FILE_BIO_SET));</span>

        // Add default EQ mods
<span class="nc" id="L617">        addDefaultEquipmentMods(context);</span>

<span class="nc" id="L619">        classLoader.loadSubLines(context);</span>

        /*
         * This is technically bad behavior, but we at least want to provide the
         * hint here since we are using WeakReferences as a container for
         * references to ensure those that are not used are not resolved.
         */
<span class="nc" id="L626">        System.gc(); // NOPMD</span>
<span class="nc" id="L627">    }</span>

    /**
     * Places the built in variables, if required, into the given LoadContext.
     *
     * @param context The LoadContext in which the built in variables will be loaded, if
     *                necessary
     */
    public static void defineBuiltinVariables(LoadContext context)
    {
<span class="fc" id="L637">        CControl.getChannelConstants().stream()</span>
<span class="fc" id="L638">                .filter(control -&gt; allowControl(context, control))</span>
<span class="fc" id="L639">                .forEach(control -&gt; enableBuiltInControl(context, control));</span>
<span class="fc" id="L640">    }</span>

    private static boolean allowControl(LoadContext context, CControl control)
    {
<span class="fc bfc" id="L644" title="All 2 branches covered.">        return control.getControllingFeature().isEmpty() || ControlUtilities</span>
<span class="fc bfc" id="L645" title="All 2 branches covered.">                .isFeatureEnabled(context, control.getControllingFeature().get());</span>
    }

    /**
     * Enables the built-in version of the given Code Control.
     *
     * @param context The LoadContext in which the CodeControl exists
     * @param control The CodeControl to be enabled using its default values
     */
    private static void enableBuiltInControl(LoadContext context,
                                             CControl control)
    {
<span class="fc" id="L657">        AbstractReferenceContext referenceContext = context.getReferenceContext();</span>
<span class="fc" id="L658">        FormatManager&lt;?&gt; formatManager = referenceContext.getFormatManager(control.getFormat());</span>
<span class="fc" id="L659">        String varName = control.getDefaultValue();</span>
<span class="fc bfc" id="L660" title="All 2 branches covered.">        if (control.isChannel())</span>
        {
<span class="fc" id="L662">            varName = ChannelUtilities.createVarName(varName);</span>
        }
<span class="fc" id="L664">        defineVariable(context.getVariableContext(), formatManager, varName);</span>
<span class="fc bfc" id="L665" title="All 2 branches covered.">        if (control.isAutoGranted())</span>
        {
<span class="fc" id="L667">            GlobalModifiers modifiers = referenceContext</span>
<span class="fc" id="L668">                    .constructNowIfNecessary(GlobalModifiers.class, GlobalModifierLoader.GLOBAL_MODIFIERS);</span>
<span class="fc" id="L669">            modifiers.addGrantedVariable(varName);</span>
        }
<span class="fc" id="L671">    }</span>

    private static void defineVariable(VariableContext varContext, FormatManager&lt;?&gt; formatManager, String varName)
    {
<span class="fc" id="L675">        LegalScope varScope = varContext.getScope(GlobalPCScope.GLOBAL_SCOPE_NAME);</span>
<span class="fc" id="L676">        varContext.assertLegalVariableID(varName, varScope, formatManager);</span>
<span class="fc" id="L677">    }</span>

    /**
     * Add default data control files to the supplied list, but only if it is empty.
     *
     * @param dataDefFileList The list of data control files.
     */
    public static List&lt;CampaignSourceEntry&gt; addDefaultDataControlIfNeeded(List&lt;CampaignSourceEntry&gt; dataDefFileList)
    {
<span class="nc bnc" id="L686" title="All 2 branches missed.">        if (dataDefFileList == null)</span>
        {
<span class="nc" id="L688">            dataDefFileList = new ArrayList&lt;&gt;();</span>
        }
<span class="nc bnc" id="L690" title="All 2 branches missed.">        if (dataDefFileList.isEmpty())</span>
        {
<span class="nc" id="L692">            File gameModeDir = new File(ConfigurationSettings.getSystemsDir(), &quot;gameModes&quot;);</span>
<span class="nc" id="L693">            File defaultGameModeDir = new File(gameModeDir, &quot;default&quot;);</span>
<span class="nc" id="L694">            File df = new File(defaultGameModeDir, &quot;compatibilityDataControl.lst&quot;);</span>
<span class="nc" id="L695">            Campaign c = new Campaign();</span>
<span class="nc" id="L696">            c.setName(&quot;Default Data Control File&quot;);</span>
<span class="nc" id="L697">            CampaignSourceEntry cse = new CampaignSourceEntry(c, df.toURI());</span>
<span class="nc" id="L698">            dataDefFileList.add(cse);</span>
        }
<span class="nc" id="L700">        return dataDefFileList;</span>
    }

    public static void processFactDefinitions(LoadContext context)
    {
<span class="fc" id="L705">        context.getReferenceContext().getConstructedCDOMObjects(FactDefinition.class)</span>
<span class="fc" id="L706">                .forEach(factDefinition -&gt; factDefinition.activate(context));</span>

<span class="fc" id="L708">        context.getReferenceContext().getConstructedCDOMObjects(FactSetDefinition.class)</span>
<span class="fc" id="L709">                .forEach(factSetDefinition -&gt; factSetDefinition.activate(context));</span>
<span class="fc" id="L710">    }</span>

    private void finishLoad(GameMode gameMode, List&lt;Campaign&gt; aSelectedCampaignsList, LoadContext context)
    {
<span class="nc" id="L714">        createLangBonusObject(context);</span>
<span class="nc" id="L715">        AbstractReferenceContext refContext = context.getReferenceContext();</span>
<span class="nc" id="L716">        refContext.buildDeferredObjects();</span>
<span class="nc" id="L717">        refContext.buildDerivedObjects();</span>
<span class="nc" id="L718">        referenceAllCategories(context);</span>
<span class="nc" id="L719">        context.resolveDeferredTokens();</span>
<span class="nc" id="L720">        LoadValidator validator = new LoadValidator(aSelectedCampaignsList);</span>
<span class="nc" id="L721">        refContext.validate(validator);</span>
<span class="nc" id="L722">        refContext.resolveReferences(validator);</span>
<span class="nc" id="L723">        context.resolvePostValidationTokens();</span>
<span class="nc" id="L724">        context.resolvePostDeferredTokens();</span>
<span class="nc" id="L725">        context.getVariableContext().validateDefaults();</span>
        //Test for items we know we use (temporary)
        //Alignment
<span class="nc bnc" id="L728" title="All 2 branches missed.">        if (ControlUtilities.isFeatureEnabled(context, CControl.ALIGNMENTFEATURE)</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">                &amp;&amp; !context.getVariableContext().hasDefaultModifier(refContext.getManufacturer(PCAlignment.class)))</span>
        {
<span class="nc" id="L731">            Logging.errorPrint(&quot;GameMode &quot; + gameMode.getName() + &quot; has Alignment text - &quot;</span>
                    + &quot;Thus it  requires a default value for ALIGNMENT format&quot;);
        }
        //Face
<span class="nc bnc" id="L735" title="All 2 branches missed.">        if (!context.getVariableContext().hasDefaultModifier(FormatUtilities.ORDEREDPAIR_MANAGER))</span>
        {
<span class="nc" id="L737">            Logging.errorPrint(gameMode.getName() + &quot; did not have required default value for ORDEREDPAIR format&quot;);</span>
        }

<span class="nc" id="L740">        ReferenceContextUtilities.validateAssociations(refContext, validator);</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">        for (Equipment eq : refContext.getConstructedCDOMObjects(Equipment.class))</span>
        {
<span class="nc" id="L743">            eq.setToCustomSize(null);</span>
<span class="nc" id="L744">            EqModAttachment.finishEquipment(eq);</span>
<span class="nc" id="L745">        }</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">        if (RaceUtilities.getUnselectedRace() == null)</span>
        {
<span class="nc" id="L748">            Logging.errorPrint(gameMode.getName() + &quot; did not have required Race with 'Unselected' Group&quot;);</span>
        }
<span class="nc bnc" id="L750" title="All 2 branches missed.">        if (ControlUtilities.isFeatureEnabled(context, CControl.DOMAINFEATURE))</span>
        {
<span class="nc" id="L752">            long unselectedDeityCount = refContext.getConstructedCDOMObjects(Deity.class)</span>
<span class="nc" id="L753">                    .stream()</span>
<span class="nc" id="L754">                    .filter(Deity::isUnselected)</span>
<span class="nc" id="L755">                    .count();</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">            if (unselectedDeityCount != 1)</span>
            {
<span class="nc" id="L758">                Logging.errorPrint(gameMode.getName()</span>
                        + &quot; did not have one Deity with 'Unselected' Group (found: &quot;
                        + unselectedDeityCount + &quot;)&quot;);
            }
        }
<span class="nc" id="L763">    }</span>

    private void referenceAllCategories(LoadContext context)
    {
<span class="nc" id="L767">        GameMode gamemode = SettingsHandler.getGameAsProperty().get();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">        for (AbilityCategory cat : gamemode.getAllAbilityCategories())</span>
        {
            /*
             * Yes, these are thrown away... just need to make sure the
             * manufacturer was built.
             */
<span class="nc" id="L774">            context.getReferenceContext().getManufacturerId(cat);</span>
<span class="nc" id="L775">        }</span>
<span class="nc" id="L776">    }</span>

    public static void createLangBonusObject(LoadContext context)
    {
<span class="fc" id="L780">        Ability a = AbilityCategory.LANGBONUS.newInstance();</span>
<span class="fc" id="L781">        a.setKeyName(&quot;*LANGBONUS&quot;);</span>
<span class="fc" id="L782">        context.getReferenceContext().importObject(a);</span>
<span class="fc" id="L783">        a.put(ObjectKey.INTERNAL, true);</span>
<span class="fc" id="L784">        context.unconditionallyProcess(a, &quot;CHOOSE&quot;, &quot;LANG|!PC,LANGBONUS&quot;);</span>
<span class="fc" id="L785">        context.unconditionallyProcess(a, &quot;VISIBLE&quot;, &quot;NO&quot;);</span>
<span class="fc" id="L786">        context.unconditionallyProcess(a, &quot;AUTO&quot;, &quot;LANG|%LIST&quot;);</span>
<span class="fc" id="L787">        context.unconditionallyProcess(a, &quot;MULT&quot;, &quot;YES&quot;);</span>
<span class="fc" id="L788">    }</span>

    private void loadCustomItems(LoadContext context)
    {
<span class="nc bnc" id="L792" title="All 2 branches missed.">        if (!PCGenSettings.OPTIONS_CONTEXT.getBoolean(PCGenSettings.OPTION_SAVE_CUSTOM_EQUIPMENT))</span>
        {
<span class="nc" id="L794">            return;</span>
        }

<span class="nc" id="L797">        try (BufferedReader br = CustomData.getCustomEquipmentReader())</span>
        {
<span class="nc bnc" id="L799" title="All 2 branches missed.">            if (br != null)</span>
            {
<span class="nc" id="L801">                String aLine = br.readLine();</span>

<span class="nc bnc" id="L803" title="All 2 branches missed.">                if (aLine == null)</span>
                {
<span class="nc" id="L805">                    return;</span>
                }

<span class="nc bnc" id="L808" title="All 2 branches missed.">                if (aLine.startsWith(&quot;BASEITEM:&quot;))</span>
                {
<span class="nc" id="L810">                    final int idx = aLine.indexOf('\t', 9);</span>

<span class="nc bnc" id="L812" title="All 2 branches missed.">                    if (idx &lt; 10)</span>
                    {
<span class="nc" id="L814">                        return;</span>
                    }

<span class="nc" id="L817">                    final String baseItemKey = aLine.substring(9, idx);</span>
<span class="nc" id="L818">                    aLine = aLine.substring(idx + 1);</span>

<span class="nc" id="L820">                    Equipment aEq = context.getReferenceContext().silentlyGetConstructedCDOMObject(Equipment.class,</span>
                            baseItemKey);

<span class="nc bnc" id="L823" title="All 2 branches missed.">                    if (aEq != null)</span>
                    {
<span class="nc" id="L825">                        aEq = aEq.clone();</span>
<span class="nc" id="L826">                        aEq.setBase();</span>
<span class="nc" id="L827">                        aEq.load(aLine, &quot;\t&quot;, &quot;:&quot;, null);</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">                        if (!aEq.isType(Constants.TYPE_CUSTOM))</span>
                        {
<span class="nc" id="L830">                            aEq.addType(Type.CUSTOM);</span>
                        }
<span class="nc" id="L832">                        context.getReferenceContext().importObject(aEq);</span>
                    }
                }
            }
<span class="nc" id="L836">            CustomData.setCustomItemsLoaded(true);</span>
<span class="nc bnc" id="L837" title="All 4 branches missed.">        } catch (IOException e)</span>
        {
<span class="nc" id="L839">            Logging.errorPrint(&quot;Error when loading custom items&quot;, e);</span>
<span class="nc" id="L840">        }</span>
<span class="nc" id="L841">    }</span>

    /**
     * This method is called to verify that all weapons loaded from the
     * equipment files are classified as either Melee or Ranged. This is
     * required so that to-hit values can be calculated for that weapon.
     *
     * @throws PersistenceLayerException if a weapon is neither melee or ranged, indicating the name
     *                                   of the weapon that caused the error
     */
    private static void verifyWeaponsMeleeOrRanged(LoadContext context) throws PersistenceLayerException
    {
        //
        // Check all the weapons to see if they are either Melee or Ranged, to avoid
        // problems when we go to export/preview the character
        //
<span class="nc bnc" id="L857" title="All 2 branches missed.">        for (Equipment aEq : context.getReferenceContext().getConstructedCDOMObjects(Equipment.class))</span>
        {
<span class="nc bnc" id="L859" title="All 6 branches missed.">            if (aEq.isWeapon() &amp;&amp; !aEq.isMelee() &amp;&amp; !aEq.isRanged())</span>
            {
<span class="nc" id="L861">                throw new PersistenceLayerException(</span>
<span class="nc" id="L862">                        &quot;Weapon: &quot; + aEq.getName() + &quot; is neither Melee nor Ranged.&quot; + Constants.LINE_SEPARATOR</span>
                                + Constants.APPLICATION_NAME + &quot; cannot calculate \&quot;to hit\&quot; unless one of these is selected.&quot;
<span class="nc" id="L864">                                + Constants.LINE_SEPARATOR + &quot;Source: &quot; + aEq.getSourceURI());</span>
            }
<span class="nc" id="L866">        }</span>
<span class="nc" id="L867">    }</span>

    /**
     * This method sorts the provided listof Campaign objects by rank.
     *
     * @param aSelectedCampaignsList List of Campaign objects to sort
     */
    public static void sortCampaignsByRank(final List&lt;Campaign&gt; aSelectedCampaignsList)
    {
<span class="nc" id="L876">        aSelectedCampaignsList.sort((c1, c2) -&gt; c2.getSafe(IntegerKey.CAMPAIGN_RANK) - c1.getSafe(IntegerKey.CAMPAIGN_RANK));</span>

<span class="nc" id="L878">    }</span>

    /**
     * This method reads the PCC (Campaign) files and, if options are allowed to
     * be set in the sources, sets the SettingsHandler settings to reflect the
     * changes from the campaign files.
     *
     * @param aSelectedCampaignsList List of Campaigns to load
     */
    private Collection&lt;Campaign&gt; readPccFiles(Iterable&lt;Campaign&gt; aSelectedCampaignsList)
    {
<span class="nc" id="L889">        Collection&lt;Campaign&gt; loadedSet = new HashSet&lt;&gt;();</span>

        // Create aggregate collections of source files to load
        // along with any options required by the campaigns...
<span class="nc bnc" id="L893" title="All 2 branches missed.">        for (Campaign campaign : aSelectedCampaignsList)</span>
        {
<span class="nc bnc" id="L895" title="All 2 branches missed.">            if (Logging.isDebugMode())</span>
            {
<span class="nc" id="L897">                Logging.debugPrint(&quot;Loading campaign &quot; + campaign);</span>
            }

<span class="nc" id="L900">            List&lt;String&gt; copyright = campaign.getListFor(ListKey.SECTION_15);</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">            if (copyright != null)</span>
            {
<span class="nc" id="L903">                sec15.append(&quot;&lt;br&gt;&lt;b&gt;Source Material:&lt;/b&gt;&quot;);</span>
<span class="nc" id="L904">                sec15.append(SourceFormat.getFormattedString(campaign, SourceFormat.LONG, true));</span>
<span class="nc" id="L905">                sec15.append(&quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L906">                sec15.append(&quot;&lt;b&gt;Section 15 Entry in Source Material:&lt;/b&gt;&lt;br&gt;&quot;);</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">                for (String license : copyright)</span>
                {
<span class="nc" id="L909">                    sec15.append(license).append(&quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L910">                }</span>
            }

            // Update whether licenses need shown
<span class="nc" id="L914">            showOGL |= campaign.getSafe(ObjectKey.IS_OGL);</span>
<span class="nc" id="L915">            showLicensed |= campaign.getSafe(ObjectKey.IS_LICENSED);</span>

<span class="nc bnc" id="L917" title="All 2 branches missed.">            if (campaign.getSafe(ObjectKey.IS_LICENSED))</span>
            {
<span class="nc" id="L919">                List&lt;String&gt; licenseList = campaign.getSafeListFor(ListKey.LICENSE);</span>
<span class="nc bnc" id="L920" title="All 4 branches missed.">                if (licenseList != null &amp;&amp; !licenseList.isEmpty())</span>
                {
<span class="nc" id="L922">                    licensesToDisplayString.append(licenseList);</span>
                }

<span class="nc" id="L925">                List&lt;CampaignSourceEntry&gt; licenseURIs = campaign.getSafeListFor(ListKey.LICENSE_FILE);</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">                if (licenseURIs != null)</span>
                {
<span class="nc" id="L928">                    licenseFiles.addAll(licenseURIs);</span>
                }
            }

            // check if maturity warning needs to be shown
<span class="nc" id="L933">            showMature |= campaign.getSafe(ObjectKey.IS_MATURE);</span>

<span class="nc bnc" id="L935" title="All 2 branches missed.">            if (campaign.getSafe(ObjectKey.IS_MATURE))</span>
            {
<span class="nc" id="L937">                matureCampaigns.append(SourceFormat.LONG.getField(campaign)).append(&quot; (&quot;).append(campaign.getSafe(StringKey.PUB_NAME_LONG)).append(&quot;)&lt;br&gt;&quot;);</span>
            }

            // Load the LST files to be loaded for the campaign
<span class="nc" id="L941">            addQualifiedSources(campaign, ListKey.FILE_LST_EXCLUDE);</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">            for (ListKey&lt;CampaignSourceEntry&gt; lk : CampaignLoader.OBJECT_FILE_LISTKEY)</span>
            {
<span class="nc" id="L944">                addQualifiedSources(campaign, lk);</span>
<span class="nc" id="L945">            }</span>
<span class="nc" id="L946">            loadedSet.add(campaign);</span>

<span class="nc bnc" id="L948" title="All 2 branches missed.">            if (PCGenSettings.OPTIONS_CONTEXT.initBoolean(PCGenSettings.OPTION_ALLOWED_IN_SOURCES, true))</span>
            {
<span class="nc" id="L950">                setCampaignOptions(campaign);</span>
            }

            // Add all sub-files to the main campaign, regardless of exclusions
<span class="nc bnc" id="L954" title="All 2 branches missed.">            for (CampaignSourceEntry fName : campaign.getSafeListFor(ListKey.FILE_PCC))</span>
            {
<span class="nc" id="L956">                URI uri = fName.getURI();</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">                if (PCGFile.isPCGenCampaignFile(uri))</span>
                {
<span class="nc" id="L959">                    loadedSet.add(Globals.getCampaignByURI(uri, false));</span>
                } else
                {
<span class="nc" id="L962">                    Logging.errorPrint(&quot;The referenced source &quot; + uri + &quot; is not valid.&quot;);</span>
                }
<span class="nc" id="L964">            }</span>

<span class="nc" id="L966">        }</span>

        // ...but make sure to remove those files specified by LSTEXCLUDE;
        // LSTEXCLUDE should be treated as a global exclusion.
        // sage_sam 29 Dec 2003, Bug #834834
<span class="nc" id="L971">        stripLstExcludes();</span>

<span class="nc" id="L973">        return loadedSet;</span>
    }

    /**
     * Add only those source files that either have no requirements, or that the
     * requirements are satisfied.
     *
     * @param c  The list being populated.
     * @param lk The list of potential sources to be added.
     */
    private void addQualifiedSources(Campaign c, ListKey&lt;CampaignSourceEntry&gt; lk)
    {
<span class="nc bnc" id="L985" title="All 2 branches missed.">        for (CampaignSourceEntry cse : c.getSafeListFor(lk))</span>
        {
<span class="nc" id="L987">            List&lt;Prerequisite&gt; prerequisites = cse.getPrerequisites();</span>
<span class="nc bnc" id="L988" title="All 4 branches missed.">            if (prerequisites.isEmpty() || PrereqHandler.passesAll(prerequisites, null, cse))</span>
            {
<span class="nc" id="L990">                fileLists.addToListFor(lk, cse);</span>
            }
<span class="nc" id="L992">        }</span>
<span class="nc" id="L993">    }</span>

    /**
     * Sets the options specified in the campaign aCamp.
     *
     * @param aCamp
     */
    private static void setCampaignOptions(Campaign aCamp)
    {
<span class="nc" id="L1002">        Set&lt;String&gt; keys = aCamp.getKeysFor(MapKey.PROPERTY);</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">        for (final String key : keys)</span>
        {
<span class="nc" id="L1005">            String value = aCamp.get(MapKey.PROPERTY, key);</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">            if (key.contains(&quot;.&quot;))</span>
            {
<span class="nc" id="L1008">                PCGenSettings.getInstance().setProperty(key, value);</span>
            } else
            {
<span class="nc" id="L1011">                PCGenSettings.OPTIONS_CONTEXT.setProperty(key, value);</span>
            }
            // Note: This is just until we transition all settings from the legacy settings
<span class="nc" id="L1014">            SettingsHandler.setPCGenOption(key, value);</span>
<span class="nc" id="L1015">        }</span>
        // Make sure any game mode settings are applied.
<span class="nc" id="L1017">        SystemCollections.getUnmodifiableGameModeList().forEach(GameMode::applyPreferences);</span>
<span class="nc" id="L1018">    }</span>

    /**
     * This method makes sure that the files specified by an LSTEXCLUDE tag are
     * stripped out of the source files to be loaded on a global basis.
     */
    private void stripLstExcludes()
    {
<span class="nc bnc" id="L1026" title="All 2 branches missed.">        for (ListKey&lt;?&gt; lk : fileLists.getKeySet())</span>
        {
<span class="nc bnc" id="L1028" title="All 2 branches missed.">            if (!ListKey.FILE_LST_EXCLUDE.equals(lk))</span>
            {
<span class="nc" id="L1030">                stripLstExcludes(lk);</span>
            }
<span class="nc" id="L1032">        }</span>
<span class="nc" id="L1033">    }</span>

    private void stripLstExcludes(ListKey&lt;?&gt; lk)
    {
<span class="nc" id="L1037">        List&lt;CampaignSourceEntry&gt; excludes = fileLists.getListFor(ListKey.FILE_LST_EXCLUDE);</span>
<span class="nc bnc" id="L1038" title="All 2 branches missed.">        if (excludes != null)</span>
        {
<span class="nc bnc" id="L1040" title="All 2 branches missed.">            for (CampaignSourceEntry exc : excludes)</span>
            {
<span class="nc" id="L1042">                URI uri = exc.getURI();</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">                for (CampaignSourceEntry cse : fileLists.getListFor(lk))</span>
                {
<span class="nc bnc" id="L1045" title="All 2 branches missed.">                    if (cse.getURI().equals(uri))</span>
                    {
<span class="nc" id="L1047">                        fileLists.removeFromListFor(lk, cse);</span>
                    }
<span class="nc" id="L1049">                }</span>
<span class="nc" id="L1050">            }</span>
        }
<span class="nc" id="L1052">    }</span>

    public boolean hasMatureCampaign()
    {
<span class="nc" id="L1056">        return showMature;</span>
    }

    public boolean hasOGLCampaign()
    {
<span class="nc" id="L1061">        return showOGL;</span>
    }

    public boolean hasLicensedCampaign()
    {
<span class="nc" id="L1066">        return showLicensed;</span>
    }

    @Override
    public void update(Observable o, Object arg)
    {
<span class="nc bnc" id="L1072" title="All 2 branches missed.">        if (arg instanceof URI uri)</span>
        {
<span class="nc" id="L1074">            progress++;</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">	        if (&quot;file&quot;.equalsIgnoreCase(uri.getScheme()))</span>
            {
<span class="nc" id="L1077">                setProgress(new File(uri).getName(), progress);</span>
            } else
            {
<span class="nc" id="L1080">                setProgress(String.valueOf(uri), progress);</span>
            }
<span class="nc bnc" id="L1082" title="All 2 branches missed.">        } else if (arg instanceof Exception)</span>
        {
<span class="nc" id="L1084">            sendErrorMessage((Exception) arg);</span>
        }
<span class="nc" id="L1086">    }</span>

    private final class LoadHandler extends Handler
    {

        private LoadHandler()
<span class="nc" id="L1092">        {</span>
<span class="nc" id="L1093">            setLevel(Logging.LST_WARNING);</span>
<span class="nc" id="L1094">        }</span>

        @Override
        public void close()
        {
            // Nothing to do
<span class="nc" id="L1100">        }</span>

        @Override
        public void flush()
        {
            // Nothing to do
<span class="nc" id="L1106">        }</span>

        @Override
        public void publish(final LogRecord arg0)
        {
<span class="nc" id="L1111">            sendErrorMessage(arg0);</span>
<span class="nc" id="L1112">        }</span>

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>