<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LangToken.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">plugin.lsttokens.auto</a> &gt; <span class="el_source">LangToken.java</span></div><h1>LangToken.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2007 (C) Thomas Parker &lt;thpr@users.sourceforge.net&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package plugin.lsttokens.auto;

import java.io.StringWriter;
import java.util.Collection;
import java.util.List;
import java.util.StringTokenizer;

import pcgen.cdom.base.CDOMObject;
import pcgen.cdom.base.CDOMReference;
import pcgen.cdom.base.ChooseDriver;
import pcgen.cdom.base.ChooseSelectionActor;
import pcgen.cdom.base.Constants;
import pcgen.cdom.content.ConditionalSelectionActor;
import pcgen.cdom.enumeration.ListKey;
import pcgen.core.Language;
import pcgen.core.PlayerCharacter;
import pcgen.core.QualifiedObject;
import pcgen.core.prereq.Prerequisite;
import pcgen.persistence.PersistenceLayerException;
import pcgen.persistence.lst.output.prereq.PrerequisiteWriter;
import pcgen.persistence.lst.prereq.PreParserFactory;
import pcgen.rules.context.Changes;
import pcgen.rules.context.LoadContext;
import pcgen.rules.persistence.TokenUtilities;
import pcgen.rules.persistence.token.AbstractNonEmptyToken;
import pcgen.rules.persistence.token.CDOMSecondaryToken;
import pcgen.rules.persistence.token.ParseResult;
import pcgen.util.Logging;

<span class="fc" id="L47">public class LangToken extends AbstractNonEmptyToken&lt;CDOMObject&gt;</span>
		implements CDOMSecondaryToken&lt;CDOMObject&gt;, ChooseSelectionActor&lt;Language&gt;
{

<span class="fc" id="L51">	private static final Class&lt;Language&gt; LANGUAGE_CLASS = Language.class;</span>

	@Override
	public String getParentToken()
	{
<span class="fc" id="L56">		return &quot;AUTO&quot;;</span>
	}

	@Override
	public String getTokenName()
	{
<span class="fc" id="L62">		return &quot;LANG&quot;;</span>
	}

	private String getFullName()
	{
<span class="fc" id="L67">		return getParentToken() + Constants.COLON + getTokenName();</span>
	}

	@Override
	protected ParseResult parseNonEmptyToken(LoadContext context, CDOMObject obj, String value)
	{
<span class="fc" id="L73">		String lang = value;</span>

<span class="fc" id="L75">		ParseResult pr = checkSeparatorsAndNonEmpty('|', lang);</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">		if (!pr.passed())</span>
		{
<span class="fc" id="L78">			return pr;</span>
		}

<span class="fc" id="L81">		boolean foundAny = false;</span>
<span class="fc" id="L82">		boolean foundOther = false;</span>

<span class="fc" id="L84">		StringTokenizer tok = new StringTokenizer(lang, Constants.PIPE);</span>

<span class="fc" id="L86">		boolean isPre = false;</span>
<span class="fc" id="L87">		Prerequisite prereq = null; // Do not initialize, null is significant!</span>

<span class="fc bfc" id="L89" title="All 2 branches covered.">		while (tok.hasMoreTokens())</span>
		{
<span class="fc" id="L91">			String token = tok.nextToken();</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">			if (PreParserFactory.isPreReqString(token))</span>
			{
<span class="nc bnc" id="L94" title="All 2 branches missed.">				if (isPre)</span>
				{
<span class="nc" id="L96">					String errorText =</span>
<span class="nc" id="L97">							&quot;Invalid &quot; + getTokenName() + &quot;: &quot; + value + &quot;  PRExxx must be at the END of the Token&quot;;</span>
<span class="nc" id="L98">					Logging.errorPrint(errorText);</span>
<span class="nc" id="L99">					return new ParseResult.Fail(errorText);</span>
				}
<span class="nc" id="L101">				prereq = getPrerequisite(token);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">				if (prereq == null)</span>
				{
<span class="nc" id="L104">					return new ParseResult.Fail(&quot;Error generating Prerequisite &quot; + prereq + &quot; in &quot; + getFullName());</span>
				}
<span class="nc" id="L106">				int preStart = value.indexOf(token) - 1;</span>
<span class="nc" id="L107">				lang = value.substring(0, preStart);</span>
<span class="nc" id="L108">				isPre = true;</span>
			}
<span class="fc" id="L110">		}</span>

<span class="fc" id="L112">		boolean firstToken = true;</span>
<span class="fc" id="L113">		tok = new StringTokenizer(lang, Constants.PIPE);</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">		while (tok.hasMoreTokens())</span>
		{
<span class="fc" id="L116">			String token = tok.nextToken();</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">			if (Constants.LST_DOT_CLEAR.equals(token))</span>
			{
<span class="nc bnc" id="L119" title="All 2 branches missed.">				if (!firstToken)</span>
				{
<span class="nc" id="L121">					return new ParseResult.Fail(&quot;Non-sensical situation was &quot; + &quot;encountered while parsing &quot;</span>
<span class="nc" id="L122">						+ getTokenName() + &quot;: When used, .CLEAR must be the first argument&quot;);</span>
				}
<span class="nc" id="L124">				context.getObjectContext().removeList(obj, ListKey.AUTO_LANGUAGE);</span>
			}
<span class="fc bfc" id="L126" title="All 2 branches covered.">			else if (Constants.LST_PERCENT_LIST.equals(token))</span>
			{
				ChooseSelectionActor&lt;Language&gt; cra;
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">				if (prereq == null)</span>
				{
<span class="fc" id="L131">					cra = this;</span>
				}
				else
				{
<span class="nc" id="L135">					ConditionalSelectionActor&lt;Language&gt; cca = new ConditionalSelectionActor&lt;&gt;(this);</span>
<span class="nc" id="L136">					cca.addPrerequisite(prereq);</span>
<span class="nc" id="L137">					cra = cca;</span>
				}
<span class="fc" id="L139">				foundOther = true;</span>
<span class="fc" id="L140">				context.getObjectContext().addToList(obj, ListKey.NEW_CHOOSE_ACTOR, cra);</span>
<span class="fc" id="L141">			}</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">			else if (Constants.LST_ALL.equals(token))</span>
			{
<span class="fc" id="L144">				foundAny = true;</span>
<span class="fc" id="L145">				context.getObjectContext().addToList(obj, ListKey.AUTO_LANGUAGE,</span>
<span class="fc" id="L146">					new QualifiedObject&lt;&gt;(context.getReferenceContext().getCDOMAllReference(LANGUAGE_CLASS), prereq));</span>
			}
			else
			{
<span class="fc" id="L150">				foundOther = true;</span>
<span class="fc" id="L151">				CDOMReference&lt;Language&gt; ref = TokenUtilities.getTypeOrPrimitive(context, LANGUAGE_CLASS, token);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">				if (ref == null)</span>
				{
<span class="fc" id="L154">					return new ParseResult.Fail(&quot;  Error was encountered while parsing &quot; + getTokenName());</span>
				}
<span class="fc" id="L156">				context.getObjectContext().addToList(obj, ListKey.AUTO_LANGUAGE, new QualifiedObject&lt;&gt;(ref, prereq));</span>
			}
<span class="fc" id="L158">			firstToken = false;</span>
<span class="fc" id="L159">		}</span>

<span class="fc bfc" id="L161" title="All 4 branches covered.">		if (foundAny &amp;&amp; foundOther)</span>
		{
<span class="fc" id="L163">			return new ParseResult.Fail(</span>
<span class="fc" id="L164">				&quot;Non-sensical &quot; + getFullName() + &quot;: Contains ANY and a specific reference: &quot; + value);</span>
		}

<span class="fc" id="L167">		return ParseResult.SUCCESS;</span>
	}

	@Override
	public String[] unparse(LoadContext context, CDOMObject obj)
	{
<span class="fc" id="L173">		PrerequisiteWriter prereqWriter = new PrerequisiteWriter();</span>
<span class="fc" id="L174">		Changes&lt;QualifiedObject&lt;CDOMReference&lt;Language&gt;&gt;&gt; changes =</span>
<span class="fc" id="L175">				context.getObjectContext().getListChanges(obj, ListKey.AUTO_LANGUAGE);</span>
<span class="fc" id="L176">		Changes&lt;ChooseSelectionActor&lt;?&gt;&gt; listChanges =</span>
<span class="fc" id="L177">				context.getObjectContext().getListChanges(obj, ListKey.NEW_CHOOSE_ACTOR);</span>
<span class="fc" id="L178">		Collection&lt;QualifiedObject&lt;CDOMReference&lt;Language&gt;&gt;&gt; added = changes.getAdded();</span>
<span class="fc" id="L179">		StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L180">		Collection&lt;ChooseSelectionActor&lt;?&gt;&gt; listAdded = listChanges.getAdded();</span>
<span class="fc" id="L181">		boolean foundAny = false;</span>
<span class="fc" id="L182">		boolean foundOther = false;</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">		if (changes.includesGlobalClear())</span>
		{
<span class="nc" id="L185">			sb.append(Constants.LST_DOT_CLEAR);</span>
		}
<span class="pc bpc" id="L187" title="1 of 4 branches missed.">		if (listAdded != null &amp;&amp; !listAdded.isEmpty())</span>
		{
<span class="fc bfc" id="L189" title="All 2 branches covered.">			for (ChooseSelectionActor&lt;?&gt; cra : listAdded)</span>
			{
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">				if (cra.getSource().equals(getTokenName()))</span>
				{
					try
					{
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">						if (sb.length() &gt; 0)</span>
						{
<span class="nc" id="L197">							sb.append('|');</span>
						}
<span class="fc" id="L199">						sb.append(cra.getLstFormat());</span>
<span class="fc" id="L200">						foundOther = true;</span>
					}
<span class="nc" id="L202">					catch (PersistenceLayerException e)</span>
					{
<span class="nc" id="L204">						context.addWriteMessage(&quot;Error writing Prerequisite: &quot; + e);</span>
<span class="nc" id="L205">						return null;</span>
<span class="fc" id="L206">					}</span>
				}
<span class="fc" id="L208">			}</span>
		}
<span class="fc bfc" id="L210" title="All 2 branches covered.">		if (added != null)</span>
		{
<span class="fc bfc" id="L212" title="All 2 branches covered.">			boolean needPipe = sb.length() &gt; 0;</span>
<span class="fc" id="L213">			Prerequisite prereq = null;</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">			for (QualifiedObject&lt;CDOMReference&lt;Language&gt;&gt; spp : added)</span>
			{
<span class="fc" id="L216">				CDOMReference&lt;Language&gt; lang = spp.getRawObject();</span>
<span class="fc" id="L217">				List&lt;Prerequisite&gt; prereqs = spp.getPrerequisiteList();</span>
<span class="fc" id="L218">				String ab = lang.getLSTformat(false);</span>
<span class="fc" id="L219">				boolean isUnconditionalAll = Constants.LST_ALL.equals(ab);</span>
<span class="fc" id="L220">				foundAny |= isUnconditionalAll;</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">				foundOther |= !isUnconditionalAll;</span>
<span class="fc bfc" id="L222" title="All 2 branches covered.">				if (needPipe)</span>
				{
<span class="fc" id="L224">					sb.append('|');</span>
				}
<span class="fc" id="L226">				needPipe = true;</span>
<span class="pc bpc" id="L227" title="2 of 4 branches missed.">				if (prereqs != null &amp;&amp; !prereqs.isEmpty())</span>
				{
<span class="nc bnc" id="L229" title="All 2 branches missed.">					if (prereqs.size() &gt; 1)</span>
					{
<span class="nc" id="L231">						context.addWriteMessage(&quot;Error: &quot; + obj.getClass().getSimpleName()</span>
<span class="nc" id="L232">							+ &quot; had more than one Prerequisite for &quot; + getFullName());</span>
<span class="nc" id="L233">						return null;</span>
					}
<span class="nc" id="L235">					Prerequisite p = prereqs.get(0);</span>
<span class="nc bnc" id="L236" title="All 4 branches missed.">					if (prereq != null &amp;&amp; !p.equals(prereq))</span>
					{
<span class="nc" id="L238">						context.addWriteMessage(&quot;Error: &quot; + obj.getClass().getSimpleName()</span>
<span class="nc" id="L239">							+ &quot; had differing Prerequisites for &quot; + getFullName());</span>
<span class="nc" id="L240">						return null;</span>
					}
<span class="nc" id="L242">					prereq = p;</span>
				}
<span class="fc" id="L244">				sb.append(ab);</span>
<span class="fc" id="L245">			}</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">			if (prereq != null)</span>
			{
<span class="nc" id="L248">				StringWriter swriter = new StringWriter();</span>
				try
				{
<span class="nc" id="L251">					prereqWriter.write(swriter, prereq);</span>
				}
<span class="nc" id="L253">				catch (PersistenceLayerException e)</span>
				{
<span class="nc" id="L255">					context.addWriteMessage(&quot;Error writing Prerequisite: &quot; + e);</span>
<span class="nc" id="L256">					return null;</span>
<span class="nc" id="L257">				}</span>
<span class="nc" id="L258">				sb.append('|').append(swriter.toString());</span>
			}
		}
<span class="fc bfc" id="L261" title="All 4 branches covered.">		if (foundAny &amp;&amp; foundOther)</span>
		{
<span class="fc" id="L263">			context.addWriteMessage(&quot;Non-sensical &quot; + getFullName() + &quot;: Contains ANY and a specific reference: &quot; + sb);</span>
<span class="fc" id="L264">			return null;</span>
		}
<span class="fc bfc" id="L266" title="All 2 branches covered.">		if (sb.length() == 0)</span>
		{
			// okay
<span class="fc" id="L269">			return null;</span>
		}
<span class="fc" id="L271">		return new String[]{sb.toString()};</span>
	}

	@Override
	public Class&lt;CDOMObject&gt; getTokenClass()
	{
<span class="fc" id="L277">		return CDOMObject.class;</span>
	}

	@Override
	public void applyChoice(ChooseDriver obj, Language l, PlayerCharacter pc)
	{
<span class="fc" id="L283">		pc.addAutoLanguage(l, obj);</span>
<span class="fc" id="L284">	}</span>

	@Override
	public void removeChoice(ChooseDriver obj, Language l, PlayerCharacter pc)
	{
<span class="fc" id="L289">		pc.removeAutoLanguage(l, obj);</span>
<span class="fc" id="L290">	}</span>

	@Override
	public Class&lt;Language&gt; getChoiceClass()
	{
<span class="fc" id="L295">		return LANGUAGE_CLASS;</span>
	}

	@Override
	public String getSource()
	{
<span class="fc" id="L301">		return getTokenName();</span>
	}

	@Override
	public String getLstFormat()
	{
<span class="fc" id="L307">		return Constants.LST_PERCENT_LIST;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>