<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Prerequisite.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.core.prereq</a> &gt; <span class="el_source">Prerequisite.java</span></div><h1>Prerequisite.java</h1><pre class="source lang-java linenums">/*
 * Prerequisite.java Copyright 2003 (C) Frugal &lt;frugal@purplewombat.co.uk&gt;
 *
 * This library is free software; you can redistribute it and/or modify it under the terms of the GNU Lesser General
 * Public License as published by the Free Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied
 * warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Lesser General Public License along with this library; if not, write to
 * the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.core.prereq;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.regex.Pattern;

import pcgen.cdom.base.Constants;
import pcgen.system.LanguageBundle;

/**
 * The Class {@code Prerequisite} is the storage format for all
 * prerequisites. It is populated by a parser, written out by a writer
 * and tested by a Tester class. Each kind of prerequisite will have 
 * one of each of these three classes that is responsible for managing
 * its lifecycle. 
 */
<span class="fc" id="L32">public class Prerequisite implements Cloneable</span>
{

<span class="fc" id="L35">	private static final String PERCENT_CHOICE_PATTERN = Pattern.quote(Constants.LST_PERCENT_CHOICE);</span>
	/** Kind to be used for a clear prerequisite request. */
	public static final String APPLY_KIND = &quot;APPLY&quot;;

	private String kind;
<span class="fc" id="L40">	private String key = null;</span>
<span class="fc" id="L41">	private String subKey = null;</span>
	private List&lt;Prerequisite&gt; prerequisites;
<span class="fc" id="L43">	private PrerequisiteOperator operator = PrerequisiteOperator.GTEQ;</span>
<span class="fc" id="L44">	private String operand = &quot;1&quot;; //$NON-NLS-1$</span>
	/** Indicates that the total of skill ranks, class levels etc should be
	 * added together when checking for a value.
	 */
	private boolean totalValues;

	/** Is a character required to test this prereq against?. */
<span class="fc" id="L51">	private boolean characterRequired = true;</span>

	/** Indicates that the number of qualifying objects should be tallied when checking for a value. */
	private boolean countMultiples;
<span class="fc" id="L55">	private boolean overrideQualify = false;</span>

	/** Used for abilities only - the category to restrict matches to. */
	private String categoryName;

	/**
	 * @return Returns the totalValues.
	 */
	public final boolean isTotalValues()
	{
<span class="fc" id="L65">		return totalValues;</span>
	}

	/**
	 * Sets the totalValues attribute.
	 * @param val The value to set TotalValues to.
	 */
	public final void setTotalValues(final boolean val)
	{
<span class="nc" id="L74">		this.totalValues = val;</span>
<span class="nc" id="L75">	}</span>

	/**
	 * Sets the countMultiples attribute.
	 * @param val
	 *            The value to set countMultiples to.
	 */
	public void setCountMultiples(final boolean val)
	{
<span class="fc" id="L84">		this.countMultiples = val;</span>
<span class="fc" id="L85">	}</span>

	/**
	 * @return Returns the countMultiples.
	 */
	public boolean isCountMultiples()
	{
<span class="nc" id="L92">		return countMultiples;</span>
	}

	/**
	 * Set the key.
	 * @param val the Key to set.
	 */
	public void setKey(final String val)
	{
<span class="fc" id="L101">		this.key = val;</span>
<span class="fc" id="L102">	}</span>

	/**
	 * Get the key.
	 * @return the prerequisite's key.
	 */
	public String getKey()
	{
<span class="fc" id="L110">		return key;</span>
	}

	/**
	 * Set the kind attribute.
	 * @param val
	 *            The value to set kind to.
	 */
	public void setKind(final String val)
	{
<span class="fc" id="L120">		this.kind = val;</span>
<span class="fc" id="L121">	}</span>

	/**
	 * @return Returns the kind.
	 */
	public String getKind()
	{
<span class="fc" id="L128">		return kind;</span>
	}

	/**
	 * Set the operand attribute.
	 * @param val
	 *            The value to set the operand to.
	 */
	public void setOperand(final String val)
	{
<span class="fc" id="L138">		this.operand = val;</span>
<span class="fc" id="L139">	}</span>

	/**
	 * @return Returns the operand.
	 */
	public String getOperand()
	{
<span class="fc" id="L146">		return operand;</span>
	}

	/**
	 * Sets an operator attribute from the name of the operator.
	 * @param operator
	 *            The name of the operator to set in the object.
	 * @throws PrerequisiteException throws an exception if it can't locate the operator.
	 */
	public void setOperator(final String operator) throws PrerequisiteException
	{
<span class="fc" id="L157">		this.operator = PrerequisiteOperator.getOperatorByName(operator);</span>
<span class="fc" id="L158">	}</span>

	/**
	 * @param operator The operator to set.
	 */
	public void setOperator(final PrerequisiteOperator operator)
	{
<span class="fc" id="L165">		this.operator = operator;</span>
<span class="fc" id="L166">	}</span>

	/**
	 * @return Returns the operator.
	 */
	public PrerequisiteOperator getOperator()
	{
<span class="fc" id="L173">		return operator;</span>
	}

	public void addPrerequisite(final Prerequisite prereq)
	{
<span class="fc bfc" id="L178" title="All 2 branches covered.">		if (prerequisites == null)</span>
		{
<span class="fc" id="L180">			prerequisites = new ArrayList&lt;&gt;();</span>
		}
<span class="fc" id="L182">		prerequisites.add(prereq);</span>
<span class="fc" id="L183">	}</span>

	public List&lt;Prerequisite&gt; getPrerequisites()
	{
<span class="fc bfc" id="L187" title="All 2 branches covered.">		if (prerequisites == null)</span>
		{
<span class="fc" id="L189">			return Collections.emptyList();</span>
		}
<span class="fc" id="L191">		return Collections.unmodifiableList(prerequisites);</span>
	}

	/**
	 * @param subKey
	 *            The subKey to set.
	 */
	public void setSubKey(final String subKey)
	{
<span class="fc" id="L200">		this.subKey = subKey;</span>
<span class="fc" id="L201">	}</span>

	/**
	 * @return Returns the subKey.
	 */
	public String getSubKey()
	{
<span class="fc" id="L208">		return subKey;</span>
	}

	@Override
	public String toString()
	{
<span class="nc" id="L214">		final StringBuilder buf = new StringBuilder(250);</span>

<span class="nc" id="L216">		buf.append(&quot;&lt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L217">		buf.append(LanguageBundle.getString(&quot;Prerequisite.prereq_tag&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L218">		buf.append(&quot; &quot;); //$NON-NLS-1$</span>

<span class="nc bnc" id="L220" title="All 2 branches missed.">		if (kind != null)</span>
		{
<span class="nc" id="L222">			buf.append(LanguageBundle.getString(&quot;Prerequisite.kind&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L223">			buf.append(&quot;=\&quot;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L224">			buf.append(kind);</span>
<span class="nc" id="L225">			buf.append(&quot;\&quot; &quot;); //$NON-NLS-1$</span>
		}

<span class="nc bnc" id="L228" title="All 2 branches missed.">		if (countMultiples)</span>
		{
<span class="nc" id="L230">			buf.append(LanguageBundle.getString(&quot;Prerequisite.count-multiples&quot;)); //$NON-NLS-1$</span>
		}

<span class="nc bnc" id="L233" title="All 2 branches missed.">		if (totalValues)</span>
		{
<span class="nc" id="L235">			buf.append(LanguageBundle.getString(&quot;Prerequisite.total-values&quot;)); //$NON-NLS-1$</span>
		}

<span class="nc bnc" id="L238" title="All 2 branches missed.">		if (categoryName != null)</span>
		{
<span class="nc" id="L240">			buf.append(LanguageBundle.getString(&quot;Prerequisite.category&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L241">			buf.append(&quot;=\&quot;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L242">			buf.append(categoryName);</span>
<span class="nc" id="L243">			buf.append(&quot;\&quot; &quot;); //$NON-NLS-1$</span>
		}

<span class="nc bnc" id="L246" title="All 2 branches missed.">		if (key != null)</span>
		{
<span class="nc" id="L248">			buf.append(LanguageBundle.getString(&quot;Prerequisite.key&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L249">			buf.append(&quot;=\&quot;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L250">			buf.append(key);</span>
<span class="nc" id="L251">			buf.append(&quot;\&quot; &quot;); //$NON-NLS-1$</span>
		}

<span class="nc bnc" id="L254" title="All 4 branches missed.">		if ((subKey != null) &amp;&amp; !subKey.equals(&quot;&quot;)) //$NON-NLS-1$</span>
		{
<span class="nc" id="L256">			buf.append(LanguageBundle.getString(&quot;Prerequisite.sub-key&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L257">			buf.append(&quot;=\&quot;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L258">			buf.append(subKey);</span>
<span class="nc" id="L259">			buf.append(&quot;\&quot; &quot;); //$NON-NLS-1$</span>
		}

<span class="nc" id="L262">		buf.append(LanguageBundle.getString(&quot;Prerequisite.operator&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L263">		buf.append(&quot;=\&quot;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L264">		buf.append(operator);</span>
<span class="nc" id="L265">		buf.append(&quot;\&quot; &quot;); //$NON-NLS-1$</span>

<span class="nc bnc" id="L267" title="All 2 branches missed.">		if (operand != null)</span>
		{
<span class="nc" id="L269">			buf.append(LanguageBundle.getString(&quot;Prerequisite.operand&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L270">			buf.append(&quot;=\&quot;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L271">			buf.append(operand);</span>
<span class="nc" id="L272">			buf.append(&quot;\&quot; &quot;); //$NON-NLS-1$</span>
		}

<span class="nc bnc" id="L275" title="All 2 branches missed.">		if (isOverrideQualify())</span>
		{
<span class="nc" id="L277">			buf.append(LanguageBundle.getString(&quot;Prerequisite.override-qualify&quot;)); //$NON-NLS-1$</span>
		}

<span class="nc" id="L280">		buf.append(&quot;&gt;\n&quot;); //$NON-NLS-1$</span>

<span class="nc bnc" id="L282" title="All 2 branches missed.">		if (prerequisites != null)</span>
		{
<span class="nc bnc" id="L284" title="All 2 branches missed.">			for (Prerequisite prereq : prerequisites)</span>
			{
<span class="nc" id="L286">				buf.append(prereq);</span>
<span class="nc" id="L287">			}</span>
		}

<span class="nc" id="L290">		buf.append(&quot;&lt;/&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L291">		buf.append(LanguageBundle.getString(&quot;Prerequisite.prereq_tag&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L292">		buf.append(&quot;&gt;\n&quot;); //$NON-NLS-1$</span>

<span class="nc" id="L294">		return buf.toString();</span>
	}

	/**
	 * @return Returns the overrideQualify.
	 */
	public boolean isOverrideQualify()
	{
<span class="fc" id="L302">		return overrideQualify;</span>
	}

	/**
	 * Setter for the overrideQualify field.
	 * @param override
	 *            Whether to override the qualifications.
	 */
	public void setOverrideQualify(final boolean override)
	{
<span class="fc" id="L312">		this.overrideQualify = override;</span>
<span class="fc" id="L313">	}</span>

	@Override
	public Prerequisite clone() throws CloneNotSupportedException
	{
<span class="nc" id="L318">		final Prerequisite copy = (Prerequisite) super.clone();</span>

<span class="nc bnc" id="L320" title="All 2 branches missed.">		if (prerequisites != null)</span>
		{
<span class="nc" id="L322">			copy.prerequisites = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">			for (Prerequisite subreq : prerequisites)</span>
			{
<span class="nc" id="L325">				copy.prerequisites.add(subreq.clone());</span>
<span class="nc" id="L326">			}</span>
		}

<span class="nc" id="L329">		return copy;</span>
	}

	/**
	 * Retrieve the description of the prerequisite. This can either be
	 * in long form 'skill TUMBLE gteq 5' or in short form 'TUMBLE'.
	 * 
	 * @param shortForm True if the abbreviated form should be used.
	 * 
	 * @return The description of the prerequisite
	 */
	public String getDescription(final boolean shortForm)
	{
<span class="nc" id="L342">		final StringBuilder buf = new StringBuilder(250);</span>

<span class="nc bnc" id="L344" title="All 4 branches missed.">		if (categoryName != null &amp;&amp; !shortForm)</span>
		{
<span class="nc" id="L346">			buf.append(&quot;of category &quot;);</span>
<span class="nc" id="L347">			buf.append(categoryName);</span>
<span class="nc" id="L348">			buf.append(&quot;:&quot;);</span>
<span class="nc" id="L349">			buf.append(' ');</span>

		}

<span class="nc bnc" id="L353" title="All 4 branches missed.">		if (kind != null &amp;&amp; !shortForm)</span>
		{
<span class="nc" id="L355">			buf.append(kind);</span>
<span class="nc" id="L356">			buf.append(' ');</span>
		}

<span class="nc bnc" id="L359" title="All 2 branches missed.">		if (key != null)</span>
		{
<span class="nc" id="L361">			buf.append(key);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">			if (!shortForm)</span>
			{
<span class="nc" id="L364">				buf.append(' ');</span>
			}
		}

<span class="nc bnc" id="L368" title="All 4 branches missed.">		if ((subKey != null) &amp;&amp; !subKey.equals(&quot;&quot;)) //$NON-NLS-1$</span>
		{
<span class="nc" id="L370">			buf.append('(');</span>
<span class="nc" id="L371">			buf.append(subKey);</span>
<span class="nc" id="L372">			buf.append(')');</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">			if (!shortForm)</span>
			{
<span class="nc" id="L375">				buf.append(' ');</span>
			}
		}

<span class="nc bnc" id="L379" title="All 2 branches missed.">		if (!shortForm)</span>
		{
<span class="nc" id="L381">			buf.append(operator);</span>
<span class="nc" id="L382">			buf.append(' ');</span>
		}

<span class="nc bnc" id="L385" title="All 4 branches missed.">		if (operand != null &amp;&amp; !shortForm)</span>
		{
<span class="nc" id="L387">			buf.append(operand);</span>
		}

<span class="nc bnc" id="L390" title="All 6 branches missed.">		if (prerequisites != null &amp;&amp; !prerequisites.isEmpty() &amp;&amp; !shortForm)</span>
		{
<span class="nc" id="L392">			buf.append(&quot; (&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">			for (Prerequisite subreq : prerequisites)</span>
			{
<span class="nc" id="L395">				buf.append(subreq.getDescription(false));</span>
<span class="nc" id="L396">			}</span>
<span class="nc" id="L397">			buf.append(')');</span>
		}

<span class="nc" id="L400">		return buf.toString();</span>
	}

	/**
	 * @return the categoryName
	 */
	public String getCategoryName()
	{
<span class="fc" id="L408">		return categoryName;</span>
	}

	/**
	 * @param categoryName the categoryName to set
	 */
	public void setCategoryName(String categoryName)
	{
<span class="fc" id="L416">		this.categoryName = categoryName;</span>
<span class="fc" id="L417">	}</span>

	@Override
	public int hashCode()
	{
<span class="pc bpc" id="L422" title="1 of 4 branches missed.">		return (kind == null ? -1 : kind.hashCode()) ^ (key == null ? 0 : key.hashCode());</span>
	}

	@Override
	public boolean equals(Object o)
	{
<span class="fc bfc" id="L428" title="All 2 branches covered.">		if (o == this)</span>
		{
<span class="fc" id="L430">			return true;</span>
		}
<span class="pc bpc" id="L432" title="1 of 2 branches missed.">		if (!(o instanceof Prerequisite other))</span>
		{
<span class="nc" id="L434">			return false;</span>
		}
<span class="fc bfc" id="L436" title="All 2 branches covered.">		if (kind == null)</span>
		{
<span class="pc bpc" id="L438" title="1 of 2 branches missed.">			if (other.kind != null)</span>
			{
<span class="nc" id="L440">				return false;</span>
			}
		}
<span class="fc bfc" id="L443" title="All 2 branches covered.">		if (key == null)</span>
		{
<span class="fc bfc" id="L445" title="All 2 branches covered.">			if (other.key != null)</span>
			{
<span class="fc" id="L447">				return false;</span>
			}
		}
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">		if (subKey == null)</span>
		{
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">			if (other.subKey != null)</span>
			{
<span class="nc" id="L454">				return false;</span>
			}
		}
<span class="pc bpc" id="L457" title="1 of 2 branches missed.">		if (categoryName == null)</span>
		{
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">			if (other.categoryName != null)</span>
			{
<span class="nc" id="L461">				return false;</span>
			}
		}
<span class="pc bpc" id="L464" title="1 of 4 branches missed.">		boolean iHave = prerequisites != null &amp;&amp; !prerequisites.isEmpty();</span>
<span class="pc bpc" id="L465" title="1 of 4 branches missed.">		boolean otherHas = other.prerequisites != null &amp;&amp; !other.prerequisites.isEmpty();</span>
<span class="fc bfc" id="L466" title="All 2 branches covered.">		if (iHave)</span>
		{
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">			if (!otherHas)</span>
			{
<span class="nc" id="L470">				return false;</span>
			}
<span class="fc" id="L472">			List&lt;Prerequisite&gt; otherPRL = other.prerequisites;</span>
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">			if (otherPRL.size() != prerequisites.size())</span>
			{
<span class="nc" id="L475">				return false;</span>
			}
<span class="fc" id="L477">			ArrayList&lt;Prerequisite&gt; removed = new ArrayList&lt;&gt;(prerequisites);</span>
<span class="fc" id="L478">			removed.removeAll(otherPRL);</span>
<span class="pc bpc" id="L479" title="1 of 2 branches missed.">			if (!removed.isEmpty())</span>
			{
<span class="nc" id="L481">				return false;</span>
			}
<span class="fc" id="L483">		}</span>
<span class="fc bfc" id="L484" title="All 2 branches covered.">		else if (otherHas)</span>
		{
<span class="fc" id="L486">			return false;</span>
		}
<span class="pc bpc" id="L488" title="2 of 8 branches missed.">		return countMultiples == other.countMultiples &amp;&amp; overrideQualify == other.overrideQualify</span>
<span class="fc bfc" id="L489" title="All 4 branches covered.">			&amp;&amp; operator == other.operator &amp;&amp; (kind == null || kind.equals(other.kind))</span>
<span class="pc bpc" id="L490" title="3 of 6 branches missed.">			&amp;&amp; (key == null || key.equals(other.key)) &amp;&amp; (subKey == null || subKey.equals(other.subKey))</span>
<span class="pc bpc" id="L491" title="4 of 6 branches missed.">			&amp;&amp; operand.equals(other.operand) &amp;&amp; (categoryName == null || categoryName.equals(other.categoryName));</span>
	}

	/**
	 * Checks if a character is required to test this prerequisite.
	 * 
	 * @return true, if a character required
	 */
	public boolean isCharacterRequired()
	{
<span class="nc" id="L501">		return characterRequired;</span>
	}

	/**
	 * Sets whether a character is required.
	 * 
	 * @param characterRequired is a character required
	 */
	public void setCharacterRequired(boolean characterRequired)
	{
<span class="fc" id="L511">		this.characterRequired = characterRequired;</span>
<span class="fc" id="L512">	}</span>

<span class="fc" id="L514">	private boolean nativeCheckMult = false;</span>

	public void setOriginalCheckmult(boolean b)
	{
<span class="fc" id="L518">		nativeCheckMult = b;</span>
<span class="fc" id="L519">	}</span>

	public boolean isOriginalCheckMult()
	{
<span class="fc" id="L523">		return nativeCheckMult;</span>
	}

	public Prerequisite specify(String assoc) throws CloneNotSupportedException
	{
<span class="nc" id="L528">		final Prerequisite copy = (Prerequisite) super.clone();</span>
		//PREMULT has no key or operand
<span class="nc bnc" id="L530" title="All 2 branches missed.">		if (copy.key != null)</span>
		{
<span class="nc" id="L532">			copy.key = copy.key.replaceAll(PERCENT_CHOICE_PATTERN, assoc);</span>
		}
<span class="nc bnc" id="L534" title="All 2 branches missed.">		if (copy.operand != null)</span>
		{
<span class="nc" id="L536">			copy.operand = copy.operand.replaceAll(PERCENT_CHOICE_PATTERN, assoc);</span>
		}

<span class="nc bnc" id="L539" title="All 2 branches missed.">		if (prerequisites != null)</span>
		{
<span class="nc" id="L541">			copy.prerequisites = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">			for (Prerequisite subreq : prerequisites)</span>
			{
<span class="nc" id="L544">				copy.prerequisites.add(subreq.specify(assoc));</span>
<span class="nc" id="L545">			}</span>
		}
<span class="nc" id="L547">		return copy;</span>
	}

	public int getPrerequisiteCount()
	{
<span class="pc bpc" id="L552" title="1 of 2 branches missed.">		return prerequisites == null ? 0 : prerequisites.size();</span>
	}

	public void removePrerequisite(Prerequisite p)
	{
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">		if (prerequisites != null)</span>
		{
<span class="fc" id="L559">			prerequisites.remove(p);</span>
		}
<span class="fc" id="L561">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>