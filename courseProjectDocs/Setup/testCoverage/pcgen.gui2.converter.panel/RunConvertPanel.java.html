<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RunConvertPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.converter.panel</a> &gt; <span class="el_source">RunConvertPanel.java</span></div><h1>RunConvertPanel.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2009 (C) James Dempsey
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */

package pcgen.gui2.converter.panel;

import java.awt.Component;
import java.awt.Dimension;
import java.awt.FontMetrics;
import java.awt.Graphics;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.Writer;
import java.net.URI;
import java.nio.charset.StandardCharsets;
import java.time.Clock;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Objects;
import java.util.Observable;
import java.util.Observer;
import java.util.concurrent.CompletableFuture;
import java.util.logging.Handler;
import java.util.logging.LogRecord;

import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JProgressBar;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import javax.swing.SwingUtilities;

import pcgen.cdom.base.CDOMObject;
import pcgen.cdom.enumeration.IntegerKey;
import pcgen.cdom.enumeration.ListKey;
import pcgen.cdom.enumeration.ObjectKey;
import pcgen.core.Campaign;
import pcgen.core.GameMode;
import pcgen.core.Globals;
import pcgen.core.SettingsHandler;
import pcgen.gui2.converter.ConversionDecider;
import pcgen.gui2.converter.LSTConverter;
import pcgen.gui2.converter.ObjectInjector;
import pcgen.gui2.converter.event.ProgressEvent;
import pcgen.gui2.converter.event.TaskStrategyMessage;
import pcgen.gui2.tools.Utility;
import pcgen.io.PCGFile;
import pcgen.persistence.lst.CampaignSourceEntry;
import pcgen.rules.context.EditorLoadContext;
import pcgen.system.LanguageBundle;
import pcgen.system.PCGenPropBundle;
import pcgen.system.PCGenSettings;
import pcgen.system.PropertyContext;
import pcgen.util.Logging;

/**
 * The Class {@code RunConvertPanel} provides a display while
 * the conversion is being run.
 */
public class RunConvertPanel extends ConvertSubPanel implements Observer, ConversionDecider
{
<span class="nc" id="L83">	private int currentFileCount = 0;</span>

	private JProgressBar progressBar;
	private ArrayList&lt;Campaign&gt; totalCampaigns;
	private final EditorLoadContext context;
	private JTextArea messageArea;
<span class="nc" id="L89">	private String lastNotifiedFilename = &quot;&quot;;</span>
<span class="nc" id="L90">	private String currFilename = &quot;&quot;;</span>
	private final Component statusField;
	private final File changeLogFile;

	public RunConvertPanel(Component statusField)
<span class="nc" id="L95">	{</span>
<span class="nc" id="L96">		context = new EditorLoadContext();</span>
<span class="nc" id="L97">		this.statusField = statusField;</span>
<span class="nc" id="L98">		PropertyContext context = PCGenSettings.getInstance();</span>
<span class="nc" id="L99">		String dataLogFileName = context.initProperty(PCGenSettings.CONVERT_DATA_LOG_FILE, &quot;dataChanges.log&quot;);</span>
<span class="nc" id="L100">		changeLogFile = new File(dataLogFileName);</span>
<span class="nc" id="L101">	}</span>

	@Override
	public boolean autoAdvance(CDOMObject pc)
	{
<span class="nc" id="L106">		return false;</span>
	}

	@Override
	public boolean performAnalysis(final CDOMObject pc)
	{
<span class="nc" id="L112">		logSummary(pc);</span>

<span class="nc" id="L114">		final File rootDir = pc.get(ObjectKey.DIRECTORY);</span>
<span class="nc" id="L115">		final File outDir = pc.get(ObjectKey.WRITE_DIRECTORY);</span>
<span class="nc" id="L116">		totalCampaigns = new ArrayList&lt;&gt;(pc.getSafeListFor(ListKey.CAMPAIGN));</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">		for (CDOMObject campaign : pc.getSafeListFor(ListKey.CAMPAIGN))</span>
		{
			// Add all sub-files to the main campaign, regardless of exclusions
<span class="nc" id="L120">			campaign.getSafeListFor(ListKey.FILE_PCC)</span>
<span class="nc" id="L121">			        .stream()</span>
<span class="nc" id="L122">			        .map(CampaignSourceEntry::getURI)</span>
<span class="nc" id="L123">			        .filter(PCGFile::isPCGenCampaignFile)</span>
<span class="nc" id="L124">			        .map(uri -&gt; Globals.getCampaignByURI(uri, false))</span>
<span class="nc" id="L125">			        .filter(Objects::nonNull)</span>
<span class="nc" id="L126">			        .forEach(totalCampaigns::add);</span>
<span class="nc" id="L127">		}</span>
<span class="nc" id="L128">		sortCampaignsByRank(totalCampaigns);</span>

<span class="nc" id="L130">		new Thread(() -&gt; {</span>
<span class="nc" id="L131">			Logging.registerHandler(getHandler());</span>
<span class="nc" id="L132">			SettingsHandler.setGame(pc.get(ObjectKey.GAME_MODE).getName());</span>
<span class="nc" id="L133">			GameMode mode = SettingsHandler.getGameAsProperty().get();</span>
			//Necessary for &quot;good&quot; behavior
<span class="nc" id="L135">			mode.resolveInto(context.getReferenceContext());</span>
			//Necessary for those still using Globals.getContext
<span class="nc" id="L137">			mode.resolveInto(mode.getContext().getReferenceContext());</span>
			LSTConverter converter;
<span class="nc" id="L139">			try(Writer changeLogWriter = new FileWriter(changeLogFile, StandardCharsets.UTF_8))</span>
			{
<span class="nc" id="L141">				String startTime = LocalDateTime.now(Clock.systemUTC()).toString();</span>
<span class="nc" id="L142">				changeLogWriter.append(&quot;PCGen Data Converter v&quot;)</span>
<span class="nc" id="L143">				               .append(PCGenPropBundle.getVersionNumber())</span>
<span class="nc" id="L144">				               .append(&quot; - conversion started at &quot;)</span>
<span class="nc" id="L145">				               .append(startTime)</span>
<span class="nc" id="L146">				               .append(&quot;\n&quot;);</span>
<span class="nc" id="L147">				changeLogWriter.append(&quot;Outputting files to &quot;).append(outDir.getAbsolutePath()).append(&quot;\n&quot;);</span>
<span class="nc" id="L148">				converter = new LSTConverter(context, rootDir, outDir.getAbsolutePath(), this, changeLogWriter);</span>
<span class="nc" id="L149">				converter.addObserver(this);</span>
<span class="nc" id="L150">				int numFiles = totalCampaigns.stream()</span>
<span class="nc" id="L151">				                             .mapToInt(converter::getNumFilesInCampaign)</span>
<span class="nc" id="L152">				                             .sum();</span>
<span class="nc" id="L153">				setTotalFileCount(numFiles);</span>
<span class="nc" id="L154">				converter.initCampaigns(totalCampaigns);</span>
<span class="nc" id="L155">				totalCampaigns.forEach(converter::processCampaign);</span>
<span class="nc" id="L156">				ObjectInjector oi = new ObjectInjector(context, outDir, rootDir, converter);</span>
<span class="nc" id="L157">				oi.writeInjectedObjects(totalCampaigns);</span>
			}
<span class="nc" id="L159">			catch (IOException e1)</span>
			{
<span class="nc" id="L161">				Logging.errorPrint(&quot;Failed to initialise LSTConverter&quot;, e1);</span>
<span class="nc" id="L162">				return;</span>
<span class="nc" id="L163">			}</span>

<span class="nc" id="L165">			converter.deleteObserver(this);</span>
<span class="nc" id="L166">			Logging.removeHandler(getHandler());</span>
			try
			{
				// Wait for any left over messages to catch up
<span class="nc" id="L170">				Thread.sleep(1000);</span>
			}
<span class="nc" id="L172">			catch (InterruptedException e)</span>
			{
				// Ignore exception
<span class="nc" id="L175">			}</span>
<span class="nc" id="L176">			setCurrentFilename(&quot;&quot;);</span>
<span class="nc" id="L177">			addMessage(&quot;\nConversion complete.&quot;);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">			if (getHandler().getNumErrors() &gt; 0)</span>
			{
<span class="nc" id="L180">				JOptionPane.showMessageDialog(</span>
<span class="nc" id="L181">					null, LanguageBundle.getFormattedString(&quot;in_lstConvErrorsFound&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L182">					getHandler().getNumErrors()), LanguageBundle.getString(&quot;in_lstConvErrorsTitle&quot;), //$NON-NLS-1$</span>
					JOptionPane.ERROR_MESSAGE);
			}
<span class="nc" id="L185">			progressBar.setValue(progressBar.getMaximum());</span>

<span class="nc" id="L187">			fireProgressEvent(ProgressEvent.AUTO_ADVANCE);</span>
<span class="nc" id="L188">		}).start();</span>
<span class="nc" id="L189">		return true;</span>
	}

	@Override
	public void setupDisplay(JPanel panel, CDOMObject pc)
	{
<span class="nc" id="L195">		panel.setLayout(new GridBagLayout());</span>

<span class="nc" id="L197">		JLabel introLabel = new JLabel(&quot;Conversion in progress&quot;);</span>
<span class="nc" id="L198">		GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L199">		Utility.buildRelativeConstraints(gbc, GridBagConstraints.REMAINDER, 1, 1.0, 0);</span>
<span class="nc" id="L200">		gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L201">		gbc.insets = new Insets(0, 10, 5, 10);</span>
<span class="nc" id="L202">		panel.add(introLabel, gbc);</span>

<span class="nc" id="L204">		JLabel explainLabel = new JLabel(&quot;&lt;html&gt;The LST data is being converted. In the log, &quot;</span>
			+ &quot;LSTERROR rows are errors that need to be manually corrected in the source data. &quot;
<span class="nc" id="L206">			+ &quot;LSTWARN rows indicate changes the converter is making. &quot; + &quot;See &quot; + changeLogFile.getAbsolutePath()</span>
			+ &quot; for a log of all data changes.&lt;/html&gt;&quot;);
<span class="nc" id="L208">		explainLabel.setFocusable(true);</span>
<span class="nc" id="L209">		Utility.buildRelativeConstraints(gbc, GridBagConstraints.REMAINDER, 1, 1.0, 0);</span>
<span class="nc" id="L210">		gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L211">		gbc.insets = new Insets(0, 10, 5, 10);</span>
<span class="nc" id="L212">		panel.add(explainLabel, gbc);</span>

<span class="nc" id="L214">		progressBar = getProgressBar();</span>
<span class="nc" id="L215">		Dimension d = progressBar.getPreferredSize();</span>
<span class="nc" id="L216">		d.width = 400;</span>
<span class="nc" id="L217">		progressBar.setPreferredSize(d);</span>
<span class="nc" id="L218">		progressBar.setStringPainted(true);</span>
<span class="nc" id="L219">		Utility.buildRelativeConstraints(gbc, GridBagConstraints.REMAINDER, 1, 1.0, 0);</span>
<span class="nc" id="L220">		gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L221">		panel.add(progressBar, gbc);</span>

<span class="nc" id="L223">		Component messageAreaContainer = new JScrollPane(getMessageArea());</span>
<span class="nc" id="L224">		Utility.buildRelativeConstraints(gbc, GridBagConstraints.REMAINDER, GridBagConstraints.REMAINDER, 1.0, 1.0);</span>
<span class="nc" id="L225">		gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L226">		panel.add(messageAreaContainer, gbc);</span>

<span class="nc" id="L228">		panel.setPreferredSize(new Dimension(800, 500));</span>
<span class="nc" id="L229">	}</span>

<span class="nc" id="L231">	private LoadHandler handler = null;</span>

	private LoadHandler getHandler()
	{
<span class="nc bnc" id="L235" title="All 2 branches missed.">		if (handler == null)</span>
		{
<span class="nc" id="L237">			handler = new LoadHandler();</span>
		}
<span class="nc" id="L239">		return handler;</span>
	}

	private void setCurrentFilename(String filename)
	{
<span class="nc" id="L244">		Graphics g = statusField.getGraphics();</span>
<span class="nc" id="L245">		FontMetrics fm = g.getFontMetrics();</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">		String message = (filename == null || filename.isEmpty()) ? &quot;&quot; : &quot;Converting &quot; + filename;</span>
<span class="nc" id="L247">		int width = fm.stringWidth(message);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">		if (width &gt;= statusField.getWidth())</span>
		{
<span class="nc" id="L250">			message = Utility.shortenString(fm, message, statusField.getWidth());</span>
		}

<span class="nc" id="L253">		TaskStrategyMessage.sendStatus(this, message);</span>
<span class="nc" id="L254">		currFilename = filename;</span>
<span class="nc" id="L255">	}</span>

	private void addMessage(String message)
	{
<span class="nc bnc" id="L259" title="All 4 branches missed.">		if (!currFilename.isEmpty() &amp;&amp; !currFilename.equals(lastNotifiedFilename))</span>
		{
<span class="nc" id="L261">			getMessageArea().append(&quot;\n&quot; + currFilename + &quot;\n&quot;);</span>
<span class="nc" id="L262">			lastNotifiedFilename = currFilename;</span>
		}
<span class="nc" id="L264">		getMessageArea().append(message + &quot;\n&quot;);</span>
<span class="nc" id="L265">	}</span>

	/**
	 * This method initializes progressBar
	 *
	 * @return javax.swing.JProgressBar
	 */
	private JProgressBar getProgressBar()
	{
<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (progressBar == null)</span>
		{
<span class="nc" id="L276">			progressBar = new JProgressBar();</span>
<span class="nc" id="L277">			progressBar.setValue(0);</span>
<span class="nc" id="L278">			progressBar.setStringPainted(true);</span>
		}

<span class="nc" id="L281">		return progressBar;</span>
	}

	/**
	 * This method initializes messageArea
	 *
	 * @return javax.swing.JTextArea
	 */
	private JTextArea getMessageArea()
	{
<span class="nc bnc" id="L291" title="All 2 branches missed.">		if (messageArea == null)</span>
		{
<span class="nc" id="L293">			messageArea = new JTextArea();</span>
<span class="nc" id="L294">			messageArea.setName(&quot;errorMessageBox&quot;);</span>
<span class="nc" id="L295">			messageArea.setEditable(false);</span>
<span class="nc" id="L296">			messageArea.setTabSize(8);</span>
		}

<span class="nc" id="L299">		return messageArea;</span>
	}

	@Override
	public void update(Observable o, Object arg)
	{
<span class="nc bnc" id="L305" title="All 2 branches missed.">		if (arg instanceof final URI uri)</span>
		{
<span class="nc" id="L307">			setCurrentFileCount(currentFileCount + 1);</span>

<span class="nc" id="L309">			setCurrentFilename(uri.toString());</span>
		}
<span class="nc bnc" id="L311" title="All 2 branches missed.">		else if (arg instanceof Exception)</span>
		{
<span class="nc" id="L313">			final Throwable e = (Exception) arg;</span>
<span class="nc" id="L314">			SwingUtilities.invokeLater(() -&gt; addMessage(e.getMessage()));</span>
<span class="nc" id="L315">			System.out.println(&quot;Persistence Observer: ERROR: &quot; + e.getMessage());</span>
<span class="nc" id="L316">		}</span>
		else
		{
<span class="nc" id="L319">			System.out.println(&quot;Persistence Observer: UNKNOWN: &quot; + arg);</span>
		}
<span class="nc" id="L321">	}</span>

	/**
	 * @param iFileCount The totalFileCount to set.
	 */
	private void setTotalFileCount(final int iFileCount)
	{
<span class="nc" id="L328">		Runnable doWork = () -&gt; getProgressBar().setMaximum(iFileCount);</span>
<span class="nc" id="L329">		SwingUtilities.invokeLater(doWork);</span>
<span class="nc" id="L330">	}</span>

	private void setCurrentFileCount(int curr)
	{
<span class="nc" id="L334">		currentFileCount = curr;</span>
<span class="nc" id="L335">		getProgressBar().setValue(curr);</span>
<span class="nc" id="L336">	}</span>

	/**
	 * A log handler to capture load errors and warnings and
	 * display them in the message section of the panel.
	 */
	private final class LoadHandler extends Handler
	{
<span class="nc" id="L344">		private int numErrors = 0;</span>

		private LoadHandler()
<span class="nc" id="L347">		{</span>
<span class="nc" id="L348">			setLevel(Logging.LST_WARNING);</span>
<span class="nc" id="L349">		}</span>

		@Override
		public void close()
		{
			// Nothing to do
<span class="nc" id="L355">		}</span>

		@Override
		public void flush()
		{
			// Nothing to do
<span class="nc" id="L361">		}</span>

		@Override
		public void publish(final LogRecord logRecord)
		{
<span class="nc" id="L366">			Runnable doWork = () -&gt; {</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">				if (logRecord.getLevel().intValue() &gt; Logging.WARNING.intValue())</span>
				{
<span class="nc" id="L369">					numErrors++;</span>
				}
<span class="nc" id="L371">				addMessage(logRecord.getLevel() + &quot; &quot; + logRecord.getMessage());</span>
<span class="nc" id="L372">			};</span>
<span class="nc" id="L373">			SwingUtilities.invokeLater(doWork);</span>
<span class="nc" id="L374">		}</span>

		/**
		 * @return the numErrors
		 */
		private int getNumErrors()
		{
<span class="nc" id="L381">			return numErrors;</span>
		}

	}

	@Override
	public String getConversionDecision(String overallDescription, List&lt;String&gt; choiceDescriptions,
		List&lt;String&gt; choiceTokenResults, int defaultChoice)
	{
<span class="nc" id="L390">		final ConversionChoiceDialog ccd =</span>
				new ConversionChoiceDialog(null, overallDescription, choiceDescriptions, defaultChoice);

<span class="nc" id="L393">		Runnable showDialog = () -&gt; ccd.setVisible(true);</span>
<span class="nc" id="L394">		SwingUtilities.invokeLater(showDialog);</span>
<span class="nc" id="L395">		int result = CompletableFuture.supplyAsync(ccd::getResult, SwingUtilities::invokeLater).join();</span>
<span class="nc" id="L396">		return choiceTokenResults.get(result);</span>
	}

	@Override
	public String getConversionInput(String overallDescription)
	{
<span class="nc" id="L402">		final ConversionInputDialog ccd = new ConversionInputDialog(null, overallDescription);</span>

<span class="nc" id="L404">		Runnable showDialog = () -&gt; ccd.setVisible(true);</span>
<span class="nc" id="L405">		SwingUtilities.invokeLater(showDialog);</span>
<span class="nc" id="L406">		return CompletableFuture.supplyAsync(ccd::getResult, SwingUtilities::invokeLater).join();</span>
	}

	/**
	 * This method sorts the provided list of Campaign objects by rank.
	 *
	 * @param aSelectedCampaignsList List of Campaign objects to sort
	 */
	private static void sortCampaignsByRank(final List&lt;Campaign&gt; aSelectedCampaignsList)
	{
<span class="nc" id="L416">		aSelectedCampaignsList.sort(Comparator.comparingInt(campaign -&gt; campaign.getSafe(IntegerKey.CAMPAIGN_RANK)));</span>

<span class="nc" id="L418">	}</span>

	private void logSummary(final CDOMObject pc)
	{
<span class="nc" id="L422">		Logging.log(Logging.INFO, &quot;Running data conversion using the following settings:&quot;);</span>
<span class="nc" id="L423">		Logging.log(Logging.INFO, &quot;Source Folder: &quot; + pc.get(ObjectKey.DIRECTORY).getAbsolutePath());</span>
<span class="nc" id="L424">		Logging.log(Logging.INFO, &quot;Destination Folder: &quot; + pc.get(ObjectKey.WRITE_DIRECTORY).getAbsolutePath());</span>
<span class="nc" id="L425">		Logging.log(Logging.INFO, &quot;Game mode: &quot; + pc.get(ObjectKey.GAME_MODE).getDisplayName());</span>
<span class="nc" id="L426">		List&lt;Campaign&gt; campaigns = pc.getSafeListFor(ListKey.CAMPAIGN);</span>
<span class="nc" id="L427">		StringBuilder campDisplay = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">		for (Campaign campaign : campaigns)</span>
		{
<span class="nc" id="L430">			campDisplay.append(campaign.getDisplayName());</span>
<span class="nc" id="L431">			campDisplay.append(&quot;\n&quot;);</span>
<span class="nc" id="L432">		}</span>
<span class="nc" id="L433">		Logging.log(Logging.INFO, &quot;Sources: &quot; + campDisplay);</span>
<span class="nc" id="L434">		Logging.log(Logging.INFO, &quot;Logging changes to &quot; + changeLogFile.getAbsolutePath());</span>
<span class="nc" id="L435">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>