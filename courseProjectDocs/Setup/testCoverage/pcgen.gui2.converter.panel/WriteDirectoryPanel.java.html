<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WriteDirectoryPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.converter.panel</a> &gt; <span class="el_source">WriteDirectoryPanel.java</span></div><h1>WriteDirectoryPanel.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2009 Tom Parker &lt;thpr@users.sourceforge.net&gt;
 * 
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA
 */
package pcgen.gui2.converter.panel;

import java.awt.Component;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

import javax.swing.AbstractButton;
import javax.swing.JButton;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.SpringLayout;

import pcgen.cdom.base.CDOMObject;
import pcgen.cdom.enumeration.ListKey;
import pcgen.cdom.enumeration.ObjectKey;
import pcgen.core.Campaign;
import pcgen.gui2.converter.event.ProgressEvent;
import pcgen.gui2.converter.event.TaskStrategyMessage;
import pcgen.gui3.GuiUtility;
import pcgen.system.PCGenSettings;
import pcgen.util.Logging;

import javafx.stage.DirectoryChooser;
import org.apache.commons.lang3.SystemUtils;

<span class="nc" id="L50">public class WriteDirectoryPanel extends ConvertSubPanel</span>
{

	private File path;

<span class="nc" id="L55">	private final SpringLayout layout = new SpringLayout();</span>

	private final JLabel fileLabel;
	private final JLabel warningLabel;

	private List&lt;Campaign&gt; campaignList;

	public WriteDirectoryPanel()
<span class="nc" id="L63">	{</span>
<span class="nc" id="L64">		fileLabel = new JLabel();</span>
<span class="nc" id="L65">		warningLabel = new JLabel();</span>
<span class="nc" id="L66">	}</span>

	@Override
	public boolean performAnalysis(CDOMObject pc)
	{
<span class="nc" id="L71">		TaskStrategyMessage.sendStatus(this, &quot;Finding Data Directories&quot;);</span>
<span class="nc" id="L72">		campaignList = pc.getListFor(ListKey.CAMPAIGN);</span>
<span class="nc" id="L73">		path = pc.get(ObjectKey.WRITE_DIRECTORY);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">		if (path != null)</span>
		{
<span class="nc" id="L76">			fileLabel.setText(path.getAbsolutePath());</span>
		}
		else
		{
<span class="nc" id="L80">			PCGenSettings context = PCGenSettings.getInstance();</span>
<span class="nc" id="L81">			String outputPathName = context.initProperty(PCGenSettings.CONVERT_OUTPUT_SAVE_PATH, SystemUtils.USER_DIR);</span>
<span class="nc" id="L82">			path = new File(outputPathName);</span>
		}
<span class="nc" id="L84">		pc.put(ObjectKey.WRITE_DIRECTORY, path);</span>
<span class="nc" id="L85">		fireProgressEvent(ProgressEvent.ALLOWED);</span>
<span class="nc" id="L86">		return true;</span>
	}

	@Override
	public boolean autoAdvance(CDOMObject pc)
	{
<span class="nc" id="L92">		return false;</span>
	}

	@Override
	public boolean returnAllowed()
	{
<span class="nc" id="L98">		return true;</span>
	}

	@Override
	public void setupDisplay(JPanel panel, final CDOMObject pc)
	{
<span class="nc" id="L104">		panel.setLayout(layout);</span>
<span class="nc" id="L105">		Component label = new JLabel(&quot;Please select the Directory where Converted files should be written: &quot;);</span>
<span class="nc" id="L106">		AbstractButton button = new JButton(&quot;Browse...&quot;);</span>
<span class="nc" id="L107">		button.setMnemonic('r');</span>
<span class="nc" id="L108">		button.addActionListener(arg0 -&gt; {</span>
<span class="nc" id="L109">			DirectoryChooser directoryChooser = new DirectoryChooser();</span>
<span class="nc" id="L110">			directoryChooser.setInitialDirectory(path);</span>

			while (true)
			{
<span class="nc" id="L114">				File fileToOpen = GuiUtility.runOnJavaFXThreadNow(() -&gt;</span>
<span class="nc" id="L115">						directoryChooser.showDialog(null));</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">				if (fileToOpen != null)</span>
				{
<span class="nc bnc" id="L118" title="All 2 branches missed.">					assert fileToOpen.isDirectory();</span>
<span class="nc bnc" id="L119" title="All 4 branches missed.">					if (fileToOpen.canRead() &amp;&amp; fileToOpen.canWrite())</span>
					{
<span class="nc" id="L121">						path = fileToOpen;</span>
<span class="nc" id="L122">						pc.put(ObjectKey.WRITE_DIRECTORY, path);</span>
<span class="nc" id="L123">						fileLabel.setText(path.getAbsolutePath());</span>
<span class="nc" id="L124">						PCGenSettings context = PCGenSettings.getInstance();</span>
<span class="nc" id="L125">						context.setProperty(PCGenSettings.CONVERT_OUTPUT_SAVE_PATH, path.getAbsolutePath());</span>
<span class="nc" id="L126">						showWarning();</span>
<span class="nc" id="L127">						break;</span>
					}
<span class="nc" id="L129">					JOptionPane.showMessageDialog(</span>
							null,
							&quot;Selection must be a valid &quot; + &quot;(readable &amp; writeable) Directory&quot;
					);
<span class="nc" id="L133">					directoryChooser.setInitialDirectory(path.getParentFile());</span>
				}
				else
				{
					break;
				}
<span class="nc" id="L139">			}</span>
<span class="nc" id="L140">		});</span>
<span class="nc" id="L141">		panel.add(label);</span>
<span class="nc" id="L142">		panel.add(fileLabel);</span>
<span class="nc" id="L143">		panel.add(button);</span>
<span class="nc" id="L144">		panel.add(warningLabel);</span>
<span class="nc" id="L145">		showWarning();</span>
<span class="nc" id="L146">		layout.putConstraint(SpringLayout.NORTH, label, 50, SpringLayout.NORTH, panel);</span>
<span class="nc" id="L147">		layout.putConstraint(SpringLayout.NORTH, fileLabel, 75 + label.getPreferredSize().height, SpringLayout.NORTH,</span>
				panel
		);
<span class="nc" id="L150">		layout.putConstraint(SpringLayout.NORTH, button, 75 + label.getPreferredSize().height, SpringLayout.NORTH,</span>
				panel
		);
<span class="nc" id="L153">		layout.putConstraint(SpringLayout.WEST, label, 25, SpringLayout.WEST, panel);</span>
<span class="nc" id="L154">		layout.putConstraint(SpringLayout.WEST, fileLabel, 25, SpringLayout.WEST, panel);</span>
<span class="nc" id="L155">		layout.putConstraint(SpringLayout.EAST, button, -50, SpringLayout.EAST, panel);</span>
<span class="nc" id="L156">		layout.putConstraint(SpringLayout.NORTH, warningLabel, 20, SpringLayout.SOUTH, fileLabel);</span>
<span class="nc" id="L157">		layout.putConstraint(SpringLayout.WEST, warningLabel, 25, SpringLayout.WEST, panel);</span>

<span class="nc" id="L159">		fileLabel.setText(path.getAbsolutePath());</span>
<span class="nc" id="L160">	}</span>

	private void showWarning()
	{
<span class="nc" id="L164">		List&lt;Campaign&gt; existingCampaigns = getExistingPccs();</span>
<span class="nc" id="L165">		StringBuilder warning = new StringBuilder(&quot;&lt;html&gt;&quot;);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">		if (!existingCampaigns.isEmpty())</span>
		{
<span class="nc" id="L168">			warning.append(&quot;&lt;b&gt;Warning&lt;/b&gt;: Some converted campaigns already exist in this &quot;);</span>
<span class="nc" id="L169">			warning.append(&quot;destination folder and will be skipped:\n&lt;UL&gt;&quot;);</span>
<span class="nc" id="L170">			final int maxCampaigns = 15;</span>
<span class="nc" id="L171">			int i = 1;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">			for (Campaign camp : existingCampaigns)</span>
			{
<span class="nc bnc" id="L174" title="All 4 branches missed.">				if ((i &gt;= maxCampaigns) &amp;&amp; (existingCampaigns.size() &gt; maxCampaigns))</span>
				{
<span class="nc" id="L176">					warning.append(&quot;&lt;li&gt;&quot;).append(existingCampaigns.size() - maxCampaigns + 1).append(&quot; more campaigns.&lt;/li&gt;&quot;);</span>
<span class="nc" id="L177">					break;</span>
				}
<span class="nc" id="L179">				warning.append(&quot;&lt;li&gt;&quot;);</span>
<span class="nc" id="L180">				warning.append(camp.getKeyName());</span>
<span class="nc" id="L181">				warning.append(&quot;&lt;/li&gt;&quot;);</span>
<span class="nc" id="L182">				i++;</span>
<span class="nc" id="L183">			}</span>
<span class="nc" id="L184">			warning.append(&quot;&lt;/ul&gt;&quot;);</span>
		}
<span class="nc" id="L186">		warning.append(&quot;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L187">		warningLabel.setText(warning.toString());</span>
<span class="nc" id="L188">	}</span>

	private List&lt;Campaign&gt; getExistingPccs()
	{
<span class="nc" id="L192">		List&lt;Path&gt; existingFiles = findPCCFiles(path);</span>

<span class="nc" id="L194">		List&lt;Campaign&gt; matchingCampaigns = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">		for (Campaign camp : campaignList)</span>
		{
<span class="nc" id="L198">			File campFile = new File(camp.getSourceURI());</span>
<span class="nc" id="L199">			if (existingFiles.stream()</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">			                 .anyMatch(file -&gt; file.getFileName().toString().equals(campFile.getName())))</span>
			{
<span class="nc" id="L202">				matchingCampaigns.add(camp);</span>
			}
<span class="nc" id="L204">		}</span>

<span class="nc" id="L206">		return matchingCampaigns;</span>
	}

	private static List&lt;Path&gt; findPCCFiles(File aDirectory)
	{
		try
		{
<span class="nc" id="L213">			return Files.walk(aDirectory.toPath())</span>
<span class="nc" id="L214">			            .filter(file -&gt; file.getFileName().toString().endsWith(&quot;pcc&quot;))</span>
<span class="nc" id="L215">			            .collect(Collectors.toUnmodifiableList());</span>
		}
<span class="nc" id="L217">		catch (IOException e)</span>
		{
<span class="nc" id="L219">			Logging.errorPrint(&quot;failed to walk &quot; + aDirectory, e);</span>
<span class="nc" id="L220">			return Collections.emptyList();</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>