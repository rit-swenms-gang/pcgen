<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RegionFacet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.cdom.facet.fact</a> &gt; <span class="el_source">RegionFacet.java</span></div><h1>RegionFacet.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) Thomas Parker, 2009.
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA
 */
package pcgen.cdom.facet.fact;

import java.util.Objects;
import java.util.Optional;

import pcgen.cdom.enumeration.CharID;
import pcgen.cdom.enumeration.ObjectKey;
import pcgen.cdom.enumeration.Region;
import pcgen.cdom.enumeration.StringKey;
import pcgen.cdom.facet.base.AbstractDataFacet;
import pcgen.cdom.facet.event.DataFacetChangeEvent;
import pcgen.cdom.facet.event.DataFacetChangeListener;
import pcgen.cdom.facet.model.TemplateFacet;
import pcgen.core.PCTemplate;

/**
 * RegionFacet is a Facet that tracks the Region and SubRegion of a Player
 * Character. The Region and SubRegion can be set explicitly or inferred from
 * the PCTemplate objects possessed by the PlayerCharacter.
 *
 */
<span class="fc" id="L39">public class RegionFacet extends AbstractDataFacet&lt;CharID, String&gt;</span>
		implements DataFacetChangeListener&lt;CharID, PCTemplate&gt;
{

	private TemplateFacet templateFacet;

	/**
	 * Returns the type-safe RegionCacheInfo for this RegionFacet and the given
	 * CharID. Will return a new, empty RegionCacheInfo if no Region information
	 * has been set for the given CharID. Will not return null.
	 *
	 * Note that this method SHOULD NOT be public. The RegionCacheInfo object is
	 * owned by RegionFacet, and since it can be modified, a reference to that
	 * object should not be exposed to any object other than RegionFacet.
	 *
	 * @param id
	 *            The CharID for which the RegionCacheInfo should be returned
	 * @return The RegionCacheInfo for the Player Character represented by the
	 *         given CharID.
	 */
	private RegionCacheInfo getConstructingInfo(CharID id)
	{
<span class="fc" id="L61">		RegionCacheInfo rci = getInfo(id);</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">		if (rci == null)</span>
		{
<span class="fc" id="L64">			rci = new RegionCacheInfo();</span>
<span class="fc" id="L65">			setCache(id, rci);</span>
		}
<span class="fc" id="L67">		return rci;</span>
	}

	/**
	 * Returns the type-safe RegionCacheInfo for this RegionFacet and the given
	 * CharID. May return null if no Region information has been set for the
	 * given CharID.
	 *
	 * Note that this method SHOULD NOT be public. The RegionCacheInfo object is
	 * owned by RegionFacet, and since it can be modified, a reference to that
	 * object should not be exposed to any object other than RegionFacet.
	 *
	 * @param id
	 *            The CharID for which the RegionCacheInfo should be returned
	 * @return The RegionCacheInfo for the Player Character represented by the
	 *         given CharID; null if no Region information has been set for the
	 *         Player Character.
	 */
	private RegionCacheInfo getInfo(CharID id)
	{
<span class="fc" id="L87">		return (RegionCacheInfo) getCache(id);</span>
	}

	/**
	 * Sets the character Region for the Player Character represented by the
	 * given CharID to the given Region. This set Region will override any
	 * Region provided by a PCTemplate.
	 *
	 * @param id
	 *            The CharID representing the Player Character for which the
	 *            Region will be set
	 * @param region
	 *            The Region for the Player Character represented by the given
	 *            CharID
	 */
	public void setRegion(CharID id, Region region)
	{
<span class="fc" id="L104">		getConstructingInfo(id).region = region;</span>
<span class="fc" id="L105">		updateRegion(id);</span>
<span class="fc" id="L106">	}</span>

	/**
	 * Sets the character SubRegion for the Player Character represented by the
	 * given CharID to the given SubRegion. This set SubRegion will override any
	 * SubRegion provided by a PCTemplate.
	 *
	 * @param id
	 *            The CharID representing the Player Character for which the
	 *            SubRegion will be set
	 * @param subregion
	 *            The SubRegion for the Player Character represented by the
	 *            given CharID
	 */
	public void setSubRegion(CharID id, String subregion)
	{
<span class="fc" id="L122">		getConstructingInfo(id).subregion = subregion;</span>
<span class="fc" id="L123">	}</span>

	/**
	 * Returns a String representation of the character Region for the Player
	 * Character represented by the given CharID. Returns &quot;NONE&quot; if no character
	 * Region is set for the Player Character
	 *
	 * **NOTE** Unless you are analyzing (or storing) raw values for a Player
	 * Character, it is unlikely that you want this method. It is more likely
	 * that you should be using getRegion(CharID id)
	 *
	 * @param id
	 *            The CharID representing the Player Character for which the
	 *            character Region should be returned.
	 * @return A String representation of the character Region for the Player
	 *         Character represented by the given CharID; &quot;NONE&quot; if no character
	 *         Region is set for the Player Character
	 */
	public Optional&lt;Region&gt; getCharacterRegion(CharID id)
	{
<span class="fc" id="L143">		RegionCacheInfo rci = getInfo(id);</span>
<span class="pc bpc" id="L144" title="1 of 4 branches missed.">		if (rci != null &amp;&amp; rci.region != null)</span>
		{
<span class="fc" id="L146">			return Optional.of(rci.region);</span>
		}
<span class="fc" id="L148">		return Optional.empty();</span>
	}

	/**
	 * Returns an Optional Region for the Player Character represented by the given
	 * CharID.
	 *
	 * @param id
	 *            The CharID representing the Player Character for which the Region should
	 *            be returned.
	 * @return An Optional Region for the Player Character represented by the given CharID
	 */
	public Optional&lt;Region&gt; getRegion(CharID id)
	{
<span class="fc" id="L162">		Optional&lt;Region&gt; charRegion = getCharacterRegion(id);</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">		return charRegion.isPresent() ? charRegion : getTemplateRegion(id);</span>
	}

	/**
	 * Returns a String representation of the Region for the Player Character
	 * represented by the given CharID. Returns &quot;NONE&quot; if no Region is set for
	 * the Player Character.
	 *
	 * @param id
	 *            The CharID representing the Player Character for which the
	 *            Region should be returned.
	 * @return A String representation of the Region for the Player Character
	 *         represented by the given CharID; &quot;NONE&quot; if no Region is set for
	 *         the Player Character
	 */
	public String getRegionString(CharID id)
	{
<span class="fc" id="L180">		Optional&lt;Region&gt; charRegion = getCharacterRegion(id);</span>
<span class="fc" id="L181">		return charRegion.orElse(getTemplateRegion(id).orElse(Region.NONE)).toString();</span>
	}

	private Optional&lt;Region&gt; getTemplateRegion(CharID id)
	{
<span class="fc" id="L186">		return templateFacet.getSet(id)</span>
<span class="fc" id="L187">				.stream()</span>
<span class="fc" id="L188">				.map(template -&gt; Optional.ofNullable(template.get(ObjectKey.REGION)))</span>
<span class="fc" id="L189">				.filter(Optional::isPresent)</span>
<span class="fc" id="L190">				.reduce(Optional.empty(), (current, next) -&gt; next);</span>
	}

	/**
	 * Returns true if the Region of the Player Character represented by the
	 * given CharID matches the given Region. This method tests the Region
	 * (which includes Region as set by PCTemplate objects), not solely the
	 * character Region. This does not compare the SubRegion.
	 *
	 * @param id
	 *            The CharID representing the Player Character for which the
	 *            given Region will be tested to see if it matches the Player
	 *            Character's Region.
	 * @param r
	 *            The Region to be tested to determine if it matches the Player
	 *            Character's Region
	 * @return true if the Region of the Player Character represented by the
	 *         given CharID matches the given Region; false otherwise.
	 */
	public boolean matchesRegion(CharID id, Region r)
	{
<span class="fc" id="L211">		return getRegion(id).orElse(Region.NONE)</span>
<span class="fc" id="L212">			.equals(Optional.ofNullable(r).orElse(Region.NONE));</span>
	}

	/**
	 * Returns a String representation of the character SubRegion for the Player
	 * Character represented by the given CharID. Returns &quot;NONE&quot; if no character
	 * SubRegion is set for the Player Character
	 *
	 * **NOTE** Unless you are analyzing (or storing) raw values for a Player
	 * Character, it is unlikely that you want this method. It is more likely
	 * that you should be using getSubRegion(CharID id)
	 *
	 * @see RegionFacet#getSubRegion(CharID)
	 *
	 * @param id
	 *            The CharID representing the Player Character for which the
	 *            character SubRegion should be returned.
	 * @return A String representation of the character SubRegion for the Player
	 *         Character represented by the given CharID; &quot;NONE&quot; if no character
	 *         SubRegion is set for the Player Character
	 */
	public Optional&lt;String&gt; getCharacterSubRegion(CharID id)
	{
<span class="fc" id="L235">		RegionCacheInfo rci = getInfo(id);</span>
		// character's subregion trumps any from templates
<span class="fc bfc" id="L237" title="All 4 branches covered.">		if (rci != null &amp;&amp; rci.subregion != null)</span>
		{
<span class="fc" id="L239">			return Optional.of(rci.subregion);</span>
		}
<span class="fc" id="L241">		return Optional.empty();</span>
	}

	/**
	 * Returns a String representation of the SubRegion for the Player Character
	 * represented by the given CharID. Returns &quot;NONE&quot; if no SubRegion is set
	 * for the Player Character.
	 *
	 * @param id
	 *            The CharID representing the Player Character for which the
	 *            Region should be returned.
	 * @return A String representation of the SubRegion for the Player Character
	 *         represented by the given CharID; &quot;NONE&quot; if no SubRegion is set
	 *         for the Player Character
	 */
	public Optional&lt;String&gt; getSubRegion(CharID id)
	{
<span class="fc" id="L258">		RegionCacheInfo rci = getInfo(id);</span>
		// character's subregion trumps any from templates
<span class="fc bfc" id="L260" title="All 4 branches covered.">		if (rci != null &amp;&amp; rci.subregion != null)</span>
		{
<span class="fc" id="L262">			return Optional.of(rci.subregion);</span>
		}

<span class="fc" id="L265">		return templateFacet.getSet(id).stream()</span>
<span class="fc" id="L266">			.map(</span>
<span class="fc" id="L267">				template -&gt; Optional.ofNullable(template.get(StringKey.SUBREGION)))</span>
<span class="fc" id="L268">			.filter(Optional::isPresent)</span>
<span class="fc" id="L269">			.reduce(Optional.empty(), (current, next) -&gt; next);</span>
	}

	/**
	 * Returns a String representation of the full Region (Region and SubRegion)
	 * for the Player Character represented by the given CharID. Returns &quot;NONE&quot;
	 * if no Region is set for the Player Character.
	 *
	 * @param id
	 *            The CharID representing the Player Character for which the
	 *            full Region should be returned.
	 * @return A String representation of the full Region for the Player
	 *         Character represented by the given CharID; &quot;NONE&quot; if no Region is
	 *         set for the Player Character
	 */
	public String getFullRegion(CharID id)
	{
<span class="fc" id="L286">		Optional&lt;String&gt; sub = getSubRegion(id);</span>
<span class="fc" id="L287">		StringBuilder tempRegName = new StringBuilder(40).append(getRegionString(id));</span>

<span class="fc" id="L289">		sub.ifPresent(subRegion -&gt; tempRegName.append(&quot; (&quot;).append(subRegion).append(')'));</span>

<span class="fc" id="L291">		return tempRegName.toString();</span>
	}

	/**
	 * RegionClassInfo is the data structure used by RegionFacet to store a
	 * Player Character's Region and SubRegion if they are directly set by a
	 * user.
	 */
<span class="fc" id="L299">	private static class RegionCacheInfo</span>
	{
<span class="fc" id="L301">		public Optional&lt;Region&gt; cachedRegion = Optional.empty();</span>

		public Region region;

		public String subregion;

		@Override
		public String toString()
		{
<span class="nc" id="L310">			return region + &quot; &quot; + subregion + &quot; &quot; + cachedRegion.orElse(Region.NONE);</span>
		}

		@Override
		public int hashCode()
		{
<span class="nc bnc" id="L316" title="All 2 branches missed.">			return (region == null ? -1 : region.hashCode());</span>
		}

		@Override
		public boolean equals(Object o)
		{
<span class="nc bnc" id="L322" title="All 2 branches missed.">			if (o instanceof RegionCacheInfo other)</span>
			{
<span class="nc bnc" id="L324" title="All 4 branches missed.">				return Objects.equals(region, other.region) &amp;&amp; Objects.equals(subregion, other.subregion)</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">					&amp;&amp; Objects.equals(cachedRegion, other.cachedRegion);</span>
			}
<span class="nc" id="L327">			return false;</span>
		}

	}

	/**
	 * Copies the contents of the RegionFacet from one Player Character to
	 * another Player Character, based on the given CharIDs representing those
	 * Player Characters.
	 *
	 * This is a method in RegionFacet in order to avoid exposing the mutable
	 * RegionCacheInfo object to other classes. This should not be inlined, as
	 * RegionCacheInfo is internal information to RegionFacet and should not be
	 * exposed to other classes.
	 *
	 * Note also the copy is a one-time event and no Region references are
	 * maintained between the Player Characters represented by the given CharIDs
	 * (meaning once this copy takes place, any change to the Region will only
	 * impact the Player Character where the Region was changed).
	 *
	 * @param source
	 *            The CharID representing the Player Character from which the
	 *            Region information should be copied
	 * @param destination
	 *            The CharID representing the Player Character to which the
	 *            Region information should be copied
	 */
	@Override
	public void copyContents(CharID source, CharID destination)
	{
<span class="fc" id="L357">		RegionCacheInfo sourceRCI = getInfo(source);</span>
<span class="fc bfc" id="L358" title="All 2 branches covered.">		if (sourceRCI != null)</span>
		{
<span class="fc" id="L360">			RegionCacheInfo destRCI = getConstructingInfo(destination);</span>
<span class="fc" id="L361">			destRCI.region = sourceRCI.region;</span>
<span class="fc" id="L362">			destRCI.subregion = sourceRCI.subregion;</span>
		}
<span class="fc" id="L364">	}</span>

	/**
	 * Drives an update of the Region and SubRegion for a Player Character when
	 * a CDOMObject is added to a Player Character.
	 *
	 * Triggered when one of the Facets to which RegionFacet listens fires a
	 * DataFacetChangeEvent to indicate a CDOMObject was added to a Player
	 * Character.
	 *
	 * @param dfce
	 *            The DataFacetChangeEvent containing the information about the
	 *            change
	 */
	@Override
	public void dataAdded(DataFacetChangeEvent&lt;CharID, PCTemplate&gt; dfce)
	{
<span class="nc" id="L381">		updateRegion(dfce.getCharID());</span>
<span class="nc" id="L382">	}</span>

	private void updateRegion(CharID id)
	{
<span class="fc" id="L386">		RegionCacheInfo rci = getInfo(id);</span>
<span class="fc" id="L387">		Optional&lt;Region&gt; current = rci.cachedRegion;</span>
<span class="fc" id="L388">		Optional&lt;Region&gt; optNewRegion = getRegion(id);</span>
<span class="pc bpc" id="L389" title="1 of 4 branches missed.">		if (current.isEmpty() || !current.equals(optNewRegion))</span>
		{
<span class="fc" id="L391">			current.ifPresent(region -&gt; fireDataFacetChangeEvent(id, region.toString(), DataFacetChangeEvent.DATA_REMOVED));</span>
<span class="fc" id="L392">			rci.cachedRegion = optNewRegion;</span>
<span class="fc" id="L393">			optNewRegion.map(Region::toString).ifPresent(newRegion -&gt; fireDataFacetChangeEvent(id, newRegion, DataFacetChangeEvent.DATA_ADDED));</span>
		}
<span class="fc" id="L395">	}</span>

	/**
	 * Drives an update of the Region and SubRegion for a Player Character when
	 * a CDOMObject is removed from a Player Character.
	 *
	 * Triggered when one of the Facets to which RegionFacet listens fires a
	 * DataFacetChangeEvent to indicate a CDOMObject was removed from a Player
	 * Character.
	 *
	 * @param dfce
	 *            The DataFacetChangeEvent containing the information about the
	 *            change
	 */
	@Override
	public void dataRemoved(DataFacetChangeEvent&lt;CharID, PCTemplate&gt; dfce)
	{
<span class="nc" id="L412">		updateRegion(dfce.getCharID());</span>
<span class="nc" id="L413">	}</span>

	public void setTemplateFacet(TemplateFacet templateFacet)
	{
<span class="fc" id="L417">		this.templateFacet = templateFacet;</span>
<span class="fc" id="L418">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>