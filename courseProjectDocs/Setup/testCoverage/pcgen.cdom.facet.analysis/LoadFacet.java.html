<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoadFacet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.cdom.facet.analysis</a> &gt; <span class="el_source">LoadFacet.java</span></div><h1>LoadFacet.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2010 Tom Parker &lt;thpr@users.sourceforge.net&gt;
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA
 */
package pcgen.cdom.facet.analysis;

import java.math.BigDecimal;
import java.util.regex.Pattern;

import pcgen.base.formula.Formula;
import pcgen.cdom.base.FormulaFactory;
import pcgen.cdom.enumeration.CharID;
import pcgen.cdom.facet.BonusCheckingFacet;
import pcgen.cdom.facet.FormulaResolvingFacet;
import pcgen.cdom.facet.PlayerCharacterTrackingFacet;
import pcgen.core.Globals;
import pcgen.core.RuleConstants;
import pcgen.core.SettingsHandler;
import pcgen.core.SizeAdjustment;
import pcgen.util.enumeration.Load;

/**
 * LoadFacet calculates information about the Load for a Player Character. The
 * underlying Load information used for these calculations is defined in the
 * Game Mode LST files.
 *
 */
<span class="fc" id="L40">public class LoadFacet</span>
{
<span class="fc" id="L42">	private static final Formula LOADSCORE_FORMULA = FormulaFactory.getFormulaFor(&quot;LOADSCORE&quot;);</span>

	private FormulaResolvingFacet formulaResolvingFacet;
	private TotalWeightFacet totalWeightFacet;
	private PlayerCharacterTrackingFacet pcFacet;
	private BonusCheckingFacet bonusCheckingFacet;

	/**
	 * Returns the Load for the Player Character identified by the given CharID.
	 *
	 * @param id
	 *            The CharID identifying the Player Character for which the Load
	 *            should be returned
	 * @return The Load for the Player Character identified by the given CharID
	 */
	public Load getLoadType(CharID id)
	{
<span class="nc" id="L59">		Float weight = totalWeightFacet.getTotalWeight(id);</span>
<span class="nc" id="L60">		double dbl = weight / getMaxLoad(id).doubleValue();</span>

<span class="nc bnc" id="L62" title="All 2 branches missed.">		if (!Globals.checkRule(RuleConstants.SYS_LDPACSK))</span>
		{
<span class="nc" id="L64">			return Load.LIGHT;</span>
		}
<span class="nc" id="L66">		Float lightMult = SettingsHandler.getGameAsProperty().get().getLoadInfo().getLoadMultiplier(&quot;LIGHT&quot;);</span>
<span class="nc bnc" id="L67" title="All 4 branches missed.">		if (lightMult != null &amp;&amp; dbl &lt;= lightMult.doubleValue())</span>
		{
<span class="nc" id="L69">			return Load.LIGHT;</span>
		}

<span class="nc" id="L72">		Float mediumMult = SettingsHandler.getGameAsProperty().get().getLoadInfo().getLoadMultiplier(&quot;MEDIUM&quot;);</span>
<span class="nc bnc" id="L73" title="All 4 branches missed.">		if (mediumMult != null &amp;&amp; dbl &lt;= mediumMult.doubleValue())</span>
		{
<span class="nc" id="L75">			return Load.MEDIUM;</span>
		}

<span class="nc" id="L78">		Float heavyMult = SettingsHandler.getGameAsProperty().get().getLoadInfo().getLoadMultiplier(&quot;HEAVY&quot;);</span>
<span class="nc bnc" id="L79" title="All 4 branches missed.">		if (heavyMult != null &amp;&amp; dbl &lt;= heavyMult.doubleValue())</span>
		{
<span class="nc" id="L81">			return Load.HEAVY;</span>
		}

<span class="nc" id="L84">		return Load.OVERLOAD;</span>
	}

	/**
	 * Returns the maximum Load for the Player Character identified by the given
	 * CharID.
	 *
	 * @param id
	 *            The CharID identifying the Player Character for which the
	 *            maximum Load should be returned.
	 * @return The Maximum load for the Player Character identified by the given
	 *         CharID
	 */
	public Float getMaxLoad(CharID id)
	{
<span class="nc" id="L99">		return getMaxLoad(id, 1.0);</span>
	}

	/**
	 * Returns the maximum Load for the Player Character identified by the given
	 * CharID, multiplied by the given multiplier.
	 *
	 * @param id
	 *            The CharID identifying the Player Character for which the
	 *            maximum Load should be returned.
	 * @param mult
	 *            The multiplier by which the maximum Load will be multiplied.
	 * @return The Maximum load for the Player Character identified by the given
	 *         CharID, multiplied by the given multiplier
	 */
	public Float getMaxLoad(CharID id, double mult)
	{
<span class="nc" id="L116">		int loadScore = formulaResolvingFacet.resolve(id, LOADSCORE_FORMULA, &quot;&quot;).intValue();</span>
<span class="nc" id="L117">		final BigDecimal loadValue = SettingsHandler.getGameAsProperty().get().getLoadInfo().getLoadScoreValue(loadScore);</span>
<span class="nc" id="L118">		String formula = SettingsHandler.getGameAsProperty().get().getLoadInfo().getLoadModifierFormula();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (formula != null)</span>
		{
<span class="nc" id="L121">			formula = formula.replaceAll(Pattern.quote(&quot;$$SCORE$$&quot;),</span>
<span class="nc" id="L122">				Double.toString(loadValue.doubleValue() * mult * getLoadMultForSize(id)));</span>
<span class="nc" id="L123">			return (float) formulaResolvingFacet.resolve(id, FormulaFactory.getFormulaFor(formula), &quot;&quot;).intValue();</span>
		}
<span class="nc" id="L125">		return (float) (loadValue.doubleValue() * mult * getLoadMultForSize(id));</span>
	}

	/**
	 * Returns the Load Multiplier for the size of the Player Character
	 * identified by the given CharID.
	 *
	 * @param id
	 *            The CharID identifying the Player Character for which the Load
	 *            Multiplier will be returned.
	 * @return The Load Multiplier for the size of the Player Character
	 *         identified by the given CharID
	 */
	private double getLoadMultForSize(CharID id)
	{
<span class="nc" id="L140">		SizeAdjustment sadj = pcFacet.getPC(id).getSizeAdjustment();</span>
<span class="nc" id="L141">		double mult = SettingsHandler.getGameAsProperty().get().getLoadInfo().getSizeAdjustment(sadj).doubleValue();</span>
<span class="nc" id="L142">		mult += bonusCheckingFacet.getBonus(id, &quot;LOADMULT&quot;, &quot;TYPE=SIZE&quot;);</span>
<span class="nc" id="L143">		return mult;</span>
	}

	public void setFormulaResolvingFacet(FormulaResolvingFacet formulaResolvingFacet)
	{
<span class="fc" id="L148">		this.formulaResolvingFacet = formulaResolvingFacet;</span>
<span class="fc" id="L149">	}</span>

	public void setTotalWeightFacet(TotalWeightFacet totalWeightFacet)
	{
<span class="fc" id="L153">		this.totalWeightFacet = totalWeightFacet;</span>
<span class="fc" id="L154">	}</span>

	public void setPlayerCharacterTrackingFacet(PlayerCharacterTrackingFacet pcFacet)
	{
<span class="fc" id="L158">		this.pcFacet = pcFacet;</span>
<span class="fc" id="L159">	}</span>

	public void setBonusCheckingFacet(BonusCheckingFacet bonusCheckingFacet)
	{
<span class="fc" id="L163">		this.bonusCheckingFacet = bonusCheckingFacet;</span>
<span class="fc" id="L164">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>