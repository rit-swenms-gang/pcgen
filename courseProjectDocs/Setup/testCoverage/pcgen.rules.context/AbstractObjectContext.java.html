<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractObjectContext.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.rules.context</a> &gt; <span class="el_source">AbstractObjectContext.java</span></div><h1>AbstractObjectContext.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2007 (C) Tom Parker &lt;thpr@users.sourceforge.net&gt;
 * 
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 * 
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.rules.context;

import java.net.URI;
import java.util.HashMap;
import java.util.IdentityHashMap;
import java.util.Objects;
import java.util.Set;

import pcgen.base.formula.Formula;
import pcgen.base.util.DoubleKeyMap;
import pcgen.base.util.DoubleKeyMapToList;
import pcgen.base.util.HashMapToList;
import pcgen.base.util.Indirect;
import pcgen.base.util.TripleKeyMapToList;
import pcgen.cdom.base.CDOMObject;
import pcgen.cdom.base.ConcretePrereqObject;
import pcgen.cdom.base.Constants;
import pcgen.cdom.enumeration.FactKey;
import pcgen.cdom.enumeration.FactSetKey;
import pcgen.cdom.enumeration.FormulaKey;
import pcgen.cdom.enumeration.IntegerKey;
import pcgen.cdom.enumeration.ListKey;
import pcgen.cdom.enumeration.MapKey;
import pcgen.cdom.enumeration.ObjectKey;
import pcgen.cdom.enumeration.StringKey;
import pcgen.cdom.enumeration.VariableKey;
import pcgen.core.prereq.Prerequisite;
import pcgen.util.Logging;

<span class="fc" id="L47">public abstract class AbstractObjectContext implements ObjectCommitStrategy</span>
{
<span class="fc" id="L49">	private final TrackingObjectCommitStrategy edits = new TrackingObjectCommitStrategy();</span>

	@Override
	public void setSourceURI(URI sourceURI)
	{
<span class="fc" id="L54">		edits.setSourceURI(sourceURI);</span>
<span class="fc" id="L55">		getCommitStrategy().setSourceURI(sourceURI);</span>
<span class="fc" id="L56">	}</span>

	@Override
	public void setExtractURI(URI extractURI)
	{
<span class="fc" id="L61">		edits.setExtractURI(extractURI);</span>
<span class="fc" id="L62">		getCommitStrategy().setExtractURI(extractURI);</span>
<span class="fc" id="L63">	}</span>

	@Override
	public &lt;T&gt; void addToList(CDOMObject cdo, ListKey&lt;T&gt; key, T value)
	{
<span class="fc" id="L68">		edits.addToList(cdo, key, value);</span>
<span class="fc" id="L69">	}</span>

	@Override
	public &lt;T&gt; void addToSet(CDOMObject cdo, FactSetKey&lt;T&gt; key, Indirect&lt;T&gt; value)
	{
<span class="fc" id="L74">		edits.addToSet(cdo, key, value);</span>
<span class="fc" id="L75">	}</span>

	@Override
	public &lt;K, V&gt; void put(CDOMObject cdo, MapKey&lt;K, V&gt; mk, K key, V value)
	{
<span class="fc" id="L80">		edits.put(cdo, mk, key, value);</span>
<span class="fc" id="L81">	}</span>

	@Override
	public void put(CDOMObject cdo, FormulaKey fk, Formula f)
	{
<span class="fc" id="L86">		edits.put(cdo, fk, f);</span>
<span class="fc" id="L87">	}</span>

	@Override
	public void put(ConcretePrereqObject cpo, Prerequisite p)
	{
<span class="fc" id="L92">		edits.put(cpo, p);</span>
<span class="fc" id="L93">	}</span>

	@Override
	public void clearPrerequisiteList(ConcretePrereqObject cpo)
	{
<span class="fc" id="L98">		edits.clearPrerequisiteList(cpo);</span>
<span class="fc" id="L99">	}</span>

	@Override
	public void put(CDOMObject cdo, IntegerKey ik, Integer i)
	{
<span class="fc" id="L104">		edits.put(cdo, ik, i);</span>
<span class="fc" id="L105">	}</span>

	@Override
	public void remove(CDOMObject cdo, IntegerKey ik)
	{
<span class="nc" id="L110">		edits.remove(cdo, ik);</span>
<span class="nc" id="L111">	}</span>

	@Override
	public &lt;T&gt; void put(CDOMObject cdo, ObjectKey&lt;T&gt; sk, T s)
	{
<span class="fc" id="L116">		edits.put(cdo, sk, s);</span>
<span class="fc" id="L117">	}</span>

	@Override
	public void remove(CDOMObject cdo, ObjectKey&lt;?&gt; sk)
	{
<span class="fc" id="L122">		edits.remove(cdo, sk);</span>
<span class="fc" id="L123">	}</span>

	@Override
	public &lt;T&gt; void put(CDOMObject cdo, FactKey&lt;T&gt; sk, Indirect&lt;T&gt; s)
	{
<span class="fc" id="L128">		edits.put(cdo, sk, s);</span>
<span class="fc" id="L129">	}</span>

	@Override
	public void remove(CDOMObject cdo, FactKey&lt;?&gt; sk)
	{
<span class="nc" id="L134">		edits.remove(cdo, sk);</span>
<span class="nc" id="L135">	}</span>

	@Override
	public void put(CDOMObject cdo, StringKey sk, String s)
	{
<span class="fc" id="L140">		edits.put(cdo, sk, s);</span>
<span class="fc" id="L141">	}</span>

	@Override
	public void remove(CDOMObject cdo, StringKey sk)
	{
<span class="fc" id="L146">		edits.remove(cdo, sk);</span>
<span class="fc" id="L147">	}</span>

	@Override
	public void put(CDOMObject cdo, VariableKey vk, Formula f)
	{
<span class="fc" id="L152">		edits.put(cdo, vk, f);</span>
<span class="fc" id="L153">	}</span>

	@Override
	public &lt;T&gt; void removeFromList(CDOMObject cdo, ListKey&lt;T&gt; lk, T val)
	{
<span class="fc" id="L158">		edits.removeFromList(cdo, lk, val);</span>
<span class="fc" id="L159">	}</span>

	@Override
	public void removeList(CDOMObject cdo, ListKey&lt;?&gt; lk)
	{
<span class="fc" id="L164">		edits.removeList(cdo, lk);</span>
<span class="fc" id="L165">	}</span>

	@Override
	public &lt;T&gt; void removeFromSet(CDOMObject cdo, FactSetKey&lt;T&gt; lk, Indirect&lt;T&gt; val)
	{
<span class="nc" id="L170">		edits.removeFromSet(cdo, lk, val);</span>
<span class="nc" id="L171">	}</span>

	@Override
	public void removeSet(CDOMObject cdo, FactSetKey&lt;?&gt; lk)
	{
<span class="nc" id="L176">		edits.removeSet(cdo, lk);</span>
<span class="nc" id="L177">	}</span>

	@Override
	public &lt;K, V&gt; void remove(CDOMObject cdo, MapKey&lt;K, V&gt; mk, K key)
	{
<span class="nc" id="L182">		edits.remove(cdo, mk, key);</span>
<span class="nc" id="L183">	}</span>

	void commit()
	{
<span class="fc" id="L187">		ObjectCommitStrategy commit = getCommitStrategy();</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">		for (URI uri : edits.preClearSet.getKeySet())</span>
		{
<span class="fc bfc" id="L190" title="All 2 branches covered.">			for (ConcretePrereqObject cpo : edits.preClearSet.getListFor(uri))</span>
			{
<span class="fc" id="L192">				commit.clearPrerequisiteList(cpo);</span>
<span class="fc" id="L193">			}</span>
<span class="fc" id="L194">		}</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">		for (URI uri : edits.globalClearSet.getKeySet())</span>
		{
<span class="fc bfc" id="L197" title="All 2 branches covered.">			for (CDOMObject cdo : edits.globalClearSet.getSecondaryKeySet(uri))</span>
			{
<span class="fc bfc" id="L199" title="All 2 branches covered.">				for (ListKey&lt;?&gt; lk : edits.globalClearSet.getListFor(uri, cdo))</span>
				{
<span class="fc" id="L201">					commit.removeList(cdo, lk);</span>
<span class="fc" id="L202">				}</span>
<span class="fc" id="L203">			}</span>
<span class="fc" id="L204">		}</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">		for (URI uri : edits.negativeMap.getKeySet())</span>
		{
<span class="fc bfc" id="L207" title="All 2 branches covered.">			for (ConcretePrereqObject cpo : edits.negativeMap.getSecondaryKeySet(uri))</span>
			{
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">				if (cpo instanceof CDOMObject cdo)</span>
				{
<span class="fc" id="L211">					CDOMObject neg = edits.negativeMap.get(uri, cdo);</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">					for (ObjectKey&lt;?&gt; ok : neg.getSafeListFor(ListKey.REMOVED_OBJECTKEY))</span>
					{
<span class="fc" id="L214">						commit.remove(cdo, ok);</span>
<span class="fc" id="L215">					}</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">					for (FactKey&lt;?&gt; ok : neg.getSafeListFor(ListKey.REMOVED_FACTKEY))</span>
					{
<span class="nc" id="L218">						commit.remove(cdo, ok);</span>
<span class="nc" id="L219">					}</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">					for (StringKey sk : neg.getSafeListFor(ListKey.REMOVED_STRINGKEY))</span>
					{
<span class="fc" id="L222">						commit.remove(cdo, sk);</span>
<span class="fc" id="L223">					}</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">					for (IntegerKey ik : neg.getSafeListFor(ListKey.REMOVED_INTEGERKEY))</span>
					{
<span class="nc" id="L226">						commit.remove(cdo, ik);</span>
<span class="nc" id="L227">					}</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">					for (FactSetKey&lt;?&gt; key : neg.getFactSetKeys())</span>
					{
<span class="nc" id="L230">						removeFactSetKey(cdo, key, neg);</span>
<span class="nc" id="L231">					}</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">					for (ListKey&lt;?&gt; key : neg.getListKeys())</span>
					{
<span class="fc" id="L234">						removeListKey(cdo, key, neg);</span>
<span class="fc" id="L235">					}</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">					for (MapKey&lt;?, ?&gt; key1 : neg.getMapKeys())</span>
					{
<span class="nc" id="L238">						removeMapKey(cdo, key1, neg);</span>
<span class="nc" id="L239">					}</span>
				}
<span class="fc" id="L241">			}</span>
<span class="fc" id="L242">		}</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">		for (URI uri : edits.positiveMap.getKeySet())</span>
		{
<span class="fc bfc" id="L245" title="All 2 branches covered.">			for (ConcretePrereqObject cpo : edits.positiveMap.getSecondaryKeySet(uri))</span>
			{
<span class="fc" id="L247">				CDOMObject pos = edits.positiveMap.get(uri, cpo);</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">				for (Prerequisite p : pos.getPrerequisiteList())</span>
				{
<span class="fc" id="L250">					commit.put(cpo, p);</span>
<span class="fc" id="L251">				}</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">				if (cpo instanceof CDOMObject cdo)</span>
				{
<span class="fc bfc" id="L254" title="All 2 branches covered.">					for (StringKey key : pos.getStringKeys())</span>
					{
<span class="fc" id="L256">						commit.put(cdo, key, pos.get(key));</span>
<span class="fc" id="L257">					}</span>
<span class="fc bfc" id="L258" title="All 2 branches covered.">					for (IntegerKey key : pos.getIntegerKeys())</span>
					{
<span class="fc" id="L260">						commit.put(cdo, key, pos.get(key));</span>
<span class="fc" id="L261">					}</span>
<span class="fc bfc" id="L262" title="All 2 branches covered.">					for (FormulaKey key : pos.getFormulaKeys())</span>
					{
<span class="fc" id="L264">						commit.put(cdo, key, pos.get(key));</span>
<span class="fc" id="L265">					}</span>
<span class="fc bfc" id="L266" title="All 2 branches covered.">					for (VariableKey key : pos.getVariableKeys())</span>
					{
<span class="fc" id="L268">						commit.put(cdo, key, pos.get(key));</span>
<span class="fc" id="L269">					}</span>
<span class="fc bfc" id="L270" title="All 2 branches covered.">					for (ObjectKey&lt;?&gt; key : pos.getObjectKeys())</span>
					{
<span class="fc" id="L272">						putObjectKey(cdo, key, pos);</span>
<span class="fc" id="L273">					}</span>
<span class="fc bfc" id="L274" title="All 2 branches covered.">					for (FactKey&lt;?&gt; key : pos.getFactKeys())</span>
					{
<span class="fc" id="L276">						putFactKey(cdo, key, pos);</span>
<span class="fc" id="L277">					}</span>
<span class="fc bfc" id="L278" title="All 2 branches covered.">					for (ListKey&lt;?&gt; key : pos.getListKeys())</span>
					{
<span class="fc" id="L280">						putListKey(cdo, key, pos);</span>
<span class="fc" id="L281">					}</span>
<span class="fc bfc" id="L282" title="All 2 branches covered.">					for (FactSetKey&lt;?&gt; key : pos.getFactSetKeys())</span>
					{
<span class="fc" id="L284">						putFactSetKey(cdo, key, pos);</span>
<span class="fc" id="L285">					}</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">					for (MapKey&lt;?, ?&gt; key1 : pos.getMapKeys())</span>
					{
<span class="fc" id="L288">						putMapKey(cdo, key1, pos);</span>
<span class="fc" id="L289">					}</span>
					/*
					 * No need to deal with ListMods because that's done in
					 * listContext
					 */
					/*
					 * TODO Deal with cloned objects
					 */
				}
<span class="fc" id="L298">			}</span>
<span class="fc" id="L299">		}</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">		for (URI uri : edits.patternClearSet.getKeySet())</span>
		{
<span class="nc bnc" id="L302" title="All 2 branches missed.">			for (CDOMObject cdo : edits.patternClearSet.getSecondaryKeySet(uri))</span>
			{
<span class="nc bnc" id="L304" title="All 2 branches missed.">				for (ListKey&lt;?&gt; lk : edits.patternClearSet.getTertiaryKeySet(uri, cdo))</span>
				{
<span class="nc bnc" id="L306" title="All 2 branches missed.">					for (String s : edits.patternClearSet.getListFor(uri, cdo, lk))</span>
					{
<span class="nc" id="L308">						commit.removePatternFromList(cdo, lk, s);</span>
<span class="nc" id="L309">					}</span>
<span class="nc" id="L310">				}</span>
<span class="nc" id="L311">			}</span>
<span class="nc" id="L312">		}</span>
<span class="fc" id="L313">		rollback();</span>
<span class="fc" id="L314">	}</span>

	private &lt;T&gt; void removeListKey(CDOMObject cdo, ListKey&lt;T&gt; key, CDOMObject neg)
	{
<span class="fc" id="L318">		ObjectCommitStrategy commit = getCommitStrategy();</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">		for (T obj : neg.getListFor(key))</span>
		{
<span class="fc" id="L321">			commit.removeFromList(cdo, key, obj);</span>
<span class="fc" id="L322">		}</span>
<span class="fc" id="L323">	}</span>

	private &lt;T&gt; void removeFactSetKey(CDOMObject cdo, FactSetKey&lt;T&gt; key, CDOMObject neg)
	{
<span class="nc" id="L327">		ObjectCommitStrategy commit = getCommitStrategy();</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">		for (Indirect&lt;T&gt; obj : neg.getSetFor(key))</span>
		{
<span class="nc" id="L330">			commit.removeFromSet(cdo, key, obj);</span>
<span class="nc" id="L331">		}</span>
<span class="nc" id="L332">	}</span>

	private &lt;T&gt; void putListKey(CDOMObject cdo, ListKey&lt;T&gt; key, CDOMObject neg)
	{
<span class="fc" id="L336">		ObjectCommitStrategy commit = getCommitStrategy();</span>
<span class="fc bfc" id="L337" title="All 2 branches covered.">		for (T obj : neg.getListFor(key))</span>
		{
<span class="fc" id="L339">			commit.addToList(cdo, key, obj);</span>
<span class="fc" id="L340">		}</span>
<span class="fc" id="L341">	}</span>

	private &lt;T&gt; void putFactSetKey(CDOMObject cdo, FactSetKey&lt;T&gt; key, CDOMObject neg)
	{
<span class="fc" id="L345">		ObjectCommitStrategy commit = getCommitStrategy();</span>
<span class="fc bfc" id="L346" title="All 2 branches covered.">		for (Indirect&lt;T&gt; obj : neg.getSetFor(key))</span>
		{
<span class="fc" id="L348">			commit.addToSet(cdo, key, obj);</span>
<span class="fc" id="L349">		}</span>
<span class="fc" id="L350">	}</span>

	private &lt;T&gt; void putObjectKey(CDOMObject cdo, ObjectKey&lt;T&gt; key, CDOMObject neg)
	{
<span class="fc" id="L354">		getCommitStrategy().put(cdo, key, neg.get(key));</span>
<span class="fc" id="L355">	}</span>

	private &lt;T&gt; void putFactKey(CDOMObject cdo, FactKey&lt;T&gt; key, CDOMObject neg)
	{
<span class="fc" id="L359">		getCommitStrategy().put(cdo, key, neg.get(key));</span>
<span class="fc" id="L360">	}</span>

	private &lt;K, V&gt; void removeMapKey(CDOMObject cdo, MapKey&lt;K, V&gt; key1, CDOMObject neg)
	{
<span class="nc" id="L364">		ObjectCommitStrategy commit = getCommitStrategy();</span>
<span class="nc" id="L365">		Set&lt;K&gt; secKeys = neg.getKeysFor(key1);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">		for (K key2 : secKeys)</span>
		{
<span class="nc" id="L368">			commit.remove(cdo, key1, key2);</span>
<span class="nc" id="L369">		}</span>
<span class="nc" id="L370">	}</span>

	private &lt;K, V&gt; void putMapKey(CDOMObject cdo, MapKey&lt;K, V&gt; key1, CDOMObject pos)
	{
<span class="fc" id="L374">		ObjectCommitStrategy commit = getCommitStrategy();</span>
<span class="fc" id="L375">		Set&lt;K&gt; secKeys = pos.getKeysFor(key1);</span>
<span class="fc bfc" id="L376" title="All 2 branches covered.">		for (K key2 : secKeys)</span>
		{
<span class="fc" id="L378">			commit.put(cdo, key1, key2, pos.get(key1, key2));</span>
<span class="fc" id="L379">		}</span>
<span class="fc" id="L380">	}</span>

	void rollback()
	{
<span class="fc" id="L384">		edits.decommit();</span>
<span class="fc" id="L385">	}</span>

	@Override
	public Formula getFormula(CDOMObject cdo, FormulaKey fk)
	{
<span class="fc" id="L390">		return getCommitStrategy().getFormula(cdo, fk);</span>
	}

	@Override
	public Integer getInteger(CDOMObject cdo, IntegerKey ik)
	{
<span class="fc" id="L396">		return getCommitStrategy().getInteger(cdo, ik);</span>
	}

	@Override
	public &lt;T&gt; Changes&lt;T&gt; getListChanges(CDOMObject cdo, ListKey&lt;T&gt; lk)
	{
<span class="fc" id="L402">		return getCommitStrategy().getListChanges(cdo, lk);</span>
	}

	@Override
	public &lt;T&gt; Changes&lt;Indirect&lt;T&gt;&gt; getSetChanges(CDOMObject cdo, FactSetKey&lt;T&gt; lk)
	{
<span class="fc" id="L408">		return getCommitStrategy().getSetChanges(cdo, lk);</span>
	}

	@Override
	public &lt;K, V&gt; MapChanges&lt;K, V&gt; getMapChanges(CDOMObject cdo, MapKey&lt;K, V&gt; mk)
	{
<span class="fc" id="L414">		return getCommitStrategy().getMapChanges(cdo, mk);</span>
	}

	@Override
	public &lt;T&gt; T getObject(CDOMObject cdo, ObjectKey&lt;T&gt; ik)
	{
<span class="fc" id="L420">		return getCommitStrategy().getObject(cdo, ik);</span>
	}

	@Override
	public &lt;T&gt; Indirect&lt;T&gt; getFact(CDOMObject cdo, FactKey&lt;T&gt; ik)
	{
<span class="fc" id="L426">		return getCommitStrategy().getFact(cdo, ik);</span>
	}

	@Override
	public String getString(CDOMObject cdo, StringKey sk)
	{
<span class="fc" id="L432">		return getCommitStrategy().getString(cdo, sk);</span>
	}

	@Override
	public Formula getVariable(CDOMObject obj, VariableKey key)
	{
<span class="fc" id="L438">		return getCommitStrategy().getVariable(obj, key);</span>
	}

	@Override
	public Set&lt;VariableKey&gt; getVariableKeys(CDOMObject obj)
	{
<span class="fc" id="L444">		return getCommitStrategy().getVariableKeys(obj);</span>
	}

	&lt;T extends CDOMObject&gt; T cloneConstructedCDOMObject(T obj, String newName)
	{
<span class="nc" id="L449">		return edits.cloneConstructedCDOMObject(obj, newName);</span>
	}

<span class="fc" id="L452">	public static class DummyCDOMObject extends CDOMObject</span>
	{
		@Override
		public boolean isType(String str)
		{
<span class="nc" id="L457">			return false;</span>
		}
	}

<span class="fc" id="L461">	public static class TrackingObjectCommitStrategy implements ObjectCommitStrategy</span>
	{
<span class="fc" id="L463">		private final DoubleKeyMap&lt;URI, ConcretePrereqObject, CDOMObject&gt; positiveMap =</span>
				new DoubleKeyMap&lt;&gt;(HashMap.class, IdentityHashMap.class);

<span class="fc" id="L466">		private final DoubleKeyMap&lt;URI, ConcretePrereqObject, CDOMObject&gt; negativeMap =</span>
				new DoubleKeyMap&lt;&gt;(HashMap.class, IdentityHashMap.class);

<span class="fc" id="L469">		private final DoubleKeyMapToList&lt;URI, CDOMObject, ListKey&lt;?&gt;&gt; globalClearSet =</span>
				new DoubleKeyMapToList&lt;&gt;(HashMap.class, IdentityHashMap.class);

<span class="fc" id="L472">		private final DoubleKeyMapToList&lt;URI, CDOMObject, FactSetKey&lt;?&gt;&gt; globalClearFactSet =</span>
				new DoubleKeyMapToList&lt;&gt;(HashMap.class, IdentityHashMap.class);

<span class="fc" id="L475">		private final HashMapToList&lt;URI, ConcretePrereqObject&gt; preClearSet = new HashMapToList&lt;&gt;();</span>

<span class="fc" id="L477">		private final TripleKeyMapToList&lt;URI, CDOMObject, ListKey&lt;?&gt;, String&gt; patternClearSet =</span>
				new TripleKeyMapToList&lt;&gt;(HashMap.class, IdentityHashMap.class, HashMap.class);

		private URI sourceURI;

		private URI extractURI;

		private CDOMObject getNegative(URI source, CDOMObject cdo)
		{
<span class="fc" id="L486">			Objects.requireNonNull(cdo, &quot;Cannot remove contents from null object&quot;);</span>
<span class="fc" id="L487">			CDOMObject negative = negativeMap.get(source, cdo);</span>
<span class="fc bfc" id="L488" title="All 2 branches covered.">			if (negative == null)</span>
			{
<span class="fc" id="L490">				negative = new DummyCDOMObject();</span>
<span class="fc" id="L491">				negativeMap.put(source, cdo, negative);</span>
			}
<span class="fc" id="L493">			return negative;</span>
		}

		@Override
		public void clearPrerequisiteList(ConcretePrereqObject cpo)
		{
<span class="fc" id="L499">			preClearSet.addToListFor(sourceURI, cpo);</span>
<span class="fc" id="L500">		}</span>

		@Override
		public void put(ConcretePrereqObject cpo, Prerequisite p)
		{
<span class="fc" id="L505">			getPositive(sourceURI, cpo).addPrerequisite(p);</span>
<span class="fc" id="L506">		}</span>

		private CDOMObject getPositive(URI source, ConcretePrereqObject cdo)
		{
<span class="fc" id="L510">			Objects.requireNonNull(cdo, &quot;Cannot assign contents to null object&quot;);</span>
<span class="fc" id="L511">			CDOMObject positive = positiveMap.get(source, cdo);</span>
<span class="fc bfc" id="L512" title="All 2 branches covered.">			if (positive == null)</span>
			{
<span class="fc" id="L514">				positive = new DummyCDOMObject();</span>
<span class="fc" id="L515">				positiveMap.put(source, cdo, positive);</span>
			}
<span class="fc" id="L517">			return positive;</span>
		}

		@Override
		public void put(CDOMObject cdo, StringKey sk, String s)
		{
<span class="fc bfc" id="L523" title="All 4 branches covered.">			if (s != null &amp;&amp; s.startsWith(Constants.LST_DOT_CLEAR))</span>
			{
<span class="fc" id="L525">				throw new IllegalArgumentException(&quot;Cannot set a value to &quot; + s);</span>
			}
<span class="fc" id="L527">			getPositive(sourceURI, cdo).put(sk, s);</span>
<span class="fc" id="L528">		}</span>

		@Override
		public void remove(CDOMObject cdo, StringKey sk)
		{
<span class="fc" id="L533">			getNegative(sourceURI, cdo).addToListFor(ListKey.REMOVED_STRINGKEY, sk);</span>
<span class="fc" id="L534">		}</span>

		@Override
		public &lt;T&gt; void put(CDOMObject cdo, ObjectKey&lt;T&gt; sk, T s)
		{
<span class="fc" id="L539">			getPositive(sourceURI, cdo).put(sk, s);</span>
<span class="fc" id="L540">		}</span>

		@Override
		public void remove(CDOMObject cdo, ObjectKey&lt;?&gt; sk)
		{
<span class="fc" id="L545">			getNegative(sourceURI, cdo).addToListFor(ListKey.REMOVED_OBJECTKEY, sk);</span>
<span class="fc" id="L546">		}</span>

		@Override
		public &lt;T&gt; void put(CDOMObject cdo, FactKey&lt;T&gt; sk, Indirect&lt;T&gt; s)
		{
<span class="fc" id="L551">			getPositive(sourceURI, cdo).put(sk, s);</span>
<span class="fc" id="L552">		}</span>

		@Override
		public void remove(CDOMObject cdo, FactKey&lt;?&gt; sk)
		{
<span class="nc" id="L557">			getNegative(sourceURI, cdo).addToListFor(ListKey.REMOVED_FACTKEY, sk);</span>
<span class="nc" id="L558">		}</span>

		@Override
		public boolean containsSetFor(CDOMObject cdo, FactSetKey&lt;?&gt; key)
		{
<span class="nc" id="L563">			return cdo.containsSetFor(key);</span>
		}

		@Override
		public &lt;T&gt; void addToSet(CDOMObject cdo, FactSetKey&lt;T&gt; key, Indirect&lt;T&gt; value)
		{
<span class="fc" id="L569">			getPositive(sourceURI, cdo).addToSetFor(key, value);</span>
<span class="fc" id="L570">		}</span>

		@Override
		public void removeSet(CDOMObject cdo, FactSetKey&lt;?&gt; lk)
		{
<span class="nc" id="L575">			globalClearFactSet.addToListFor(sourceURI, cdo, lk);</span>
<span class="nc" id="L576">		}</span>

		@Override
		public &lt;T&gt; void removeFromSet(CDOMObject cdo, FactSetKey&lt;T&gt; lk, Indirect&lt;T&gt; val)
		{
<span class="nc" id="L581">			getNegative(sourceURI, cdo).addToSetFor(lk, val);</span>
<span class="nc" id="L582">		}</span>

		@Override
		public void put(CDOMObject cdo, IntegerKey ik, Integer i)
		{
<span class="fc" id="L587">			getPositive(sourceURI, cdo).put(ik, i);</span>
<span class="fc" id="L588">		}</span>

		@Override
		public void remove(CDOMObject cdo, IntegerKey ik)
		{
<span class="nc" id="L593">			getNegative(sourceURI, cdo).addToListFor(ListKey.REMOVED_INTEGERKEY, ik);</span>
<span class="nc" id="L594">		}</span>

		@Override
		public void put(CDOMObject cdo, FormulaKey fk, Formula f)
		{
<span class="fc" id="L599">			getPositive(sourceURI, cdo).put(fk, f);</span>
<span class="fc" id="L600">		}</span>

		@Override
		public void put(CDOMObject cdo, VariableKey vk, Formula f)
		{
<span class="fc" id="L605">			getPositive(sourceURI, cdo).put(vk, f);</span>
<span class="fc" id="L606">		}</span>

		@Override
		public boolean containsListFor(CDOMObject cdo, ListKey&lt;?&gt; key)
		{
<span class="nc" id="L611">			return cdo.containsListFor(key);</span>
		}

		@Override
		public &lt;T&gt; void addToList(CDOMObject cdo, ListKey&lt;T&gt; key, T value)
		{
<span class="fc" id="L617">			getPositive(sourceURI, cdo).addToListFor(key, value);</span>
<span class="fc" id="L618">		}</span>

		@Override
		public void removeList(CDOMObject cdo, ListKey&lt;?&gt; lk)
		{
<span class="fc" id="L623">			globalClearSet.addToListFor(sourceURI, cdo, lk);</span>
<span class="fc" id="L624">		}</span>

		@Override
		public &lt;T&gt; void removeFromList(CDOMObject cdo, ListKey&lt;T&gt; lk, T val)
		{
<span class="fc" id="L629">			getNegative(sourceURI, cdo).addToListFor(lk, val);</span>
<span class="fc" id="L630">		}</span>

		// ==== MapKey manipulation functions ====

		@Override
		public &lt;K, V&gt; void put(CDOMObject cdo, MapKey&lt;K, V&gt; mk, K key, V value)
		{
<span class="fc" id="L637">			getPositive(sourceURI, cdo).addToMapFor(mk, key, value);</span>
<span class="fc" id="L638">		}</span>

		@Override
		public &lt;K, V&gt; void remove(CDOMObject cdo, MapKey&lt;K, V&gt; mk, K key)
		{
<span class="nc" id="L643">			getNegative(sourceURI, cdo).addToMapFor(mk, key, null);</span>
<span class="nc" id="L644">		}</span>

		@Override
		public &lt;K, V&gt; MapChanges&lt;K, V&gt; getMapChanges(CDOMObject cdo, MapKey&lt;K, V&gt; mk)
		{
<span class="nc" id="L649">			return new MapChanges&lt;&gt;(getPositive(extractURI, cdo).getMapFor(mk),</span>
<span class="nc" id="L650">				getNegative(extractURI, cdo).getMapFor(mk), false);</span>
		}

		// ==== end of MapKey manipulation functions ====

		@Override
		public String getString(CDOMObject cdo, StringKey sk)
		{
<span class="nc" id="L658">			return getPositive(extractURI, cdo).get(sk);</span>
		}

		@Override
		public Integer getInteger(CDOMObject cdo, IntegerKey ik)
		{
<span class="nc" id="L664">			return getPositive(extractURI, cdo).get(ik);</span>
		}

		@Override
		public Formula getFormula(CDOMObject cdo, FormulaKey fk)
		{
<span class="nc" id="L670">			return getPositive(extractURI, cdo).get(fk);</span>
		}

		@Override
		public Formula getVariable(CDOMObject cdo, VariableKey key)
		{
<span class="nc" id="L676">			return getPositive(extractURI, cdo).get(key);</span>
		}

		@Override
		public Set&lt;VariableKey&gt; getVariableKeys(CDOMObject cdo)
		{
<span class="nc" id="L682">			return getPositive(extractURI, cdo).getVariableKeys();</span>
		}

		@Override
		public &lt;T&gt; T getObject(CDOMObject cdo, ObjectKey&lt;T&gt; ik)
		{
<span class="nc" id="L688">			return getPositive(extractURI, cdo).get(ik);</span>
		}

		@Override
		public &lt;T&gt; Indirect&lt;T&gt; getFact(CDOMObject cdo, FactKey&lt;T&gt; ik)
		{
<span class="nc" id="L694">			return getPositive(extractURI, cdo).get(ik);</span>
		}

		@Override
		public &lt;T&gt; Changes&lt;T&gt; getListChanges(CDOMObject cdo, ListKey&lt;T&gt; lk)
		{
<span class="nc" id="L700">			return new CollectionChanges&lt;&gt;(getPositive(extractURI, cdo).getListFor(lk),</span>
<span class="nc" id="L701">				getNegative(extractURI, cdo).getListFor(lk), globalClearSet.containsInList(extractURI, cdo, lk));</span>
		}

		@Override
		public &lt;T&gt; Changes&lt;Indirect&lt;T&gt;&gt; getSetChanges(CDOMObject cdo, FactSetKey&lt;T&gt; lk)
		{
<span class="nc" id="L707">			return new CollectionChanges&lt;&gt;(getPositive(extractURI, cdo).getSetFor(lk),</span>
<span class="nc" id="L708">				getNegative(extractURI, cdo).getSetFor(lk), globalClearFactSet.containsInList(extractURI, cdo, lk));</span>
		}

		@Override
		public &lt;T&gt; PatternChanges&lt;T&gt; getListPatternChanges(CDOMObject cdo, ListKey&lt;T&gt; lk)
		{
<span class="nc" id="L714">			return new PatternChanges&lt;&gt;(getPositive(extractURI, cdo).getListFor(lk),</span>
<span class="nc" id="L715">				patternClearSet.getListFor(extractURI, cdo, lk), globalClearSet.containsInList(extractURI, cdo, lk));</span>
		}

		public URI getExtractURI()
		{
<span class="nc" id="L720">			return extractURI;</span>
		}

		@Override
		public void setExtractURI(URI extractURI)
		{
<span class="fc" id="L726">			this.extractURI = extractURI;</span>
<span class="fc" id="L727">		}</span>

		public URI getSourceURI()
		{
<span class="nc" id="L731">			return sourceURI;</span>
		}

		@Override
		public void setSourceURI(URI sourceURI)
		{
<span class="fc" id="L737">			this.sourceURI = sourceURI;</span>
<span class="fc" id="L738">		}</span>

		public void decommit()
		{
<span class="fc" id="L742">			positiveMap.clear();</span>
<span class="fc" id="L743">			negativeMap.clear();</span>
<span class="fc" id="L744">			globalClearSet.clear();</span>
<span class="fc" id="L745">			preClearSet.clear();</span>
<span class="fc" id="L746">			patternClearSet.clear();</span>
<span class="fc" id="L747">		}</span>

		public &lt;T extends CDOMObject&gt; T cloneConstructedCDOMObject(T obj, String newName)
		{
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L752">			Class&lt;T&gt; cl = (Class&lt;T&gt;) obj.getClass();</span>
			try
			{
<span class="nc" id="L755">				T newObj = cl.newInstance();</span>
<span class="nc" id="L756">				newObj.setName(newName);</span>
				/*
				 * TODO Need to store this clone somewhere
				 */
<span class="nc" id="L760">				return newObj;</span>
			}
<span class="nc" id="L762">			catch (InstantiationException | IllegalAccessException e)</span>
			{
<span class="nc" id="L764">				Logging.errorPrint(&quot;Error instantiating &quot; + cl.getSimpleName(), e);</span>
			}
<span class="nc" id="L766">			return null;</span>
		}

		@Override
		public Changes&lt;Prerequisite&gt; getPrerequisiteChanges(ConcretePrereqObject obj)
		{
<span class="fc" id="L772">			return new CollectionChanges&lt;&gt;(getPositive(extractURI, obj).getPrerequisiteList(), null,</span>
<span class="fc" id="L773">				preClearSet.containsInList(extractURI, obj));</span>
		}

		@Override
		public &lt;T&gt; void removePatternFromList(CDOMObject cdo, ListKey&lt;T&gt; lk, String pattern)
		{
<span class="nc" id="L779">			patternClearSet.addToListFor(sourceURI, cdo, lk, pattern);</span>
<span class="nc" id="L780">		}</span>

		@Override
		public boolean wasRemoved(CDOMObject cdo, ObjectKey&lt;?&gt; ok)
		{
<span class="nc" id="L785">			return getNegative(extractURI, cdo).containsInList(ListKey.REMOVED_OBJECTKEY, ok);</span>
		}

		@Override
		public boolean wasRemoved(CDOMObject cdo, FactKey&lt;?&gt; ok)
		{
<span class="nc" id="L791">			return getNegative(extractURI, cdo).containsInList(ListKey.REMOVED_FACTKEY, ok);</span>
		}

		@Override
		public boolean wasRemoved(CDOMObject cdo, FactSetKey&lt;?&gt; ok)
		{
<span class="nc" id="L797">			return getNegative(extractURI, cdo).containsInList(ListKey.REMOVED_FACTSETKEY, ok);</span>
		}

		@Override
		public boolean wasRemoved(CDOMObject cdo, StringKey sk)
		{
<span class="nc" id="L803">			return getNegative(extractURI, cdo).containsInList(ListKey.REMOVED_STRINGKEY, sk);</span>
		}

		@Override
		public boolean wasRemoved(CDOMObject cdo, IntegerKey ik)
		{
<span class="nc" id="L809">			return getNegative(extractURI, cdo).containsInList(ListKey.REMOVED_INTEGERKEY, ik);</span>
		}

		public void purge(CDOMObject cdo)
		{
<span class="nc" id="L814">			positiveMap.remove(sourceURI, cdo);</span>
<span class="nc" id="L815">			negativeMap.remove(sourceURI, cdo);</span>
<span class="nc" id="L816">			globalClearSet.removeListFor(sourceURI, cdo);</span>
<span class="nc" id="L817">			preClearSet.removeFromListFor(sourceURI, cdo);</span>
<span class="nc" id="L818">			patternClearSet.removeListsFor(sourceURI, cdo);</span>
<span class="nc" id="L819">		}</span>
	}

	@Override
	public Changes&lt;Prerequisite&gt; getPrerequisiteChanges(ConcretePrereqObject obj)
	{
<span class="fc" id="L825">		return getCommitStrategy().getPrerequisiteChanges(obj);</span>
	}

	@Override
	public boolean containsListFor(CDOMObject obj, ListKey&lt;?&gt; lk)
	{
<span class="fc" id="L831">		return getCommitStrategy().containsListFor(obj, lk);</span>
	}

	@Override
	public boolean containsSetFor(CDOMObject obj, FactSetKey&lt;?&gt; lk)
	{
<span class="nc" id="L837">		return getCommitStrategy().containsSetFor(obj, lk);</span>
	}

	@Override
	public &lt;T&gt; void removePatternFromList(CDOMObject cdo, ListKey&lt;T&gt; lk, String pattern)
	{
<span class="nc" id="L843">		edits.removePatternFromList(cdo, lk, pattern);</span>
<span class="nc" id="L844">	}</span>

	@Override
	public &lt;T&gt; PatternChanges&lt;T&gt; getListPatternChanges(CDOMObject cdo, ListKey&lt;T&gt; lk)
	{
<span class="fc" id="L849">		return getCommitStrategy().getListPatternChanges(cdo, lk);</span>
	}

	@Override
	public boolean wasRemoved(CDOMObject cdo, ObjectKey&lt;?&gt; ok)
	{
<span class="fc" id="L855">		return getCommitStrategy().wasRemoved(cdo, ok);</span>
	}

	@Override
	public boolean wasRemoved(CDOMObject cdo, FactKey&lt;?&gt; sk)
	{
<span class="fc" id="L861">		return getCommitStrategy().wasRemoved(cdo, sk);</span>
	}

	@Override
	public boolean wasRemoved(CDOMObject cdo, FactSetKey&lt;?&gt; sk)
	{
<span class="nc" id="L867">		return getCommitStrategy().wasRemoved(cdo, sk);</span>
	}

	@Override
	public boolean wasRemoved(CDOMObject cdo, StringKey sk)
	{
<span class="fc" id="L873">		return getCommitStrategy().wasRemoved(cdo, sk);</span>
	}

	@Override
	public boolean wasRemoved(CDOMObject cdo, IntegerKey ik)
	{
<span class="fc" id="L879">		return getCommitStrategy().wasRemoved(cdo, ik);</span>
	}

	protected abstract ObjectCommitStrategy getCommitStrategy();

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>