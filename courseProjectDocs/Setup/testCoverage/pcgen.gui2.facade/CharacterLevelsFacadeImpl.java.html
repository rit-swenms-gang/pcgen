<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CharacterLevelsFacadeImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.facade</a> &gt; <span class="el_source">CharacterLevelsFacadeImpl.java</span></div><h1>CharacterLevelsFacadeImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2010 (C) James Dempsey
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.gui2.facade;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import pcgen.cdom.base.Constants;
import pcgen.cdom.enumeration.CharID;
import pcgen.cdom.enumeration.SkillCost;
import pcgen.cdom.facet.BonusChangeFacet;
import pcgen.cdom.facet.BonusChangeFacet.BonusChangeEvent;
import pcgen.cdom.facet.BonusChangeFacet.BonusChangeListener;
import pcgen.cdom.facet.FacetLibrary;
import pcgen.cdom.facet.event.DataFacetChangeEvent;
import pcgen.cdom.facet.event.DataFacetChangeListener;
import pcgen.cdom.facet.model.SkillFacet;
import pcgen.cdom.inst.PCClassLevel;
import pcgen.core.Globals;
import pcgen.core.PCClass;
import pcgen.core.PlayerCharacter;
import pcgen.core.Skill;
import pcgen.core.SkillUtilities;
import pcgen.core.analysis.ChooseActivation;
import pcgen.core.analysis.SkillModifier;
import pcgen.core.analysis.SkillRankControl;
import pcgen.core.display.CharacterDisplay;
import pcgen.core.display.SkillDisplay;
import pcgen.core.pclevelinfo.PCLevelInfo;
import pcgen.facade.core.CharacterLevelFacade;
import pcgen.facade.core.CharacterLevelsFacade;
import pcgen.facade.core.DataSetFacade;
import pcgen.facade.core.UIDelegate;
import pcgen.facade.util.AbstractListFacade;
import pcgen.system.LanguageBundle;
import pcgen.util.Logging;
import pcgen.util.enumeration.Tab;

import org.jetbrains.annotations.Nullable;

/**
 * The Class {@code CharacterLevelsFacadeImpl} is an implementation of
 * the CharacterLevelsFacade interface for the new user interface. It allows 
 * the user interface to work with the class levels of a character.
 *
 * 
 */
public class CharacterLevelsFacadeImpl extends AbstractListFacade&lt;CharacterLevelFacade&gt;
		implements CharacterLevelsFacade, DataFacetChangeListener&lt;CharID, Skill&gt;, BonusChangeListener
{
	private PlayerCharacter theCharacter;
	private CharacterDisplay charDisplay;

	private final UIDelegate delegate;

	private List&lt;PCClass&gt; classLevels;
	private List&lt;CharacterLevelFacade&gt; charLevels;
	private final TodoManager todoManager;
	private CharID charID;
	private final DataSetFacade dataSetFacade;
	private final CharacterFacadeImpl characterFacadeImpl;

	/**
	 * Create a new CharacterLevelsFacadeImpl instance for a character.
	 * @param pc The character we are creating the instance for 
	 * @param delegate The user interface delegate that can do dialogs and choosers for us.
	 * @param todoManager The user tasks tracker.
	 * @param dataSetFacade The datasets that the character is using.
	 * @param characterFacadeImpl The facade managing the character.
	 */
	CharacterLevelsFacadeImpl(PlayerCharacter pc, UIDelegate delegate, TodoManager todoManager,
		DataSetFacade dataSetFacade, CharacterFacadeImpl characterFacadeImpl)
<span class="nc" id="L91">	{</span>
<span class="nc" id="L92">		this.theCharacter = pc;</span>
<span class="nc" id="L93">		this.characterFacadeImpl = characterFacadeImpl;</span>
<span class="nc" id="L94">		this.charDisplay = pc.getDisplay();</span>
<span class="nc" id="L95">		this.delegate = delegate;</span>
<span class="nc" id="L96">		this.todoManager = todoManager;</span>
<span class="nc" id="L97">		this.dataSetFacade = dataSetFacade;</span>
<span class="nc" id="L98">		initForCharacter();</span>
<span class="nc" id="L99">	}</span>

	/**
	 * Tidy up character listeners when closing the character. 
	 */
	void closeCharacter()
	{
<span class="nc" id="L106">		SkillFacet skillFacet = FacetLibrary.getFacet(SkillFacet.class);</span>
<span class="nc" id="L107">		skillFacet.removeDataFacetChangeListener(this);</span>
<span class="nc" id="L108">		BonusChangeFacet bcf = FacetLibrary.getFacet(BonusChangeFacet.class);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">		for (Skill skillFacade : dataSetFacade.getSkills())</span>
		{
<span class="nc" id="L111">			bcf.removeBonusChangeListener(this, &quot;SKILLRANK&quot;, skillFacade.getKeyName().toUpperCase());</span>
<span class="nc" id="L112">		}</span>
<span class="nc" id="L113">		theCharacter = null;</span>
<span class="nc" id="L114">		charDisplay = null;</span>
<span class="nc" id="L115">		charID = null;</span>
<span class="nc" id="L116">	}</span>

	/**
	 * Initialise the instance for the current character. 
	 */
	private void initForCharacter()
	{
<span class="nc" id="L123">		classLevels = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L124">		charLevels = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L125">		refreshClassList();</span>

<span class="nc" id="L127">		charID = theCharacter.getCharID();</span>
<span class="nc" id="L128">		SkillFacet skillFacet = FacetLibrary.getFacet(SkillFacet.class);</span>
<span class="nc" id="L129">		skillFacet.addDataFacetChangeListener(this);</span>
<span class="nc" id="L130">		BonusChangeFacet bcf = FacetLibrary.getFacet(BonusChangeFacet.class);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">		for (Skill skillFacade : dataSetFacade.getSkills())</span>
		{
<span class="nc" id="L133">			bcf.addBonusChangeListener(this, &quot;SKILLRANK&quot;, skillFacade.getKeyName().toUpperCase());</span>
<span class="nc" id="L134">		}</span>

<span class="nc" id="L136">	}</span>

	@Override
	public CharacterLevelFacade getElementAt(int index)
	{
<span class="nc bnc" id="L141" title="All 4 branches missed.">		if (index &lt; 0 || index &gt;= charLevels.size())</span>
		{
<span class="nc" id="L143">			return null;</span>
		}
<span class="nc" id="L145">		return charLevels.get(index);</span>
	}

	@Override
	public int getSize()
	{
<span class="nc" id="L151">		return charLevels.size();</span>
	}

	private void clearContents()
	{
<span class="nc" id="L156">		charLevels.clear();</span>
<span class="nc" id="L157">		fireElementsChanged(this);</span>
<span class="nc" id="L158">	}</span>

	private void addElement(CharacterLevelFacadeImpl levelFI)
	{
<span class="nc" id="L162">		int index = charLevels.size();</span>
<span class="nc" id="L163">		charLevels.add(levelFI);</span>
<span class="nc" id="L164">		fireElementAdded(this, levelFI, index);</span>
<span class="nc" id="L165">	}</span>

	private void removeElement(int i)
	{
<span class="nc" id="L169">		fireElementRemoved(this, charLevels.remove(i), i);</span>
<span class="nc" id="L170">	}</span>

	/**
	 * Update the list of class levels from scratch to match the current
	 * state of the character. 
	 */
	private void refreshClassList()
	{
<span class="nc" id="L178">		List&lt;PCClass&gt; newClasses = charDisplay.getClassList();</span>
<span class="nc" id="L179">		Collection&lt;PCLevelInfo&gt; levelInfo = charDisplay.getLevelInfo();</span>

<span class="nc" id="L181">		Map&lt;String, Integer&gt; levelCount = new HashMap&lt;&gt;();</span>
<span class="nc" id="L182">		Map&lt;String, PCClass&gt; classMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">		for (PCClass pcClass : newClasses)</span>
		{
<span class="nc" id="L185">			levelCount.put(pcClass.getKeyName(), 1);</span>
<span class="nc" id="L186">			classMap.put(pcClass.getKeyName(), pcClass);</span>
<span class="nc" id="L187">		}</span>

<span class="nc" id="L189">		classLevels.clear();</span>
<span class="nc" id="L190">		clearContents();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">		for (PCLevelInfo lvlInfo : levelInfo)</span>
		{
<span class="nc" id="L193">			final String classKeyName = lvlInfo.getClassKeyName();</span>
<span class="nc" id="L194">			PCClass currClass = classMap.get(classKeyName);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">			if (currClass == null)</span>
			{
<span class="nc" id="L197">				Logging</span>
<span class="nc" id="L198">					.errorPrint(&quot;No PCClass found for '&quot; + classKeyName + &quot;' in character's class list: &quot; + newClasses);</span>
<span class="nc" id="L199">				return;</span>
			}

<span class="nc" id="L202">			int clsLvlNum = levelCount.get(classKeyName);</span>
<span class="nc" id="L203">			levelCount.put(classKeyName, clsLvlNum + 1);</span>

<span class="nc" id="L205">			classLevels.add(currClass);</span>

<span class="nc" id="L207">			CharacterLevelFacadeImpl levelFI = new CharacterLevelFacadeImpl(currClass, classLevels.size());</span>
<span class="nc" id="L208">			addElement(levelFI);</span>
			//PCClassLevel classLevel = currClass.getClassLevel(clsLvlNum);
<span class="nc" id="L210">		}</span>
<span class="nc" id="L211">		updateSkillsTodo();</span>
<span class="nc" id="L212">	}</span>

	@Override
	public PCClass getClassTaken(CharacterLevelFacade level)
	{
<span class="nc bnc" id="L217" title="All 4 branches missed.">		if (level == null || !(level instanceof CharacterLevelFacadeImpl))</span>
		{
<span class="nc" id="L219">			return null;</span>
		}
<span class="nc" id="L221">		return classLevels.get(getLevelIndex(level));</span>
	}

	private PCClassLevel getClassLevel(CharacterLevelFacade level)
	{
<span class="nc bnc" id="L226" title="All 4 branches missed.">		if (level == null || !(level instanceof CharacterLevelFacadeImpl levelImpl))</span>
		{
<span class="nc" id="L228">			return null;</span>
		}
<span class="nc" id="L230">		int lvlIdx = levelImpl.getCharacterLevel() - 1;</span>

<span class="nc" id="L232">		final String classKeyName = charDisplay.getLevelInfoClassKeyName(lvlIdx);</span>
<span class="nc" id="L233">		PCClass aClass = theCharacter.getClassKeyed(classKeyName);</span>

<span class="nc bnc" id="L235" title="All 2 branches missed.">		if (aClass != null)</span>
		{
<span class="nc" id="L237">			final int clsLvl = charDisplay.getLevelInfoClassLevel(lvlIdx);</span>
<span class="nc" id="L238">			return charDisplay.getActiveClassLevel(aClass, clsLvl - 1);</span>
		}

<span class="nc" id="L241">		return null;</span>
	}

	@Override
	public int getHPGained(CharacterLevelFacade level)
	{
<span class="nc" id="L247">		int numHp = getHPRolled(level);</span>

<span class="nc" id="L249">		numHp += (int) charDisplay.getStatBonusTo(&quot;HP&quot;, &quot;BONUS&quot;);</span>

<span class="nc bnc" id="L251" title="All 2 branches missed.">		if (numHp &lt; 1)</span>
		{
<span class="nc" id="L253">			numHp = 1;</span>
		}

<span class="nc" id="L256">		return numHp;</span>

	}

	@Override
	public int getHPRolled(CharacterLevelFacade level)
	{
<span class="nc" id="L263">		PCClassLevel classLevel = getClassLevel(level);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">		if (classLevel == null)</span>
		{
<span class="nc" id="L266">			return 0;</span>
		}

<span class="nc" id="L269">		return charDisplay.getHP(classLevel);</span>
	}

	@Override
	public void setHPRolled(CharacterLevelFacade level, int hp)
	{
<span class="nc" id="L275">		PCClassLevel classLevel = getClassLevel(level);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">		if (classLevel != null)</span>
		{
<span class="nc" id="L278">			theCharacter.setHP(classLevel, hp);</span>
<span class="nc" id="L279">			fireHitPointEvent(this, getLevelIndex(level), false);</span>
		}
<span class="nc" id="L281">	}</span>

	PCLevelInfo getLevelInfo(CharacterLevelFacade level)
	{
<span class="nc bnc" id="L285" title="All 4 branches missed.">		if (level == null || !(level instanceof CharacterLevelFacadeImpl))</span>
		{
<span class="nc" id="L287">			return null;</span>
		}

<span class="nc" id="L290">		return charDisplay.getLevelInfo(getLevelIndex(level));</span>
	}

	private int getLevelIndex(CharacterLevelFacade level)
	{
<span class="nc" id="L295">		CharacterLevelFacadeImpl levelImpl = (CharacterLevelFacadeImpl) level;</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">		if (levelImpl == null)</span>
		{
<span class="nc" id="L298">			return 0;</span>
		}
<span class="nc" id="L300">		return levelImpl.getCharacterLevel() - 1;</span>
	}

	@Override
	public int getGainedSkillPoints(CharacterLevelFacade level)
	{
<span class="nc" id="L306">		PCLevelInfo classLevel = getLevelInfo(level);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">		if (classLevel == null)</span>
		{
<span class="nc" id="L309">			return 0;</span>
		}
<span class="nc" id="L311">		return classLevel.getSkillPointsGained(theCharacter);</span>
	}

	@Override
	public float getMaxRanks(CharacterLevelFacade level, SkillCost cost, boolean isClassForMaxRanks)
	{
<span class="nc bnc" id="L317" title="All 6 branches missed.">		if (cost == null || level == null || !(level instanceof CharacterLevelFacadeImpl levelImpl))</span>
		{
<span class="nc" id="L319">			return 0.0f;</span>
		}
<span class="nc bnc" id="L321" title="All 2 branches missed.">		if (cost.getCost() == 0)</span>
		{
<span class="nc" id="L323">			return Float.NaN;</span>
		}
<span class="nc bnc" id="L325" title="All 2 branches missed.">		SkillCost costForMaxRanks = isClassForMaxRanks ? SkillCost.CLASS : cost;</span>

<span class="nc bnc" id="L327" title="All 3 branches missed.">		return switch (costForMaxRanks)</span>
				{
<span class="nc" id="L329">					case CLASS -&gt; SkillUtilities.maxClassSkillForLevel(levelImpl.getCharacterLevel(), theCharacter)</span>
<span class="nc" id="L330">					                            .floatValue();</span>
<span class="nc" id="L331">					case CROSS_CLASS -&gt; SkillUtilities.maxCrossClassSkillForLevel(</span>
<span class="nc" id="L332">							levelImpl.getCharacterLevel(),</span>
							theCharacter
<span class="nc" id="L334">					).floatValue();</span>
					case EXCLUSIVE -&gt;
							// We can't test if the skill in question is valid for all classes
							// So just assume it is for the time being. A check on the total
							// levels for the skill itself will need to be made elsewhere
<span class="nc" id="L339">							SkillUtilities.maxClassSkillForLevel(levelImpl.getCharacterLevel(), theCharacter)</span>
<span class="nc" id="L340">							              .floatValue();</span>
				};
	}

	@Override
	public SkillCost getSkillCost(CharacterLevelFacade level, Skill skill)
	{
<span class="nc bnc" id="L347" title="All 6 branches missed.">		if (level != null &amp;&amp; level instanceof CharacterLevelFacadeImpl &amp;&amp; charDisplay != null)</span>
		{
<span class="nc" id="L349">			final String classKeyName = charDisplay.getLevelInfoClassKeyName(getLevelIndex(level));</span>
<span class="nc" id="L350">			PCClass aClass = theCharacter.getClassKeyed(classKeyName);</span>
<span class="nc" id="L351">			return theCharacter.getSkillCostForClass(skill, aClass);</span>
		}

<span class="nc" id="L354">		return null;</span>
	}

	@Override
	public boolean isClassSkillForMaxRanks(CharacterLevelFacade level, Skill skill)
	{
<span class="nc bnc" id="L360" title="All 2 branches missed.">		for (int i = 0; i &lt; charLevels.size(); i++)</span>
		{
<span class="nc" id="L362">			CharacterLevelFacade testLevel = getElementAt(i);</span>

<span class="nc bnc" id="L364" title="All 2 branches missed.">			if (getSkillCost(testLevel, skill) == SkillCost.CLASS)</span>
			{
<span class="nc" id="L366">				return true;</span>
			}

<span class="nc bnc" id="L369" title="All 2 branches missed.">			if (testLevel == level)</span>
			{
				// Break as we have reached the level to be checked and it hasn't been class yet
<span class="nc" id="L372">				return false;</span>
			}
		}
<span class="nc" id="L375">		return false;</span>
	}

	@Override
	public float getSkillRanks(@Nullable CharacterLevelFacade level, @Nullable Skill skill)
	{
		// TODO Ranks aren't stored by level - have compromised by returning the total. Further discussion needed
<span class="nc bnc" id="L382" title="All 2 branches missed.">		if (skill == null)</span>
		{
<span class="nc" id="L384">			return 0;</span>
		}
<span class="nc" id="L386">		return SkillRankControl.getTotalRank(theCharacter, skill);</span>
	}

	@Override
	public SkillBreakdown getSkillBreakdown(CharacterLevelFacade level, Skill skill)
	{
<span class="nc" id="L392">		SkillBreakdown sb = new SkillBreakdown();</span>
		// TODO Ranks aren't stored by level - have compromised by returning the total. Further discussion needed 
<span class="nc" id="L394">		sb.ranks = SkillRankControl.getTotalRank(theCharacter, skill);</span>
<span class="nc" id="L395">		sb.modifier = SkillModifier.modifier(skill, theCharacter);</span>
<span class="nc" id="L396">		sb.total = sb.modifier + (int) sb.ranks;</span>
<span class="nc" id="L397">		return sb;</span>
	}

	@Override
	public int getSpentSkillPoints(CharacterLevelFacade level)
	{
<span class="nc" id="L403">		PCLevelInfo classLevel = getLevelInfo(level);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">		if (classLevel == null)</span>
		{
<span class="nc" id="L406">			return 0;</span>
		}
<span class="nc" id="L408">		return classLevel.getSkillPointsGained(theCharacter) - classLevel.getSkillPointsRemaining();</span>
	}

	@Override
	public int getRemainingSkillPoints(CharacterLevelFacade level)
	{
<span class="nc" id="L414">		PCLevelInfo classLevel = getLevelInfo(level);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">		if (classLevel == null)</span>
		{
<span class="nc" id="L417">			return 0;</span>
		}
<span class="nc" id="L419">		return classLevel.getSkillPointsRemaining();</span>
	}

	@Override
	public boolean investSkillPoints(CharacterLevelFacade level, Skill skill, int points)
	{
<span class="nc bnc" id="L425" title="All 6 branches missed.">		if (points == 0 || level == null || !(level instanceof CharacterLevelFacadeImpl))</span>
		{
<span class="nc" id="L427">			Logging.errorPrint(</span>
				&quot;Invalid request to investSkillPoints in &quot; + skill + &quot;. Points: &quot; + points + &quot; level: &quot; + level);
<span class="nc" id="L429">			return false;</span>
		}

<span class="nc" id="L432">		PCLevelInfo classLevel = getLevelInfo(level);</span>
		int skillPool;
<span class="nc bnc" id="L434" title="All 2 branches missed.">		if (Globals.getGameModeHasPointPool())</span>
		{
<span class="nc" id="L436">			skillPool = theCharacter.getSkillPoints();</span>
		}
		else
		{
<span class="nc" id="L440">			skillPool = classLevel.getSkillPointsRemaining();</span>

<span class="nc bnc" id="L442" title="All 4 branches missed.">			if ((points &lt; 0) &amp;&amp; (((skillPool - points) &gt; classLevel.getSkillPointsGained(theCharacter))</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">				|| !classHasRanksIn(skill, ((CharacterLevelFacadeImpl) level).getSelectedClass())))</span>
			{
<span class="nc" id="L445">				level = findLevelWithSpentSkillPoints(points, skill);</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">				if (level == null)</span>
				{
<span class="nc" id="L448">					delegate.showInfoMessage(Constants.APPLICATION_NAME,</span>
<span class="nc" id="L449">						LanguageBundle.getFormattedString(&quot;in_iskErr_message_05&quot;, skill));</span>
<span class="nc" id="L450">					return false;</span>
				}

<span class="nc" id="L453">				classLevel = getLevelInfo(level);</span>
<span class="nc" id="L454">				skillPool = classLevel.getSkillPointsRemaining();</span>
			}
		}

<span class="nc bnc" id="L458" title="All 4 branches missed.">		if ((points &gt; 0) &amp;&amp; (points &gt; skillPool))</span>
		{
<span class="nc" id="L460">			delegate.showInfoMessage(Constants.APPLICATION_NAME,</span>
<span class="nc" id="L461">				LanguageBundle.getFormattedString(&quot;in_iskErr_message_04a&quot;, String.valueOf(skillPool)));</span>

<span class="nc" id="L463">			return false;</span>
		}

<span class="nc" id="L466">		SkillCost sc = getSkillCost(level, skill);</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">		if (sc == null)</span>
		{
<span class="nc" id="L469">			Logging.errorPrint(&quot;Failed to get skillcost for skill &quot; + skill + &quot;. Could not process request to invest &quot;</span>
				+ points + &quot; in the skill&quot;);
<span class="nc" id="L471">			return false;</span>
		}

<span class="nc bnc" id="L474" title="All 2 branches missed.">		if (sc.equals(SkillCost.EXCLUSIVE))</span>
		{
<span class="nc" id="L476">			delegate.showInfoMessage(Constants.APPLICATION_NAME, LanguageBundle.getString(&quot;in_iskErr_message_06&quot;));</span>

<span class="nc" id="L478">			return false;</span>
		}

<span class="nc" id="L481">		final double cost = sc.getCost();</span>
<span class="nc" id="L482">		double rank = points / cost;</span>

<span class="nc" id="L484">		boolean hasSkill = charDisplay.hasSkill(skill);</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">		if (!hasSkill)</span>
		{
<span class="nc" id="L487">			SkillDisplay.updateSkillsOutputOrder(theCharacter, skill);</span>
		}

<span class="nc" id="L490">		final String classKeyName = charDisplay.getLevelInfoClassKeyName(getLevelIndex(level));</span>
<span class="nc" id="L491">		PCClass aClass = theCharacter.getClassKeyed(classKeyName);</span>
<span class="nc" id="L492">		String errMessage = SkillRankControl.modRanks(rank, aClass, false, theCharacter, skill);</span>

<span class="nc bnc" id="L494" title="All 2 branches missed.">		if (&quot;&quot;.equals(errMessage)) //$NON-NLS-1$</span>
		{
<span class="nc" id="L496">			classLevel.setSkillPointsRemaining(skillPool - points);</span>
		}

<span class="nc bnc" id="L499" title="All 4 branches missed.">		if (ChooseActivation.hasNewChooseToken(skill) &amp;&amp; characterFacadeImpl != null)</span>
		{
<span class="nc" id="L501">			characterFacadeImpl.postLevellingUpdates();</span>
		}

<span class="nc bnc" id="L504" title="All 2 branches missed.">		if (!errMessage.isEmpty())</span>
		{
<span class="nc" id="L506">			delegate.showInfoMessage(Constants.APPLICATION_NAME, errMessage);</span>

<span class="nc" id="L508">			return false;</span>
		}

<span class="nc" id="L511">		updateSkillsTodo();</span>
<span class="nc" id="L512">		fireSkillPointEvent(this, getLevelIndex(level), false);</span>
<span class="nc" id="L513">		fireSkillBonusEvent(this, getLevelIndex(level), false);</span>
<span class="nc" id="L514">		return true;</span>
	}

	@Override
	public CharacterLevelFacade findNextLevelForSkill(Skill skill, CharacterLevelFacade baseLevel, float newRank)
	{
<span class="nc" id="L520">		SkillCost skillCost = getSkillCost(baseLevel, skill);</span>
<span class="nc" id="L521">		float maxRanks = getMaxRanks(baseLevel, skillCost, isClassSkillForMaxRanks(baseLevel, skill));</span>

<span class="nc" id="L523">		float currRank = SkillRankControl.getTotalRank(theCharacter, skill);</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">		if (newRank &lt; currRank)</span>
		{
			// 1. Selected level (if class had purchased a rank and is not above max ranks)
<span class="nc bnc" id="L527" title="All 2 branches missed.">			if (classHasRanksIn(skill, ((CharacterLevelFacadeImpl) baseLevel).getSelectedClass())</span>
<span class="nc bnc" id="L528" title="All 6 branches missed.">				&amp;&amp; !Float.isNaN(maxRanks) &amp;&amp; maxRanks &gt;= currRank &amp;&amp; getSpentSkillPoints(baseLevel) &gt; 0)</span>
			{
<span class="nc" id="L530">				return baseLevel;</span>
			}

			// 2. Scan from level 1 for first level of the same class as currently 
			// selected level in which the rank to be removed is below max ranks and 
			// is a class that has bought ranks in the class
<span class="nc" id="L536">			CharacterLevelFacade levelToRefundSkill =</span>
<span class="nc" id="L537">					scanForLevelToRefundSkill(skill, currRank, getClassTaken(baseLevel));</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">			if (levelToRefundSkill != null)</span>
			{
<span class="nc" id="L540">				return levelToRefundSkill;</span>
			}

			// 3. Scan from level 1 for first level of any class in which the rank 
			// to be removed is below max ranks and is a class that has bought 
			// ranks in the class
<span class="nc" id="L546">			levelToRefundSkill = scanForLevelToRefundSkill(skill, currRank, null);</span>
<span class="nc" id="L547">			return levelToRefundSkill;</span>
		}

		// Check if current level ok
<span class="nc bnc" id="L551" title="All 6 branches missed.">		if (!Float.isNaN(maxRanks) &amp;&amp; maxRanks &gt;= newRank &amp;&amp; getRemainingSkillPoints(baseLevel) &gt; 0)</span>
		{
<span class="nc" id="L553">			return baseLevel;</span>
		}

		// Check for class cost on this level or higher
<span class="nc" id="L557">		int baseLevelIndex = getLevelIndex(baseLevel);</span>
<span class="nc" id="L558">		CharacterLevelFacade levelToBuySkill =</span>
<span class="nc" id="L559">				scanForwardforLevelToBuySkill(skill, newRank, baseLevelIndex, SkillCost.CLASS);</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">		if (levelToBuySkill != null)</span>
		{
<span class="nc" id="L562">			return levelToBuySkill;</span>
		}
		// Check for class cost on any level
<span class="nc" id="L565">		levelToBuySkill = scanForwardforLevelToBuySkill(skill, newRank, 0, SkillCost.CLASS);</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">		if (levelToBuySkill != null)</span>
		{
<span class="nc" id="L568">			return levelToBuySkill;</span>
		}
		// Check for any cost on this level or higher
<span class="nc" id="L571">		levelToBuySkill = scanForwardforLevelToBuySkill(skill, newRank, baseLevelIndex, null);</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">		if (levelToBuySkill != null)</span>
		{
<span class="nc" id="L574">			return levelToBuySkill;</span>
		}
		// Check for any cost on any level
<span class="nc" id="L577">		levelToBuySkill = scanForwardforLevelToBuySkill(skill, newRank, 0, null);</span>

<span class="nc" id="L579">		return levelToBuySkill;</span>
	}

	private CharacterLevelFacade scanForwardforLevelToBuySkill(Skill aSkill, float testRank, int baseLevelIndex,
		SkillCost costToMatch)
	{
<span class="nc bnc" id="L585" title="All 2 branches missed.">		for (int i = baseLevelIndex; i &lt; charLevels.size(); i++)</span>
		{
<span class="nc" id="L587">			CharacterLevelFacade testLevel = getElementAt(i);</span>
			//Logging.errorPrint(&quot;Checking &quot; + testLevel);
<span class="nc bnc" id="L589" title="All 2 branches missed.">			if (getRemainingSkillPoints(testLevel) &lt;= 0)</span>
			{
				//Logging.errorPrint(&quot;Skipping level &quot; + testLevel + &quot; as it does not have points left.&quot;);
<span class="nc" id="L592">				continue;</span>
			}
<span class="nc" id="L594">			SkillCost skillCost = getSkillCost(testLevel, aSkill);</span>
<span class="nc bnc" id="L595" title="All 4 branches missed.">			if (costToMatch != null &amp;&amp; skillCost.getCost() != costToMatch.getCost())</span>
			{
				//Logging.errorPrint(&quot;Skipping level &quot; + testLevel + &quot; as it is not the same cost as &quot; + costToMatch);
<span class="nc" id="L598">				continue;</span>
			}
<span class="nc" id="L600">			float maxRanks = getMaxRanks(testLevel, skillCost, isClassSkillForMaxRanks(testLevel, aSkill));</span>
<span class="nc bnc" id="L601" title="All 4 branches missed.">			if (!Float.isNaN(maxRanks) &amp;&amp; maxRanks &gt;= testRank)</span>
			{
				//Logging.errorPrint(&quot;Selected level &quot; + testLevel);
<span class="nc" id="L604">				return testLevel;</span>
			}
			//Logging.errorPrint(&quot;Skipping level &quot; + testLevel + &quot; as skill is above max ranks&quot;);
		}
<span class="nc" id="L608">		return null;</span>
	}

	private CharacterLevelFacade scanForLevelToRefundSkill(Skill aSkill, float testRank, PCClass classToMatch)
	{
<span class="nc bnc" id="L613" title="All 2 branches missed.">		for (int i = 0; i &lt; charLevels.size(); i++)</span>
		{
<span class="nc" id="L615">			CharacterLevelFacade testLevel = getElementAt(i);</span>
			//Logging.errorPrint(&quot;Checking &quot; + testLevel);
<span class="nc" id="L617">			String lvlClassName = getLevelInfo(testLevel).getClassKeyName();</span>
<span class="nc bnc" id="L618" title="All 4 branches missed.">			if (classToMatch != null &amp;&amp; !classToMatch.getKeyName().equals(lvlClassName))</span>
			{
				//Logging.errorPrint(&quot;Skipping level &quot; + testLevel + &quot; as it is not the same class as &quot; + classToMatch);
<span class="nc" id="L621">				continue;</span>
			}
<span class="nc bnc" id="L623" title="All 2 branches missed.">			if (!classHasRanksIn(aSkill, ((CharacterLevelFacadeImpl) testLevel).getSelectedClass()))</span>
			{
				//Logging.errorPrint(&quot;Skipping level &quot; + testLevel + &quot; as it does not have ranks in &quot; + aSkill);
<span class="nc" id="L626">				continue;</span>
			}
<span class="nc bnc" id="L628" title="All 2 branches missed.">			if (getSpentSkillPoints(testLevel) &lt;= 0)</span>
			{
				//Logging.errorPrint(&quot;Skipping level &quot; + testLevel + &quot; as it does not have spent points.&quot;);
<span class="nc" id="L631">				continue;</span>
			}
<span class="nc" id="L633">			SkillCost skillCost = getSkillCost(testLevel, aSkill);</span>
<span class="nc" id="L634">			float maxRanks = getMaxRanks(testLevel, skillCost, isClassSkillForMaxRanks(testLevel, aSkill));</span>
<span class="nc bnc" id="L635" title="All 4 branches missed.">			if (!Float.isNaN(maxRanks) &amp;&amp; maxRanks &gt;= testRank)</span>
			{
				//Logging.errorPrint(&quot;Selected level &quot; + testLevel);
<span class="nc" id="L638">				return testLevel;</span>
			}
			//Logging.errorPrint(&quot;Skipping level &quot; + testLevel + &quot; as skill is above max ranks&quot;);
		}
<span class="nc" id="L642">		return null;</span>
	}

	/**
	 * Find a level which has a certain number of points spent.
	 * @param points The negative number of points spent required.
	 * @param skill 
	 * @return The level with spent points, or null if none match
	 */
	private CharacterLevelFacade findLevelWithSpentSkillPoints(int points, Skill skill)
	{
<span class="nc bnc" id="L653" title="All 2 branches missed.">		for (int i = charLevels.size() - 1; i &gt;= 0; i--)</span>
		{
<span class="nc" id="L655">			CharacterLevelFacadeImpl levelFacade = (CharacterLevelFacadeImpl) charLevels.get(i);</span>
<span class="nc" id="L656">			PCLevelInfo levelInfo = getLevelInfo(levelFacade);</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">			if (levelInfo.getSkillPointsRemaining() - points &lt;= levelInfo.getSkillPointsGained(theCharacter))</span>
			{
<span class="nc bnc" id="L659" title="All 2 branches missed.">				if (classHasRanksIn(skill, levelFacade.getSelectedClass()))</span>
				{
<span class="nc" id="L661">					return levelFacade;</span>
				}
			}
		}
<span class="nc" id="L665">		return null;</span>
	}

	/**
	 * Identify if the class has ranks in the skill.
	 * @param skill The skill to be checked for.
	 * @param pcClass The class being checked.
	 * @return true if the character took ranks of the skill in the class.
	 */
	private boolean classHasRanksIn(Skill skill, PCClass pcClass)
	{
<span class="nc" id="L676">		Double rank = theCharacter.getSkillRankForClass(skill, pcClass);</span>
<span class="nc bnc" id="L677" title="All 4 branches missed.">		return (rank != null) &amp;&amp; (rank &gt; 0.0d);</span>
	}

	void updateSkillsTodo()
	{
<span class="nc" id="L682">		int remainingPoints = calcRemainingSkillPoints();</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">		if (remainingPoints &lt; 0)</span>
		{
<span class="nc" id="L685">			todoManager.addTodo(new TodoFacadeImpl(Tab.SKILLS, &quot;Skills&quot;, &quot;in_iskTodoTooMany&quot;, 1));</span>
<span class="nc" id="L686">			todoManager.removeTodo(&quot;in_iskTodoRemain&quot;);</span>
		}
<span class="nc bnc" id="L688" title="All 2 branches missed.">		else if (remainingPoints &gt; 0)</span>
		{
<span class="nc" id="L690">			todoManager.addTodo(new TodoFacadeImpl(Tab.SKILLS, &quot;Skills&quot;, &quot;in_iskTodoRemain&quot;, 1));</span>
<span class="nc" id="L691">			todoManager.removeTodo(&quot;in_iskTodoTooMany&quot;);</span>
		}
		else
		{
<span class="nc" id="L695">			todoManager.removeTodo(&quot;in_iskTodoRemain&quot;);</span>
<span class="nc" id="L696">			todoManager.removeTodo(&quot;in_iskTodoTooMany&quot;);</span>
		}
<span class="nc" id="L698">	}</span>

	/**
	 * @return The total of each level's remaining skill points.
	 */
	private int calcRemainingSkillPoints()
	{
<span class="nc" id="L705">		return charLevels.stream()</span>
<span class="nc" id="L706">		                 .mapToInt(this::getRemainingSkillPoints)</span>
<span class="nc" id="L707">		                 .sum();</span>
	}

	@Override
	public void setGainedSkillPoints(CharacterLevelFacade level, int points)
	{
<span class="nc" id="L713">		int spentSkillPoints = getSpentSkillPoints(level);</span>
<span class="nc" id="L714">		PCLevelInfo classLevel = getLevelInfo(level);</span>
<span class="nc" id="L715">		classLevel.setSkillPointsGained(theCharacter, points);</span>
<span class="nc" id="L716">		classLevel.setSkillPointsRemaining(points - spentSkillPoints);</span>

<span class="nc" id="L718">		fireSkillPointEvent(this, getLevelIndex(level), false);</span>
<span class="nc" id="L719">	}</span>

	// ============== Level Management code =========================

	/**
	 * Register the addition of a new level to the character of the 
	 * specified class. It is expected that the backing PlayerCharacter object 
	 * will be updated by our caller.
	 * @param theClassLevel The class the level is in.
	 */
	void addLevelOfClass(CharacterLevelFacadeImpl theClassLevel)
	{
<span class="nc" id="L731">		PCClass theClass = theClassLevel.getSelectedClass();</span>
<span class="nc" id="L732">		classLevels.add(theClass);</span>
<span class="nc" id="L733">		addElement(theClassLevel);</span>
<span class="nc" id="L734">		updateSkillsTodo();</span>
<span class="nc" id="L735">	}</span>

	/**
	 * Remove the last level gained. It is expected that the backing 
	 * PlayerCharacter object will be updated by our caller.
	 */
	void removeLastLevel()
	{
<span class="nc" id="L743">		classLevels.remove(classLevels.size() - 1);</span>
<span class="nc" id="L744">		removeElement(getSize() - 1);</span>
<span class="nc" id="L745">		updateSkillsTodo();</span>
<span class="nc" id="L746">	}</span>

	void classListRefreshRequired()
	{
<span class="nc" id="L750">		refreshClassList();</span>
<span class="nc" id="L751">		fireClassChangedEvent(this, 0, true);</span>
<span class="nc" id="L752">		fireSkillBonusEvent(this, 0, true);</span>
<span class="nc" id="L753">	}</span>

	// ============== Listener Management code =========================

	@Override
	public void addClassListener(ClassListener listener)
	{
<span class="nc" id="L760">		listenerList.add(ClassListener.class, listener);</span>
<span class="nc" id="L761">	}</span>

	@Override
	public void addHitPointListener(HitPointListener listener)
	{
<span class="nc" id="L766">		listenerList.add(HitPointListener.class, listener);</span>
<span class="nc" id="L767">	}</span>

	@Override
	public void addSkillBonusListener(SkillBonusListener listener)
	{
<span class="nc" id="L772">		listenerList.add(SkillBonusListener.class, listener);</span>
<span class="nc" id="L773">	}</span>

	@Override
	public void addSkillPointListener(SkillPointListener listener)
	{
<span class="nc" id="L778">		listenerList.add(SkillPointListener.class, listener);</span>
<span class="nc" id="L779">	}</span>

	@Override
	public void removeHitPointListener(HitPointListener listener)
	{
<span class="nc" id="L784">		listenerList.remove(HitPointListener.class, listener);</span>
<span class="nc" id="L785">	}</span>

	@Override
	public void removeSkillBonusListener(SkillBonusListener listener)
	{
<span class="nc" id="L790">		listenerList.remove(SkillBonusListener.class, listener);</span>
<span class="nc" id="L791">	}</span>

	@Override
	public void removeSkillPointListener(SkillPointListener listener)
	{
<span class="nc" id="L796">		listenerList.remove(SkillPointListener.class, listener);</span>
<span class="nc" id="L797">	}</span>

	private void fireClassChangedEvent(Object source, int baseLevelIndex, boolean stacks)
	{
<span class="nc" id="L801">		Object[] listeners = listenerList.getListenerList();</span>
<span class="nc" id="L802">		CharacterLevelEvent e = null;</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">		for (int i = listeners.length - 2; i &gt;= 0; i -= 2)</span>
		{
<span class="nc bnc" id="L805" title="All 2 branches missed.">			if (listeners[i] == ClassListener.class)</span>
			{
<span class="nc bnc" id="L807" title="All 2 branches missed.">				if (e == null)</span>
				{
<span class="nc" id="L809">					e = new CharacterLevelEvent(source, baseLevelIndex, stacks);</span>
				}
<span class="nc" id="L811">				((ClassListener) listeners[i + 1]).classChanged(e);</span>
			}
		}
<span class="nc" id="L814">	}</span>

	private void fireHitPointEvent(Object source, int baseLevelIndex, boolean stacks)
	{
<span class="nc" id="L818">		Object[] listeners = listenerList.getListenerList();</span>
<span class="nc" id="L819">		CharacterLevelEvent e = null;</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">		for (int i = listeners.length - 2; i &gt;= 0; i -= 2)</span>
		{
<span class="nc bnc" id="L822" title="All 2 branches missed.">			if (listeners[i] == HitPointListener.class)</span>
			{
<span class="nc bnc" id="L824" title="All 2 branches missed.">				if (e == null)</span>
				{
<span class="nc" id="L826">					e = new CharacterLevelEvent(source, baseLevelIndex, stacks);</span>
				}
<span class="nc" id="L828">				((HitPointListener) listeners[i + 1]).hitPointsChanged(e);</span>
			}
		}
<span class="nc" id="L831">	}</span>

	private void fireSkillPointEvent(Object source, int baseLevelIndex, boolean stacks)
	{
<span class="nc" id="L835">		Object[] listeners = listenerList.getListenerList();</span>
<span class="nc" id="L836">		CharacterLevelEvent e = null;</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">		for (int i = listeners.length - 2; i &gt;= 0; i -= 2)</span>
		{
<span class="nc bnc" id="L839" title="All 2 branches missed.">			if (listeners[i] == SkillPointListener.class)</span>
			{
<span class="nc bnc" id="L841" title="All 2 branches missed.">				if (e == null)</span>
				{
<span class="nc" id="L843">					e = new CharacterLevelEvent(source, baseLevelIndex, stacks);</span>
				}
<span class="nc" id="L845">				((SkillPointListener) listeners[i + 1]).skillPointsChanged(e);</span>
			}
		}
<span class="nc" id="L848">	}</span>

	void fireSkillBonusEvent(Object source, int baseLevelIndex, boolean stacks)
	{
<span class="nc" id="L852">		Object[] listeners = listenerList.getListenerList();</span>
<span class="nc" id="L853">		CharacterLevelEvent e = null;</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">		for (int i = listeners.length - 2; i &gt;= 0; i -= 2)</span>
		{
<span class="nc bnc" id="L856" title="All 2 branches missed.">			if (listeners[i] == SkillBonusListener.class)</span>
			{
<span class="nc bnc" id="L858" title="All 2 branches missed.">				if (e == null)</span>
				{
<span class="nc" id="L860">					e = new CharacterLevelEvent(source, baseLevelIndex, stacks);</span>
				}
<span class="nc" id="L862">				((SkillBonusListener) listeners[i + 1]).skillBonusChanged(e);</span>
			}
		}
<span class="nc" id="L865">	}</span>

	@Override
	public void dataAdded(DataFacetChangeEvent&lt;CharID, Skill&gt; dfce)
	{
<span class="nc bnc" id="L870" title="All 2 branches missed.">		if (dfce.getCharID() != charID)</span>
		{
<span class="nc" id="L872">			return;</span>
		}
<span class="nc" id="L874">		Skill skill = dfce.getCDOMObject();</span>
<span class="nc bnc" id="L875" title="All 2 branches missed.">		if (theCharacter.getRank(skill) &gt; 0)</span>
		{
<span class="nc" id="L877">			fireSkillBonusEvent(this, 0, true);</span>
		}
<span class="nc" id="L879">	}</span>

	@Override
	public void dataRemoved(DataFacetChangeEvent&lt;CharID, Skill&gt; dfce)
	{
<span class="nc bnc" id="L884" title="All 2 branches missed.">		if (dfce.getCharID() != charID)</span>
		{
<span class="nc" id="L886">			return;</span>
		}
		//Skill skill = dfce.getCDOMObject();
<span class="nc" id="L889">		fireSkillBonusEvent(this, 0, true);</span>
<span class="nc" id="L890">	}</span>

	@Override
	public void bonusChange(BonusChangeEvent bce)
	{
<span class="nc bnc" id="L895" title="All 4 branches missed.">		if (bce.getCharID() != charID || bce.getOldVal() == null)</span>
		{
<span class="nc" id="L897">			return;</span>
		}
<span class="nc" id="L899">		fireSkillBonusEvent(this, 0, true);</span>
<span class="nc" id="L900">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>