<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Gui2InfoFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.facade</a> &gt; <span class="el_source">Gui2InfoFactory.java</span></div><h1>Gui2InfoFactory.java</h1><pre class="source lang-java linenums">/**
 * Copyright James Dempsey, 2010
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.gui2.facade;

import java.io.File;
import java.math.BigDecimal;
import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.TreeMap;
import java.util.TreeSet;

import pcgen.base.formula.Formula;
import pcgen.base.lang.StringUtil;
import pcgen.base.util.Indirect;
import pcgen.cdom.base.CDOMObject;
import pcgen.cdom.base.CDOMReference;
import pcgen.cdom.base.ChooseInformation;
import pcgen.cdom.base.Constants;
import pcgen.cdom.content.CNAbility;
import pcgen.cdom.content.CNAbilityFactory;
import pcgen.cdom.content.HitDie;
import pcgen.cdom.content.LevelCommandFactory;
import pcgen.cdom.content.fact.FactDefinition;
import pcgen.cdom.content.factset.FactSetDefinition;
import pcgen.cdom.enumeration.AspectName;
import pcgen.cdom.enumeration.FactKey;
import pcgen.cdom.enumeration.FactSetKey;
import pcgen.cdom.enumeration.FormulaKey;
import pcgen.cdom.enumeration.IntegerKey;
import pcgen.cdom.enumeration.ListKey;
import pcgen.cdom.enumeration.MapKey;
import pcgen.cdom.enumeration.Nature;
import pcgen.cdom.enumeration.ObjectKey;
import pcgen.cdom.enumeration.RaceSubType;
import pcgen.cdom.enumeration.RaceType;
import pcgen.cdom.enumeration.SourceFormat;
import pcgen.cdom.enumeration.StringKey;
import pcgen.cdom.helper.AllowUtilities;
import pcgen.cdom.helper.Aspect;
import pcgen.cdom.reference.ReferenceUtilities;
import pcgen.cdom.util.CControl;
import pcgen.cdom.util.ControlUtilities;
import pcgen.core.Ability;
import pcgen.core.BenefitFormatting;
import pcgen.core.BonusManager.TempBonusInfo;
import pcgen.core.Deity;
import pcgen.core.Domain;
import pcgen.core.Equipment;
import pcgen.core.EquipmentModifier;
import pcgen.core.Globals;
import pcgen.core.Kit;
import pcgen.core.PCClass;
import pcgen.core.PCStat;
import pcgen.core.PCTemplate;
import pcgen.core.PlayerCharacter;
import pcgen.core.QualifiedObject;
import pcgen.core.Race;
import pcgen.core.SettingsHandler;
import pcgen.core.SimpleMovement;
import pcgen.core.Skill;
import pcgen.core.SpecialProperty;
import pcgen.core.SubClass;
import pcgen.core.WeaponProf;
import pcgen.core.analysis.BonusCalc;
import pcgen.core.analysis.OutputNameFormatting;
import pcgen.core.analysis.SkillInfoUtilities;
import pcgen.core.bonus.BonusObj;
import pcgen.core.character.CharacterSpell;
import pcgen.core.character.SpellBook;
import pcgen.core.character.SpellInfo;
import pcgen.core.character.WieldCategory;
import pcgen.core.display.CharacterDisplay;
import pcgen.core.display.DescriptionFormatting;
import pcgen.core.display.SkillCostDisplay;
import pcgen.core.display.TemplateModifier;
import pcgen.core.display.VisionDisplay;
import pcgen.core.kit.BaseKit;
import pcgen.core.prereq.PrerequisiteUtilities;
import pcgen.core.spell.Spell;
import pcgen.facade.core.AbilityFacade;
import pcgen.facade.core.EquipmentFacade;
import pcgen.facade.core.InfoFacade;
import pcgen.facade.core.InfoFactory;
import pcgen.facade.core.SpellFacade;
import pcgen.facade.core.TempBonusFacade;
import pcgen.gui2.util.HtmlInfoBuilder;
import pcgen.io.exporttoken.EqToken;
import pcgen.io.exporttoken.WeaponToken;
import pcgen.rules.context.LoadContext;
import pcgen.system.LanguageBundle;
import pcgen.system.PCGenSettings;
import pcgen.util.Delta;
import pcgen.util.Logging;
import pcgen.util.enumeration.Tab;
import pcgen.util.enumeration.View;
import pcgen.util.enumeration.Visibility;

import org.apache.commons.lang3.StringUtils;

/**
 * The Class {@code Gui2InfoFactory} provides character related information
 * on various facade objects. The information is displayed to the user via the
 * new user interface.
 *
 *
 */
public class Gui2InfoFactory implements InfoFactory
{
	/** A default return value for an invalid request. */
	private static final String EMPTY_STRING = &quot;&quot;; //$NON-NLS-1$
<span class="nc" id="L135">	private static final NumberFormat ADJ_FMT = new DecimalFormat(&quot;+0;-0&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L136">	private static final NumberFormat COST_FMT = new DecimalFormat(&quot;#,##0.##&quot;); //$NON-NLS-1$</span>

	/** Constant for 2 spaces in HTML */
	private static final String TWO_SPACES = &quot; &amp;nbsp;&quot;; //$NON-NLS-1$
	/** Constant for HTML bold start tag */
	private static final String BOLD = &quot;&lt;b&gt;&quot;; //$NON-NLS-1$
	/** Constant for HTML bold end tag */
	private static final String END_BOLD = &quot;&lt;/b&gt;&quot;; //$NON-NLS-1$

	private final PlayerCharacter pc;
	private final CharacterDisplay charDisplay;

	/**
	 * Create a new Gui2InfoFactory instance for the character.
	 * @param pc The character
	 */
	public Gui2InfoFactory(PlayerCharacter pc)
<span class="nc" id="L153">	{</span>
<span class="nc" id="L154">		this.pc = pc;</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">		this.charDisplay = pc == null ? null : pc.getDisplay();</span>
<span class="nc" id="L156">	}</span>

	@Override
	public String getFavoredClass(Race race)
	{
<span class="nc" id="L161">		String[] favClass = Globals.getContext().unparseSubtoken(race, &quot;FAVCLASS&quot;);</span>
<span class="nc" id="L162">		return StringUtil.join(favClass, &quot;, &quot;);</span>
	}

	@Override
	public String getHTMLInfo(Race race)
	{
<span class="nc" id="L168">		final HtmlInfoBuilder infoText = new HtmlInfoBuilder();</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">		if (!race.isUnselected())</span>
		{
<span class="nc" id="L172">			infoText.appendTitleElement(OutputNameFormatting.piString(race));</span>

<span class="nc" id="L174">			infoText.appendLineBreak();</span>
<span class="nc" id="L175">			RaceType rt = race.get(ObjectKey.RACETYPE);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">			if (rt != null)</span>
			{
<span class="nc" id="L178">				infoText.appendI18nElement(&quot;in_irInfoRaceType&quot;, rt.toString()); //$NON-NLS-1$</span>
			}

<span class="nc" id="L181">			List&lt;RaceSubType&gt; rst = race.getListFor(ListKey.RACESUBTYPE);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">			if (rst != null)</span>
			{
<span class="nc" id="L184">				infoText.appendSpacer();</span>
<span class="nc" id="L185">				infoText.appendI18nElement(&quot;in_irInfoSubType&quot;, StringUtil.join(rst, &quot;, &quot;)); //$NON-NLS-1$</span>
			}
<span class="nc bnc" id="L187" title="All 2 branches missed.">			if (!race.getType().isEmpty())</span>
			{
<span class="nc" id="L189">				infoText.appendSpacer();</span>
<span class="nc" id="L190">				infoText.appendI18nElement(&quot;in_irInfoType&quot;, race.getType()); //$NON-NLS-1$</span>
			}

<span class="nc" id="L193">			appendFacts(infoText, race);</span>

<span class="nc" id="L195">			infoText.appendLineBreak();</span>
<span class="nc" id="L196">			String size = getSize(race);</span>

<span class="nc bnc" id="L198" title="All 2 branches missed.">			if (StringUtils.isNotEmpty(size))</span>
			{
<span class="nc" id="L200">				infoText.appendI18nElement(&quot;in_size&quot;, size); //$NON-NLS-1$</span>
			}
<span class="nc" id="L202">			String movement = getMovement(race);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">			if (!movement.isEmpty())</span>
			{
<span class="nc" id="L205">				infoText.appendSpacer();</span>
<span class="nc" id="L206">				infoText.appendI18nElement(&quot;in_movement&quot;, movement); //$NON-NLS-1$</span>
			}
<span class="nc" id="L208">			String vision = getVision(race);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">			if (!vision.isEmpty())</span>
			{
<span class="nc" id="L211">				infoText.appendSpacer();</span>
<span class="nc" id="L212">				infoText.appendI18nElement(&quot;in_vision&quot;, vision); //$NON-NLS-1$</span>
			}

<span class="nc" id="L215">			String bString =</span>
<span class="nc" id="L216">					PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, race.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">			if (!bString.isEmpty())</span>
			{
<span class="nc" id="L219">				infoText.appendLineBreak();</span>
<span class="nc" id="L220">				infoText.appendI18nElement(&quot;in_requirements&quot;, bString); //$NON-NLS-1$</span>
			}
<span class="nc" id="L222">			String aString = AllowUtilities.getAllowInfo(pc, race);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">			if (!aString.isEmpty())</span>
			{
<span class="nc" id="L225">				infoText.appendLineBreak();</span>
<span class="nc" id="L226">				infoText.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
			}

<span class="nc" id="L229">			String desc = pc.getDescription(race);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">			if (!desc.isEmpty())</span>
			{
<span class="nc" id="L232">				infoText.appendLineBreak();</span>
<span class="nc" id="L233">				infoText.appendI18nFormattedElement(&quot;in_InfoDescription&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L234">					DescriptionFormatting.piWrapDesc(race, desc, false));</span>
			}

<span class="nc" id="L237">			String statAdjustments = getStatAdjustments(race);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">			if (StringUtils.isNotEmpty(statAdjustments))</span>
			{
<span class="nc" id="L240">				infoText.appendLineBreak();</span>
<span class="nc" id="L241">				infoText.appendI18nElement(&quot;in_irTableStat&quot;, statAdjustments); //$NON-NLS-1$</span>
			}

<span class="nc" id="L244">			LevelCommandFactory levelCommandFactory = race.get(ObjectKey.MONSTER_CLASS);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">			if (levelCommandFactory != null)</span>
			{
<span class="nc" id="L247">				infoText.appendLineBreak();</span>
<span class="nc" id="L248">				infoText.appendI18nFormattedElement(&quot;in_irInfoMonsterClass&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L249">					String.valueOf(levelCommandFactory.getLevelCount()),</span>
<span class="nc" id="L250">					OutputNameFormatting.piString(levelCommandFactory.getPCClass()));</span>

			}
<span class="nc" id="L253">			String favoredClass = getFavoredClass(race);</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">			if (StringUtils.isNotEmpty(favoredClass))</span>
			{
<span class="nc" id="L256">				infoText.appendLineBreak();</span>
<span class="nc" id="L257">				infoText.appendI18nElement(&quot;in_favoredClass&quot;, favoredClass); //$NON-NLS-1$</span>
			}
<span class="nc" id="L259">			bString = race.getSource();</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">			if (!bString.isEmpty())</span>
			{
<span class="nc" id="L262">				infoText.appendLineBreak();</span>
<span class="nc" id="L263">				infoText.appendI18nElement(&quot;in_sourceLabel&quot;, bString); //$NON-NLS-1$</span>
			}
		}

<span class="nc" id="L267">		return infoText.toString();</span>
	}

	@Override
	public String getHTMLInfo(PCClass aClass, PCClass possibleParentClass)
	{
<span class="nc" id="L273">		PCClass parentClass = aClass;</span>

		String aString;
<span class="nc" id="L276">		boolean isSubClass = aClass instanceof SubClass;</span>
<span class="nc bnc" id="L277" title="All 4 branches missed.">		if (isSubClass &amp;&amp; possibleParentClass != null)</span>
		{
<span class="nc" id="L279">			parentClass = possibleParentClass;</span>
		}

<span class="nc" id="L282">		final HtmlInfoBuilder b = new HtmlInfoBuilder(OutputNameFormatting.piString(aClass));</span>
<span class="nc" id="L283">		b.appendLineBreak();</span>

		// Subclass cost - at the top to make choices easier
<span class="nc bnc" id="L286" title="All 4 branches missed.">		if (isSubClass &amp;&amp; aClass.getSafe(IntegerKey.COST) != 0)</span>
		{
<span class="nc" id="L288">			b.appendI18nElement(&quot;in_clInfoCost&quot;, String.valueOf(aClass.getSafe(IntegerKey.COST))); //$NON-NLS-1$</span>
<span class="nc" id="L289">			b.appendLineBreak();</span>
		}

		// Type
<span class="nc" id="L293">		aString = aClass.getType();</span>
<span class="nc bnc" id="L294" title="All 4 branches missed.">		if (isSubClass &amp;&amp; (aString.isEmpty()))</span>
		{
<span class="nc" id="L296">			aString = parentClass.getType();</span>
		}
<span class="nc" id="L298">		b.appendI18nElement(&quot;in_clInfoType&quot;, aString); //$NON-NLS-1$</span>

		// Hit Die
<span class="nc" id="L301">		HitDie hitDie = aClass.getSafe(ObjectKey.LEVEL_HITDIE);</span>
<span class="nc bnc" id="L302" title="All 4 branches missed.">		if (isSubClass &amp;&amp; HitDie.ZERO.equals(hitDie))</span>
		{
<span class="nc" id="L304">			hitDie = parentClass.getSafe(ObjectKey.LEVEL_HITDIE);</span>
		}
<span class="nc bnc" id="L306" title="All 2 branches missed.">		if (!HitDie.ZERO.equals(hitDie))</span>
		{
<span class="nc" id="L308">			b.appendSpacer();</span>
<span class="nc" id="L309">			b.appendI18nElement(&quot;in_clInfoHD&quot;, &quot;d&quot; + hitDie.getDie()); //$NON-NLS-1$  //$NON-NLS-2$</span>
		}

<span class="nc" id="L312">		appendFacts(b, aClass);</span>

<span class="nc bnc" id="L314" title="All 2 branches missed.">		if (SettingsHandler.getGameAsProperty().get().getTabShown(Tab.SPELLS))</span>
		{
<span class="nc" id="L316">			FactKey&lt;String&gt; fk = FactKey.valueOf(&quot;SpellType&quot;);</span>
<span class="nc" id="L317">			aString = aClass.getResolved(fk);</span>

<span class="nc bnc" id="L319" title="All 4 branches missed.">			if (isSubClass &amp;&amp; aString == null)</span>
			{
<span class="nc" id="L321">				aString = parentClass.getSpellType();</span>
			}

<span class="nc" id="L324">			b.appendSpacer();</span>
<span class="nc" id="L325">			b.appendI18nElement(&quot;in_clInfoSpellType&quot;, aString); //$NON-NLS-1$</span>

<span class="nc" id="L327">			aString = aClass.getSpellBaseStat();</span>

			/*
			 * CONSIDER This test here is the ONLY place where the &quot;magical&quot;
			 * value of null is tested for in getSpellBaseStat(). This is
			 * currently set by SubClass and SubstititionClass, so it IS
			 * used, but the question is: Is there a better method for
			 * identifying this special deferral to the &quot;parentClass&quot; other
			 * than null SpellBaseStat? - thpr 11/9/06
			 */
<span class="nc bnc" id="L337" title="All 6 branches missed.">			if (isSubClass &amp;&amp; ((aString == null) || (aString.isEmpty())))</span>
			{
<span class="nc" id="L339">				aString = parentClass.getSpellBaseStat();</span>
			}

<span class="nc" id="L342">			b.appendSpacer();</span>
<span class="nc" id="L343">			b.appendI18nElement(&quot;in_clInfoBaseStat&quot;, aString); //$NON-NLS-1$</span>
		}

		// Prereqs
<span class="nc" id="L347">		aString = PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, aClass.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L348" title="All 4 branches missed.">		if (isSubClass &amp;&amp; (aString.isEmpty()))</span>
		{
<span class="nc" id="L350">			aString =</span>
<span class="nc" id="L351">					PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, parentClass.getPrerequisiteList(), false);</span>
		}
<span class="nc bnc" id="L353" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L355">			b.appendLineBreak();</span>
<span class="nc" id="L356">			b.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}
<span class="nc" id="L358">		aString = AllowUtilities.getAllowInfo(pc, aClass);</span>
<span class="nc bnc" id="L359" title="All 4 branches missed.">		if (isSubClass &amp;&amp; aString.isEmpty())</span>
		{
<span class="nc" id="L361">			aString = AllowUtilities.getAllowInfo(pc, parentClass);</span>
		}
<span class="nc bnc" id="L363" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L365">			b.appendLineBreak();</span>
<span class="nc" id="L366">			b.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

		//Description
<span class="nc" id="L370">		String desc = pc.getDescription(aClass);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">		if (!desc.isEmpty())</span>
		{
<span class="nc" id="L373">			b.appendLineBreak();</span>
<span class="nc" id="L374">			b.appendI18nFormattedElement(&quot;in_InfoDescription&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L375">				DescriptionFormatting.piWrapDesc(aClass, desc, false));</span>
		}
		// Sub class extra info
<span class="nc bnc" id="L378" title="All 2 branches missed.">		if (isSubClass)</span>
		{
<span class="nc" id="L380">			int specialtySpells = aClass.getSafe(IntegerKey.KNOWN_SPELLS_FROM_SPECIALTY);</span>
<span class="nc" id="L381">			b.appendLineBreak();</span>
<span class="nc" id="L382">			b.appendI18nElement(&quot;in_clSpecialtySpells&quot;, Delta.toString(specialtySpells)); //$NON-NLS-1$</span>
<span class="nc" id="L383">			b.appendSpacer();</span>
<span class="nc" id="L384">			b.appendI18nElement(&quot;in_clSpecialty&quot;, ((SubClass) aClass).getChoice()); //$NON-NLS-1$</span>
		}

		// Source
<span class="nc" id="L388">		aString = aClass.getSource();</span>
<span class="nc bnc" id="L389" title="All 4 branches missed.">		if (isSubClass &amp;&amp; (aString.isEmpty()))</span>
		{
<span class="nc" id="L391">			aString = parentClass.getSource();</span>
		}
<span class="nc bnc" id="L393" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L395">			b.appendLineBreak();</span>
<span class="nc" id="L396">			b.appendI18nElement(&quot;in_source&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L399">		return b.toString();</span>
	}

	@Override
	public String getHTMLInfo(Skill skill)
	{
<span class="nc bnc" id="L405" title="All 2 branches missed.">		if (skill == null)</span>
		{
<span class="nc" id="L407">			return EMPTY_STRING;</span>
		}

<span class="nc" id="L410">		final HtmlInfoBuilder infoText = new HtmlInfoBuilder();</span>

<span class="nc" id="L412">		infoText.appendTitleElement(OutputNameFormatting.piString(skill));</span>

<span class="nc" id="L414">		infoText.appendLineBreak();</span>
<span class="nc" id="L415">		String typeString = StringUtil.join(skill.getTrueTypeList(true), &quot;. &quot;);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">		if (StringUtils.isNotBlank(typeString))</span>
		{
<span class="nc" id="L418">			infoText.appendI18nElement(&quot;in_igInfoLabelTextType&quot;, //$NON-NLS-1$</span>
				typeString);
<span class="nc" id="L420">			infoText.appendLineBreak();</span>
		}

<span class="nc" id="L423">		appendFacts(infoText, skill);</span>

<span class="nc" id="L425">		String aString = SkillInfoUtilities.getKeyStatFromStats(pc, skill);</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L428">			infoText.appendI18nElement(&quot;in_iskKEY_STAT&quot;, aString); //$NON-NLS-1$</span>
		}
<span class="nc" id="L430">		infoText.appendLineBreak();</span>
<span class="nc" id="L431">		infoText.appendI18nElement(&quot;in_iskUntrained&quot;, //$NON-NLS-1$</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">			skill.getSafe(ObjectKey.USE_UNTRAINED) ? LanguageBundle.getString(&quot;in_yes&quot;)</span>
<span class="nc" id="L433">				: LanguageBundle.getString(&quot;in_no&quot;));</span>
<span class="nc" id="L434">		infoText.appendLineBreak();</span>
<span class="nc" id="L435">		infoText.appendI18nElement(&quot;in_iskEXCLUSIVE&quot;, //$NON-NLS-1$</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">			skill.getSafe(ObjectKey.EXCLUSIVE) ? LanguageBundle.getString(&quot;in_yes&quot;)</span>
<span class="nc" id="L437">				: LanguageBundle.getString(&quot;in_no&quot;));</span>

<span class="nc" id="L439">		String bString = PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, skill.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L442">			infoText.appendI18nFormattedElement(&quot;in_InfoRequirements&quot;, //$NON-NLS-1$</span>
				bString);
		}

<span class="nc" id="L446">		aString = AllowUtilities.getAllowInfo(pc, skill);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L449">			infoText.appendLineBreak();</span>
<span class="nc" id="L450">			infoText.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

		//Description
<span class="nc" id="L454">		String desc = pc.getDescription(skill);</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">		if (!desc.isEmpty())</span>
		{
<span class="nc" id="L457">			infoText.appendLineBreak();</span>
<span class="nc" id="L458">			infoText.appendI18nFormattedElement(&quot;in_InfoDescription&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L459">				DescriptionFormatting.piWrapDesc(skill, desc, false));</span>
		}

<span class="nc" id="L462">		bString = skill.getSource();</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L465">			infoText.appendLineBreak();</span>
<span class="nc" id="L466">			infoText.appendI18nElement(&quot;in_iskSource&quot;, bString); //$NON-NLS-1$</span>
		}

<span class="nc bnc" id="L469" title="All 2 branches missed.">		if (PCGenSettings.OPTIONS_CONTEXT.getBoolean(PCGenSettings.OPTION_SHOW_SKILL_MOD_BREAKDOWN, false))</span>
		{
<span class="nc" id="L471">			bString = SkillCostDisplay.getModifierExplanation(skill, pc, false);</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">			if (!bString.isEmpty())</span>
			{
<span class="nc" id="L474">				infoText.appendLineBreak();</span>
<span class="nc" id="L475">				infoText.appendI18nFormattedElement(&quot;in_iskHtml_PcMod&quot;, //$NON-NLS-1$</span>
					bString);
			}
		}

<span class="nc bnc" id="L480" title="All 2 branches missed.">		if (PCGenSettings.OPTIONS_CONTEXT.getBoolean(PCGenSettings.OPTION_SHOW_SKILL_RANK_BREAKDOWN, false))</span>
		{
<span class="nc" id="L482">			bString = SkillCostDisplay.getRanksExplanation(pc, skill);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">			if (bString.isEmpty())</span>
			{
<span class="nc" id="L485">				bString = LanguageBundle.getString(&quot;in_none&quot;); //$NON-NLS-1$</span>
			}
<span class="nc" id="L487">			infoText.appendLineBreak();</span>
<span class="nc" id="L488">			infoText.appendI18nFormattedElement(&quot;in_iskHtml_Ranks&quot;, //$NON-NLS-1$</span>
				bString);
		}

<span class="nc" id="L492">		return infoText.toString();</span>
	}

	@Override
	public String getHTMLInfo(AbilityFacade abilityFacade)
	{
<span class="nc bnc" id="L498" title="All 2 branches missed.">		if (!(abilityFacade instanceof Ability ability))</span>
		{
<span class="nc" id="L500">			return EMPTY_STRING;</span>
		}

<span class="nc" id="L503">		final HtmlInfoBuilder infoText = new HtmlInfoBuilder();</span>
<span class="nc" id="L504">		infoText.appendTitleElement(OutputNameFormatting.piString(ability));</span>
<span class="nc" id="L505">		infoText.appendLineBreak();</span>

<span class="nc" id="L507">		infoText.appendI18nFormattedElement(&quot;Ability.Info.Type&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L508">			StringUtil.join(ability.getTrueTypeList(true), &quot;. &quot;)); //$NON-NLS-1$</span>

<span class="nc" id="L510">		BigDecimal costStr = ability.getSafe(ObjectKey.SELECTION_COST);</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">		if (!costStr.equals(BigDecimal.ONE))</span>
		{
<span class="nc" id="L513">			infoText.appendI18nFormattedElement(&quot;Ability.Info.Cost&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L514">				COST_FMT.format(costStr));</span>
		}

<span class="nc bnc" id="L517" title="All 2 branches missed.">		if (ability.getSafe(ObjectKey.MULTIPLE_ALLOWED))</span>
		{
<span class="nc" id="L519">			infoText.appendSpacer();</span>
<span class="nc" id="L520">			infoText.append(LanguageBundle.getString(&quot;Ability.Info.Multiple&quot;)); //$NON-NLS-1$</span>
		}

<span class="nc bnc" id="L523" title="All 2 branches missed.">		if (ability.getSafe(ObjectKey.STACKS))</span>
		{
<span class="nc" id="L525">			infoText.appendSpacer();</span>
<span class="nc" id="L526">			infoText.append(LanguageBundle.getString(&quot;Ability.Info.Stacks&quot;)); //$NON-NLS-1$</span>
		}

<span class="nc" id="L529">		appendFacts(infoText, ability);</span>

<span class="nc" id="L531">		final String cString =</span>
<span class="nc" id="L532">				PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, ability.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">		if (!cString.isEmpty())</span>
		{
<span class="nc" id="L535">			infoText.appendI18nFormattedElement(&quot;in_InfoRequirements&quot;, //$NON-NLS-1$</span>
				cString);
		}

<span class="nc" id="L539">		String aString = AllowUtilities.getAllowInfo(pc, ability);</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L542">			infoText.appendLineBreak();</span>
<span class="nc" id="L543">			infoText.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L546">		infoText.appendLineBreak();</span>
<span class="nc" id="L547">		infoText.appendI18nFormattedElement(&quot;in_InfoDescription&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L548">			getDescription(abilityFacade));</span>

<span class="nc" id="L550">		List&lt;CNAbility&gt; wrappedAbility = getWrappedAbility(ability);</span>

<span class="nc bnc" id="L552" title="All 2 branches missed.">		if (ability.getSafeSizeOfMapFor(MapKey.ASPECT) &gt; 0)</span>
		{
<span class="nc" id="L554">			Set&lt;AspectName&gt; aspectKeys = ability.getKeysFor(MapKey.ASPECT);</span>
<span class="nc" id="L555">			StringBuilder buff = new StringBuilder(100);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">			for (AspectName key : aspectKeys)</span>
			{
<span class="nc bnc" id="L558" title="All 2 branches missed.">				if (buff.length() &gt; 0)</span>
				{
<span class="nc" id="L560">					buff.append(&quot;, &quot;);</span>
				}
				//Assert here that the actual text displayed is not critical
<span class="nc" id="L563">				buff.append(Aspect.printAspect(pc, key, wrappedAbility));</span>
<span class="nc" id="L564">			}</span>
<span class="nc" id="L565">			infoText.appendLineBreak();</span>
<span class="nc" id="L566">			infoText.appendI18nFormattedElement(&quot;Ability.Info.Aspects&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L567">				buff.toString());</span>
		}

<span class="nc" id="L570">		final String bene = BenefitFormatting.getBenefits(pc, wrappedAbility);</span>
<span class="nc bnc" id="L571" title="All 4 branches missed.">		if (bene != null &amp;&amp; !bene.isEmpty())</span>
		{
<span class="nc" id="L573">			infoText.appendLineBreak();</span>
<span class="nc" id="L574">			infoText.appendI18nFormattedElement(&quot;Ability.Info.Benefit&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L575">				BenefitFormatting.getBenefits(pc, wrappedAbility));</span>
		}

<span class="nc" id="L578">		infoText.appendLineBreak();</span>
<span class="nc" id="L579">		infoText.appendI18nFormattedElement(&quot;in_InfoSource&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L580">			ability.getSource());</span>

<span class="nc" id="L582">		return infoText.toString();</span>
	}

	@Override
	public String getHTMLInfo(Deity deity)
	{
<span class="nc bnc" id="L588" title="All 2 branches missed.">		if (deity == null)</span>
		{
<span class="nc" id="L590">			return EMPTY_STRING;</span>
		}
<span class="nc" id="L592">		final HtmlInfoBuilder infoText = new HtmlInfoBuilder();</span>

<span class="nc" id="L594">		infoText.appendTitleElement(OutputNameFormatting.piString(deity));</span>
<span class="nc" id="L595">		infoText.appendLineBreak();</span>

<span class="nc" id="L597">		infoText.appendI18nFormattedElement(&quot;in_InfoDescription&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L598">			DescriptionFormatting.piWrapDesc(deity, pc.getDescription(deity), false));</span>

<span class="nc" id="L600">		appendFacts(infoText, deity);</span>

<span class="nc" id="L602">		String aString = getPantheons(deity);</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">		if (aString != null)</span>
		{
<span class="nc" id="L605">			infoText.appendSpacer();</span>
<span class="nc" id="L606">			infoText.appendI18nElement(&quot;in_pantheon&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L609">		infoText.appendSpacer();</span>
<span class="nc" id="L610">		infoText.appendI18nElement(&quot;in_domains&quot;, getDomains(deity)); //$NON-NLS-1$</span>

<span class="nc" id="L612">		List&lt;CDOMReference&lt;WeaponProf&gt;&gt; dwp = deity.getListFor(ListKey.DEITYWEAPON);</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">		if (dwp != null)</span>
		{
<span class="nc" id="L615">			infoText.appendSpacer();</span>
<span class="nc" id="L616">			infoText.appendI18nFormattedElement(&quot;in_deityFavWeap&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L617">				ReferenceUtilities.joinLstFormat(dwp, &quot;|&quot;));</span>
		}

<span class="nc" id="L620">		aString = PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, deity.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L623">			infoText.appendSpacer();</span>
<span class="nc" id="L624">			infoText.appendI18nFormattedElement(&quot;in_InfoRequirements&quot;, //$NON-NLS-1$</span>
				aString);
		}

<span class="nc" id="L628">		aString = AllowUtilities.getAllowInfo(pc, deity);</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L631">			infoText.appendLineBreak();</span>
<span class="nc" id="L632">			infoText.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L635">		aString = deity.getSource();</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L638">			infoText.appendSpacer();</span>
<span class="nc" id="L639">			infoText.appendI18nFormattedElement(&quot;in_InfoSource&quot;, //$NON-NLS-1$</span>
				aString);
		}

<span class="nc" id="L643">		return infoText.toString();</span>
	}

	@Override
	public String getHTMLInfo(QualifiedObject&lt;Domain&gt; domain)
	{
<span class="nc" id="L649">		Domain aDomain = domain.getRawObject();</span>

<span class="nc" id="L651">		final HtmlInfoBuilder infoText = new HtmlInfoBuilder();</span>

<span class="nc bnc" id="L653" title="All 2 branches missed.">		if (aDomain != null)</span>
		{
<span class="nc" id="L655">			infoText.appendTitleElement(OutputNameFormatting.piString(aDomain));</span>

<span class="nc" id="L657">			appendFacts(infoText, aDomain);</span>

<span class="nc" id="L659">			String aString = pc.getDescription(aDomain);</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">			if (!aString.isEmpty())</span>
			{
<span class="nc" id="L662">				infoText.appendLineBreak();</span>
<span class="nc" id="L663">				infoText.appendI18nFormattedElement(&quot;in_domainGrant&quot;, //$NON-NLS-1$</span>
					aString);
			}

<span class="nc" id="L667">			aString = PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, aDomain.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">			if (!aString.isEmpty())</span>
			{
<span class="nc" id="L670">				infoText.appendI18nFormattedElement(&quot;in_InfoRequirements&quot;, //$NON-NLS-1$</span>
					aString);
			}

<span class="nc" id="L674">			aString =</span>
<span class="nc" id="L675">					PrerequisiteUtilities.preReqHTMLStringsForList(pc, aDomain, domain.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">			if (!aString.isEmpty())</span>
			{
<span class="nc" id="L678">				infoText.appendLineBreak();</span>
<span class="nc" id="L679">				infoText.appendI18nFormattedElement(&quot;in_domainRequirements&quot;, //$NON-NLS-1$</span>
					aString);
			}

<span class="nc" id="L683">			aString = AllowUtilities.getAllowInfo(pc, aDomain);</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">			if (!aString.isEmpty())</span>
			{
<span class="nc" id="L686">				infoText.appendLineBreak();</span>
<span class="nc" id="L687">				infoText.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
			}

<span class="nc" id="L690">			aString = SourceFormat.getFormattedString(aDomain, Globals.getSourceDisplay(), true);</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">			if (!aString.isEmpty())</span>
			{
<span class="nc" id="L693">				infoText.appendI18nFormattedElement(&quot;in_InfoSource&quot;, //$NON-NLS-1$</span>
					aString);
			}

		}

<span class="nc" id="L699">		return infoText.toString();</span>
	}

	@Override
	public String getHTMLInfo(EquipmentFacade equipFacade)
	{
<span class="nc bnc" id="L705" title="All 4 branches missed.">		if (equipFacade == null || !(equipFacade instanceof Equipment equip))</span>
		{
<span class="nc" id="L707">			return EMPTY_STRING;</span>
		}

<span class="nc" id="L710">		final HtmlInfoBuilder b = getEquipmentHtmlInfo(equip);</span>

<span class="nc" id="L712">		String bString = equip.getSource();</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L715">			b.appendLineBreak();</span>
<span class="nc" id="L716">			b.appendI18nElement(&quot;in_igInfoLabelTextSource&quot;, bString); //$NON-NLS-1$</span>
		}
<span class="nc" id="L718">		b.appendLineBreak();</span>

<span class="nc" id="L720">		return b.toString();</span>
	}

	private HtmlInfoBuilder getEquipmentHtmlInfo(Equipment equip)
	{
<span class="nc" id="L725">		final StringBuilder title = new StringBuilder(50);</span>
<span class="nc" id="L726">		title.append(OutputNameFormatting.piString(equip));</span>

<span class="nc bnc" id="L728" title="All 2 branches missed.">		if (!equip.longName().equals(equip.getName()))</span>
		{
<span class="nc" id="L730">			title.append(&quot;(&quot;).append(equip.longName()).append(&quot;)&quot;);</span>
		}

<span class="nc" id="L733">		final HtmlInfoBuilder b = new HtmlInfoBuilder(null, false);</span>
<span class="nc" id="L734">		File icon = equip.getIcon();</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">		if (icon != null)</span>
		{
<span class="nc" id="L737">			b.appendIconElement(icon.toURI().toString());</span>
		}
<span class="nc" id="L739">		b.appendTitleElement(title.toString());</span>
<span class="nc" id="L740">		b.appendLineBreak();</span>

<span class="nc" id="L742">		String baseName = equip.getBaseItemName();</span>
<span class="nc bnc" id="L743" title="All 4 branches missed.">		if (StringUtils.isNotEmpty(baseName) &amp;&amp; !baseName.equals(equip.getName()))</span>
		{
<span class="nc" id="L745">			b.appendI18nElement(&quot;in_igInfoLabelTextBaseItem&quot;, //$NON-NLS-1$</span>
				baseName);
<span class="nc" id="L747">			b.appendLineBreak();</span>
		}

<span class="nc" id="L750">		b.appendI18nElement(&quot;in_igInfoLabelTextType&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L751">			StringUtil.join(equip.getTrueTypeList(true), &quot;. &quot;));</span>

<span class="nc" id="L753">		appendFacts(b, equip);</span>

		//
		// Should only be meaningful for weapons, but if included on some other piece of
		// equipment, show it anyway
		//
<span class="nc bnc" id="L759" title="All 4 branches missed.">		if (equip.isWeapon() || equip.get(ObjectKey.WIELD) != null)</span>
		{
<span class="nc" id="L761">			b.appendLineBreak();</span>
<span class="nc" id="L762">			final WieldCategory wCat = equip.getEffectiveWieldCategory(pc);</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">			if (wCat != null)</span>
			{
<span class="nc" id="L765">				b.appendI18nElement(&quot;in_igInfoLabelTextWield&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L766">					wCat.getDisplayName());</span>
			}
		}

		//
		// Only meaningful for weapons, armor and shields
		//
<span class="nc bnc" id="L773" title="All 6 branches missed.">		if (equip.isWeapon() || equip.isArmor() || equip.isShield())</span>
		{
<span class="nc" id="L775">			b.appendLineBreak();</span>
<span class="nc bnc" id="L776" title="All 4 branches missed.">			final String value = (pc.isProficientWith(equip) &amp;&amp; equip.meetsPreReqs(pc))</span>
<span class="nc" id="L777">				? LanguageBundle.getString(&quot;in_igInfoLabelTextYes&quot;) //$NON-NLS-1$</span>
<span class="nc" id="L778">				: (SettingsHandler.getPrereqFailColorAsHtmlStart()</span>
<span class="nc" id="L779">						+ LanguageBundle.getString(&quot;in_igInfoLabelTextNo&quot;) //$NON-NLS-1$</span>
<span class="nc" id="L780">						+ SettingsHandler.getPrereqFailColorAsHtmlEnd());</span>
<span class="nc" id="L781">			b.appendI18nElement(&quot;in_igInfoLabelTextProficient&quot;, value); //$NON-NLS-1$</span>
		}

<span class="nc" id="L784">		final String cString =</span>
<span class="nc" id="L785">				PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, equip.getPrerequisiteList(), false);</span>

<span class="nc bnc" id="L787" title="All 2 branches missed.">		if (!cString.isEmpty())</span>
		{
<span class="nc" id="L789">			b.appendLineBreak();</span>
<span class="nc" id="L790">			b.appendI18nElement(&quot;in_igInfoLabelTextReq&quot;, cString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L793">		String aString = AllowUtilities.getAllowInfo(pc, equip);</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L796">			b.appendLineBreak();</span>
<span class="nc" id="L797">			b.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L800">		BigDecimal cost = equip.getCost(pc);</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">		if (cost != BigDecimal.ZERO)</span>
		{
<span class="nc" id="L803">			b.appendLineBreak();</span>
<span class="nc" id="L804">			b.appendI18nElement(&quot;in_igEqModelColCost&quot;, COST_FMT.format(cost.doubleValue())); //$NON-NLS-1$</span>
<span class="nc" id="L805">			b.append(&quot; &quot;);</span>
<span class="nc" id="L806">			b.append(SettingsHandler.getGameAsProperty().get().getCurrencyDisplay());</span>
		}

<span class="nc" id="L809">		String bString = Globals.getGameModeUnitSet().displayWeightInUnitSet(equip.getWeight(pc).doubleValue());</span>

<span class="nc bnc" id="L811" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L813">			b.appendLineBreak();</span>
<span class="nc" id="L814">			bString += Globals.getGameModeUnitSet().getWeightUnit();</span>
<span class="nc" id="L815">			b.appendI18nElement(&quot;in_igInfoLabelTextWeight&quot;, bString); //$NON-NLS-1$</span>

		}

<span class="nc" id="L819">		int a = EqToken.getMaxDexTokenInt(pc, equip);</span>

<span class="nc bnc" id="L821" title="All 2 branches missed.">		if (a != Constants.MAX_MAXDEX)</span>
		{
<span class="nc" id="L823">			b.appendSpacer();</span>
<span class="nc" id="L824">			b.appendI18nElement(&quot;in_igInfoLabelTextMaxDex&quot;, Integer.toString(a)); //$NON-NLS-1$</span>
		}

<span class="nc" id="L827">		a = EqToken.getAcCheckTokenInt(pc, equip);</span>

<span class="nc bnc" id="L829" title="All 6 branches missed.">		if (equip.isArmor() || equip.isShield() || (a != 0))</span>
		{
<span class="nc" id="L831">			b.appendSpacer();</span>
<span class="nc" id="L832">			b.appendI18nElement(&quot;in_igInfoLabelTextAcCheck&quot;, Integer.toString(a)); //$NON-NLS-1$</span>
		}

<span class="nc bnc" id="L835" title="All 2 branches missed.">		if (!SettingsHandler.getGameAsProperty().get().getACText().isEmpty())</span>
		{
<span class="nc" id="L837">			a = equip.getACMod(pc);</span>

<span class="nc bnc" id="L839" title="All 6 branches missed.">			if (equip.isArmor() || equip.isShield() || (a != 0))</span>
			{
<span class="nc" id="L841">				b.appendSpacer();</span>
<span class="nc" id="L842">				b.appendElement(LanguageBundle.getFormattedString(&quot;in_igInfoLabelTextAcBonus&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L843">					SettingsHandler.getGameAsProperty().get().getACText()), Integer.toString(a));</span>
			}
		}

<span class="nc bnc" id="L847" title="All 2 branches missed.">		if (SettingsHandler.getGameAsProperty().get().getTabShown(Tab.SPELLS))</span>
		{
<span class="nc" id="L849">			a = EqToken.getSpellFailureTokenInt(pc, equip);</span>

<span class="nc bnc" id="L851" title="All 6 branches missed.">			if (equip.isArmor() || equip.isShield() || (a != 0))</span>
			{
<span class="nc" id="L853">				b.appendSpacer();</span>
<span class="nc" id="L854">				b.appendI18nElement(&quot;in_igInfoLabelTextArcaneFailure&quot;, Integer.toString(a)); //$NON-NLS-1$</span>
			}
		}

<span class="nc" id="L858">		bString = SettingsHandler.getGameAsProperty().get().getDamageResistanceText();</span>

<span class="nc bnc" id="L860" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L862">			a = EqToken.getEdrTokenInt(pc, equip);</span>

<span class="nc bnc" id="L864" title="All 6 branches missed.">			if (equip.isArmor() || equip.isShield() || (a != 0))</span>
			{
<span class="nc" id="L866">				b.appendSpacer();</span>
<span class="nc" id="L867">				b.appendElement(bString, Integer.toString(a));</span>
			}
		}

<span class="nc" id="L871">		bString = equip.moveString();</span>

<span class="nc bnc" id="L873" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L875">			b.appendSpacer();</span>
<span class="nc" id="L876">			b.appendI18nElement(&quot;in_igInfoLabelTextMove&quot;, bString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L879">		bString = equip.getSize();</span>

<span class="nc bnc" id="L881" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L883">			b.appendSpacer();</span>
<span class="nc" id="L884">			b.appendI18nElement(&quot;in_igInfoLabelTextSize&quot;, bString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L887">		bString = equip.getDamage(pc);</span>

<span class="nc bnc" id="L889" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{

<span class="nc bnc" id="L892" title="All 2 branches missed.">			if (equip.isDouble())</span>
			{
<span class="nc" id="L894">				bString += &quot;/&quot; + equip.getAltDamage(pc); //$NON-NLS-1$</span>
			}

<span class="nc" id="L897">			b.appendLineBreak();</span>
<span class="nc" id="L898">			b.appendI18nElement(&quot;in_igInfoLabelTextDamage&quot;, bString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L901">		String critRangeVar = ControlUtilities.getControlToken(Globals.getContext(), CControl.CRITRANGE);</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">		if (critRangeVar == null)</span>
		{
<span class="nc" id="L904">			int critrange = EqToken.getOldBonusedCritRange(pc, equip, true);</span>
<span class="nc" id="L905">			int altcritrange = EqToken.getOldBonusedCritRange(pc, equip, false);</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">			bString = critrange == 0 ? EMPTY_STRING : Integer.toString(critrange);</span>
<span class="nc bnc" id="L907" title="All 4 branches missed.">			if (equip.isDouble() &amp;&amp; critrange != altcritrange)</span>
			{
<span class="nc" id="L909">				bString += &quot;/&quot; //$NON-NLS-1$</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">					+ (altcritrange == 0 ? EMPTY_STRING : Integer.toString(altcritrange));</span>
			}
<span class="nc" id="L912">		}</span>
		else
		{
<span class="nc" id="L915">			bString = WeaponToken.getNewCritRangeString(pc, equip, critRangeVar);</span>
		}

<span class="nc bnc" id="L918" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L920">			b.appendSpacer();</span>
<span class="nc" id="L921">			b.appendI18nElement(&quot;in_ieInfoLabelTextCritRange&quot;, bString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L924">		String critMultVar = ControlUtilities.getControlToken(Globals.getContext(), CControl.CRITMULT);</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">		if (critMultVar == null)</span>
		{
<span class="nc" id="L927">			bString = EqToken.multAsString(equip.getCritMultiplier());</span>
<span class="nc bnc" id="L928" title="All 4 branches missed.">			if (equip.isDouble() &amp;&amp; (equip.getCritMultiplier() != equip.getAltCritMultiplier()))</span>
			{
<span class="nc" id="L930">				bString += &quot;/&quot; + EqToken.multAsString(equip.getAltCritMultiplier()); //$NON-NLS-1$</span>
			}
		}
		else
		{
<span class="nc" id="L935">			bString = WeaponToken.getNewCritMultString(pc, equip, critMultVar);</span>
		}

<span class="nc bnc" id="L938" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L940">			b.appendSpacer();</span>
<span class="nc" id="L941">			b.appendI18nElement(&quot;in_igInfoLabelTextCritMult&quot;, bString); //$NON-NLS-1$</span>
		}

<span class="nc bnc" id="L944" title="All 2 branches missed.">		if (equip.isWeapon())</span>
		{
<span class="nc" id="L946">			bString = Globals.getGameModeUnitSet().displayDistanceInUnitSet(EqToken.getRange(pc, equip));</span>

<span class="nc bnc" id="L948" title="All 2 branches missed.">			if (!bString.isEmpty())</span>
			{
<span class="nc" id="L950">				b.appendSpacer();</span>
<span class="nc" id="L951">				b.appendI18nElement(&quot;in_igInfoLabelTextRange&quot;, bString //$NON-NLS-1$</span>
<span class="nc" id="L952">					+ Globals.getGameModeUnitSet().getDistanceUnit());</span>
			}
		}

<span class="nc" id="L956">		bString = equip.getContainerCapacityString();</span>

<span class="nc bnc" id="L958" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L960">			b.appendLineBreak();</span>
<span class="nc" id="L961">			b.appendI18nElement(&quot;in_igInfoLabelTextContainer&quot;, bString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L964">		bString = equip.getContainerContentsString();</span>

<span class="nc bnc" id="L966" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L968">			b.appendSpacer();</span>
<span class="nc" id="L969">			b.appendI18nElement(&quot;in_igInfoLabelTextCurrentlyContains&quot;, bString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L972">		final int charges = equip.getRemainingCharges();</span>

<span class="nc bnc" id="L974" title="All 2 branches missed.">		if (charges &gt;= 0)</span>
		{
<span class="nc" id="L976">			b.appendLineBreak();</span>
<span class="nc" id="L977">			b.appendI18nElement(&quot;in_igInfoLabelTextCharges&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L978">				Integer.valueOf(charges).toString());</span>
		}

<span class="nc" id="L981">		Map&lt;String, String&gt; qualityMap = equip.getMapFor(MapKey.QUALITY);</span>
<span class="nc bnc" id="L982" title="All 4 branches missed.">		if (qualityMap != null &amp;&amp; !qualityMap.isEmpty())</span>
		{
<span class="nc" id="L984">			Set&lt;String&gt; qualities = new TreeSet&lt;&gt;();</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">			for (Map.Entry&lt;String, String&gt; me : qualityMap.entrySet())</span>
			{
<span class="nc" id="L987">				qualities.add(me.getKey() + &quot;: &quot; + me.getValue());</span>
<span class="nc" id="L988">			}</span>

<span class="nc" id="L990">			b.appendLineBreak();</span>
<span class="nc" id="L991">			b.appendI18nElement(&quot;in_igInfoLabelTextQualities&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L992">				StringUtil.join(qualities, &quot;, &quot;));</span>
		}
		//Description
<span class="nc" id="L995">		String desc = pc.getDescription(equip);</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">		if (!desc.isEmpty())</span>
		{
<span class="nc" id="L998">			b.appendLineBreak();</span>
<span class="nc" id="L999">			b.appendI18nFormattedElement(&quot;in_InfoDescription&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1000">				DescriptionFormatting.piWrapDesc(equip, desc, false));</span>
		}
<span class="nc" id="L1002">		String IDS = equip.getInterestingDisplayString(pc);</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">		if (!IDS.isEmpty())</span>
		{
<span class="nc" id="L1005">			b.appendLineBreak();</span>
<span class="nc" id="L1006">			b.appendI18nElement(&quot;in_igInfoLabelTextProp&quot;, IDS); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1009">		String note = equip.getNote();</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">		if (!note.isEmpty())</span>
		{
<span class="nc" id="L1012">			b.appendLineBreak();</span>
<span class="nc" id="L1013">			b.appendI18nElement(&quot;in_igInfoLabelTextNote&quot;, note); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1016">		return b;</span>
	}

	@Override
	public String getHTMLInfo(EquipmentModifier equipMod, EquipmentFacade equipFacade)
	{
<span class="nc bnc" id="L1022" title="All 6 branches missed.">		if (equipMod == null || equipFacade == null</span>
<span class="nc" id="L1023">			|| !(equipFacade instanceof Equipment equip))</span>
		{
<span class="nc" id="L1025">			return EMPTY_STRING;</span>
		}

<span class="nc" id="L1028">		final HtmlInfoBuilder b = new HtmlInfoBuilder(null, false);</span>
<span class="nc" id="L1029">		b.appendTitleElement(OutputNameFormatting.piString(equipMod));</span>
<span class="nc" id="L1030">		b.appendLineBreak();</span>

<span class="nc" id="L1032">		b.appendI18nElement(&quot;in_igInfoLabelTextType&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1033">			StringUtil.join(equipMod.getTrueTypeList(true), &quot;. &quot;));</span>

		// Various cost types
<span class="nc" id="L1036">		int iPlus = equipMod.getSafe(IntegerKey.PLUS);</span>
<span class="nc bnc" id="L1037" title="All 2 branches missed.">		if (iPlus != 0)</span>
		{
<span class="nc" id="L1039">			b.appendLineBreak();</span>
<span class="nc" id="L1040">			b.appendI18nElement(&quot;in_igInfoLabelTextPlus&quot;, String.valueOf(iPlus));</span>
		}
<span class="nc" id="L1042">		Formula baseCost = equipMod.getSafe(FormulaKey.BASECOST);</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">		if (!&quot;0&quot;.equals(baseCost.toString()))</span>
		{
<span class="nc" id="L1045">			b.appendLineBreak();</span>
<span class="nc" id="L1046">			b.appendI18nElement(&quot;in_igInfoLabelTextPrecost&quot;, String.valueOf(baseCost));</span>
		}
<span class="nc" id="L1048">		Formula cost = equipMod.getSafe(FormulaKey.COST);</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">		if (!&quot;0&quot;.equals(cost.toString()))</span>
		{
<span class="nc" id="L1051">			b.appendLineBreak();</span>
<span class="nc" id="L1052">			b.appendI18nElement(&quot;in_igEqModelColCost&quot;, String.valueOf(cost));</span>
		}

		//Description
<span class="nc" id="L1056">		String desc = pc.getDescription(equipMod);</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">		if (!desc.isEmpty())</span>
		{
<span class="nc" id="L1059">			b.appendLineBreak();</span>
<span class="nc" id="L1060">			b.appendI18nFormattedElement(&quot;in_InfoDescription&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1061">				DescriptionFormatting.piWrapDesc(equipMod, desc, false));</span>
		}

		// Special properties
<span class="nc" id="L1065">		StringBuilder sb = new StringBuilder(100);</span>
<span class="nc" id="L1066">		boolean first = true;</span>
<span class="nc bnc" id="L1067" title="All 2 branches missed.">		for (SpecialProperty sp : equipMod.getSafeListFor(ListKey.SPECIAL_PROPERTIES))</span>
		{
<span class="nc bnc" id="L1069" title="All 2 branches missed.">			if (!first)</span>
			{
<span class="nc" id="L1071">				sb.append(&quot;, &quot;);</span>
			}
<span class="nc" id="L1073">			first = false;</span>
<span class="nc" id="L1074">			sb.append(sp.getDisplayName());</span>
<span class="nc" id="L1075">		}</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">		if (sb.length() &gt; 0)</span>
		{
<span class="nc" id="L1078">			b.appendLineBreak();</span>
<span class="nc" id="L1079">			b.appendI18nElement(&quot;in_igInfoLabelTextSprop&quot;, sb.toString());</span>
		}

<span class="nc" id="L1082">		final String cString =</span>
<span class="nc" id="L1083">				PrerequisiteUtilities.preReqHTMLStringsForList(pc, equip, equipMod.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L1084" title="All 2 branches missed.">		if (!cString.isEmpty())</span>
		{
<span class="nc" id="L1086">			b.appendLineBreak();</span>
<span class="nc" id="L1087">			b.appendI18nElement(&quot;in_igInfoLabelTextReq&quot;, cString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1090">		String aString = AllowUtilities.getAllowInfo(pc, equipMod);</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1093">			b.appendLineBreak();</span>
<span class="nc" id="L1094">			b.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1097">		String bString = equipMod.getSource();</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">		if (!bString.isEmpty())</span>
		{
<span class="nc" id="L1100">			b.appendLineBreak();</span>
<span class="nc" id="L1101">			b.appendI18nElement(&quot;in_igInfoLabelTextSource&quot;, bString); //$NON-NLS-1$</span>
		}
<span class="nc" id="L1103">		b.appendLineBreak();</span>

<span class="nc" id="L1105">		return b.toString();</span>
	}

	@Override
	public String getHTMLInfo(PCTemplate template)
	{
<span class="nc bnc" id="L1111" title="All 2 branches missed.">		if (template == null)</span>
		{
<span class="nc" id="L1113">			return EMPTY_STRING;</span>
		}

<span class="nc" id="L1116">		final HtmlInfoBuilder infoText = new HtmlInfoBuilder();</span>

<span class="nc" id="L1118">		infoText.appendTitleElement(OutputNameFormatting.piString(template));</span>

<span class="nc" id="L1120">		appendFacts(infoText, template);</span>

<span class="nc" id="L1122">		RaceType rt = template.get(ObjectKey.RACETYPE);</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">		if (rt != null)</span>
		{
<span class="nc" id="L1125">			infoText.appendLineBreak();</span>
<span class="nc" id="L1126">			infoText.appendI18nElement(&quot;in_irInfoRaceType&quot;, rt.toString()); //$NON-NLS-1$</span>
		}

<span class="nc bnc" id="L1129" title="All 2 branches missed.">		if (!template.getType().isEmpty())</span>
		{
<span class="nc" id="L1131">			infoText.appendSpacer();</span>
<span class="nc" id="L1132">			infoText.appendI18nElement(&quot;in_irInfoType&quot;, template.getType()); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1135">		String aString = pc.getDescription(template);</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1138">			infoText.appendLineBreak();</span>
<span class="nc" id="L1139">			infoText.appendI18nFormattedElement(&quot;in_InfoDescription&quot;, //$NON-NLS-1$</span>
				aString);
		}

<span class="nc" id="L1143">		aString = TemplateModifier.modifierString(template, pc);</span>
<span class="nc bnc" id="L1144" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1146">			infoText.appendLineBreak();</span>
<span class="nc" id="L1147">			infoText.appendI18nElement(&quot;in_modifier&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1150">		aString = PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, template.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1153">			infoText.appendLineBreak();</span>
<span class="nc" id="L1154">			infoText.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1157">		aString = AllowUtilities.getAllowInfo(pc, template);</span>
<span class="nc bnc" id="L1158" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1160">			infoText.appendLineBreak();</span>
<span class="nc" id="L1161">			infoText.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1164">		aString = template.getSource();</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1167">			infoText.appendLineBreak();</span>
<span class="nc" id="L1168">			infoText.appendI18nElement(&quot;in_sourceLabel&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1171">		return infoText.toString();</span>
	}

	@Override
	public String getHTMLInfo(Kit kit)
	{
<span class="nc bnc" id="L1177" title="All 2 branches missed.">		if (kit == null)</span>
		{
<span class="nc" id="L1179">			return EMPTY_STRING;</span>
		}

<span class="nc" id="L1182">		final HtmlInfoBuilder infoText = new HtmlInfoBuilder();</span>

<span class="nc" id="L1184">		infoText.appendTitleElement(OutputNameFormatting.piString(kit));</span>

<span class="nc" id="L1186">		appendFacts(infoText, kit);</span>

<span class="nc" id="L1188">		String aString = PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, kit.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1191">			infoText.appendLineBreak();</span>
<span class="nc" id="L1192">			infoText.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1195">		aString = AllowUtilities.getAllowInfo(pc, kit);</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1198">			infoText.appendLineBreak();</span>
<span class="nc" id="L1199">			infoText.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1202">		List&lt;BaseKit&gt; sortedObjects = new ArrayList&lt;&gt;(kit.getSafeListFor(ListKey.KIT_TASKS));</span>
<span class="nc" id="L1203">		sortedObjects.sort(Comparator.comparing(BaseKit::getObjectName));</span>

<span class="nc" id="L1205">		String lastObjectName = EMPTY_STRING;</span>
<span class="nc bnc" id="L1206" title="All 2 branches missed.">		for (BaseKit bk : sortedObjects)</span>
		{
<span class="nc" id="L1208">			String objName = bk.getObjectName();</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">			if (!objName.equals(lastObjectName))</span>
			{
<span class="nc bnc" id="L1211" title="All 2 branches missed.">				if (!EMPTY_STRING.equals(lastObjectName))</span>
				{
<span class="nc" id="L1213">					infoText.append(&quot;; &quot;);</span>
				}
				else
				{
<span class="nc" id="L1217">					infoText.appendLineBreak();</span>
				}
<span class="nc" id="L1219">				infoText.append(&quot;  &lt;b&gt;&quot; + objName + &quot;&lt;/b&gt;: &quot;);</span>
<span class="nc" id="L1220">				lastObjectName = objName;</span>
			}
			else
			{
<span class="nc" id="L1224">				infoText.append(&quot;, &quot;);</span>
			}
<span class="nc" id="L1226">			infoText.append(bk.toString());</span>
<span class="nc" id="L1227">		}</span>

<span class="nc" id="L1229">		BigDecimal totalCost = kit.getTotalCost(pc);</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">		if (totalCost != null)</span>
		{
<span class="nc" id="L1232">			infoText.appendLineBreak();</span>
<span class="nc" id="L1233">			infoText.appendI18nFormattedElement(&quot;in_kitInfo_TotalCost&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1234">				COST_FMT.format(totalCost), SettingsHandler.getGameAsProperty().get().getCurrencyDisplay());</span>
		}

<span class="nc" id="L1237">		String desc = pc.getDescription(kit);</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">		if (!desc.isEmpty())</span>
		{
<span class="nc" id="L1240">			infoText.appendLineBreak();</span>
<span class="nc" id="L1241">			infoText.appendI18nFormattedElement(&quot;in_InfoDescription&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1242">				DescriptionFormatting.piWrapDesc(kit, desc, false));</span>
		}

<span class="nc" id="L1245">		aString = kit.getSource();</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1248">			infoText.appendLineBreak();</span>
<span class="nc" id="L1249">			infoText.appendI18nElement(&quot;in_sourceLabel&quot;, aString); //$NON-NLS-1$</span>
		}
		//TODO ListKey.KIT_TASKS
<span class="nc" id="L1252">		return infoText.toString();</span>
	}

	@Override
	public String getHTMLInfo(TempBonusFacade tempBonusFacade)
	{
<span class="nc bnc" id="L1258" title="All 2 branches missed.">		if (tempBonusFacade == null)</span>
		{
<span class="nc" id="L1260">			return EMPTY_STRING;</span>
		}

<span class="nc bnc" id="L1263" title="All 2 branches missed.">		if (!(tempBonusFacade instanceof TempBonusFacadeImpl tempBonus))</span>
		{
<span class="nc" id="L1265">			final HtmlInfoBuilder infoText = new HtmlInfoBuilder();</span>
<span class="nc" id="L1266">			infoText.appendTitleElement(tempBonusFacade.toString());</span>
<span class="nc" id="L1267">			return infoText.toString();</span>
		}

<span class="nc" id="L1270">		CDOMObject originObj = tempBonus.getOriginObj();</span>

		final HtmlInfoBuilder infoText;
<span class="nc bnc" id="L1273" title="All 2 branches missed.">		if (originObj instanceof Equipment)</span>
		{
<span class="nc" id="L1275">			infoText = getEquipmentHtmlInfo((Equipment) originObj);</span>
		}
		else
		{
<span class="nc" id="L1279">			infoText = new HtmlInfoBuilder();</span>
<span class="nc" id="L1280">			infoText.appendTitleElement(OutputNameFormatting.piString(originObj));</span>
<span class="nc" id="L1281">			infoText.append(&quot; (&quot;).append(tempBonus.getOriginType()).append(&quot;)&quot;); //$NON-NLS-1$ //$NON-NLS-2$</span>
		}

<span class="nc bnc" id="L1284" title="All 2 branches missed.">		if (tempBonus.getTarget() != null)</span>
		{
<span class="nc" id="L1286">			String targetName = charDisplay.getName();</span>
<span class="nc bnc" id="L1287" title="All 2 branches missed.">			if (tempBonus.getTarget() instanceof CDOMObject)</span>
			{
<span class="nc" id="L1289">				targetName = ((CDOMObject) tempBonus.getTarget()).getKeyName();</span>
			}

<span class="nc" id="L1292">			infoText.appendLineBreak();</span>
<span class="nc" id="L1293">			infoText.appendI18nElement(&quot;in_itmInfoLabelTextTarget&quot;, targetName); //$NON-NLS-1$</span>

<span class="nc" id="L1295">			StringBuilder bonusValues = new StringBuilder(100);</span>
<span class="nc" id="L1296">			Map&lt;BonusObj, TempBonusInfo&gt; bonusMap = pc.getTempBonusMap(originObj.getKeyName(), targetName);</span>
<span class="nc" id="L1297">			boolean first = true;</span>
<span class="nc" id="L1298">			List&lt;BonusObj&gt; bonusList = new ArrayList&lt;&gt;(bonusMap.keySet());</span>
<span class="nc" id="L1299">			bonusList.sort(BONUS_COMPARATOR);</span>
<span class="nc bnc" id="L1300" title="All 2 branches missed.">			for (BonusObj bonusObj : bonusList)</span>
			{
<span class="nc bnc" id="L1302" title="All 2 branches missed.">				if (!first)</span>
				{
<span class="nc" id="L1304">					bonusValues.append(&quot;, &quot;); //$NON-NLS-1$</span>
				}
<span class="nc" id="L1306">				first = false;</span>
<span class="nc" id="L1307">				String adj = ADJ_FMT.format(bonusObj.resolve(pc, &quot;&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1308">				bonusValues.append(adj).append(&quot; &quot;).append(bonusObj.getDescription()); //$NON-NLS-1$</span>
<span class="nc" id="L1309">			}</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">			if (bonusValues.length() &gt; 0)</span>
			{
<span class="nc" id="L1312">				infoText.appendLineBreak();</span>
<span class="nc" id="L1313">				infoText.appendI18nElement(&quot;in_itmInfoLabelTextEffect&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1314">					bonusValues.toString());</span>
			}
		}

<span class="nc bnc" id="L1318" title="All 2 branches missed.">		if (originObj instanceof Spell aSpell)</span>
		{
<span class="nc" id="L1320">			infoText.appendLineBreak();</span>
<span class="nc" id="L1321">			infoText.appendI18nElement(&quot;in_spellDuration&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1322">				aSpell.getListAsString(ListKey.DURATION));</span>
<span class="nc" id="L1323">			infoText.appendSpacer();</span>
<span class="nc" id="L1324">			infoText.appendI18nElement(&quot;in_spellRange&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1325">				aSpell.getListAsString(ListKey.RANGE));</span>
<span class="nc" id="L1326">			infoText.appendSpacer();</span>
<span class="nc" id="L1327">			infoText.appendI18nElement(&quot;in_spellTarget&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1328">				aSpell.getSafe(StringKey.TARGET_AREA));</span>
		}

<span class="nc" id="L1331">		String aString = originObj.getSafe(StringKey.TEMP_DESCRIPTION);</span>
<span class="nc bnc" id="L1332" title="All 4 branches missed.">		if (StringUtils.isEmpty(aString) &amp;&amp; originObj instanceof Spell sp)</span>
		{
<span class="nc" id="L1334">			aString = DescriptionFormatting.piWrapDesc(sp, pc.getDescription(sp), false);</span>
		}
<span class="nc bnc" id="L1336" title="All 4 branches missed.">		else if (StringUtils.isEmpty(aString) &amp;&amp; originObj instanceof Ability ab)</span>
		{
<span class="nc" id="L1338">			List&lt;CNAbility&gt; wrappedAbility =</span>
<span class="nc" id="L1339">					Collections.singletonList(CNAbilityFactory.getCNAbility(ab.getCDOMCategory(), Nature.NORMAL, ab));</span>
<span class="nc" id="L1340">			aString = DescriptionFormatting.piWrapDesc(ab, pc.getDescription(wrappedAbility), false);</span>
		}
<span class="nc bnc" id="L1342" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1344">			infoText.appendLineBreak();</span>
<span class="nc" id="L1345">			infoText.appendI18nElement(&quot;in_itmInfoLabelTextDesc&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1348">		aString = PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, originObj.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1351">			infoText.appendLineBreak();</span>
<span class="nc" id="L1352">			infoText.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1355">		aString = AllowUtilities.getAllowInfo(pc, originObj);</span>
<span class="nc bnc" id="L1356" title="All 2 branches missed.">		if (!aString.isEmpty())</span>
		{
<span class="nc" id="L1358">			infoText.appendLineBreak();</span>
<span class="nc" id="L1359">			infoText.appendI18nElement(&quot;in_requirements&quot;, aString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1362">		infoText.appendLineBreak();</span>
<span class="nc" id="L1363">		infoText.appendI18nElement(&quot;in_itmInfoLabelTextSource&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1364">			SourceFormat.getFormattedString(originObj, Globals.getSourceDisplay(), true));</span>

<span class="nc" id="L1366">		return infoText.toString();</span>
	}

	@Override
	public String getHTMLInfo(InfoFacade facade)
	{
<span class="nc bnc" id="L1372" title="All 2 branches missed.">		if (facade == null)</span>
		{
<span class="nc" id="L1374">			return EMPTY_STRING;</span>
		}

		// Use a more detailed info if we can
<span class="nc bnc" id="L1378" title="All 2 branches missed.">		if (facade instanceof AbilityFacade)</span>
		{
<span class="nc" id="L1380">			return getHTMLInfo((AbilityFacade) facade);</span>
		}
<span class="nc bnc" id="L1382" title="All 2 branches missed.">		if (facade instanceof PCClass)</span>
		{
<span class="nc" id="L1384">			return getHTMLInfo((PCClass) facade, null);</span>
		}
<span class="nc bnc" id="L1386" title="All 2 branches missed.">		if (facade instanceof EquipmentFacade)</span>
		{
<span class="nc" id="L1388">			return getHTMLInfo((EquipmentFacade) facade);</span>
		}
<span class="nc bnc" id="L1390" title="All 2 branches missed.">		if (facade instanceof SpellFacade)</span>
		{
<span class="nc" id="L1392">			return getHTMLInfo((SpellFacade) facade);</span>
		}
<span class="nc bnc" id="L1394" title="All 2 branches missed.">		if (facade instanceof TempBonusFacade)</span>
		{
<span class="nc" id="L1396">			return getHTMLInfo((TempBonusFacade) facade);</span>
		}

<span class="nc" id="L1399">		final HtmlInfoBuilder infoText = new HtmlInfoBuilder();</span>
<span class="nc" id="L1400">		infoText.appendTitleElement(facade.toString());</span>
<span class="nc" id="L1401">		infoText.appendLineBreak();</span>

<span class="nc bnc" id="L1403" title="All 2 branches missed.">		if (!facade.getType().isEmpty())</span>
		{
<span class="nc" id="L1405">			infoText.appendI18nElement(&quot;in_irInfoType&quot;, facade.getType()); //$NON-NLS-1$</span>
<span class="nc" id="L1406">			infoText.appendLineBreak();</span>
		}

<span class="nc" id="L1409">		infoText.appendI18nElement(&quot;in_itmInfoLabelTextSource&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1410">			facade.getSource());</span>

<span class="nc" id="L1412">		return infoText.toString();</span>
	}

<span class="nc" id="L1415">	private final Comparator&lt;BonusObj&gt; BONUS_COMPARATOR =</span>
<span class="nc" id="L1416">			Comparator.comparing(BonusObj::getTypeOfBonus)</span>
<span class="nc" id="L1417">			.thenComparing(BonusObj::getBonusInfo);</span>

	@Override
	public String getLevelAdjustment(Race race)
	{
<span class="nc" id="L1422">		return ADJ_FMT.format(race.getSafe(FormulaKey.LEVEL_ADJUSTMENT).resolve(pc, EMPTY_STRING));</span>
	}

	@Override
	public int getNumMonsterClassLevels(Race race)
	{
<span class="nc" id="L1428">		LevelCommandFactory levelCommandFactory = race.get(ObjectKey.MONSTER_CLASS);</span>
<span class="nc bnc" id="L1429" title="All 2 branches missed.">		if (levelCommandFactory == null)</span>
		{
<span class="nc" id="L1431">			return 0;</span>
		}
<span class="nc" id="L1433">		return levelCommandFactory.getLevelCount().resolve(pc, EMPTY_STRING).intValue();</span>
	}

	@Override
	public String getPreReqHTML(Race race)
	{
<span class="nc" id="L1439">		return &quot;&lt;html&gt;&quot;</span>
<span class="nc" id="L1440">				+ PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, race.getPrerequisiteList(), false)</span>
<span class="nc" id="L1441">				+ AllowUtilities.getAllowInfo(pc, race)</span>
				+ &quot;&lt;/html&gt;&quot;;
	}

	@Override
	public String getStatAdjustments(Race race)
	{
<span class="nc" id="L1448">		final StringBuilder retString = new StringBuilder(100);</span>

<span class="nc bnc" id="L1450" title="All 2 branches missed.">		for (PCStat stat : charDisplay.getStatSet())</span>
		{
<span class="nc bnc" id="L1452" title="All 2 branches missed.">			if (charDisplay.isNonAbility(stat))</span>
			{
<span class="nc bnc" id="L1454" title="All 2 branches missed.">				if (retString.length() &gt; 0)</span>
				{
<span class="nc" id="L1456">					retString.append(' ');</span>
				}

<span class="nc" id="L1459">				retString.append(stat.getKeyName()).append(&quot;:Nonability&quot;);</span>
			}
			else
			{
<span class="nc bnc" id="L1463" title="All 2 branches missed.">				if (BonusCalc.getStatMod(race, stat, pc) != 0)</span>
				{
<span class="nc bnc" id="L1465" title="All 2 branches missed.">					if (retString.length() &gt; 0)</span>
					{
<span class="nc" id="L1467">						retString.append(' ');</span>
					}

<span class="nc" id="L1470">					retString.append(stat.getKeyName()).append(&quot;:&quot;).append(BonusCalc.getStatMod(race, stat, pc));</span>
				}
			}
<span class="nc" id="L1473">		}</span>

<span class="nc" id="L1475">		return retString.toString();</span>
	}

	@Override
	public String getVision(Race race)
	{
<span class="nc" id="L1481">		return VisionDisplay.getVision(pc, race);</span>
	}

	@Override
	public float getCost(EquipmentFacade equipment)
	{
<span class="nc bnc" id="L1487" title="All 2 branches missed.">		if (equipment instanceof Equipment)</span>
		{
<span class="nc" id="L1489">			return ((Equipment) equipment).getCost(pc).floatValue();</span>
		}
<span class="nc" id="L1491">		return 0;</span>
	}

	@Override
	public float getWeight(EquipmentFacade equipment)
	{
<span class="nc bnc" id="L1497" title="All 2 branches missed.">		if (equipment instanceof Equipment)</span>
		{
<span class="nc" id="L1499">			Float weight = ((Equipment) equipment).getWeight(pc);</span>
<span class="nc" id="L1500">			return (float) Globals.getGameModeUnitSet().convertWeightToUnitSet(weight);</span>
		}
<span class="nc" id="L1502">		return 0;</span>
	}

	@Override
	public String getLevelAdjustment(PCTemplate template)
	{
<span class="nc" id="L1508">		return ADJ_FMT.format(template.getSafe(FormulaKey.LEVEL_ADJUSTMENT).resolve(pc, EMPTY_STRING));</span>
	}

	@Override
	public String getModifier(PCTemplate template)
	{
<span class="nc" id="L1514">		return TemplateModifier.modifierString(template, pc);</span>
	}

	@Override
	public String getPreReqHTML(PCTemplate template)
	{
<span class="nc" id="L1520">		return &quot;&lt;html&gt;&quot;</span>
<span class="nc" id="L1521">				+ PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, template.getPrerequisiteList(), false)</span>
<span class="nc" id="L1522">				+ AllowUtilities.getAllowInfo(pc, template)</span>
				+ &quot;&lt;/html&gt;&quot;;
	}

	@Override
	public String getHTMLInfo(SpellFacade spell)
	{
<span class="nc" id="L1529">		Objects.requireNonNull(spell);</span>
<span class="nc" id="L1530">		CharacterSpell cs = spell.getCharSpell();</span>
<span class="nc" id="L1531">		SpellInfo si = spell.getSpellInfo();</span>
<span class="nc" id="L1532">		Spell aSpell = cs.getSpell();</span>

<span class="nc bnc" id="L1534" title="All 2 branches missed.">		if (aSpell == null)</span>
		{
<span class="nc" id="L1536">			return EMPTY_STRING;</span>
		}
<span class="nc" id="L1538">		final HtmlInfoBuilder b = new HtmlInfoBuilder(OutputNameFormatting.piString(aSpell));</span>

<span class="nc bnc" id="L1540" title="All 2 branches missed.">		if (si != null)</span>
		{
<span class="nc" id="L1542">			final String addString = si.toString(); // would add [featList]</span>
<span class="nc bnc" id="L1543" title="All 2 branches missed.">			if (!addString.isEmpty())</span>
			{
<span class="nc" id="L1545">				b.append(&quot; &quot;).append(addString); //$NON-NLS-1$</span>
			}
<span class="nc" id="L1547">			b.appendLineBreak();</span>
<span class="nc" id="L1548">			b.appendI18nElement(&quot;InfoSpells.level.title&quot;, Integer.toString(si.getOriginalLevel())); //$NON-NLS-1$</span>
		}
<span class="nc" id="L1550">		b.appendLineBreak();</span>

<span class="nc" id="L1552">		String classlevels = aSpell.getListAsString(ListKey.SPELL_CLASSLEVEL);</span>
<span class="nc bnc" id="L1553" title="All 2 branches missed.">		if (StringUtils.isNotEmpty(classlevels))</span>
		{
<span class="nc" id="L1555">			b.appendI18nElement(&quot;in_clClass&quot;, classlevels);</span>
<span class="nc" id="L1556">			b.appendLineBreak();</span>
		}
<span class="nc" id="L1558">		String domainlevels = aSpell.getListAsString(ListKey.SPELL_DOMAINLEVEL);</span>
<span class="nc bnc" id="L1559" title="All 2 branches missed.">		if (StringUtils.isNotEmpty(domainlevels))</span>
		{
<span class="nc" id="L1561">			b.appendI18nElement(&quot;in_domains&quot;, domainlevels);</span>
<span class="nc" id="L1562">			b.appendLineBreak();</span>
		}

<span class="nc" id="L1565">		b.appendI18nElement(&quot;in_spellSchool&quot;, aSpell.getListAsString(ListKey.SPELL_SCHOOL));</span>

<span class="nc" id="L1567">		String subSchool = aSpell.getListAsString(ListKey.SPELL_SUBSCHOOL);</span>
<span class="nc bnc" id="L1568" title="All 2 branches missed.">		if (StringUtils.isNotEmpty(subSchool))</span>
		{
<span class="nc" id="L1570">			b.append(&quot; (&quot;).append(subSchool).append(&quot;)&quot;);</span>
		}
<span class="nc" id="L1572">		String spellDescriptor = aSpell.getListAsString(ListKey.SPELL_DESCRIPTOR);</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">		if (StringUtils.isNotEmpty(spellDescriptor))</span>
		{
<span class="nc" id="L1575">			b.append(&quot; [&quot;).append(spellDescriptor).append(&quot;]&quot;);</span>
		}
<span class="nc" id="L1577">		b.appendLineBreak();</span>

<span class="nc" id="L1579">		appendFacts(b, aSpell);</span>
<span class="nc" id="L1580">		b.appendLineBreak();</span>

<span class="nc" id="L1582">		b.appendI18nElement(&quot;in_spellComponents&quot;, aSpell.getListAsString(ListKey.COMPONENTS));</span>
<span class="nc" id="L1583">		b.appendLineBreak();</span>

<span class="nc" id="L1585">		b.appendI18nElement(&quot;in_spellCastTime&quot;, aSpell.getListAsString(ListKey.CASTTIME));</span>
<span class="nc" id="L1586">		b.appendLineBreak();</span>

<span class="nc" id="L1588">		b.appendI18nElement(&quot;in_spellDuration&quot;, pc.parseSpellString(cs, aSpell.getListAsString(ListKey.DURATION)));</span>
<span class="nc" id="L1589">		b.appendLineBreak();</span>

<span class="nc" id="L1591">		b.appendI18nElement(&quot;in_spellRange&quot;, pc.getSpellRange(cs, si));</span>
<span class="nc" id="L1592">		b.appendSpacer();</span>
<span class="nc" id="L1593">		b.appendI18nElement(&quot;in_spellTarget&quot;, pc.parseSpellString(cs, aSpell.getSafe(StringKey.TARGET_AREA)));</span>
<span class="nc" id="L1594">		b.appendLineBreak();</span>

<span class="nc" id="L1596">		b.appendI18nElement(&quot;in_spellSavingThrow&quot;, aSpell.getListAsString(ListKey.SAVE_INFO));</span>
<span class="nc" id="L1597">		b.appendSpacer();</span>
<span class="nc" id="L1598">		b.appendI18nElement(&quot;in_spellSpellResist&quot;, aSpell.getListAsString(ListKey.SPELL_RESISTANCE));</span>
<span class="nc" id="L1599">		b.appendLineBreak();</span>

<span class="nc" id="L1601">		b.appendLineBreak();</span>
<span class="nc" id="L1602">		b.appendI18nElement(&quot;in_descrip&quot;, pc.parseSpellString(cs, //$NON-NLS-1$</span>
<span class="nc" id="L1603">			pc.getDescription(aSpell)));</span>

<span class="nc" id="L1605">		String cString = PrerequisiteUtilities.preReqHTMLStringsForList(pc, null, aSpell.getPrerequisiteList(), false);</span>
<span class="nc bnc" id="L1606" title="All 2 branches missed.">		if (!cString.isEmpty())</span>
		{
<span class="nc" id="L1608">			b.appendLineBreak();</span>
<span class="nc" id="L1609">			b.appendI18nElement(&quot;in_requirements&quot;, cString); //$NON-NLS-1$</span>
		}
<span class="nc" id="L1611">		cString = AllowUtilities.getAllowInfo(pc, aSpell);</span>
<span class="nc bnc" id="L1612" title="All 2 branches missed.">		if (!cString.isEmpty())</span>
		{
<span class="nc" id="L1614">			b.appendLineBreak();</span>
<span class="nc" id="L1615">			b.appendI18nElement(&quot;in_requirements&quot;, cString); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1618">		b.appendLineBreak();</span>

<span class="nc" id="L1620">		String spellSource = SourceFormat.getFormattedString(aSpell, Globals.getSourceDisplay(), true);</span>
<span class="nc bnc" id="L1621" title="All 2 branches missed.">		if (!spellSource.isEmpty())</span>
		{
<span class="nc" id="L1623">			b.appendLineBreak();</span>
<span class="nc" id="L1624">			b.appendI18nElement(&quot;in_source&quot;, spellSource); //$NON-NLS-1$</span>
		}

<span class="nc" id="L1627">		return b.toString();</span>
	}

	@Override
	public String getSpellBookInfo(String name)
	{
<span class="nc" id="L1633">		SpellBook book = charDisplay.getSpellBookByName(name);</span>
<span class="nc bnc" id="L1634" title="All 2 branches missed.">		if (book == null)</span>
		{
<span class="nc" id="L1636">			return EMPTY_STRING;</span>
		}

<span class="nc bnc" id="L1639" title="All 3 branches missed.">		return switch (book.getType())</span>
				{
<span class="nc" id="L1641">					case SpellBook.TYPE_PREPARED_LIST -&gt; produceSpellListInfo(book);</span>
<span class="nc" id="L1642">					case SpellBook.TYPE_SPELL_BOOK -&gt; produceSpellBookInfo(book);</span>
<span class="nc" id="L1643">					default -&gt; EMPTY_STRING;</span>
				};
	}

	/**
	 * Produce the HTML info label for a prepared spell list.
	 * @param spelllist The spell list being output.
	 * @return String  The HTML info for the list.
	 */
	private String produceSpellListInfo(SpellBook spelllist)
	{
<span class="nc" id="L1654">		final HtmlInfoBuilder b = new HtmlInfoBuilder(spelllist.getName());</span>

<span class="nc" id="L1656">		b.append(&quot; (&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1657">		b.append(spelllist.getTypeName());</span>
<span class="nc" id="L1658">		b.append(&quot;)&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1659">		b.appendLineBreak();</span>

<span class="nc bnc" id="L1661" title="All 2 branches missed.">		if (spelllist.getDescription() != null)</span>
		{
<span class="nc" id="L1663">			b.appendI18nElement(&quot;in_descrip&quot;, spelllist.getDescription()); //$NON-NLS-1$</span>
<span class="nc" id="L1664">			b.appendLineBreak();</span>
		}

		// Look at each spell on each spellcasting class
<span class="nc bnc" id="L1668" title="All 2 branches missed.">		for (PCClass pcClass : charDisplay.getClassSet())</span>
		{
<span class="nc" id="L1670">			Map&lt;Integer, Integer&gt; spellCountMap = new TreeMap&lt;&gt;();</span>
<span class="nc" id="L1671">			int highestSpellLevel = -1;</span>
<span class="nc" id="L1672">			Collection&lt;? extends CharacterSpell&gt; sp = charDisplay.getCharacterSpells(pcClass);</span>
<span class="nc" id="L1673">			List&lt;CharacterSpell&gt; classSpells = new ArrayList&lt;&gt;(sp);</span>
			// Add in the spells granted by objects
<span class="nc" id="L1675">			pc.addBonusKnownSpellsToList(pcClass, classSpells);</span>
<span class="nc bnc" id="L1676" title="All 2 branches missed.">			for (CharacterSpell charSpell : classSpells)</span>
			{
<span class="nc bnc" id="L1678" title="All 2 branches missed.">				for (SpellInfo spellInfo : charSpell.getInfoList())</span>
				{
<span class="nc bnc" id="L1680" title="All 2 branches missed.">					if (!spelllist.getName().equals(spellInfo.getBook()))</span>
					{
<span class="nc" id="L1682">						continue;</span>
					}
<span class="nc" id="L1684">					int level = spellInfo.getActualLevel();</span>

<span class="nc" id="L1686">					int count = spellCountMap.getOrDefault(level, 0);</span>
<span class="nc" id="L1687">					count += spellInfo.getTimes();</span>
<span class="nc" id="L1688">					spellCountMap.put(level, count);</span>
<span class="nc bnc" id="L1689" title="All 2 branches missed.">					if (level &gt; highestSpellLevel)</span>
					{
<span class="nc" id="L1691">						highestSpellLevel = level;</span>
					}
<span class="nc" id="L1693">				}</span>
<span class="nc" id="L1694">			}</span>

<span class="nc bnc" id="L1696" title="All 2 branches missed.">			if (!spellCountMap.isEmpty())</span>
			{
<span class="nc" id="L1698">				b.append(&quot;&lt;table border=1&gt;&lt;tr&gt;&lt;td&gt;&lt;font size=-1&gt;&lt;b&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1699">				b.append(OutputNameFormatting.piString(pcClass));</span>
<span class="nc" id="L1700">				b.append(&quot;&lt;/b&gt;&lt;/font&gt;&lt;/td&gt;&quot;); //$NON-NLS-1$</span>

<span class="nc bnc" id="L1702" title="All 2 branches missed.">				for (int i = 0; i &lt;= highestSpellLevel; ++i)</span>
				{
<span class="nc" id="L1704">					b.append(&quot;&lt;td&gt;&lt;font size=-2&gt;&lt;b&gt;&lt;center&gt;&amp;nbsp;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1705">					b.append(String.valueOf(i));</span>
<span class="nc" id="L1706">					b.append(&quot;&amp;nbsp;&lt;/b&gt;&lt;/center&gt;&lt;/font&gt;&lt;/td&gt;&quot;); //$NON-NLS-1$</span>
				}

<span class="nc" id="L1709">				b.append(&quot;&lt;/tr&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1710">				b.append(&quot;&lt;tr&gt;&lt;td&gt;&lt;font size=-1&gt;&lt;b&gt;Prepared&lt;/b&gt;&lt;/font&gt;&lt;/td&gt;&quot;); //$NON-NLS-1$</span>

<span class="nc bnc" id="L1712" title="All 2 branches missed.">				for (int i = 0; i &lt;= highestSpellLevel; ++i)</span>
				{
<span class="nc" id="L1714">					b.append(&quot;&lt;td&gt;&lt;font size=-1&gt;&lt;center&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1715">					b.append(String.valueOf(spellCountMap.getOrDefault(i, 0)));</span>
<span class="nc" id="L1716">					b.append(&quot;&lt;/center&gt;&lt;/font&gt;&lt;/td&gt;&quot;); //$NON-NLS-1$</span>
				}
<span class="nc" id="L1718">				b.append(&quot;&lt;/tr&gt;&lt;/table&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1719">				b.appendLineBreak();</span>
			}

<span class="nc" id="L1722">		}</span>

<span class="nc" id="L1724">		return b.toString();</span>
	}

	/**
	 * Produce the HTML info label for a spell book.
	 * @param book The spell book being output.
	 * @return The HTML info for the book.
	 */
	private String produceSpellBookInfo(SpellBook book)
	{
<span class="nc" id="L1734">		final HtmlInfoBuilder b = new HtmlInfoBuilder(book.getName());</span>

<span class="nc" id="L1736">		b.append(&quot; (&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1737">		b.append(book.getTypeName());</span>
<span class="nc bnc" id="L1738" title="All 2 branches missed.">		if (book.getName().equals(charDisplay.getSpellBookNameToAutoAddKnown()))</span>
		{
<span class="nc" id="L1740">			b.append(TWO_SPACES).append(BOLD);</span>
<span class="nc" id="L1741">			b.append(LanguageBundle.getString(&quot;InfoSpellsSubTab.DefaultKnownBook&quot;)) //$NON-NLS-1$</span>
<span class="nc" id="L1742">				.append(END_BOLD);</span>
		}
<span class="nc" id="L1744">		b.append(&quot;)&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1745">		b.appendLineBreak();</span>

<span class="nc" id="L1747">		b.append(LanguageBundle.getFormattedString(&quot;InfoSpells.html.spellbook.details&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1748">                book.getNumPages(), book.getNumPagesUsed(), book.getPageFormula(), book.getNumSpells()));</span>

<span class="nc bnc" id="L1750" title="All 2 branches missed.">		if (book.getDescription() != null)</span>
		{
<span class="nc" id="L1752">			b.appendLineBreak();</span>
<span class="nc" id="L1753">			b.appendI18nElement(&quot;in_descrip&quot;, book.getDescription()); //$NON-NLS-1$</span>
		}
<span class="nc" id="L1755">		return b.toString();</span>
	}

	@Override
	public String getDescription(AbilityFacade ability)
	{
<span class="nc bnc" id="L1761" title="All 4 branches missed.">		if (ability == null || !(ability instanceof Ability))</span>
		{
<span class="nc" id="L1763">			return EMPTY_STRING;</span>
		}

		try
		{
<span class="nc" id="L1768">			Ability a = (Ability) ability;</span>
<span class="nc" id="L1769">			List&lt;CNAbility&gt; wrappedAbility = getWrappedAbility(a);</span>
<span class="nc" id="L1770">			return DescriptionFormatting.piWrapDesc(a, pc.getDescription(wrappedAbility), false);</span>
		}
<span class="nc" id="L1772">		catch (Exception e)</span>
		{
<span class="nc" id="L1774">			Logging.errorPrint(&quot;Failed to get description for &quot; + ability, e); //$NON-NLS-1$</span>
<span class="nc" id="L1775">			return EMPTY_STRING;</span>
		}
	}

	@Override
	public String getDescription(Race race)
	{
<span class="nc bnc" id="L1782" title="All 2 branches missed.">		if (race == null)</span>
		{
<span class="nc" id="L1784">			return EMPTY_STRING;</span>
		}
		try
		{
<span class="nc" id="L1788">			return DescriptionFormatting.piWrapDesc(race, pc.getDescription(race), false);</span>
		}
<span class="nc" id="L1790">		catch (Exception e)</span>
		{
<span class="nc" id="L1792">			Logging.errorPrint(&quot;Failed to get description for &quot; + race, e); //$NON-NLS-1$</span>
<span class="nc" id="L1793">			return EMPTY_STRING;</span>
		}
	}

	@Override
	public String getDescription(PCTemplate template)
	{
<span class="nc bnc" id="L1800" title="All 2 branches missed.">		if (template == null)</span>
		{
<span class="nc" id="L1802">			return EMPTY_STRING;</span>
		}
		try
		{
<span class="nc" id="L1806">			return DescriptionFormatting.piWrapDesc(template, pc.getDescription(template), false);</span>
		}
<span class="nc" id="L1808">		catch (Exception e)</span>
		{
<span class="nc" id="L1810">			Logging.errorPrint(&quot;Failed to get description for &quot; + template, e); //$NON-NLS-1$</span>
<span class="nc" id="L1811">			return EMPTY_STRING;</span>
		}
	}

	@Override
	public String getDescription(PCClass pcClass)
	{
<span class="nc bnc" id="L1818" title="All 2 branches missed.">		if (pcClass == null)</span>
		{
<span class="nc" id="L1820">			return EMPTY_STRING;</span>
		}
		try
		{
<span class="nc" id="L1824">			return DescriptionFormatting.piWrapDesc(pcClass, pc.getDescription(pcClass), false);</span>
		}
<span class="nc" id="L1826">		catch (Exception e)</span>
		{
<span class="nc" id="L1828">			Logging.errorPrint(&quot;Failed to get description for &quot; + pcClass, e); //$NON-NLS-1$</span>
<span class="nc" id="L1829">			return EMPTY_STRING;</span>
		}
	}

	@Override
	public String getDescription(Skill skill)
	{
<span class="nc bnc" id="L1836" title="All 2 branches missed.">		if (skill == null)</span>
		{
<span class="nc" id="L1838">			return EMPTY_STRING;</span>
		}
		try
		{
<span class="nc" id="L1842">			return DescriptionFormatting.piWrapDesc(skill, pc.getDescription(skill), false);</span>
		}
<span class="nc" id="L1844">		catch (Exception e)</span>
		{
<span class="nc" id="L1846">			Logging.errorPrint(&quot;Failed to get description for &quot; + skill, e); //$NON-NLS-1$</span>
<span class="nc" id="L1847">			return EMPTY_STRING;</span>
		}
	}

	@Override
	public String getDescription(EquipmentFacade equipFacade)
	{
<span class="nc bnc" id="L1854" title="All 4 branches missed.">		if (equipFacade == null || !(equipFacade instanceof Equipment))</span>
		{
<span class="nc" id="L1856">			return EMPTY_STRING;</span>
		}
		try
		{
<span class="nc" id="L1860">			Equipment equip = (Equipment) equipFacade;</span>
<span class="nc" id="L1861">			return DescriptionFormatting.piWrapDesc(equip, pc.getDescription(equip), false);</span>
		}
<span class="nc" id="L1863">		catch (Exception e)</span>
		{
<span class="nc" id="L1865">			Logging.errorPrint(&quot;Failed to get description for &quot; + equipFacade, e); //$NON-NLS-1$</span>
<span class="nc" id="L1866">			return EMPTY_STRING;</span>
		}
	}

	@Override
	public String getDescription(Kit kit)
	{
<span class="nc bnc" id="L1873" title="All 2 branches missed.">		if (kit == null)</span>
		{
<span class="nc" id="L1875">			return EMPTY_STRING;</span>
		}
		try
		{
<span class="nc" id="L1879">			return DescriptionFormatting.piWrapDesc(kit, pc.getDescription(kit), false);</span>
		}
<span class="nc" id="L1881">		catch (Exception e)</span>
		{
<span class="nc" id="L1883">			Logging.errorPrint(&quot;Failed to get description for &quot; + kit, e); //$NON-NLS-1$</span>
<span class="nc" id="L1884">			return EMPTY_STRING;</span>
		}
	}

	@Override
	public String getDescription(Deity deity)
	{
<span class="nc bnc" id="L1891" title="All 2 branches missed.">		if (deity == null)</span>
		{
<span class="nc" id="L1893">			return EMPTY_STRING;</span>
		}
		try
		{
<span class="nc" id="L1897">			return DescriptionFormatting.piWrapDesc(deity, pc.getDescription(deity), false);</span>
		}
<span class="nc" id="L1899">		catch (Exception e)</span>
		{
<span class="nc" id="L1901">			Logging.errorPrint(&quot;Failed to get description for &quot; + deity, e); //$NON-NLS-1$</span>
<span class="nc" id="L1902">			return EMPTY_STRING;</span>
		}
	}

	@Override
	public String getDescription(Domain domain)
	{
<span class="nc bnc" id="L1909" title="All 2 branches missed.">		if (domain == null)</span>
		{
<span class="nc" id="L1911">			return EMPTY_STRING;</span>
		}
		try
		{
<span class="nc" id="L1915">			return DescriptionFormatting.piWrapDesc(domain, pc.getDescription(domain), false);</span>
		}
<span class="nc" id="L1917">		catch (Exception e)</span>
		{
<span class="nc" id="L1919">			Logging.errorPrint(&quot;Failed to get description for &quot; + domain, e); //$NON-NLS-1$</span>
<span class="nc" id="L1920">			return EMPTY_STRING;</span>
		}
	}

	@Override
	public String getDescription(SpellFacade spellFacade)
	{
<span class="nc bnc" id="L1927" title="All 4 branches missed.">		if (spellFacade == null || !(spellFacade instanceof SpellFacadeImplem))</span>
		{
<span class="nc" id="L1929">			return EMPTY_STRING;</span>
		}
		try
		{
<span class="nc" id="L1933">			SpellFacadeImplem spell = (SpellFacadeImplem) spellFacade;</span>
<span class="nc" id="L1934">			Spell aSpell = spell.getSpell();</span>
<span class="nc bnc" id="L1935" title="All 2 branches missed.">			if (aSpell == null)</span>
			{
<span class="nc" id="L1937">				return EMPTY_STRING;</span>
			}
<span class="nc" id="L1939">			return DescriptionFormatting.piWrapDesc(aSpell, pc.getDescription(aSpell), false);</span>
		}
<span class="nc" id="L1941">		catch (Exception e)</span>
		{
<span class="nc" id="L1943">			Logging.errorPrint(&quot;Failed to get description for &quot; + spellFacade, e); //$NON-NLS-1$</span>
<span class="nc" id="L1944">			return EMPTY_STRING;</span>
		}
	}

	@Override
	public String getDescription(TempBonusFacade tempBonusFacade)
	{
<span class="nc bnc" id="L1951" title="All 4 branches missed.">		if (tempBonusFacade == null || !(tempBonusFacade instanceof TempBonusFacadeImpl))</span>
		{
<span class="nc" id="L1953">			return EMPTY_STRING;</span>
		}
		try
		{
<span class="nc" id="L1957">			TempBonusFacadeImpl tempBonus = (TempBonusFacadeImpl) tempBonusFacade;</span>
<span class="nc" id="L1958">			CDOMObject originObj = tempBonus.getOriginObj();</span>
<span class="nc" id="L1959">			String desc = originObj.getSafe(StringKey.TEMP_DESCRIPTION);</span>
<span class="nc bnc" id="L1960" title="All 2 branches missed.">			if (StringUtils.isEmpty(desc))</span>
			{
<span class="nc bnc" id="L1962" title="All 2 branches missed.">				if (originObj instanceof Spell sp)</span>
				{
<span class="nc" id="L1964">					desc = DescriptionFormatting.piWrapDesc(sp, pc.getDescription(sp), false);</span>
				}
<span class="nc bnc" id="L1966" title="All 2 branches missed.">				else if (originObj instanceof Ability ab)</span>
				{
<span class="nc" id="L1968">					List&lt;CNAbility&gt; wrappedAbility = Collections</span>
<span class="nc" id="L1969">						.singletonList(CNAbilityFactory.getCNAbility(ab.getCDOMCategory(), Nature.NORMAL, ab));</span>
<span class="nc" id="L1970">					desc = DescriptionFormatting.piWrapDesc(ab, pc.getDescription(wrappedAbility), false);</span>
				}
			}
<span class="nc" id="L1973">			return desc;</span>
		}
<span class="nc" id="L1975">		catch (Exception e)</span>
		{
<span class="nc" id="L1977">			Logging.errorPrint(&quot;Failed to get description for &quot; + tempBonusFacade, e); //$NON-NLS-1$</span>
<span class="nc" id="L1978">			return EMPTY_STRING;</span>
		}
	}

	/**
	 * Retrieve a wrapped instance of the provided ability, whether the
	 * character has the ability or not. This will either be a list of the
	 * specific occurrences of the ability the character, or a list of a new
	 * CNAbility if the character does not possess the ability.
	 *
	 * @param a The ability to be wrapped.
	 * @return The list of wrapped abilities.
	 */
	private List&lt;CNAbility&gt; getWrappedAbility(Ability a)
	{
		/*
		 * TODO this is probably a problem in that it is doing a target (all
		 * associations for an ability, not related to the current CNAbility
		 * selected in the UI)
		 */
<span class="nc" id="L1998">		List&lt;CNAbility&gt; wrappedAbility = pc.getMatchingCNAbilities(a);</span>
<span class="nc bnc" id="L1999" title="All 2 branches missed.">		if (wrappedAbility.isEmpty())</span>
		{
<span class="nc" id="L2001">			CNAbility cna = CNAbilityFactory.getCNAbility(a.getCDOMCategory(), Nature.NORMAL, a);</span>
<span class="nc" id="L2002">			wrappedAbility.add(cna);</span>
		}
<span class="nc" id="L2004">		return wrappedAbility;</span>
	}

	@Override
	public String getDomains(Deity deity)
	{
<span class="nc bnc" id="L2010" title="All 2 branches missed.">		if (deity == null)</span>
		{
<span class="nc" id="L2012">			return EMPTY_STRING;</span>
		}
<span class="nc" id="L2014">		Set&lt;String&gt; set = new TreeSet&lt;&gt;();</span>
<span class="nc bnc" id="L2015" title="All 2 branches missed.">		for (CDOMReference&lt;Domain&gt; ref : deity.getSafeListMods(Deity.DOMAINLIST))</span>
		{
<span class="nc" id="L2017">			ref.getContainedObjects()</span>
<span class="nc" id="L2018">				.forEach(domain -&gt; set.add(OutputNameFormatting.piString(domain)));</span>
<span class="nc" id="L2019">		}</span>
<span class="nc" id="L2020">		return StringUtil.join(set, &quot;, &quot;); //$NON-NLS-1$</span>
	}

	@Override
	public String getPantheons(Deity deity)
	{
<span class="nc bnc" id="L2026" title="All 2 branches missed.">		if (deity == null)</span>
		{
<span class="nc" id="L2028">			return EMPTY_STRING;</span>
		}
<span class="nc" id="L2030">		Set&lt;String&gt; set = new TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</span>
<span class="nc" id="L2031">		FactSetKey&lt;String&gt; fk = FactSetKey.valueOf(&quot;Pantheon&quot;);</span>
<span class="nc" id="L2032">		deity.getSafeSetFor(fk).forEach(indirect -&gt; set.add(indirect.get()));</span>
<span class="nc" id="L2033">		return StringUtil.join(set, &quot;,&quot;); //$NON-NLS-1$</span>

	}

	/**
	 * Get a display string of the deity's favored weapons.
	 * @param deity The deity to be output.
	 * @return The comma separated list of weapons.
	 */
	@Override
	public String getFavoredWeapons(Deity deity)
	{
<span class="nc bnc" id="L2045" title="All 2 branches missed.">		if (deity == null)</span>
		{
<span class="nc" id="L2047">			return EMPTY_STRING;</span>
		}
<span class="nc" id="L2049">		List&lt;CDOMReference&lt;WeaponProf&gt;&gt; wpnList = deity.getSafeListFor(ListKey.DEITYWEAPON);</span>
<span class="nc" id="L2050">		return ReferenceUtilities.joinLstFormat(wpnList, &quot;,&quot;);</span>
	}

	@Override
	public String getChoices(AbilityFacade abilityFacade)
	{
<span class="nc bnc" id="L2056" title="All 4 branches missed.">		if (abilityFacade == null || !(abilityFacade instanceof final Ability ability))</span>
		{
<span class="nc" id="L2058">			return EMPTY_STRING;</span>
		}
<span class="nc" id="L2060">		final StringBuilder result = new StringBuilder(100);</span>

<span class="nc" id="L2062">		Collection&lt;CNAbility&gt; targetAbilities = pc.getMatchingCNAbilities(ability);</span>
<span class="nc bnc" id="L2063" title="All 2 branches missed.">		if (ability.getSafe(ObjectKey.MULTIPLE_ALLOWED))</span>
		{
<span class="nc" id="L2065">			ChooseInformation&lt;?&gt; chooseInfo = ability.get(ObjectKey.CHOOSE_INFO);</span>
<span class="nc" id="L2066">			processAbilities(result, targetAbilities, chooseInfo);</span>
		}
<span class="nc" id="L2068">		return result.toString();</span>
	}

	private &lt;T&gt; void processAbilities(final StringBuilder result, Collection&lt;CNAbility&gt; targetAbilities,
		ChooseInformation&lt;T&gt; chooseInfo)
	{
<span class="nc bnc" id="L2074" title="All 2 branches missed.">		if (chooseInfo == null)</span>
		{
<span class="nc" id="L2076">			return;</span>
		}

<span class="nc" id="L2079">		List&lt;T&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2080" title="All 2 branches missed.">		for (CNAbility ab : targetAbilities)</span>
		{
<span class="nc" id="L2082">			List&lt;? extends T&gt; sel = (List&lt;? extends T&gt;) pc.getDetailedAssociations(ab);</span>
<span class="nc bnc" id="L2083" title="All 2 branches missed.">			if (sel != null)</span>
			{
<span class="nc" id="L2085">				choices.addAll(sel);</span>
			}
<span class="nc" id="L2087">		}</span>

<span class="nc" id="L2089">		String choiceInfo = chooseInfo.composeDisplay(choices).toString();</span>
<span class="nc bnc" id="L2090" title="All 2 branches missed.">		if (!choiceInfo.isEmpty())</span>
		{
<span class="nc" id="L2092">			result.append(choiceInfo);</span>
		}
<span class="nc" id="L2094">	}</span>

	@Override
	public String getTempBonusTarget(TempBonusFacade tempBonusFacade)
	{
<span class="nc bnc" id="L2099" title="All 4 branches missed.">		if (tempBonusFacade == null || !(tempBonusFacade instanceof TempBonusFacadeImpl tempBonus))</span>
		{
<span class="nc" id="L2101">			return EMPTY_STRING;</span>
		}

<span class="nc" id="L2104">		Set&lt;String&gt; targetSet = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2105" title="All 2 branches missed.">		if (TempBonusHelper.hasCharacterTempBonus(tempBonus.getOriginObj()))</span>
		{
<span class="nc" id="L2107">			targetSet.add(LanguageBundle.getString(&quot;in_itmBonModelTargetTypeCharacter&quot;)); //$NON-NLS-1$</span>
		}
<span class="nc bnc" id="L2109" title="All 2 branches missed.">		if (TempBonusHelper.hasEquipmentTempBonus(tempBonus.getOriginObj()))</span>
		{
<span class="nc" id="L2111">			targetSet.addAll(TempBonusHelper.getEquipmentApplyString(tempBonus.getOriginObj()));</span>
		}
<span class="nc" id="L2113">		return StringUtil.join(targetSet, &quot;;&quot;);</span>
	}

	@Override
	public String getMovement(Race race)
	{
<span class="nc" id="L2119">		List&lt;SimpleMovement&gt; movements = race.getListFor(ListKey.BASE_MOVEMENT);</span>
<span class="nc bnc" id="L2120" title="All 4 branches missed.">		if (movements != null &amp;&amp; !movements.isEmpty())</span>
		{
<span class="nc" id="L2122">			return movements.get(0).toString();</span>
		}
<span class="nc" id="L2124">		return EMPTY_STRING;</span>
	}

	private void appendFacts(HtmlInfoBuilder infoText, CDOMObject cdo)
	{
<span class="nc" id="L2129">		Class&lt;? extends CDOMObject&gt; cl = cdo.getClass();</span>
<span class="nc" id="L2130">		LoadContext context = Globals.getContext();</span>
<span class="nc" id="L2131">		Collection&lt;FactDefinition&gt; defs = context.getReferenceContext().getConstructedCDOMObjects(FactDefinition.class);</span>
<span class="nc bnc" id="L2132" title="All 2 branches missed.">		for (FactDefinition&lt;?, ?&gt; def : defs)</span>
		{
<span class="nc bnc" id="L2134" title="All 2 branches missed.">			if (def.getUsableLocation().isAssignableFrom(cl))</span>
			{
<span class="nc" id="L2136">				Visibility visibility = def.getVisibility();</span>
<span class="nc bnc" id="L2137" title="All 4 branches missed.">				if (visibility != null &amp;&amp; visibility.isVisibleTo(View.VISIBLE_DISPLAY))</span>
				{
<span class="nc" id="L2139">					FactKey&lt;?&gt; fk = def.getFactKey();</span>
<span class="nc" id="L2140">					Indirect&lt;?&gt; fact = cdo.get(fk);</span>
<span class="nc bnc" id="L2141" title="All 2 branches missed.">					if (fact != null)</span>
					{
<span class="nc" id="L2143">						infoText.appendSpacer();</span>
<span class="nc" id="L2144">						infoText.append(&quot;&lt;b&gt;&quot;);</span>
<span class="nc" id="L2145">						infoText.append(fk.toString());</span>
<span class="nc" id="L2146">						infoText.append(&quot;:&lt;/b&gt;&amp;nbsp;&quot;);</span>
<span class="nc" id="L2147">						infoText.append(fact.getUnconverted());</span>
					}
				}
			}
<span class="nc" id="L2151">		}</span>
<span class="nc" id="L2152">		Collection&lt;FactSetDefinition&gt; setdefs =</span>
<span class="nc" id="L2153">				context.getReferenceContext().getConstructedCDOMObjects(FactSetDefinition.class);</span>
<span class="nc bnc" id="L2154" title="All 2 branches missed.">		for (FactSetDefinition&lt;?, ?&gt; def : setdefs)</span>
		{
<span class="nc bnc" id="L2156" title="All 2 branches missed.">			if (def.getUsableLocation().isAssignableFrom(cl))</span>
			{
<span class="nc" id="L2158">				Visibility visibility = def.getVisibility();</span>
<span class="nc bnc" id="L2159" title="All 4 branches missed.">				if (visibility != null &amp;&amp; visibility.isVisibleTo(View.VISIBLE_DISPLAY))</span>
				{
<span class="nc" id="L2161">					FactSetKey&lt;?&gt; fk = def.getFactSetKey();</span>
<span class="nc" id="L2162">					String s = getSetString(cdo, fk);</span>
<span class="nc bnc" id="L2163" title="All 2 branches missed.">					if (s != null)</span>
					{
<span class="nc" id="L2165">						infoText.appendSpacer();</span>
<span class="nc" id="L2166">						infoText.append(&quot;&lt;b&gt;&quot;);</span>
<span class="nc" id="L2167">						infoText.append(fk.toString());</span>
<span class="nc" id="L2168">						infoText.append(&quot;:&lt;/b&gt;&amp;nbsp;&quot;);</span>
<span class="nc" id="L2169">						infoText.append(s);</span>
					}
				}
			}
<span class="nc" id="L2173">		}</span>

<span class="nc" id="L2175">	}</span>

	private &lt;T&gt; String getSetString(CDOMObject cdo, FactSetKey&lt;T&gt; fk)
	{
<span class="nc" id="L2179">		List&lt;Indirect&lt;T&gt;&gt; set = cdo.getSetFor(fk);</span>
<span class="nc bnc" id="L2180" title="All 2 branches missed.">		if (set == null)</span>
		{
<span class="nc" id="L2182">			return null;</span>
		}
<span class="nc" id="L2184">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L2185">		boolean first = true;</span>
<span class="nc bnc" id="L2186" title="All 2 branches missed.">		for (Indirect&lt;T&gt; indirect : set)</span>
		{
<span class="nc bnc" id="L2188" title="All 2 branches missed.">			if (!first)</span>
			{
<span class="nc" id="L2190">				sb.append(Constants.COMMA);</span>
			}
<span class="nc" id="L2192">			sb.append(indirect.get());</span>
<span class="nc" id="L2193">			first = false;</span>
<span class="nc" id="L2194">		}</span>
<span class="nc" id="L2195">		return sb.toString();</span>
	}

	@Override
	public String getSize(Race race)
	{
<span class="nc" id="L2201">		Formula formula = race.get(FormulaKey.SIZE);</span>
<span class="nc bnc" id="L2202" title="All 2 branches missed.">		return (formula == null) ? &quot;&quot; : formula.toString();</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>