<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PCGenFrame.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2</a> &gt; <span class="el_source">PCGenFrame.java</span></div><h1>PCGenFrame.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2008 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 *
 */
package pcgen.gui2;

import java.awt.BorderLayout;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.io.File;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.Observer;
import java.util.Optional;
import java.util.concurrent.ExecutionException;
import java.util.logging.LogRecord;
import javax.swing.Action;
import javax.swing.ActionMap;
import javax.swing.InputMap;
import javax.swing.JCheckBox;
import javax.swing.JComponent;
import javax.swing.JDialog;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.KeyStroke;
import javax.swing.SwingConstants;
import javax.swing.SwingUtilities;
import javax.swing.SwingWorker;
import javax.swing.WindowConstants;
import org.apache.commons.lang3.StringUtils;
import pcgen.cdom.base.Constants;
import pcgen.core.Campaign;
import pcgen.core.GameMode;
import pcgen.core.Globals;
import pcgen.core.utils.ShowMessageDelegate;
import pcgen.facade.core.CharacterFacade;
import pcgen.facade.core.CharacterStubFacade;
import pcgen.facade.core.ChooserFacade;
import pcgen.facade.core.CompanionFacade;
import pcgen.facade.core.DataSetFacade;
import pcgen.facade.core.EquipmentBuilderFacade;
import pcgen.facade.core.PartyFacade;
import pcgen.facade.core.SourceSelectionFacade;
import pcgen.facade.core.SpellBuilderFacade;
import pcgen.facade.core.UIDelegate;
import pcgen.facade.util.DefaultReferenceFacade;
import pcgen.facade.util.ListFacade;
import pcgen.facade.util.ReferenceFacade;
import pcgen.facade.util.event.ReferenceEvent;
import pcgen.facade.util.event.ReferenceListener;
import pcgen.gui2.dialog.ChooserDialog;
import pcgen.gui2.dialog.EquipCustomizerDialog;
import pcgen.gui2.dialog.PostLevelUpDialog;
import pcgen.gui2.dialog.RadioChooserDialog;
import pcgen.gui2.dialog.SpellChoiceDialog;
import pcgen.gui2.sources.SourceSelectionDialog;
import pcgen.gui2.tabs.InfoTabbedPane;
import pcgen.gui2.tools.CharacterSelectionListener;
import pcgen.gui2.tools.Icons;
import pcgen.gui2.tools.TipOfTheDayHandler;
import pcgen.gui2.util.ShowMessageGuiObserver;
import pcgen.gui3.GuiAssertions;
import pcgen.gui3.GuiUtility;
import pcgen.gui3.JFXPanelFromResource;
import pcgen.gui3.component.PCGenToolBar;
import pcgen.gui3.dialog.AboutDialog;
import pcgen.gui3.dialog.RememberingChoiceDialog;
import pcgen.gui3.dialog.TipOfTheDayController;
import pcgen.io.PCGFile;
import pcgen.persistence.SourceFileLoader;
import pcgen.system.CharacterManager;
import pcgen.system.ConfigurationSettings;
import pcgen.system.FacadeFactory;
import pcgen.system.LanguageBundle;
import pcgen.system.Main;
import pcgen.system.PCGenPropBundle;
import pcgen.system.PCGenSettings;
import pcgen.system.PropertyContext;
import pcgen.util.Logging;
import pcgen.util.chooser.ChooserFactory;
import pcgen.util.chooser.RandomChooser;

import javafx.application.Platform;
import javafx.embed.swing.JFXPanel;
import javafx.scene.control.Alert;
import javafx.scene.control.ButtonType;
import javafx.scene.control.TextInputDialog;
import javafx.scene.control.ToolBar;
import javafx.stage.FileChooser;
import javafx.stage.Stage;

import static javax.swing.JOptionPane.CLOSED_OPTION;

/**
 * The main window for PCGen. In addition, this class is responsible for providing
 * global UI functions such as message dialogs.
 */
public final class PCGenFrame extends JFrame implements UIDelegate, CharacterSelectionListener
{

	private final PCGenActionMap actionMap;
	private final CharacterTabs characterTabs;
	private final PCGenStatusBar statusBar;
	private final PCGenMenuBar pcGenMenuBar;

	/**
	 * The context indicating what items are currently loaded/being processed in the UI
	 */
	private final UIContext uiContext;

	private final DefaultReferenceFacade&lt;SourceSelectionFacade&gt; currentSourceSelection;
	private final DefaultReferenceFacade&lt;CharacterFacade&gt; currentCharacterRef;
	private final DefaultReferenceFacade&lt;DataSetFacade&gt; currentDataSetRef;
	private final FilenameListener filenameListener;
	private JDialog sourceSelectionDialog;
	private SourceLoadWorker sourceLoader;
	private String section15;
	private String lastCharacterPath;
	/**
	 * This is a bit of a hack until we're full on JavaFX for showing dialogs
	 */
	private Stage javaFXStage;

	private AboutDialog javaFXAboutDialog;

	public PCGenFrame(UIContext uiContext)
<span class="nc" id="L151">	{</span>
<span class="nc" id="L152">		this.uiContext = Objects.requireNonNull(uiContext);</span>
<span class="nc" id="L153">		Globals.setRootFrame(this);</span>
<span class="nc" id="L154">		this.currentSourceSelection = uiContext.getCurrentSourceSelectionRef();</span>
<span class="nc" id="L155">		this.currentCharacterRef = new DefaultReferenceFacade&lt;&gt;();</span>
<span class="nc" id="L156">		this.currentDataSetRef = new DefaultReferenceFacade&lt;&gt;();</span>
<span class="nc" id="L157">		this.actionMap = new PCGenActionMap(this, uiContext);</span>
<span class="nc" id="L158">		this.characterTabs = new CharacterTabs(this);</span>
<span class="nc" id="L159">		this.statusBar = new PCGenStatusBar(this);</span>
<span class="nc" id="L160">		this.filenameListener = new FilenameListener();</span>
<span class="nc" id="L161">		Observer messageObserver = new ShowMessageGuiObserver(this);</span>
<span class="nc" id="L162">		ShowMessageDelegate.getInstance().addObserver(messageObserver);</span>
<span class="nc" id="L163">		ChooserFactory.setDelegate(this);</span>
<span class="nc" id="L164">		this.pcGenMenuBar = new PCGenMenuBar(this, uiContext);</span>
<span class="nc" id="L165">		initComponents();</span>
<span class="nc" id="L166">		pack();</span>
<span class="nc" id="L167">		initSettings();</span>
<span class="nc" id="L168">		Platform.runLater(() -&gt; {</span>
<span class="nc" id="L169">				javaFXStage = new Stage();</span>
<span class="nc" id="L170">				javaFXAboutDialog = new AboutDialog(javaFXStage);</span>
<span class="nc" id="L171">			}</span>
		);
<span class="nc" id="L173">	}</span>

	private void initComponents()
	{
<span class="nc" id="L177">		setLayout(new BorderLayout());</span>

<span class="nc" id="L179">		JComponent root = getRootPane();</span>
<span class="nc" id="L180">		root.setActionMap(actionMap);</span>
<span class="nc" id="L181">		root.setInputMap(JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT, createInputMap(actionMap));</span>

<span class="nc" id="L183">		characterTabs.add(new InfoGuidePane(this, uiContext));</span>

<span class="nc" id="L185">		setJMenuBar(pcGenMenuBar);</span>
<span class="nc" id="L186">		PCGenToolBar pcGenToolBar = new PCGenToolBar(this);</span>
<span class="nc" id="L187">		ToolBar toolBar = pcGenToolBar.buildMenu();</span>
<span class="nc" id="L188">		JFXPanel wrappedToolBar = GuiUtility.wrapParentAsJFXPanel(toolBar);</span>

<span class="nc" id="L190">		add(wrappedToolBar, BorderLayout.NORTH);</span>
<span class="nc" id="L191">		add(characterTabs, BorderLayout.CENTER);</span>
<span class="nc" id="L192">		add(statusBar, BorderLayout.SOUTH);</span>
<span class="nc" id="L193">		updateTitle();</span>
<span class="nc" id="L194">		setIconImage(Icons.PCGenApp.getImageIcon().getImage());</span>
<span class="nc" id="L195">	}</span>

	private void initSettings()
	{
<span class="nc" id="L199">		setSize(1060, 725); //this is the default frame dimensions</span>

<span class="nc" id="L201">		setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</span>
<span class="nc" id="L202">		addWindowListener(new WindowAdapter()</span>
<span class="nc" id="L203">		{</span>

			@Override
			public void windowClosing(WindowEvent e)
			{
<span class="nc" id="L208">				PCGenUIManager.closePCGen();</span>
<span class="nc" id="L209">			}</span>

		});
<span class="nc" id="L212">	}</span>

	/**
	 * This is called after initialization and starts up the PCGenFrame
	 * by setting it visible and then performing other startup actions
	 * as the user's preferences dictate.
	 */
	void startPCGenFrame()
	{
<span class="nc" id="L221">		GuiAssertions.assertIsSwingThread();</span>
<span class="nc" id="L222">		setVisible(true);</span>
<span class="nc" id="L223">		new StartupWorker().start();</span>
<span class="nc" id="L224">	}</span>

	/**
	 * This thread does the work of starting up the UI.
	 * If command arguments are present it handles them, otherwise it starts up normally.
	 */
<span class="nc" id="L230">	private class StartupWorker extends Thread</span>
	{

		@Override
		public void run()
		{
			try
			{
<span class="nc" id="L238">				boolean alternateStartup = false;</span>
<span class="nc" id="L239">				alternateStartup |= maybeLoadCampaign();</span>
<span class="nc" id="L240">				alternateStartup |= maybeLoadOrCreateCharacter();</span>
<span class="nc" id="L241">				alternateStartup |= maybeAutoLoadSources();</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">				if (!alternateStartup)</span>
				{
					//Do a default startup
<span class="nc" id="L246">					SwingUtilities.invokeLater(() -&gt; {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">						if (TipOfTheDayHandler.shouldShowTipOfTheDay())</span>
						{
<span class="nc" id="L249">							showTipsOfTheDay();</span>
						}

<span class="nc bnc" id="L252" title="All 2 branches missed.">						if (!SourceSelectionDialog.skipSourceSelection())</span>
						{
<span class="nc" id="L254">							showSourceSelectionDialog();</span>
						}
<span class="nc" id="L256">					});</span>
				}
			}
<span class="nc" id="L259">			catch (InterruptedException | InvocationTargetException ex)</span>
			{
<span class="nc" id="L261">				Logging.errorPrint(&quot;Unexepected exception&quot;, ex);</span>
<span class="nc" id="L262">			}</span>
<span class="nc" id="L263">		}</span>

		/**
		 * If the preference to auto load sources at start is set, find the
		 * sources that were last loaded and load them now.
		 * @return true if the sources have been loaded, false if not.
		 * @throws InterruptedException If the load was interrupted.
		 */
		private boolean maybeAutoLoadSources() throws InterruptedException
		{
<span class="nc" id="L273">			boolean autoLoadSources =</span>
<span class="nc" id="L274">					PCGenSettings.OPTIONS_CONTEXT.initBoolean(PCGenSettings.OPTION_AUTOLOAD_SOURCES_AT_START, false);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">			if (autoLoadSources)</span>
			{
<span class="nc" id="L277">				String gameModeName = PCGenSettings.getInstance().getProperty(PCGenSettings.LAST_LOADED_GAME);</span>
<span class="nc" id="L278">				String sourcesNameString = PCGenSettings.getInstance().getProperty(PCGenSettings.LAST_LOADED_SOURCES);</span>
<span class="nc bnc" id="L279" title="All 4 branches missed.">				if (StringUtils.isEmpty(gameModeName) || StringUtils.isEmpty(sourcesNameString))</span>
				{
<span class="nc" id="L281">					return false;</span>
				}
<span class="nc" id="L283">				GameMode gameMode = null;</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">				for (GameMode facade : FacadeFactory.getGameModes())</span>
				{
<span class="nc bnc" id="L286" title="All 2 branches missed.">					if (gameModeName.equals(facade.toString()))</span>
					{
<span class="nc" id="L288">						gameMode = facade;</span>
<span class="nc" id="L289">						break;</span>
					}

<span class="nc" id="L292">				}</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">				if (gameMode == null)</span>
				{
<span class="nc" id="L295">					return false;</span>
				}

<span class="nc" id="L298">				List&lt;Campaign&gt; campaigns = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L299">				String[] sourceNames = sourcesNameString.split(&quot;\\|&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">				for (Campaign camp : FacadeFactory.getCampaigns())</span>
				{
<span class="nc bnc" id="L302" title="All 2 branches missed.">					for (String name : sourceNames)</span>
					{
<span class="nc bnc" id="L304" title="All 2 branches missed.">						if (name.equals(camp.toString()))</span>
						{
<span class="nc" id="L306">							campaigns.add(camp);</span>
<span class="nc" id="L307">							break;</span>
						}
					}
<span class="nc" id="L310">				}</span>

<span class="nc" id="L312">				SourceSelectionFacade selection = FacadeFactory.createSourceSelection(gameMode, campaigns);</span>
<span class="nc" id="L313">				loadSourceSelection(selection);</span>
<span class="nc" id="L314">				sourceLoader.join();</span>
<span class="nc" id="L315">				return true;</span>
			}

<span class="nc" id="L318">			return false;</span>
		}

		private boolean maybeLoadCampaign() throws InterruptedException
		{
<span class="nc" id="L323">			String camp = Main.getStartupCampaign().orElse(null);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">			if (camp != null)</span>
			{
<span class="nc" id="L326">				SourceSelectionFacade selection = null;</span>
<span class="nc" id="L327">				ListFacade&lt;SourceSelectionFacade&gt; sources = FacadeFactory.getSourceSelections();</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">				for (SourceSelectionFacade sourceSelectionFacade : sources)</span>
				{
<span class="nc bnc" id="L330" title="All 2 branches missed.">					if (sourceSelectionFacade.toString().equals(camp))</span>
					{
<span class="nc" id="L332">						selection = sourceSelectionFacade;</span>
<span class="nc" id="L333">						break;</span>
					}
<span class="nc" id="L335">				}</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">				if (selection != null)</span>
				{
<span class="nc" id="L338">					loadSourceSelection(selection);</span>
<span class="nc" id="L339">					sourceLoader.join();</span>
<span class="nc" id="L340">					return true;</span>
				}
				else
				{
					//did not find source
<span class="nc" id="L345">					Logging.errorPrint(&quot;Ignoring invalid campaign requested in -m flag: '&quot; + camp + &quot;'.&quot;);</span>
<span class="nc" id="L346">					return false;</span>
				}
			}
<span class="nc" id="L349">			return false;</span>
		}

		/**
		 * loads or creates a character based upon the command line arguments.
		 * This also handles the start in character sheet command option
		 * @return boolean
		 * @throws InterruptedException
		 * @throws InvocationTargetException
		 */
		private boolean maybeLoadOrCreateCharacter() throws InterruptedException, InvocationTargetException
		{
<span class="nc bnc" id="L361" title="All 2 branches missed.">			if (Main.getStartupCharacterFile().isEmpty())</span>
			{
<span class="nc" id="L363">				return false;</span>
			}
<span class="nc" id="L365">			final File file = Main.getStartupCharacterFile().get();</span>
<span class="nc" id="L366">			final DataSetFacade dataset = currentDataSetRef.get();</span>
<span class="nc bnc" id="L367" title="All 4 branches missed.">			if (!file.exists() &amp;&amp; dataset == null)</span>
			{
<span class="nc" id="L369">				Logging.errorPrint(&quot;The provided file does not exist: '{0}'.&quot;, file);</span>
<span class="nc" id="L370">				return false;</span>
			}
<span class="nc bnc" id="L372" title="All 2 branches missed.">			if (Main.shouldStartInCharacterSheet())</span>
			{
<span class="nc" id="L374">				String key = UIPropertyContext.C_PROP_INITIAL_TAB;</span>
<span class="nc" id="L375">				key = UIPropertyContext.createFilePropertyKey(file, key);</span>
<span class="nc" id="L376">				UIPropertyContext.getInstance().setInt(key, InfoTabbedPane.CHARACTER_SHEET_TAB);</span>
			}
<span class="nc" id="L378">			GuiAssertions.assertIsNotSwingThread();</span>
<span class="nc" id="L379">			SwingUtilities.invokeAndWait(() -&gt; {</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">				if (!file.exists())</span>
				{
<span class="nc" id="L382">					createNewCharacter(file);</span>
				}
<span class="nc bnc" id="L384" title="All 2 branches missed.">				else if (dataset == null)</span>
				{
<span class="nc" id="L386">					loadCharacterFromFile(file);</span>
				}
				else
				{
<span class="nc" id="L390">					openCharacter(file, dataset);</span>
				}
<span class="nc" id="L392">			});</span>
<span class="nc" id="L393">			return true;</span>
		}

	}

	private static InputMap createInputMap(ActionMap actionMap)
	{
<span class="nc" id="L400">		InputMap inputMap = new InputMap();</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">		for (Object obj : actionMap.keys())</span>
		{
<span class="nc" id="L403">			KeyStroke key = (KeyStroke) actionMap.get(obj).getValue(Action.ACCELERATOR_KEY);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">			if (key != null)</span>
			{
<span class="nc" id="L406">				inputMap.put(key, obj);</span>
			}
		}
<span class="nc" id="L409">		return inputMap;</span>
	}

	public PCGenActionMap getActionMap()
	{
<span class="nc" id="L414">		return actionMap;</span>
	}

	@Override
	public void setCharacter(CharacterFacade character)
	{
<span class="nc bnc" id="L420" title="All 2 branches missed.">		if (currentCharacterRef.get() != null)</span>
		{
<span class="nc" id="L422">			currentCharacterRef.get().getFileRef().removeReferenceListener(filenameListener);</span>
		}
<span class="nc" id="L424">		currentCharacterRef.set(character);</span>
<span class="nc" id="L425">		updateTitle();</span>
<span class="nc bnc" id="L426" title="All 4 branches missed.">		if (character != null &amp;&amp; character.getFileRef() != null)</span>
		{
<span class="nc" id="L428">			character.getFileRef().addReferenceListener(filenameListener);</span>
		}
<span class="nc bnc" id="L430" title="All 2 branches missed.">		if (character != null)</span>
		{
<span class="nc" id="L432">			pcGenMenuBar.setCharacter(character);</span>
		}
<span class="nc" id="L434">	}</span>

	/**
	 *
	 * @return a reference to the selected character
	 */
	public ReferenceFacade&lt;CharacterFacade&gt; getSelectedCharacterRef()
	{
<span class="nc" id="L442">		return currentCharacterRef;</span>
	}

	/**
	 *
	 * @return a reference to the currently loaded data set
	 */
	public ReferenceFacade&lt;DataSetFacade&gt; getLoadedDataSetRef()
	{
<span class="nc" id="L451">		return currentDataSetRef;</span>
	}

	/**
	 * @return the status bar for the main PCGen frame
	 */
	public PCGenStatusBar getStatusBar()
	{
<span class="nc" id="L459">		return statusBar;</span>
	}

	/**
	 * Unload any currently loaded sources.
	 */
	public void unloadSources()
	{
		//make sure all characters are closed before unloading sources.
<span class="nc bnc" id="L468" title="All 2 branches missed.">		if (closeAllCharacters())</span>
		{
<span class="nc" id="L470">			currentSourceSelection.set(null);</span>
<span class="nc" id="L471">			currentDataSetRef.set(null);</span>
<span class="nc" id="L472">			Globals.emptyLists();</span>
<span class="nc" id="L473">			updateTitle();</span>
		}
<span class="nc" id="L475">	}</span>

	/**
	 * Loads a selection of sources into PCGen asynchronously and
	 * tracks the load progress on the status bar. While sources
	 * are being loaded any calls to this method are ignored until
	 * sources are finished loading.
	 * @param sources a SourceSelectionFacade specifying the sources to load
	 * @return true if the sources are loaded or are loading
	 */
	public boolean loadSourceSelection(SourceSelectionFacade sources)
	{
<span class="nc bnc" id="L487" title="All 2 branches missed.">		if (sources == null)</span>
		{
<span class="nc" id="L489">			return false;</span>
		}
<span class="nc bnc" id="L491" title="All 4 branches missed.">		if (sourceLoader != null &amp;&amp; sourceLoader.isAlive())</span>
		{
<span class="nc" id="L493">			return checkSourceEquality(sources, sourceLoader.sources);</span>
		}
<span class="nc bnc" id="L495" title="All 2 branches missed.">		if (checkSourceEquality(sources, currentSourceSelection.get()))</span>
		{
<span class="nc" id="L497">			return true;</span>
		}
		//make sure all characters are closed before loading new sources.
<span class="nc bnc" id="L500" title="All 2 branches missed.">		if (closeAllCharacters())</span>
		{
<span class="nc" id="L502">			sourceLoader = new SourceLoadWorker(sources, this);</span>
<span class="nc" id="L503">			sourceLoader.start();</span>
<span class="nc" id="L504">			return true;</span>
		}
<span class="nc" id="L506">		return false;</span>
	}

	private boolean checkSourceEquality(SourceSelectionFacade source1, SourceSelectionFacade source2)
	{
<span class="nc bnc" id="L511" title="All 2 branches missed.">		if (source1 == source2)</span>
		{
<span class="nc" id="L513">			return true;</span>
		}
<span class="nc bnc" id="L515" title="All 6 branches missed.">		if (source1 == null ^ source2 == null)</span>
		{
<span class="nc" id="L517">			return false;</span>
		}
		//we use reference equality since GameModes come from a fixed database
<span class="nc bnc" id="L520" title="All 2 branches missed.">		if (source1.getGameMode().get() != source2.getGameMode().get())</span>
		{
<span class="nc" id="L522">			return false;</span>
		}
<span class="nc" id="L524">		ListFacade&lt;Campaign&gt; campaigns1 = source1.getCampaigns();</span>
<span class="nc" id="L525">		ListFacade&lt;Campaign&gt; campaigns2 = source2.getCampaigns();</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">		if (campaigns1.getSize() != campaigns2.getSize())</span>
		{
<span class="nc" id="L528">			return false;</span>
		}
<span class="nc bnc" id="L530" title="All 2 branches missed.">		for (Campaign campaign : campaigns1)</span>
		{
<span class="nc bnc" id="L532" title="All 2 branches missed.">			if (!campaigns2.containsElement(campaign))</span>
			{
<span class="nc" id="L534">				return false;</span>
			}
<span class="nc" id="L536">		}</span>
<span class="nc" id="L537">		return true;</span>
	}

	private static boolean checkGameModeEquality(SourceSelectionFacade source1, SourceSelectionFacade source2)
	{
<span class="nc bnc" id="L542" title="All 2 branches missed.">		if (source1 == source2)</span>
		{
<span class="nc" id="L544">			return true;</span>
		}
<span class="nc bnc" id="L546" title="All 6 branches missed.">		if (source1 == null ^ source2 == null)</span>
		{
<span class="nc" id="L548">			return false;</span>
		}
		//we use reference equality since GameModes come from a fixed database
<span class="nc bnc" id="L551" title="All 2 branches missed.">        return source1.getGameMode().get() == source2.getGameMode().get();</span>
    }

	public boolean saveCharacter(CharacterFacade character)
	{
<span class="nc bnc" id="L556" title="All 2 branches missed.">		if (!CharacterManager.characterFilenameValid(character))</span>
		{
<span class="nc" id="L558">			return showSaveCharacterChooser(character);</span>
		}
		// We must have a file name before we prepare.
<span class="nc" id="L561">		prepareForSave(character, false);</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">		if (!reallySaveCharacter(character))</span>
		{
<span class="nc" id="L564">			return showSaveCharacterChooser(character);</span>
		}
<span class="nc" id="L566">		return true;</span>
	}

	/**
	 * Wraps the CharacterManager with GUI progress updates
	 * @param character
	 * @return value from CharacterManager.saveCharacter()
	 */
	public boolean reallySaveCharacter(CharacterFacade character)
	{
<span class="nc" id="L576">		boolean result = false;</span>

		// KAW TODO externalize and NLS the msg
<span class="nc" id="L579">		final String msg = &quot;Saving character...&quot;;</span>
<span class="nc" id="L580">		statusBar.startShowingProgress(msg, true);</span>
		try
		{
<span class="nc" id="L583">			result = CharacterManager.saveCharacter(character);</span>
		}
<span class="nc" id="L585">		catch (Exception e)</span>
		{
<span class="nc" id="L587">			Logging.errorPrint(e.getLocalizedMessage(), e);</span>
		}
		finally
		{
<span class="nc" id="L591">			statusBar.endShowingProgress();</span>
		}
<span class="nc" id="L593">		return result;</span>
	}

	/**
	 * Prepare the character for a save. This is primarily concerned with
	 * ensuring all companions (or masters) have file names before the save is
	 * done.
	 * @param character The character being saved.
	 */
	private void prepareForSave(CharacterFacade character, boolean savingAll)
	{
<span class="nc" id="L604">		List&lt;CompanionFacade&gt; tobeSaved = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">		for (CompanionFacade comp : character.getCompanionSupport().getCompanions())</span>
		{
<span class="nc bnc" id="L607" title="All 2 branches missed.">			if (StringUtils.isEmpty(comp.getFileRef().get().getName())</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">				&amp;&amp; CharacterManager.getCharacterMatching(comp) != null)</span>
			{
<span class="nc" id="L610">				tobeSaved.add(comp);</span>
			}
<span class="nc" id="L612">		}</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">		if (!tobeSaved.isEmpty())</span>
		{
<span class="nc bnc" id="L615" title="All 2 branches missed.">			if (savingAll</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">				|| showMessageConfirm(Constants.APPLICATION_NAME,</span>
<span class="nc" id="L617">					LanguageBundle.getString(&quot;in_unsavedCompanions&quot;))) //$NON-NLS-1$</span>
			{
<span class="nc bnc" id="L619" title="All 2 branches missed.">				for (CompanionFacade companionFacade : tobeSaved)</span>
				{
<span class="nc" id="L621">					CharacterFacade compChar = CharacterManager.getCharacterMatching(companionFacade);</span>
<span class="nc" id="L622">					showSaveCharacterChooser(compChar);</span>
<span class="nc" id="L623">				}</span>
			}
		}
<span class="nc" id="L626">		CharacterStubFacade master = character.getMaster();</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">		if (master != null</span>
<span class="nc bnc" id="L628" title="All 4 branches missed.">			&amp;&amp; (master.getFileRef().get() == null || StringUtils.isEmpty(master.getFileRef().get().getName())))</span>
		{
<span class="nc bnc" id="L630" title="All 2 branches missed.">			if (savingAll</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">				|| showMessageConfirm(Constants.APPLICATION_NAME,</span>
<span class="nc" id="L632">					LanguageBundle.getString(&quot;in_unsavedMaster&quot;))) //$NON-NLS-1$</span>
			{
<span class="nc" id="L634">				CharacterFacade masterChar = CharacterManager.getCharacterMatching(master);</span>
<span class="nc" id="L635">				showSaveCharacterChooser(masterChar);</span>
			}
		}
<span class="nc" id="L638">	}</span>

	public void closeCharacter(CharacterFacade character)
	{
<span class="nc bnc" id="L642" title="All 2 branches missed.">		if (character.isDirty())</span>
		{
<span class="nc" id="L644">			int ret = JOptionPane.showConfirmDialog(this,</span>
<span class="nc" id="L645">				LanguageBundle.getFormattedString(&quot;in_savePcChoice&quot;, character //$NON-NLS-1$</span>
<span class="nc" id="L646">				.getNameRef().get()), Constants.APPLICATION_NAME, JOptionPane.YES_NO_CANCEL_OPTION);</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">			if (ret == JOptionPane.CANCEL_OPTION)</span>
			{
<span class="nc" id="L649">				return;</span>
			}
<span class="nc bnc" id="L651" title="All 2 branches missed.">			if (ret == JOptionPane.YES_OPTION)</span>
			{
<span class="nc" id="L653">				saveCharacter(character);</span>
			}
		}
<span class="nc" id="L656">		CharacterManager.removeCharacter(character);</span>
<span class="nc" id="L657">	}</span>

	public boolean closeAllCharacters()
	{
<span class="nc" id="L661">		final int CLOSE_OPT_CHOOSE = 2;</span>
<span class="nc" id="L662">		ListFacade&lt;CharacterFacade&gt; characters = CharacterManager.getCharacters();</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">		if (characters.isEmpty())</span>
		{
<span class="nc" id="L665">			return true;</span>
		}
<span class="nc" id="L667">		int saveAllChoice = CLOSE_OPT_CHOOSE;</span>

<span class="nc" id="L669">		List&lt;CharacterFacade&gt; characterList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L670">		List&lt;CharacterFacade&gt; unsavedPCs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">		for (CharacterFacade characterFacade : characters)</span>
		{
<span class="nc bnc" id="L673" title="All 2 branches missed.">			if (characterFacade.isDirty())</span>
			{
<span class="nc" id="L675">				unsavedPCs.add(characterFacade);</span>
			}
			else
			{
<span class="nc" id="L679">				characterList.add(characterFacade);</span>
			}
<span class="nc" id="L681">		}</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">		if (unsavedPCs.size() &gt; 1)</span>
		{
<span class="nc" id="L684">			Object[] options = {LanguageBundle.getString(&quot;in_closeOptSaveAll&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L685">				LanguageBundle.getString(&quot;in_closeOptSaveNone&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L686">				LanguageBundle.getString(&quot;in_closeOptChoose&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L687">				LanguageBundle.getString(&quot;in_cancel&quot;) //$NON-NLS-1$</span>
			};
<span class="nc" id="L689">			saveAllChoice = JOptionPane.showOptionDialog(this,</span>
<span class="nc" id="L690">				LanguageBundle.getString(&quot;in_closeOptSaveTitle&quot;), //$NON-NLS-1$</span>
				Constants.APPLICATION_NAME,
					JOptionPane.YES_NO_CANCEL_OPTION,
					JOptionPane.QUESTION_MESSAGE,
					null,
					options,
					options[0]);
		}
<span class="nc bnc" id="L698" title="All 4 branches missed.">		if (saveAllChoice == 3 || saveAllChoice == CLOSED_OPTION)</span>
		{
			// Cancel
<span class="nc" id="L701">			return false;</span>
		}
<span class="nc bnc" id="L703" title="All 2 branches missed.">		if (saveAllChoice == 1)</span>
		{
			// Save none
<span class="nc" id="L706">			CharacterManager.removeAllCharacters();</span>
<span class="nc" id="L707">			return true;</span>
		}

<span class="nc bnc" id="L710" title="All 2 branches missed.">		for (CharacterFacade character : unsavedPCs)</span>
		{
<span class="nc" id="L712">			int saveSingleChoice = JOptionPane.YES_OPTION;</span>

<span class="nc bnc" id="L714" title="All 2 branches missed.">			if (saveAllChoice == CLOSE_OPT_CHOOSE)</span>
			{
<span class="nc" id="L716">				saveSingleChoice = JOptionPane.showConfirmDialog(this,</span>
<span class="nc" id="L717">					LanguageBundle.getFormattedString(&quot;in_savePcChoice&quot;, character //$NON-NLS-1$</span>
<span class="nc" id="L718">						.getNameRef().get()),</span>
					Constants.APPLICATION_NAME, JOptionPane.YES_NO_CANCEL_OPTION);
			}

<span class="nc bnc" id="L722" title="All 4 branches missed.">			switch (saveSingleChoice)</span>
			{
				case JOptionPane.YES_OPTION: //If you get here then the user either selected &quot;Yes to All&quot; or &quot;Yes&quot;
<span class="nc bnc" id="L725" title="All 2 branches missed.">					if (saveCharacter(character))</span>
					{
<span class="nc" id="L727">						characterList.add(character);</span>
					}
					break;
				case JOptionPane.NO_OPTION:
<span class="nc" id="L731">					characterList.add(character);</span>
<span class="nc" id="L732">					break;</span>
				case JOptionPane.CANCEL_OPTION:
<span class="nc" id="L734">					return false;</span>
			}
<span class="nc" id="L736">		}</span>

<span class="nc bnc" id="L738" title="All 2 branches missed.">		for (CharacterFacade character : characterList)</span>
		{
<span class="nc" id="L740">			CharacterManager.removeCharacter(character);</span>
<span class="nc" id="L741">		}</span>
<span class="nc" id="L742">		return characters.isEmpty();</span>
	}

	boolean showSavePartyChooser()
	{
<span class="nc" id="L747">		PartyFacade party = CharacterManager.getCharacters();</span>
<span class="nc" id="L748">		PCGenSettings context = PCGenSettings.getInstance();</span>
<span class="nc" id="L749">		String parentPath = context.getProperty(PCGenSettings.PCP_SAVE_PATH);</span>
<span class="nc" id="L750">		File oldFile = party.getFileRef().get();</span>


<span class="nc" id="L753">		FileChooser fileChooser = new FileChooser();</span>
<span class="nc" id="L754">		fileChooser.setTitle(&quot;Save PCGen Party&quot;);</span>
<span class="nc" id="L755">		fileChooser.setInitialDirectory(new File(parentPath));</span>

<span class="nc" id="L757">		FileChooser.ExtensionFilter extensionFilter = new FileChooser.ExtensionFilter(</span>
				&quot;party files only&quot;, &quot;*.pcp&quot;
		);
<span class="nc" id="L760">		fileChooser.getExtensionFilters().add(extensionFilter);</span>
<span class="nc" id="L761">		fileChooser.setSelectedExtensionFilter(extensionFilter);</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">		if (oldFile != null)</span>
		{
<span class="nc" id="L764">			fileChooser.setInitialFileName(oldFile.getName());</span>
		}

<span class="nc" id="L767">		File file = GuiUtility.runOnJavaFXThreadNow(() -&gt;</span>
<span class="nc" id="L768">				fileChooser.showSaveDialog(null));</span>

<span class="nc bnc" id="L770" title="All 2 branches missed.">		if (file == null)</span>
		{
<span class="nc" id="L772">			return false;</span>
		}
<span class="nc bnc" id="L774" title="All 2 branches missed.">		if (file.exists())</span>
		{
<span class="nc" id="L776">			boolean overwrite =</span>
<span class="nc" id="L777">					showWarningConfirm(</span>
<span class="nc" id="L778">						LanguageBundle.getFormattedString(&quot;in_savePcConfirmOverTitle&quot;, file.getName()), //$NON-NLS-1$</span>
<span class="nc" id="L779">						LanguageBundle.getFormattedString(&quot;in_savePcConfirmOverMsg&quot;, file.getName())); //$NON-NLS-1$</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">			if (!overwrite)</span>
			{
<span class="nc" id="L782">				return showSavePartyChooser();</span>
			}
		}
<span class="nc" id="L785">		party.setFile(file);</span>
<span class="nc" id="L786">		context.setProperty(PCGenSettings.PCP_SAVE_PATH, file.getParent());</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">		if (!saveAllCharacters())</span>
		{
<span class="nc" id="L789">			showErrorMessage(LanguageBundle.getString(&quot;in_savePartyFailTitle&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L790">				LanguageBundle.getString(&quot;in_savePartyFailMsg&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L791">			return false;</span>
		}
<span class="nc bnc" id="L793" title="All 2 branches missed.">		if (!CharacterManager.saveCurrentParty())</span>
		{
<span class="nc" id="L795">			return showSavePartyChooser();</span>
		}
<span class="nc" id="L797">		return true;</span>
	}

	boolean saveAllCharacters()
	{
<span class="nc" id="L802">		boolean ok = true;</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">		for (CharacterFacade character : CharacterManager.getCharacters())</span>
		{
<span class="nc" id="L805">			File file = character.getFileRef().get();</span>
<span class="nc bnc" id="L806" title="All 4 branches missed.">			if (file == null || StringUtils.isEmpty(file.getName()))</span>
			{
<span class="nc" id="L808">				ok &amp;= showSaveCharacterChooser(character);</span>
			}
			else
			{
<span class="nc" id="L812">				prepareForSave(character, true);</span>
<span class="nc" id="L813">				ok &amp;= reallySaveCharacter(character);</span>
			}
<span class="nc" id="L815">		}</span>
<span class="nc" id="L816">		return ok;</span>
	}

	/**
	 * This brings up a file chooser allows the user to select
	 * the location that a character should be saved to.
	 * @param character the character to be saved
	 */
	boolean showSaveCharacterChooser(CharacterFacade character)
	{
<span class="nc" id="L826">		PCGenSettings context = PCGenSettings.getInstance();</span>
<span class="nc" id="L827">		String parentPath = lastCharacterPath;</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">		if (parentPath == null)</span>
		{
<span class="nc" id="L830">			parentPath = context.getProperty(PCGenSettings.PCG_SAVE_PATH);</span>
		}

<span class="nc" id="L833">		FileChooser fileChooser = new FileChooser();</span>
<span class="nc" id="L834">		fileChooser.setTitle(&quot;Save PCGen Character File&quot;);</span>
<span class="nc" id="L835">		FileChooser.ExtensionFilter extensionFilter = new FileChooser.ExtensionFilter(</span>
				&quot;character files only&quot;, '*' + Constants.EXTENSION_CHARACTER_FILE
		);
<span class="nc" id="L838">		fileChooser.getExtensionFilters().add(extensionFilter);</span>
<span class="nc" id="L839">		fileChooser.setSelectedExtensionFilter(extensionFilter);</span>

<span class="nc" id="L841">		File prevFile = character.getFileRef().get();</span>
<span class="nc bnc" id="L842" title="All 4 branches missed.">		if (prevFile == null || StringUtils.isEmpty(prevFile.getName()))</span>
		{
<span class="nc" id="L844">			fileChooser.setInitialDirectory(new File(parentPath));</span>
<span class="nc" id="L845">			fileChooser.setInitialFileName(character.getNameRef().get() + Constants.EXTENSION_CHARACTER_FILE);</span>
		}

<span class="nc" id="L848">		File file = GuiUtility.runOnJavaFXThreadNow(() -&gt;</span>
<span class="nc" id="L849">				fileChooser.showSaveDialog(null));</span>

<span class="nc bnc" id="L851" title="All 2 branches missed.">		if (file != null)</span>
		{
<span class="nc" id="L853">			UIDelegate delegate = character.getUIDelegate();</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">			if (file.isDirectory())</span>
			{
<span class="nc" id="L856">				delegate.showErrorMessage(Constants.APPLICATION_NAME,</span>
<span class="nc" id="L857">					LanguageBundle.getString(&quot;in_savePcDirOverwrite&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L858">				return showSaveCharacterChooser(character);</span>
			}

<span class="nc bnc" id="L861" title="All 6 branches missed.">			if (file.exists() &amp;&amp; (prevFile == null || !file.getName().equals(prevFile.getName())))</span>
			{
<span class="nc" id="L863">				boolean overwrite = delegate.showWarningConfirm(</span>
<span class="nc" id="L864">					LanguageBundle.getFormattedString(&quot;in_savePcConfirmOverTitle&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L865">						file.getName()),</span>
<span class="nc" id="L866">					LanguageBundle.getFormattedString(&quot;in_savePcConfirmOverMsg&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L867">						file.getName()));</span>

<span class="nc bnc" id="L869" title="All 2 branches missed.">				if (!overwrite)</span>
				{
<span class="nc" id="L871">					return showSaveCharacterChooser(character);</span>
				}
			}

			try
			{
<span class="nc" id="L877">				character.setFile(file);</span>
<span class="nc" id="L878">				prepareForSave(character, false);</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">				if (!reallySaveCharacter(character))</span>
				{
<span class="nc" id="L881">					return showSaveCharacterChooser(character);</span>
				}

<span class="nc" id="L884">				lastCharacterPath = file.getParent();</span>
<span class="nc" id="L885">				return true;</span>
			}
<span class="nc" id="L887">			catch (Exception e)</span>
			{
<span class="nc" id="L889">				Logging.errorPrint(&quot;Error saving character to new file &quot; + file, e); //$NON-NLS-1$</span>
<span class="nc" id="L890">				delegate.showErrorMessage(Constants.APPLICATION_NAME,</span>
<span class="nc" id="L891">					LanguageBundle.getFormattedString(&quot;in_saveFailMsg&quot;, file.getName())); //$NON-NLS-1$</span>
			}
		}
<span class="nc" id="L894">		return false;</span>
	}

	/**
	 * Revert the character to the previous save. If no previous save, open a
	 * new character tab.
	 * @param character The character being saved.
	 */
	public void revertCharacter(CharacterFacade character)
	{
<span class="nc bnc" id="L904" title="All 2 branches missed.">		if (character.isDirty())</span>
		{
<span class="nc" id="L906">			int ret =</span>
<span class="nc" id="L907">					JOptionPane.showConfirmDialog(this,</span>
<span class="nc" id="L908">						LanguageBundle.getFormattedString(&quot;in_revertPcChoice&quot;, character //$NON-NLS-1$</span>
<span class="nc" id="L909">						.getNameRef().get()), Constants.APPLICATION_NAME, JOptionPane.YES_NO_OPTION);</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">			if (ret == JOptionPane.YES_OPTION)</span>
			{
<span class="nc" id="L912">				CharacterManager.removeCharacter(character);</span>

<span class="nc bnc" id="L914" title="All 4 branches missed.">				if (character.getFileRef().get() != null &amp;&amp; character.getFileRef().get().exists())</span>
				{
<span class="nc" id="L916">					openCharacter(character.getFileRef().get(), currentDataSetRef.get());</span>
				}
				else
				{
<span class="nc" id="L920">					createNewCharacter(null);</span>
				}
			}
		}

<span class="nc" id="L925">	}</span>

	public void showOpenCharacterChooser()
	{
<span class="nc" id="L929">		GuiAssertions.assertIsNotJavaFXThread();</span>
<span class="nc" id="L930">		PropertyContext context = PCGenSettings.getInstance();</span>
<span class="nc" id="L931">		String path = lastCharacterPath;</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">		if (path == null)</span>
		{
<span class="nc" id="L934">			path = context.getProperty(PCGenSettings.PCG_SAVE_PATH);</span>
		}

<span class="nc" id="L937">		FileChooser fileChooser = new FileChooser();</span>
<span class="nc" id="L938">		fileChooser.setTitle(&quot;Open PCGen Character&quot;);</span>
<span class="nc" id="L939">		fileChooser.setInitialDirectory(new File(path));</span>

<span class="nc" id="L941">		FileChooser.ExtensionFilter extensionFilter = new FileChooser.ExtensionFilter(</span>
				&quot;character files only&quot;, '*' + Constants.EXTENSION_CHARACTER_FILE
		);
<span class="nc" id="L944">		fileChooser.getExtensionFilters().add(extensionFilter);</span>
<span class="nc" id="L945">		fileChooser.setSelectedExtensionFilter(extensionFilter);</span>

<span class="nc" id="L947">		File file = GuiUtility.runOnJavaFXThreadNow(() -&gt;</span>
<span class="nc" id="L948">				fileChooser.showOpenDialog(null));</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">		if (file != null)</span>
		{
<span class="nc" id="L951">			lastCharacterPath = file.getAbsoluteFile().getParent();</span>
<span class="nc" id="L952">			loadCharacterFromFile(file);</span>
		}
<span class="nc" id="L954">	}</span>

	void showOpenPartyChooser()
	{
<span class="nc" id="L958">		PropertyContext context = PCGenSettings.getInstance();</span>
<span class="nc" id="L959">		FileChooser fileChooser = new FileChooser();</span>
<span class="nc" id="L960">		fileChooser.setTitle(&quot;Open PCGen Party File&quot;);</span>
<span class="nc" id="L961">		fileChooser.setInitialDirectory(new File(context.getProperty(PCGenSettings.PCP_SAVE_PATH)));</span>

<span class="nc" id="L963">		FileChooser.ExtensionFilter extensionFilter = new FileChooser.ExtensionFilter(</span>
				&quot;party files only&quot;, &quot;*.pcp&quot;
		);
<span class="nc" id="L966">		fileChooser.getExtensionFilters().add(extensionFilter);</span>
<span class="nc" id="L967">		fileChooser.setSelectedExtensionFilter(extensionFilter);</span>

<span class="nc" id="L969">		File file = GuiUtility.runOnJavaFXThreadNow(() -&gt;</span>
<span class="nc" id="L970">				fileChooser.showOpenDialog(null));</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">		if (file != null)</span>
		{
<span class="nc" id="L973">			loadPartyFromFile(file);</span>
		}
<span class="nc" id="L975">	}</span>

	/**
	 * creates a new character and sets its file if possible
	 * then sets the character as the currently selected character
	 * @param file the File for this character
	 */
	public void createNewCharacter(File file)
	{
<span class="nc" id="L984">		GuiAssertions.assertIsSwingThread();</span>
<span class="nc" id="L985">		DataSetFacade data = getLoadedDataSetRef().get();</span>
<span class="nc" id="L986">		CharacterFacade character = CharacterManager.createNewCharacter(this, data);</span>
		//This is called before the we set it as the selected character so
		//the InfoTabbedPane can catch any character specific properties when
		//it is first displayed
<span class="nc bnc" id="L990" title="All 2 branches missed.">		if (file != null)</span>
		{
<span class="nc" id="L992">			character.setFile(file);</span>
		}
		//Because CharacterManager adds the new character to the character
		//list before it returns, it is not necessary to update the character
		//tabs since they will catch that event before the call to
		//setCharacter is called
<span class="nc" id="L998">		setCharacter(character);</span>
<span class="nc" id="L999">	}</span>

	/**
	 * Loads a character from a file. Any sources that are required for
	 * this character are loaded first, then the character is loaded
	 * from the file and a tab is opened for it.
	 * @param pcgFile a file specifying the character to be loaded
	 */
	public void loadCharacterFromFile(final File pcgFile)
	{
<span class="nc bnc" id="L1009" title="All 2 branches missed.">		if (!PCGFile.isPCGenCharacterFile(pcgFile))</span>
		{
<span class="nc" id="L1011">			this.showErrorMessage(LanguageBundle.getFormattedString(&quot;in_loadPcInvalid&quot;, pcgFile),</span>
<span class="nc" id="L1012">					LanguageBundle.getFormattedString(&quot;in_loadPcInvalid&quot;, pcgFile)	);</span>
<span class="nc" id="L1013">			return;</span>
		}
<span class="nc bnc" id="L1015" title="All 2 branches missed.">		if (!pcgFile.canRead())</span>
		{
<span class="nc" id="L1017">			this.showErrorMessage(LanguageBundle.getFormattedString(&quot;in_loadPcFailTtile&quot;),</span>
<span class="nc" id="L1018">					LanguageBundle.getFormattedString(&quot;in_loadPcNoRead&quot;, pcgFile)	);</span>
<span class="nc" id="L1019">			return;</span>
		}

<span class="nc" id="L1022">		SourceSelectionFacade sources = CharacterManager.getRequiredSourcesForCharacter(pcgFile, this);</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">		if (sources == null)</span>
		{
<span class="nc" id="L1025">			this.showErrorMessage(LanguageBundle.getFormattedString(&quot;in_loadPcNoSources&quot;, pcgFile),</span>
<span class="nc" id="L1026">					LanguageBundle.getString(&quot;in_loadPcFailTtile&quot;));</span>
		}
<span class="nc bnc" id="L1028" title="All 2 branches missed.">		else if (!sources.getCampaigns().isEmpty())</span>
		{
			// Check if the user has asked that sources not be loaded with the character
<span class="nc bnc" id="L1031" title="All 2 branches missed.">			boolean dontLoadSources = currentSourceSelection.get() != null</span>
<span class="nc bnc" id="L1032" title="All 2 branches missed.">				&amp;&amp; !PCGenSettings.OPTIONS_CONTEXT.initBoolean(PCGenSettings.OPTION_AUTOLOAD_SOURCES_WITH_PC, true);</span>
<span class="nc" id="L1033">			boolean sourcesSame = checkSourceEquality(sources, currentSourceSelection.get());</span>
<span class="nc" id="L1034">			boolean gameModesSame = checkGameModeEquality(sources, currentSourceSelection.get());</span>
<span class="nc bnc" id="L1035" title="All 6 branches missed.">			if (!dontLoadSources &amp;&amp; !sourcesSame &amp;&amp; gameModesSame)</span>
			{
<span class="nc" id="L1037">				Object[] btnNames = {LanguageBundle.getString(&quot;in_loadPcDiffSourcesLoaded&quot;),</span>
<span class="nc" id="L1038">					LanguageBundle.getString(&quot;in_loadPcDiffSourcesCharacter&quot;), LanguageBundle.getString(&quot;in_cancel&quot;)};</span>
<span class="nc" id="L1039">				int choice = JOptionPane.showOptionDialog(this,</span>
<span class="nc" id="L1040">					LanguageBundle.getFormattedString(&quot;in_loadPcDiffSources&quot;,</span>
<span class="nc" id="L1041">						getFormattedCampaigns(currentSourceSelection.get()), getFormattedCampaigns(sources)),</span>
<span class="nc" id="L1042">					LanguageBundle.getString(&quot;in_loadPcSourcesLoadTitle&quot;), JOptionPane.YES_NO_CANCEL_OPTION,</span>
					JOptionPane.QUESTION_MESSAGE, null, btnNames, null);
<span class="nc bnc" id="L1044" title="All 2 branches missed.">				if (choice == JOptionPane.CANCEL_OPTION)</span>
				{
<span class="nc" id="L1046">					return;</span>
				}
<span class="nc bnc" id="L1048" title="All 2 branches missed.">				if (choice == JOptionPane.YES_OPTION)</span>
				{
<span class="nc" id="L1050">					openCharacter(pcgFile, currentDataSetRef.get());</span>
<span class="nc" id="L1051">					return;</span>
				}
			}

<span class="nc bnc" id="L1055" title="All 2 branches missed.">			if (dontLoadSources)</span>
			{
<span class="nc bnc" id="L1057" title="All 2 branches missed.">				if (!checkSourceEquality(sources, currentSourceSelection.get()))</span>
				{
<span class="nc" id="L1059">					Logging.log(Logging.WARNING, &quot;Loading character with different sources. Character: &quot; + sources</span>
<span class="nc" id="L1060">						+ &quot; current: &quot; + currentSourceSelection.get());</span>
				}
<span class="nc" id="L1062">				openCharacter(pcgFile, currentDataSetRef.get());</span>
			}
<span class="nc bnc" id="L1064" title="All 2 branches missed.">			else if (loadSourceSelection(sources))</span>
			{
<span class="nc bnc" id="L1066" title="All 2 branches missed.">				if (sourceSelectionDialog == null)</span>
				{
<span class="nc" id="L1068">					sourceSelectionDialog = new SourceSelectionDialog(this, uiContext);</span>
				}
<span class="nc" id="L1070">				((SourceSelectionDialog) sourceSelectionDialog).setAdvancedSources(sources);</span>
<span class="nc" id="L1071">				currentSourceSelection.set(sources);</span>
<span class="nc" id="L1072">				loadSourcesThenCharacter(pcgFile);</span>
			}
			else
			{
<span class="nc" id="L1076">				JOptionPane.showMessageDialog(this, LanguageBundle.getString(&quot;in_loadPcIncompatSource&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1077">					LanguageBundle.getString(&quot;in_loadPcFailTtile&quot;), //$NON-NLS-1$</span>
					JOptionPane.ERROR_MESSAGE);
			}
<span class="nc" id="L1080">		}</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">		else if (currentDataSetRef.get() != null)</span>
		{
<span class="nc bnc" id="L1083" title="All 2 branches missed.">			if (showWarningConfirm(Constants.APPLICATION_NAME,</span>
<span class="nc" id="L1084">				LanguageBundle.getFormattedString(&quot;in_loadPcSourcesLoadQuery&quot;, //$NON-NLS-1$</span>
					pcgFile)))
			{
<span class="nc" id="L1087">				openCharacter(pcgFile, currentDataSetRef.get());</span>
			}
		}
		else
		{
			// No character sources and no sources loaded.
<span class="nc" id="L1093">			this.showErrorMessage(LanguageBundle.getFormattedString(&quot;in_loadPcNoSources&quot;, pcgFile),</span>
<span class="nc" id="L1094">					LanguageBundle.getString(&quot;in_loadPcFailTtile&quot;));</span>
		}
<span class="nc" id="L1096">	}</span>

	/**
	 * @param pcgFile the character's pcgFile
	 * @param reference data set reference
	 */
	private void openCharacter(final File pcgFile, final DataSetFacade reference)
	{
<span class="nc" id="L1104">		final String msg = LanguageBundle.getFormattedString(&quot;in_loadPcLoadingFile&quot;, pcgFile.getName());</span>
<span class="nc" id="L1105">		statusBar.startShowingProgress(msg, false);</span>
<span class="nc" id="L1106">		statusBar.getProgressBar().getModel().setRangeProperties(0, 1, 0, 2, false);</span>
<span class="nc" id="L1107">		statusBar.getProgressBar().setString(LanguageBundle.getString(&quot;in_loadPcOpening&quot;));</span>
<span class="nc" id="L1108">		SwingUtilities.invokeLater(() -&gt; {</span>

			try
			{
<span class="nc" id="L1112">				CharacterManager.openCharacter(pcgFile, PCGenFrame.this, reference);</span>
<span class="nc" id="L1113">				statusBar.getProgressBar().getModel().setRangeProperties(1, 1, 0, 2, false);</span>
			}
<span class="nc" id="L1115">			catch (Exception e)</span>
			{
<span class="nc" id="L1117">				Logging.errorPrint(&quot;Error loading character: &quot; + pcgFile.getName(), e);</span>
			}
			finally
			{
<span class="nc" id="L1121">				statusBar.endShowingProgress();</span>
			}
<span class="nc" id="L1123">		});</span>
<span class="nc" id="L1124">	}</span>

	private static String getFormattedCampaigns(SourceSelectionFacade sources)
	{
<span class="nc" id="L1128">		StringBuilder campList = new StringBuilder(100);</span>
<span class="nc" id="L1129">		campList.append(&quot;&lt;UL&gt;&quot;);</span>
<span class="nc" id="L1130">		int count = 1;</span>
<span class="nc" id="L1131">		final int maxListLen = 6;</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">		for (Campaign facade : sources.getCampaigns())</span>
		{
<span class="nc" id="L1134">			campList.append(&quot;&lt;li&gt;&quot;);</span>
<span class="nc bnc" id="L1135" title="All 4 branches missed.">			if (count &gt;= maxListLen &amp;&amp; sources.getCampaigns().getSize() &gt; maxListLen)</span>
			{
<span class="nc" id="L1137">				int numExtra = sources.getCampaigns().getSize() - maxListLen + 1;</span>
<span class="nc" id="L1138">				campList.append(</span>
<span class="nc" id="L1139">					LanguageBundle.getFormattedString(&quot;in_loadPcDiffSourcesExcessSources&quot;, String.valueOf(numExtra)));</span>
<span class="nc" id="L1140">				break;</span>
			}
<span class="nc" id="L1142">			campList.append(facade);</span>
<span class="nc" id="L1143">			campList.append(&quot;&lt;/li&gt;&quot;);</span>
<span class="nc" id="L1144">			count++;</span>
<span class="nc" id="L1145">		}</span>
<span class="nc" id="L1146">		campList.append(&quot;&lt;/UL&gt;&quot;);</span>
<span class="nc" id="L1147">		return campList.toString();</span>
	}

	/**
	 * Asynchronously load the sources required for a character and then load the character.
	 * @param pcgFile The character to be loaded.
	 */
	private void loadSourcesThenCharacter(final File pcgFile)
	{
<span class="nc" id="L1156">		new Thread(() -&gt; {</span>
			try
			{
<span class="nc" id="L1159">				sourceLoader.join();</span>
<span class="nc" id="L1160">				SwingUtilities.invokeAndWait(() -&gt; {</span>
<span class="nc" id="L1161">					final String msg =</span>
<span class="nc" id="L1162">							LanguageBundle.getFormattedString(&quot;in_loadPcLoadingFile&quot;, pcgFile.getName());</span>
<span class="nc" id="L1163">					statusBar.startShowingProgress(msg, false);</span>
<span class="nc" id="L1164">					statusBar.getProgressBar().getModel().setRangeProperties(0, 1, 0, 2, false);</span>
<span class="nc" id="L1165">					statusBar.getProgressBar().setString(LanguageBundle.getString(&quot;in_loadPcOpening&quot;));</span>
<span class="nc" id="L1166">				});</span>
<span class="nc" id="L1167">				SwingUtilities.invokeLater(() -&gt; {</span>
					try
					{
<span class="nc" id="L1170">						CharacterManager.openCharacter(pcgFile, PCGenFrame.this, currentDataSetRef.get());</span>
<span class="nc" id="L1171">						statusBar.getProgressBar().getModel().setRangeProperties(1, 1, 0, 2, false);</span>
					}
<span class="nc" id="L1173">					catch (Exception e)</span>
					{
<span class="nc" id="L1175">						Logging.errorPrint(&quot;Error loading character: &quot; + pcgFile.getName(), e);</span>
					}
					finally
					{
<span class="nc" id="L1179">						statusBar.endShowingProgress();</span>
					}
<span class="nc" id="L1181">				});</span>
			}
<span class="nc" id="L1183">			catch (InterruptedException ex)</span>
			{
				//Do nothing
			}
<span class="nc" id="L1187">			catch (InvocationTargetException e1)</span>
			{
<span class="nc" id="L1189">				Logging.errorPrint(&quot;Error showing progress bar.&quot;, e1);</span>
<span class="nc" id="L1190">			}</span>
<span class="nc" id="L1191">		}).start();</span>
<span class="nc" id="L1192">	}</span>

	public void loadPartyFromFile(final File pcpFile)
	{
<span class="nc bnc" id="L1196" title="All 2 branches missed.">		if (!PCGFile.isPCGenPartyFile(pcpFile))</span>
		{
<span class="nc" id="L1198">			this.showErrorMessage(LanguageBundle.getString(&quot;in_loadPartyFailTtile&quot;),</span>
<span class="nc" id="L1199">					LanguageBundle.getFormattedString(&quot;in_loadPartyInvalid&quot;, pcpFile)	);</span>
<span class="nc" id="L1200">			return;</span>
		}
<span class="nc bnc" id="L1202" title="All 2 branches missed.">		if (!pcpFile.canRead())</span>
		{
<span class="nc" id="L1204">			this.showErrorMessage(LanguageBundle.getString(&quot;in_loadPartyFailTtile&quot;),</span>
<span class="nc" id="L1205">					LanguageBundle.getFormattedString(&quot;in_loadPartyNoRead&quot;, pcpFile)	);</span>
<span class="nc" id="L1206">			return;</span>
		}
<span class="nc" id="L1208">		SourceSelectionFacade sources = CharacterManager.getRequiredSourcesForParty(pcpFile, this);</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">		if (sources == null)</span>
		{
<span class="nc" id="L1211">			this.showErrorMessage(LanguageBundle.getString(&quot;in_loadPartyFailTtile&quot;),</span>
<span class="nc" id="L1212">					LanguageBundle.getFormattedString(&quot;in_loadPartyNoSources&quot;, pcpFile)	);</span>
		}
<span class="nc bnc" id="L1214" title="All 2 branches missed.">		else if (!sources.getCampaigns().isEmpty())</span>
		{
			// Check if the user has asked that sources not be loaded with the character
<span class="nc bnc" id="L1217" title="All 2 branches missed.">			boolean dontLoadSources = currentSourceSelection.get() != null</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">				&amp;&amp; !PCGenSettings.OPTIONS_CONTEXT.initBoolean(PCGenSettings.OPTION_AUTOLOAD_SOURCES_WITH_PC, true);</span>
<span class="nc bnc" id="L1219" title="All 2 branches missed.">			if (dontLoadSources)</span>
			{
<span class="nc bnc" id="L1221" title="All 2 branches missed.">				if (!checkSourceEquality(sources, currentSourceSelection.get()))</span>
				{
<span class="nc" id="L1223">					Logging.log(Logging.WARNING, &quot;Loading party with different sources. Party: &quot; + sources</span>
<span class="nc" id="L1224">						+ &quot; current: &quot; + currentSourceSelection.get());</span>
				}
<span class="nc" id="L1226">				CharacterManager.openParty(pcpFile, PCGenFrame.this, currentDataSetRef.get());</span>
			}
<span class="nc bnc" id="L1228" title="All 2 branches missed.">			else if (loadSourceSelection(sources))</span>
			{
<span class="nc" id="L1230">				new Thread(() -&gt; {</span>
					try
					{
<span class="nc" id="L1233">						sourceLoader.join();</span>
<span class="nc" id="L1234">						SwingUtilities.invokeLater(() -&gt; CharacterManager.openParty(pcpFile, PCGenFrame.this, currentDataSetRef.get()));</span>
					}
<span class="nc" id="L1236">					catch (InterruptedException ex)</span>
					{
						//Do nothing
<span class="nc" id="L1239">					}</span>
<span class="nc" id="L1240">				}).start();</span>
			}
			else
			{
<span class="nc" id="L1244">				this.showErrorMessage(LanguageBundle.getString(&quot;in_loadPartyFailTtile&quot;),</span>
<span class="nc" id="L1245">						LanguageBundle.getString(&quot;in_loadPcIncompatSource&quot;)	);</span>
			}
		}
<span class="nc" id="L1248">	}</span>

	/**
	 * Set the frame's title based on the current character and source/game mode.
	 */
	private void updateTitle()
	{
<span class="nc" id="L1255">		StringBuilder title = new StringBuilder(100);</span>
		File characterFile;
<span class="nc" id="L1257">		String characterFileName = null;</span>
<span class="nc" id="L1258">		String sourceName = null;</span>
<span class="nc bnc" id="L1259" title="All 4 branches missed.">		if (currentCharacterRef != null &amp;&amp; currentCharacterRef.get() != null)</span>
		{
			// characterFileName The file name (without path) of the active character
			// sourceName The name of the source selection.

<span class="nc" id="L1264">			characterFile = currentCharacterRef.get().getFileRef().get();</span>
<span class="nc bnc" id="L1265" title="All 4 branches missed.">			if (characterFile == null || StringUtils.isEmpty(characterFile.getName()))</span>
			{
<span class="nc" id="L1267">				characterFileName = LanguageBundle.getString(&quot;in_unsaved_char&quot;); //$NON-NLS-1$</span>
			}
			else
			{
<span class="nc" id="L1271">				characterFileName = characterFile.getName();</span>
			}
		}
<span class="nc bnc" id="L1274" title="All 2 branches missed.">		if (currentSourceSelection.get() != null)</span>
		{
<span class="nc" id="L1276">			sourceName = currentSourceSelection.get().toString();</span>
		}

<span class="nc bnc" id="L1279" title="All 4 branches missed.">		if (characterFileName != null &amp;&amp; !characterFileName.isEmpty())</span>
		{
<span class="nc" id="L1281">			title.append(characterFileName);</span>
<span class="nc" id="L1282">			title.append(&quot; - &quot;);</span>
		}
<span class="nc bnc" id="L1284" title="All 4 branches missed.">		if (sourceName != null &amp;&amp; !sourceName.isEmpty())</span>
		{
<span class="nc" id="L1286">			title.append(sourceName);</span>
<span class="nc" id="L1287">			title.append(&quot; - &quot;);</span>
		}
<span class="nc" id="L1289">		title.append(&quot;PCGen v&quot;);</span>
<span class="nc" id="L1290">		title.append(PCGenPropBundle.getVersionNumber());</span>
<span class="nc" id="L1291">		setTitle(title.toString());</span>
<span class="nc" id="L1292">	}</span>

	/**
	 * display the tips of the day dialog to the user
	 */
	static void showTipsOfTheDay()
	{
<span class="nc" id="L1299">		var totd = new JFXPanelFromResource&lt;&gt;(</span>
				TipOfTheDayController.class,
				&quot;TipOfTheDay.fxml&quot;
		);
<span class="nc" id="L1303">		totd.showAsStage(LanguageBundle.getString(&quot;in_tod_title&quot;));</span>
<span class="nc" id="L1304">	}</span>

	/**
	 * display the source selection dialog to the user
	 */
	public void showSourceSelectionDialog()
	{
<span class="nc bnc" id="L1311" title="All 2 branches missed.">		if (sourceSelectionDialog == null)</span>
		{
<span class="nc" id="L1313">			sourceSelectionDialog = new SourceSelectionDialog(this, uiContext);</span>
		}
<span class="nc" id="L1315">		sourceSelectionDialog.setLocationRelativeTo(this);</span>
<span class="nc" id="L1316">		sourceSelectionDialog.setVisible(true);</span>
<span class="nc" id="L1317">	}</span>

	//TODO: This should be in a utility class.
	/**
	 * Builds a JPanel containing the supplied message, split at each new
	 * line and an optional checkbox, suitable for use in a showMessageDialog
	 * call. This is generally useful for showing messges which can turned
	 * off either in preferences or when they are displayed.
	 *
	 * @param message The message to be displayed.
	 * @param checkbox The optional checkbox to be added - may be null.
	 * @return JPanel A panel containing the message and the checkbox.
	 */
	public static JPanel buildMessageLabelPanel(String message, JCheckBox checkbox)
	{
<span class="nc" id="L1332">		JPanel panel = new JPanel();</span>
		JLabel label;
		String part;

<span class="nc" id="L1336">		panel.setLayout(new GridBagLayout());</span>

<span class="nc" id="L1338">		GridBagConstraints cons = new GridBagConstraints();</span>
<span class="nc" id="L1339">		cons.gridx = cons.gridy = 0;</span>
<span class="nc" id="L1340">		cons.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1341">		cons.gridheight = 1;</span>
<span class="nc" id="L1342">		cons.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L1343">		cons.insets = new Insets(0, 0, 3, 0);</span>
<span class="nc" id="L1344">		cons.weightx = 1;</span>
<span class="nc" id="L1345">		cons.weighty = 0;</span>
<span class="nc" id="L1346">		cons.fill = GridBagConstraints.NONE;</span>

<span class="nc" id="L1348">		int start = 0;</span>
		int sepPos;

		do
		{
<span class="nc" id="L1353">			sepPos = message.indexOf(&quot;\n&quot;, start); //$NON-NLS-1$</span>

<span class="nc bnc" id="L1355" title="All 2 branches missed.">			if (sepPos &gt;= 0)</span>
			{
<span class="nc" id="L1357">				part = message.substring(start, sepPos);</span>
<span class="nc" id="L1358">				start = sepPos + 1;</span>
			}
			else
			{
<span class="nc" id="L1362">				part = message.substring(start);</span>
<span class="nc" id="L1363">				start = -1;</span>
			}

<span class="nc" id="L1366">			label = new JLabel(part, SwingConstants.LEADING);</span>

<span class="nc" id="L1368">			panel.add(label, cons);</span>
<span class="nc" id="L1369">			cons.gridy++;</span>
		}
<span class="nc bnc" id="L1371" title="All 2 branches missed.">		while (start &gt;= 0);</span>

<span class="nc bnc" id="L1373" title="All 2 branches missed.">		if (checkbox != null)</span>
		{
<span class="nc" id="L1375">			label = new JLabel(&quot;&quot;, SwingConstants.LEADING); //$NON-NLS-1$</span>
<span class="nc" id="L1376">			panel.add(label, cons);</span>
<span class="nc" id="L1377">			cons.gridy++;</span>
<span class="nc" id="L1378">			panel.add(checkbox, cons);</span>
<span class="nc" id="L1379">			cons.gridy++;</span>
		}

<span class="nc" id="L1382">		return panel;</span>
	}

	@Override
	public Boolean maybeShowWarningConfirm(String title, String message, String checkBoxText,
		final PropertyContext context, final String contextProp)
	{
<span class="nc bnc" id="L1389" title="All 2 branches missed.">		if (!context.getBoolean(contextProp, true))</span>
		{
<span class="nc" id="L1391">			return null;</span>
		}
<span class="nc" id="L1393">		final JCheckBox checkBox = new JCheckBox(checkBoxText, true);</span>
<span class="nc" id="L1394">		checkBox.addItemListener(e -&gt; context.setBoolean(contextProp, checkBox.isSelected()));</span>
<span class="nc" id="L1395">		JPanel panel = buildMessageLabelPanel(message, checkBox);</span>
<span class="nc" id="L1396">		int ret = JOptionPane.showConfirmDialog(this, panel, title, JOptionPane.YES_NO_OPTION,</span>
			JOptionPane.WARNING_MESSAGE);
<span class="nc bnc" id="L1398" title="All 2 branches missed.">		return ret == JOptionPane.YES_OPTION;</span>
	}

	@Override
	public boolean showWarningConfirm(String title, String message)
	{
<span class="nc" id="L1404">		Alert alert = GuiUtility.runOnJavaFXThreadNow(() -&gt; new Alert(Alert.AlertType.CONFIRMATION));</span>
<span class="nc" id="L1405">		alert.setTitle(title);</span>
<span class="nc" id="L1406">		alert.setContentText(message);</span>
<span class="nc" id="L1407">		Optional&lt;ButtonType&gt; buttonType = GuiUtility.runOnJavaFXThreadNow(alert::showAndWait);</span>
<span class="nc" id="L1408">		return buttonType.orElse(ButtonType.NO).equals(ButtonType.OK);</span>
	}

	private boolean showMessageConfirm(String title, String message)
	{
<span class="nc" id="L1413">		JComponent msgComp = new JLabel(message);</span>
<span class="nc" id="L1414">		int ret = JOptionPane.showConfirmDialog(this, msgComp, title, JOptionPane.YES_NO_OPTION);</span>
<span class="nc bnc" id="L1415" title="All 2 branches missed.">		return ret == JOptionPane.YES_OPTION;</span>
	}

	@Override
	public void showErrorMessage(String title, String message)
	{
<span class="nc" id="L1421">		GuiAssertions.assertIsNotJavaFXThread();</span>
<span class="nc" id="L1422">		Alert alert = GuiUtility.runOnJavaFXThreadNow(() -&gt; new Alert(Alert.AlertType.ERROR));</span>
<span class="nc" id="L1423">		alert.setTitle(title);</span>
<span class="nc" id="L1424">		alert.setContentText(message);</span>
<span class="nc" id="L1425">		GuiUtility.runOnJavaFXThreadNow(alert::showAndWait);</span>
<span class="nc" id="L1426">	}</span>

	@Override
	public void showInfoMessage(String title, String message)
	{
<span class="nc" id="L1431">		GuiAssertions.assertIsNotJavaFXThread();</span>
<span class="nc" id="L1432">		Alert alert = GuiUtility.runOnJavaFXThreadNow(() -&gt; new Alert(Alert.AlertType.INFORMATION));</span>
<span class="nc" id="L1433">		alert.setTitle(title);</span>
<span class="nc" id="L1434">		alert.setContentText(message);</span>
<span class="nc" id="L1435">		GuiUtility.runOnJavaFXThreadNow(alert::showAndWait);</span>
<span class="nc" id="L1436">	}</span>

	@Override
	public void showWarningMessage(String title, String message)
	{
<span class="nc" id="L1441">		GuiAssertions.assertIsNotJavaFXThread();</span>
<span class="nc" id="L1442">		Alert alert = GuiUtility.runOnJavaFXThreadNow(() -&gt; new Alert(Alert.AlertType.WARNING));</span>
<span class="nc" id="L1443">		alert.setTitle(title);</span>
<span class="nc" id="L1444">		alert.setContentText(message);</span>
<span class="nc" id="L1445">		GuiUtility.runOnJavaFXThreadNow(alert::showAndWait);</span>
<span class="nc" id="L1446">	}</span>

	@Override
	public Optional&lt;String&gt; showInputDialog(String title, String message, String initialValue)
	{
<span class="nc" id="L1451">		GuiAssertions.assertIsNotJavaFXThread();</span>
<span class="nc" id="L1452">		TextInputDialog dialog = GuiUtility.runOnJavaFXThreadNow(() -&gt; new TextInputDialog(initialValue));</span>
<span class="nc" id="L1453">		dialog.setTitle(title);</span>
<span class="nc" id="L1454">		dialog.setContentText(message);</span>
<span class="nc" id="L1455">		return GuiUtility.runOnJavaFXThreadNow(dialog::showAndWait);</span>
	}

	@Override
	public void showLevelUpInfo(CharacterFacade character, int oldLevel)
	{
<span class="nc" id="L1461">		PostLevelUpDialog.showPostLevelUpDialog(this, character, oldLevel);</span>
<span class="nc" id="L1462">	}</span>

	@Override
	public boolean showGeneralChooser(ChooserFacade chooserFacade)
	{
		// Check for an override of the chooser to be used
<span class="nc" id="L1468">		Optional&lt;RandomChooser&gt; choiceHandler = ChooserFactory.getChoiceHandler();</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">		if (choiceHandler.isPresent())</span>
		{
<span class="nc" id="L1471">			return choiceHandler.get().makeChoice(chooserFacade);</span>
		}

<span class="nc bnc" id="L1474" title="All 4 branches missed.">		if (chooserFacade.isPreferRadioSelection() &amp;&amp; chooserFacade.getRemainingSelections().get() == 1)</span>
		{
<span class="nc" id="L1476">			RadioChooserDialog dialog = new RadioChooserDialog(this, chooserFacade);</span>
<span class="nc" id="L1477">			dialog.setLocationRelativeTo(this);</span>
<span class="nc" id="L1478">			dialog.setVisible(true);</span>
<span class="nc" id="L1479">			return dialog.isCommitted();</span>
		}
		else
		{
<span class="nc" id="L1483">			ChooserDialog dialog = new ChooserDialog(this, chooserFacade);</span>
<span class="nc" id="L1484">			dialog.setLocationRelativeTo(this);</span>
<span class="nc" id="L1485">			dialog.setVisible(true);</span>
<span class="nc" id="L1486">			return dialog.isCommitted();</span>
		}
	}

	/*
	 * This thread does all work of loading sources that the user
	 * has selected. After the sources are loaded the thread then
	 * displays the licenses for the data.
	 */
	private class SourceLoadWorker extends Thread
	{

		private final SourceSelectionFacade sources;
		private final SourceFileLoader loader;
		private final SwingWorker&lt;List&lt;LogRecord&gt;, List&lt;LogRecord&gt;&gt; worker;

		public SourceLoadWorker(SourceSelectionFacade sources, UIDelegate delegate)
<span class="nc" id="L1503">		{</span>
<span class="nc" id="L1504">			this.sources = sources;</span>
<span class="nc" id="L1505">			loader = new SourceFileLoader(delegate, sources.getCampaigns(), sources.getGameMode().get().getName());</span>
<span class="nc" id="L1506">			worker = statusBar.createWorker(LanguageBundle.getString(&quot;in_taskLoadSources&quot;), loader); //$NON-NLS-1$</span>
<span class="nc" id="L1507">		}</span>

		@Override
		public void run()
		{
<span class="nc" id="L1512">			worker.execute();</span>
			//wait until the worker finish and post any errors that occurred
			try
			{
<span class="nc" id="L1516">				statusBar.setSourceLoadErrors(worker.get());</span>
<span class="nc" id="L1517">			} catch (InterruptedException | ExecutionException e)</span>
			{
<span class="nc" id="L1519">				Logging.errorPrint(&quot;error when loading sources&quot;, e);</span>
<span class="nc" id="L1520">			}</span>
			//now that the SourceFileLoader has finished
			//handle licenses and whatnot
<span class="nc" id="L1523">			section15 = &quot; &quot;</span>
<span class="nc" id="L1524">					+ readTextFromFile(</span>
<span class="nc" id="L1525">					ConfigurationSettings.getSystemsDir() + File.separator + &quot;opengaminglicense.10a.txt&quot;)</span>
<span class="nc" id="L1526">					+ loader.getOGL();</span>
			try
			{
<span class="nc" id="L1529">				showLicenses();</span>
			}
<span class="nc" id="L1531">			catch (Throwable e)</span>
			{
<span class="nc" id="L1533">				Logging.errorPrint(&quot;Failed to show licences.&quot;, e);</span>
<span class="nc" id="L1534">			}</span>

<span class="nc" id="L1536">			DataSetFacade data = loader.getDataSetFacade();</span>
<span class="nc bnc" id="L1537" title="All 2 branches missed.">			if (data != null)</span>
			{
<span class="nc" id="L1539">				currentSourceSelection.set(sources);</span>

<span class="nc" id="L1541">				StringBuilder sourceString = new StringBuilder(100);</span>
<span class="nc" id="L1542">				ListFacade&lt;Campaign&gt; campaigns = sources.getCampaigns();</span>
<span class="nc bnc" id="L1543" title="All 2 branches missed.">				for (int i = 0; i &lt; campaigns.getSize(); i++)</span>
				{
<span class="nc bnc" id="L1545" title="All 2 branches missed.">					if (i &gt; 0)</span>
					{
<span class="nc" id="L1547">						sourceString.append('|');</span>
					}
<span class="nc" id="L1549">					sourceString.append(campaigns.getElementAt(i));</span>
				}
<span class="nc" id="L1551">				PCGenSettings.getInstance().setProperty(PCGenSettings.LAST_LOADED_GAME,</span>
<span class="nc" id="L1552">					sources.getGameMode().toString());</span>
<span class="nc" id="L1553">				PCGenSettings.getInstance().setProperty(PCGenSettings.LAST_LOADED_SOURCES, sourceString.toString());</span>
<span class="nc" id="L1554">			}</span>
			else
			{
<span class="nc" id="L1557">				currentSourceSelection.set(null);</span>
			}
<span class="nc" id="L1559">			currentDataSetRef.set(data);</span>
<span class="nc" id="L1560">			updateTitle();</span>
<span class="nc" id="L1561">		}</span>

		private void showLicenses()
		{
<span class="nc" id="L1565">			PropertyContext context = PCGenSettings.OPTIONS_CONTEXT;</span>
<span class="nc bnc" id="L1566" title="All 2 branches missed.">			if (context.initBoolean(PCGenSettings.OPTION_SHOW_LICENSE, true))</span>
			{
<span class="nc bnc" id="L1568" title="All 2 branches missed.">				if (loader.hasOGLCampaign())</span>
				{
<span class="nc" id="L1570">					showOGLDialog();</span>
				}
<span class="nc bnc" id="L1572" title="All 2 branches missed.">				if (loader.hasLicensedCampaign())</span>
				{
<span class="nc" id="L1574">					String licenses = loader.getLicenses();</span>
<span class="nc bnc" id="L1575" title="All 2 branches missed.">					if (!licenses.trim().isEmpty())</span>
					{
<span class="nc" id="L1577">						showLicenseDialog(LanguageBundle.getString(&quot;in_specialLicenses&quot;), licenses); //$NON-NLS-1$</span>
					}
<span class="nc bnc" id="L1579" title="All 2 branches missed.">					for (String license : loader.getOtherLicenses())</span>
					{
<span class="nc" id="L1581">						showLicenseDialog(LanguageBundle.getString(&quot;in_specialLicenses&quot;), license); //$NON-NLS-1$</span>
<span class="nc" id="L1582">					}</span>

				}
			}
<span class="nc bnc" id="L1586" title="All 4 branches missed.">			if (loader.hasMatureCampaign() &amp;&amp; context.initBoolean(PCGenSettings.OPTION_SHOW_MATURE_ON_LOAD, true))</span>
			{
<span class="nc" id="L1588">				showMatureDialog(loader.getMatureInfo());</span>
			}
<span class="nc" id="L1590">		}</span>

	}

	void showOGLDialog()
	{
<span class="nc" id="L1596">		showLicenseDialog(LanguageBundle.getString(&quot;in_oglTitle&quot;), section15); //$NON-NLS-1$</span>
<span class="nc" id="L1597">	}</span>

	private static void showLicenseDialog(String title, String htmlString)
	{
<span class="nc" id="L1601">		GuiAssertions.assertIsNotJavaFXThread();</span>
<span class="nc bnc" id="L1602" title="All 2 branches missed.">		if (htmlString == null)</span>
		{
<span class="nc" id="L1604">			htmlString = LanguageBundle.getString(&quot;in_licNoInfo&quot;); //$NON-NLS-1$</span>
		}
<span class="nc" id="L1606">		Alert alert = RememberingChoiceDialog.create(</span>
				title,
				&quot;&quot;,
				htmlString,
				&quot;in_licShowOnLoad&quot;,
				PCGenSettings.OPTIONS_CONTEXT,
				PCGenSettings.OPTION_SHOW_LICENSE
				);
<span class="nc" id="L1614">		GuiUtility.runOnJavaFXThreadNow(alert::showAndWait);</span>
<span class="nc" id="L1615">	}</span>

	private static void showMatureDialog(final String text)
	{
<span class="nc" id="L1619">		Logging.log(Logging.WARNING, &quot;The following datasets contains mature themes. User discretion is advised.&quot;);</span>
<span class="nc" id="L1620">		Logging.log(Logging.WARNING, text);</span>
		// todo: combine into a single l18n string
<span class="nc" id="L1622">		String matureWarning = LanguageBundle.getString(&quot;in_matureWarningLine1&quot;)</span>
				+ '\n'
<span class="nc" id="L1624">				+ LanguageBundle.getString(&quot;in_matureWarningLine2&quot;);</span>
<span class="nc" id="L1625">		Alert alert = RememberingChoiceDialog.create(</span>
<span class="nc" id="L1626">				LanguageBundle.getString(&quot;in_matureTitle&quot;),</span>
				matureWarning,
				text,
				&quot;in_Prefs_displayMature&quot;,
				PCGenSettings.OPTIONS_CONTEXT,
				PCGenSettings.OPTION_SHOW_MATURE_ON_LOAD
		);
<span class="nc" id="L1633">		GuiUtility.runOnJavaFXThreadNow(alert::showAndWait);</span>
<span class="nc" id="L1634">	}</span>

	void showAboutDialog()
	{
<span class="nc" id="L1638">		Platform.runLater(javaFXAboutDialog::show);</span>
<span class="nc" id="L1639">	}</span>

	@Override
	public CustomEquipResult showCustomEquipDialog(CharacterFacade character, EquipmentBuilderFacade equipBuilder)
	{
<span class="nc" id="L1644">		EquipCustomizerDialog eqDialog = new EquipCustomizerDialog(this, character, equipBuilder);</span>
<span class="nc" id="L1645">		eqDialog.setLocationRelativeTo(this);</span>
<span class="nc" id="L1646">		eqDialog.setVisible(true);</span>
<span class="nc bnc" id="L1647" title="All 2 branches missed.">		return eqDialog.isCancelled() ? CustomEquipResult.CANCELLED</span>
<span class="nc bnc" id="L1648" title="All 2 branches missed.">			: eqDialog.isPurchase() ? CustomEquipResult.PURCHASE : CustomEquipResult.OK;</span>
	}

	@Override
	public boolean showCustomSpellDialog(SpellBuilderFacade spellBuilderFI)
	{
<span class="nc" id="L1654">		SpellChoiceDialog spellDialog = new SpellChoiceDialog(this, spellBuilderFI);</span>
<span class="nc" id="L1655">		spellDialog.setLocationRelativeTo(this);</span>
<span class="nc" id="L1656">		spellDialog.setVisible(true);</span>
<span class="nc bnc" id="L1657" title="All 2 branches missed.">		return !spellDialog.isCancelled();</span>
	}

	private static String readTextFromFile(String fileName)
	{
		try
		{
<span class="nc" id="L1664">			return Files.readString(Paths.get(fileName));</span>
<span class="nc" id="L1665">		} catch (IOException e)</span>
		{
<span class="nc" id="L1667">			Logging.errorPrint(&quot;Could not read license at &quot; + fileName, e);</span>
<span class="nc" id="L1668">			return LanguageBundle.getString(&quot;in_licNoInfo&quot;); //$NON-NLS-1$</span>
		}
	}

	/**
	 * The Class {@code FilenameListener} is used to update the frame title each time the
	 * current character's file name is changed.
	 */
<span class="nc" id="L1676">	class FilenameListener implements ReferenceListener&lt;File&gt;</span>
	{
		@Override
		public void referenceChanged(ReferenceEvent&lt;File&gt; e)
		{
<span class="nc" id="L1681">			PCGenFrame.this.updateTitle();</span>
<span class="nc" id="L1682">		}</span>

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>