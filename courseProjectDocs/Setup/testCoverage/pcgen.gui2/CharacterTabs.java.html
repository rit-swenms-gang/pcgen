<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CharacterTabs.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2</a> &gt; <span class="el_source">CharacterTabs.java</span></div><h1>CharacterTabs.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2009 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 * 
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 * 
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 * 
 */
package pcgen.gui2;

import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseEvent;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.swing.BorderFactory;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;
import javax.swing.SwingConstants;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;

import pcgen.facade.core.CharacterFacade;
import pcgen.facade.util.ReferenceFacade;
import pcgen.facade.util.event.ListEvent;
import pcgen.facade.util.event.ListListener;
import pcgen.facade.util.event.ReferenceEvent;
import pcgen.facade.util.event.ReferenceListener;
import pcgen.gui2.tabs.InfoTabbedPane;
import pcgen.gui2.tools.Icons;
import pcgen.gui2.util.SharedTabPane;
import pcgen.gui2.util.event.PopupMouseAdapter;
import pcgen.system.CharacterManager;

import org.apache.commons.lang3.StringUtils;

/**
 * This is the tabbed pane for PCGen characters. Unlike normal tabbed panes, the
 * CharacterTabs pane really only has a component single child component, the
 * InfoTabbedPane. The CharacterTabs pane is responsible for notifying both the
 * PCGenFrame and the InfoTabbedPane when a change in character selection
 * occurs.
 *
 * @see pcgen.gui2.PCGenFrame
 * @see pcgen.gui2.tabs.InfoTabbedPane
 */
public final class CharacterTabs extends SharedTabPane
		implements ChangeListener, ReferenceListener&lt;CharacterFacade&gt;, ListListener&lt;CharacterFacade&gt;
{

	private final PCGenFrame frame;
	//This holds the list of characters as well as the order in which they are displayed
	private final List&lt;CharacterFacade&gt; characters;
	private final Map&lt;CharacterFacade, TabLabel&gt; listenerMap;
	private final InfoTabbedPane infoTabbedPane;
	private final JPopupMenu popupMenu;

	public CharacterTabs(PCGenFrame frame)
<span class="nc" id="L78">	{</span>
<span class="nc" id="L79">		this.frame = frame;</span>
<span class="nc" id="L80">		this.characters = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L81">		this.infoTabbedPane = new InfoTabbedPane();</span>
<span class="nc" id="L82">		this.listenerMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L83">		this.popupMenu = new JPopupMenu();</span>
<span class="nc" id="L84">		initComponents();</span>
<span class="nc" id="L85">	}</span>

	private void initComponents()
	{
<span class="nc" id="L89">		CharacterManager.getCharacters().addListListener(this);</span>
<span class="nc" id="L90">		frame.getSelectedCharacterRef().addReferenceListener(this);</span>

<span class="nc" id="L92">		setTabPlacement(SwingConstants.BOTTOM);</span>
<span class="nc" id="L93">		addChangeListener(this);</span>
<span class="nc" id="L94">		setSharedComponent(infoTabbedPane);</span>
		//Initialize popup menu
<span class="nc" id="L96">		PCGenActionMap actions = frame.getActionMap();</span>
<span class="nc" id="L97">		popupMenu.add(actions.get(PCGenActionMap.NEW_COMMAND));</span>
<span class="nc" id="L98">		popupMenu.add(actions.get(PCGenActionMap.CLOSE_COMMAND));</span>
<span class="nc" id="L99">		popupMenu.add(actions.get(PCGenActionMap.SAVE_COMMAND));</span>
<span class="nc" id="L100">		popupMenu.add(actions.get(PCGenActionMap.SAVEAS_COMMAND));</span>
<span class="nc" id="L101">		addMouseListener(new PopupMouseAdapter()</span>
<span class="nc" id="L102">		{</span>
			@Override
			public void showPopup(final MouseEvent e)
			{
<span class="nc" id="L106">				popupMenu.setVisible(true);</span>
<span class="nc" id="L107">				popupMenu.show(e.getComponent(), e.getX(), e.getY() - popupMenu.getHeight());</span>
<span class="nc" id="L108">			}</span>
		});
<span class="nc" id="L110">	}</span>

	private void addCharacter(CharacterFacade character)
	{
<span class="nc" id="L114">		characters.add(character);</span>
<span class="nc" id="L115">		TabLabel tabLabel = new TabLabel(character);</span>
<span class="nc" id="L116">		addTab(tabLabel);</span>
<span class="nc" id="L117">		listenerMap.put(character, tabLabel);</span>
<span class="nc" id="L118">	}</span>

	private void removeCharacter(CharacterFacade character)
	{
<span class="nc" id="L122">		int index = characters.indexOf(character);</span>
<span class="nc" id="L123">		characters.remove(index);</span>
<span class="nc" id="L124">		removeTabAt(index);</span>
<span class="nc" id="L125">		listenerMap.remove(character).removeListeners();</span>
<span class="nc" id="L126">		infoTabbedPane.characterRemoved(character);</span>
<span class="nc" id="L127">	}</span>

	@Override
	public void referenceChanged(ReferenceEvent&lt;CharacterFacade&gt; e)
	{
<span class="nc" id="L132">		setSelectedIndex(characters.indexOf(e.getNewReference()));</span>
<span class="nc" id="L133">	}</span>

	@Override
	public void stateChanged(ChangeEvent e)
	{
<span class="nc" id="L138">		int index = getSelectedIndex();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">		CharacterFacade character = index != -1 ? characters.get(index) : null;</span>
<span class="nc" id="L140">		frame.setCharacter(character);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">		if (character != null)</span>
		{
<span class="nc" id="L143">			infoTabbedPane.setCharacter(character);</span>
		}
		else
		{
<span class="nc" id="L147">			infoTabbedPane.clearStateMap();</span>
		}
<span class="nc" id="L149">	}</span>

	@Override
	public void elementAdded(ListEvent&lt;CharacterFacade&gt; e)
	{
<span class="nc" id="L154">		addCharacter(e.getElement());</span>
<span class="nc" id="L155">	}</span>

	@Override
	public void elementRemoved(ListEvent&lt;CharacterFacade&gt; e)
	{
<span class="nc" id="L160">		removeCharacter(e.getElement());</span>
<span class="nc" id="L161">	}</span>

	@Override
	public void elementsChanged(ListEvent&lt;CharacterFacade&gt; e)
	{
<span class="nc" id="L166">		removeAll();</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">		for (CharacterFacade character : characters)</span>
		{
<span class="nc" id="L169">			listenerMap.remove(character).removeListeners();</span>
<span class="nc" id="L170">		}</span>
<span class="nc" id="L171">		characters.clear();</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">		for (CharacterFacade character : (Iterable&lt;CharacterFacade&gt;) e.getSource())</span>
		{
<span class="nc" id="L174">			addCharacter(character);</span>
<span class="nc" id="L175">		}</span>
<span class="nc" id="L176">		infoTabbedPane.clearStateMap();</span>
<span class="nc" id="L177">	}</span>

	@Override
	public void elementModified(ListEvent&lt;CharacterFacade&gt; e)
	{
<span class="nc" id="L182">	}</span>

	private class TabLabel extends JPanel implements ActionListener, ReferenceListener&lt;String&gt;
	{

		private JLabel titleLabel;
		private JButton closeButton;
		private final CharacterFacade character;
		private final ReferenceFacade&lt;String&gt; tabNameRef;
		private final ReferenceFacade&lt;String&gt; nameRef;

		public TabLabel(CharacterFacade character)
<span class="nc" id="L194">		{</span>
<span class="nc" id="L195">			super(new FlowLayout(FlowLayout.CENTER, 5, 2));</span>
<span class="nc" id="L196">			this.character = character;</span>
<span class="nc" id="L197">			this.tabNameRef = character.getTabNameRef();</span>
<span class="nc" id="L198">			this.nameRef = character.getNameRef();</span>

<span class="nc" id="L200">			initComponents();</span>

<span class="nc" id="L202">			closeButton.addActionListener(this);</span>
<span class="nc" id="L203">			tabNameRef.addReferenceListener(this);</span>
<span class="nc" id="L204">			nameRef.addReferenceListener(this);</span>
<span class="nc" id="L205">		}</span>

		private void initComponents()
		{
<span class="nc bnc" id="L209" title="All 2 branches missed.">			if (StringUtils.isNotEmpty(tabNameRef.get()))</span>
			{
<span class="nc" id="L211">				titleLabel = new JLabel(tabNameRef.get());</span>
			}
			else
			{
<span class="nc" id="L215">				titleLabel = new JLabel(nameRef.get());</span>
			}
<span class="nc" id="L217">			add(titleLabel);</span>

<span class="nc" id="L219">			closeButton = new JButton();</span>
<span class="nc" id="L220">			closeButton.setMargin(new Insets(0, 0, 0, 0));</span>
<span class="nc" id="L221">			closeButton.setBorder(BorderFactory.createEmptyBorder());</span>
<span class="nc" id="L222">			closeButton.setFocusable(false);</span>
<span class="nc" id="L223">			closeButton.setBorderPainted(false);</span>
<span class="nc" id="L224">			closeButton.setContentAreaFilled(false);</span>
<span class="nc" id="L225">			closeButton.setRolloverEnabled(true);</span>

<span class="nc" id="L227">			ImageIcon icon = Icons.XButton_Stat.getImageIcon();</span>
<span class="nc" id="L228">			Dimension size = new Dimension(icon.getIconWidth(), icon.getIconHeight());</span>
<span class="nc" id="L229">			Insets insets = closeButton.getInsets();</span>
<span class="nc" id="L230">			size.width += insets.left + insets.right;</span>
<span class="nc" id="L231">			size.height += insets.top + insets.bottom;</span>
<span class="nc" id="L232">			closeButton.setMinimumSize(size);</span>
<span class="nc" id="L233">			closeButton.setPreferredSize(size);</span>
<span class="nc" id="L234">			closeButton.setMaximumSize(size);</span>

<span class="nc" id="L236">			closeButton.setIcon(icon);</span>
<span class="nc" id="L237">			closeButton.setRolloverIcon(Icons.XButton_Roll.getImageIcon());</span>
<span class="nc" id="L238">			closeButton.setPressedIcon(Icons.XButton_Click.getImageIcon());</span>
<span class="nc" id="L239">			add(closeButton);</span>

<span class="nc" id="L241">			setOpaque(false);</span>
<span class="nc" id="L242">		}</span>

		public void removeListeners()
		{
<span class="nc" id="L246">			tabNameRef.removeReferenceListener(this);</span>
<span class="nc" id="L247">			nameRef.removeReferenceListener(this);</span>
<span class="nc" id="L248">		}</span>

		@Override
		public void referenceChanged(ReferenceEvent&lt;String&gt; e)
		{
<span class="nc bnc" id="L253" title="All 2 branches missed.">			if (e.getSource() == nameRef)</span>
			{
<span class="nc bnc" id="L255" title="All 2 branches missed.">				if (StringUtils.isEmpty(tabNameRef.get()))</span>
				{
<span class="nc" id="L257">					titleLabel.setText(e.getNewReference());</span>
				}
			}
			else
			{
<span class="nc bnc" id="L262" title="All 2 branches missed.">				if (StringUtils.isNotEmpty(e.getNewReference()))</span>
				{
<span class="nc" id="L264">					titleLabel.setText(e.getNewReference());</span>
				}
				else
				{
<span class="nc" id="L268">					titleLabel.setText(nameRef.get());</span>
				}
			}
<span class="nc" id="L271">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L276">			frame.closeCharacter(character);</span>
<span class="nc" id="L277">		}</span>

	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>