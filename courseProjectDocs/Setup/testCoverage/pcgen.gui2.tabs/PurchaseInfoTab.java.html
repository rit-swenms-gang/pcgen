<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PurchaseInfoTab.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.tabs</a> &gt; <span class="el_source">PurchaseInfoTab.java</span></div><h1>PurchaseInfoTab.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2011 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 * 
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 * 
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 * 
 */
package pcgen.gui2.tabs;

import static pcgen.gui2.tabs.equip.EquipmentSelection.EQUIPMENT_ARRAY_FLAVOR;

import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.datatransfer.Transferable;
import java.awt.datatransfer.UnsupportedFlavorException;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseEvent;
import java.io.IOException;
import java.math.BigDecimal;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

import javax.swing.AbstractAction;
import javax.swing.Box;
import javax.swing.DropMode;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JFormattedTextField;
import javax.swing.JLabel;
import javax.swing.JMenu;
import javax.swing.JMenuItem;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.JTree;
import javax.swing.SwingConstants;
import javax.swing.TransferHandler;
import javax.swing.border.EmptyBorder;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.tree.DefaultMutableTreeNode;

import pcgen.cdom.base.Constants;
import pcgen.core.Equipment;
import pcgen.facade.core.CharacterFacade;
import pcgen.facade.core.EquipmentFacade;
import pcgen.facade.core.EquipmentListFacade;
import pcgen.facade.core.EquipmentListFacade.EquipmentListEvent;
import pcgen.facade.core.EquipmentListFacade.EquipmentListListener;
import pcgen.facade.core.GearBuySellFacade;
import pcgen.facade.util.DefaultListFacade;
import pcgen.facade.util.ListFacade;
import pcgen.gui2.UIPropertyContext;
import pcgen.gui2.filter.FilterBar;
import pcgen.gui2.filter.FilterButton;
import pcgen.gui2.filter.FilteredTreeViewTable;
import pcgen.gui2.filter.SearchFilterPanel;
import pcgen.gui2.tabs.equip.EquipmentSelection;
import pcgen.gui2.tabs.models.BigDecimalFieldHandler;
import pcgen.gui2.tabs.models.CharacterComboBoxModel;
import pcgen.gui2.tabs.models.CharacterTreeCellRenderer;
import pcgen.gui2.tabs.models.CharacterTreeCellRenderer.Handler;
import pcgen.gui2.tools.FlippingSplitPane;
import pcgen.gui2.tools.Icons;
import pcgen.gui2.tools.InfoPane;
import pcgen.gui2.util.SignIcon;
import pcgen.gui2.util.SignIcon.Sign;
import pcgen.gui2.util.event.PopupMouseAdapter;
import pcgen.gui2.util.treeview.CachedDataView;
import pcgen.gui2.util.treeview.DataView;
import pcgen.gui2.util.treeview.DataViewColumn;
import pcgen.gui2.util.treeview.DefaultDataViewColumn;
import pcgen.gui2.util.treeview.TreeView;
import pcgen.gui2.util.treeview.TreeViewModel;
import pcgen.gui2.util.treeview.TreeViewPath;
import pcgen.gui3.utilty.ColorUtilty;
import pcgen.system.CharacterManager;
import pcgen.system.LanguageBundle;
import pcgen.util.enumeration.Tab;

/**
 * A character tab providing the user with the ability to buy and sell
 * equipment.
 */
@SuppressWarnings(&quot;serial&quot;)
public class PurchaseInfoTab extends FlippingSplitPane implements CharacterInfoTab
{

<span class="nc" id="L115">	private static final Set&lt;String&gt; PRIMARY_TYPES = new HashSet&lt;&gt;();</span>
	private final FilteredTreeViewTable&lt;CharacterFacade, EquipmentFacade&gt; availableTable;
	private final FilteredTreeViewTable&lt;CharacterFacade, EquipmentFacade&gt; purchasedTable;
	private final EquipmentRenderer equipmentRenderer;
	private final JCheckBox autoResizeBox;
	private final JButton addCustomButton;
	private final JButton addEquipmentButton;
	private final JButton sellEquipmentButton;
	private final JButton removeEquipmentButton;
	private final InfoPane infoPane;
	private final JFormattedTextField wealthLabel;
	private final JFormattedTextField goldField;
	private final JFormattedTextField goldModField;
	private final JComboBox buySellRateBox;
	private final JButton fundsAddButton;
	private final JButton fundsSubtractButton;
	private final JCheckBox allowDebt;
	private final List&lt;JLabel&gt; currencyLabels;

	/**
	 * Create a new instance of PurchaseInfoTab
	 */
	public PurchaseInfoTab()
<span class="nc" id="L138">	{</span>
<span class="nc" id="L139">		this.availableTable = new FilteredTreeViewTable&lt;&gt;();</span>
<span class="nc" id="L140">		this.purchasedTable = new FilteredTreeViewTable&lt;&gt;();</span>
<span class="nc" id="L141">		this.equipmentRenderer = new EquipmentRenderer();</span>
<span class="nc" id="L142">		this.autoResizeBox = new JCheckBox();</span>
<span class="nc" id="L143">		this.addCustomButton = new JButton();</span>
<span class="nc" id="L144">		this.addEquipmentButton = new JButton();</span>
<span class="nc" id="L145">		this.sellEquipmentButton = new JButton();</span>
<span class="nc" id="L146">		this.removeEquipmentButton = new JButton();</span>
<span class="nc" id="L147">		this.infoPane = new InfoPane();</span>
<span class="nc" id="L148">		this.wealthLabel = new JFormattedTextField(NumberFormat.getNumberInstance());</span>
<span class="nc" id="L149">		this.goldField = new JFormattedTextField(NumberFormat.getNumberInstance());</span>
<span class="nc" id="L150">		this.goldModField = new JFormattedTextField(NumberFormat.getNumberInstance());</span>
<span class="nc" id="L151">		this.buySellRateBox = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L152">		this.fundsAddButton = new JButton();</span>
<span class="nc" id="L153">		this.fundsSubtractButton = new JButton();</span>
<span class="nc" id="L154">		this.allowDebt = new JCheckBox();</span>
<span class="nc" id="L155">		this.currencyLabels = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L157">		initComponents();</span>
<span class="nc" id="L158">	}</span>

	private void initComponents()
	{
<span class="nc" id="L162">		setOrientation(VERTICAL_SPLIT);</span>
<span class="nc" id="L163">		FlippingSplitPane splitPane = new FlippingSplitPane(); //$NON-NLS-1$</span>
<span class="nc" id="L164">		splitPane.setOrientation(HORIZONTAL_SPLIT);</span>
		{ // Top Left panel
<span class="nc" id="L166">			FilterBar&lt;CharacterFacade, EquipmentFacade&gt; filterBar = new FilterBar&lt;&gt;();</span>
			{ // Filters
<span class="nc" id="L168">				filterBar.addDisplayableFilter(new SearchFilterPanel());</span>
<span class="nc" id="L169">				FilterButton&lt;CharacterFacade, EquipmentFacade&gt; premadeFilter =</span>
						new FilterButton&lt;&gt;(&quot;EqQualified&quot;); //$NON-NLS-1$
<span class="nc" id="L171">				premadeFilter.setText(LanguageBundle.getString(&quot;in_igQualFilter&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L172">				premadeFilter.setFilter(CharacterFacade::isQualifiedFor);</span>
<span class="nc" id="L173">				FilterButton&lt;CharacterFacade, EquipmentFacade&gt; customFilter =</span>
						new FilterButton&lt;&gt;(&quot;EqAffordable&quot;); //$NON-NLS-1$
<span class="nc" id="L175">				customFilter.setText(LanguageBundle.getString(&quot;in_igAffordFilter&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L176">				customFilter.setFilter((context, element) -&gt;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">						context.getInfoFactory().getCost(element) &lt;= context.getFundsRef().get().floatValue());</span>
<span class="nc" id="L178">				filterBar.addDisplayableFilter(premadeFilter);</span>
<span class="nc" id="L179">				filterBar.addDisplayableFilter(customFilter);</span>
			}
<span class="nc" id="L181">			JPanel panel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L182">			panel.add(filterBar, BorderLayout.NORTH);</span>

<span class="nc" id="L184">			availableTable.setTreeCellRenderer(equipmentRenderer);</span>
<span class="nc" id="L185">			availableTable.setDisplayableFilter(filterBar);</span>
<span class="nc" id="L186">			panel.add(new JScrollPane(availableTable), BorderLayout.CENTER);</span>

<span class="nc" id="L188">			Box box = Box.createHorizontalBox();</span>
<span class="nc" id="L189">			box.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L190">			box.add(autoResizeBox);</span>
<span class="nc" id="L191">			box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L192">			addCustomButton.setHorizontalTextPosition(SwingConstants.LEADING);</span>
<span class="nc" id="L193">			box.add(addCustomButton);</span>
<span class="nc" id="L194">			box.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L195">			addEquipmentButton.setHorizontalTextPosition(SwingConstants.LEADING);</span>
<span class="nc" id="L196">			box.add(addEquipmentButton);</span>
<span class="nc" id="L197">			box.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L198">			box.setBorder(new EmptyBorder(0, 0, 5, 0));</span>
<span class="nc" id="L199">			panel.add(box, BorderLayout.SOUTH);</span>
<span class="nc" id="L200">			splitPane.setLeftComponent(panel);</span>
		}
		{// Top Right panel
<span class="nc" id="L203">			FilterBar&lt;CharacterFacade, EquipmentFacade&gt; filterBar = new FilterBar&lt;&gt;();</span>
<span class="nc" id="L204">			filterBar.addDisplayableFilter(new SearchFilterPanel());</span>

<span class="nc" id="L206">			JPanel panel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L207">			panel.add(filterBar, BorderLayout.NORTH);</span>

<span class="nc" id="L209">			purchasedTable.setDisplayableFilter(filterBar);</span>
<span class="nc" id="L210">			purchasedTable.setTreeCellRenderer(equipmentRenderer);</span>
<span class="nc" id="L211">			panel.add(new JScrollPane(purchasedTable), BorderLayout.CENTER);</span>

<span class="nc" id="L213">			Box box = Box.createHorizontalBox();</span>
<span class="nc" id="L214">			box.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L215">			sellEquipmentButton.setToolTipText(LanguageBundle.getString(&quot;in_ieSellEq_Tooltip&quot;));</span>
<span class="nc" id="L216">			box.add(sellEquipmentButton);</span>
<span class="nc" id="L217">			removeEquipmentButton.setToolTipText(LanguageBundle.getString(&quot;in_ieRemEq_Tooltip&quot;));</span>
<span class="nc" id="L218">			box.add(removeEquipmentButton);</span>
<span class="nc" id="L219">			box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L220">			box.setBorder(new EmptyBorder(0, 0, 5, 0));</span>
<span class="nc" id="L221">			panel.add(box, BorderLayout.SOUTH);</span>
<span class="nc" id="L222">			splitPane.setRightComponent(panel);</span>
		}
<span class="nc" id="L224">		setTopComponent(splitPane);</span>
<span class="nc" id="L225">		splitPane = new FlippingSplitPane(); //$NON-NLS-1$</span>
<span class="nc" id="L226">		splitPane.setOrientation(HORIZONTAL_SPLIT);</span>
		{// Bottom Left Panel
<span class="nc" id="L228">			JPanel panel = new JPanel();</span>
<span class="nc" id="L229">			initMoneyPanel(panel);</span>
<span class="nc" id="L230">			splitPane.setLeftComponent(panel);</span>
		}
		{// Bottom Right Panel
<span class="nc" id="L233">			infoPane.setTitle(LanguageBundle.getString(&quot;in_igEqInfo&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L234">			splitPane.setRightComponent(infoPane);</span>
		}
<span class="nc" id="L236">		splitPane.setResizeWeight(0.25);</span>
<span class="nc" id="L237">		setResizeWeight(1);</span>
<span class="nc" id="L238">		setBottomComponent(splitPane);</span>
<span class="nc" id="L239">	}</span>

	/**
	 * Create the money panel laying out all components.
	 *
	 * @param panel The panel to be populated.
	 */
	private void initMoneyPanel(JPanel panel)
	{
<span class="nc" id="L248">		panel.setLayout(new GridBagLayout());</span>

<span class="nc" id="L250">		GridBagConstraints leftGbc = new GridBagConstraints();</span>
<span class="nc" id="L251">		Insets panelInsets = panel.getInsets();</span>
<span class="nc" id="L252">		leftGbc.insets = new Insets(2, panelInsets.left, 2, 10);</span>
<span class="nc" id="L253">		leftGbc.gridwidth = 2;</span>
<span class="nc" id="L254">		leftGbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L255">		leftGbc.anchor = GridBagConstraints.LINE_START;</span>

<span class="nc" id="L257">		GridBagConstraints middleGbc = new GridBagConstraints();</span>
<span class="nc" id="L258">		middleGbc.insets = new Insets(2, 5, 2, 5);</span>
<span class="nc" id="L259">		middleGbc.gridwidth = 1;</span>
<span class="nc" id="L260">		middleGbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L261">		middleGbc.anchor = GridBagConstraints.LINE_END;</span>

<span class="nc" id="L263">		GridBagConstraints rightGbc = new GridBagConstraints();</span>
<span class="nc" id="L264">		rightGbc.insets = new Insets(2, 10, 2, panelInsets.right);</span>
<span class="nc" id="L265">		rightGbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L266">		rightGbc.fill = GridBagConstraints.HORIZONTAL;</span>

<span class="nc" id="L268">		GridBagConstraints fullLineGbc = new GridBagConstraints();</span>
<span class="nc" id="L269">		fullLineGbc.insets = new Insets(2, panelInsets.left, 2, panelInsets.right);</span>
<span class="nc" id="L270">		fullLineGbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L271">		fullLineGbc.fill = GridBagConstraints.HORIZONTAL;</span>

<span class="nc" id="L273">		JLabel label = new JLabel(LanguageBundle.getString(&quot;in_igValueLabel&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L274">		panel.add(label, leftGbc);</span>
<span class="nc" id="L275">		wealthLabel.setEditable(false);</span>
<span class="nc" id="L276">		wealthLabel.setColumns(10);</span>
<span class="nc" id="L277">		wealthLabel.setHorizontalAlignment(SwingConstants.RIGHT);</span>
<span class="nc" id="L278">		panel.add(wealthLabel, middleGbc);</span>
<span class="nc" id="L279">		panel.add(createCurrencyLabel(), rightGbc);</span>

<span class="nc" id="L281">		label = new JLabel(LanguageBundle.getString(&quot;in_igFundsLabel&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L282">		panel.add(label, leftGbc);</span>
<span class="nc" id="L283">		goldField.setHorizontalAlignment(SwingConstants.RIGHT);</span>
<span class="nc" id="L284">		goldField.setColumns(10);</span>
<span class="nc" id="L285">		goldField.setMinimumSize(new Dimension(50, goldField.getPreferredSize().height));</span>
<span class="nc" id="L286">		panel.add(goldField, middleGbc);</span>
<span class="nc" id="L287">		panel.add(createCurrencyLabel(), rightGbc);</span>

<span class="nc" id="L289">		label = new JLabel(LanguageBundle.getString(&quot;in_igAddSubFundsLabel&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L290">		panel.add(label, fullLineGbc);</span>

<span class="nc" id="L292">		JPanel expmodPanel = new JPanel();</span>
		{
<span class="nc" id="L294">			GridBagConstraints gbc2 = new GridBagConstraints();</span>
<span class="nc" id="L295">			gbc2.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L296">			gbc2.weightx = 1.0;</span>
<span class="nc" id="L297">			gbc2.insets = new Insets(0, 1, 0, 1);</span>
<span class="nc" id="L298">			expmodPanel.add(fundsAddButton, gbc2);</span>
<span class="nc" id="L299">			expmodPanel.add(fundsSubtractButton, gbc2);</span>
		}
<span class="nc" id="L301">		panel.add(expmodPanel, leftGbc);</span>
<span class="nc" id="L302">		goldModField.setHorizontalAlignment(SwingConstants.RIGHT);</span>
<span class="nc" id="L303">		panel.add(goldModField, middleGbc);</span>
<span class="nc" id="L304">		panel.add(createCurrencyLabel(), rightGbc);</span>

<span class="nc" id="L306">		label = new JLabel(LanguageBundle.getString(&quot;in_igBuySellRateLabel&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L307">		fullLineGbc.insets = new Insets(10, 2, 2, 2);</span>
<span class="nc" id="L308">		panel.add(label, fullLineGbc);</span>
<span class="nc" id="L309">		buySellRateBox.setPrototypeDisplayValue(&quot;QuiteLongPrototypeDisplayValue&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L310">		fullLineGbc.insets = new Insets(2, 2, 2, 2);</span>
<span class="nc" id="L311">		panel.add(buySellRateBox, fullLineGbc);</span>

<span class="nc" id="L313">		panel.add(allowDebt, fullLineGbc);</span>

<span class="nc" id="L315">		fullLineGbc.weighty = 1.0f;</span>
<span class="nc" id="L316">		panel.add(new JLabel(), fullLineGbc);</span>
<span class="nc" id="L317">	}</span>

	/**
	 * Create a new label with the currency abbreviation.
	 *
	 * @return A new label
	 */
	private JLabel createCurrencyLabel()
	{
		JLabel label;
<span class="nc" id="L327">		label = new JLabel(&quot;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L328">		currencyLabels.add(label);</span>
<span class="nc" id="L329">		return label;</span>
	}

	@Override
	public ModelMap createModels(final CharacterFacade character)
	{
<span class="nc" id="L335">		ModelMap models = new ModelMap();</span>
<span class="nc" id="L336">		models.put(AvailableTreeViewModel.class, new AvailableTreeViewModel(character));</span>
<span class="nc" id="L337">		models.put(PurchasedTreeViewModel.class, new PurchasedTreeViewModel(character));</span>
<span class="nc" id="L338">		models.put(UseAutoResizeAction.class, new UseAutoResizeAction(character));</span>
<span class="nc" id="L339">		models.put(AddCustomAction.class, new AddCustomAction(character));</span>
<span class="nc" id="L340">		models.put(AddAction.class, new AddAction(character));</span>
<span class="nc" id="L341">		models.put(SellAction.class, new SellAction(character));</span>
<span class="nc" id="L342">		models.put(RemoveAction.class, new RemoveAction(character));</span>
<span class="nc" id="L343">		models.put(DeleteCustomAction.class, new DeleteCustomAction(character));</span>
<span class="nc" id="L344">		models.put(FundsAddAction.class, new FundsAddAction(character));</span>
<span class="nc" id="L345">		models.put(FundsSubtractAction.class, new FundsSubtractAction(character));</span>
<span class="nc" id="L346">		models.put(AllowDebtAction.class, new AllowDebtAction(character));</span>
<span class="nc" id="L347">		models.put(EquipInfoHandler.class, new EquipInfoHandler(character));</span>
<span class="nc" id="L348">		models.put(Handler.class, equipmentRenderer.createHandler(character));</span>
<span class="nc" id="L349">		models.put(EquipmentFilterHandler.class, new EquipmentFilterHandler(character));</span>
<span class="nc" id="L350">		models.put(EquipmentTransferHandler.class, new EquipmentTransferHandler(character));</span>
<span class="nc" id="L351">		models.put(CurrencyLabelHandler.class, new CurrencyLabelHandler(character));</span>
<span class="nc" id="L352">		models.put(BuyPopupMenuHandler.class, new BuyPopupMenuHandler(character));</span>
<span class="nc" id="L353">		models.put(SellPopupMenuHandler.class, new SellPopupMenuHandler(character));</span>

<span class="nc" id="L355">		models.put(CurrencyFieldHandler.class, new CurrencyFieldHandler(character));</span>

<span class="nc" id="L357">		CharacterComboBoxModel&lt;GearBuySellFacade&gt; buySellModel = new CharacterComboBoxModel&lt;&gt;(</span>
<span class="nc" id="L358">				character.getDataSet().getGearBuySellSchemes(), character.getGearBuySellRef())</span>
<span class="nc" id="L359">		{</span>

			@Override
			public void setSelectedItem(Object anItem)
			{
<span class="nc" id="L364">				character.setGearBuySellRef((GearBuySellFacade) anItem);</span>
<span class="nc" id="L365">			}</span>

		};
<span class="nc" id="L368">		models.put(CharacterComboBoxModel.class, buySellModel);</span>

<span class="nc" id="L370">		return models;</span>
	}

	@Override
	public void restoreModels(ModelMap models)
	{
<span class="nc" id="L376">		models.get(EquipmentFilterHandler.class).install();</span>
<span class="nc" id="L377">		models.get(Handler.class).install();</span>
<span class="nc" id="L378">		models.get(AvailableTreeViewModel.class).install();</span>
<span class="nc" id="L379">		purchasedTable.setTreeViewModel(models.get(PurchasedTreeViewModel.class));</span>
<span class="nc" id="L380">		autoResizeBox.setAction(models.get(UseAutoResizeAction.class));</span>
<span class="nc" id="L381">		addCustomButton.setAction(models.get(AddCustomAction.class));</span>
<span class="nc" id="L382">		addEquipmentButton.setAction(models.get(AddAction.class));</span>
<span class="nc" id="L383">		sellEquipmentButton.setAction(models.get(SellAction.class));</span>
<span class="nc" id="L384">		removeEquipmentButton.setAction(models.get(RemoveAction.class));</span>
<span class="nc" id="L385">		fundsAddButton.setAction(models.get(FundsAddAction.class));</span>
<span class="nc" id="L386">		fundsSubtractButton.setAction(models.get(FundsSubtractAction.class));</span>
<span class="nc" id="L387">		buySellRateBox.setModel(models.get(CharacterComboBoxModel.class));</span>
<span class="nc" id="L388">		allowDebt.setAction(models.get(AllowDebtAction.class));</span>

<span class="nc" id="L390">		models.get(EquipInfoHandler.class).install();</span>
<span class="nc" id="L391">		models.get(EquipmentTransferHandler.class).install();</span>
<span class="nc" id="L392">		models.get(UseAutoResizeAction.class).install();</span>
<span class="nc" id="L393">		models.get(AddAction.class).install();</span>
<span class="nc" id="L394">		models.get(SellAction.class).install();</span>
<span class="nc" id="L395">		models.get(RemoveAction.class).install();</span>
<span class="nc" id="L396">		models.get(CurrencyFieldHandler.class).install();</span>
<span class="nc" id="L397">		models.get(CurrencyLabelHandler.class).install();</span>
<span class="nc" id="L398">		models.get(BuyPopupMenuHandler.class).install();</span>
<span class="nc" id="L399">		models.get(SellPopupMenuHandler.class).install();</span>
<span class="nc" id="L400">		models.get(AllowDebtAction.class).install();</span>
<span class="nc" id="L401">	}</span>

	@Override
	public void storeModels(ModelMap models)
	{
<span class="nc" id="L406">		models.get(EquipInfoHandler.class).uninstall();</span>
<span class="nc" id="L407">		models.get(AddAction.class).uninstall();</span>
<span class="nc" id="L408">		models.get(SellAction.class).uninstall();</span>
<span class="nc" id="L409">		models.get(RemoveAction.class).uninstall();</span>
<span class="nc" id="L410">		models.get(CurrencyFieldHandler.class).uninstall();</span>
<span class="nc" id="L411">		models.get(BuyPopupMenuHandler.class).uninstall();</span>
<span class="nc" id="L412">		models.get(SellPopupMenuHandler.class).uninstall();</span>
<span class="nc" id="L413">		models.get(Handler.class).uninstall();</span>
<span class="nc" id="L414">	}</span>

	@Override
	public TabTitle getTabTitle()
	{
<span class="nc" id="L419">		return new TabTitle(Tab.PURCHASE);</span>
	}

	private static List&lt;EquipmentFacade&gt; getMenuTargets(JTable table, MouseEvent e)
	{
<span class="nc" id="L424">		int row = table.rowAtPoint(e.getPoint());</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">		if (!table.isRowSelected(row))</span>
		{
<span class="nc bnc" id="L427" title="All 4 branches missed.">			if ((row &gt;= 0) &amp;&amp; (table.getRowCount() &gt; row))</span>
			{
<span class="nc" id="L429">				table.setRowSelectionInterval(row, row);</span>
			}
		}
<span class="nc" id="L432">		return Arrays.stream(table.getSelectedRows())</span>
<span class="nc" id="L433">		             .mapToObj(selRow -&gt; table.getModel().getValueAt(selRow, 0))</span>
<span class="nc" id="L434">		             .filter(value -&gt; value instanceof EquipmentFacade)</span>
<span class="nc" id="L435">		             .map(value -&gt; (EquipmentFacade) value)</span>
<span class="nc" id="L436">		             .collect(Collectors.toList());</span>
	}

	private class CurrencyFieldHandler
	{

		private final BigDecimalFieldHandler fundsHandler;
		private final BigDecimalFieldHandler wealthHandler;

		public CurrencyFieldHandler(final CharacterFacade character)
<span class="nc" id="L446">		{</span>
			/**
			 * Handler for the Current Funds field. This listens for and
			 * processes both changes to the value from the character and
			 * modifications to the field made by the user.
			 */
<span class="nc" id="L452">			fundsHandler = new BigDecimalFieldHandler(goldField, character.getFundsRef())</span>
<span class="nc" id="L453">			{</span>

				@Override
				protected void valueChanged(BigDecimal value)
				{
<span class="nc" id="L458">					character.setFunds(value);</span>
<span class="nc" id="L459">					availableTable.refilter();</span>
<span class="nc" id="L460">				}</span>

			};
			/**
			 * Handler for theTotal Wealth field. This listens for and processes
			 * changes to the value from the character.
			 */
<span class="nc" id="L467">			wealthHandler = new BigDecimalFieldHandler(wealthLabel, character.getWealthRef())</span>
<span class="nc" id="L468">			{</span>

				@Override
				protected void valueChanged(BigDecimal value)
				{
					// Ignored for this read-only field
<span class="nc" id="L474">				}</span>

			};
<span class="nc" id="L477">		}</span>

		public void install()
		{
<span class="nc" id="L481">			fundsHandler.install();</span>
<span class="nc" id="L482">			wealthHandler.install();</span>
<span class="nc" id="L483">		}</span>

		public void uninstall()
		{
<span class="nc" id="L487">			fundsHandler.uninstall();</span>
<span class="nc" id="L488">			wealthHandler.uninstall();</span>
<span class="nc" id="L489">		}</span>
	}

	private class AddAction extends AbstractAction
	{

		private final CharacterFacade character;

		public AddAction(CharacterFacade character)
<span class="nc" id="L498">		{</span>
<span class="nc" id="L499">			super(LanguageBundle.getString(&quot;in_ieAddEq&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L500">			putValue(SMALL_ICON, Icons.Forward16.getImageIcon());</span>
<span class="nc" id="L501">			this.character = character;</span>
<span class="nc" id="L502">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L507">			List&lt;?&gt; data = availableTable.getSelectedData();</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">			if (data != null)</span>
			{
<span class="nc bnc" id="L510" title="All 2 branches missed.">				for (Object object : data)</span>
				{
<span class="nc bnc" id="L512" title="All 2 branches missed.">					if (object instanceof EquipmentFacade equip)</span>
					{
<span class="nc bnc" id="L514" title="All 2 branches missed.">						if (character.isAutoResize())</span>
						{
<span class="nc" id="L516">							equip = character.getEquipmentSizedForCharacter(equip);</span>
						}
<span class="nc" id="L518">						character.addPurchasedEquipment(equip, 1, false, false);</span>
					}
<span class="nc" id="L520">				}</span>
<span class="nc" id="L521">				availableTable.refilter();</span>
			}
<span class="nc" id="L523">		}</span>

		public void install()
		{
<span class="nc" id="L527">			availableTable.addActionListener(this);</span>
<span class="nc" id="L528">		}</span>

		public void uninstall()
		{
<span class="nc" id="L532">			availableTable.removeActionListener(this);</span>
<span class="nc" id="L533">		}</span>

	}

	private class AddCustomAction extends AbstractAction
	{

		private final CharacterFacade character;

		public AddCustomAction(CharacterFacade character)
<span class="nc" id="L543">		{</span>
<span class="nc" id="L544">			super(LanguageBundle.getString(&quot;in_igAddCustom&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L545">			putValue(SMALL_ICON, Icons.Forward16.getImageIcon());</span>
<span class="nc" id="L546">			this.character = character;</span>
<span class="nc" id="L547">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L552">			List&lt;?&gt; data = availableTable.getSelectedData();</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">			if (data != null)</span>
			{
<span class="nc bnc" id="L555" title="All 2 branches missed.">				for (Object object : data)</span>
				{
<span class="nc bnc" id="L557" title="All 2 branches missed.">					if (object instanceof EquipmentFacade equip)</span>
					{
<span class="nc bnc" id="L559" title="All 2 branches missed.">						if (character.isAutoResize())</span>
						{
<span class="nc" id="L561">							equip = character.getEquipmentSizedForCharacter(equip);</span>
						}
<span class="nc" id="L563">						character.addPurchasedEquipment(equip, 1, true, false);</span>
					}
<span class="nc" id="L565">				}</span>
			}
<span class="nc" id="L567">		}</span>

	}

	/**
	 * The Class {@code DeleteCustomAction} defines an action to delete a
	 * custom equipment item.
	 */
	private class DeleteCustomAction extends AbstractAction
	{

		private final CharacterFacade character;

		public DeleteCustomAction(CharacterFacade character)
<span class="nc" id="L581">		{</span>
<span class="nc" id="L582">			super(LanguageBundle.getString(&quot;in_igDeleteCustom&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L583">			this.character = character;</span>
<span class="nc" id="L584">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L589">			List&lt;?&gt; data = availableTable.getSelectedData();</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">			if (data != null)</span>
			{
<span class="nc bnc" id="L592" title="All 2 branches missed.">				for (Object object : data)</span>
				{
<span class="nc bnc" id="L594" title="All 2 branches missed.">					if (object instanceof EquipmentFacade equip)</span>
					{
<span class="nc" id="L596">						character.deleteCustomEquipment(equip);</span>
					}
<span class="nc" id="L598">				}</span>
			}
<span class="nc" id="L600">		}</span>

	}

	private class UseAutoResizeAction extends AbstractAction
	{

		private final CharacterFacade character;

		public UseAutoResizeAction(CharacterFacade character)
<span class="nc" id="L610">		{</span>
<span class="nc" id="L611">			super(LanguageBundle.getString(&quot;in_igAutoResize&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L612">			this.character = character;</span>
<span class="nc" id="L613">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L618">			character.setAutoResize(autoResizeBox.isSelected());</span>
<span class="nc" id="L619">		}</span>

		public void install()
		{
<span class="nc" id="L623">			autoResizeBox.setSelected(character.isAutoResize());</span>
<span class="nc" id="L624">		}</span>

	}

	private final class SellAction extends AbstractAction
	{

		private final CharacterFacade character;

		private SellAction(CharacterFacade character)
<span class="nc" id="L634">		{</span>
<span class="nc" id="L635">			super(LanguageBundle.getString(&quot;in_ieSellEq&quot;));</span>
<span class="nc" id="L636">			putValue(SMALL_ICON, Icons.Back16.getImageIcon());</span>
<span class="nc" id="L637">			this.character = character;</span>
<span class="nc" id="L638">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L643">			List&lt;?&gt; data = purchasedTable.getSelectedData();</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">			if (data != null)</span>
			{
<span class="nc bnc" id="L646" title="All 2 branches missed.">				for (Object object : data)</span>
				{
<span class="nc" id="L648">					character.removePurchasedEquipment((EquipmentFacade) object, 1, false);</span>
<span class="nc" id="L649">				}</span>
<span class="nc" id="L650">				availableTable.refilter();</span>
			}
<span class="nc" id="L652">		}</span>

		public void install()
		{
<span class="nc" id="L656">			purchasedTable.addActionListener(this);</span>
<span class="nc" id="L657">		}</span>

		public void uninstall()
		{
<span class="nc" id="L661">			purchasedTable.removeActionListener(this);</span>
<span class="nc" id="L662">		}</span>
	}

	private final class RemoveAction extends AbstractAction
	{

		private final CharacterFacade character;

		private RemoveAction(CharacterFacade character)
<span class="nc" id="L671">		{</span>
<span class="nc" id="L672">			super(LanguageBundle.getString(&quot;in_ieRemEq&quot;));</span>
<span class="nc" id="L673">			putValue(SMALL_ICON, Icons.Back16.getImageIcon());</span>
<span class="nc" id="L674">			this.character = character;</span>
<span class="nc" id="L675">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L680">			List&lt;?&gt; data = purchasedTable.getSelectedData();</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">			if (data != null)</span>
			{
<span class="nc" id="L683">				data.forEach(object -&gt; character.removePurchasedEquipment((EquipmentFacade) object, 1, true));</span>
<span class="nc" id="L684">				availableTable.refilter();</span>
			}
<span class="nc" id="L686">		}</span>

		public void install()
		{
<span class="nc" id="L690">			purchasedTable.addActionListener(this);</span>
<span class="nc" id="L691">		}</span>

		public void uninstall()
		{
<span class="nc" id="L695">			purchasedTable.removeActionListener(this);</span>
<span class="nc" id="L696">		}</span>
	}

	/**
	 * Handler for actions from the add funds button. Also defines the
	 * appearance of the button.
	 */
	private class FundsAddAction extends AbstractAction
	{

		private final CharacterFacade character;

		public FundsAddAction(CharacterFacade character)
<span class="nc" id="L709">		{</span>
<span class="nc" id="L710">			this.character = character;</span>
<span class="nc" id="L711">			putValue(SMALL_ICON, new SignIcon(Sign.Plus));</span>
<span class="nc" id="L712">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L717">			Object value = goldModField.getValue();</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">			if (value == null)</span>
			{
<span class="nc" id="L720">				return;</span>
			}
<span class="nc" id="L722">			BigDecimal modVal = BigDecimal.valueOf(((Number) value).doubleValue());</span>
<span class="nc" id="L723">			character.adjustFunds(modVal);</span>
<span class="nc" id="L724">		}</span>

	}

	/**
	 * Handler for actions from the subtract funds button. Also defines the
	 * appearance of the button.
	 */
	private class FundsSubtractAction extends AbstractAction
	{

		private final CharacterFacade character;

		public FundsSubtractAction(CharacterFacade character)
<span class="nc" id="L738">		{</span>
<span class="nc" id="L739">			this.character = character;</span>
<span class="nc" id="L740">			putValue(SMALL_ICON, new SignIcon(Sign.Minus));</span>
<span class="nc" id="L741">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L746">			Object value = goldModField.getValue();</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">			if (value == null)</span>
			{
<span class="nc" id="L749">				return;</span>
			}
<span class="nc" id="L751">			BigDecimal modVal = BigDecimal.valueOf(((Number) value).doubleValue() * -1);</span>
<span class="nc" id="L752">			character.adjustFunds(modVal);</span>
<span class="nc" id="L753">		}</span>

	}

	/**
	 * The Class {@code AllowDebtAction} links the allow debt checkbox to a
	 * character.
	 */
	private class AllowDebtAction extends AbstractAction
	{

		private final CharacterFacade character;

		public AllowDebtAction(CharacterFacade character)
<span class="nc" id="L767">		{</span>
<span class="nc" id="L768">			super(LanguageBundle.getString(&quot;in_igAllowDebt&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L769">			this.character = character;</span>
<span class="nc" id="L770">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L775">			character.setAllowDebt(allowDebt.isSelected());</span>
<span class="nc" id="L776">		}</span>

		public void install()
		{
<span class="nc" id="L780">			allowDebt.setSelected(character.isAllowDebt());</span>
<span class="nc" id="L781">		}</span>

	}

	private class EquipInfoHandler implements ListSelectionListener
	{

		private final CharacterFacade character;
		private String text;
		private List&lt;EquipmentFacade&gt; oldList;

		public EquipInfoHandler(CharacterFacade character)
<span class="nc" id="L793">		{</span>
<span class="nc" id="L794">			this.character = character;</span>
<span class="nc" id="L795">			this.text = &quot;&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L796">			oldList = null;</span>
<span class="nc" id="L797">		}</span>

		public void install()
		{
<span class="nc" id="L801">			availableTable.getSelectionModel().addListSelectionListener(this);</span>
<span class="nc" id="L802">			purchasedTable.getSelectionModel().addListSelectionListener(this);</span>
<span class="nc" id="L803">			infoPane.setText(text);</span>
<span class="nc" id="L804">		}</span>

		public void uninstall()
		{
<span class="nc" id="L808">			availableTable.getSelectionModel().removeListSelectionListener(this);</span>
<span class="nc" id="L809">			purchasedTable.getSelectionModel().removeListSelectionListener(this);</span>
<span class="nc" id="L810">		}</span>

		@Override
		public void valueChanged(ListSelectionEvent e)
		{
<span class="nc" id="L815">			JTable target = availableTable;</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">			if (purchasedTable.getSelectionModel().equals(e.getSource()))</span>
			{
<span class="nc" id="L818">				target = purchasedTable;</span>
			}
<span class="nc bnc" id="L820" title="All 2 branches missed.">			if (!e.getValueIsAdjusting())</span>
			{
<span class="nc" id="L822">				int[] selectedRows = target.getSelectedRows();</span>
<span class="nc" id="L823">				List&lt;EquipmentFacade&gt; newList = new ArrayList&lt;&gt;(selectedRows.length);</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">				for (int row : selectedRows)</span>
				{
<span class="nc bnc" id="L826" title="All 2 branches missed.">					if (row != -1)</span>
					{
<span class="nc" id="L828">						Object value = target.getModel().getValueAt(row, 0);</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">						if (value instanceof EquipmentFacade)</span>
						{
<span class="nc" id="L831">							newList.add((EquipmentFacade) value);</span>
						}
					}
				}
<span class="nc bnc" id="L835" title="All 4 branches missed.">				if (newList.isEmpty() || newList.equals(oldList))</span>
				{
<span class="nc" id="L837">					return;</span>
				}
<span class="nc" id="L839">				oldList = newList;</span>
<span class="nc" id="L840">				StringBuilder sb = new StringBuilder(2000);</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">				for (EquipmentFacade equip : newList)</span>
				{
<span class="nc" id="L843">					sb.append(character.getInfoFactory().getHTMLInfo(equip));</span>
<span class="nc" id="L844">				}</span>
<span class="nc" id="L845">				text = &quot;&lt;html&gt;&quot; + sb + &quot;&lt;/html&gt;&quot;; //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L846">				infoPane.setText(text);</span>
			}
<span class="nc" id="L848">		}</span>

	}

	/**
	 * The Class {@code CurrencyLabelHandler} manages the currently
	 * displayed currency.
	 */
	private class CurrencyLabelHandler
	{

		private final CharacterFacade character;

		public CurrencyLabelHandler(CharacterFacade character)
<span class="nc" id="L862">		{</span>
<span class="nc" id="L863">			this.character = character;</span>
<span class="nc" id="L864">		}</span>

		public void install()
		{
<span class="nc" id="L868">			String currencyDisplay = character.getDataSet().getGameMode().getCurrencyDisplay();</span>
<span class="nc bnc" id="L869" title="All 2 branches missed.">			for (JLabel label : currencyLabels)</span>
			{
<span class="nc" id="L871">				label.setText(currencyDisplay);</span>
<span class="nc" id="L872">			}</span>
<span class="nc" id="L873">		}</span>

	}

	private class AvailableTreeViewModel extends CachedDataView&lt;EquipmentFacade&gt;
			implements TreeViewModel&lt;EquipmentFacade&gt;, DataView&lt;EquipmentFacade&gt;
	{

<span class="nc" id="L881">		private final ListFacade&lt;? extends TreeView&lt;EquipmentFacade&gt;&gt; treeviews =</span>
<span class="nc" id="L882">				new DefaultListFacade&lt;&gt;(Arrays.asList(EquipmentTreeView.values()));</span>
<span class="nc" id="L883">		private final List&lt;DefaultDataViewColumn&gt; columns =</span>
<span class="nc" id="L884">				Arrays.asList(new DefaultDataViewColumn(&quot;in_igEqModelColCost&quot;, Float.class, true), //$NON-NLS-1$</span>
					new DefaultDataViewColumn(&quot;in_igEqModelColWeight&quot;, Float.class, true), //$NON-NLS-1$
					new DefaultDataViewColumn(&quot;in_descrip&quot;, String.class, false), //$NON-NLS-1$
					new DefaultDataViewColumn(&quot;in_igEqModelColSource&quot;, String.class, false)); //$NON-NLS-1$
		private final CharacterFacade character;
		private final ListFacade&lt;EquipmentFacade&gt; equipmentList;

		public AvailableTreeViewModel(CharacterFacade character)
<span class="nc" id="L892">		{</span>
<span class="nc" id="L893">			this.character = character;</span>
<span class="nc" id="L894">			this.equipmentList = character.getDataSet().getEquipment();</span>

<span class="nc bnc" id="L896" title="All 2 branches missed.">			if (PRIMARY_TYPES.isEmpty())</span>
			{
<span class="nc bnc" id="L898" title="All 2 branches missed.">				for (int i = 0; i &lt; equipmentList.getSize(); i++)</span>
				{
<span class="nc" id="L900">					EquipmentFacade eq = equipmentList.getElementAt(i);</span>
<span class="nc" id="L901">					List&lt;String&gt; types = eq.getTypesForDisplay();</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">					if (!types.isEmpty())</span>
					{
<span class="nc" id="L904">						PRIMARY_TYPES.add(types.get(0));</span>
					}
				}
			}
<span class="nc" id="L908">		}</span>

		@Override
		public ListFacade&lt;? extends TreeView&lt;EquipmentFacade&gt;&gt; getTreeViews()
		{
<span class="nc" id="L913">			return treeviews;</span>
		}

		@Override
		public int getDefaultTreeViewIndex()
		{
<span class="nc" id="L919">			return 2;</span>
		}

		@Override
		public DataView&lt;EquipmentFacade&gt; getDataView()
		{
<span class="nc" id="L925">			return this;</span>
		}

		@Override
		public ListFacade&lt;EquipmentFacade&gt; getDataModel()
		{
<span class="nc" id="L931">			return equipmentList;</span>
		}

		@Override
		public List&lt;? extends DataViewColumn&gt; getDataColumns()
		{
<span class="nc" id="L937">			return columns;</span>
		}

		@Override
		public String getPrefsKey()
		{
<span class="nc" id="L943">			return &quot;PurchaseAvail&quot;; //$NON-NLS-1$</span>
		}

		@Override
		public Object getDataInternal(EquipmentFacade obj, int column)
		{
<span class="nc bnc" id="L949" title="All 5 branches missed.">			return switch (column)</span>
					{
<span class="nc" id="L951">						case 0 -&gt; character.getInfoFactory().getCost(obj);</span>
<span class="nc" id="L952">						case 1 -&gt; character.getInfoFactory().getWeight(obj);</span>
<span class="nc" id="L953">						case 2 -&gt; character.getInfoFactory().getDescription(obj);</span>
<span class="nc" id="L954">						case 3 -&gt; obj.getSource();</span>
<span class="nc" id="L955">						default -&gt; null;</span>
					};
		}

		@Override
		public void setData(Object value, EquipmentFacade element, int column)
		{
<span class="nc" id="L962">		}</span>

		public void install()
		{
<span class="nc" id="L966">			availableTable.setTreeViewModel(this);</span>
<span class="nc" id="L967">		}</span>
	}

	private class PurchasedTreeViewModel
			implements TreeViewModel&lt;EquipmentFacade&gt;, DataView&lt;EquipmentFacade&gt;, EquipmentListListener
	{

<span class="nc" id="L974">		private final ListFacade&lt;? extends TreeView&lt;EquipmentFacade&gt;&gt; treeviews =</span>
<span class="nc" id="L975">				new DefaultListFacade&lt;&gt;(Arrays.asList(EquipmentTreeView.values()));</span>
<span class="nc" id="L976">		private final List&lt;DefaultDataViewColumn&gt; columns =</span>
<span class="nc" id="L977">				Arrays.asList(new DefaultDataViewColumn(&quot;in_igEqModelColCost&quot;, Float.class, true), //$NON-NLS-1$</span>
					new DefaultDataViewColumn(&quot;in_igEqModelColWeight&quot;, Float.class, false), //$NON-NLS-1$
					new DefaultDataViewColumn(&quot;in_igEqModelColQty&quot;, Integer.class, true), //$NON-NLS-1$
					new DefaultDataViewColumn(&quot;in_descrip&quot;, String.class, false)); //$NON-NLS-1$
		private final CharacterFacade character;
		private final EquipmentListFacade equipmentList;

		public PurchasedTreeViewModel(CharacterFacade character)
<span class="nc" id="L985">		{</span>
<span class="nc" id="L986">			this.character = character;</span>
<span class="nc" id="L987">			this.equipmentList = character.getPurchasedEquipment();</span>
<span class="nc" id="L988">			this.equipmentList.addEquipmentListListener(this);</span>
<span class="nc" id="L989">		}</span>

		@Override
		public ListFacade&lt;? extends TreeView&lt;EquipmentFacade&gt;&gt; getTreeViews()
		{
<span class="nc" id="L994">			return treeviews;</span>
		}

		@Override
		public int getDefaultTreeViewIndex()
		{
<span class="nc" id="L1000">			return 0;</span>
		}

		@Override
		public DataView&lt;EquipmentFacade&gt; getDataView()
		{
<span class="nc" id="L1006">			return this;</span>
		}

		@Override
		public ListFacade&lt;EquipmentFacade&gt; getDataModel()
		{
<span class="nc" id="L1012">			return equipmentList;</span>
		}

		@Override
		public Object getData(EquipmentFacade obj, int column)
		{
<span class="nc bnc" id="L1018" title="All 5 branches missed.">			return switch (column)</span>
					{
<span class="nc" id="L1020">						case 0 -&gt; character.getInfoFactory().getCost(obj);</span>
<span class="nc" id="L1021">						case 1 -&gt; character.getInfoFactory().getWeight(obj);</span>
<span class="nc" id="L1022">						case 2 -&gt; equipmentList.getQuantity(obj);</span>
<span class="nc" id="L1023">						case 3 -&gt; character.getInfoFactory().getDescription(obj);</span>
<span class="nc" id="L1024">						default -&gt; null;</span>
					};
		}

		@Override
		public void setData(Object value, EquipmentFacade element, int column)
		{
<span class="nc" id="L1031">		}</span>

		@Override
		public List&lt;? extends DataViewColumn&gt; getDataColumns()
		{
<span class="nc" id="L1036">			return columns;</span>
		}

		@Override
		public void quantityChanged(EquipmentListEvent equipment)
		{
<span class="nc" id="L1042">			purchasedTable.refreshModelData();</span>
<span class="nc" id="L1043">		}</span>

		@Override
		public String getPrefsKey()
		{
<span class="nc" id="L1048">			return &quot;Purchased&quot;; //$NON-NLS-1$</span>
		}

	}

<span class="nc" id="L1053">	private enum EquipmentTreeView implements TreeView&lt;EquipmentFacade&gt;</span>
	{

<span class="nc" id="L1056">		NAME(LanguageBundle.getString(&quot;in_nameLabel&quot;)), //$NON-NLS-1$</span>
<span class="nc" id="L1057">		TYPE_NAME(LanguageBundle.getString(&quot;in_typeName&quot;)), //$NON-NLS-1$</span>
<span class="nc" id="L1058">		TYPE_SUBTYPE_NAME(LanguageBundle.getString(&quot;in_typeSubtypeName&quot;)), //$NON-NLS-1$</span>
<span class="nc" id="L1059">		SOURCE_NAME(LanguageBundle.getString(&quot;in_sourceName&quot;)); //$NON-NLS-1$</span>
		private final String name;

		private EquipmentTreeView(String name)
<span class="nc" id="L1063">		{</span>
<span class="nc" id="L1064">			this.name = name;</span>
<span class="nc" id="L1065">		}</span>

		@Override
		public String getViewName()
		{
<span class="nc" id="L1070">			return name;</span>
		}

		@Override
		public List&lt;TreeViewPath&lt;EquipmentFacade&gt;&gt; getPaths(EquipmentFacade pobj)
		{
<span class="nc bnc" id="L1076" title="All 5 branches missed.">			switch (this)</span>
			{
				case TYPE_SUBTYPE_NAME:
<span class="nc" id="L1079">					List&lt;String&gt; types = pobj.getTypesForDisplay();</span>
<span class="nc bnc" id="L1080" title="All 4 branches missed.">					if (types != null &amp;&amp; types.size() &gt; 1)</span>
					{
<span class="nc" id="L1082">						List&lt;TreeViewPath&lt;EquipmentFacade&gt;&gt; paths = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">						for (String type : types)</span>
						{
<span class="nc bnc" id="L1085" title="All 2 branches missed.">							if (PRIMARY_TYPES.contains(type))</span>
							{
<span class="nc bnc" id="L1087" title="All 2 branches missed.">								for (String subType : types)</span>
								{
<span class="nc bnc" id="L1089" title="All 2 branches missed.">									if (!type.equals(subType))</span>
									{
<span class="nc" id="L1091">										paths.add(new TreeViewPath&lt;&gt;(pobj, type, subType));</span>
									}
<span class="nc" id="L1093">								}</span>
							}
<span class="nc" id="L1095">						}</span>
<span class="nc" id="L1096">						return paths;</span>
					}
					// Less then two types, fall through to treat it as a type tree.
				case TYPE_NAME:
<span class="nc" id="L1100">					types = pobj.getTypesForDisplay();</span>
<span class="nc bnc" id="L1101" title="All 4 branches missed.">					if (types != null &amp;&amp; !types.isEmpty())</span>
					{
<span class="nc" id="L1103">						List&lt;TreeViewPath&lt;EquipmentFacade&gt;&gt; paths = new ArrayList&lt;&gt;(types.size());</span>
<span class="nc bnc" id="L1104" title="All 2 branches missed.">						for (String type : types)</span>
						{
<span class="nc bnc" id="L1106" title="All 2 branches missed.">							if (PRIMARY_TYPES.contains(type))</span>
							{
<span class="nc" id="L1108">								paths.add(new TreeViewPath&lt;&gt;(pobj, type));</span>
							}
<span class="nc" id="L1110">						}</span>
<span class="nc" id="L1111">						return paths;</span>
					}
					// No types, fall through and treat it as just a name.
				case NAME:
<span class="nc" id="L1115">					return Collections.singletonList(new TreeViewPath&lt;&gt;(pobj));</span>
				case SOURCE_NAME:
<span class="nc" id="L1117">					return Collections.singletonList(new TreeViewPath&lt;&gt;(pobj, pobj.getSourceForNodeDisplay()));</span>
				default:
<span class="nc" id="L1119">					throw new InternalError();</span>
			}

		}

	}

	/**
	 * The Class {@code EquipmentRenderer} displays the tree cells of the
	 * available and purchased equipment tables.
	 */
	private static class EquipmentRenderer extends CharacterTreeCellRenderer
	{

		@Override
		public Component getTreeCellRendererComponent(JTree tree, Object value, boolean sel, boolean expanded,
			boolean leaf, int row, boolean focus)
		{

<span class="nc" id="L1138">			super.getTreeCellRendererComponent(tree, value, sel, expanded, leaf, row, focus);</span>
<span class="nc" id="L1139">			Object equipObj = ((DefaultMutableTreeNode) value).getUserObject();</span>
<span class="nc bnc" id="L1140" title="All 4 branches missed.">			if (equipObj instanceof EquipmentFacade &amp;&amp; !character.isQualifiedFor((EquipmentFacade) equipObj))</span>
			{
<span class="nc" id="L1142">				setForeground(ColorUtilty.colorToAWTColor(UIPropertyContext.getNotQualifiedColor()));</span>
			}
<span class="nc" id="L1144">			return this;</span>
		}

	}

	private class EquipmentFilterHandler
	{

		private final CharacterFacade character;

		public EquipmentFilterHandler(CharacterFacade character)
<span class="nc" id="L1155">		{</span>
<span class="nc" id="L1156">			this.character = character;</span>
<span class="nc" id="L1157">		}</span>

		public void install()
		{
<span class="nc" id="L1161">			availableTable.setContext(character);</span>
<span class="nc" id="L1162">		}</span>

	}

	private class EquipmentTransferHandler extends TransferHandler
	{

		private final CharacterFacade character;

		public EquipmentTransferHandler(CharacterFacade character)
<span class="nc" id="L1172">		{</span>
<span class="nc" id="L1173">			this.character = character;</span>
<span class="nc" id="L1174">		}</span>

		public void install()
		{
<span class="nc" id="L1178">			availableTable.setDragEnabled(true);</span>
<span class="nc" id="L1179">			availableTable.setDropMode(DropMode.ON);</span>
<span class="nc" id="L1180">			availableTable.setTransferHandler(this);</span>

<span class="nc" id="L1182">			purchasedTable.setDragEnabled(true);</span>
<span class="nc" id="L1183">			purchasedTable.setDropMode(DropMode.ON);</span>
<span class="nc" id="L1184">			purchasedTable.setTransferHandler(this);</span>
<span class="nc" id="L1185">		}</span>

		@Override
		public int getSourceActions(JComponent c)
		{
<span class="nc" id="L1190">			return MOVE;</span>
		}

		@Override
		protected Transferable createTransferable(JComponent c)
		{
<span class="nc" id="L1196">			List&lt;?&gt; data = null;</span>
<span class="nc bnc" id="L1197" title="All 2 branches missed.">			if (c == availableTable)</span>
			{
<span class="nc" id="L1199">				data = availableTable.getSelectedData();</span>
			}
<span class="nc bnc" id="L1201" title="All 2 branches missed.">			else if (c == purchasedTable)</span>
			{
<span class="nc" id="L1203">				data = purchasedTable.getSelectedData();</span>
			}
<span class="nc bnc" id="L1205" title="All 2 branches missed.">			if (data == null)</span>
			{
<span class="nc" id="L1207">				return null;</span>
			}
<span class="nc bnc" id="L1209" title="All 2 branches missed.">			data.removeIf(o -&gt; !(o instanceof EquipmentFacade));</span>
<span class="nc bnc" id="L1210" title="All 2 branches missed.">			if (data.isEmpty())</span>
			{
<span class="nc" id="L1212">				return null;</span>
			}

<span class="nc" id="L1215">			EquipmentFacade[] equipArray = data.toArray(new EquipmentFacade[0]);</span>
<span class="nc" id="L1216">			return new EquipmentSelection(equipArray);</span>
		}

		@Override
		public boolean canImport(TransferSupport support)
		{
<span class="nc bnc" id="L1222" title="All 2 branches missed.">			if (!support.isDataFlavorSupported(EQUIPMENT_ARRAY_FLAVOR))</span>
			{
<span class="nc" id="L1224">				return false;</span>
			}
<span class="nc" id="L1226">			support.setShowDropLocation(false);</span>
<span class="nc" id="L1227">			return true;</span>
		}

		private EquipmentFacade[] getEquipmentArray(TransferSupport support)
		{
<span class="nc" id="L1232">			EquipmentFacade[] equipmentArray = null;</span>
			try
			{
<span class="nc" id="L1235">				equipmentArray = (EquipmentFacade[]) support.getTransferable().getTransferData(EQUIPMENT_ARRAY_FLAVOR);</span>
			}
<span class="nc" id="L1237">			catch (UnsupportedFlavorException | IOException ex)</span>
			{
<span class="nc" id="L1239">			}</span>
<span class="nc" id="L1240">			return equipmentArray;</span>
		}

		@Override
		public boolean importData(TransferSupport support)
		{
<span class="nc bnc" id="L1246" title="All 2 branches missed.">			if (!canImport(support))</span>
			{
<span class="nc" id="L1248">				return false;</span>
			}
<span class="nc bnc" id="L1250" title="All 2 branches missed.">			if (!support.isDrop())</span>
			{
<span class="nc" id="L1252">				return false;</span>
			}
<span class="nc" id="L1254">			EquipmentFacade[] equipmentArray = getEquipmentArray(support);</span>
<span class="nc bnc" id="L1255" title="All 2 branches missed.">			if (support.getComponent() == availableTable)</span>
			{
<span class="nc bnc" id="L1257" title="All 2 branches missed.">				for (EquipmentFacade equipmentFacade : equipmentArray)</span>
				{
<span class="nc" id="L1259">					character.removePurchasedEquipment(equipmentFacade, 1, false);</span>
				}
			}
<span class="nc bnc" id="L1262" title="All 2 branches missed.">			else if (support.getComponent() == purchasedTable)</span>
			{
<span class="nc bnc" id="L1264" title="All 2 branches missed.">				for (EquipmentFacade equipmentFacade : equipmentArray)</span>
				{
<span class="nc" id="L1266">					EquipmentFacade equip = character.getEquipmentSizedForCharacter(equipmentFacade);</span>
<span class="nc" id="L1267">					character.addPurchasedEquipment(equip, 1, false, false);</span>
				}
			}
<span class="nc" id="L1270">			availableTable.refilter();</span>
<span class="nc" id="L1271">			return true;</span>
		}

	}

	private class BuyPopupMenuHandler extends PopupMouseAdapter
	{

		private final CharacterFacade character;

		BuyPopupMenuHandler(CharacterFacade character)
<span class="nc" id="L1282">		{</span>
<span class="nc" id="L1283">			this.character = character;</span>
<span class="nc" id="L1284">		}</span>

		@Override
		public void showPopup(MouseEvent e)
		{
<span class="nc" id="L1289">			List&lt;EquipmentFacade&gt; targets = getMenuTargets(availableTable, e);</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">			if (targets.isEmpty())</span>
			{
<span class="nc" id="L1292">				return;</span>
			}

<span class="nc" id="L1295">			JPopupMenu popupMenu = new JPopupMenu();</span>
<span class="nc" id="L1296">			popupMenu.add(new BuyNumMenuItem(character, targets, 1));</span>
<span class="nc" id="L1297">			JMenu buyMenu = new JMenu(LanguageBundle.getString(&quot;in_igBuyQuantity&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1298">			buyMenu.add(new BuyNumMenuItem(character, targets, 2));</span>
<span class="nc" id="L1299">			buyMenu.add(new BuyNumMenuItem(character, targets, 5));</span>
<span class="nc" id="L1300">			buyMenu.add(new BuyNumMenuItem(character, targets, 10));</span>
<span class="nc" id="L1301">			buyMenu.add(new BuyNumMenuItem(character, targets, 15));</span>
<span class="nc" id="L1302">			buyMenu.add(new BuyNumMenuItem(character, targets, 20));</span>
<span class="nc" id="L1303">			buyMenu.add(new BuyNumMenuItem(character, targets, 50));</span>
<span class="nc" id="L1304">			popupMenu.add(buyMenu);</span>
<span class="nc" id="L1305">			popupMenu.add(new BuyNumMenuItem(character, targets, 0));</span>
<span class="nc" id="L1306">			popupMenu.addSeparator();</span>
<span class="nc" id="L1307">			popupMenu.add(new AddCustomAction(character));</span>
<span class="nc" id="L1308">			popupMenu.add(new DeleteCustomAction(character));</span>
<span class="nc" id="L1309">			popupMenu.show(e.getComponent(), e.getX(), e.getY());</span>
<span class="nc" id="L1310">		}</span>

		public void install()
		{
<span class="nc" id="L1314">			availableTable.addMouseListener(this);</span>
<span class="nc" id="L1315">		}</span>

		public void uninstall()
		{
<span class="nc" id="L1319">			availableTable.removeMouseListener(this);</span>
<span class="nc" id="L1320">		}</span>

	}

	/**
	 * Menu item for buying a quanity of an item at the current rate.
	 */
	private class BuyNumMenuItem extends JMenuItem implements ActionListener
	{

		private final int quantity;
		private final CharacterFacade character;
		private final List&lt;EquipmentFacade&gt; targets;

		BuyNumMenuItem(CharacterFacade character, List&lt;EquipmentFacade&gt; targets, int quantity)
<span class="nc" id="L1335">		{</span>
<span class="nc" id="L1336">			super(LanguageBundle.getFormattedString(</span>
<span class="nc bnc" id="L1337" title="All 2 branches missed.">				quantity &gt; 0 ? &quot;in_igBuyMenuCommand&quot; : &quot;in_igBuyN&quot;, quantity)); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L1338">			this.character = character;</span>
<span class="nc" id="L1339">			this.targets = targets;</span>
<span class="nc" id="L1340">			this.quantity = quantity;</span>
<span class="nc bnc" id="L1341" title="All 2 branches missed.">			if (quantity &gt; 0)</span>
			{
<span class="nc" id="L1343">				setToolTipText(LanguageBundle.getFormattedString(&quot;in_igBuyMenuDesc&quot;, quantity)); //$NON-NLS-1$</span>
			}
			else
			{
<span class="nc" id="L1347">				setToolTipText(LanguageBundle.getString(&quot;in_igBuyNMenuDesc&quot;)); //$NON-NLS-1$</span>
			}
<span class="nc" id="L1349">			setIcon(Icons.Add16.getImageIcon());</span>

<span class="nc" id="L1351">			addActionListener(this);</span>
<span class="nc" id="L1352">		}</span>

		/**
		 * Action to buy a certain number of items.
		 */
		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1360">			int num = quantity;</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">			if (num == 0)</span>
			{
<span class="nc" id="L1363">				String selectedValue =</span>
<span class="nc" id="L1364">						JOptionPane.showInputDialog(</span>
<span class="nc" id="L1365">							null, LanguageBundle.getString(&quot;in_igBuyEnterQuantity&quot;), //$NON-NLS-1$</span>
							Constants.APPLICATION_NAME, JOptionPane.QUESTION_MESSAGE);
<span class="nc bnc" id="L1367" title="All 2 branches missed.">				if (selectedValue != null)</span>
				{
					try
					{
<span class="nc" id="L1371">						num = (int) Float.parseFloat(selectedValue);</span>
					}
<span class="nc" id="L1373">					catch (NumberFormatException ex)</span>
					{
						//Ignored
<span class="nc" id="L1376">					}</span>
				}
			}
<span class="nc bnc" id="L1379" title="All 2 branches missed.">			if (num &gt; 0)</span>
			{
<span class="nc bnc" id="L1381" title="All 2 branches missed.">				for (EquipmentFacade equip : targets)</span>
				{
<span class="nc bnc" id="L1383" title="All 2 branches missed.">					if (character.isAutoResize())</span>
					{
<span class="nc" id="L1385">						equip = character.getEquipmentSizedForCharacter(equip);</span>
					}
<span class="nc" id="L1387">					character.addPurchasedEquipment(equip, num, false, false);</span>
<span class="nc" id="L1388">					availableTable.refilter();</span>
<span class="nc" id="L1389">				}</span>
			}
<span class="nc" id="L1391">		}</span>

	}

	private class SellPopupMenuHandler extends PopupMouseAdapter
	{

		private final CharacterFacade character;

		SellPopupMenuHandler(CharacterFacade character)
<span class="nc" id="L1401">		{</span>
<span class="nc" id="L1402">			this.character = character;</span>
<span class="nc" id="L1403">		}</span>

		@Override
		public void showPopup(MouseEvent e)
		{
<span class="nc" id="L1408">			List&lt;EquipmentFacade&gt; targets = getMenuTargets(purchasedTable, e);</span>
<span class="nc bnc" id="L1409" title="All 2 branches missed.">			if (targets.isEmpty())</span>
			{
<span class="nc" id="L1411">				return;</span>
			}

<span class="nc" id="L1414">			JPopupMenu popupMenu = new JPopupMenu();</span>
<span class="nc" id="L1415">			popupMenu.add(new SellNumMenuItem(character, targets, 1));</span>
<span class="nc" id="L1416">			JMenu sellMenu = new JMenu(LanguageBundle.getString(&quot;in_igSellQuantity&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1417">			sellMenu.add(new SellNumMenuItem(character, targets, 2));</span>
<span class="nc" id="L1418">			sellMenu.add(new SellNumMenuItem(character, targets, 5));</span>
<span class="nc" id="L1419">			sellMenu.add(new SellNumMenuItem(character, targets, 10));</span>
<span class="nc" id="L1420">			sellMenu.add(new SellNumMenuItem(character, targets, 15));</span>
<span class="nc" id="L1421">			sellMenu.add(new SellNumMenuItem(character, targets, 20));</span>
<span class="nc" id="L1422">			sellMenu.add(new SellNumMenuItem(character, targets, 50));</span>
<span class="nc" id="L1423">			popupMenu.add(sellMenu);</span>
<span class="nc" id="L1424">			popupMenu.add(new SellNumMenuItem(character, targets, 0));</span>
<span class="nc" id="L1425">			popupMenu.add(new SellNumMenuItem(character, targets, SellNumMenuItem.SELL_ALL_QUANTITY));</span>
<span class="nc" id="L1426">			popupMenu.addSeparator();</span>
<span class="nc" id="L1427">			JMenu moveMenu = new JMenu(LanguageBundle.getString(&quot;in_igMoveItemMenuTitle&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1428">			moveMenu.setEnabled(false);</span>
<span class="nc bnc" id="L1429" title="All 2 branches missed.">			for (CharacterFacade dest : CharacterManager.getCharacters())</span>
			{
<span class="nc bnc" id="L1431" title="All 2 branches missed.">				if (dest != character)</span>
				{
<span class="nc" id="L1433">					moveMenu.add(new MoveItemMenuItem(character, dest, targets));</span>
<span class="nc" id="L1434">					moveMenu.setEnabled(true);</span>
				}
<span class="nc" id="L1436">			}</span>
<span class="nc" id="L1437">			popupMenu.add(moveMenu);</span>
<span class="nc" id="L1438">			JMenu copyMenu = new JMenu(LanguageBundle.getString(&quot;in_igCopyItemMenuTitle&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1439">			copyMenu.setEnabled(false);</span>
<span class="nc bnc" id="L1440" title="All 2 branches missed.">			for (CharacterFacade dest : CharacterManager.getCharacters())</span>
			{
<span class="nc bnc" id="L1442" title="All 2 branches missed.">				if (dest != character)</span>
				{
<span class="nc" id="L1444">					copyMenu.add(new CopyItemMenuItem(dest, targets));</span>
<span class="nc" id="L1445">					copyMenu.setEnabled(true);</span>
				}
<span class="nc" id="L1447">			}</span>
<span class="nc" id="L1448">			popupMenu.add(copyMenu);</span>
<span class="nc" id="L1449">			popupMenu.addSeparator();</span>
<span class="nc" id="L1450">			popupMenu.add(new ModifyChargesMenuItem(character, targets));</span>
<span class="nc" id="L1451">			popupMenu.add(new AddNoteMenuItem(character, targets));</span>
<span class="nc" id="L1452">			popupMenu.show(e.getComponent(), e.getX(), e.getY());</span>
<span class="nc" id="L1453">		}</span>

		public void install()
		{
<span class="nc" id="L1457">			purchasedTable.addMouseListener(this);</span>
<span class="nc" id="L1458">		}</span>

		public void uninstall()
		{
<span class="nc" id="L1462">			purchasedTable.removeMouseListener(this);</span>
<span class="nc" id="L1463">		}</span>

	}

	/**
	 * Menu item for selling a quantity of an item at the current rate.
	 */
	private class SellNumMenuItem extends JMenuItem implements ActionListener
	{

		public static final int SELL_ALL_QUANTITY = -5;
		private final int quantity;
		private final CharacterFacade character;
		private final List&lt;EquipmentFacade&gt; targets;

		SellNumMenuItem(CharacterFacade character, List&lt;EquipmentFacade&gt; targets, int quantity)
<span class="nc" id="L1479">		{</span>
<span class="nc" id="L1480">			super(</span>
<span class="nc" id="L1481">				LanguageBundle.getFormattedString(</span>
<span class="nc bnc" id="L1482" title="All 4 branches missed.">					quantity &gt; 0 ? &quot;in_igSellMenuCommand&quot; : (quantity == SELL_ALL_QUANTITY //$NON-NLS-1$</span>
<span class="nc" id="L1483">					? &quot;in_igSellAll&quot; : &quot;in_igSellN&quot;), quantity)); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L1484">			this.character = character;</span>
<span class="nc" id="L1485">			this.targets = targets;</span>
<span class="nc" id="L1486">			this.quantity = quantity;</span>
<span class="nc bnc" id="L1487" title="All 2 branches missed.">			if (quantity &gt; 0)</span>
			{
<span class="nc" id="L1489">				setToolTipText(LanguageBundle.getFormattedString(&quot;in_igSellMenuDesc&quot;, quantity)); //$NON-NLS-1$</span>
			}
<span class="nc bnc" id="L1491" title="All 2 branches missed.">			else if (quantity == SELL_ALL_QUANTITY)</span>
			{
<span class="nc" id="L1493">				setToolTipText(LanguageBundle.getString(&quot;in_igSellAllMenuDesc&quot;)); //$NON-NLS-1$</span>
			}
			else
			{
<span class="nc" id="L1497">				setToolTipText(LanguageBundle.getString(&quot;in_igSellNMenuDesc&quot;)); //$NON-NLS-1$</span>
			}
<span class="nc" id="L1499">			setIcon(Icons.Remove16.getImageIcon());</span>

<span class="nc" id="L1501">			addActionListener(this);</span>
<span class="nc" id="L1502">		}</span>

		/**
		 * Action to buy a certain number of items.
		 */
		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc bnc" id="L1510" title="All 2 branches missed.">			boolean sellAll = quantity == SELL_ALL_QUANTITY;</span>
<span class="nc" id="L1511">			int num = quantity;</span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">			if (num == 0)</span>
			{
<span class="nc" id="L1514">				String selectedValue =</span>
<span class="nc" id="L1515">						JOptionPane.showInputDialog(</span>
<span class="nc" id="L1516">							null, LanguageBundle.getString(&quot;in_igBuyEnterQuantity&quot;), //$NON-NLS-1$</span>
							Constants.APPLICATION_NAME, JOptionPane.QUESTION_MESSAGE);
<span class="nc bnc" id="L1518" title="All 2 branches missed.">				if (selectedValue != null)</span>
				{
					try
					{
<span class="nc" id="L1522">						num = (int) Float.parseFloat(selectedValue);</span>
					}
<span class="nc" id="L1524">					catch (NumberFormatException ex)</span>
					{
						//Ignored
<span class="nc" id="L1527">					}</span>
				}
			}
<span class="nc bnc" id="L1530" title="All 4 branches missed.">			if (num &gt; 0 || sellAll)</span>
			{
<span class="nc bnc" id="L1532" title="All 2 branches missed.">				for (EquipmentFacade equip : targets)</span>
				{
<span class="nc bnc" id="L1534" title="All 2 branches missed.">					if (sellAll)</span>
					{
<span class="nc" id="L1536">						num = character.getPurchasedEquipment().getQuantity(equip);</span>
					}
<span class="nc" id="L1538">					character.removePurchasedEquipment(equip, num, false);</span>
<span class="nc" id="L1539">				}</span>
<span class="nc" id="L1540">				availableTable.refilter();</span>
			}
<span class="nc" id="L1542">		}</span>

	}

	private static class ModifyChargesMenuItem extends JMenuItem implements ActionListener
	{

		private final CharacterFacade character;
		private final List&lt;EquipmentFacade&gt; targets;

		ModifyChargesMenuItem(CharacterFacade character, List&lt;EquipmentFacade&gt; targets)
		{
<span class="nc" id="L1554">			super(LanguageBundle.getString(&quot;in_igModifyCharges&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1555">			this.character = character;</span>
<span class="nc" id="L1556">			this.targets = targets;</span>
			// Set enabled only if there are items with charges
<span class="nc" id="L1558">			boolean hasItemWithCharges = false;</span>
<span class="nc bnc" id="L1559" title="All 2 branches missed.">			for (EquipmentFacade equipment : targets)</span>
			{
<span class="nc bnc" id="L1561" title="All 4 branches missed.">				if (equipment instanceof Equipment &amp;&amp; ((Equipment) equipment).getMaxCharges() &gt; 0)</span>
				{
<span class="nc" id="L1563">					hasItemWithCharges = true;</span>
<span class="nc" id="L1564">					break;</span>
				}
<span class="nc" id="L1566">			}</span>
<span class="nc" id="L1567">			setEnabled(hasItemWithCharges);</span>
<span class="nc" id="L1568">			addActionListener(this);</span>
<span class="nc" id="L1569">		}</span>

		/**
		 * Action to modify the number of charges on the items.
		 */
		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1577">			character.modifyCharges(targets);</span>
<span class="nc" id="L1578">		}</span>

	}

	private static class AddNoteMenuItem extends JMenuItem implements ActionListener
	{

		private final CharacterFacade character;
		private final List&lt;EquipmentFacade&gt; targets;

		AddNoteMenuItem(CharacterFacade character, List&lt;EquipmentFacade&gt; targets)
		{
<span class="nc" id="L1590">			super(LanguageBundle.getString(&quot;in_igAddNote&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1591">			this.character = character;</span>
<span class="nc" id="L1592">			this.targets = targets;</span>

<span class="nc" id="L1594">			addActionListener(this);</span>
<span class="nc" id="L1595">		}</span>

		/**
		 * Action to modify the number of charges on the items.
		 */
		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1603">			character.addNote(targets);</span>
<span class="nc" id="L1604">		}</span>

	}

	private static class MoveItemMenuItem extends JMenuItem implements ActionListener
	{

		private final CharacterFacade character;
		private final CharacterFacade destination;
		private final List&lt;EquipmentFacade&gt; targets;

		MoveItemMenuItem(CharacterFacade character, CharacterFacade destination, List&lt;EquipmentFacade&gt; targets)
		{
<span class="nc" id="L1617">			super(destination.getNameRef().get());</span>
<span class="nc" id="L1618">			this.character = character;</span>
<span class="nc" id="L1619">			this.destination = destination;</span>
<span class="nc" id="L1620">			this.targets = targets;</span>

<span class="nc" id="L1622">			addActionListener(this);</span>
<span class="nc" id="L1623">		}</span>

		/**
		 * Action to move the items between characters.
		 */
		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc bnc" id="L1631" title="All 2 branches missed.">			for (EquipmentFacade item : targets)</span>
			{
<span class="nc" id="L1633">				character.removePurchasedEquipment(item, 1, true);</span>
<span class="nc" id="L1634">				destination.addPurchasedEquipment(item, 1, false, true);</span>
<span class="nc" id="L1635">			}</span>
<span class="nc" id="L1636">		}</span>

	}

	private static class CopyItemMenuItem extends JMenuItem implements ActionListener
	{

		private final CharacterFacade destination;
		private final List&lt;EquipmentFacade&gt; targets;

		CopyItemMenuItem(CharacterFacade destination, List&lt;EquipmentFacade&gt; targets)
		{
<span class="nc" id="L1648">			super(destination.getNameRef().get());</span>
<span class="nc" id="L1649">			this.destination = destination;</span>
<span class="nc" id="L1650">			this.targets = targets;</span>

<span class="nc" id="L1652">			addActionListener(this);</span>
<span class="nc" id="L1653">		}</span>

		/**
		 * Action to copy the items to another character.
		 */
		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc bnc" id="L1661" title="All 2 branches missed.">			for (EquipmentFacade item : targets)</span>
			{
<span class="nc" id="L1663">				destination.addPurchasedEquipment(item, 1, false, true);</span>
<span class="nc" id="L1664">			}</span>
<span class="nc" id="L1665">		}</span>

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>