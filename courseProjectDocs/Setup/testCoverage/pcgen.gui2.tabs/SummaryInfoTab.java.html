<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SummaryInfoTab.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.tabs</a> &gt; <span class="el_source">SummaryInfoTab.java</span></div><h1>SummaryInfoTab.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2010 (C) Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 * 
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 * 
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 * 
 */
package pcgen.gui2.tabs;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Container;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.GridLayout;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.text.NumberFormat;
import java.util.Arrays;
import java.util.Collection;
import java.util.TreeSet;

import javax.swing.AbstractAction;
import javax.swing.BorderFactory;
import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.DefaultListCellRenderer;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JEditorPane;
import javax.swing.JFormattedTextField;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JSpinner;
import javax.swing.JTable;
import javax.swing.JTextField;
import javax.swing.LayoutFocusTraversalPolicy;
import javax.swing.ScrollPaneConstants;
import javax.swing.SwingConstants;
import javax.swing.SwingUtilities;
import javax.swing.border.Border;
import javax.swing.border.TitledBorder;
import javax.swing.event.HyperlinkEvent;
import javax.swing.event.HyperlinkListener;

import pcgen.cdom.enumeration.Gender;
import pcgen.cdom.enumeration.Handed;
import pcgen.cdom.util.CControl;
import pcgen.core.Deity;
import pcgen.core.PCAlignment;
import pcgen.core.PCClass;
import pcgen.core.Race;
import pcgen.facade.core.CharacterFacade;
import pcgen.facade.core.CharacterLevelFacade;
import pcgen.facade.core.CharacterLevelsFacade;
import pcgen.facade.core.DataSetFacade;
import pcgen.facade.core.InfoFacade;
import pcgen.facade.core.TodoFacade;
import pcgen.facade.util.ReferenceFacade;
import pcgen.facade.util.event.ListEvent;
import pcgen.facade.util.event.ListListener;
import pcgen.facade.util.event.ReferenceEvent;
import pcgen.facade.util.event.ReferenceListener;
import pcgen.gui2.UIPropertyContext;
import pcgen.gui2.dialog.CharacterHPDialog;
import pcgen.gui2.dialog.KitSelectionDialog;
import pcgen.gui2.dialog.RandomNameDialog;
import pcgen.gui2.dialog.SinglePrefDialog;
import pcgen.gui2.prefs.CharacterStatsPanel;
import pcgen.gui2.tabs.models.CharacterComboBoxModel;
import pcgen.gui2.tabs.models.DeferredCharacterComboBoxModel;
import pcgen.gui2.tabs.models.FormattedFieldHandler;
import pcgen.gui2.tabs.models.TextFieldHandler;
import pcgen.gui2.tabs.summary.ClassLevelTableModel;
import pcgen.gui2.tabs.summary.InfoPaneHandler;
import pcgen.gui2.tabs.summary.LanguageTableModel;
import pcgen.gui2.tabs.summary.StatTableModel;
import pcgen.gui2.tools.Icons;
import pcgen.gui2.util.FacadeComboBoxModel;
import pcgen.gui2.util.FontManipulation;
import pcgen.gui2.util.ManagedField;
import pcgen.gui2.util.SignIcon;
import pcgen.gui2.util.SignIcon.Sign;
import pcgen.gui2.util.SimpleTextIcon;
import pcgen.gui3.JFXPanelFromResource;
import pcgen.gui3.SimpleHtmlPanelController;
import pcgen.gui3.utilty.ColorUtilty;
import pcgen.system.LanguageBundle;
import pcgen.util.enumeration.Tab;

import org.apache.commons.lang3.StringUtils;

/**
 * This component displays a basic summary of a character such as name,
 * alignment, race, class, and stat information.
 */
@SuppressWarnings(&quot;serial&quot;)
public class SummaryInfoTab extends JPanel implements CharacterInfoTab, TodoHandler
{

	private final TabTitle tabTitle;
	private final JPanel basicsPanel;
	private final JPanel todoPanel;
	private final JPanel scoresPanel;
	private final JPanel racePanel;
	private final JPanel classPanel;
	private final JTextField characterNameField;
	private final JComboBox characterTypeComboBox;
	private final JTextField playerNameField;
	private final JTextField tabLabelField;
	private final JFormattedTextField ageField;
	private final JFormattedTextField expField;
	private final JFormattedTextField nextlevelField;
	private final JComboBox xpTableComboBox;
	private final JFormattedTextField expmodField;
	private final JFormattedTextField addLevelsField;
	private final JFormattedTextField removeLevelsField;
	private final JTable statsTable;
	private final JTable classLevelTable;
	private final JTable languageTable;
	private final JComboBox genderComboBox;
	private final JComboBox handsComboBox;
	private final JComboBox alignmentComboBox;
	private final JComboBox deityComboBox;
	private final JComboBox raceComboBox;
	private final JComboBox ageComboBox;
	private final JComboBox classComboBox;
	private final InfoBoxRenderer infoBoxRenderer;
	private final ClassBoxRenderer classBoxRenderer;
	private final JButton generateRollsButton;
	private final JButton rollMethodButton;
	private final JButton createMonsterButton;
	private final JButton expaddButton;
	private final JButton expsubtractButton;
	private final JButton addLevelsButton;
	private final JButton removeLevelsButton;
	private final JButton hpButton;
	private final JLabel totalHPLabel;
	private final JFXPanelFromResource&lt;SimpleHtmlPanelController&gt; infoPane;
	private final JLabel statTotalLabel;
	private final JLabel statTotal;
	private final JLabel modTotalLabel;
	private final JLabel modTotal;
	private final JEditorPane todoPane;
	private final JButton random;
	private JScrollPane langScroll;

	SummaryInfoTab()
<span class="nc" id="L168">	{</span>
<span class="nc" id="L169">		this.tabTitle = new TabTitle(Tab.SUMMARY);</span>
<span class="nc" id="L170">		this.basicsPanel = new JPanel();</span>
<span class="nc" id="L171">		this.todoPanel = new JPanel();</span>
<span class="nc" id="L172">		this.scoresPanel = new JPanel();</span>
<span class="nc" id="L173">		this.racePanel = new JPanel();</span>
<span class="nc" id="L174">		this.classPanel = new JPanel();</span>
<span class="nc" id="L175">		this.characterNameField = new JTextField();</span>
<span class="nc" id="L176">		this.characterTypeComboBox = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L177">		this.random = new JButton();</span>
<span class="nc" id="L178">		FontManipulation.xsmall(random);</span>
<span class="nc" id="L179">		this.playerNameField = new JTextField();</span>
<span class="nc" id="L180">		this.expField = new JFormattedTextField(NumberFormat.getIntegerInstance());</span>
<span class="nc" id="L181">		this.nextlevelField = new JFormattedTextField(NumberFormat.getIntegerInstance());</span>
<span class="nc" id="L182">		this.xpTableComboBox = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L183">		this.expmodField = new JFormattedTextField(NumberFormat.getIntegerInstance());</span>
<span class="nc" id="L184">		this.addLevelsField = new JFormattedTextField(NumberFormat.getIntegerInstance());</span>
<span class="nc" id="L185">		this.removeLevelsField = new JFormattedTextField(NumberFormat.getIntegerInstance());</span>
<span class="nc" id="L186">		this.statsTable = new JTable();</span>
<span class="nc" id="L187">		this.classLevelTable = new JTable();</span>
<span class="nc" id="L188">		this.languageTable = new JTable();</span>
<span class="nc" id="L189">		this.genderComboBox = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L190">		this.handsComboBox = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L191">		this.alignmentComboBox = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L192">		this.deityComboBox = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L193">		this.raceComboBox = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L194">		this.ageComboBox = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L195">		this.classComboBox = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L196">		this.tabLabelField = new JTextField();</span>
<span class="nc" id="L197">		this.ageField = new JFormattedTextField(NumberFormat.getIntegerInstance());</span>
<span class="nc" id="L198">		this.generateRollsButton = new JButton();</span>
<span class="nc" id="L199">		this.rollMethodButton = new JButton();</span>
<span class="nc" id="L200">		this.createMonsterButton = new JButton();</span>
<span class="nc" id="L201">		this.addLevelsButton = new JButton();</span>
<span class="nc" id="L202">		this.removeLevelsButton = new JButton();</span>
<span class="nc" id="L203">		this.expaddButton = new JButton();</span>
<span class="nc" id="L204">		this.expsubtractButton = new JButton();</span>
<span class="nc" id="L205">		this.hpButton = new JButton();</span>
<span class="nc" id="L206">		this.totalHPLabel = new JLabel();</span>
<span class="nc" id="L207">		this.infoPane = new JFXPanelFromResource&lt;&gt;(</span>
				SimpleHtmlPanelController.class,
				&quot;SimpleHtmlPanel.fxml&quot;
		);
<span class="nc" id="L211">		this.statTotalLabel = new JLabel();</span>
<span class="nc" id="L212">		this.statTotal = new JLabel();</span>
<span class="nc" id="L213">		this.modTotalLabel = new JLabel();</span>
<span class="nc" id="L214">		this.modTotal = new JLabel();</span>
<span class="nc" id="L215">		this.todoPane = new JEditorPane();</span>
<span class="nc" id="L216">		this.infoBoxRenderer = new InfoBoxRenderer();</span>
<span class="nc" id="L217">		this.classBoxRenderer = new ClassBoxRenderer();</span>
<span class="nc" id="L218">		initComponents();</span>
<span class="nc" id="L219">	}</span>

	private void initComponents()
	{
<span class="nc" id="L223">		this.setFocusCycleRoot(true);</span>
<span class="nc" id="L224">		this.setFocusTraversalPolicyProvider(true);</span>
<span class="nc" id="L225">		this.setFocusTraversalPolicy(new SummaryTabFocusTraversalPolicy());</span>

<span class="nc" id="L227">		LanguageTableModel.initializeTable(languageTable);</span>

<span class="nc" id="L229">		setLayout(new GridBagLayout());</span>
<span class="nc" id="L230">		GridBagConstraints gbc = new GridBagConstraints();</span>

<span class="nc" id="L232">		setPanelTitle(basicsPanel, LanguageBundle.getString(&quot;in_sumCharacterBasics&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L233">		basicsPanel.setLayout(new GridBagLayout());</span>
<span class="nc" id="L234">		deityComboBox.setRenderer(infoBoxRenderer);</span>
<span class="nc" id="L235">		raceComboBox.setRenderer(infoBoxRenderer);</span>
<span class="nc" id="L236">		classComboBox.setRenderer(classBoxRenderer);</span>
<span class="nc" id="L237">		gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L238">		gbc.weightx = 0.1;</span>
<span class="nc" id="L239">		gbc.weighty = 0.7;</span>
<span class="nc" id="L240">		add(basicsPanel, gbc);</span>

<span class="nc" id="L242">		setPanelTitle(todoPanel, LanguageBundle.getString(&quot;in_tipsString&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L243">		initTodoPanel(todoPanel);</span>
<span class="nc" id="L244">		gbc.gridy = 1;</span>
<span class="nc" id="L245">		gbc.gridheight = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L246">		add(todoPanel, gbc);</span>

<span class="nc" id="L248">		initMiddlePanel(scoresPanel);</span>
<span class="nc" id="L249">		gbc.gridy = GridBagConstraints.RELATIVE;</span>
<span class="nc" id="L250">		gbc.weightx = 1;</span>
<span class="nc" id="L251">		add(scoresPanel, gbc);</span>

<span class="nc" id="L253">		JPanel rightPanel = new JPanel();</span>
<span class="nc" id="L254">		setPanelTitle(racePanel, LanguageBundle.getString(&quot;in_raceString&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L255">		setPanelTitle(classPanel, LanguageBundle.getString(&quot;in_sumClassLevel&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L256">		initRightPanel(rightPanel);</span>
<span class="nc" id="L257">		gbc.weightx = 0.1;</span>
<span class="nc" id="L258">		gbc.weighty = 1;</span>
<span class="nc" id="L259">		add(rightPanel, gbc);</span>
<span class="nc" id="L260">	}</span>

	private static void setPanelTitle(JComponent panel, String title)
	{
<span class="nc" id="L264">		panel.setBorder(</span>
<span class="nc" id="L265">			BorderFactory.createTitledBorder(null, title, TitledBorder.CENTER, TitledBorder.DEFAULT_POSITION));</span>
<span class="nc" id="L266">	}</span>

	/**
	 * Initialise the &quot;Things to be Done&quot; panel. Creates the required components
	 * and places them in the panel.
	 *
	 * @param panel The panel to be initialised
	 */
	private void initTodoPanel(JPanel panel)
	{
<span class="nc" id="L276">		panel.setLayout(new BorderLayout());</span>
<span class="nc" id="L277">		todoPane.setOpaque(false);</span>
<span class="nc" id="L278">		todoPane.setContentType(&quot;text/html&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L279">		todoPane.setEditable(false);</span>

<span class="nc" id="L281">		JScrollPane scroll = new JScrollPane(todoPane);</span>
<span class="nc" id="L282">		scroll.setBorder(BorderFactory.createEmptyBorder());</span>

<span class="nc" id="L284">		panel.add(scroll, BorderLayout.CENTER);</span>
<span class="nc" id="L285">	}</span>

	private void initMiddlePanel(JPanel middlePanel)
	{
<span class="nc" id="L289">		middlePanel.setLayout(new GridLayout(2, 1));</span>

<span class="nc" id="L291">		JPanel statsPanel = new JPanel();</span>
<span class="nc" id="L292">		setPanelTitle(statsPanel, LanguageBundle.getString(&quot;in_sumAbilityScores&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L293">		statsPanel.setLayout(new BoxLayout(statsPanel, BoxLayout.Y_AXIS));</span>

<span class="nc" id="L295">		StatTableModel.initializeTable(statsTable);</span>
<span class="nc" id="L296">		JScrollPane pane = new JScrollPane(statsTable, ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,</span>
			ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER)
<span class="nc" id="L298">		{</span>

			@Override
			public Dimension getMaximumSize()
			{
				//This prevents the scroll pane from taking up more space than it needs.
<span class="nc" id="L304">				return super.getPreferredSize();</span>
			}

		};
<span class="nc" id="L308">		pane.setBorder(BorderFactory.createEmptyBorder());</span>
<span class="nc" id="L309">		JPanel statsBox = new JPanel();</span>
<span class="nc" id="L310">		statsBox.setLayout(new BoxLayout(statsBox, BoxLayout.X_AXIS));</span>
<span class="nc" id="L311">		statsBox.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L312">		statsBox.add(pane);</span>
<span class="nc" id="L313">		statsBox.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L314">		statsPanel.add(statsBox);</span>

<span class="nc" id="L316">		JPanel statTotalPanel = new JPanel();</span>
<span class="nc" id="L317">		statTotalPanel.setLayout(new BoxLayout(statTotalPanel, BoxLayout.X_AXIS));</span>
		//this makes box layout use the statTotalPanel to distribute extra space
<span class="nc" id="L319">		statTotalPanel.setMaximumSize(new Dimension(Integer.MAX_VALUE, Integer.MAX_VALUE));</span>
<span class="nc" id="L320">		statTotalPanel.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L321">		FontManipulation.title(statTotalLabel);</span>
<span class="nc" id="L322">		statTotalPanel.add(statTotalLabel);</span>
<span class="nc" id="L323">		statTotalPanel.add(statTotal);</span>
<span class="nc" id="L324">		FontManipulation.title(modTotalLabel);</span>
<span class="nc" id="L325">		statTotalPanel.add(modTotalLabel);</span>
<span class="nc" id="L326">		statTotalPanel.add(modTotal);</span>
<span class="nc" id="L327">		statTotalPanel.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L328">		generateRollsButton.setText(LanguageBundle.getString(&quot;in_sumGenerate_Rolls&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L329">		statTotalPanel.add(generateRollsButton);</span>
<span class="nc" id="L330">		rollMethodButton.setText(LanguageBundle.getString(&quot;in_sumRoll_Method&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L331">		statTotalPanel.add(Box.createRigidArea(new Dimension(5, 0)));</span>
<span class="nc" id="L332">		statTotalPanel.add(rollMethodButton);</span>
<span class="nc" id="L333">		statTotalPanel.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L334">		statsPanel.add(statTotalPanel);</span>

<span class="nc" id="L336">		middlePanel.add(statsPanel);</span>

<span class="nc" id="L338">		pane = new JScrollPane(infoPane);</span>
<span class="nc" id="L339">		setPanelTitle(pane, LanguageBundle.getString(&quot;in_sumStats&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L340">		middlePanel.add(pane);</span>
<span class="nc" id="L341">	}</span>

	private void initRightPanel(JPanel rightPanel)
	{
<span class="nc" id="L345">		rightPanel.setLayout(new GridBagLayout());</span>
		/*
		 * initialize Components
		 */
<span class="nc" id="L349">		racePanel.setOpaque(false);</span>
<span class="nc" id="L350">		classPanel.setOpaque(false);</span>
<span class="nc" id="L351">		ageField.setHorizontalAlignment(SwingConstants.RIGHT);</span>
<span class="nc" id="L352">		expField.setHorizontalAlignment(SwingConstants.RIGHT);</span>
<span class="nc" id="L353">		nextlevelField.setHorizontalAlignment(SwingConstants.RIGHT);</span>
<span class="nc" id="L354">		nextlevelField.setEnabled(false);</span>
<span class="nc" id="L355">		expmodField.setHorizontalAlignment(SwingConstants.RIGHT);</span>

<span class="nc" id="L357">		raceComboBox.setPrototypeDisplayValue(&quot;PrototypeDisplayValue&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L358">		classComboBox.setPrototypeDisplayValue(&quot;PrototypeDisplayValue&quot;); //$NON-NLS-1$</span>

<span class="nc" id="L360">		expaddButton.setMargin(new Insets(0, 8, 0, 8));</span>
<span class="nc" id="L361">		expsubtractButton.setMargin(new Insets(0, 8, 0, 8));</span>
<span class="nc" id="L362">		hpButton.setMargin(new Insets(0, 0, 0, 0));</span>

<span class="nc" id="L364">		JPanel expmodPanel = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L365">		JPanel levelPanel = new JPanel();</span>
<span class="nc" id="L366">		JLabel raceLabel = createLabel(&quot;in_sumRace&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L367">		JLabel ageLabel = createLabel(&quot;in_sumAge&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L368">		JLabel classLabel = createLabel(&quot;in_sumClass&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L369">		JLabel hpLabel = createLabel(&quot;in_sumTotalHP&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L370">		JLabel expLabel = createLabel(&quot;in_sumCurrentXp&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L371">		JLabel nextlevelLabel = createLabel(&quot;in_sumNextlevel&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L372">		JLabel xpTableLabel = createLabel(&quot;in_sumXpTable&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L373">		JLabel expmodLabel = createLabel(&quot;in_sumExpMod&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L374">		expmodLabel.setHorizontalAlignment(SwingConstants.CENTER);</span>
<span class="nc" id="L375">		initLevelPanel(levelPanel);</span>
		/*
		 * initialize constant variables
		 */
<span class="nc" id="L379">		Insets racePanelInsets = racePanel.getInsets();</span>
<span class="nc" id="L380">		Insets classPanelInsets = classPanel.getInsets();</span>
		/*
		 * racePanel
		 */
<span class="nc" id="L384">		GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L385">		gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L386">		gbc.insets = new Insets(racePanelInsets.top, racePanelInsets.left, 0, 0);</span>
<span class="nc" id="L387">		gbc.gridwidth = 2;</span>
<span class="nc" id="L388">		rightPanel.add(raceLabel, gbc);</span>
<span class="nc" id="L389">		gbc.insets = new Insets(racePanelInsets.top, 1, 1, racePanelInsets.right);</span>
<span class="nc" id="L390">		gbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L391">		rightPanel.add(raceComboBox, gbc);</span>
<span class="nc" id="L392">		gbc.insets = new Insets(0, racePanelInsets.left, 0, 1);</span>
<span class="nc" id="L393">		gbc.gridwidth = 1;</span>
<span class="nc" id="L394">		rightPanel.add(ageLabel, gbc);</span>
<span class="nc" id="L395">		gbc.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L396">		rightPanel.add(ageField, gbc);</span>
<span class="nc" id="L397">		gbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L398">		gbc.insets = new Insets(1, 1, 1, racePanelInsets.right);</span>
<span class="nc" id="L399">		rightPanel.add(ageComboBox, gbc);</span>
<span class="nc" id="L400">		gbc.insets = new Insets(1, racePanelInsets.left, racePanelInsets.bottom, racePanelInsets.right);</span>
<span class="nc" id="L401">		rightPanel.add(createMonsterButton, gbc);</span>
		/*
		 * classPanel
		 */
<span class="nc" id="L405">		gbc.gridwidth = 2;</span>
<span class="nc" id="L406">		gbc.insets = new Insets(classPanelInsets.top, classPanelInsets.left, 0, 0);</span>
<span class="nc" id="L407">		rightPanel.add(classLabel, gbc);</span>
<span class="nc" id="L408">		gbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L409">		gbc.insets = new Insets(classPanelInsets.top, 0, 0, classPanelInsets.right);</span>
<span class="nc" id="L410">		rightPanel.add(classComboBox, gbc);</span>

<span class="nc" id="L412">		gbc.weighty = 1;</span>
<span class="nc" id="L413">		gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L414">		gbc.insets = new Insets(7, classPanelInsets.left, 0, classPanelInsets.right);</span>
<span class="nc" id="L415">		rightPanel.add(levelPanel, gbc);</span>
<span class="nc" id="L416">		gbc.insets.top = 0;</span>
<span class="nc" id="L417">		gbc.insets.bottom = 10;</span>
<span class="nc" id="L418">		gbc.weighty = 0;</span>
		{
<span class="nc" id="L420">			JPanel hpPanel = new JPanel(new FlowLayout());</span>
<span class="nc" id="L421">			hpPanel.add(hpLabel);</span>
<span class="nc" id="L422">			hpPanel.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L423">			hpPanel.add(totalHPLabel);</span>
<span class="nc" id="L424">			hpPanel.add(hpButton);</span>
<span class="nc" id="L425">			rightPanel.add(hpPanel, gbc);</span>
		}
<span class="nc" id="L427">		gbc.insets.bottom = 0;</span>
<span class="nc" id="L428">		GridBagConstraints leftgbc = new GridBagConstraints();</span>
<span class="nc" id="L429">		leftgbc.insets = new Insets(0, classPanelInsets.left, 0, 0);</span>
<span class="nc" id="L430">		leftgbc.gridwidth = 2;</span>
<span class="nc" id="L431">		leftgbc.fill = GridBagConstraints.BOTH;</span>

<span class="nc" id="L433">		GridBagConstraints rightgbc = new GridBagConstraints();</span>
<span class="nc" id="L434">		rightgbc.insets = new Insets(0, 0, 0, classPanelInsets.right);</span>
<span class="nc" id="L435">		rightgbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L436">		rightgbc.fill = GridBagConstraints.BOTH;</span>

<span class="nc" id="L438">		rightPanel.add(expLabel, leftgbc);</span>
<span class="nc" id="L439">		rightPanel.add(expField, rightgbc);</span>
<span class="nc" id="L440">		rightPanel.add(nextlevelLabel, leftgbc);</span>
<span class="nc" id="L441">		rightPanel.add(nextlevelField, rightgbc);</span>
<span class="nc" id="L442">		rightPanel.add(xpTableLabel, leftgbc);</span>
<span class="nc" id="L443">		rightPanel.add(xpTableComboBox, rightgbc);</span>

<span class="nc" id="L445">		gbc.insets.top = 10;</span>
<span class="nc" id="L446">		rightPanel.add(expmodLabel, gbc);</span>
		{
<span class="nc" id="L448">			GridBagConstraints gbc2 = new GridBagConstraints();</span>
<span class="nc" id="L449">			gbc2.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L450">			gbc2.weightx = 1.0;</span>
<span class="nc" id="L451">			gbc2.insets = new Insets(0, 1, 0, 1);</span>
<span class="nc" id="L452">			expmodPanel.add(expaddButton, gbc2);</span>
<span class="nc" id="L453">			expmodPanel.add(expsubtractButton, gbc2);</span>
		}
<span class="nc" id="L455">		leftgbc.insets.bottom = classPanelInsets.bottom;</span>
<span class="nc" id="L456">		leftgbc.weightx = 0.3;</span>
<span class="nc" id="L457">		rightPanel.add(expmodPanel, leftgbc);</span>
<span class="nc" id="L458">		rightgbc.insets.bottom = classPanelInsets.bottom;</span>
<span class="nc" id="L459">		rightgbc.weightx = 0.7;</span>
<span class="nc" id="L460">		rightPanel.add(expmodField, rightgbc);</span>

<span class="nc" id="L462">		gbc = new GridBagConstraints();</span>
<span class="nc" id="L463">		gbc.gridx = gbc.gridy = 0;</span>
<span class="nc" id="L464">		gbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L465">		gbc.gridheight = 3;</span>
<span class="nc" id="L466">		gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L467">		rightPanel.add(racePanel, gbc);</span>

<span class="nc" id="L469">		gbc.gridy = 3;</span>
<span class="nc" id="L470">		gbc.gridheight = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L471">		rightPanel.add(classPanel, gbc);</span>
<span class="nc" id="L472">	}</span>

	private void initLevelPanel(JPanel panel)
	{
<span class="nc" id="L476">		panel.setLayout(new GridBagLayout());</span>
<span class="nc" id="L477">		JLabel addLabel = createLabel(&quot;in_sumAddLevels&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L478">		JLabel removeLabel = createLabel(&quot;in_sumRemoveLevels&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L479">		JLabel darrowLabel = new JLabel(Icons.button_arrow_down.getImageIcon());</span>
<span class="nc" id="L480">		JLabel uarrowLabel = new JLabel(Icons.button_arrow_up.getImageIcon());</span>

<span class="nc" id="L482">		addLevelsButton.setMargin(new Insets(0, 8, 0, 8));</span>
<span class="nc" id="L483">		addLevelsField.setValue(1);</span>
<span class="nc" id="L484">		addLevelsField.setHorizontalAlignment(SwingConstants.RIGHT);</span>
<span class="nc" id="L485">		removeLevelsButton.setMargin(new Insets(0, 8, 0, 8));</span>
<span class="nc" id="L486">		removeLevelsField.setValue(1);</span>
<span class="nc" id="L487">		removeLevelsField.setHorizontalAlignment(SwingConstants.RIGHT);</span>

<span class="nc" id="L489">		GridBagConstraints gbc1 = new GridBagConstraints();</span>
<span class="nc" id="L490">		GridBagConstraints gbc2 = new GridBagConstraints();</span>
<span class="nc" id="L491">		gbc1.weightx = gbc2.weightx = 0.5;</span>
<span class="nc" id="L492">		gbc1.insets = new Insets(1, 0, 1, 0);</span>
<span class="nc" id="L493">		gbc2.insets = new Insets(1, 0, 1, 0);</span>
<span class="nc" id="L494">		gbc2.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L495">		panel.add(addLabel, gbc1);</span>
<span class="nc" id="L496">		panel.add(removeLabel, gbc2);</span>
<span class="nc" id="L497">		gbc1.ipadx = 30;</span>
<span class="nc" id="L498">		panel.add(addLevelsField, gbc1);</span>
<span class="nc" id="L499">		gbc2.ipadx = 30;</span>
<span class="nc" id="L500">		panel.add(removeLevelsField, gbc2);</span>
<span class="nc" id="L501">		gbc1.ipadx = 0;</span>
<span class="nc" id="L502">		panel.add(addLevelsButton, gbc1);</span>
<span class="nc" id="L503">		gbc2.ipadx = 0;</span>
<span class="nc" id="L504">		panel.add(removeLevelsButton, gbc2);</span>
<span class="nc" id="L505">		panel.add(darrowLabel, gbc1);</span>
<span class="nc" id="L506">		panel.add(uarrowLabel, gbc2);</span>

<span class="nc" id="L508">		ClassLevelTableModel.initializeTable(classLevelTable);</span>
<span class="nc" id="L509">		gbc2.weightx = 0;</span>
<span class="nc" id="L510">		gbc2.weighty = 1;</span>
<span class="nc" id="L511">		gbc2.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L512">		panel.add(new JScrollPane(classLevelTable), gbc2);</span>
<span class="nc" id="L513">	}</span>

	private static JLabel createLabel(String text)
	{
<span class="nc" id="L517">		return new JLabel(LanguageBundle.getString(text));</span>
	}

	private void resetBasicsPanel()
	{
<span class="nc" id="L522">		basicsPanel.removeAll();</span>
<span class="nc" id="L523">		GridBagConstraints gbc = new GridBagConstraints();</span>
		{
<span class="nc" id="L525">			JLabel label = createLabel(&quot;in_sumName&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L526">			gbc.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L527">			gbc.insets = new Insets(0, 0, 3, 0);</span>
<span class="nc" id="L528">			basicsPanel.add(label, gbc);</span>

<span class="nc" id="L530">			random.setText(LanguageBundle.getString(&quot;in_randomButton&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L531">			random.setMargin(new Insets(0, 0, 0, 0));</span>
<span class="nc" id="L532">			gbc.insets = new Insets(0, 2, 3, 2);</span>
<span class="nc" id="L533">			basicsPanel.add(random, gbc);</span>

<span class="nc" id="L535">			gbc.insets = new Insets(0, 0, 3, 2);</span>
<span class="nc" id="L536">			gbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L537">			gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L538">			gbc.weightx = 1.0;</span>
<span class="nc" id="L539">			basicsPanel.add(characterNameField, gbc);</span>
		}
<span class="nc" id="L541">		Insets insets = new Insets(0, 0, 3, 2);</span>
<span class="nc" id="L542">		Font labelFont = null;</span>
<span class="nc" id="L543">		addGridBagLayer(basicsPanel, labelFont, insets, &quot;in_sumCharType&quot;, characterTypeComboBox); //$NON-NLS-1$</span>
<span class="nc" id="L544">		addGridBagLayer(basicsPanel, labelFont, insets, &quot;in_sumPlayer&quot;, playerNameField); //$NON-NLS-1$</span>
<span class="nc" id="L545">		addGridBagLayer(basicsPanel, labelFont, insets, &quot;in_sumTabLabel&quot;, tabLabelField); //$NON-NLS-1$</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">		if (genderComboBox.getModel().getSize() != 0)</span>
		{
<span class="nc" id="L548">			addGridBagLayer(basicsPanel, labelFont, insets, &quot;in_sumGender&quot;, genderComboBox); //$NON-NLS-1$</span>
		}
<span class="nc bnc" id="L550" title="All 2 branches missed.">		if (handsComboBox.getModel().getSize() != 0)</span>
		{
<span class="nc" id="L552">			addGridBagLayer(basicsPanel, labelFont, insets, &quot;in_sumHanded&quot;, handsComboBox); //$NON-NLS-1$</span>
		}
<span class="nc bnc" id="L554" title="All 2 branches missed.">		if (alignmentComboBox.getModel().getSize() != 0)</span>
		{
<span class="nc" id="L556">			addGridBagLayer(basicsPanel, labelFont, insets, &quot;in_sumAlignment&quot;, alignmentComboBox); //$NON-NLS-1$</span>
		}
<span class="nc bnc" id="L558" title="All 2 branches missed.">		if (deityComboBox.getModel().getSize() != 0)</span>
		{
<span class="nc" id="L560">			addGridBagLayer(basicsPanel, labelFont, insets, &quot;in_domDeityLabel&quot;, deityComboBox); //$NON-NLS-1$</span>
		}

<span class="nc" id="L563">		gbc = new GridBagConstraints();</span>
<span class="nc" id="L564">		gbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L565">		gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L566">		gbc.weighty = 1;</span>
<span class="nc" id="L567">		gbc.insets = new Insets(6, 2, 2, 2);</span>
<span class="nc" id="L568">		langScroll = new JScrollPane(languageTable);</span>
<span class="nc" id="L569">		basicsPanel.add(langScroll, gbc);</span>
<span class="nc" id="L570">		basicsPanel.revalidate();</span>
<span class="nc" id="L571">	}</span>

	private void addGridBagLayer(JPanel panel, Font font, Insets insets, String text, JComponent comp)
	{
<span class="nc" id="L575">		GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L576">		JLabel label = new JLabel(LanguageBundle.getString(text));</span>
<span class="nc" id="L577">		label.setFont(font);</span>
<span class="nc" id="L578">		gbc.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L579">		gbc.gridwidth = 2;</span>
<span class="nc" id="L580">		panel.add(label, gbc);</span>

<span class="nc" id="L582">		gbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L583">		gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">		if (insets != null)</span>
		{
<span class="nc" id="L586">			gbc.insets = insets;</span>
		}
<span class="nc" id="L588">		panel.add(comp, gbc);</span>
<span class="nc" id="L589">	}</span>

	@Override
	public void adviseTodo(String fieldName)
	{
<span class="nc bnc" id="L594" title="All 2 branches missed.">		if (&quot;Name&quot;.equals(fieldName)) //$NON-NLS-1$</span>
		{
<span class="nc" id="L596">			characterNameField.requestFocusInWindow();</span>
<span class="nc" id="L597">			characterNameField.selectAll();</span>
		}
<span class="nc bnc" id="L599" title="All 2 branches missed.">		else if (&quot;Race&quot;.equals(fieldName)) //$NON-NLS-1$</span>
		{
<span class="nc" id="L601">			raceComboBox.requestFocusInWindow();</span>
<span class="nc" id="L602">			highlightBorder(raceComboBox);</span>
		}
<span class="nc bnc" id="L604" title="All 2 branches missed.">		else if (&quot;Class&quot;.equals(fieldName)) //$NON-NLS-1$</span>
		{
<span class="nc" id="L606">			classComboBox.requestFocusInWindow();</span>
<span class="nc" id="L607">			highlightBorder(classComboBox);</span>
		}
<span class="nc bnc" id="L609" title="All 2 branches missed.">		else if (&quot;Languages&quot;.equals(fieldName)) //$NON-NLS-1$</span>
		{
<span class="nc" id="L611">			highlightBorder(langScroll);</span>
		}
<span class="nc bnc" id="L613" title="All 2 branches missed.">		else if (&quot;Ability Scores&quot;.equals(fieldName)) //$NON-NLS-1$</span>
		{
<span class="nc" id="L615">			deityComboBox.requestFocusInWindow();</span>
<span class="nc" id="L616">			deityComboBox.transferFocus();</span>
		}

<span class="nc" id="L619">	}</span>

	private void highlightBorder(final JComponent comp)
	{
<span class="nc" id="L623">		final Border oldBorder = comp.getBorder();</span>
<span class="nc" id="L624">		Border highlightBorder = BorderFactory.createLineBorder(Color.GREEN, 3);</span>
<span class="nc" id="L625">		comp.setBorder(highlightBorder);</span>

<span class="nc" id="L627">		SwingUtilities.invokeLater(() -&gt; {</span>
			try
			{
<span class="nc" id="L630">				Thread.sleep(500);</span>
			}
<span class="nc" id="L632">			catch (InterruptedException e)</span>
			{
				// Ignored as we'll exit shortly anyway.
<span class="nc" id="L635">			}</span>
<span class="nc" id="L636">			comp.setBorder(oldBorder);</span>
<span class="nc" id="L637">		});</span>
<span class="nc" id="L638">	}</span>

	@Override
	public ModelMap createModels(final CharacterFacade character)
	{
<span class="nc" id="L643">		ModelMap models = new ModelMap();</span>

<span class="nc" id="L645">		models.put(LabelAndFieldHandler.class, new LabelAndFieldHandler(character));</span>
<span class="nc" id="L646">		models.put(ComboBoxRendererHandler.class, new ComboBoxRendererHandler(character));</span>
<span class="nc" id="L647">		models.put(ComboBoxModelHandler.class, new ComboBoxModelHandler(character));</span>

<span class="nc" id="L649">		models.put(RandomNameAction.class,</span>
<span class="nc" id="L650">                new RandomNameAction(character, (JFrame) SwingUtilities.getWindowAncestor(this)));</span>
<span class="nc" id="L651">		models.put(ClassLevelTableModel.class, new ClassLevelTableModel(character, classLevelTable, classComboBox));</span>

<span class="nc" id="L653">		models.put(GenerateRollsAction.class, new GenerateRollsAction(character));</span>
<span class="nc" id="L654">		models.put(RollMethodAction.class,</span>
<span class="nc" id="L655">				new RollMethodAction(character, (JFrame) SwingUtilities.getWindowAncestor(this))</span>
		);
<span class="nc" id="L657">		models.put(CreateMonsterAction.class,</span>
<span class="nc" id="L658">                new CreateMonsterAction(character, (JFrame) SwingUtilities.getWindowAncestor(this)));</span>
<span class="nc" id="L659">		models.put(AddLevelsAction.class, new AddLevelsAction(character));</span>
<span class="nc" id="L660">		models.put(RemoveLevelsAction.class, new RemoveLevelsAction(character));</span>
<span class="nc" id="L661">		models.put(StatTableModel.class, new StatTableModel(character, statsTable));</span>
<span class="nc" id="L662">		models.put(LanguageTableModel.class, new LanguageTableModel(character, languageTable));</span>
<span class="nc" id="L663">		models.put(InfoPaneHandler.class, new InfoPaneHandler(character, infoPane));</span>
<span class="nc" id="L664">		models.put(ExpAddAction.class, new ExpAddAction(character));</span>
<span class="nc" id="L665">		models.put(ExpSubtractAction.class, new ExpSubtractAction(character));</span>
<span class="nc" id="L666">		models.put(TodoListHandler.class, new TodoListHandler(character));</span>
<span class="nc" id="L667">		models.put(HPHandler.class, new HPHandler(character));</span>
<span class="nc" id="L668">		return models;</span>
	}

	@Override
	public TabTitle getTabTitle()
	{
<span class="nc" id="L674">		return tabTitle;</span>
	}

	@Override
	public void storeModels(ModelMap models)
	{
<span class="nc" id="L680">		models.get(LabelAndFieldHandler.class).uninstall();</span>
<span class="nc" id="L681">		models.get(ComboBoxModelHandler.class).uninstall();</span>

<span class="nc" id="L683">		models.get(LanguageTableModel.class).uninstall();</span>
<span class="nc" id="L684">		models.get(ClassLevelTableModel.class).uninstall();</span>
<span class="nc" id="L685">		models.get(InfoPaneHandler.class).uninstall();</span>
<span class="nc" id="L686">		models.get(StatTableModel.class).uninstall();</span>
<span class="nc" id="L687">		models.get(TodoListHandler.class).uninstall();</span>
<span class="nc" id="L688">		models.get(GenerateRollsAction.class).uninstall();</span>
<span class="nc" id="L689">		models.get(HPHandler.class).uninstall();</span>

<span class="nc" id="L691">		models.get(ComboBoxRendererHandler.class).uninstall();</span>
<span class="nc" id="L692">	}</span>

	@Override
	public void restoreModels(ModelMap models)
	{
<span class="nc" id="L697">		models.get(LabelAndFieldHandler.class).install();</span>
<span class="nc" id="L698">		models.get(ComboBoxRendererHandler.class).install();</span>
<span class="nc" id="L699">		models.get(ComboBoxModelHandler.class).install();</span>

<span class="nc" id="L701">		models.get(InfoPaneHandler.class).install();</span>
<span class="nc" id="L702">		models.get(LanguageTableModel.class).install();</span>
<span class="nc" id="L703">		models.get(StatTableModel.class).install();</span>
<span class="nc" id="L704">		models.get(ClassLevelTableModel.class).install();</span>
<span class="nc" id="L705">		models.get(TodoListHandler.class).install();</span>
<span class="nc" id="L706">		models.get(GenerateRollsAction.class).install();</span>
<span class="nc" id="L707">		models.get(HPHandler.class).install();</span>

<span class="nc" id="L709">		random.setAction(models.get(RandomNameAction.class));</span>
<span class="nc" id="L710">		generateRollsButton.setAction(models.get(GenerateRollsAction.class));</span>
<span class="nc" id="L711">		rollMethodButton.setAction(models.get(RollMethodAction.class));</span>
<span class="nc" id="L712">		createMonsterButton.setAction(models.get(CreateMonsterAction.class));</span>
<span class="nc" id="L713">		AddLevelsAction addLevelsAction = models.get(AddLevelsAction.class);</span>
<span class="nc" id="L714">		addLevelsButton.setAction(addLevelsAction);</span>
<span class="nc" id="L715">		addLevelsField.setAction(addLevelsAction);</span>
<span class="nc" id="L716">		RemoveLevelsAction removeLevelsAction = models.get(RemoveLevelsAction.class);</span>
<span class="nc" id="L717">		removeLevelsButton.setAction(removeLevelsAction);</span>
<span class="nc" id="L718">		removeLevelsField.setAction(removeLevelsAction);</span>
<span class="nc" id="L719">		ExpAddAction expAddAction = models.get(ExpAddAction.class);</span>
<span class="nc" id="L720">		expaddButton.setAction(expAddAction);</span>
<span class="nc" id="L721">		expmodField.setAction(expAddAction);</span>
<span class="nc" id="L722">		expsubtractButton.setAction(models.get(ExpSubtractAction.class));</span>
<span class="nc" id="L723">		addLevelsAction.install();</span>

<span class="nc" id="L725">		resetBasicsPanel();</span>
<span class="nc" id="L726">	}</span>

	private class LabelAndFieldHandler
	{

		private final LabelHandler statTotalLabelHandler;
		private final LabelHandler statTotalHandler;
		private final LabelHandler modTotalLabelHandler;
		private final LabelHandler modTotalHandler;
		
		/**
		 * Field for Character Name
		 */
		private final ManagedField charNameHandler;

		/**
		 * Field for PlayerName
		 */
		private final ManagedField playerNameHandler;

		/**
		 * Field for Tab Name
		 */
		private final ManagedField tabNameHandler;
		private final ManagedField ageHandler;
		private final ManagedField expHandler;
		private final ManagedField nextLevelHandler;

		LabelAndFieldHandler(final CharacterFacade character)
<span class="nc" id="L755">		{</span>

<span class="nc" id="L757">			statTotalLabelHandler = new LabelHandler(statTotalLabel, character.getStatTotalLabelTextRef());</span>
<span class="nc" id="L758">			statTotalHandler = new LabelHandler(statTotal, character.getStatTotalTextRef());</span>
<span class="nc" id="L759">			modTotalLabelHandler = new LabelHandler(modTotalLabel, character.getModTotalLabelTextRef());</span>
<span class="nc" id="L760">			modTotalHandler = new LabelHandler(modTotal, character.getModTotalTextRef());</span>

			//Manages the character name text field
<span class="nc" id="L763">			charNameHandler = new TextFieldHandler(characterNameField, character.getNameRef())</span>
<span class="nc" id="L764">			{</span>

				@Override
				protected void textChanged(String text)
				{
<span class="nc" id="L769">					character.setName(text);</span>
<span class="nc" id="L770">				}</span>

			};

			//Manages the player name text field.
<span class="nc" id="L775">			playerNameHandler = new TextFieldHandler(playerNameField, character.getPlayersNameRef())</span>
<span class="nc" id="L776">			{</span>

				@Override
				protected void textChanged(String text)
				{
<span class="nc" id="L781">					character.setPlayersName(text);</span>
<span class="nc" id="L782">				}</span>

			};
			//Manages the tab name text field.
<span class="nc" id="L786">			tabNameHandler = new TextFieldHandler(tabLabelField, character.getTabNameRef())</span>
<span class="nc" id="L787">			{</span>

				@Override
				protected void textChanged(String text)
				{
<span class="nc" id="L792">					character.setTabName(text);</span>
<span class="nc" id="L793">				}</span>

			};

			/*
			 * Handler for the Age field. This listens for and processes both
			 * changes to the value from the character and modifications to the
			 * field made by the user.
			 */
<span class="nc" id="L802">			ageHandler = new FormattedFieldHandler(ageField, character.getAgeRef())</span>
<span class="nc" id="L803">			{</span>
				@Override
				protected void valueChanged(int value)
				{
<span class="nc" id="L807">					character.setAge(value);</span>
<span class="nc" id="L808">				}</span>

			};

			/*
			 * Handler for the Current Experience field. This listens for and
			 * processes both changes to the value from the character and
			 * modifications to the field made by the user.
			 */
<span class="nc" id="L817">			expHandler = new FormattedFieldHandler(expField, character.getXPRef())</span>
<span class="nc" id="L818">			{</span>
				@Override
				protected void valueChanged(int value)
				{
<span class="nc" id="L822">					character.setXP(value);</span>
<span class="nc" id="L823">				}</span>

			};

			/*
			 * Handler for the Next Level field. This is a read-only field so
			 * the handler only listens for changes to the value from the
			 * character.
			 */
<span class="nc" id="L832">			nextLevelHandler = new FormattedFieldHandler(nextlevelField, character.getXPForNextLevelRef())</span>
<span class="nc" id="L833">			{</span>

				@Override
				protected void valueChanged(int value)
				{
					//This will never be called
<span class="nc" id="L839">				}</span>

			};
<span class="nc" id="L842">		}</span>

		public void install()
		{
<span class="nc" id="L846">			charNameHandler.install();</span>
<span class="nc" id="L847">			playerNameHandler.install();</span>
<span class="nc" id="L848">			tabNameHandler.install();</span>
<span class="nc" id="L849">			ageHandler.install();</span>
<span class="nc" id="L850">			expHandler.install();</span>
<span class="nc" id="L851">			nextLevelHandler.install();</span>
<span class="nc" id="L852">			statTotalLabelHandler.install();</span>
<span class="nc" id="L853">			statTotalHandler.install();</span>
<span class="nc" id="L854">			modTotalLabelHandler.install();</span>
<span class="nc" id="L855">			modTotalHandler.install();</span>
<span class="nc" id="L856">		}</span>

		public void uninstall()
		{
<span class="nc" id="L860">			charNameHandler.uninstall();</span>
<span class="nc" id="L861">			playerNameHandler.uninstall();</span>
<span class="nc" id="L862">			tabNameHandler.uninstall();</span>
<span class="nc" id="L863">			ageHandler.uninstall();</span>
<span class="nc" id="L864">			expHandler.uninstall();</span>
<span class="nc" id="L865">			nextLevelHandler.uninstall();</span>
<span class="nc" id="L866">			statTotalLabelHandler.uninstall();</span>
<span class="nc" id="L867">			statTotalHandler.uninstall();</span>
<span class="nc" id="L868">			modTotalLabelHandler.uninstall();</span>
<span class="nc" id="L869">			modTotalHandler.uninstall();</span>
<span class="nc" id="L870">		}</span>
	}

	private class ComboBoxModelHandler
	{
		private final CharacterFacade character;
		private final CharacterComboBoxModel&lt;Gender&gt; genderModel;
		private final CharacterComboBoxModel&lt;Handed&gt; handsModel;
		private CharacterComboBoxModel&lt;PCAlignment&gt; alignmentModel;
		private CharacterComboBoxModel&lt;Deity&gt; deityModel;
		private final DeferredCharacterComboBoxModel&lt;Race&gt; raceModel;
		private final CharacterComboBoxModel&lt;String&gt; ageCatModel;
		private final FacadeComboBoxModel&lt;PCClass&gt; classModel;
		private final CharacterComboBoxModel&lt;String&gt; xpTableModel;
		private final CharacterComboBoxModel&lt;String&gt; characterTypeModel;

		ComboBoxModelHandler(final CharacterFacade character)
<span class="nc" id="L887">		{</span>
<span class="nc" id="L888">			this.character = character;</span>
<span class="nc" id="L889">			DataSetFacade dataset = character.getDataSet();</span>

			//initialize character type model
<span class="nc" id="L892">			characterTypeModel =</span>
<span class="nc" id="L893">					new CharacterComboBoxModel&lt;&gt;(dataset.getCharacterTypes(), character.getCharacterTypeRef())</span>
<span class="nc" id="L894">					{</span>

						@Override
						public void setSelectedItem(Object anItem)
						{
<span class="nc" id="L899">							character.setCharacterType((String) anItem);</span>
<span class="nc" id="L900">						}</span>

					};

			//initialize gender model
<span class="nc" id="L905">			genderModel =</span>
<span class="nc" id="L906">					new CharacterComboBoxModel&lt;&gt;(character.getAvailableGenders(), character.getGenderRef())</span>
<span class="nc" id="L907">					{</span>

						@Override
						public void setSelectedItem(Object anItem)
						{
<span class="nc" id="L912">							character.setGender((Gender) anItem);</span>
<span class="nc" id="L913">						}</span>

					};

			//initialize handed model
<span class="nc" id="L918">			handsModel =</span>
<span class="nc" id="L919">					new CharacterComboBoxModel&lt;&gt;(character.getAvailableHands(), character.getHandedRef())</span>
<span class="nc" id="L920">					{</span>

						@Override
						public void setSelectedItem(Object anItem)
						{
<span class="nc" id="L925">							character.setHanded((Handed) anItem);</span>
<span class="nc" id="L926">						}</span>

					};

<span class="nc bnc" id="L930" title="All 2 branches missed.">			if (!dataset.getAlignments().isEmpty())</span>
			{
				//initialize alignment model
<span class="nc" id="L933">				alignmentModel =</span>
<span class="nc" id="L934">						new CharacterComboBoxModel&lt;&gt;(dataset.getAlignments(), character.getAlignmentRef())</span>
<span class="nc" id="L935">						{</span>

							@Override
							public void setSelectedItem(Object anItem)
							{
<span class="nc" id="L940">								character.setAlignment((PCAlignment) anItem);</span>
<span class="nc" id="L941">							}</span>

						};
			}

<span class="nc bnc" id="L946" title="All 2 branches missed.">			if (character.isFeatureEnabled(CControl.DOMAINFEATURE))</span>
			{
				//initialize deity model
<span class="nc" id="L949">				deityModel = new CharacterComboBoxModel&lt;&gt;(dataset.getDeities(), character.getDeityRef())</span>
<span class="nc" id="L950">				{</span>

					@Override
					public void setSelectedItem(Object anItem)
					{
<span class="nc" id="L955">						character.setDeity((Deity) anItem);</span>
<span class="nc" id="L956">					}</span>

				};
			}

			//initialize race model
<span class="nc" id="L962">			raceModel = new DeferredCharacterComboBoxModel&lt;&gt;(dataset.getRaces(), character.getRaceRef())</span>
<span class="nc" id="L963">			{</span>

				@Override
				public void commitSelectedItem(Object anItem)
				{
<span class="nc" id="L968">					character.setRace((Race) anItem);</span>
<span class="nc" id="L969">				}</span>

			};

			//initialize age category model
<span class="nc" id="L974">			ageCatModel = new CharacterComboBoxModel&lt;&gt;(</span>
<span class="nc" id="L975">					character.getAgeCategories(),</span>
<span class="nc" id="L976">					character.getAgeCategoryRef()</span>
			)
<span class="nc" id="L978">			{</span>

				@Override
				public void setSelectedItem(Object anItem)
				{
<span class="nc" id="L983">					character.setAgeCategory((String) anItem);</span>
<span class="nc" id="L984">				}</span>

			};

			//initialize XP table model
<span class="nc" id="L989">			xpTableModel = new CharacterComboBoxModel&lt;&gt;(dataset.getXPTableNames(), character.getXPTableNameRef())</span>
<span class="nc" id="L990">			{</span>

				@Override
				public void setSelectedItem(Object anItem)
				{
<span class="nc" id="L995">					character.setXPTable((String) anItem);</span>
<span class="nc" id="L996">				}</span>

			};

<span class="nc" id="L1000">			classModel = new FacadeComboBoxModel&lt;&gt;(dataset.getClasses(), null);</span>
<span class="nc" id="L1001">		}</span>

		public void install()
		{
<span class="nc" id="L1005">			characterTypeComboBox.setModel(characterTypeModel);</span>
<span class="nc" id="L1006">			genderComboBox.setModel(genderModel);</span>
<span class="nc" id="L1007">			handsComboBox.setModel(handsModel);</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">			if (character.getDataSet().getAlignments().isEmpty())</span>
			{
<span class="nc" id="L1010">				alignmentComboBox.setVisible(false);</span>
			}
			else
			{
<span class="nc" id="L1014">				alignmentComboBox.setModel(alignmentModel);</span>
<span class="nc" id="L1015">				alignmentComboBox.setVisible(true);</span>
			}
<span class="nc" id="L1017">			boolean hasDeityDomain = character.isFeatureEnabled(CControl.DOMAINFEATURE);</span>
<span class="nc" id="L1018">			deityComboBox.setVisible(hasDeityDomain);</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">			if (hasDeityDomain)</span>
			{
<span class="nc" id="L1021">				deityComboBox.setModel(deityModel);</span>
			}
<span class="nc" id="L1023">			raceComboBox.setModel(raceModel);</span>
<span class="nc" id="L1024">			raceComboBox.addFocusListener(raceModel);</span>
<span class="nc" id="L1025">			ageComboBox.setModel(ageCatModel);</span>
<span class="nc" id="L1026">			classComboBox.setModel(classModel);</span>
<span class="nc" id="L1027">			xpTableComboBox.setModel(xpTableModel);</span>
<span class="nc" id="L1028">		}</span>

		public void uninstall()
		{
<span class="nc" id="L1032">			raceComboBox.removeFocusListener(raceModel);</span>
<span class="nc" id="L1033">		}</span>
	}

	private class ComboBoxRendererHandler
	{

		private final CharacterFacade character;

		ComboBoxRendererHandler(CharacterFacade character)
<span class="nc" id="L1042">		{</span>
<span class="nc" id="L1043">			this.character = character;</span>
<span class="nc" id="L1044">		}</span>

		public void install()
		{
<span class="nc" id="L1048">			infoBoxRenderer.setCharacter(character);</span>
<span class="nc" id="L1049">			classBoxRenderer.setCharacter(character);</span>
<span class="nc" id="L1050">		}</span>

		public void uninstall()
		{
<span class="nc" id="L1054">			infoBoxRenderer.setCharacter(null);</span>
<span class="nc" id="L1055">			classBoxRenderer.setCharacter(null);</span>
<span class="nc" id="L1056">		}</span>
	}

	private static class CharacterComboBoxRenderer extends DefaultListCellRenderer
	{

		protected CharacterFacade character;

		public void setCharacter(CharacterFacade character)
		{
<span class="nc" id="L1066">			this.character = character;</span>
<span class="nc" id="L1067">		}</span>

		@Override
		public Component getListCellRendererComponent(JList list, Object value, int index, boolean isSelected,
			boolean cellHasFocus)
		{
<span class="nc" id="L1073">			super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">			setToolTipText(value == null ? null : value.toString());</span>
<span class="nc" id="L1075">			return this;</span>
		}

	}

	private static class InfoBoxRenderer extends CharacterComboBoxRenderer
	{

		@Override
		public Component getListCellRendererComponent(JList list, Object value, int index, boolean isSelected,
			boolean cellHasFocus)
		{
<span class="nc" id="L1087">			super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);</span>
<span class="nc bnc" id="L1088" title="All 6 branches missed.">			if ((character != null) &amp;&amp; (value instanceof InfoFacade) &amp;&amp; !character.isQualifiedFor((InfoFacade) value))</span>
			{
<span class="nc bnc" id="L1090" title="All 2 branches missed.">				if (index == -1)</span>
				{// this is a hack to prevent the combobox from overwriting the text color
<span class="nc" id="L1092">					setText(&quot;&quot;);</span>
<span class="nc" id="L1093">					setIcon(new SimpleTextIcon(list, value.toString(),</span>
<span class="nc" id="L1094">							ColorUtilty.colorToAWTColor(UIPropertyContext.getNotQualifiedColor())));</span>
				}
				else
				{
<span class="nc" id="L1098">					setForeground(ColorUtilty.colorToAWTColor(UIPropertyContext.getNotQualifiedColor()));</span>
				}
			}
<span class="nc" id="L1101">			return this;</span>
		}

	}

	private static class ClassBoxRenderer extends CharacterComboBoxRenderer
	{

		@Override
		public Component getListCellRendererComponent(JList list, Object value, int index, boolean isSelected,
			boolean cellHasFocus)
		{
<span class="nc" id="L1113">			super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);</span>
<span class="nc bnc" id="L1114" title="All 4 branches missed.">			if (value instanceof PCClass &amp;&amp; !character.isQualifiedFor((PCClass) value))</span>
			{
<span class="nc bnc" id="L1116" title="All 2 branches missed.">				if (index == -1)</span>
				{// this is a hack to prevent the combobox from overwriting the text color
<span class="nc" id="L1118">					setText(&quot;&quot;);</span>
<span class="nc" id="L1119">					setIcon(new SimpleTextIcon(list, value.toString(),</span>
<span class="nc" id="L1120">							ColorUtilty.colorToAWTColor(UIPropertyContext.getNotQualifiedColor())));</span>
				}
				else
				{
<span class="nc" id="L1124">					setForeground(ColorUtilty.colorToAWTColor(UIPropertyContext.getNotQualifiedColor()));</span>
				}
			}
<span class="nc" id="L1127">			return this;</span>
		}

	}

	private class HPHandler extends AbstractAction implements ReferenceListener&lt;Integer&gt;
	{

		private final CharacterFacade character;
		private final ReferenceFacade&lt;Integer&gt; ref;

		HPHandler(CharacterFacade character)
<span class="nc" id="L1139">		{</span>
<span class="nc" id="L1140">			this.character = character;</span>
<span class="nc" id="L1141">			this.ref = character.getTotalHPRef();</span>
<span class="nc" id="L1142">			putValue(NAME, LanguageBundle.getString(&quot;in_edit&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1143">		}</span>

		public void install()
		{
<span class="nc" id="L1147">			hpButton.setAction(this);</span>
<span class="nc" id="L1148">			totalHPLabel.setText(ref.get().toString());</span>
<span class="nc" id="L1149">			ref.addReferenceListener(this);</span>
<span class="nc" id="L1150">		}</span>

		public void uninstall()
		{
<span class="nc" id="L1154">			ref.removeReferenceListener(this);</span>
<span class="nc" id="L1155">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1160">			CharacterHPDialog.showHPDialog(SummaryInfoTab.this, character);</span>
<span class="nc" id="L1161">		}</span>

		@Override
		public void referenceChanged(ReferenceEvent&lt;Integer&gt; e)
		{
<span class="nc" id="L1166">			totalHPLabel.setText(ref.get().toString());</span>
<span class="nc" id="L1167">		}</span>

	}

	private static class RandomNameAction extends AbstractAction
	{

		private final CharacterFacade character;
		private final JFrame frame;

		RandomNameAction(CharacterFacade character, JFrame frame)
<span class="nc" id="L1178">		{</span>
<span class="nc" id="L1179">			this.character = character;</span>
<span class="nc" id="L1180">			this.frame = frame;</span>
<span class="nc" id="L1181">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
			String gender =
<span class="nc bnc" id="L1187" title="All 2 branches missed.">					character.getGenderRef().get()</span>
<span class="nc" id="L1188">					!= null ? character.getGenderRef().get().toString() : &quot;&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1189">			RandomNameDialog dialog = new RandomNameDialog(frame, gender);</span>
<span class="nc" id="L1190">			dialog.setVisible(true);</span>
<span class="nc" id="L1191">			String chosenName = dialog.getChosenName();</span>
<span class="nc bnc" id="L1192" title="All 4 branches missed.">			if (chosenName != null &amp;&amp; !chosenName.isEmpty()</span>
<span class="nc bnc" id="L1193" title="All 2 branches missed.">				&amp;&amp; !chosenName.equals(LanguageBundle.getString(&quot;in_rndNmDefault&quot;))) //$NON-NLS-1$</span>
			{
<span class="nc" id="L1195">				character.setName(chosenName);</span>
			}
<span class="nc" id="L1197">			String chosenGender = dialog.getGender();</span>
<span class="nc" id="L1198">			character.setGender(chosenGender);</span>
<span class="nc" id="L1199">		}</span>

	}

	/**
	 * Handler for actions from the generate rolls button. Also defines the
	 * appearance of the button.
	 */
	private static final class GenerateRollsAction extends AbstractAction
			implements ListListener&lt;CharacterLevelFacade&gt;, ReferenceListener&lt;Integer&gt;
	{

		private final CharacterFacade character;

		GenerateRollsAction(CharacterFacade character)
<span class="nc" id="L1214">		{</span>
<span class="nc" id="L1215">			this.character = character;</span>
<span class="nc" id="L1216">			putValue(NAME, LanguageBundle.getString(&quot;in_sumGenerate_Rolls&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1217">			update();</span>
<span class="nc" id="L1218">		}</span>

		/**
		 * Attach the handler to the screen button. e.g. When the character is
		 * made active.
		 */
		public void install()
		{
			// Listen to the total levels
<span class="nc" id="L1227">			character.getCharacterLevelsFacade().addListListener(this);</span>

			// Listen to the roll method
<span class="nc" id="L1230">			character.getRollMethodRef().addReferenceListener(this);</span>
<span class="nc" id="L1231">		}</span>

		/**
		 * Detach the handler from the on screen button. e.g. when the character
		 * is no longer being displayed.
		 */
		public void uninstall()
		{
<span class="nc" id="L1239">			character.getCharacterLevelsFacade().removeListListener(this);</span>
<span class="nc" id="L1240">			character.getRollMethodRef().removeReferenceListener(this);</span>
<span class="nc" id="L1241">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1246">			character.rollStats();</span>
<span class="nc" id="L1247">		}</span>

		/**
		 * Update the state of the button.
		 */
		public void update()
		{
<span class="nc" id="L1254">			setEnabled(character.isStatRollEnabled());</span>
<span class="nc" id="L1255">		}</span>

		@Override
		public void elementAdded(ListEvent&lt;CharacterLevelFacade&gt; e)
		{
<span class="nc" id="L1260">			update();</span>
<span class="nc" id="L1261">		}</span>

		@Override
		public void elementRemoved(ListEvent&lt;CharacterLevelFacade&gt; e)
		{
<span class="nc" id="L1266">			update();</span>
<span class="nc" id="L1267">		}</span>

		@Override
		public void elementsChanged(ListEvent&lt;CharacterLevelFacade&gt; e)
		{
<span class="nc" id="L1272">			update();</span>
<span class="nc" id="L1273">		}</span>

		@Override
		public void referenceChanged(ReferenceEvent&lt;Integer&gt; e)
		{
<span class="nc" id="L1278">			update();</span>
<span class="nc" id="L1279">		}</span>

		@Override
		public void elementModified(ListEvent&lt;CharacterLevelFacade&gt; e)
		{
<span class="nc" id="L1284">			update();</span>
<span class="nc" id="L1285">		}</span>

	}

	/**
	 * Handler for actions from the generate rolls button. Also defines the
	 * appearance of the button.
	 */
	private static final class RollMethodAction extends AbstractAction
	{

		private final JFrame parent;
		private final CharacterFacade character;

		private RollMethodAction(CharacterFacade character, JFrame parent)
<span class="nc" id="L1300">		{</span>
<span class="nc" id="L1301">			putValue(NAME, LanguageBundle.getString(&quot;in_sumRoll_Method&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1302">			putValue(SHORT_DESCRIPTION, LanguageBundle.getString(&quot;in_sumRoll_Method_Tip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1303">			this.parent = parent;</span>
<span class="nc" id="L1304">			this.character = character;</span>
<span class="nc" id="L1305">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1310">			CharacterStatsPanel charStatsPanel = new CharacterStatsPanel();</span>
<span class="nc" id="L1311">			SinglePrefDialog prefsDialog = new SinglePrefDialog(parent, charStatsPanel);</span>
<span class="nc" id="L1312">			prefsDialog.setLocationRelativeTo(parent);</span>
<span class="nc" id="L1313">			prefsDialog.setVisible(true);</span>
<span class="nc" id="L1314">			character.refreshRollMethod();</span>
<span class="nc" id="L1315">		}</span>

	}

	private static class CreateMonsterAction extends AbstractAction
	{

		private final CharacterFacade character;
		private final JFrame frame;

		CreateMonsterAction(CharacterFacade character, JFrame frame)
<span class="nc" id="L1326">		{</span>
<span class="nc" id="L1327">			putValue(NAME, LanguageBundle.getString(&quot;in_sumCreateMonster&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1328">			putValue(SHORT_DESCRIPTION, LanguageBundle.getString(&quot;in_sumCreateMonster_Tip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1329">			this.character = character;</span>
<span class="nc" id="L1330">			this.frame = frame;</span>
<span class="nc" id="L1331">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1336">			KitSelectionDialog kitDialog = new KitSelectionDialog(frame, character);</span>
<span class="nc" id="L1337">			kitDialog.setLocationRelativeTo(frame);</span>
<span class="nc" id="L1338">			kitDialog.setVisible(true);</span>
<span class="nc" id="L1339">		}</span>

	}

	private class AddLevelsAction extends AbstractAction
	{

		private final CharacterFacade character;

		AddLevelsAction(CharacterFacade character)
<span class="nc" id="L1349">		{</span>
<span class="nc" id="L1350">			this.character = character;</span>
<span class="nc" id="L1351">			putValue(SMALL_ICON, new SignIcon(Sign.Plus));</span>
<span class="nc" id="L1352">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1357">			PCClass c = (PCClass) classComboBox.getSelectedItem();</span>
<span class="nc bnc" id="L1358" title="All 2 branches missed.">			if (c != null)</span>
			{
<span class="nc" id="L1360">				Number levels = (Number) addLevelsField.getValue();</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">				if (levels.intValue() &gt;= 0)</span>
				{
<span class="nc" id="L1363">					PCClass[] classes = new PCClass[levels.intValue()];</span>
<span class="nc" id="L1364">					Arrays.fill(classes, c);</span>
<span class="nc" id="L1365">					character.addCharacterLevels(classes);</span>
				}
			}
<span class="nc" id="L1368">		}</span>

		public void install()
		{
<span class="nc" id="L1372">			CharacterLevelsFacade characterLevelsFacade = character.getCharacterLevelsFacade();</span>
<span class="nc" id="L1373">			int maxLvl = characterLevelsFacade.getSize();</span>
<span class="nc bnc" id="L1374" title="All 2 branches missed.">			if (maxLvl &gt; 0)</span>
			{
<span class="nc" id="L1376">				PCClass classTaken =</span>
<span class="nc" id="L1377">						characterLevelsFacade.getClassTaken(characterLevelsFacade.getElementAt(maxLvl - 1));</span>
<span class="nc" id="L1378">				classComboBox.setSelectedItem(classTaken);</span>
			}
<span class="nc" id="L1380">		}</span>
	}

	private class RemoveLevelsAction extends AbstractAction
	{

		private final CharacterFacade character;

		RemoveLevelsAction(CharacterFacade character)
<span class="nc" id="L1389">		{</span>
<span class="nc" id="L1390">			this.character = character;</span>
<span class="nc" id="L1391">			putValue(SMALL_ICON, new SignIcon(Sign.Minus));</span>
<span class="nc" id="L1392">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1397">			Number levels = (Number) removeLevelsField.getValue();</span>
<span class="nc" id="L1398">			character.removeCharacterLevels(levels.intValue());</span>
<span class="nc" id="L1399">		}</span>

	}

	/**
	 * Handler for actions from the add experience button. Also defines the
	 * appearance of the button.
	 */
	private class ExpAddAction extends AbstractAction
	{

		private final CharacterFacade character;

		ExpAddAction(CharacterFacade character)
<span class="nc" id="L1413">		{</span>
<span class="nc" id="L1414">			this.character = character;</span>
<span class="nc" id="L1415">			putValue(SMALL_ICON, new SignIcon(Sign.Plus));</span>
<span class="nc" id="L1416">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1421">			Object value = expmodField.getValue();</span>
<span class="nc bnc" id="L1422" title="All 2 branches missed.">			if (value == null)</span>
			{
<span class="nc" id="L1424">				return;</span>
			}
<span class="nc" id="L1426">			int modVal = ((Number) value).intValue();</span>
<span class="nc" id="L1427">			character.adjustXP(modVal);</span>
<span class="nc" id="L1428">		}</span>

	}

	/**
	 * Handler for actions from the subtract experience button. Also defines the
	 * appearance of the button.
	 */
	private class ExpSubtractAction extends AbstractAction
	{

		private final CharacterFacade character;

		ExpSubtractAction(CharacterFacade character)
<span class="nc" id="L1442">		{</span>
<span class="nc" id="L1443">			this.character = character;</span>
<span class="nc" id="L1444">			putValue(SMALL_ICON, new SignIcon(Sign.Minus));</span>
<span class="nc" id="L1445">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1450">			Object value = expmodField.getValue();</span>
<span class="nc bnc" id="L1451" title="All 2 branches missed.">			if (value == null)</span>
			{
<span class="nc" id="L1453">				return;</span>
			}
<span class="nc" id="L1455">			int modVal = ((Number) value).intValue();</span>
<span class="nc" id="L1456">			character.adjustXP(modVal * -1);</span>
<span class="nc" id="L1457">		}</span>

	}

	/**
	 * The Class {@code LabelHandler} manages the text displayed in a
	 * JLabel field for a character. The text will be updated each time a
	 * reference is updated. The handler also knows how to react to install and
	 * uninstall actions when the displayed character changes.
	 */
	private static class LabelHandler implements ReferenceListener&lt;String&gt;
	{

<span class="nc" id="L1470">		private ReferenceFacade&lt;String&gt; reference = null;</span>
		private final JLabel label;

		/**
		 * Create a new label handler.
		 *
		 * @param label The label to be managed
		 * @param ref   the ReferenceFacade that this handler should listen to.
		 */
		LabelHandler(JLabel label, ReferenceFacade&lt;String&gt; ref)
<span class="nc" id="L1480">		{</span>
<span class="nc" id="L1481">			this.label = label;</span>
<span class="nc" id="L1482">			setReference(ref);</span>
<span class="nc" id="L1483">		}</span>

		/**
		 * @param ref The new reference to be watched
		 */
		private void setReference(ReferenceFacade&lt;String&gt; ref)
		{
<span class="nc bnc" id="L1490" title="All 2 branches missed.">			if (reference != null)</span>
			{
<span class="nc" id="L1492">				reference.removeReferenceListener(this);</span>
			}
<span class="nc" id="L1494">			reference = ref;</span>
<span class="nc bnc" id="L1495" title="All 2 branches missed.">			if (reference != null)</span>
			{
<span class="nc" id="L1497">				reference.addReferenceListener(this);</span>
<span class="nc" id="L1498">				label.setText(reference.get());</span>
			}
<span class="nc" id="L1500">		}</span>

		/**
		 * Attach the handler to the on-screen field. e.g. When the character is
		 * made active.
		 */
		public void install()
		{
<span class="nc" id="L1508">			reference.addReferenceListener(this);</span>
<span class="nc" id="L1509">			label.setText(reference.get());</span>
<span class="nc" id="L1510">		}</span>

		/**
		 * Detach the handler from the on-screen field. e.g. when the character
		 * is no longer being displayed.
		 */
		public void uninstall()
		{
<span class="nc" id="L1518">			reference.removeReferenceListener(this);</span>
<span class="nc" id="L1519">		}</span>

		@Override
		public void referenceChanged(ReferenceEvent&lt;String&gt; e)
		{
<span class="nc" id="L1524">			label.setText(e.getNewReference());</span>
<span class="nc" id="L1525">		}</span>

	}

	/**
	 * The Class {@code TodoListHandler} manages the text displayed in the
	 * things to be done panel for the character. The text will be updated each
	 * time the character's todo list changes. The handler also knows how to
	 * react to install and uninstall actions when the displayed character
	 * changes.
	 */
	@SuppressWarnings(&quot;TodoComment&quot;)
	private class TodoListHandler implements ListListener&lt;TodoFacade&gt;, HyperlinkListener
	{

		private final CharacterFacade character;
<span class="nc" id="L1541">		private String lastDest = &quot;&quot;; //$NON-NLS-1$</span>

		/**
		 * Create a new instance for the character.
		 *
		 * @param character The character being managed.
		 */
		TodoListHandler(CharacterFacade character)
<span class="nc" id="L1549">		{</span>
<span class="nc" id="L1550">			this.character = character;</span>
<span class="nc" id="L1551">		}</span>

		/**
		 * Attach the handler to the on-screen field. e.g. When the character is
		 * made active.
		 */
		public void install()
		{
<span class="nc" id="L1559">			character.getTodoList().addListListener(this);</span>
<span class="nc" id="L1560">			todoPane.addHyperlinkListener(this);</span>
<span class="nc" id="L1561">			lastDest = &quot;&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1562">			refreshTodoList();</span>
<span class="nc" id="L1563">		}</span>

		/**
		 * Detach the handler from the on-screen field. e.g. when the character
		 * is no longer being displayed.
		 */
		public void uninstall()
		{
<span class="nc" id="L1571">			todoPane.removeHyperlinkListener(this);</span>
<span class="nc" id="L1572">			character.getTodoList().removeListListener(this);</span>
<span class="nc" id="L1573">		}</span>

		@Override
		public void elementAdded(ListEvent&lt;TodoFacade&gt; e)
		{
<span class="nc" id="L1578">			refreshTodoList();</span>
<span class="nc" id="L1579">		}</span>

		@Override
		public void elementRemoved(ListEvent&lt;TodoFacade&gt; e)
		{
<span class="nc" id="L1584">			refreshTodoList();</span>
<span class="nc" id="L1585">		}</span>

		@Override
		public void elementsChanged(ListEvent&lt;TodoFacade&gt; e)
		{
<span class="nc" id="L1590">			refreshTodoList();</span>
<span class="nc" id="L1591">		}</span>

		@Override
		public void elementModified(ListEvent&lt;TodoFacade&gt; e)
		{
<span class="nc" id="L1596">			refreshTodoList();</span>
<span class="nc" id="L1597">		}</span>

		/**
		 * Recreate the &quot;Things to be Done&quot; list based on the character's todo
		 * list.
		 */
		private void refreshTodoList()
		{
<span class="nc" id="L1605">			StringBuilder todoText = new StringBuilder(&quot;&lt;html&gt;&lt;body&gt;&quot;); //$NON-NLS-1$</span>

<span class="nc" id="L1607">			int i = 1;</span>
<span class="nc" id="L1608">			Collection&lt;TodoFacade&gt; sortedTodos = new TreeSet&lt;&gt;();</span>
<span class="nc" id="L1609">			character.getTodoList().iterator().forEachRemaining(sortedTodos::add);</span>

<span class="nc bnc" id="L1611" title="All 2 branches missed.">			for (TodoFacade item : sortedTodos)</span>
			{
<span class="nc" id="L1613">				todoText.append(i++).append(&quot;. &quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1614">				String fieldLoc = item.getTab().name() + &quot;/&quot; + item.getFieldName(); //$NON-NLS-1$</span>
<span class="nc bnc" id="L1615" title="All 2 branches missed.">				if (StringUtils.isNotEmpty(item.getSubTabName()))</span>
				{
<span class="nc" id="L1617">					fieldLoc += &quot;/&quot; + item.getSubTabName(); //$NON-NLS-1$</span>
				}
<span class="nc" id="L1619">				todoText.append(&quot;&lt;a href=\&quot;&quot;).append(fieldLoc).append(&quot;\&quot;&gt;&quot;); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc bnc" id="L1620" title="All 2 branches missed.">				if (item.getMessageKey().startsWith(&quot;in_&quot;)) //$NON-NLS-1$</span>
				{
<span class="nc" id="L1622">					todoText.append(LanguageBundle.getFormattedString(item.getMessageKey(), item.getFieldName()));</span>
				}
				else
				{
<span class="nc" id="L1626">					todoText.append(item.getMessageKey());</span>
				}
<span class="nc" id="L1628">				todoText.append(&quot;&lt;/a&gt;&lt;br&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1629">			}</span>
<span class="nc" id="L1630">			todoText.append(&quot;&lt;/body&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1631">			todoPane.setText(todoText.toString());</span>
<span class="nc" id="L1632">		}</span>

		@Override
		public void hyperlinkUpdate(HyperlinkEvent e)
		{
<span class="nc bnc" id="L1637" title="All 2 branches missed.">			if (e.getEventType() == HyperlinkEvent.EventType.ACTIVATED)</span>
			{
				// We get two messages on a click, so ignore duplicates
<span class="nc bnc" id="L1640" title="All 2 branches missed.">				if (lastDest.equals(e.getDescription()))</span>
				{
<span class="nc" id="L1642">					lastDest = &quot;&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1643">					return;</span>
				}
<span class="nc" id="L1645">				lastDest = e.getDescription();</span>
<span class="nc" id="L1646">				firePropertyChange(TodoFacade.SWITCH_TABS, &quot;&quot;, e.getDescription()); //$NON-NLS-1$</span>
			}
<span class="nc" id="L1648">		}</span>

	}

<span class="nc" id="L1652">	private class SummaryTabFocusTraversalPolicy extends LayoutFocusTraversalPolicy</span>
	{

		@Override
		public Component getComponentAfter(Container aContainer, Component aComponent)
		{
<span class="nc bnc" id="L1658" title="All 2 branches missed.">			if (aComponent == deityComboBox)</span>
			{
<span class="nc" id="L1660">				int column = statsTable.getColumn(StatTableModel.EDITABLE_COLUMN_ID).getModelIndex();</span>
<span class="nc" id="L1661">				statsTable.editCellAt(0, column);</span>
<span class="nc" id="L1662">				JSpinner spinner = (JSpinner) statsTable.getEditorComponent();</span>
<span class="nc" id="L1663">				return ((JSpinner.DefaultEditor) spinner.getEditor()).getTextField();</span>
			}
<span class="nc" id="L1665">			return super.getComponentAfter(aContainer, aComponent);</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>