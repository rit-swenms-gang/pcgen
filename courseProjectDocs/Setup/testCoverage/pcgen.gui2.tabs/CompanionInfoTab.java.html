<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CompanionInfoTab.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.tabs</a> &gt; <span class="el_source">CompanionInfoTab.java</span></div><h1>CompanionInfoTab.java</h1><pre class="source lang-java linenums">/*
 * CompanionInfoTab.java Copyright 2012 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 *
 * This library is free software; you can redistribute it and/or modify it under the terms of the
 * GNU Lesser General Public License as published by the Free Software Foundation; either version 2.1
 * of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License along with this library;
 * if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA
 * 02111-1307 USA
 */
package pcgen.gui2.tabs;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Container;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Enumeration;
import java.util.List;
import java.util.Vector;

import javax.swing.AbstractAction;
import javax.swing.AbstractCellEditor;
import javax.swing.Action;
import javax.swing.JButton;
import javax.swing.JDialog;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.JTree;
import javax.swing.ListSelectionModel;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.event.TreeExpansionEvent;
import javax.swing.event.TreeExpansionListener;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableColumnModel;
import javax.swing.table.TableCellEditor;
import javax.swing.table.TableCellRenderer;
import javax.swing.table.TableColumn;
import javax.swing.tree.MutableTreeNode;
import javax.swing.tree.TreeNode;
import javax.swing.tree.TreePath;

import pcgen.facade.core.CharacterFacade;
import pcgen.facade.core.CompanionFacade;
import pcgen.facade.core.CompanionStubFacade;
import pcgen.facade.core.CompanionSupportFacade;
import pcgen.facade.util.DefaultListFacade;
import pcgen.facade.util.ListFacade;
import pcgen.facade.util.MapFacade;
import pcgen.facade.util.event.ListEvent;
import pcgen.facade.util.event.ListListener;
import pcgen.facade.util.event.MapEvent;
import pcgen.facade.util.event.MapListener;
import pcgen.facade.util.event.ReferenceEvent;
import pcgen.facade.util.event.ReferenceListener;
import pcgen.gui2.PCGenFrame;
import pcgen.gui2.filter.Filter;
import pcgen.gui2.filter.FilteredListFacade;
import pcgen.gui2.filter.FilteredTreeViewTable;
import pcgen.gui2.filter.SearchFilterPanel;
import pcgen.gui2.tabs.models.HtmlSheetSupport;
import pcgen.gui2.tools.FlippingSplitPane;
import pcgen.gui2.tools.Utility;
import pcgen.gui2.util.DisplayAwareTab;
import pcgen.gui2.util.JTableEx;
import pcgen.gui2.util.JTreeTable;
import pcgen.gui2.util.treetable.AbstractTreeTableModel;
import pcgen.gui2.util.treetable.DefaultTreeTableNode;
import pcgen.gui2.util.treetable.TreeTableModel;
import pcgen.gui2.util.treeview.DataView;
import pcgen.gui2.util.treeview.DataViewColumn;
import pcgen.gui2.util.treeview.TreeView;
import pcgen.gui2.util.treeview.TreeViewModel;
import pcgen.gui2.util.treeview.TreeViewPath;
import pcgen.gui3.JFXPanelFromResource;
import pcgen.gui3.SimpleHtmlPanelController;
import pcgen.system.CharacterManager;
import pcgen.system.ConfigurationSettings;
import pcgen.system.LanguageBundle;
import pcgen.util.Comparators;
import pcgen.util.Logging;
import pcgen.util.enumeration.Tab;

/**
 * This component allows a user to manage a character's companions (animal,
 * familiar, cohort, mount, etc).
 */
@SuppressWarnings(&quot;PMD.UseArrayListInsteadOfVector&quot;)
public class CompanionInfoTab extends FlippingSplitPane implements CharacterInfoTab, TodoHandler, DisplayAwareTab
{

	private final JTreeTable companionsTable;
	private final JFXPanelFromResource&lt;SimpleHtmlPanelController&gt; infoPane;
	private final JButton loadButton;
<span class="nc" id="L114">	private CompanionDialog companionDialog = null;</span>
	private Object selectedElement;

	CompanionInfoTab()
<span class="nc" id="L118">	{</span>
<span class="nc" id="L119">		this.companionsTable = new JTreeTable()</span>
<span class="nc" id="L120">		{</span>
			@Override
			protected void configureEnclosingScrollPane()
			{
				//We do nothing so the table is displayed without a header
<span class="nc" id="L125">			}</span>

		};
<span class="nc" id="L128">		this.infoPane = new JFXPanelFromResource&lt;&gt;(</span>
				SimpleHtmlPanelController.class,
				&quot;SimpleHtmlPanel.fxml&quot;
		);
<span class="nc" id="L132">		this.loadButton = new JButton();</span>
<span class="nc" id="L133">		initComponents();</span>
<span class="nc" id="L134">	}</span>

	private void initDialog()
	{
<span class="nc bnc" id="L138" title="All 2 branches missed.">		if (companionDialog == null)</span>
		{
<span class="nc" id="L140">			companionDialog = new CompanionDialog();</span>
		}
<span class="nc" id="L142">	}</span>

	private void initComponents()
	{
		{
<span class="nc" id="L147">			DefaultTableColumnModel model = new DefaultTableColumnModel();</span>
<span class="nc" id="L148">			TableColumn column = new TableColumn(0);</span>
<span class="nc" id="L149">			column.setResizable(true);</span>
<span class="nc" id="L150">			model.addColumn(column);</span>

<span class="nc" id="L152">			column = new TableColumn(1, 120, new ButtonCellRenderer(), null);</span>
<span class="nc" id="L153">			column.setMaxWidth(120);</span>
<span class="nc" id="L154">			column.setResizable(false);</span>
<span class="nc" id="L155">			model.addColumn(column);</span>

<span class="nc" id="L157">			companionsTable.setAutoResizeMode(JTable.AUTO_RESIZE_ALL_COLUMNS);</span>
<span class="nc" id="L158">			companionsTable.getTableHeader().setResizingAllowed(false);</span>
<span class="nc" id="L159">			companionsTable.setAutoCreateColumnsFromModel(false);</span>
<span class="nc" id="L160">			companionsTable.setColumnModel(model);</span>
		}
<span class="nc" id="L162">		companionsTable.setIntercellSpacing(new Dimension(0, 0));</span>
<span class="nc" id="L163">		companionsTable.setFocusable(false);</span>
<span class="nc" id="L164">		companionsTable.setRowHeight(23);</span>
<span class="nc" id="L165">		companionsTable.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L166">		setLeftComponent(new JScrollPane(companionsTable));</span>
<span class="nc" id="L167">		JPanel rightPane = new JPanel(new BorderLayout());</span>
<span class="nc" id="L168">		rightPane.add(new JScrollPane(infoPane), BorderLayout.CENTER);</span>
<span class="nc" id="L169">		JPanel buttonPane = new JPanel(new FlowLayout());</span>
<span class="nc" id="L170">		buttonPane.add(loadButton);</span>
<span class="nc" id="L171">		rightPane.add(buttonPane, BorderLayout.SOUTH);</span>
<span class="nc" id="L172">		setRightComponent(rightPane);</span>
<span class="nc" id="L173">	}</span>

	@Override
	public ModelMap createModels(CharacterFacade character)
	{
<span class="nc" id="L178">		ModelMap models = new ModelMap();</span>
<span class="nc" id="L179">		models.put(CompanionsModel.class, new CompanionsModel(character));</span>
<span class="nc" id="L180">		models.put(ButtonCellEditor.class, new ButtonCellEditor(character));</span>
<span class="nc" id="L181">		models.put(LoadButtonAndSheetHandler.class, new LoadButtonAndSheetHandler());</span>
<span class="nc" id="L182">		models.put(TreeExpansionHandler.class, new TreeExpansionHandler());</span>
<span class="nc" id="L183">		return models;</span>
	}

	@Override
	public void restoreModels(ModelMap models)
	{
<span class="nc" id="L189">		companionsTable.setTreeTableModel(models.get(CompanionsModel.class));</span>
<span class="nc" id="L190">		companionsTable.setDefaultEditor(Object.class, models.get(ButtonCellEditor.class));</span>
<span class="nc" id="L191">		models.get(TreeExpansionHandler.class).install();</span>
<span class="nc" id="L192">		models.get(LoadButtonAndSheetHandler.class).install();</span>
<span class="nc" id="L193">	}</span>

	@Override
	public void storeModels(ModelMap models)
	{
<span class="nc" id="L198">		models.get(TreeExpansionHandler.class).uninstall();</span>
<span class="nc" id="L199">		models.get(LoadButtonAndSheetHandler.class).uninstall();</span>
<span class="nc" id="L200">	}</span>

	@Override
	public TabTitle getTabTitle()
	{
<span class="nc" id="L205">		return new TabTitle(Tab.COMPANIONS);</span>
	}

	@Override
	public void tabSelected()
	{
		// Refresh the character sheet as we have been displayed.
<span class="nc" id="L212">		LoadButtonAndSheetHandler action = (LoadButtonAndSheetHandler) loadButton.getAction();</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">		if (action != null)</span>
		{
<span class="nc" id="L215">			action.showCompanion(false);</span>
		}
<span class="nc" id="L217">	}</span>

	private void selectCompanion(CompanionFacade compFacade)
	{
<span class="nc" id="L221">		TreeTableModel treeTableModel = companionsTable.getTreeTableModel();</span>
<span class="nc" id="L222">		treeTableModel.getRoot();</span>
<span class="nc" id="L223">		TreePath path = null;</span>

<span class="nc" id="L225">		JTree tree = companionsTable.getTree();</span>
<span class="nc" id="L226">		String companionType = compFacade.getCompanionType();</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">		for (int i = 0; i &lt; tree.getRowCount(); i++)</span>
		{
<span class="nc" id="L229">			TreePath pathForRow = tree.getPathForRow(i);</span>
<span class="nc" id="L230">			Object lastPathComponent = pathForRow.getLastPathComponent();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">			if (lastPathComponent.toString().startsWith(companionType))</span>
			{
<span class="nc" id="L233">				tree.expandRow(i);</span>
			}
<span class="nc bnc" id="L235" title="All 2 branches missed.">			else if (lastPathComponent instanceof pcgen.gui2.tabs.CompanionInfoTab.CompanionsModel.CompanionNode)</span>
			{
<span class="nc" id="L237">				CompanionFacade rowComp =</span>
					(CompanionFacade)
						((pcgen.gui2.tabs.CompanionInfoTab.CompanionsModel.CompanionNode) lastPathComponent)
<span class="nc" id="L240">							.getValueAt(0);</span>

<span class="nc bnc" id="L242" title="All 4 branches missed.">				if (rowComp != null &amp;&amp; rowComp.getFileRef().get() == compFacade.getFileRef().get()</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">					&amp;&amp; rowComp.getNameRef().get() == compFacade.getNameRef().get()</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">					&amp;&amp; rowComp.getRaceRef().get() == compFacade.getRaceRef().get())</span>
				{
<span class="nc" id="L246">					path = pathForRow;</span>
				}
			}
		}
<span class="nc bnc" id="L250" title="All 2 branches missed.">		if (path != null)</span>
		{
<span class="nc" id="L252">			companionsTable.getTree().setSelectionPath(path);</span>
<span class="nc" id="L253">			companionsTable.getTree().scrollPathToVisible(path);</span>
		}
<span class="nc" id="L255">	}</span>

	private class TreeExpansionHandler implements TreeExpansionListener
	{

		private final JTree tree;
<span class="nc" id="L261">		private List&lt;TreePath&gt; expandedPaths = Collections.emptyList();</span>

		public TreeExpansionHandler()
<span class="nc" id="L264">		{</span>
<span class="nc" id="L265">			this.tree = companionsTable.getTree();</span>
<span class="nc" id="L266">		}</span>

		public void install()
		{
<span class="nc bnc" id="L270" title="All 2 branches missed.">			for (TreePath path : expandedPaths)</span>
			{
<span class="nc" id="L272">				tree.expandPath(path);</span>
<span class="nc" id="L273">			}</span>
<span class="nc" id="L274">			tree.addTreeExpansionListener(this);</span>
<span class="nc" id="L275">		}</span>

		public void uninstall()
		{
<span class="nc" id="L279">			tree.removeTreeExpansionListener(this);</span>
<span class="nc" id="L280">		}</span>

		@Override
		public void treeExpanded(TreeExpansionEvent event)
		{
<span class="nc" id="L285">			saveExpansionState();</span>
<span class="nc" id="L286">		}</span>

		@Override
		public void treeCollapsed(TreeExpansionEvent event)
		{
<span class="nc" id="L291">			saveExpansionState();</span>
<span class="nc" id="L292">		}</span>

		private void saveExpansionState()
		{
<span class="nc" id="L296">			Object root = companionsTable.getTreeTableModel().getRoot();</span>
<span class="nc" id="L297">			Enumeration&lt;TreePath&gt; paths = tree.getExpandedDescendants(new TreePath(root));</span>
<span class="nc" id="L298">			expandedPaths = Collections.list(paths);</span>
<span class="nc" id="L299">		}</span>

	}

	private class LoadButtonAndSheetHandler extends AbstractAction implements ListSelectionListener
	{

		private final HtmlSheetSupport sheetSupport;
		private int selectedRow;
		private final ListSelectionModel selectionModel;
		private final PCGenFrame frame;

		public LoadButtonAndSheetHandler()
<span class="nc" id="L312">		{</span>
<span class="nc" id="L313">			File sheet = Path.of(</span>
<span class="nc" id="L314">						ConfigurationSettings.getPreviewDir(),</span>
<span class="nc" id="L315">						&quot;companions&quot;, &quot;compact_companion.htm&quot;).toFile(); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L316">			this.sheetSupport = new HtmlSheetSupport(infoPane, sheet.getAbsolutePath());</span>
<span class="nc" id="L317">			this.selectedRow = -1;</span>
<span class="nc" id="L318">			this.selectionModel = companionsTable.getSelectionModel();</span>
<span class="nc" id="L319">			this.frame = (PCGenFrame) JOptionPane.getFrameForComponent(CompanionInfoTab.this);</span>
<span class="nc" id="L320">		}</span>

		public void install()
		{
<span class="nc" id="L324">			configureButton();</span>
<span class="nc" id="L325">			loadButton.setAction(this);</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">			if (selectedRow == -1)</span>
			{
<span class="nc" id="L328">				selectionModel.clearSelection();</span>
			}
			else
			{
<span class="nc" id="L332">				selectionModel.setSelectionInterval(selectedRow, selectedRow);</span>
			}
<span class="nc" id="L334">			selectionModel.addListSelectionListener(this);</span>

<span class="nc" id="L336">			showCompanion(false);</span>
<span class="nc" id="L337">			sheetSupport.install();</span>
<span class="nc" id="L338">		}</span>

		public void uninstall()
		{
<span class="nc" id="L342">			selectionModel.removeListSelectionListener(this);</span>
<span class="nc" id="L343">			sheetSupport.uninstall();</span>
<span class="nc" id="L344">		}</span>

		private void configureButton()
		{
<span class="nc" id="L348">			CompanionFacade companion = getSelectedCompanion();</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">			setEnabled(companion != null);</span>
<span class="nc bnc" id="L350" title="All 4 branches missed.">			if (companion != null &amp;&amp; isCompanionOpen(companion))</span>
			{
				//configure action for show
<span class="nc" id="L353">				this.putValue(Action.NAME, LanguageBundle.getString(&quot;in_companionSwitchTo&quot;)); //$NON-NLS-1$</span>
			}
			else
			{
				//configure action for load
<span class="nc" id="L358">				this.putValue(Action.NAME, LanguageBundle.getString(&quot;in_companionLoadComp&quot;)); //$NON-NLS-1$</span>
			}
<span class="nc" id="L360">		}</span>

		private void showCompanion(boolean switchTabs)
		{
<span class="nc" id="L364">			CompanionFacade companion = getSelectedCompanion();</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">			if (companion == null)</span>
			{
<span class="nc bnc" id="L367" title="All 2 branches missed.">				if (!switchTabs)</span>
				{
<span class="nc" id="L369">					infoPane.getController().setHtml(&quot;&quot;); //$NON-NLS-1$</span>
				}
<span class="nc" id="L371">				return;</span>
			}
<span class="nc bnc" id="L373" title="All 2 branches missed.">			if (isCompanionOpen(companion))</span>
			{
<span class="nc" id="L375">				CharacterFacade character = CharacterManager.getCharacterMatching(companion);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">				if (character != null)</span>
				{
<span class="nc bnc" id="L378" title="All 2 branches missed.">					if (switchTabs)</span>
					{
<span class="nc" id="L380">						frame.setCharacter(character);</span>
<span class="nc" id="L381">						return;</span>
					}
					else
					{
<span class="nc" id="L385">						sheetSupport.setCharacter(character);</span>
<span class="nc" id="L386">						sheetSupport.refresh();</span>
					}
				}
				//the companion was not found
				//TODO: show error, complain?
<span class="nc" id="L391">			}</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">			else if (switchTabs)</span>
			{
<span class="nc" id="L394">				frame.loadCharacterFromFile(companion.getFileRef().get());</span>
			}
			else
			{
				// Display a message telling the user to open the companion.
<span class="nc" id="L399">				infoPane.getController().setHtml(LanguageBundle.getString(&quot;in_companionLoadCompanionMessage&quot;));</span>
			}
<span class="nc" id="L401">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L406">			showCompanion(true);</span>
<span class="nc" id="L407">		}</span>

		@Override
		public void valueChanged(ListSelectionEvent e)
		{
<span class="nc bnc" id="L412" title="All 2 branches missed.">			if (e.getValueIsAdjusting())</span>
			{
<span class="nc" id="L414">				return;</span>
			}
<span class="nc" id="L416">			selectedRow = selectionModel.getMinSelectionIndex();</span>
<span class="nc" id="L417">			configureButton();</span>
<span class="nc" id="L418">			showCompanion(false);</span>
<span class="nc" id="L419">		}</span>

		private CompanionFacade getSelectedCompanion()
		{
<span class="nc bnc" id="L423" title="All 2 branches missed.">			if (selectedRow == -1)</span>
			{
<span class="nc" id="L425">				return null;</span>
			}
<span class="nc" id="L427">			Object value = companionsTable.getValueAt(selectedRow, 0);</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">			if (value instanceof CompanionFacade)</span>
			{
<span class="nc" id="L430">				return (CompanionFacade) value;</span>
			}
<span class="nc" id="L432">			return null;</span>
		}

		private boolean isCompanionOpen(CompanionFacade companion)
		{
<span class="nc" id="L437">			File compFile = companion.getFileRef().get();</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">			if (compFile == null)</span>
			{
<span class="nc" id="L440">				return true;</span>
			}
<span class="nc bnc" id="L442" title="All 2 branches missed.">			for (CharacterFacade character : CharacterManager.getCharacters())</span>
			{
<span class="nc" id="L444">				File charFile = character.getFileRef().get();</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">				if (compFile.equals(charFile))</span>
				{
<span class="nc" id="L447">					return true;</span>
				}
<span class="nc" id="L449">			}</span>
<span class="nc" id="L450">			return false;</span>
		}

	}

	private static class ButtonCellRenderer extends JPanel implements TableCellRenderer
	{

<span class="nc" id="L458">		private final JButton button = new JButton();</span>
<span class="nc" id="L459">		private final DefaultTableCellRenderer background = new DefaultTableCellRenderer();</span>

		public ButtonCellRenderer()
<span class="nc" id="L462">		{</span>
<span class="nc" id="L463">			button.setMargin(new Insets(0, 0, 0, 0));</span>

<span class="nc" id="L465">			setOpaque(true);</span>
<span class="nc" id="L466">			setLayout(new GridBagLayout());</span>
<span class="nc" id="L467">			GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L468">			gbc.weightx = 1;</span>
<span class="nc" id="L469">			gbc.weighty = 1;</span>
<span class="nc" id="L470">			gbc.anchor = GridBagConstraints.EAST;</span>
<span class="nc" id="L471">			gbc.fill = GridBagConstraints.VERTICAL;</span>
<span class="nc" id="L472">			add(button, gbc);</span>
<span class="nc" id="L473">		}</span>

		@Override
		public boolean isOpaque()
		{
<span class="nc" id="L478">			Color back = getBackground();</span>
<span class="nc" id="L479">			Component p = getParent();</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">			if (p != null)</span>
			{
<span class="nc" id="L482">				p = p.getParent();</span>
			}

			// p should now be the JTable. 
<span class="nc bnc" id="L486" title="All 8 branches missed.">			boolean colorMatch = (back != null) &amp;&amp; (p != null) &amp;&amp; back.equals(p.getBackground()) &amp;&amp; p.isOpaque();</span>
<span class="nc bnc" id="L487" title="All 4 branches missed.">			return !colorMatch &amp;&amp; super.isOpaque();</span>
		}

		@Override
		public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus,
			int row, int column)
		{
<span class="nc" id="L494">			background.getTableCellRendererComponent(table, null, isSelected, hasFocus, row, column);</span>
<span class="nc" id="L495">			setBackground(background.getBackground());</span>
<span class="nc" id="L496">			value = table.getValueAt(row, 0);</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">			if (value instanceof CompanionFacade)</span>
			{
<span class="nc" id="L499">				button.setText(LanguageBundle.getString(&quot;in_companionRemove&quot;)); //$NON-NLS-1$</span>
			}
			else
			{
<span class="nc" id="L503">				button.setText(LanguageBundle.getString(&quot;in_companionCreateNew&quot;)); //$NON-NLS-1$</span>
			}
<span class="nc" id="L505">			value = table.getValueAt(row, 1);</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">			if (value instanceof Boolean)</span>
			{
<span class="nc" id="L508">				button.setEnabled((Boolean) value);</span>
			}
			else
			{
<span class="nc" id="L512">				button.setEnabled(true);</span>
			}
<span class="nc" id="L514">			return this;</span>
		}

	}

	private class ButtonCellEditor extends AbstractCellEditor implements TableCellEditor, ActionListener
	{

		private static final String CREATE_COMMAND = &quot;New&quot;; //$NON-NLS-1$
		private static final String REMOVE_COMMAND = &quot;Remove&quot;; //$NON-NLS-1$
<span class="nc" id="L524">		private final JButton button = new JButton();</span>
<span class="nc" id="L525">		private final JPanel container = new JPanel();</span>
<span class="nc" id="L526">		private final DefaultTableCellRenderer background = new DefaultTableCellRenderer();</span>
		private final CharacterFacade character;

		public ButtonCellEditor(CharacterFacade character)
<span class="nc" id="L530">		{</span>
<span class="nc" id="L531">			this.character = character;</span>

<span class="nc" id="L533">			button.addActionListener(this);</span>
<span class="nc" id="L534">			button.setMargin(new Insets(0, 0, 0, 0));</span>

<span class="nc" id="L536">			container.setOpaque(true);</span>
<span class="nc" id="L537">			container.setLayout(new GridBagLayout());</span>
<span class="nc" id="L538">			GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L539">			gbc.weightx = 1;</span>
<span class="nc" id="L540">			gbc.weighty = 1;</span>
<span class="nc" id="L541">			gbc.anchor = GridBagConstraints.EAST;</span>
<span class="nc" id="L542">			gbc.fill = GridBagConstraints.VERTICAL;</span>
<span class="nc" id="L543">			container.add(button, gbc);</span>
<span class="nc" id="L544">		}</span>

		@Override
		public Object getCellEditorValue()
		{
<span class="nc" id="L549">			return null;</span>
		}

		@Override
		public Component getTableCellEditorComponent(JTable table, Object value, boolean isSelected, int row,
			int column)
		{
<span class="nc" id="L556">			background.getTableCellRendererComponent(table, null, true, false, row, column);</span>
<span class="nc" id="L557">			container.setBackground(background.getBackground());</span>
<span class="nc" id="L558">			selectedElement = table.getValueAt(row, 0);</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">			if (selectedElement instanceof CompanionFacade)</span>
			{
<span class="nc" id="L561">				button.setText(LanguageBundle.getString(&quot;in_companionRemove&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L562">				button.setActionCommand(REMOVE_COMMAND);</span>
			}
			else
			{
<span class="nc" id="L566">				button.setText(LanguageBundle.getString(&quot;in_companionCreateNew&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L567">				button.setActionCommand(CREATE_COMMAND);</span>
			}
<span class="nc" id="L569">			return container;</span>
		}

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L575">			CompanionSupportFacade support = character.getCompanionSupport();</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">			if (REMOVE_COMMAND.equals(e.getActionCommand()))</span>
			{
<span class="nc" id="L578">				CompanionFacade companion = (CompanionFacade) selectedElement;</span>
<span class="nc" id="L579">				int ret = JOptionPane.showConfirmDialog(button,</span>
<span class="nc" id="L580">					LanguageBundle.getFormattedString(&quot;in_companionConfirmRemovalMsg&quot;, companion //$NON-NLS-1$</span>
<span class="nc" id="L581">						.getNameRef().get()),</span>
<span class="nc" id="L582">					LanguageBundle.getString(&quot;in_companionConfirmRemoval&quot;), //$NON-NLS-1$</span>
					JOptionPane.YES_NO_OPTION);
<span class="nc bnc" id="L584" title="All 2 branches missed.">				if (ret == JOptionPane.YES_OPTION)</span>
				{
<span class="nc" id="L586">					support.removeCompanion(companion);</span>
				}
			}
<span class="nc bnc" id="L589" title="All 2 branches missed.">			if (CREATE_COMMAND.equals(e.getActionCommand()))</span>
			{
<span class="nc" id="L591">				initDialog();</span>
<span class="nc" id="L592">				String type = (String) selectedElement;</span>
<span class="nc" id="L593">				companionDialog.setCharacter(character);</span>
<span class="nc" id="L594">				companionDialog.setCompanionType(type);</span>
<span class="nc" id="L595">				companionDialog.setLocationRelativeTo(CompanionInfoTab.this);</span>
<span class="nc" id="L596">				companionDialog.setVisible(true);</span>
<span class="nc" id="L597">				CharacterFacade comp = companionDialog.getNewCompanion();</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">				if (comp != null)</span>
				{
<span class="nc" id="L600">					selectCompanion(comp);</span>
				}
			}
<span class="nc" id="L603">			cancelCellEditing();</span>
<span class="nc" id="L604">		}</span>

	}

	private static class FilteredCompanionList extends FilteredListFacade&lt;String, CompanionStubFacade&gt;
			implements Filter&lt;String, CompanionStubFacade&gt;
	{

		public FilteredCompanionList()
<span class="nc" id="L613">		{</span>
<span class="nc" id="L614">			setFilter(this);</span>
<span class="nc" id="L615">		}</span>

		public void setCompanionType(String type)
		{
<span class="nc" id="L619">			setContext(type);</span>
<span class="nc" id="L620">		}</span>

		@Override
		public boolean accept(String context, CompanionStubFacade element)
		{
<span class="nc bnc" id="L625" title="All 2 branches missed.">			if (context == null)</span>
			{
<span class="nc" id="L627">				return true;</span>
			}
<span class="nc" id="L629">			return context.equals(element.getCompanionType());</span>
		}

	}

	private class CompanionDialog extends JDialog
			implements TreeViewModel&lt;CompanionStubFacade&gt;, DataView&lt;CompanionStubFacade&gt;, ActionListener
	{

		private final FilteredCompanionList model;
		private final JButton selectButton;
		private final FilteredTreeViewTable raceTable;
		private CharacterFacade character;
		private String companionType;
		private CharacterFacade newCompanion;
<span class="nc" id="L644">		private final DefaultListFacade&lt;CompanionTreeView&gt; treeViews =</span>
<span class="nc" id="L645">				new DefaultListFacade&lt;&gt;(Arrays.asList(CompanionTreeView.values()));</span>

		public CompanionDialog()
<span class="nc" id="L648">		{</span>
<span class="nc" id="L649">			super(JOptionPane.getFrameForComponent(CompanionInfoTab.this), true);</span>
<span class="nc" id="L650">			this.model = new FilteredCompanionList();</span>
<span class="nc" id="L651">			this.selectButton = new JButton();</span>
<span class="nc" id="L652">			this.raceTable = new FilteredTreeViewTable&lt;&gt;();</span>
<span class="nc" id="L653">			initComponents();</span>
<span class="nc" id="L654">			pack();</span>
<span class="nc" id="L655">		}</span>

		private void initComponents()
		{
<span class="nc" id="L659">			setTitle(LanguageBundle.getString(&quot;in_companionSelectRace&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L660">			setLayout(new BorderLayout());</span>
<span class="nc" id="L661">			Container container = getContentPane();</span>
			{
<span class="nc" id="L663">				final ListSelectionModel selectionModel = raceTable.getSelectionModel();</span>
<span class="nc" id="L664">				selectionModel.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L665">				selectionModel.addListSelectionListener(e -&gt; {</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">                    if (!e.getValueIsAdjusting())</span>
                    {
<span class="nc bnc" id="L668" title="All 2 branches missed.">                        selectButton.setEnabled(!selectionModel.isSelectionEmpty());</span>
                    }
<span class="nc" id="L670">                });</span>
			}
<span class="nc" id="L672">			SearchFilterPanel searchBar = new SearchFilterPanel();</span>
<span class="nc" id="L673">			container.add(searchBar, BorderLayout.NORTH);</span>
<span class="nc" id="L674">			raceTable.setDisplayableFilter(searchBar);</span>
<span class="nc" id="L675">			raceTable.addActionListener(this);</span>
<span class="nc" id="L676">			raceTable.setTreeViewModel(this);</span>
<span class="nc" id="L677">			container.add(new JScrollPane(raceTable), BorderLayout.CENTER);</span>
<span class="nc" id="L678">			JPanel buttonPane = new JPanel(new FlowLayout());</span>
<span class="nc" id="L679">			selectButton.addActionListener(this);</span>
<span class="nc" id="L680">			selectButton.setEnabled(false);</span>
<span class="nc" id="L681">			selectButton.setActionCommand(&quot;SELECT&quot;);</span>
<span class="nc" id="L682">			buttonPane.add(selectButton);</span>

<span class="nc" id="L684">			JButton cancelButton = new JButton(LanguageBundle.getString(&quot;in_cancel&quot;));</span>
<span class="nc" id="L685">			cancelButton.addActionListener(this);</span>
<span class="nc" id="L686">			cancelButton.setActionCommand(&quot;CANCEL&quot;);</span>
<span class="nc" id="L687">			buttonPane.add(cancelButton);</span>
<span class="nc" id="L688">			container.add(buttonPane, BorderLayout.SOUTH);</span>

<span class="nc" id="L690">			Utility.installEscapeCloseOperation(this);</span>
<span class="nc" id="L691">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc bnc" id="L696" title="All 2 branches missed.">			if (!&quot;null&quot;.equals(e.getActionCommand()))</span>
			{
<span class="nc bnc" id="L698" title="All 4 branches missed.">				if (&quot;SELECT&quot;.equals(e.getActionCommand()) || (e.getID() == JTableEx.ACTION_DOUBLECLICK))</span>
				{
<span class="nc" id="L700">					newCompanion =</span>
<span class="nc" id="L701">							CharacterManager.createNewCharacter(character.getUIDelegate(), character.getDataSet());</span>
<span class="nc" id="L702">					CompanionStubFacade selected = (CompanionStubFacade) raceTable.getSelectedObject();</span>
<span class="nc" id="L703">					newCompanion.setRace(selected.getRaceRef().get());</span>
<span class="nc" id="L704">					character.getCompanionSupport().addCompanion(newCompanion, companionType);</span>
<span class="nc" id="L705">					setVisible(false);</span>
<span class="nc" id="L706">				}</span>
				else
				{
<span class="nc" id="L709">					newCompanion = null;</span>
<span class="nc" id="L710">					setVisible(false);</span>
				}
			}
<span class="nc" id="L713">		}</span>

		public void setCharacter(CharacterFacade character)
		{
<span class="nc" id="L717">			this.character = character;</span>
<span class="nc" id="L718">			model.setDelegate(character.getCompanionSupport().getAvailableCompanions());</span>
<span class="nc" id="L719">		}</span>

		public void setCompanionType(String type)
		{
<span class="nc" id="L723">			companionType = type;</span>
<span class="nc" id="L724">			model.setCompanionType(type);</span>
<span class="nc" id="L725">			selectButton.setText(LanguageBundle.getFormattedString(&quot;in_companionCreateType&quot;, type)); //$NON-NLS-1$</span>
<span class="nc" id="L726">			newCompanion = null;</span>
<span class="nc" id="L727">		}</span>

		@Override
		public ListFacade&lt;? extends TreeView&lt;CompanionStubFacade&gt;&gt; getTreeViews()
		{
<span class="nc" id="L732">			return treeViews;</span>
		}

		@Override
		public int getDefaultTreeViewIndex()
		{
<span class="nc" id="L738">			return 0;</span>
		}

		@Override
		public DataView&lt;CompanionStubFacade&gt; getDataView()
		{
<span class="nc" id="L744">			return this;</span>
		}

		@Override
		public ListFacade&lt;CompanionStubFacade&gt; getDataModel()
		{
<span class="nc" id="L750">			return model;</span>
		}

		@Override
		public Object getData(CompanionStubFacade element, int column)
		{
<span class="nc" id="L756">			return null;</span>
		}

		@Override
		public void setData(Object value, CompanionStubFacade element, int column)
		{
<span class="nc" id="L762">		}</span>

		@Override
		public List&lt;? extends DataViewColumn&gt; getDataColumns()
		{
<span class="nc" id="L767">			return Collections.emptyList();</span>
		}

		@Override
		public String getPrefsKey()
		{
<span class="nc" id="L773">			return &quot;CompanionAvail&quot;; //$NON-NLS-1$</span>
		}

		/**
		 * @return the newCompanion
		 */
		public CharacterFacade getNewCompanion()
		{
<span class="nc" id="L781">			return newCompanion;</span>
		}

	}

<span class="nc" id="L786">	private enum CompanionTreeView implements TreeView&lt;CompanionStubFacade&gt;</span>
	{

<span class="nc" id="L789">		NAME(&quot;in_race&quot;); //$NON-NLS-1$</span>
		private final String name;

		private CompanionTreeView(String name)
<span class="nc" id="L793">		{</span>
<span class="nc" id="L794">			this.name = LanguageBundle.getString(name);</span>
<span class="nc" id="L795">		}</span>

		@Override
		public String getViewName()
		{
<span class="nc" id="L800">			return name;</span>
		}

		@Override
		public List&lt;TreeViewPath&lt;CompanionStubFacade&gt;&gt; getPaths(CompanionStubFacade pobj)
		{
<span class="nc bnc" id="L806" title="All 2 branches missed.">            if (this == CompanionTreeView.NAME)</span>
            {
<span class="nc" id="L808">                return Collections.singletonList(new TreeViewPath&lt;&gt;(pobj));</span>
            }
<span class="nc" id="L810">            throw new InternalError();</span>
        }

	}

	private static class CompanionsModel extends AbstractTreeTableModel implements TreeTableModel
	{

		private final CompanionSupportFacade support;
		private final MapFacade&lt;String, Integer&gt; maxMap;

		public CompanionsModel(CharacterFacade character)
<span class="nc" id="L822">		{</span>
<span class="nc" id="L823">			this.support = character.getCompanionSupport();</span>
<span class="nc" id="L824">			this.maxMap = support.getMaxCompanionsMap();</span>
<span class="nc" id="L825">			this.setRoot(new RootNode());</span>
<span class="nc" id="L826">		}</span>

		@Override
		public boolean isCellEditable(Object node, int column)
		{
<span class="nc bnc" id="L831" title="All 2 branches missed.">			if (column &gt; 0)</span>
			{
<span class="nc" id="L833">				Object value = getValueAt(node, column);</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">				if (value instanceof Boolean)</span>
				{
<span class="nc" id="L836">					return (Boolean) value;</span>
				}
<span class="nc" id="L838">				return true;</span>
			}
			else
			{
<span class="nc" id="L842">				return super.isCellEditable(node, column);</span>
			}
		}

		@Override
		public int getColumnCount()
		{
<span class="nc" id="L849">			return 2;</span>
		}

		private static class CompanionNode extends DefaultTreeTableNode
		{

			private final CompanionFacade companion;

			public CompanionNode(CompanionFacade companion)
<span class="nc" id="L858">			{</span>
<span class="nc" id="L859">				this.companion = companion;</span>
<span class="nc" id="L860">			}</span>

			@Override
			public Object getValueAt(int column)
			{
<span class="nc bnc" id="L865" title="All 2 branches missed.">				if (column == 0)</span>
				{
<span class="nc" id="L867">					return companion;</span>
				}
<span class="nc" id="L869">				return null;</span>
			}

			@Override
			public String toString()
			{
<span class="nc" id="L875">				return companion.getNameRef().get();</span>
			}

		}

		private class CompanionTypeNode extends DefaultTreeTableNode implements ReferenceListener&lt;String&gt;
		{

			private final String type;

			public CompanionTypeNode(String type)
<span class="nc" id="L886">			{</span>
<span class="nc" id="L887">				super(Arrays.asList(type, null));</span>
<span class="nc" id="L888">				this.type = type;</span>
<span class="nc" id="L889">			}</span>

			@Override
			public Object getValueAt(int column)
			{
<span class="nc bnc" id="L894" title="All 2 branches missed.">				if (column &gt; 0)</span>
				{
<span class="nc" id="L896">					Integer max = maxMap.getValue(type);</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">					if (max &lt; 0)</span>
					{
<span class="nc" id="L899">						return true;</span>
					}
<span class="nc bnc" id="L901" title="All 2 branches missed.">					return getChildCount() &lt; max;</span>
				}
				else
				{
<span class="nc" id="L905">					return super.getValueAt(column);</span>
				}
			}

			@SuppressWarnings(&quot;nls&quot;)
			@Override
			public String toString()
			{
<span class="nc" id="L913">				Integer max = maxMap.getValue(type);</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">				String maxString = max == -1 ? &quot;*&quot; : max.toString();</span>
<span class="nc" id="L915">				return type + &quot; (&quot; + getChildCount() + &quot;/&quot; + maxString + &quot;)&quot;;</span>
			}

			private void addCompanion(CompanionFacade companion, boolean silently)
			{
<span class="nc" id="L920">				companion.getNameRef().addReferenceListener(this);</span>
<span class="nc" id="L921">				CompanionNode child = new CompanionNode(companion);</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">				if (children == null)</span>
				{
<span class="nc" id="L924">					children = new Vector&lt;&gt;();</span>
				}
				@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L927">				int insertIndex = Collections.binarySearch(children, child, Comparators.toStringIgnoreCaseCollator());</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">				if (insertIndex &lt; 0)</span>
				{
<span class="nc bnc" id="L930" title="All 2 branches missed.">					if (silently)</span>
					{
<span class="nc" id="L932">						insert(child, -(insertIndex + 1));</span>
					}
					else
					{
<span class="nc" id="L936">						insertNodeInto(child, this, -(insertIndex + 1));</span>
					}
				}
				else
				{
<span class="nc bnc" id="L941" title="All 2 branches missed.">					if (silently)</span>
					{
<span class="nc" id="L943">						insert(child, insertIndex);</span>
					}
					else
					{
<span class="nc" id="L947">						insertNodeInto(child, this, insertIndex);</span>
					}
				}
<span class="nc bnc" id="L950" title="All 2 branches missed.">				if (!silently)</span>
				{
<span class="nc" id="L952">					nodeChanged(this);</span>
				}
<span class="nc" id="L954">			}</span>

			private void removeCompanion(CompanionFacade companion)
			{
<span class="nc" id="L958">				companion.getNameRef().removeReferenceListener(this);</span>
				//we create a dummy child for comparison
<span class="nc" id="L960">				CompanionNode child = new CompanionNode(companion);</span>
				@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L962">				int index = Collections.binarySearch(children, child, Comparators.toStringIgnoreCaseCollator());</span>
<span class="nc" id="L963">				removeNodeFromParent((CompanionNode) getChildAt(index));</span>
<span class="nc" id="L964">				nodeChanged(this);</span>
<span class="nc" id="L965">			}</span>

			@Override
			@SuppressWarnings(&quot;unchecked&quot;)
			public void referenceChanged(ReferenceEvent&lt;String&gt; e)
			{
<span class="nc" id="L971">				children.sort(Comparators.toStringIgnoreCaseCollator());</span>
<span class="nc" id="L972">				int[] indexes = new int[getChildCount()];</span>
<span class="nc" id="L973">				Arrays.setAll(indexes, i -&gt; i);</span>
<span class="nc" id="L974">				nodesChanged(this, indexes);</span>
<span class="nc" id="L975">			}</span>

			@Override
			public void setParent(MutableTreeNode newParent)
			{
<span class="nc" id="L980">				super.setParent(newParent);</span>
<span class="nc bnc" id="L981" title="All 4 branches missed.">				if (newParent == null &amp;&amp; children != null)</span>
				{
<span class="nc bnc" id="L983" title="All 2 branches missed.">					for (int i = 0; i &lt; getChildCount(); i++)</span>
					{
<span class="nc" id="L985">						CompanionNode child = (CompanionNode) getChildAt(i);</span>
<span class="nc" id="L986">						child.companion.getNameRef().removeReferenceListener(this);</span>
					}
				}
<span class="nc" id="L989">			}</span>

		}

		class RootNode extends DefaultTreeTableNode
				implements MapListener&lt;String, Integer&gt;, ListListener&lt;CompanionFacade&gt;
		{

			private final List&lt;String&gt; types;
			private final ListFacade&lt;? extends CompanionFacade&gt; companions;

			public RootNode()
<span class="nc" id="L1001">			{</span>
<span class="nc" id="L1002">				this.types = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1003">				this.companions = support.getCompanions();</span>
<span class="nc" id="L1004">				maxMap.addMapListener(this);</span>
<span class="nc" id="L1005">				companions.addListListener(this);</span>
<span class="nc" id="L1006">				initChildren();</span>
<span class="nc" id="L1007">			}</span>

			private void initChildren()
			{
<span class="nc" id="L1011">				types.clear();</span>
<span class="nc" id="L1012">				types.addAll(maxMap.getKeys());</span>
<span class="nc" id="L1013">				types.sort(Comparators.toStringIgnoreCaseCollator());</span>
<span class="nc" id="L1014">				removeAllChildren();</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">				for (String key : types)</span>
				{
<span class="nc" id="L1017">					CompanionTypeNode child = new CompanionTypeNode(key);</span>
<span class="nc" id="L1018">					add(child);</span>
<span class="nc" id="L1019">				}</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">				for (CompanionFacade companion : companions)</span>
				{
<span class="nc" id="L1022">					addCompanion(companion, true);</span>
<span class="nc" id="L1023">				}</span>
<span class="nc" id="L1024">			}</span>

			private void addCompanion(CompanionFacade companion, boolean silently)
			{
<span class="nc" id="L1028">				String type = companion.getCompanionType();</span>
<span class="nc" id="L1029">				int index = Collections.binarySearch(types, type, Comparators.toStringIgnoreCaseCollator());</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">				if (index &lt; 0)</span>
				{
<span class="nc" id="L1032">					Logging.errorPrint(</span>
						&quot;Unable to add companion &quot; + companion + &quot; as the type &quot; + type + &quot; could not be found.&quot;);
<span class="nc" id="L1034">					return;</span>
				}
<span class="nc" id="L1036">				CompanionTypeNode child = (CompanionTypeNode) getChildAt(index);</span>
<span class="nc" id="L1037">				child.addCompanion(companion, silently);</span>
<span class="nc" id="L1038">			}</span>

			@Override
			public void keyAdded(MapEvent&lt;String, Integer&gt; e)
			{
<span class="nc" id="L1043">				int insertIndex = Collections.binarySearch(types, e.getKey(), Comparators.toStringIgnoreCaseCollator());</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">				if (insertIndex &lt; 0)</span>
				{
<span class="nc" id="L1046">					insertIndex = -(insertIndex + 1);</span>
				}
<span class="nc" id="L1048">				types.add(insertIndex, e.getKey());</span>
<span class="nc" id="L1049">				CompanionTypeNode child = new CompanionTypeNode(e.getKey());</span>
<span class="nc" id="L1050">				insertNodeInto(child, this, insertIndex);</span>
<span class="nc" id="L1051">			}</span>

			@Override
			public void keyRemoved(MapEvent&lt;String, Integer&gt; e)
			{
<span class="nc" id="L1056">				int index = types.indexOf(e.getKey());</span>
<span class="nc" id="L1057">				types.remove(index);</span>
<span class="nc" id="L1058">				removeNodeFromParent((MutableTreeNode) getChildAt(index));</span>
<span class="nc" id="L1059">			}</span>

			@Override
			public void keyModified(MapEvent&lt;String, Integer&gt; e)
			{
				//ignore this
<span class="nc" id="L1065">			}</span>

			@Override
			public void valueChanged(MapEvent&lt;String, Integer&gt; e)
			{
<span class="nc" id="L1070">				int index = types.indexOf(e.getKey());</span>
<span class="nc" id="L1071">				nodeChanged(getChildAt(index));</span>
<span class="nc" id="L1072">			}</span>

			@Override
			public void valueModified(MapEvent&lt;String, Integer&gt; e)
			{
				//ignore this
<span class="nc" id="L1078">			}</span>

			@Override
			public void keysChanged(MapEvent&lt;String, Integer&gt; e)
			{
<span class="nc" id="L1083">				initChildren();</span>
<span class="nc" id="L1084">				nodeStructureChanged(this);</span>
<span class="nc" id="L1085">			}</span>

			@Override
			public void elementAdded(ListEvent&lt;CompanionFacade&gt; e)
			{
<span class="nc" id="L1090">				addCompanion(e.getElement(), false);</span>
<span class="nc" id="L1091">			}</span>

			@Override
			public void elementRemoved(ListEvent&lt;CompanionFacade&gt; e)
			{
<span class="nc" id="L1096">				String type = e.getElement().getCompanionType();</span>
<span class="nc" id="L1097">				int index = Collections.binarySearch(types, type, Comparators.toStringIgnoreCaseCollator());</span>
<span class="nc" id="L1098">				CompanionTypeNode child = (CompanionTypeNode) getChildAt(index);</span>
<span class="nc" id="L1099">				child.removeCompanion(e.getElement());</span>
<span class="nc" id="L1100">			}</span>

			@Override
			public void elementsChanged(ListEvent&lt;CompanionFacade&gt; e)
			{
<span class="nc" id="L1105">				initChildren();</span>
<span class="nc" id="L1106">				nodeStructureChanged(this);</span>
<span class="nc" id="L1107">			}</span>

			@Override
			public void elementModified(ListEvent&lt;CompanionFacade&gt; e)
			{
				//this is handled by the CompanionTypeNode
<span class="nc" id="L1113">			}</span>

		}

	}

	@Override
	public void adviseTodo(String fieldName)
	{
<span class="nc" id="L1122">		CompanionsModel model = (CompanionsModel) companionsTable.getTreeTableModel();</span>
<span class="nc" id="L1123">		CompanionsModel.RootNode root = (CompanionsModel.RootNode) model.getRoot();</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">		for (int i = 0; i &lt; root.getChildCount(); i++)</span>
		{
<span class="nc" id="L1126">			TreeNode node = root.getChildAt(i);</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">			if (node.toString().startsWith(fieldName))</span>
			{
<span class="nc" id="L1129">				companionsTable.getSelectionModel().setSelectionInterval(i, i);</span>
<span class="nc" id="L1130">				return;</span>
			}
		}
<span class="nc" id="L1133">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>