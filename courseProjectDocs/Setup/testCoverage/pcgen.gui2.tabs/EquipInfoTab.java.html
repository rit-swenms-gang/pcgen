<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EquipInfoTab.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.gui2.tabs</a> &gt; <span class="el_source">EquipInfoTab.java</span></div><h1>EquipInfoTab.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2010 Connor Petty &lt;cpmeister@users.sourceforge.net&gt;
 * 
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 * 
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 * 
 */
package pcgen.gui2.tabs;

import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.Insets;
import java.awt.datatransfer.DataFlavor;
import java.awt.datatransfer.Transferable;
import java.awt.datatransfer.UnsupportedFlavorException;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseEvent;
import java.io.IOException;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;
import javax.swing.AbstractAction;
import javax.swing.BorderFactory;
import javax.swing.Box;
import javax.swing.DropMode;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JMenuItem;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.JTree;
import javax.swing.RowSorter;
import javax.swing.SwingConstants;
import javax.swing.TransferHandler;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.TableColumn;
import javax.swing.table.TableModel;
import org.apache.commons.lang3.ArrayUtils;
import org.apache.commons.lang3.StringUtils;
import pcgen.core.Equipment;
import pcgen.facade.core.CharacterFacade;
import pcgen.facade.core.EquipmentFacade;
import pcgen.facade.core.EquipmentSetFacade;
import pcgen.facade.util.ReferenceFacade;
import pcgen.facade.util.event.ReferenceEvent;
import pcgen.facade.util.event.ReferenceListener;
import pcgen.gui2.UIPropertyContext;
import pcgen.gui2.facade.EquipNode;
import static pcgen.gui2.facade.EquipNode.NodeType.EQUIPMENT;
import pcgen.gui2.filter.DisplayableFilter;
import pcgen.gui2.filter.SearchFilterPanel;
import pcgen.gui2.tabs.equip.EquipmentModel;
import pcgen.gui2.tabs.equip.EquipmentModels;
import pcgen.gui2.tabs.equip.EquipmentModels.EquipView;
import pcgen.gui2.tabs.equip.EquipmentSelection;
import static pcgen.gui2.tabs.equip.EquipmentSelection.EQUIPMENT_ARRAY_FLAVOR;
import pcgen.gui2.tabs.models.CharacterComboBoxModel;
import pcgen.gui2.tools.FlippingSplitPane;
import pcgen.gui2.tools.Icons;
import pcgen.gui2.tools.InfoPane;
import pcgen.gui2.util.FontManipulation;
import pcgen.gui2.util.JDynamicTable;
import pcgen.gui2.util.JTreeTable;
import pcgen.gui2.util.event.PopupMouseAdapter;
import pcgen.gui2.util.table.DefaultDynamicTableColumnModel;
import pcgen.gui2.util.table.DynamicTableColumnModel;
import pcgen.gui3.utilty.ColorUtilty;
import pcgen.system.LanguageBundle;
import pcgen.util.enumeration.Load;
import pcgen.util.enumeration.Tab;

/**
 * EquipInfoTab is a character tab for managing where gear is distributed for a
 * character. Each set of distribution information is called an EquipSet.
 * Multiple EquipSets can be managed to reflect different configurations.
 */
public class EquipInfoTab extends FlippingSplitPane implements CharacterInfoTab, TodoHandler
{

<span class="nc" id="L102">	private static final DataFlavor EQUIP_NODE_ARRAY_FLAVOR =</span>
			new DataFlavor(DataFlavor.javaJVMLocalObjectMimeType + &quot;;class=\&quot;&quot; //$NON-NLS-1$
<span class="nc" id="L104">				+ EquipNode[].class.getName() + &quot;\&quot;&quot;, null); //$NON-NLS-1$</span>
	private final JDynamicTable equipmentTable;
	private final JComboBox equipViewBox;
	private final JTreeTable equipmentSetTable;
	private final InfoPane infoPane;
	private final JButton unequipButton;
	private final JButton unequipAllButton;
	private final JButton moveUpButton;
	private final JButton moveDownButton;
	private final JButton equipButton;
	private final JComboBox equipSetBox;
	private final JButton newSetButton;
	private final JButton removeSetButton;
	private final JButton expandAllButton;
	private final JButton collapseAllButton;
	private final JLabel weightLabel;
	private final JLabel loadLabel;
	private final JLabel limitLabel;
	private DisplayableFilter&lt;Object, Object&gt; tableFilter;

	public EquipInfoTab()
<span class="nc" id="L125">	{</span>
		//TODO: remove this when optimized sorting is implemented
<span class="nc" id="L127">		this.equipmentTable = new JDynamicTable()</span>
<span class="nc" id="L128">		{</span>

			@Override
			public void setModel(TableModel dataModel)
			{
<span class="nc" id="L133">				RowSorter&lt;? extends TableModel&gt; oldRowSorter = getRowSorter();</span>
<span class="nc" id="L134">				super.setModel(dataModel);</span>
<span class="nc" id="L135">				RowSorter&lt;? extends TableModel&gt; newRowSorter = getRowSorter();</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">				if (newRowSorter != null &amp;&amp; oldRowSorter != null)</span>
				{
<span class="nc" id="L138">					newRowSorter.setSortKeys(oldRowSorter.getSortKeys());</span>
				}
<span class="nc" id="L140">			}</span>

		};
<span class="nc" id="L143">		this.equipViewBox = new JComboBox&lt;&gt;(EquipView.values());</span>
<span class="nc" id="L144">		this.infoPane = new InfoPane();</span>
<span class="nc" id="L145">		this.equipmentSetTable = new JTreeTable()</span>
<span class="nc" id="L146">		{</span>

			@Override
			protected void configureEnclosingScrollPane()
			{
				//We do nothing so the table is displayed without a header
<span class="nc" id="L152">			}</span>

		};
<span class="nc" id="L155">		this.equipButton = new JButton();</span>
<span class="nc" id="L156">		this.unequipButton = new JButton();</span>
<span class="nc" id="L157">		this.unequipAllButton = new JButton();</span>
<span class="nc" id="L158">		this.moveUpButton = new JButton();</span>
<span class="nc" id="L159">		this.moveDownButton = new JButton();</span>
<span class="nc" id="L160">		this.equipSetBox = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L161">		this.newSetButton = new JButton();</span>
<span class="nc" id="L162">		this.removeSetButton = new JButton();</span>
<span class="nc" id="L163">		this.expandAllButton = new JButton();</span>
<span class="nc" id="L164">		this.collapseAllButton = new JButton();</span>
<span class="nc" id="L165">		this.weightLabel = new JLabel();</span>
<span class="nc" id="L166">		this.loadLabel = new JLabel();</span>
<span class="nc" id="L167">		this.limitLabel = new JLabel();</span>
<span class="nc" id="L168">		initComponents();</span>
<span class="nc" id="L169">	}</span>

	private void initComponents()
	{
<span class="nc" id="L173">		FontManipulation.small(expandAllButton);</span>
<span class="nc" id="L174">		expandAllButton.setMargin(new Insets(0, -2,0,-2));</span>
<span class="nc" id="L175">		FontManipulation.small(collapseAllButton);</span>
<span class="nc" id="L176">		collapseAllButton.setMargin(new Insets(0, -2,0,-2));</span>

<span class="nc" id="L178">		FontManipulation.small(newSetButton);</span>
<span class="nc" id="L179">		newSetButton.setMargin(new Insets(0, 0, 0, 0));</span>
<span class="nc" id="L180">		FontManipulation.small(removeSetButton);</span>
<span class="nc" id="L181">		removeSetButton.setMargin(new Insets(0, 0, 0, 0));</span>

<span class="nc" id="L183">		setOrientation(HORIZONTAL_SPLIT);</span>
<span class="nc" id="L184">		FlippingSplitPane splitPane = new FlippingSplitPane(VERTICAL_SPLIT);</span>

<span class="nc" id="L186">		JPanel panel = new JPanel(new BorderLayout());</span>

<span class="nc" id="L188">		Box bar = Box.createHorizontalBox();</span>
<span class="nc" id="L189">		bar.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L190">		bar.add(new JLabel(LanguageBundle.getString(&quot;in_equipView&quot;))); //$NON-NLS-1$</span>
<span class="nc" id="L191">		bar.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L192">		bar.add(equipViewBox);</span>
<span class="nc" id="L193">		bar.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L194">		tableFilter = new SearchFilterPanel();</span>
<span class="nc" id="L195">		bar.add(tableFilter.getFilterComponent());</span>
<span class="nc" id="L196">		bar.setBorder(BorderFactory.createEmptyBorder(2, 0, 2, 0));</span>
<span class="nc" id="L197">		panel.add(bar, BorderLayout.NORTH);</span>

<span class="nc" id="L199">		equipmentTable.setAutoCreateColumnsFromModel(false);</span>
<span class="nc" id="L200">		equipmentTable.setColumnModel(createEquipmentColumnModel());</span>
<span class="nc" id="L201">		equipmentTable.setAutoCreateRowSorter(true);</span>
<span class="nc" id="L202">		panel.add(new JScrollPane(equipmentTable), BorderLayout.CENTER);</span>

<span class="nc" id="L204">		Box buttonsBox = Box.createHorizontalBox();</span>
<span class="nc" id="L205">		buttonsBox.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L206">		equipButton.setHorizontalTextPosition(SwingConstants.LEADING);</span>
<span class="nc" id="L207">		buttonsBox.add(equipButton);</span>
<span class="nc" id="L208">		buttonsBox.setBorder(BorderFactory.createEmptyBorder(5, 0, 5, 0));</span>
<span class="nc" id="L209">		panel.add(buttonsBox, BorderLayout.SOUTH);</span>

<span class="nc" id="L211">		splitPane.setTopComponent(panel);</span>
<span class="nc" id="L212">		splitPane.setBottomComponent(infoPane);</span>

<span class="nc" id="L214">		setLeftComponent(splitPane);</span>

<span class="nc" id="L216">		panel = new JPanel(new BorderLayout());</span>

<span class="nc" id="L218">		Box equipPane = Box.createVerticalBox();</span>
<span class="nc" id="L219">		Box box = Box.createHorizontalBox();</span>
<span class="nc" id="L220">		box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L221">		box.add(new JLabel(LanguageBundle.getString(&quot;in_equipSetLabel&quot;))); //$NON-NLS-1$</span>
<span class="nc" id="L222">		box.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L223">		box.add(equipSetBox);</span>
<span class="nc" id="L224">		box.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L225">		box.add(newSetButton);</span>
<span class="nc" id="L226">		box.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L227">		box.add(removeSetButton);</span>
<span class="nc" id="L228">		box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L229">		box.add(new JLabel(LanguageBundle.getString(&quot;in_equipWeightLabel&quot;))); //$NON-NLS-1$</span>
<span class="nc" id="L230">		box.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L231">		box.add(weightLabel);</span>
<span class="nc" id="L232">		box.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L233">		box.add(new JLabel(LanguageBundle.getString(&quot;in_equipLoadLabel&quot;))); //$NON-NLS-1$</span>
<span class="nc" id="L234">		box.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L235">		box.add(loadLabel);</span>
<span class="nc" id="L236">		box.add(Box.createHorizontalStrut(5));</span>
<span class="nc" id="L237">		box.add(limitLabel);</span>
<span class="nc" id="L238">		box.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L239">		box.add(expandAllButton);</span>
<span class="nc" id="L240">		box.add(collapseAllButton);</span>
<span class="nc" id="L241">		box.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L242">		equipPane.add(box);</span>

<span class="nc" id="L244">		box.add(Box.createHorizontalStrut(3));</span>

<span class="nc" id="L246">		panel.add(equipPane, BorderLayout.NORTH);</span>

<span class="nc" id="L248">		EquipmentModel.initializeTreeTable(equipmentSetTable);</span>
<span class="nc" id="L249">		panel.add(new JScrollPane(equipmentSetTable), BorderLayout.CENTER);</span>

<span class="nc" id="L251">		Box selPanelbuttonsBox = Box.createHorizontalBox();</span>
<span class="nc" id="L252">		selPanelbuttonsBox.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L253">		selPanelbuttonsBox.add(unequipButton);</span>
<span class="nc" id="L254">		selPanelbuttonsBox.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L255">		selPanelbuttonsBox.add(unequipAllButton);</span>
<span class="nc" id="L256">		selPanelbuttonsBox.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L257">		selPanelbuttonsBox.add(moveUpButton);</span>
<span class="nc" id="L258">		selPanelbuttonsBox.add(Box.createHorizontalStrut(3));</span>
<span class="nc" id="L259">		selPanelbuttonsBox.add(moveDownButton);</span>
<span class="nc" id="L260">		selPanelbuttonsBox.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L261">		selPanelbuttonsBox.setBorder(BorderFactory.createEmptyBorder(5, 0, 5, 0));</span>
<span class="nc" id="L262">		panel.add(selPanelbuttonsBox, BorderLayout.SOUTH);</span>
<span class="nc" id="L263">		setRightComponent(panel);</span>
<span class="nc" id="L264">	}</span>

	private DynamicTableColumnModel createEquipmentColumnModel()
	{
<span class="nc" id="L268">		DefaultDynamicTableColumnModel model = new DefaultDynamicTableColumnModel(1);</span>

<span class="nc" id="L270">		TableColumn column = new TableColumn(0);</span>
<span class="nc" id="L271">		column.setHeaderValue(LanguageBundle.getString(&quot;in_nameLabel&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L272">		column.setPreferredWidth(150);</span>
<span class="nc" id="L273">		model.addColumn(column);</span>
<span class="nc" id="L274">		model.setVisible(column, true);</span>

<span class="nc" id="L276">		column = new TableColumn(1);</span>
<span class="nc" id="L277">		column.setHeaderValue(LanguageBundle.getString(&quot;in_type&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L278">		column.setPreferredWidth(75);</span>
<span class="nc" id="L279">		model.addColumn(column);</span>
<span class="nc" id="L280">		model.setVisible(column, true);</span>

<span class="nc" id="L282">		column = new TableColumn(2);</span>
<span class="nc" id="L283">		column.setHeaderValue(LanguageBundle.getString(&quot;in_equipLocationAbbrev&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L284">		column.setPreferredWidth(75);</span>
<span class="nc" id="L285">		model.addColumn(column);</span>
<span class="nc" id="L286">		model.setVisible(column, true);</span>

<span class="nc" id="L288">		column = new TableColumn(3);</span>
<span class="nc" id="L289">		column.setHeaderValue(LanguageBundle.getString(&quot;in_equipQuantityAbbrev&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L290">		column.setPreferredWidth(75);</span>
<span class="nc" id="L291">		model.addColumn(column);</span>
<span class="nc" id="L292">		model.setVisible(column, true);</span>

<span class="nc" id="L294">		column = new TableColumn(4);</span>
<span class="nc" id="L295">		column.setHeaderValue(LanguageBundle.getString(&quot;in_equipWeightAbbrev&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L296">		column.setPreferredWidth(75);</span>
<span class="nc" id="L297">		model.addColumn(column);</span>
<span class="nc" id="L298">		model.setVisible(column, true);</span>

<span class="nc" id="L300">		column = new TableColumn(5);</span>
<span class="nc" id="L301">		column.setHeaderValue(LanguageBundle.getString(&quot;in_descrip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L302">		column.setPreferredWidth(75);</span>
<span class="nc" id="L303">		model.addColumn(column);</span>
<span class="nc" id="L304">		model.setVisible(column, false);</span>

<span class="nc" id="L306">		return model;</span>
	}

	@Override
	public ModelMap createModels(CharacterFacade character)
	{
<span class="nc" id="L312">		ModelMap models = new ModelMap();</span>
<span class="nc" id="L313">		models.put(EquipmentModel.class, new EquipmentModel(character, equipmentSetTable));</span>
<span class="nc" id="L314">		models.put(EquipmentModels.class, new EquipmentModels(character, equipViewBox, equipmentTable, tableFilter,</span>
			equipmentSetTable, equipButton, unequipButton, moveUpButton, moveDownButton));
<span class="nc" id="L316">		models.put(UnequipAllAction.class, new UnequipAllAction(character));</span>
<span class="nc" id="L317">		models.put(EquipSetBoxModel.class, new EquipSetBoxModel(character));</span>
<span class="nc" id="L318">		models.put(AddSetAction.class, new AddSetAction(character));</span>
<span class="nc" id="L319">		models.put(RemoveSetAction.class, new RemoveSetAction(character));</span>
<span class="nc" id="L320">		models.put(LabelsUpdater.class, new LabelsUpdater(character));</span>
<span class="nc" id="L321">		models.put(EquipInfoHandler.class, new EquipInfoHandler(character));</span>
<span class="nc" id="L322">		models.put(EquipmentRenderer.class, new EquipmentRenderer(character));</span>
<span class="nc" id="L323">		models.put(EquipmentTransferHandler.class, new EquipmentTransferHandler(character));</span>
<span class="nc" id="L324">		models.put(EquipmentSetTransferHandler.class, new EquipmentSetTransferHandler(character));</span>
<span class="nc" id="L325">		models.put(OrderPopupMenuHandler.class, new OrderPopupMenuHandler(character));</span>
<span class="nc" id="L326">		models.put(ExpandAllAction.class, new ExpandAllAction());</span>
<span class="nc" id="L327">		models.put(CollapseAllAction.class, new CollapseAllAction());</span>
<span class="nc" id="L328">		return models;</span>
	}

	@Override
	public void restoreModels(ModelMap models)
	{
<span class="nc" id="L334">		models.get(EquipmentModel.class).install();</span>
<span class="nc" id="L335">		models.get(EquipmentModels.class).install();</span>
<span class="nc" id="L336">		models.get(LabelsUpdater.class).install();</span>
<span class="nc" id="L337">		models.get(EquipInfoHandler.class).install();</span>
<span class="nc" id="L338">		models.get(EquipmentRenderer.class).install();</span>
<span class="nc" id="L339">		models.get(EquipmentTransferHandler.class).install();</span>
<span class="nc" id="L340">		models.get(EquipmentSetTransferHandler.class).install();</span>
<span class="nc" id="L341">		models.get(OrderPopupMenuHandler.class).install();</span>
<span class="nc" id="L342">		unequipAllButton.setAction(models.get(UnequipAllAction.class));</span>
<span class="nc" id="L343">		newSetButton.setAction(models.get(AddSetAction.class));</span>
<span class="nc" id="L344">		removeSetButton.setAction(models.get(RemoveSetAction.class));</span>
<span class="nc" id="L345">		expandAllButton.setAction(models.get(ExpandAllAction.class));</span>
<span class="nc" id="L346">		collapseAllButton.setAction(models.get(CollapseAllAction.class));</span>
<span class="nc" id="L347">		equipSetBox.setModel(models.get(EquipSetBoxModel.class));</span>
<span class="nc" id="L348">	}</span>

	@Override
	public void storeModels(ModelMap models)
	{
<span class="nc" id="L353">		models.get(LabelsUpdater.class).uninstall();</span>
<span class="nc" id="L354">		models.get(EquipmentModel.class).uninstall();</span>
<span class="nc" id="L355">		models.get(EquipmentModels.class).uninstall();</span>
<span class="nc" id="L356">		models.get(EquipInfoHandler.class).uninstall();</span>
<span class="nc" id="L357">		models.get(OrderPopupMenuHandler.class).uninstall();</span>
<span class="nc" id="L358">	}</span>

	@Override
	public TabTitle getTabTitle()
	{
<span class="nc" id="L363">		return new TabTitle(Tab.EQUIPPING);</span>
	}

	private static List&lt;EquipNode&gt; getMenuTargets(JTable table, MouseEvent e)
	{
<span class="nc" id="L368">		int row = table.rowAtPoint(e.getPoint());</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">		if (!table.isRowSelected(row))</span>
		{
<span class="nc bnc" id="L371" title="All 4 branches missed.">			if ((row &gt;= 0) &amp;&amp; (table.getRowCount() &gt; row))</span>
			{
<span class="nc" id="L373">				table.setRowSelectionInterval(row, row);</span>
			}
		}
<span class="nc" id="L376">		return Arrays.stream(table.getSelectedRows())</span>
<span class="nc" id="L377">		             .mapToObj(selRow -&gt; table.getModel().getValueAt(selRow, 0))</span>
<span class="nc" id="L378">		             .filter(value -&gt; value instanceof EquipNode)</span>
<span class="nc" id="L379">		             .map(value -&gt; (EquipNode) value)</span>
<span class="nc" id="L380">		             .collect(Collectors.toList());</span>
	}

	public void setLoadLabel(Load encumbrance)
	{
<span class="nc" id="L385">		loadLabel.setText(encumbrance.name());</span>
<span class="nc" id="L386">		loadLabel.setFont(encumbrance.getFont(loadLabel.getFont()));</span>
<span class="nc" id="L387">		loadLabel.setForeground(ColorUtilty.colorToAWTColor(encumbrance.getColor()));</span>
<span class="nc" id="L388">	}</span>

	@Override
	public void adviseTodo(String fieldName)
	{
		// We don't provide further advice at this time. 
<span class="nc" id="L394">	}</span>

	private class AddSetAction extends AbstractAction
	{

		private final CharacterFacade character;

		public AddSetAction(CharacterFacade character)
<span class="nc" id="L402">		{</span>
<span class="nc" id="L403">			super(LanguageBundle.getString(&quot;in_new&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L404">			this.character = character;</span>
<span class="nc" id="L405">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L410">			String name =</span>
<span class="nc" id="L411">					JOptionPane.showInputDialog(JOptionPane.getFrameForComponent(EquipInfoTab.this), &quot;Name of new set&quot;);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">			if (StringUtils.isNotEmpty(name))</span>
			{
<span class="nc" id="L414">				character.setEquipmentSet(character.createEquipmentSet(name));</span>

			}
<span class="nc" id="L417">		}</span>

	}

	private static class RemoveSetAction extends AbstractAction
	{

		private final CharacterFacade character;

		public RemoveSetAction(CharacterFacade character)
		{
<span class="nc" id="L428">			super(LanguageBundle.getString(&quot;in_remove&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L429">			this.character = character;</span>
<span class="nc" id="L430">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L435">			character.deleteEquipmentSet(character.getEquipmentSetRef().get());</span>
<span class="nc" id="L436">		}</span>

	}

	private static class EquipSetBoxModel extends CharacterComboBoxModel&lt;EquipmentSetFacade&gt;
	{

		private final CharacterFacade character;

		public EquipSetBoxModel(CharacterFacade character)
<span class="nc" id="L446">		{</span>
<span class="nc" id="L447">			this.character = character;</span>
<span class="nc" id="L448">			setListFacade(character.getEquipmentSets());</span>
<span class="nc" id="L449">			setReference(character.getEquipmentSetRef());</span>
<span class="nc" id="L450">		}</span>

		@Override
		public void setSelectedItem(Object anItem)
		{
<span class="nc" id="L455">			character.setEquipmentSet((EquipmentSetFacade) anItem);</span>
<span class="nc" id="L456">		}</span>

	}

	private class ExpandAllAction extends AbstractAction
	{

		public ExpandAllAction()
<span class="nc" id="L464">		{</span>
<span class="nc" id="L465">			super(&quot;+&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L466">			putValue(SHORT_DESCRIPTION, LanguageBundle.getString(&quot;in_expandAllTip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L467">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L472">			JTree tree = equipmentSetTable.getTree();</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">			for (int i = 0; i &lt; tree.getRowCount(); i++)</span>
			{
<span class="nc" id="L475">				tree.expandRow(i);</span>
			}
<span class="nc" id="L477">		}</span>

	}

	private class CollapseAllAction extends AbstractAction
	{

		public CollapseAllAction()
<span class="nc" id="L485">		{</span>
<span class="nc" id="L486">			super(&quot;-&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L487">			putValue(SHORT_DESCRIPTION, LanguageBundle.getString(&quot;in_collapseAllTip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L488">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L493">			JTree tree = equipmentSetTable.getTree();</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">			for (int i = tree.getRowCount() - 1; i &gt;= 0; i--)</span>
			{
<span class="nc" id="L496">				tree.collapseRow(i);</span>
			}
<span class="nc" id="L498">		}</span>

	}

	private class UnequipAllAction extends AbstractAction
	{

		private final CharacterFacade character;

		public UnequipAllAction(CharacterFacade character)
<span class="nc" id="L508">		{</span>
<span class="nc" id="L509">			super(LanguageBundle.getString(&quot;in_equipUnequipAll&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L510">			this.character = character;</span>
<span class="nc" id="L511">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{

<span class="nc" id="L517">			int ret =</span>
<span class="nc" id="L518">					JOptionPane.showConfirmDialog(</span>
						EquipInfoTab.this,
<span class="nc" id="L520">						LanguageBundle.getString(&quot;in_equipUnequipConfirm&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L521">						LanguageBundle.getString(&quot;in_areYouSure&quot;), //$NON-NLS-1$</span>
						JOptionPane.YES_NO_OPTION);
<span class="nc bnc" id="L523" title="All 2 branches missed.">			if (ret == JOptionPane.YES_OPTION)</span>
			{
<span class="nc" id="L525">				character.getEquipmentSetRef().get().removeAllEquipment();</span>
			}
<span class="nc" id="L527">		}</span>

	}

	private class LabelsUpdater implements ReferenceListener&lt;String&gt;
	{

		private final ReferenceFacade&lt;String&gt; weightRef;
		private final ReferenceFacade&lt;String&gt; loadRef;
		private final ReferenceFacade&lt;String&gt; limitRef;

		public LabelsUpdater(CharacterFacade character)
<span class="nc" id="L539">		{</span>
<span class="nc" id="L540">			weightRef = character.getCarriedWeightRef();</span>
<span class="nc" id="L541">			loadRef = character.getLoadRef();</span>
<span class="nc" id="L542">			limitRef = character.getWeightLimitRef();</span>
<span class="nc" id="L543">		}</span>

		public void install()
		{
<span class="nc" id="L547">			weightLabel.setText(weightRef.get());</span>
<span class="nc" id="L548">			setLoadLabel(Load.getLoadType(loadRef.get()));</span>
<span class="nc" id="L549">			limitLabel.setText(limitRef.get());</span>

<span class="nc" id="L551">			weightRef.addReferenceListener(this);</span>
<span class="nc" id="L552">			loadRef.addReferenceListener(this);</span>
<span class="nc" id="L553">			limitRef.addReferenceListener(this);</span>
<span class="nc" id="L554">		}</span>

		public void uninstall()
		{
<span class="nc" id="L558">			weightRef.removeReferenceListener(this);</span>
<span class="nc" id="L559">			loadRef.removeReferenceListener(this);</span>
<span class="nc" id="L560">			limitRef.removeReferenceListener(this);</span>
<span class="nc" id="L561">		}</span>

		@Override
		public void referenceChanged(ReferenceEvent&lt;String&gt; e)
		{
<span class="nc" id="L566">			Object source = e.getSource();</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">			if (source == weightRef)</span>
			{
<span class="nc" id="L569">				weightLabel.setText(e.getNewReference());</span>
			}
<span class="nc bnc" id="L571" title="All 2 branches missed.">			else if (source == loadRef)</span>
			{
<span class="nc" id="L573">				setLoadLabel(Load.getLoadType(e.getNewReference()));</span>
			}
			else
			{
<span class="nc" id="L577">				limitLabel.setText(e.getNewReference());</span>
			}
<span class="nc" id="L579">		}</span>

	}

	private class EquipInfoHandler implements ListSelectionListener
	{

		private final CharacterFacade character;
		private String text;

		public EquipInfoHandler(CharacterFacade character)
<span class="nc" id="L590">		{</span>
<span class="nc" id="L591">			this.character = character;</span>
<span class="nc" id="L592">			this.text = &quot;&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L593">		}</span>

		public void install()
		{
<span class="nc" id="L597">			equipmentTable.getSelectionModel().addListSelectionListener(this);</span>
<span class="nc" id="L598">			equipmentSetTable.getSelectionModel().addListSelectionListener(this);</span>
<span class="nc" id="L599">			infoPane.setText(text);</span>
<span class="nc" id="L600">		}</span>

		public void uninstall()
		{
<span class="nc" id="L604">			equipmentTable.getSelectionModel().removeListSelectionListener(this);</span>
<span class="nc" id="L605">			equipmentSetTable.getSelectionModel().removeListSelectionListener(this);</span>
<span class="nc" id="L606">		}</span>

		@Override
		public void valueChanged(ListSelectionEvent e)
		{
<span class="nc" id="L611">			JTable target = equipmentTable;</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">			if (equipmentSetTable.getSelectionModel().equals(e.getSource()))</span>
			{
<span class="nc" id="L614">				target = equipmentSetTable;</span>
			}
<span class="nc bnc" id="L616" title="All 2 branches missed.">			if (!e.getValueIsAdjusting())</span>
			{
<span class="nc" id="L618">				int[] selectedRows = target.getSelectedRows();</span>
<span class="nc" id="L619">				StringBuilder sb = new StringBuilder(2000);</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">				for (int row : selectedRows)</span>
				{
<span class="nc" id="L622">					EquipmentFacade equip = null;</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">					if (row != -1)</span>
					{
<span class="nc" id="L625">						Object value = target.getModel().getValueAt(row, 0);</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">						if (value instanceof EquipmentFacade)</span>
						{
<span class="nc" id="L628">							equip = (EquipmentFacade) value;</span>
						}
<span class="nc bnc" id="L630" title="All 2 branches missed.">						else if (value instanceof EquipNode)</span>
						{
<span class="nc" id="L632">							equip = ((EquipNode) value).getEquipment();</span>
						}
					}
<span class="nc bnc" id="L635" title="All 2 branches missed.">					if (equip != null)</span>
					{
<span class="nc" id="L637">						sb.append(character.getInfoFactory().getHTMLInfo(equip));</span>
					}
				}
<span class="nc" id="L640">				text = &quot;&lt;html&gt;&quot; + sb + &quot;&lt;/html&gt;&quot;; //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L641">				infoPane.setText(text);</span>
			}
<span class="nc" id="L643">		}</span>

	}

	private class EquipmentRenderer extends DefaultTableCellRenderer
	{

		private final CharacterFacade character;

		public EquipmentRenderer(CharacterFacade character)
<span class="nc" id="L653">		{</span>
<span class="nc" id="L654">			this.character = character;</span>
<span class="nc" id="L655">		}</span>

		public void install()
		{
<span class="nc" id="L659">			equipmentTable.setDefaultRenderer(Object.class, this);</span>
<span class="nc" id="L660">		}</span>

		@Override
		public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus,
			int row, int column)
		{
<span class="nc" id="L666">			super.getTableCellRendererComponent(table, value, isSelected, hasFocus, row, column);</span>
<span class="nc bnc" id="L667" title="All 4 branches missed.">			if (value instanceof EquipmentFacade &amp;&amp; !character.isQualifiedFor((EquipmentFacade) value))</span>
			{
<span class="nc" id="L669">				setForeground(ColorUtilty.colorToAWTColor(UIPropertyContext.getNotQualifiedColor()));</span>
			}
<span class="nc bnc" id="L671" title="All 2 branches missed.">			else if (!isSelected)</span>
			{
<span class="nc" id="L673">				setForeground(ColorUtilty.colorToAWTColor(UIPropertyContext.getQualifiedColor()));</span>
			}
<span class="nc" id="L675">			return this;</span>
		}

	}

	private static class EquipNodeSelection implements Transferable
	{

<span class="nc" id="L683">		private static final DataFlavor[] FLAVORS = {EQUIP_NODE_ARRAY_FLAVOR, EQUIPMENT_ARRAY_FLAVOR};</span>
		private final EquipNode[] nodeArray;

		public EquipNodeSelection(EquipNode[] nodeArray)
<span class="nc" id="L687">		{</span>
<span class="nc" id="L688">			this.nodeArray = nodeArray;</span>
<span class="nc" id="L689">		}</span>

		@Override
		public DataFlavor[] getTransferDataFlavors()
		{
<span class="nc" id="L694">			return FLAVORS;</span>
		}

		@Override
		public boolean isDataFlavorSupported(DataFlavor flavor)
		{
<span class="nc bnc" id="L700" title="All 4 branches missed.">			return flavor == FLAVORS[0] || flavor == FLAVORS[1];</span>
		}

		@Override
		public Object getTransferData(DataFlavor flavor) throws UnsupportedFlavorException
		{
<span class="nc bnc" id="L706" title="All 2 branches missed.">			if (flavor == EQUIP_NODE_ARRAY_FLAVOR)</span>
			{
<span class="nc" id="L708">				return nodeArray;</span>
			}
<span class="nc bnc" id="L710" title="All 2 branches missed.">			if (flavor == EQUIPMENT_ARRAY_FLAVOR)</span>
			{
<span class="nc" id="L712">				EquipmentFacade[] equipArray = new EquipmentFacade[nodeArray.length];</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">				for (int i = 0; i &lt; equipArray.length; i++)</span>
				{
<span class="nc" id="L715">					equipArray[i] = nodeArray[i].getEquipment();</span>
				}
<span class="nc" id="L717">				return equipArray;</span>
			}
<span class="nc" id="L719">			throw new UnsupportedFlavorException(flavor);</span>
		}

	}

	private class EquipmentTransferHandler extends TransferHandler
	{

		private final CharacterFacade character;

		public EquipmentTransferHandler(CharacterFacade character)
<span class="nc" id="L730">		{</span>
<span class="nc" id="L731">			this.character = character;</span>
<span class="nc" id="L732">		}</span>

		public void install()
		{
<span class="nc" id="L736">			equipmentTable.setDragEnabled(true);</span>
<span class="nc" id="L737">			equipmentTable.setDropMode(DropMode.ON);</span>
<span class="nc" id="L738">			equipmentTable.setTransferHandler(this);</span>
<span class="nc" id="L739">		}</span>

		@Override
		public int getSourceActions(JComponent c)
		{
<span class="nc" id="L744">			return MOVE;</span>
		}

		@Override
		protected Transferable createTransferable(JComponent c)
		{
<span class="nc bnc" id="L750" title="All 2 branches missed.">			if (c == equipmentTable)</span>
			{
<span class="nc" id="L752">				int[] rows = equipmentTable.getSelectedRows();</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">				if (ArrayUtils.isEmpty(rows))</span>
				{
<span class="nc" id="L755">					return null;</span>
				}
<span class="nc" id="L757">				EquipmentFacade[] equipArray = new EquipmentFacade[rows.length];</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">				for (int i = 0; i &lt; equipArray.length; i++)</span>
				{
<span class="nc" id="L760">					equipArray[i] = (EquipmentFacade) equipmentTable.getModel().getValueAt(rows[i], 0);</span>
				}
<span class="nc" id="L762">				return new EquipmentSelection(equipArray);</span>
			}
<span class="nc" id="L764">			return super.createTransferable(c);</span>
		}

		@Override
		public boolean canImport(TransferSupport support)
		{
<span class="nc bnc" id="L770" title="All 2 branches missed.">			if (!support.isDataFlavorSupported(EQUIP_NODE_ARRAY_FLAVOR))</span>
			{
<span class="nc" id="L772">				return false;</span>
			}
<span class="nc" id="L774">			support.setShowDropLocation(false);</span>
<span class="nc" id="L775">			return true;</span>
		}

		private EquipNode[] getEquipNodeArray(TransferSupport support)
		{
<span class="nc" id="L780">			EquipNode[] equipNodeArray = null;</span>
			try
			{
<span class="nc" id="L783">				equipNodeArray = (EquipNode[]) support.getTransferable().getTransferData(EQUIP_NODE_ARRAY_FLAVOR);</span>
			}
<span class="nc" id="L785">			catch (UnsupportedFlavorException | IOException ex)</span>
			{
<span class="nc" id="L787">				Logger.getLogger(EquipmentTransferHandler.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L788">			}</span>
<span class="nc" id="L789">			return equipNodeArray;</span>
		}

		@Override
		public boolean importData(TransferSupport support)
		{
<span class="nc bnc" id="L795" title="All 2 branches missed.">			if (!canImport(support))</span>
			{
<span class="nc" id="L797">				return false;</span>
			}
<span class="nc bnc" id="L799" title="All 2 branches missed.">			if (!support.isDrop())</span>
			{
<span class="nc" id="L801">				return false;</span>
			}
<span class="nc" id="L803">			EquipNode[] nodes = getEquipNodeArray(support);</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">			if (nodes == null)</span>
			{
<span class="nc" id="L806">				return false;</span>
			}
<span class="nc" id="L808">			EquipmentSetFacade equipSet = character.getEquipmentSetRef().get();</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">			for (EquipNode equipNode : nodes)</span>
			{
<span class="nc" id="L811">				equipSet.removeEquipment(equipNode, 1);</span>
			}
<span class="nc" id="L813">			return true;</span>
		}

	}

	private class EquipmentSetTransferHandler extends TransferHandler
	{

		private final CharacterFacade character;

		public EquipmentSetTransferHandler(CharacterFacade character)
<span class="nc" id="L824">		{</span>
<span class="nc" id="L825">			this.character = character;</span>
<span class="nc" id="L826">		}</span>

		public void install()
		{
<span class="nc" id="L830">			equipmentSetTable.setTransferHandler(this);</span>
<span class="nc" id="L831">			equipmentSetTable.setDragEnabled(true);</span>
<span class="nc" id="L832">			equipmentSetTable.setDropMode(DropMode.ON_OR_INSERT_ROWS);</span>
<span class="nc" id="L833">		}</span>

		@Override
		public int getSourceActions(JComponent c)
		{
<span class="nc" id="L838">			return MOVE;</span>
		}

		@Override
		protected Transferable createTransferable(JComponent c)
		{
<span class="nc bnc" id="L844" title="All 2 branches missed.">			if (c == equipmentSetTable)</span>
			{
<span class="nc" id="L846">				int[] rows = equipmentSetTable.getSelectedRows();</span>
<span class="nc bnc" id="L847" title="All 2 branches missed.">				if (ArrayUtils.isEmpty(rows))</span>
				{
<span class="nc" id="L849">					return null;</span>
				}
<span class="nc" id="L851">				EquipNode[] nodeArray = new EquipNode[rows.length];</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">				for (int i = 0; i &lt; nodeArray.length; i++)</span>
				{
<span class="nc" id="L854">					nodeArray[i] = (EquipNode) equipmentSetTable.getModel().getValueAt(rows[i], 0);</span>
				}
<span class="nc" id="L856">				return new EquipNodeSelection(nodeArray);</span>
			}
<span class="nc" id="L858">			return super.createTransferable(c);</span>
		}

		private EquipmentFacade[] getEquipmentArray(TransferSupport support)
		{
<span class="nc" id="L863">			EquipmentFacade[] equipmentArray = null;</span>
			try
			{
<span class="nc" id="L866">				equipmentArray = (EquipmentFacade[]) support.getTransferable().getTransferData(EQUIPMENT_ARRAY_FLAVOR);</span>
			}
<span class="nc" id="L868">			catch (UnsupportedFlavorException | IOException ex)</span>
			{
<span class="nc" id="L870">				Logger.getLogger(EquipmentSetTransferHandler.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L871">			}</span>
<span class="nc" id="L872">			return equipmentArray;</span>
		}

		private EquipNode[] getEquipNodeArray(TransferSupport support)
		{
<span class="nc" id="L877">			EquipNode[] equipNodeArray = null;</span>
			try
			{
<span class="nc" id="L880">				equipNodeArray = (EquipNode[]) support.getTransferable().getTransferData(EQUIP_NODE_ARRAY_FLAVOR);</span>
			}
<span class="nc" id="L882">			catch (UnsupportedFlavorException | IOException ex)</span>
			{
<span class="nc" id="L884">				Logger.getLogger(EquipmentSetTransferHandler.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L885">			}</span>
<span class="nc" id="L886">			return equipNodeArray;</span>
		}

		@Override
		public boolean canImport(TransferSupport support)
		{
<span class="nc" id="L892">			JTable.DropLocation location = (JTable.DropLocation) support.getDropLocation();</span>
<span class="nc" id="L893">			int row = location.getRow();</span>
<span class="nc" id="L894">			EquipNode node = (EquipNode) equipmentSetTable.getValueAt(row, 0);</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">			if (node == null)</span>
			{
<span class="nc" id="L897">				return false;</span>
			}
<span class="nc bnc" id="L899" title="All 2 branches missed.">			if (location.isInsertRow())</span>
			{
<span class="nc" id="L901">				node = node.getParent();</span>
			}
<span class="nc" id="L903">			EquipmentSetFacade equipSet = character.getEquipmentSetRef().get();</span>

<span class="nc bnc" id="L905" title="All 2 branches missed.">			if (support.isDataFlavorSupported(EQUIP_NODE_ARRAY_FLAVOR))</span>
			{
<span class="nc" id="L907">				EquipNode[] equipNodeArray = getEquipNodeArray(support);</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">				if (equipNodeArray == null)</span>
				{
<span class="nc" id="L910">					return false;</span>
				}
<span class="nc bnc" id="L912" title="All 2 branches missed.">				for (EquipNode equipNode : equipNodeArray)</span>
				{
<span class="nc bnc" id="L914" title="All 2 branches missed.">					if (!equipSet.canEquip(node, equipNode.getEquipment()))</span>
					{
<span class="nc" id="L916">						return false;</span>
					}
				}
<span class="nc" id="L919">				return true;</span>
			}
<span class="nc bnc" id="L921" title="All 2 branches missed.">			else if (support.isDataFlavorSupported(EQUIPMENT_ARRAY_FLAVOR))</span>
			{
<span class="nc" id="L923">				EquipmentFacade[] equipmentArray = getEquipmentArray(support);</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">				if (equipmentArray == null)</span>
				{
<span class="nc" id="L926">					return false;</span>
				}
<span class="nc bnc" id="L928" title="All 2 branches missed.">				for (EquipmentFacade equipmentFacade : equipmentArray)</span>
				{
<span class="nc bnc" id="L930" title="All 2 branches missed.">					if (!equipSet.canEquip(node, equipmentFacade))</span>
					{
<span class="nc" id="L932">						return false;</span>
					}
				}
<span class="nc" id="L935">				return true;</span>
			}
<span class="nc" id="L937">			return false;</span>
		}

		@Override
		public boolean importData(TransferSupport support)
		{
<span class="nc bnc" id="L943" title="All 4 branches missed.">			if (!canImport(support) || !support.isDrop())</span>
			{
<span class="nc" id="L945">				return false;</span>
			}

<span class="nc" id="L948">			JTable.DropLocation location = (JTable.DropLocation) support.getDropLocation();</span>
<span class="nc" id="L949">			int row = location.getRow();</span>
<span class="nc" id="L950">			EquipNode node = (EquipNode) equipmentSetTable.getValueAt(row, 0);</span>
<span class="nc" id="L951">			EquipNode beforeNode = null;</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">			if (location.isInsertRow())</span>
			{
<span class="nc" id="L954">				beforeNode = node;</span>
<span class="nc" id="L955">				node = node.getParent();</span>
			}
<span class="nc" id="L957">			EquipmentSetFacade equipSet = character.getEquipmentSetRef().get();</span>

<span class="nc bnc" id="L959" title="All 2 branches missed.">			if (support.isDataFlavorSupported(EQUIP_NODE_ARRAY_FLAVOR))</span>
			{
<span class="nc" id="L961">				EquipNode[] equipNodeArray = getEquipNodeArray(support);</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">				if (equipNodeArray == null)</span>
				{
<span class="nc" id="L964">					return false;</span>
				}
<span class="nc bnc" id="L966" title="All 2 branches missed.">				for (EquipNode equipNode : equipNodeArray)</span>
				{
<span class="nc" id="L968">					int quantity = equipSet.getQuantity(equipNode);</span>
<span class="nc" id="L969">					equipSet.removeEquipment(equipNode, quantity);</span>
<span class="nc" id="L970">					equipSet.addEquipment(node, equipNode.getEquipment(), quantity, beforeNode);</span>
				}
<span class="nc" id="L972">			}</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">			else if (support.isDataFlavorSupported(EQUIPMENT_ARRAY_FLAVOR))</span>
			{
<span class="nc" id="L975">				EquipmentFacade[] equipmentArray = getEquipmentArray(support);</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">				if (equipmentArray == null)</span>
				{
<span class="nc" id="L978">					return false;</span>
				}
<span class="nc bnc" id="L980" title="All 2 branches missed.">				for (EquipmentFacade equipmentFacade : equipmentArray)</span>
				{
<span class="nc" id="L982">					equipSet.addEquipment(node, equipmentFacade, 1, beforeNode);</span>
				}
			}
<span class="nc" id="L985">			return true;</span>
		}

	}

	private final class OrderPopupMenuHandler extends PopupMouseAdapter
	{

		private final CharacterFacade character;

		private OrderPopupMenuHandler(CharacterFacade character)
<span class="nc" id="L996">		{</span>
<span class="nc" id="L997">			this.character = character;</span>
<span class="nc" id="L998">		}</span>

		@Override
		public void showPopup(MouseEvent e)
		{
<span class="nc" id="L1003">			List&lt;EquipNode&gt; targets = getMenuTargets(equipmentSetTable, e);</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">			if (targets.isEmpty())</span>
			{
<span class="nc" id="L1006">				return;</span>
			}

<span class="nc" id="L1009">			JPopupMenu popupMenu = new JPopupMenu();</span>
<span class="nc" id="L1010">			popupMenu.add(new MoveEquipUpMenuItem(character, targets));</span>
<span class="nc" id="L1011">			popupMenu.add(new MoveEquipDownMenuItem(character, targets));</span>
<span class="nc" id="L1012">			popupMenu.addSeparator();</span>
<span class="nc" id="L1013">			popupMenu.add(new SortEquipMenuItem(character, targets));</span>
<span class="nc" id="L1014">			popupMenu.addSeparator();</span>
<span class="nc" id="L1015">			popupMenu.add(new EditChargesMenuItem(character, targets));</span>
<span class="nc" id="L1016">			popupMenu.show(e.getComponent(), e.getX(), e.getY());</span>
<span class="nc" id="L1017">		}</span>

		public void install()
		{
<span class="nc" id="L1021">			equipmentSetTable.addMouseListener(this);</span>
<span class="nc" id="L1022">		}</span>

		public void uninstall()
		{
<span class="nc" id="L1026">			equipmentSetTable.removeMouseListener(this);</span>
<span class="nc" id="L1027">		}</span>

	}

	/**
	 * Menu item for moving the selected equipment up a step in their container.
	 */
	private static class MoveEquipUpMenuItem extends JMenuItem implements ActionListener
	{

		private final CharacterFacade character;
		private final List&lt;? extends EquipNode&gt; targets;

		MoveEquipUpMenuItem(CharacterFacade character, List&lt;? extends EquipNode&gt; targets)
		{
<span class="nc" id="L1042">			super(LanguageBundle.getString(&quot;in_equipMoveUpMenuCommand&quot;)); //$NON-NLS-1$ </span>
<span class="nc" id="L1043">			this.character = character;</span>
<span class="nc" id="L1044">			this.targets = targets;</span>
<span class="nc" id="L1045">			setToolTipText(LanguageBundle.getString(&quot;in_equipMoveUpMenuDesc&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1046">			setIcon(Icons.Up16.getImageIcon());</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">			setEnabled(!targets.isEmpty());</span>

<span class="nc" id="L1049">			addActionListener(this);</span>
<span class="nc" id="L1050">		}</span>

		/**
		 * Action to move the current item up in the current container
		 */
		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1058">			EquipmentSetFacade equipSet = character.getEquipmentSetRef().get();</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">			for (EquipNode equipNode : targets)</span>
			{
<span class="nc" id="L1061">				equipSet.moveEquipment(equipNode, -1);</span>
<span class="nc" id="L1062">			}</span>
<span class="nc" id="L1063">		}</span>

	}

	/**
	 * Menu item for moving the selected equipment up a step in their container.
	 */
	private static class MoveEquipDownMenuItem extends JMenuItem implements ActionListener
	{

		private final CharacterFacade character;
		private final List&lt;EquipNode&gt; targets;

		MoveEquipDownMenuItem(CharacterFacade character, List&lt;EquipNode&gt; targets)
		{
<span class="nc" id="L1078">			super(LanguageBundle.getString(&quot;in_equipMoveDownMenuCommand&quot;)); //$NON-NLS-1$ </span>
<span class="nc" id="L1079">			this.character = character;</span>
<span class="nc" id="L1080">			this.targets = targets;</span>
<span class="nc" id="L1081">			setToolTipText(LanguageBundle.getString(&quot;in_equipMoveDownMenuDesc&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1082">			setIcon(Icons.Down16.getImageIcon());</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">			setEnabled(!targets.isEmpty());</span>

<span class="nc" id="L1085">			addActionListener(this);</span>
<span class="nc" id="L1086">		}</span>

		/**
		 * Action to move the current item up in the current container
		 */
		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1094">			EquipmentSetFacade equipSet = character.getEquipmentSetRef().get();</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">			for (EquipNode equipNode : targets)</span>
			{
<span class="nc" id="L1097">				equipSet.moveEquipment(equipNode, 1);</span>
<span class="nc" id="L1098">			}</span>
<span class="nc" id="L1099">		}</span>

	}

	/**
	 * Menu item for moving the selected equipment up a step in their container.
	 */
	private static final class SortEquipMenuItem extends JMenuItem implements ActionListener
	{

		private final CharacterFacade character;
		private final List&lt;? extends EquipNode&gt; targets;

		SortEquipMenuItem(CharacterFacade character, List&lt;? extends EquipNode&gt; targets)
		{
<span class="nc" id="L1114">			super(LanguageBundle.getString(&quot;in_equipSortAscMenuCommand&quot;)); //$NON-NLS-1$ </span>
<span class="nc" id="L1115">			this.character = character;</span>
<span class="nc" id="L1116">			this.targets = targets;</span>
<span class="nc" id="L1117">			setToolTipText(LanguageBundle.getString(&quot;in_equipSortAscMenuDesc&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1118">			setIcon(Icons.FForward16.getImageIcon());</span>
<span class="nc" id="L1119">			setEnabled(false);</span>
<span class="nc bnc" id="L1120" title="All 4 branches missed.">			if (targets.stream().anyMatch(e -&gt; e.getNodeType() != EQUIPMENT))</span>
			{
<span class="nc" id="L1122">				setEnabled(true);</span>
			}
<span class="nc" id="L1124">			addActionListener(this);</span>
<span class="nc" id="L1125">		}</span>

		/**
		 * Action to move the current item up in the current container
		 */
		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1133">			EquipmentSetFacade equipSet = character.getEquipmentSetRef().get();</span>
<span class="nc" id="L1134">			targets.forEach(equipSet::sortEquipment);</span>
<span class="nc" id="L1135">		}</span>

	}

	/**
	 * Menu item for editing the number of charges on an item.
	 */
	private static class EditChargesMenuItem extends JMenuItem implements ActionListener
	{
		private final CharacterFacade character;
		private final List&lt;? extends EquipNode&gt; targets;

		EditChargesMenuItem(CharacterFacade character, List&lt;? extends EquipNode&gt; targets)
		{
<span class="nc" id="L1149">			super(LanguageBundle.getString(&quot;in_igModifyCharges&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1150">			this.character = character;</span>
<span class="nc" id="L1151">			this.targets = targets;</span>
<span class="nc" id="L1152">			setIcon(Icons.Edit16.getImageIcon());</span>
			// Set enabled only if there are items with charges
<span class="nc" id="L1154">			boolean hasItemWithCharges = false;</span>
<span class="nc bnc" id="L1155" title="All 2 branches missed.">			for (EquipNode node : targets)</span>
			{
<span class="nc" id="L1157">				EquipmentFacade equipment = node.getEquipment();</span>
<span class="nc bnc" id="L1158" title="All 4 branches missed.">				if (equipment instanceof Equipment &amp;&amp; ((Equipment) equipment).getMaxCharges() &gt; 0)</span>
				{
<span class="nc" id="L1160">					hasItemWithCharges = true;</span>
<span class="nc" id="L1161">					break;</span>
				}
<span class="nc" id="L1163">			}</span>
<span class="nc" id="L1164">			setEnabled(hasItemWithCharges);</span>

<span class="nc" id="L1166">			addActionListener(this);</span>
<span class="nc" id="L1167">		}</span>

		@Override
		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1172">			List&lt;EquipmentFacade&gt; equipmentList = targets.stream()</span>
<span class="nc" id="L1173">					.map(EquipNode::getEquipment)</span>
<span class="nc" id="L1174">					.filter(Objects::nonNull)</span>
<span class="nc" id="L1175">					.collect(Collectors.toList());</span>

<span class="nc" id="L1177">			character.modifyCharges(equipmentList);</span>
<span class="nc" id="L1178">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>