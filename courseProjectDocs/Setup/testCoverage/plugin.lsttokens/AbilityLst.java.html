<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbilityLst.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">plugin.lsttokens</a> &gt; <span class="el_source">AbilityLst.java</span></div><h1>AbilityLst.java</h1><pre class="source lang-java linenums">/*
 * AbilityLst.java
 * Copyright 2006 (C) Aaron Divinsky &lt;boomer70@yahoo.com&gt;
 * Copyright 2008-12 (C) Thomas Parker &lt;thpr@users.sourceforge.net&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package plugin.lsttokens;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Set;
import java.util.StringTokenizer;
import java.util.TreeSet;

import pcgen.base.util.MapToList;
import pcgen.base.util.TripleKeyMapToList;
import pcgen.cdom.base.AssociatedPrereqObject;
import pcgen.cdom.base.CDOMList;
import pcgen.cdom.base.CDOMObject;
import pcgen.cdom.base.CDOMReference;
import pcgen.cdom.base.ChooseSelectionActor;
import pcgen.cdom.base.Constants;
import pcgen.cdom.base.PrereqObject;
import pcgen.cdom.base.Ungranted;
import pcgen.cdom.enumeration.AssociationKey;
import pcgen.cdom.enumeration.ListKey;
import pcgen.cdom.enumeration.Nature;
import pcgen.cdom.helper.AbilitySelector;
import pcgen.cdom.helper.AbilityTargetSelector;
import pcgen.cdom.list.AbilityList;
import pcgen.cdom.reference.CDOMDirectSingleRef;
import pcgen.cdom.reference.CDOMSingleRef;
import pcgen.cdom.reference.ReferenceManufacturer;
import pcgen.cdom.reference.ReferenceUtilities;
import pcgen.core.Ability;
import pcgen.core.AbilityCategory;
import pcgen.core.AbilityUtilities;
import pcgen.core.prereq.Prerequisite;
import pcgen.persistence.PersistenceLayerException;
import pcgen.rules.context.AssociatedChanges;
import pcgen.rules.context.Changes;
import pcgen.rules.context.LoadContext;
import pcgen.rules.persistence.TokenUtilities;
import pcgen.rules.persistence.token.AbstractTokenWithSeparator;
import pcgen.rules.persistence.token.CDOMPrimaryToken;
import pcgen.rules.persistence.token.DeferredToken;
import pcgen.rules.persistence.token.ParseResult;

/**
 * Implements the ABILITY: global LST token.
 *
 * &lt;p&gt;
 * &lt;b&gt;Tag Name&lt;/b&gt;: {@code ABILITY}:x|y|z|z&lt;br&gt;
 * &lt;b&gt;Variables Used (x)&lt;/b&gt;: Ability Category (The Ability Category this ability will be added to).&lt;br&gt;
 * &lt;b&gt;Variables Used (y)&lt;/b&gt;: Ability Nature (The nature of the added ability:
 * &lt;tt&gt;NORMAL&lt;/tt&gt;, &lt;tt&gt;AUTOMATIC&lt;/tt&gt;, or &lt;tt&gt;VIRTUAL&lt;/tt&gt;)&lt;br&gt;
 * &lt;b&gt;Variables Used (z)&lt;/b&gt;: Ability Key or TYPE(The Ability to add. Can have
 * choices specified in &amp;quot;()&amp;quot;)&lt;br&gt;
 * &lt;b&gt;Prereqs Allowed&lt;/b&gt;: Yes &lt;br&gt;
 * &lt;p&gt;
 * &lt;b&gt;What it does:&lt;/b&gt;&lt;br&gt;
 * &lt;ul&gt;
 * &lt;li&gt;Adds an Ability to a character.&lt;/li&gt;
 * &lt;li&gt;The Ability is added to the Ability Category specied and that category's
 * pool will be charged if the Nature is &lt;tt&gt;NORMAL&lt;/tt&gt;&lt;/li&gt;
 * &lt;li&gt;This tag will &lt;b&gt;not&lt;/b&gt; cause a chooser to appear so all required
 * choices must be specified in the tag&lt;/li&gt;
 * &lt;li&gt;Choices can be specified by including them in parenthesis after the
 * ability key name (whitespace is ignored).&lt;/li&gt;
 * &lt;li&gt;A &lt;tt&gt;CATEGORY&lt;/tt&gt; tag can be added to the ability key to specify that
 * the innate ability category specified be searched for a matching ability.&lt;/li&gt;
 * &lt;li&gt;If no &lt;tt&gt;CATEGORY&lt;/tt&gt; is specified the standard list for the ability
 * category will be used to find a matching ability.&lt;/li&gt;
 * &lt;li&gt;This tag is a replacement for the following tags: &lt;tt&gt;FEAT&lt;/tt&gt;,
 * &lt;tt&gt;VFEAT&lt;/tt&gt;, and &lt;tt&gt;FEATAUTO&lt;/tt&gt;.
 * &lt;/ul&gt;
 * &lt;b&gt;Where it is used:&lt;/b&gt;&lt;br&gt;
 * Global tag can be used anywhere.
 * &lt;p&gt;
 * &lt;b&gt;Examples:&lt;/b&gt;&lt;br&gt;
 * {@code ABILITY:FEAT|AUTOMATIC|TYPE=Metamagic}&lt;br&gt;
 * Adds a Metamagic feat as an Auto feat.
 * &lt;p&gt;
 *
 * {@code ABILITY:CLASSFEATURE|VIRTUAL|CATEGORY=FEAT:Stunning Fist}&lt;br&gt;
 * Adds the Stunning Fist feat as a virtual class feature.
 * &lt;p&gt;
 */
<span class="fc" id="L103">public class AbilityLst extends AbstractTokenWithSeparator&lt;CDOMObject&gt;</span>
		implements CDOMPrimaryToken&lt;CDOMObject&gt;, DeferredToken&lt;CDOMObject&gt;
{

<span class="fc" id="L107">	private static final Class&lt;Ability&gt; ABILITY_CLASS = Ability.class;</span>
<span class="fc" id="L108">	private static final Class&lt;AbilityCategory&gt; ABILITY_CATEGORY_CLASS = AbilityCategory.class;</span>

	@Override
	public String getTokenName()
	{
<span class="fc" id="L113">		return &quot;ABILITY&quot;;</span>
	}

	@Override
	protected char separator()
	{
<span class="fc" id="L119">		return '|';</span>
	}

	@Override
	protected ParseResult parseTokenWithSeparator(LoadContext context, CDOMObject obj, String value)
	{
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">		if (obj instanceof Ungranted)</span>
		{
<span class="nc" id="L127">			return new ParseResult.Fail(</span>
<span class="nc" id="L128">				&quot;Cannot use &quot; + getTokenName() + &quot; on an Ungranted object type: &quot; + obj.getClass().getSimpleName());</span>
		}
<span class="fc" id="L130">		StringTokenizer tok = new StringTokenizer(value, Constants.PIPE);</span>
<span class="fc" id="L131">		String cat = tok.nextToken();</span>
<span class="fc" id="L132">		CDOMSingleRef&lt;AbilityCategory&gt; acRef =</span>
<span class="fc" id="L133">				context.getReferenceContext().getCDOMReference(ABILITY_CATEGORY_CLASS, cat);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">		if (!tok.hasMoreTokens())</span>
		{
<span class="fc" id="L136">			return new ParseResult.Fail(</span>
<span class="fc" id="L137">				getTokenName() + &quot; must have a Nature, &quot; + &quot;Format is: CATEGORY|NATURE|AbilityName: &quot; + value);</span>
		}
<span class="fc" id="L139">		final String natureKey = tok.nextToken();</span>
		Nature nature;
		try
		{
<span class="fc" id="L143">			nature = Nature.valueOf(natureKey);</span>
		}
<span class="fc" id="L145">		catch (IllegalArgumentException iae)</span>
		{
<span class="fc" id="L147">			return new ParseResult.Fail(getTokenName() + &quot; refers to invalid Ability Nature: &quot; + natureKey);</span>
<span class="fc" id="L148">		}</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">		if (Nature.ANY.equals(nature))</span>
		{
<span class="fc" id="L151">			return new ParseResult.Fail(</span>
<span class="fc" id="L152">				getTokenName() + &quot; refers to ANY Ability Nature, cannot be used in &quot; + getTokenName() + &quot;: &quot; + value);</span>
		}
<span class="fc bfc" id="L154" title="All 2 branches covered.">		if (!tok.hasMoreTokens())</span>
		{
<span class="fc" id="L156">			return new ParseResult.Fail(</span>
<span class="fc" id="L157">				getTokenName() + &quot; must have abilities, Format is: &quot; + &quot;CATEGORY|NATURE|AbilityName: &quot; + value);</span>
		}

<span class="fc" id="L160">		String token = tok.nextToken();</span>

<span class="fc bfc" id="L162" title="All 2 branches covered.">		if (looksLikeAPrerequisite(token))</span>
		{
<span class="fc" id="L164">			return new ParseResult.Fail(&quot;Cannot have only PRExxx subtoken in &quot; + getTokenName() + &quot;: &quot; + value);</span>
		}

<span class="fc" id="L167">		String lkString = &quot;GA_CA_&quot; + cat + '_' + natureKey;</span>
<span class="fc" id="L168">		ListKey glk = ListKey.getKeyFor(ChooseSelectionActor.class, lkString);</span>
<span class="fc" id="L169">		ListKey&lt;ChooseSelectionActor&lt;?&gt;&gt; lk = glk;</span>

<span class="fc" id="L171">		ArrayList&lt;PrereqObject&gt; edgeList = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L173">		CDOMReference&lt;AbilityList&gt; abilList = AbilityList.getAbilityListReference(acRef, nature);</span>

<span class="fc" id="L175">		boolean first = true;</span>
<span class="fc" id="L176">		boolean removed = false;</span>

<span class="fc" id="L178">		ReferenceManufacturer&lt;Ability&gt; rm =</span>
<span class="fc" id="L179">				context.getReferenceContext().getManufacturerByFormatName(&quot;ABILITY=&quot; + cat, ABILITY_CLASS);</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">		if (rm == null)</span>
		{
<span class="fc" id="L182">			return new ParseResult.Fail(&quot;Could not get Reference Manufacturer for Category: &quot; + cat);</span>
		}

<span class="fc" id="L185">		boolean prereqsAllowed = true;</span>

		while (true)
		{
<span class="fc bfc" id="L189" title="All 2 branches covered.">			if (Constants.LST_DOT_CLEAR.equals(token))</span>
			{
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">				if (!first)</span>
				{
<span class="nc" id="L193">					return new ParseResult.Fail(</span>
<span class="nc" id="L194">						&quot;  Non-sensical &quot; + getTokenName() + &quot;: .CLEAR was not the first list item: &quot; + value);</span>
				}
<span class="fc" id="L196">				context.getListContext().removeAllFromList(getTokenName(), obj, abilList);</span>
<span class="fc" id="L197">				context.getObjectContext().removeFromList(obj, ListKey.GA_CAKEYS, lk);</span>
<span class="fc" id="L198">				context.getObjectContext().removeList(obj, lk);</span>
<span class="fc" id="L199">				removed = true;</span>
			}
<span class="fc bfc" id="L201" title="All 2 branches covered.">			else if (token.startsWith(Constants.LST_DOT_CLEAR_DOT))</span>
			{
<span class="fc" id="L203">				String clearText = token.substring(7);</span>
<span class="fc" id="L204">				CDOMReference&lt;Ability&gt; ref = TokenUtilities.getTypeOrPrimitive(rm, clearText);</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">				if (ref == null)</span>
				{
<span class="fc" id="L207">					return ParseResult.INTERNAL_ERROR;</span>
				}
<span class="fc" id="L209">				AssociatedPrereqObject assoc =</span>
<span class="fc" id="L210">						context.getListContext().removeFromList(getTokenName(), obj, abilList, ref);</span>
<span class="fc" id="L211">				assoc.setAssociation(AssociationKey.NATURE, nature);</span>
<span class="fc" id="L212">				assoc.setAssociation(AssociationKey.CATEGORY, acRef);</span>
<span class="fc" id="L213">				removed = true;</span>
<span class="fc" id="L214">			}</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">			else if (Constants.LST_PERCENT_LIST.equals(token))</span>
			{
<span class="fc" id="L217">				prereqsAllowed = false;</span>
<span class="fc" id="L218">				AbilitySelector as = new AbilitySelector(getTokenName(), acRef, nature);</span>
<span class="fc" id="L219">				context.getObjectContext().addToList(obj, ListKey.NEW_CHOOSE_ACTOR, as);</span>
<span class="fc" id="L220">			}</span>
			else
			{
<span class="fc" id="L223">				CDOMReference&lt;Ability&gt; ability = TokenUtilities.getTypeOrPrimitive(rm, token);</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">				if (ability == null)</span>
				{
<span class="fc" id="L226">					return ParseResult.INTERNAL_ERROR;</span>
				}
<span class="fc" id="L228">				ability.setRequiresTarget(true);</span>
<span class="fc" id="L229">				boolean loadList = true;</span>
<span class="fc" id="L230">				List&lt;String&gt; choices = null;</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">				if (token.indexOf('(') != -1)</span>
				{
<span class="fc" id="L233">					choices = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L234">					AbilityUtilities.getUndecoratedName(token, choices);</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">					if (choices.size() == 1)</span>
					{
<span class="pc bpc" id="L237" title="1 of 4 branches missed.">						if (Constants.LST_PERCENT_LIST.equals(choices.get(0)) &amp;&amp; (ability instanceof CDOMSingleRef&lt;Ability&gt; ref))</span>
						{
<span class="fc" id="L239">							AbilityTargetSelector ats = new AbilityTargetSelector(getTokenName(), acRef, ref, nature);</span>
<span class="fc" id="L240">							context.getObjectContext().addToList(obj, ListKey.GA_CAKEYS, lk);</span>
<span class="fc" id="L241">							context.getObjectContext().addToList(obj, lk, ats);</span>
<span class="fc" id="L242">							edgeList.add(ats);</span>
<span class="fc" id="L243">							loadList = false;</span>
						}
					}
				}
<span class="fc bfc" id="L247" title="All 2 branches covered.">				if (loadList)</span>
				{
<span class="fc" id="L249">					AssociatedPrereqObject assoc =</span>
<span class="fc" id="L250">							context.getListContext().addToList(getTokenName(), obj, abilList, ability);</span>
<span class="fc" id="L251">					assoc.setAssociation(AssociationKey.NATURE, nature);</span>
<span class="fc" id="L252">					assoc.setAssociation(AssociationKey.CATEGORY, acRef);</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">					if (choices != null)</span>
					{
<span class="fc" id="L255">						assoc.setAssociation(AssociationKey.ASSOC_CHOICES, choices);</span>
					}
<span class="fc" id="L257">					edgeList.add(assoc);</span>
				}
			}
<span class="fc bfc" id="L260" title="All 2 branches covered.">			if (!tok.hasMoreTokens())</span>
			{
				// No prereqs, so we're done
<span class="fc" id="L263">				return ParseResult.SUCCESS;</span>
			}
<span class="fc" id="L265">			first = false;</span>
<span class="fc" id="L266">			token = tok.nextToken();</span>
<span class="fc bfc" id="L267" title="All 2 branches covered.">			if (looksLikeAPrerequisite(token))</span>
			{
<span class="fc" id="L269">				break;</span>
			}
		}

<span class="fc bfc" id="L273" title="All 4 branches covered.">		if (removed || !prereqsAllowed)</span>
		{
<span class="fc" id="L275">			return new ParseResult.Fail(&quot;Cannot use PREREQs when using .CLEAR, .CLEAR., or %LIST in &quot; + getTokenName());</span>
		}

		while (true)
		{
<span class="fc" id="L280">			Prerequisite prereq = getPrerequisite(token);</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">			if (prereq == null)</span>
			{
<span class="fc" id="L283">				return new ParseResult.Fail(</span>
<span class="fc" id="L284">					&quot;   (Did you put feats after the &quot; + &quot;PRExxx tags in &quot; + getTokenName() + &quot;:?)&quot;);</span>
			}
<span class="fc bfc" id="L286" title="All 2 branches covered.">			for (PrereqObject edge : edgeList)</span>
			{
<span class="fc" id="L288">				edge.addPrerequisite(prereq);</span>
<span class="fc" id="L289">			}</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">			if (!tok.hasMoreTokens())</span>
			{
<span class="fc" id="L292">				break;</span>
			}
<span class="fc" id="L294">			token = tok.nextToken();</span>
<span class="fc" id="L295">		}</span>

<span class="fc" id="L297">		return ParseResult.SUCCESS;</span>
	}

	@Override
	public String[] unparse(LoadContext context, CDOMObject obj)
	{
<span class="fc" id="L303">		Collection&lt;CDOMReference&lt;? extends CDOMList&lt;?&gt;&gt;&gt; changedLists =</span>
<span class="fc" id="L304">				context.getListContext().getChangedLists(obj, AbilityList.class);</span>
<span class="fc" id="L305">		Changes&lt;ListKey&lt;ChooseSelectionActor&lt;?&gt;&gt;&gt; actors =</span>
<span class="fc" id="L306">				context.getObjectContext().getListChanges(obj, ListKey.GA_CAKEYS);</span>
<span class="fc" id="L307">		Set&lt;String&gt; returnSet = new TreeSet&lt;&gt;();</span>
<span class="fc" id="L308">		TripleKeyMapToList&lt;Nature, CDOMSingleRef&lt;AbilityCategory&gt;, List&lt;Prerequisite&gt;, CDOMReference&lt;Ability&gt;&gt; m =</span>
				new TripleKeyMapToList&lt;&gt;();
<span class="fc" id="L310">		TripleKeyMapToList&lt;Nature, CDOMSingleRef&lt;AbilityCategory&gt;, List&lt;Prerequisite&gt;, CDOMReference&lt;Ability&gt;&gt; clear =</span>
				new TripleKeyMapToList&lt;&gt;();

<span class="fc" id="L313">		Changes&lt;ChooseSelectionActor&lt;?&gt;&gt; listChanges =</span>
<span class="fc" id="L314">				context.getObjectContext().getListChanges(obj, ListKey.NEW_CHOOSE_ACTOR);</span>
<span class="fc" id="L315">		Collection&lt;ChooseSelectionActor&lt;?&gt;&gt; listAdded = listChanges.getAdded();</span>
<span class="pc bpc" id="L316" title="1 of 4 branches missed.">		if ((listAdded != null) &amp;&amp; !listAdded.isEmpty())</span>
		{
<span class="fc bfc" id="L318" title="All 2 branches covered.">			for (ChooseSelectionActor&lt;?&gt; csa : listAdded)</span>
			{
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">				if (csa.getSource().equals(getTokenName()))</span>
				{
<span class="fc" id="L322">					AbilitySelector as = (AbilitySelector) csa;</span>
<span class="fc" id="L323">					String sb = as.getAbilityCategory().getLSTformat(false) + Constants.PIPE</span>
<span class="fc" id="L324">							+ as.getNature() + Constants.PIPE</span>
<span class="fc" id="L325">							+ as.getLstFormat();</span>
<span class="fc" id="L326">					returnSet.add(sb);</span>
				}
<span class="fc" id="L328">			}</span>
		}

<span class="fc bfc" id="L331" title="All 2 branches covered.">		for (CDOMReference ref : changedLists)</span>
		{
<span class="fc" id="L333">			AssociatedChanges&lt;CDOMReference&lt;Ability&gt;&gt; changes =</span>
<span class="fc" id="L334">					context.getListContext().getChangesInList(getTokenName(), obj, ref);</span>
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">			if (changes.includesGlobalClear())</span>
			{
<span class="nc" id="L337">				CDOMDirectSingleRef&lt;AbilityList&gt; dr = (CDOMDirectSingleRef&lt;AbilityList&gt;) ref;</span>
<span class="nc" id="L338">				AbilityList al = dr.get();</span>
<span class="nc" id="L339">				String sb = al.getCategory().getLSTformat(false) + Constants.PIPE</span>
<span class="nc" id="L340">						+ al.getNature() + Constants.PIPE</span>
						+ Constants.LST_DOT_CLEAR;
<span class="nc" id="L342">				returnSet.add(sb);</span>
			}
<span class="fc" id="L344">			MapToList&lt;CDOMReference&lt;Ability&gt;, AssociatedPrereqObject&gt; mtl = changes.getAddedAssociations();</span>
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">			if (mtl != null)</span>
			{
<span class="fc bfc" id="L347" title="All 2 branches covered.">				for (CDOMReference&lt;Ability&gt; ab : mtl.getKeySet())</span>
				{
<span class="fc bfc" id="L349" title="All 2 branches covered.">					for (AssociatedPrereqObject assoc : mtl.getListFor(ab))</span>
					{
<span class="fc" id="L351">						Nature nature = assoc.getAssociation(AssociationKey.NATURE);</span>
<span class="fc" id="L352">						CDOMSingleRef&lt;AbilityCategory&gt; cat = assoc.getAssociation(AssociationKey.CATEGORY);</span>
<span class="fc" id="L353">						m.addToListFor(nature, cat, assoc.getPrerequisiteList(), ab);</span>
<span class="fc" id="L354">					}</span>
<span class="fc" id="L355">				}</span>
			}
<span class="fc" id="L357">			mtl = changes.getRemovedAssociations();</span>
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">			if (mtl != null)</span>
			{
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">				for (CDOMReference&lt;Ability&gt; ab : mtl.getKeySet())</span>
				{
<span class="nc bnc" id="L362" title="All 2 branches missed.">					for (AssociatedPrereqObject assoc : mtl.getListFor(ab))</span>
					{
<span class="nc" id="L364">						Nature nature = assoc.getAssociation(AssociationKey.NATURE);</span>
<span class="nc" id="L365">						CDOMSingleRef&lt;AbilityCategory&gt; cat = assoc.getAssociation(AssociationKey.CATEGORY);</span>
<span class="nc" id="L366">						clear.addToListFor(nature, cat, assoc.getPrerequisiteList(), ab);</span>
<span class="nc" id="L367">					}</span>
<span class="nc" id="L368">				}</span>
			}
<span class="fc" id="L370">		}</span>

<span class="fc bfc" id="L372" title="All 2 branches covered.">		for (Nature nature : m.getKeySet())</span>
		{
<span class="fc bfc" id="L374" title="All 2 branches covered.">			for (CDOMSingleRef&lt;AbilityCategory&gt; category : m.getSecondaryKeySet(nature))</span>
			{
<span class="fc bfc" id="L376" title="All 2 branches covered.">				for (List&lt;Prerequisite&gt; prereqs : m.getTertiaryKeySet(nature, category))</span>
				{
<span class="fc" id="L378">					StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L379">					sb.append(category.getLSTformat(false)).append(Constants.PIPE);</span>
<span class="fc" id="L380">					sb.append(nature);</span>
<span class="fc" id="L381">					List&lt;CDOMReference&lt;Ability&gt;&gt; clearList = clear.removeListFor(nature, category, prereqs);</span>
<span class="pc bpc" id="L382" title="3 of 4 branches missed.">					if ((clearList != null) &amp;&amp; !clearList.isEmpty())</span>
					{
<span class="nc" id="L384">						sb.append(Constants.PIPE);</span>
<span class="nc" id="L385">						sb.append(Constants.LST_DOT_CLEAR_DOT);</span>
<span class="nc" id="L386">						sb.append(</span>
<span class="nc" id="L387">							ReferenceUtilities.joinLstFormat(clearList, Constants.PIPE + Constants.LST_DOT_CLEAR_DOT));</span>
					}
<span class="fc" id="L389">					sb.append(Constants.PIPE);</span>
<span class="fc" id="L390">					sb.append(</span>
<span class="fc" id="L391">						ReferenceUtilities.joinLstFormat(m.getListFor(nature, category, prereqs), Constants.PIPE));</span>
<span class="pc bpc" id="L392" title="1 of 4 branches missed.">					if ((prereqs != null) &amp;&amp; !prereqs.isEmpty())</span>
					{
<span class="fc" id="L394">						sb.append(Constants.PIPE);</span>
<span class="fc" id="L395">						sb.append(getPrerequisiteString(context, prereqs));</span>
					}
<span class="fc" id="L397">					returnSet.add(sb.toString());</span>
<span class="fc" id="L398">				}</span>
<span class="fc" id="L399">			}</span>
<span class="fc" id="L400">		}</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">		for (Nature nature : clear.getKeySet())</span>
		{
<span class="nc bnc" id="L403" title="All 2 branches missed.">			for (CDOMSingleRef&lt;AbilityCategory&gt; category : clear.getSecondaryKeySet(nature))</span>
			{
<span class="nc bnc" id="L405" title="All 2 branches missed.">				for (List&lt;Prerequisite&gt; prereqs : clear.getTertiaryKeySet(nature, category))</span>
				{
<span class="nc" id="L407">					StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L408">					sb.append(category.getLSTformat(false)).append(Constants.PIPE);</span>
<span class="nc" id="L409">					sb.append(nature).append(Constants.PIPE).append(Constants.LST_DOT_CLEAR_DOT);</span>
<span class="nc" id="L410">					sb.append(ReferenceUtilities.joinLstFormat(clear.getListFor(nature, category, prereqs),</span>
						Constants.PIPE + Constants.LST_DOT_CLEAR_DOT));
<span class="nc bnc" id="L412" title="All 4 branches missed.">					if ((prereqs != null) &amp;&amp; !prereqs.isEmpty())</span>
					{
<span class="nc" id="L414">						sb.append(Constants.PIPE);</span>
<span class="nc" id="L415">						sb.append(getPrerequisiteString(context, prereqs));</span>
					}
<span class="nc" id="L417">					returnSet.add(sb.toString());</span>
<span class="nc" id="L418">				}</span>
<span class="nc" id="L419">			}</span>
<span class="nc" id="L420">		}</span>
<span class="fc" id="L421">		Collection&lt;ListKey&lt;ChooseSelectionActor&lt;?&gt;&gt;&gt; addedActors = actors.getAdded();</span>
<span class="fc bfc" id="L422" title="All 2 branches covered.">		if (addedActors != null)</span>
		{
<span class="fc bfc" id="L424" title="All 2 branches covered.">			for (ListKey&lt;ChooseSelectionActor&lt;?&gt;&gt; lk : addedActors)</span>
			{
<span class="fc" id="L426">				Changes&lt;ChooseSelectionActor&lt;?&gt;&gt; cras = context.getObjectContext().getListChanges(obj, lk);</span>
<span class="fc bfc" id="L427" title="All 2 branches covered.">				for (ChooseSelectionActor&lt;?&gt; cra : cras.getAdded())</span>
				{
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">					if (getTokenName().equals(cra.getSource()))</span>
					{
						try
						{
<span class="fc" id="L433">							AbilityTargetSelector ats = (AbilityTargetSelector) cra;</span>
<span class="fc" id="L434">							StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L435">							sb.append(ats.getAbilityCategory().getLSTformat(false)).append(Constants.PIPE);</span>
<span class="fc" id="L436">							sb.append(ats.getNature()).append(Constants.PIPE).append(cra.getLstFormat());</span>
<span class="fc" id="L437">							List&lt;Prerequisite&gt; prereqs = ats.getPrerequisiteList();</span>
<span class="pc bpc" id="L438" title="1 of 4 branches missed.">							if ((prereqs != null) &amp;&amp; !prereqs.isEmpty())</span>
							{
<span class="fc" id="L440">								sb.append(Constants.PIPE);</span>
<span class="fc" id="L441">								sb.append(getPrerequisiteString(context, prereqs));</span>
							}
<span class="fc" id="L443">							returnSet.add(sb.toString());</span>
						}
<span class="nc" id="L445">						catch (PersistenceLayerException e)</span>
						{
<span class="nc" id="L447">							context.addWriteMessage(getTokenName() + &quot; encountered error: &quot; + e.getMessage());</span>
<span class="nc" id="L448">							return null;</span>
<span class="fc" id="L449">						}</span>
					}
<span class="fc" id="L451">				}</span>
<span class="fc" id="L452">			}</span>
		}
<span class="fc bfc" id="L454" title="All 2 branches covered.">		if (returnSet.isEmpty())</span>
		{
<span class="fc" id="L456">			return null;</span>
		}
<span class="fc" id="L458">		return returnSet.toArray(new String[0]);</span>
	}

	@Override
	public Class&lt;CDOMObject&gt; getTokenClass()
	{
<span class="fc" id="L464">		return CDOMObject.class;</span>
	}

	/*
	 * This is a DeferredToken because attempting to extract &quot;self&quot; out of the
	 * &quot;generic&quot; (widely shared) CHOOSE_ACTOR list is extremely difficult since
	 * the item added is not this token but a derivative object whose reference
	 * is not saved by this token. Therefore a unique list is used to store the
	 * CHOOSE_ACTORs generated by this token and they are added into the
	 * &quot;global&quot; list when load is complete - thpr Dec 15, 2012
	 */
	@Override
	public boolean process(LoadContext context, CDOMObject cdo)
	{
<span class="nc" id="L478">		List&lt;ListKey&lt;ChooseSelectionActor&lt;?&gt;&gt;&gt; lkList = cdo.getListFor(ListKey.GA_CAKEYS);</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">		if (lkList != null)</span>
		{
<span class="nc bnc" id="L481" title="All 2 branches missed.">			for (ListKey&lt;ChooseSelectionActor&lt;?&gt;&gt; lk : lkList)</span>
			{
<span class="nc" id="L483">				cdo.addAllToListFor(ListKey.NEW_CHOOSE_ACTOR, cdo.getListFor(lk));</span>
<span class="nc" id="L484">			}</span>
		}
<span class="nc" id="L486">		return true;</span>
	}

	@Override
	public Class&lt;CDOMObject&gt; getDeferredTokenClass()
	{
<span class="nc" id="L492">		return CDOMObject.class;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>