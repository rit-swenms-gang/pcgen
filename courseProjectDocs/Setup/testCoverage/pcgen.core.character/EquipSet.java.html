<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EquipSet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.core.character</a> &gt; <span class="el_source">EquipSet.java</span></div><h1>EquipSet.java</h1><pre class="source lang-java linenums">/*
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package pcgen.core.character;

import java.util.IdentityHashMap;
import java.util.Map;
import java.util.StringTokenizer;

import pcgen.cdom.base.Constants;
import pcgen.cdom.enumeration.EquipmentLocation;
import pcgen.core.BodyStructure;
import pcgen.core.BonusManager;
import pcgen.core.Equipment;
import pcgen.core.PlayerCharacter;
import pcgen.core.bonus.BonusObj;
import pcgen.core.utils.MessageType;
import pcgen.core.utils.ShowMessageDelegate;
import pcgen.facade.core.EquipmentFacade;
import pcgen.facade.util.DefaultListFacade;
import pcgen.gui2.facade.EquipNode;
import pcgen.util.Logging;

/**
 * Every item of equipment that is contained in an EquipSet has an ID with the following
 * structure.  X.Y, where X is the parent ID (and may also be a period separated list)
 * and Y is this equipment's id.  All EquipSets have 0 as their ultimate parent.
 *
 * This means that the ID for a &quot;root&quot; EquipSet looks like: 0.1
 * 0 is the parent ID,
 * 1 the equipset ID
 *
 * Each piece of equipment that is part of this EquipSet has a parent ID of 0.1
 *
 * The ID path for an Equipset that is the root of an Equipset tree
 * id_path for a &quot;root&quot; EquipSet looks like: 0.1
 * where
 * 0 == my parent (none)
 * 1 == my Id
 *
 * a Child id_path looks like this: 0.1.3
 * where
 * 0 == root
 * 1 == my parent
 * 3 == my Id
 */

/*
 * the Structure of each EQUIPSET is as follows.
 *
 * EQUIPSET: id_path : name : value : item
 *
 * id_path = a . delimited string that denotes parent/child relationship
 * name = name of EquipSet or item this represents
 (and is used to define uniquiness for compareTo)
 * value = Name of the Equipment stored in this item
 * item = Equipment item stored (optional)
 * qty = number of items this equipset contains (all same item)
 */

/**
 * {@code EquipSet.java}
 */
public final class EquipSet implements Comparable&lt;EquipSet&gt;, Cloneable
{
	/** The root path of the default equipment set. */
	public static final String DEFAULT_SET_PATH = &quot;0.1&quot;;

	private Equipment eq_item;
<span class="pc" id="L82">	private Float qty = 1.0f;</span>
<span class="pc" id="L83">	private Map&lt;BonusObj, BonusManager.TempBonusInfo&gt; tempBonusBySource = new IdentityHashMap&lt;&gt;();</span>

	private String id_path;
	private String name;
<span class="pc" id="L87">	private String note = Constants.EMPTY_STRING;</span>
<span class="pc" id="L88">	private String value = Constants.EMPTY_STRING;</span>
<span class="pc" id="L89">	private boolean useTempBonuses = true;</span>

	/** This list of equipment nodes to be displayed on the equipped tree. */
	private DefaultListFacade&lt;EquipNode&gt; nodeList;

	private Map&lt;EquipSlot, EquipNode&gt; equipSlotNodeMap;

	private Map&lt;String, EquipNode&gt; naturalWeaponNodes;

	/**
	 * Retrieve the id from a path, that is the last number in the sequence.
	 * e.g. The id of the path 0.1.17 is 17.  
	 * @param path The path to be interpreted.
	 * @return The numeric id
	 */
	public static int getIdFromPath(String path)
	{
<span class="nc" id="L106">		int id = 0;</span>

		try
		{
<span class="nc" id="L110">			final StringTokenizer aTok = new StringTokenizer(path, Constants.EQUIP_SET_PATH_SEPARATOR, false);</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">			while (aTok.hasMoreTokens())</span>
			{
<span class="nc" id="L114">				id = Integer.parseInt(aTok.nextToken());</span>
			}
		}
<span class="nc" id="L117">		catch (NullPointerException e)</span>
		{
<span class="nc" id="L119">			Logging.errorPrint(&quot;Error in EquipSet.getId &quot; + path, e);</span>
<span class="nc" id="L120">		}</span>

<span class="nc" id="L122">		return id;</span>
	}

	/**
	 * Retrieve the parent path of this path, that is the sequence without 
	 * the last number.
	 * e.g. The parent of the path 0.1.17 is 0.1  
	 * @param path The path to be interpreted.
	 * @return The parent path.
	 */
	public static String getParentPath(String path)
	{
<span class="nc" id="L134">		int idx = path.lastIndexOf(Constants.EQUIP_SET_PATH_SEPARATOR);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">		if (idx &lt; 0)</span>
		{
<span class="nc" id="L137">			return &quot;&quot;;</span>
		}

<span class="nc" id="L140">		return path.substring(0, idx);</span>
	}

	/**
	 * Retrieve the depth from a path, that is the number of numbers in the sequence.
	 * e.g. The depth of the path 0.1.17 is 3.  
	 * @param path The path to be interpreted.
	 * @return The numeric depth
	 */
	public static int getPathDepth(String path)
	{
		try
		{
<span class="nc" id="L153">			final StringTokenizer aTok = new StringTokenizer(path, Constants.EQUIP_SET_PATH_SEPARATOR, false);</span>
<span class="nc" id="L154">			return aTok.countTokens();</span>
		}
<span class="nc" id="L156">		catch (NullPointerException e)</span>
		{
<span class="nc" id="L158">			Logging.errorPrint(&quot;Error in EquipSet.getPathDepth&quot;, e);</span>
		}

<span class="nc" id="L161">		return 0;</span>
	}

	/**
	 * Constructor
	 * @param id
	 * @param aName
	 */
	public EquipSet(final String id, final String aName)
<span class="fc" id="L170">	{</span>
<span class="fc" id="L171">		id_path = id;</span>
<span class="fc" id="L172">		name = aName;</span>
<span class="fc" id="L173">	}</span>

	/**
	 * Constructor
	 * @param id
	 * @param aName
	 * @param aValue
	 * @param item
	 */
	public EquipSet(final String id, final String aName, final String aValue, final Equipment item)
<span class="nc" id="L183">	{</span>
<span class="nc" id="L184">		id_path = id;</span>
<span class="nc" id="L185">		name = aName;</span>
<span class="nc" id="L186">		value = aValue;</span>
<span class="nc" id="L187">		eq_item = item;</span>
<span class="nc" id="L188">	}</span>

	/**
	 * our Id is the last number on the id_path
	 * if id_path is &quot;0.2.8.15&quot;, our id is 15
	 * @return id
	 **/
	public int getId()
	{
<span class="nc" id="L197">		return EquipSet.getIdFromPath(id_path);</span>
	}

	/**
	 * Set ID Path
	 * @param x
	 */
	public void setIdPath(final String x)
	{
<span class="nc" id="L206">		id_path = x;</span>
<span class="nc" id="L207">	}</span>

	/**
	 * Get Id Path
	 * @return id_path
	 */
	public String getIdPath()
	{
<span class="nc" id="L215">		return id_path;</span>
	}

	/**
	 * Set Item
	 * @param item
	 */
	public void setItem(final Equipment item)
	{
<span class="nc" id="L224">		eq_item = item;</span>
<span class="nc" id="L225">	}</span>

	/**
	 * Get item
	 * @return eq_item
	 */
	public Equipment getItem()
	{
<span class="nc" id="L233">		return eq_item;</span>
	}

	/**
	 * Set name
	 * @param x
	 */
	public void setName(final String x)
	{
<span class="nc" id="L242">		name = x;</span>
<span class="nc" id="L243">	}</span>

	/**
	 * name is our EquipSet name if we are a root node
	 * or it is the name of the location for the equipment we are holding
	 * @return name
	 **/
	public String getName()
	{
<span class="nc" id="L252">		return name;</span>
	}

	/**
	 * Sets the player added note to aString
	 * @param aString
	 **/
	public void setNote(final String aString)
	{
<span class="nc" id="L261">		note = aString;</span>
<span class="nc" id="L262">	}</span>

	/**
	 * Get note
	 * @return note
	 */
	public String getNote()
	{
<span class="nc" id="L270">		return note;</span>
	}

	/**
	 * the Parent Id Path is everything except our Id
	 * if id_path is &quot;0.2.8.15&quot;, our Parent Id is &quot;0.2.8&quot;
	 * @return parent id path
	 **/
	public String getParentIdPath()
	{
<span class="nc" id="L280">		final StringBuilder buf = new StringBuilder(50);</span>

		// get all tokens and include the delimiter
		try
		{
<span class="nc" id="L285">			final StringTokenizer aTok = new StringTokenizer(id_path, Constants.EQUIP_SET_PATH_SEPARATOR, true);</span>

			// get all tokens (and delimiters) except last two
<span class="nc bnc" id="L288" title="All 2 branches missed.">			for (int i = aTok.countTokens() - 2; i &gt; 0; i--)</span>
			{
<span class="nc" id="L290">				buf.append(aTok.nextToken());</span>
			}
		}
<span class="nc" id="L293">		catch (NullPointerException e)</span>
		{
<span class="nc" id="L295">			Logging.errorPrint(&quot;Error in EquipSet.getParentIdPath&quot;, e);</span>
<span class="nc" id="L296">		}</span>

<span class="nc" id="L298">		return buf.toString();</span>
	}

	/**
	 * Set's the number of items in this equipset
	 * @param x
	 **/
	public void setQty(final Float x)
	{
<span class="nc" id="L307">		qty = x;</span>
<span class="nc" id="L308">	}</span>

	/**
	 * Get quantity
	 * @return quantity
	 */
	public Float getQty()
	{
<span class="nc" id="L316">		return qty;</span>
	}

	/**
	 * return the root id of the EquipSet
	 * If our id_path is &quot;0.2.8.15&quot;, the root would be &quot;0.2&quot;
	 * @return root id path
	 **/
	public String getRootIdPath()
	{
<span class="nc" id="L326">		final StringBuilder buf = new StringBuilder(50);</span>
<span class="nc" id="L327">		final StringTokenizer aTok = new StringTokenizer(id_path, Constants.EQUIP_SET_PATH_SEPARATOR, false);</span>
		final String result;

<span class="nc bnc" id="L330" title="All 2 branches missed.">		if (aTok.countTokens() &lt; 2)</span>
		{
<span class="nc" id="L332">			result = Constants.EMPTY_STRING;</span>
		}
		else
		{
			// get first two tokens and delimiter
<span class="nc" id="L337">			buf.append(aTok.nextToken());</span>
<span class="nc" id="L338">			buf.append('.');</span>
<span class="nc" id="L339">			buf.append(aTok.nextToken());</span>

<span class="nc" id="L341">			result = buf.toString();</span>
		}

<span class="nc" id="L344">		return result;</span>
	}

	/**
	 * Set temp bonus list
	 * @param aList
	 */
	public void setTempBonusList(final Map&lt;BonusObj, BonusManager.TempBonusInfo&gt; aList)
	{
<span class="nc" id="L353">		tempBonusBySource = aList;</span>
<span class="nc" id="L354">	}</span>

	/**
	 * a List of BonusObj's
	 * @return temp bonus list
	 **/
	public Map&lt;BonusObj, BonusManager.TempBonusInfo&gt; getTempBonusMap()
	{
<span class="nc" id="L362">		return tempBonusBySource;</span>
	}

	/**
	 * Should apply temporary bonuses to this equipset?
	 * @param aBool
	 **/
	public void setUseTempMods(final boolean aBool)
	{
<span class="nc" id="L371">		useTempBonuses = aBool;</span>
<span class="nc" id="L372">	}</span>

	/**
	 * Return TRUE if using temp mods
	 * @return TRUE if using temp mods
	 */
	public boolean getUseTempMods()
	{
<span class="nc" id="L380">		return useTempBonuses;</span>
	}

	/**
	 * Set value
	 * @param x
	 */
	public void setValue(final String x)
	{
<span class="nc" id="L389">		value = x;</span>
<span class="nc" id="L390">	}</span>

	/**
	 * value is null for root nodes or
	 * it is the name of the piece of equipment we are holding
	 * @return value
	 **/
	public String getValue()
	{
<span class="nc" id="L399">		return value;</span>
	}

	/**
	 * Clear the temp bonus list
	 */
	public void clearTempBonusList()
	{
<span class="nc" id="L407">		tempBonusBySource.clear();</span>
<span class="nc" id="L408">	}</span>

	/**
	 * Creates a duplicate of this equip set. Note that this is
	 * a deep clone - all equipment associated with this EquipSet
	 * will also be cloned.
	 *
	 * @return A new equip set, identical to this one.
	 */
	@Override
	public EquipSet clone()
	{
<span class="nc" id="L420">		EquipSet eqSet = null;</span>

		try
		{
<span class="nc" id="L424">			eqSet = (EquipSet) super.clone();</span>

<span class="nc bnc" id="L426" title="All 2 branches missed.">			if (eq_item != null)</span>
			{
<span class="nc" id="L428">				eqSet.eq_item = eq_item.clone();</span>
			}

<span class="nc bnc" id="L431" title="All 2 branches missed.">			if (qty != null)</span>
			{
<span class="nc" id="L433">				eqSet.qty = qty;</span>
			}
		}
<span class="nc" id="L436">		catch (CloneNotSupportedException exc)</span>
		{
<span class="nc" id="L438">			ShowMessageDelegate.showMessageDialog(exc.getMessage(), Constants.APPLICATION_NAME, MessageType.ERROR);</span>
<span class="nc" id="L439">		}</span>

<span class="nc" id="L441">		return eqSet;</span>
	}

	/**
	 * Compares the path ids of each object to determine relative order.
	 * 
	 * @param obj The EquipSet to compare with.
	 *  
	 * @return a negative integer, zero, or a positive integer as this EquipSet 
	 * is less than, equal to, or greater than the specified EquipSet.
	 */
	@Override
	public int compareTo(final EquipSet obj)
	{
<span class="nc" id="L455">		return id_path.compareToIgnoreCase(obj.id_path);</span>
	}

	@Override
	public String toString()
	{
<span class="nc" id="L461">		return name;</span>
	}

	/**
	 * true if temp bonus list is not empty.
	 * @return true if temp bonus list is not empty
	 */
	public boolean useTempBonusList()
	{
<span class="nc bnc" id="L470" title="All 2 branches missed.">		return !tempBonusBySource.isEmpty();</span>
	}

	/**
	 * Apply this EquipSet to a PlayerCharacter object.
	 * @param aPC the PC to equip the item on
	 */
	public void equipItem(PlayerCharacter aPC)
	{
<span class="nc" id="L479">		final StringTokenizer aTok = new StringTokenizer(getIdPath(), Constants.EQUIP_SET_PATH_SEPARATOR);</span>

		// if the eSet.getIdPath() is longer than 3
		// it's inside a container, don't try to equip
<span class="nc bnc" id="L483" title="All 2 branches missed.">		if (aTok.countTokens() &gt; Constants.ID_PATH_LENGTH_FOR_NON_CONTAINED)</span>
		{
			// Get back to carried/equipped/not carried to determine correct location
<span class="nc" id="L486">			StringBuilder rootPath = new StringBuilder(40);</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">			for (int i = 0; i &lt; Constants.ID_PATH_LENGTH_FOR_NON_CONTAINED; i++)</span>
			{
<span class="nc bnc" id="L489" title="All 2 branches missed.">				if (i &gt; 0)</span>
				{
<span class="nc" id="L491">					rootPath.append(&quot;.&quot;);</span>
				}
<span class="nc" id="L493">				rootPath.append(aTok.nextToken());</span>
			}
<span class="nc" id="L495">			EquipSet rootSet = aPC.getEquipSetByIdPath(rootPath.toString());</span>
<span class="nc bnc" id="L496" title="All 4 branches missed.">			if (rootSet != null &amp;&amp; rootSet.name.startsWith(Constants.EQUIP_LOCATION_CARRIED))</span>
			{
<span class="nc" id="L498">				eq_item.addEquipmentToLocation(qty, EquipmentLocation.CARRIED_NEITHER, false, aPC);</span>
			}
<span class="nc bnc" id="L500" title="All 4 branches missed.">			else if (rootSet != null &amp;&amp; rootSet.name.startsWith(Constants.EQUIP_LOCATION_NOTCARRIED))</span>
			{
<span class="nc" id="L502">				eq_item.addEquipmentToLocation(qty, EquipmentLocation.NOT_CARRIED, false, aPC);</span>
			}
<span class="nc bnc" id="L504" title="All 4 branches missed.">			else if (rootSet != null &amp;&amp; rootSet.name.startsWith(Constants.EQUIP_LOCATION_EQUIPPED))</span>
			{
<span class="nc" id="L506">				eq_item.addEquipmentToLocation(qty, EquipmentLocation.EQUIPPED_NEITHER, false, aPC);</span>
			}
			else
			{
<span class="nc" id="L510">				eq_item.addEquipmentToLocation(qty, EquipmentLocation.CONTAINED, false, aPC);</span>
			}
<span class="nc" id="L512">		}</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">		else if (name.startsWith(Constants.EQUIP_LOCATION_CARRIED))</span>
		{
<span class="nc" id="L515">			eq_item.addEquipmentToLocation(qty, EquipmentLocation.CARRIED_NEITHER, false, aPC);</span>
		}
<span class="nc bnc" id="L517" title="All 2 branches missed.">		else if (name.startsWith(Constants.EQUIP_LOCATION_NOTCARRIED))</span>
		{
<span class="nc" id="L519">			eq_item.addEquipmentToLocation(qty, EquipmentLocation.NOT_CARRIED, false, aPC);</span>
		}
<span class="nc bnc" id="L521" title="All 2 branches missed.">		else if (eq_item.isWeapon())</span>
		{
<span class="nc bnc" id="L523" title="All 4 branches missed.">			if (name.equals(Constants.EQUIP_LOCATION_PRIMARY) || name.equals(Constants.EQUIP_LOCATION_NATURAL_PRIMARY))</span>
			{
<span class="nc" id="L525">				eq_item.addWeaponToLocation(qty, EquipmentLocation.EQUIPPED_PRIMARY, aPC);</span>
			}
<span class="nc bnc" id="L527" title="All 2 branches missed.">			else if (name.startsWith(Constants.EQUIP_LOCATION_SECONDARY)</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">				|| name.equals(Constants.EQUIP_LOCATION_NATURAL_SECONDARY))</span>
			{
<span class="nc" id="L530">				eq_item.addWeaponToLocation(qty, EquipmentLocation.EQUIPPED_SECONDARY, aPC);</span>
			}
<span class="nc bnc" id="L532" title="All 2 branches missed.">			else if (name.equals(Constants.EQUIP_LOCATION_BOTH))</span>
			{
<span class="nc" id="L534">				eq_item.addWeaponToLocation(qty, EquipmentLocation.EQUIPPED_BOTH, aPC);</span>
			}
<span class="nc bnc" id="L536" title="All 2 branches missed.">			else if (name.equals(Constants.EQUIP_LOCATION_DOUBLE))</span>
			{
<span class="nc" id="L538">				eq_item.addWeaponToLocation(qty, EquipmentLocation.EQUIPPED_TWO_HANDS, aPC);</span>
			}
<span class="nc bnc" id="L540" title="All 2 branches missed.">			else if (name.equals(Constants.EQUIP_LOCATION_UNARMED))</span>
			{
<span class="nc" id="L542">				eq_item.addWeaponToLocation(qty, EquipmentLocation.EQUIPPED_NEITHER, aPC);</span>
			}
<span class="nc bnc" id="L544" title="All 2 branches missed.">			else if (name.equals(Constants.EQUIP_LOCATION_TWOWEAPONS))</span>
			{
<span class="nc bnc" id="L546" title="All 2 branches missed.">				Float quantity = (qty.doubleValue() &lt; 2.0) ? 2.0f : qty;</span>

<span class="nc" id="L548">				setQty(quantity);</span>
<span class="nc" id="L549">				eq_item.addWeaponToLocation(quantity, EquipmentLocation.EQUIPPED_TWO_HANDS, aPC);</span>
<span class="nc" id="L550">			}</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">			else if (name.equals(Constants.EQUIP_LOCATION_SHIELD))</span>
			{
<span class="nc" id="L553">				eq_item.addWeaponToLocation(qty, EquipmentLocation.EQUIPPED_NEITHER, aPC);</span>
			}
		}
		else
		{
<span class="nc" id="L558">			eq_item.addEquipmentToLocation(qty, EquipmentLocation.EQUIPPED_NEITHER, true, aPC);</span>
		}
<span class="nc" id="L560">	}</span>

	/**
	 * If there is a note set in this Equipment set, then add it to the contained equipment.
	 */
	public void addNoteToItem()
	{
<span class="nc" id="L567">		final String aNote = getNote();</span>

<span class="nc bnc" id="L569" title="All 4 branches missed.">		if ((aNote != null) &amp;&amp; (!aNote.isEmpty()))</span>
		{
<span class="nc" id="L571">			getItem().setNote(aNote);</span>
		}
<span class="nc" id="L573">	}</span>

	/**
	 * Is this EquipSet part of the Equipment set located at rootId.
	 *
	 * @param rootId The id to test
	 * @return true if eqSet is a child of rootId
	 */
	public boolean isPartOf(String rootId)
	{
		// rootId = 0.1.
		// parentIdPath = 0.10.
		// OR
		// rootId = 0.10.
		// parentIdPath = 0.1.
<span class="nc" id="L588">		final String abCalcId = rootId + Constants.EQUIP_SET_PATH_SEPARATOR;</span>
<span class="nc" id="L589">		final String abParentId = getParentIdPath() + Constants.EQUIP_SET_PATH_SEPARATOR;</span>

<span class="nc" id="L591">		return abParentId.startsWith(abCalcId);</span>
	}

	public DefaultListFacade&lt;EquipNode&gt; getNodeList()
	{
<span class="nc" id="L596">		return nodeList;</span>
	}

	public void setNodeList(DefaultListFacade&lt;EquipNode&gt; nodeList)
	{
<span class="nc" id="L601">		this.nodeList = nodeList;</span>
<span class="nc" id="L602">	}</span>

	public Map&lt;EquipSlot, EquipNode&gt; getEquipSlotNodeMap()
	{
<span class="nc" id="L606">		return equipSlotNodeMap;</span>
	}

	public void setEquipSlotNodeMap(Map&lt;EquipSlot, EquipNode&gt; equipSlotNodeMap)
	{
<span class="nc" id="L611">		this.equipSlotNodeMap = equipSlotNodeMap;</span>
<span class="nc" id="L612">	}</span>

	public Map&lt;String, EquipNode&gt; getNaturalWeaponNodes()
	{
<span class="nc" id="L616">		return naturalWeaponNodes;</span>
	}

	public void setNaturalWeaponNodes(Map&lt;String, EquipNode&gt; naturalWeaponNodes)
	{
<span class="nc" id="L621">		this.naturalWeaponNodes = naturalWeaponNodes;</span>
<span class="nc" id="L622">	}</span>

	/**
	 * Retrieve the preferred location for a natural weapon. Will return null
	 * for non natural weapon equipment items.
	 *
	 * @param pc which PlayerCharacter has the item
	 * @param item The equipment item to be checked.
	 * @return The preferred natural equip node, or null if not applicable.
	 */
	public EquipNode getNatWeaponLoc(PlayerCharacter pc, Equipment item)
	{
<span class="nc" id="L634">		String locName = pc.getNaturalWeaponLocation(item);</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">		if (locName != null)</span>
		{
<span class="nc" id="L637">			return naturalWeaponNodes.get(locName);</span>
		}
<span class="nc" id="L639">		return null;</span>
	}

	/**
	 * Check if the node is a valid location for the natural weapon to be equipped to.
	 * This allows primary natural weapons to be equipped to primary or secondary
	 * slots, but secondary weapons only too the secondary slot.
	 *
	 * @param node The node to be tested.
	 * @param equipment The natural weapon
	 * @param naturalLoc The natural weapon;s preferred slot.
	 * @return true if the node can take the natural weapon, false otherwise.
	 */
	public boolean validLocationForNaturalWeapon(EquipNode node, Equipment equipment, EquipNode naturalLoc)
	{
<span class="nc bnc" id="L654" title="All 2 branches missed.">		if (equipment.isPrimaryNaturalWeapon())</span>
		{
<span class="nc" id="L656">			return getNaturalWeaponNodes().containsValue(node);</span>
		}
<span class="nc" id="L658">		return node.equals(naturalLoc);</span>
	}

	public boolean canEquip(PlayerCharacter theCharacter, EquipNode node,
		Equipment item)
	{
		// Check for a required location (i.e. you can't carry a natural weapon)
<span class="nc" id="L665">		EquipNode requiredLoc = getNatWeaponLoc(theCharacter, item);</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">		if (requiredLoc != null)</span>
		{
<span class="nc" id="L668">			return validLocationForNaturalWeapon(node, item, requiredLoc);</span>
		}

		// Is this a container? Then check if the object can fit in
<span class="nc bnc" id="L672" title="All 2 branches missed.">		if (node.getNodeType() == EquipNode.NodeType.EQUIPMENT)</span>
		{
<span class="nc" id="L674">			EquipmentFacade parent = node.getEquipment();</span>
<span class="nc bnc" id="L675" title="All 4 branches missed.">			if ((parent instanceof Equipment) &amp;&amp; ((Equipment) parent).isContainer())</span>
			{
				// Check if it fits
<span class="nc bnc" id="L678" title="All 2 branches missed.">				if (((Equipment) parent).canContain(theCharacter, item) == 1)</span>
				{
<span class="nc" id="L680">					return true;</span>
				}
			}
		}

<span class="nc bnc" id="L685" title="All 2 branches missed.">		if (node.getNodeType() == EquipNode.NodeType.PHANTOM_SLOT)</span>
		{
			// Check first for an already full or taken slot
<span class="nc bnc" id="L688" title="All 2 branches missed.">			if (!getNodeList().containsElement(node))</span>
			{
<span class="nc" id="L690">				return false;</span>
			}
<span class="nc" id="L692">			EquipSlot slot = node.getSlot();</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">			if (slot.canContainType(item.getType()))</span>
			{
<span class="nc bnc" id="L695" title="All 2 branches missed.">				if (item.isWeapon())</span>
				{
<span class="nc" id="L697">					final String slotName = slot.getSlotName();</span>

<span class="nc bnc" id="L699" title="All 4 branches missed.">					if (item.isUnarmed() &amp;&amp; slotName.equals(Constants.EQUIP_LOCATION_UNARMED))</span>
					{
<span class="nc" id="L701">						return true;</span>
					}
<span class="nc bnc" id="L703" title="All 4 branches missed.">					if (item.isShield() &amp;&amp; slotName.equals(Constants.EQUIP_LOCATION_SHIELD))</span>
					{
<span class="nc" id="L705">						return true;</span>
					}

					// If it is outsized, they can't equip it to a weapon slot
<span class="nc bnc" id="L709" title="All 2 branches missed.">					if (item.isWeaponOutsizedForPC(theCharacter))</span>
					{
<span class="nc" id="L711">						return false;</span>
					}

<span class="nc bnc" id="L714" title="All 2 branches missed.">					if (slotName.startsWith(Constants.EQUIP_LOCATION_BOTH))</span>
					{
<span class="nc" id="L716">						return true;</span>
					}
<span class="nc bnc" id="L718" title="All 6 branches missed.">					if (item.isMelee() &amp;&amp; item.isDouble() &amp;&amp; slotName.equals(Constants.EQUIP_LOCATION_DOUBLE))</span>
					{
<span class="nc" id="L720">						return true;</span>
					}
<span class="nc bnc" id="L722" title="All 2 branches missed.">					if (item.isWeaponOneHanded(theCharacter))</span>
					{
<span class="nc bnc" id="L724" title="All 2 branches missed.">						if (slotName.equals(Constants.EQUIP_LOCATION_PRIMARY)</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">							|| slotName.startsWith(Constants.EQUIP_LOCATION_SECONDARY))</span>
						{
<span class="nc" id="L727">							return true;</span>
						}
					}

<span class="nc" id="L731">				}</span>
				else
				{
<span class="nc" id="L734">					return true;</span>
				}
			}
		}

		// Is this a body structure? Then check if the object be placed there
<span class="nc bnc" id="L740" title="All 2 branches missed.">		if (node.getNodeType() == EquipNode.NodeType.BODY_SLOT)</span>
		{
<span class="nc" id="L742">			BodyStructure root = node.getBodyStructure();</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">			if (root.isHoldsAnyType())</span>
			{
<span class="nc bnc" id="L745" title="All 2 branches missed.">				return !root.isForbidden(item.getTrueTypeList(false));</span>
			}
		}

		// This item can't be equipped in this location
<span class="nc" id="L750">		return false;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>