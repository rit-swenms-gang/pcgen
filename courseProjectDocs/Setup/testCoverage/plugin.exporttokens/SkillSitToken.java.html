<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SkillSitToken.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">plugin.exporttokens</a> &gt; <span class="el_source">SkillSitToken.java</span></div><h1>SkillSitToken.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2014 Tom Parker &lt;thpr@users.sourceforge.net&gt;
 * derived from export token SkillToken.java
 * Copyright 2004 (C) James Dempsey &lt;jdempsey@users.sourceforge.net&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.     See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package plugin.exporttokens;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;

import pcgen.cdom.enumeration.ListKey;
import pcgen.cdom.enumeration.ObjectKey;
import pcgen.cdom.enumeration.SkillCost;
import pcgen.cdom.enumeration.SkillFilter;
import pcgen.cdom.helper.SkillSituation;
import pcgen.core.Globals;
import pcgen.core.PCClass;
import pcgen.core.PlayerCharacter;
import pcgen.core.SettingsHandler;
import pcgen.core.Skill;
import pcgen.core.analysis.QualifiedName;
import pcgen.core.analysis.SkillInfoUtilities;
import pcgen.core.analysis.SkillModifier;
import pcgen.core.analysis.SkillRankControl;
import pcgen.core.display.SkillCostDisplay;
import pcgen.core.display.SkillDisplay;
import pcgen.io.ExportHandler;
import pcgen.io.exporttoken.SkillToken;
import pcgen.io.exporttoken.SkillToken.SkillDetails;
import pcgen.io.exporttoken.Token;
import pcgen.util.Logging;
import pcgen.util.enumeration.View;

import org.apache.commons.lang3.StringUtils;

<span class="nc" id="L52">public class SkillSitToken extends Token</span>
{
	public static final String TOKENNAME = &quot;SKILLSIT&quot;;

	// Cache the skill list as it is expensive to build
<span class="nc" id="L57">	private List&lt;Skill&gt; cachedSkillList = null;</span>
<span class="nc" id="L58">	private PlayerCharacter lastPC = null;</span>
	private int lastPCSerial;

	@Override
	public String getTokenName()
	{
<span class="nc" id="L64">		return TOKENNAME;</span>
	}

	@Override
	public String getToken(String tokenSource, PlayerCharacter pc, ExportHandler eh)
	{
<span class="nc" id="L70">		SkillDetails details = SkillToken.buildSkillDetails(tokenSource);</span>

<span class="nc" id="L72">		Object aSkill = getSkill(pc, details, eh);</span>

<span class="nc" id="L74">		return getSkillProperty(aSkill, details.getProperty(0), pc);</span>
	}

	/**
	 * Select the target skill based on the supplied criteria. Uses the
	 * id in the details object to either retrieve a skill by name or by
	 * position in the skill list.
	 *
	 * @param pc The character being processed.
	 * @param details The parsed details of the token.
	 * @param eh The ExportHandler
	 * @return The matching skill, or null if none match.
	 */
	private Object getSkill(PlayerCharacter pc, SkillDetails details, ExportHandler eh)
	{
<span class="nc" id="L89">		Object skill = null;</span>
		try
		{
<span class="nc" id="L92">			int i = Integer.parseInt(details.getSkillId());</span>
<span class="nc" id="L93">			final List&lt;Skill&gt; pcSkills = new ArrayList&lt;&gt;(getSkillList(pc));</span>

<span class="nc" id="L95">			SkillFilter filter = details.getSkillFilter();</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">			if (filter == null || filter == SkillFilter.Selected)</span>
			{
<span class="nc" id="L98">				filter = pc.getSkillFilter();</span>
			}

<span class="nc" id="L101">			Iterator&lt;Skill&gt; iter = pcSkills.iterator();</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">			while (iter.hasNext())</span>
			{
<span class="nc" id="L104">				Skill sk = iter.next();</span>
<span class="nc bnc" id="L105" title="All 4 branches missed.">				if (!pc.includeSkill(sk, filter) || !sk.qualifies(pc, null))</span>
				{
<span class="nc" id="L107">					iter.remove();</span>
				}
<span class="nc" id="L109">			}</span>

<span class="nc bnc" id="L111" title="All 6 branches missed.">			if ((i &gt;= (pcSkills.size() - 1)) &amp;&amp; eh != null &amp;&amp; eh.getExistsOnly())</span>
			{
<span class="nc" id="L113">				eh.setNoMoreItems(true);</span>
			}

<span class="nc bnc" id="L116" title="All 2 branches missed.">			for (iter = pcSkills.iterator(); i &gt;= 0;)</span>
			{
<span class="nc" id="L118">				Skill sk = iter.next();</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">				if (i == 0)</span>
				{
<span class="nc" id="L122">					return sk;</span>
				}
<span class="nc" id="L124">				i--; //wasn't the base skill</span>
<span class="nc" id="L125">				List&lt;String&gt; situations = new ArrayList&lt;&gt;(sk.getUniqueListFor(ListKey.SITUATION));</span>
<span class="nc" id="L126">				int numSits = situations.size();</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">				if (i &lt; numSits)</span>
				{
<span class="nc" id="L129">					Collections.sort(situations);</span>
				}
<span class="nc bnc" id="L131" title="All 2 branches missed.">				for (String situation : situations)</span>
				{
<span class="nc" id="L133">					double bonus = pc.getTotalBonusTo(&quot;SITUATION&quot;, sk.getKeyName() + '=' + situation);</span>
<span class="nc bnc" id="L134" title="All 4 branches missed.">					if (bonus &gt; 0.01 || bonus &lt; -0.01)</span>
					{
<span class="nc bnc" id="L136" title="All 2 branches missed.">						if (i == 0)</span>
						{
<span class="nc" id="L138">							return new SkillSituation(sk, situation, bonus);</span>
						}
<span class="nc" id="L140">						i--; //Wasn't this situation</span>
					}
<span class="nc" id="L142">				}</span>
<span class="nc" id="L143">			}</span>
		}
<span class="nc" id="L145">		catch (NumberFormatException exc)</span>
		{
<span class="nc" id="L147">			String skillName = details.getSkillId();</span>
<span class="nc" id="L148">			int equalLoc = skillName.indexOf('=');</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">			if (equalLoc == -1)</span>
			{
				//Allowing SKILL.Spot.&lt;subtoken&gt;
<span class="nc" id="L152">				skill = Globals.getContext().getReferenceContext().silentlyGetConstructedCDOMObject(Skill.class,</span>
					skillName);
			}
			else
			{
				//Allowing SKILL.Spot=Situation.&lt;subtoken&gt;
<span class="nc" id="L158">				String situation = skillName.substring(equalLoc + 1);</span>
<span class="nc" id="L159">				Skill sk = Globals.getContext().getReferenceContext().silentlyGetConstructedCDOMObject(Skill.class,</span>
<span class="nc" id="L160">					skillName.substring(0, equalLoc));</span>
<span class="nc" id="L161">				double bonus = pc.getTotalBonusTo(&quot;SITUATION&quot;, sk.getKeyName() + '=' + situation);</span>
<span class="nc" id="L162">				return new SkillSituation(sk, situation, bonus);</span>
			}
<span class="nc" id="L164">		}</span>
<span class="nc" id="L165">		return skill;</span>
	}

	private synchronized List&lt;Skill&gt; getSkillList(PlayerCharacter pc)
	{
<span class="nc bnc" id="L170" title="All 4 branches missed.">		if (pc == lastPC &amp;&amp; pc.getSerial() == lastPCSerial)</span>
		{
<span class="nc" id="L172">			return cachedSkillList;</span>
		}

<span class="nc" id="L175">		final List&lt;Skill&gt; pcSkills =</span>
<span class="nc" id="L176">				SkillDisplay.getSkillListInOutputOrder(pc, pc.getDisplay().getPartialSkillList(View.VISIBLE_EXPORT));</span>
<span class="nc" id="L177">		cachedSkillList = pcSkills;</span>
<span class="nc" id="L178">		lastPC = pc;</span>
<span class="nc" id="L179">		lastPCSerial = pc.getSerial();</span>
<span class="nc" id="L180">		return pcSkills;</span>
	}

	/**
	 * Calculate the value of the specified skill property for the
	 * supplied skill and character.
	 *
	 * @param aSkill The skill to be processed.
	 * @param property The property being processed.
	 * @param pc The character to be reported.
	 * @return The skill tag output value.
	 */
	protected String getSkillProperty(Object aSkill, String property, PlayerCharacter pc)
	{
<span class="nc bnc" id="L194" title="All 2 branches missed.">		if (aSkill == null)</span>
		{
<span class="nc" id="L196">			return &quot;&quot;;</span>
		}

<span class="nc" id="L199">		int action = SkillToken.getPropertyId(property);</span>
<span class="nc" id="L200">		return getSkillPropValue(aSkill, action, property, pc);</span>
	}

	/**
	 * Evaluate the property for the supplied skill and character. For
	 * properties such as ACP and the extended UNTRAINED property, the
	 * property text is required to be further parsed to pull out user
	 * defined text to be output in each case.
	 *
	 * @param skillSit The skill to be reported upon.
	 * @param property The property to be reported.
	 * @param propertyText The original text of the property.
	 * @param pc The character to be reported upon.
	 * @return The value of the property.
	 */
	private String getSkillPropValue(Object skillSit, int property, String propertyText, PlayerCharacter pc)
	{
<span class="nc" id="L217">		StringBuilder retValue = new StringBuilder();</span>


			Skill skill;
			boolean isSituation;
			String situation;
			SkillSituation sit;
<span class="nc bnc" id="L224" title="All 2 branches missed.">			if (skillSit instanceof Skill)</span>
			{
<span class="nc" id="L226">				sit = null;</span>
<span class="nc" id="L227">				skill = (Skill) skillSit;</span>
<span class="nc" id="L228">				isSituation = false;</span>
<span class="nc" id="L229">				situation = &quot;&quot;;</span>
			}
<span class="nc bnc" id="L231" title="All 2 branches missed.">			else if (skillSit instanceof SkillSituation)</span>
			{
<span class="nc" id="L233">				sit = (SkillSituation) skillSit;</span>
<span class="nc" id="L234">				skill = sit.getSkill();</span>
<span class="nc" id="L235">				isSituation = true;</span>
<span class="nc" id="L236">				situation = sit.getSituation();</span>
			}
			else
			{
<span class="nc" id="L240">				Logging.errorPrint(&quot;Internal Error: unexpected type: &quot; + skillSit.getClass());</span>
<span class="nc" id="L241">				return &quot;&quot;;</span>
			}
<span class="nc bnc" id="L243" title="All 19 branches missed.">		switch (property)</span>
		{
			case SkillToken.SKILL_NAME -&gt; {
<span class="nc" id="L246">				String name = QualifiedName.qualifiedName(pc, skill);</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">				if (isSituation)</span>
				{
<span class="nc" id="L249">					name += &quot; (&quot; + situation + ')';</span>
				}
<span class="nc" id="L251">				retValue.append(name);</span>
<span class="nc" id="L252">			}</span>
			case SkillToken.SKILL_TOTAL -&gt; {
<span class="nc" id="L254">				int rank = SkillRankControl.getTotalRank(pc, skill).intValue()</span>
<span class="nc" id="L255">						+ SkillModifier.modifier(skill, pc);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">				if (isSituation)</span>
				{
<span class="nc" id="L258">					rank += sit.getSituationBonus();</span>
				}
<span class="nc bnc" id="L260" title="All 2 branches missed.">				if (SettingsHandler.getGameAsProperty().get().hasSkillRankDisplayText())</span>
				{
<span class="nc" id="L262">					retValue.append(SettingsHandler.getGameAsProperty().get().getSkillRankDisplayText(rank));</span>
				}
				else
				{
<span class="nc" id="L266">					retValue.append(Integer.toString(rank));</span>
				}
<span class="nc" id="L268">			}</span>
			case SkillToken.SKILL_RANK -&gt; {
<span class="nc" id="L270">				Float sRank = SkillRankControl.getTotalRank(pc, skill);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">				if (SettingsHandler.getGameAsProperty().get().hasSkillRankDisplayText())</span>
				{
<span class="nc" id="L273">					retValue.append(SettingsHandler.getGameAsProperty()</span>
<span class="nc" id="L274">					                               .get()</span>
<span class="nc" id="L275">					                               .getSkillRankDisplayText(sRank.intValue()));</span>
				}
				else
				{
<span class="nc" id="L279">					retValue.append(SkillRankControl.getTotalRank(pc, skill).toString());</span>
				}
<span class="nc" id="L281">			}</span>
			case SkillToken.SKILL_MOD -&gt; {
<span class="nc" id="L283">				int mod = SkillModifier.modifier(skill, pc);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">				if (isSituation)</span>
				{
<span class="nc" id="L286">					mod += sit.getSituationBonus();</span>
				}
<span class="nc" id="L288">				retValue.append(Integer.toString(mod));</span>
<span class="nc" id="L289">			}</span>
<span class="nc" id="L290">			case SkillToken.SKILL_ABILITY -&gt; retValue.append(SkillInfoUtilities.getKeyStatFromStats(pc, skill));</span>
<span class="nc" id="L291">			case SkillToken.SKILL_ABMOD -&gt; retValue.append(Integer.toString(SkillModifier.getStatMod(skill, pc)));</span>
			case SkillToken.SKILL_MISC -&gt; {
<span class="nc" id="L293">				int misc = SkillModifier.modifier(skill, pc);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">				if (isSituation)</span>
				{
<span class="nc" id="L296">					misc += sit.getSituationBonus();</span>
				}
<span class="nc" id="L298">				misc -= SkillModifier.getStatMod(skill, pc);</span>
<span class="nc" id="L299">				retValue.append(Integer.toString(misc));</span>
<span class="nc" id="L300">			}</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">			case SkillToken.SKILL_UNTRAINED -&gt; retValue.append(skill.getSafe(ObjectKey.USE_UNTRAINED) ? &quot;Y&quot; : &quot;NO&quot;);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">			case SkillToken.SKILL_EXCLUSIVE -&gt; retValue.append(skill.getSafe(ObjectKey.EXCLUSIVE) ? &quot;Y&quot; : &quot;N&quot;);</span>
<span class="nc" id="L303">			case SkillToken.SKILL_UNTRAINED_EXTENDED -&gt; retValue.append(SkillToken.getUntrainedOutput(</span>
					skill,
					propertyText
			));
<span class="nc" id="L307">			case SkillToken.SKILL_ACP -&gt; retValue.append(SkillToken.getAcpOutput(skill, propertyText));</span>
			case SkillToken.SKILL_COST -&gt; {
<span class="nc" id="L309">				SkillCost cost = null;</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">				for (PCClass pcc : pc.getDisplay().getClassSet())</span>
				{
<span class="nc bnc" id="L312" title="All 2 branches missed.">					if (cost == null)</span>
					{
<span class="nc" id="L314">						cost = pc.getSkillCostForClass(skill, pcc);</span>
					}
					else
					{
<span class="nc" id="L318">						SkillCost newCost = pc.getSkillCostForClass(skill, pcc);</span>
<span class="nc bnc" id="L319" title="All 4 branches missed.">						if (SkillCost.CLASS.equals(newCost) || SkillCost.EXCLUSIVE.equals(cost))</span>
						{
<span class="nc" id="L321">							cost = newCost;</span>
						}
					}
<span class="nc bnc" id="L324" title="All 2 branches missed.">					if (SkillCost.CLASS.equals(cost))</span>
					{
<span class="nc" id="L326">						break;</span>
					}
<span class="nc" id="L328">				}</span>
<span class="nc" id="L329">				retValue.append(cost.toString());</span>
<span class="nc" id="L330">			}</span>
			case SkillToken.SKILL_EXCLUSIVE_TOTAL -&gt; {
<span class="nc" id="L332">				int etRank = SkillRankControl.getTotalRank(pc, skill).intValue();</span>
<span class="nc bnc" id="L333" title="All 6 branches missed.">				boolean b = (skill.getSafe(ObjectKey.EXCLUSIVE) || !skill.getSafe(ObjectKey.USE_UNTRAINED))</span>
						&amp;&amp; (etRank == 0);
<span class="nc bnc" id="L335" title="All 2 branches missed.">				if (b)</span>
				{
<span class="nc" id="L337">					retValue.append('0');</span>
				}
				else
				{
<span class="nc" id="L341">					int mRank = etRank + SkillModifier.modifier(skill, pc);</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">					if (isSituation)</span>
					{
<span class="nc" id="L344">						mRank += sit.getSituationBonus();</span>
					}
<span class="nc" id="L346">					retValue.append(Integer.toString(mRank));</span>
				}
<span class="nc" id="L348">			}</span>
			case SkillToken.SKILL_TRAINED_TOTAL -&gt; {
<span class="nc" id="L350">				int tRank = SkillRankControl.getTotalRank(pc, skill).intValue();</span>
<span class="nc bnc" id="L351" title="All 4 branches missed.">				boolean isNotTrained = !skill.getSafe(ObjectKey.USE_UNTRAINED) &amp;&amp; (tRank == 0);</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">				if (isNotTrained)</span>
				{
<span class="nc" id="L354">					retValue.append('0');</span>
				}
				else
				{
<span class="nc" id="L358">					int mRank = tRank + SkillModifier.modifier(skill, pc);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">					if (isSituation)</span>
					{
<span class="nc" id="L361">						mRank += sit.getSituationBonus();</span>
					}
<span class="nc" id="L363">					retValue.append(Integer.toString(mRank));</span>
				}
<span class="nc" id="L365">			}</span>
			case SkillToken.SKILL_EXPLANATION -&gt; {
<span class="nc bnc" id="L367" title="All 2 branches missed.">				boolean shortFrom = !(&quot;_LONG&quot;.equals(propertyText.substring(7)));</span>
<span class="nc" id="L368">				String bonusDetails = SkillCostDisplay.getModifierExplanation(skill, pc, shortFrom);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">				if (isSituation)</span>
				{
<span class="nc" id="L371">					String sitDetails =</span>
<span class="nc" id="L372">							SkillCostDisplay.getSituationModifierExplanation(skill, situation, pc, shortFrom);</span>
<span class="nc" id="L373">					retValue.append(bonusDetails).append(&quot; situational: &quot;).append(sitDetails);</span>
<span class="nc" id="L374">				}</span>
				else
				{
<span class="nc" id="L377">					retValue.append(bonusDetails);</span>
				}
<span class="nc" id="L379">			}</span>
			case SkillToken.SKILL_TYPE -&gt; {
<span class="nc" id="L381">				String type = skill.getType();</span>
<span class="nc" id="L382">				retValue.append(type);</span>
<span class="nc" id="L383">			}</span>
			case SkillToken.SKILL_SIZE -&gt; {
<span class="nc" id="L385">				int i = (int) (pc.getSizeAdjustmentBonusTo(&quot;SKILL&quot;, skill.getKeyName()));</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">				if (isSituation)</span>
				{
<span class="nc" id="L388">					i += pc.getSizeAdjustmentBonusTo(&quot;SITUATION&quot;, skill.getKeyName() + '=' + situation);</span>
				}
<span class="nc" id="L390">				retValue.append(Integer.toString(i));</span>
<span class="nc" id="L391">			}</span>
			case SkillToken.SKILL_CLASSES -&gt; {
<span class="nc" id="L393">				List&lt;String&gt; classes = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">				for (PCClass aClass : pc.getClassList())</span>
				{
<span class="nc bnc" id="L396" title="All 2 branches missed.">					if (pc.getSkillCostForClass(skill, aClass) == SkillCost.CLASS)</span>
					{
<span class="nc" id="L398">						classes.add(aClass.getDisplayName());</span>
					}
<span class="nc" id="L400">				}</span>
<span class="nc" id="L401">				retValue.append(StringUtils.join(classes, &quot;.&quot;));</span>
<span class="nc" id="L402">			}</span>
<span class="nc" id="L403">			default -&gt; Logging.errorPrint(</span>
					&quot;In ExportHandler._writeSkillProperty the propIdvalue &quot; + property + &quot; is not handled.&quot;);
		}

<span class="nc" id="L407">		return retValue.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>