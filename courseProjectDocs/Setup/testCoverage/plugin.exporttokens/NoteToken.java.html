<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NoteToken.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">plugin.exporttokens</a> &gt; <span class="el_source">NoteToken.java</span></div><h1>NoteToken.java</h1><pre class="source lang-java linenums">/*
 * NoteToken.java
 * Copyright 2003 (C) Devon Jones &lt;soulcatcher@evilsoft.org&gt;
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.     See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 */
package plugin.exporttokens;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.StringTokenizer;

import pcgen.core.NoteItem;
import pcgen.core.PlayerCharacter;
import pcgen.io.ExportHandler;
import pcgen.io.exporttoken.Token;

//NOTE
<span class="nc" id="L32">public class NoteToken extends Token</span>
{
	public static final String TOKENNAME = &quot;NOTE&quot;;

	@Override
	public String getTokenName()
	{
<span class="nc" id="L39">		return TOKENNAME;</span>
	}

	@Override
	public String getToken(String tokenSource, PlayerCharacter pc, ExportHandler eh)
	{
<span class="nc" id="L45">		StringTokenizer tok = new StringTokenizer(tokenSource, &quot;.&quot;);</span>
<span class="nc" id="L46">		tok.nextToken();</span>
<span class="nc" id="L47">		StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L49">		String name = tok.nextToken();</span>
<span class="nc" id="L50">		List&lt;NoteItem&gt; noteList = getNoteList(pc, name);</span>

<span class="nc" id="L52">		String beforeHeader = &quot;&lt;b&gt;&quot;;</span>
<span class="nc" id="L53">		String afterHeader = &quot;&lt;/b&gt;&lt;br/&gt;&quot;;</span>
<span class="nc" id="L54">		String beforeValue = &quot;&quot;;</span>
<span class="nc" id="L55">		String afterValue = &quot;&lt;br/&gt;&quot;;</span>
<span class="nc" id="L56">		String token = &quot;ALL&quot;;</span>

<span class="nc bnc" id="L58" title="All 2 branches missed.">		if (tok.hasMoreTokens())</span>
		{
<span class="nc" id="L60">			beforeHeader = tok.nextToken();</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">			if (&quot;NAME&quot;.equals(beforeHeader))</span>
			{
<span class="nc" id="L63">				token = &quot;NAME&quot;;</span>
<span class="nc" id="L64">				beforeHeader = afterHeader = beforeValue = afterValue = &quot;&quot;;</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">				if (tok.hasMoreTokens())</span>
				{
<span class="nc" id="L67">					beforeHeader = tok.nextToken();</span>
				}
<span class="nc bnc" id="L69" title="All 2 branches missed.">				if (tok.hasMoreTokens())</span>
				{
<span class="nc" id="L71">					afterHeader = tok.nextToken();</span>
				}
			}
<span class="nc bnc" id="L74" title="All 2 branches missed.">			else if (&quot;VALUE&quot;.equals(beforeHeader))</span>
			{
<span class="nc" id="L76">				token = &quot;VALUE&quot;;</span>
<span class="nc" id="L77">				beforeHeader = afterHeader = beforeValue = afterValue = &quot;&quot;;</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">				if (tok.hasMoreTokens())</span>
				{
<span class="nc" id="L80">					beforeValue = tok.nextToken();</span>
				}
<span class="nc bnc" id="L82" title="All 2 branches missed.">				if (tok.hasMoreTokens())</span>
				{
<span class="nc" id="L84">					afterValue = tok.nextToken();</span>
				}
			}
<span class="nc bnc" id="L87" title="All 2 branches missed.">			else if (&quot;ALL&quot;.equals(beforeHeader))</span>
			{
<span class="nc" id="L89">				token = &quot;ALL&quot;;</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">				if (tok.hasMoreTokens())</span>
				{
<span class="nc" id="L92">					beforeHeader = tok.nextToken();</span>
				}
<span class="nc bnc" id="L94" title="All 2 branches missed.">				if (tok.hasMoreTokens())</span>
				{
<span class="nc" id="L96">					afterHeader = tok.nextToken();</span>
				}
<span class="nc bnc" id="L98" title="All 2 branches missed.">				if (tok.hasMoreTokens())</span>
				{
<span class="nc" id="L100">					beforeValue = tok.nextToken();</span>
				}
<span class="nc bnc" id="L102" title="All 2 branches missed.">				if (tok.hasMoreTokens())</span>
				{
<span class="nc" id="L104">					afterValue = tok.nextToken();</span>
				}
			}
		}

<span class="nc bnc" id="L109" title="All 2 branches missed.">		for (NoteItem ni : noteList)</span>
		{
<span class="nc bnc" id="L111" title="All 4 branches missed.">			switch (token)</span>
			{
				case &quot;ALL&quot; -&gt;
						// TODO - Why doesn't this handle value the same as the VALUE token
<span class="nc" id="L115">						sb.append(ni.getExportString(beforeHeader, afterHeader, beforeValue, afterValue));</span>
<span class="nc" id="L116">				case &quot;NAME&quot; -&gt; sb.append(ni.getName());</span>
				case &quot;VALUE&quot; -&gt; {
<span class="nc" id="L118">					String internal = beforeValue + afterValue;</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">					if (&quot;&quot;.equals(internal))</span>
					{
<span class="nc" id="L121">						internal = &quot;$1&quot;;</span>
					}
<span class="nc" id="L123">					sb.append(beforeValue);</span>
<span class="nc" id="L124">					sb.append(ni.getValue().replaceAll(&quot;(\n)&quot;, internal));</span>
<span class="nc" id="L125">					sb.append(afterValue);</span>
				}
			}
<span class="nc" id="L128">		}</span>

<span class="nc" id="L130">		return sb.toString().trim();</span>
	}

	public static List&lt;NoteItem&gt; getNoteList(PlayerCharacter pc, String name)
	{
<span class="nc" id="L135">		List&lt;NoteItem&gt; noteList = new ArrayList&lt;&gt;();</span>
		List&lt;NoteItem&gt; resultList;

<span class="nc" id="L138">		buildSubTree(noteList, pc.getDisplay().getNotesList(), -1);</span>

<span class="nc bnc" id="L140" title="All 2 branches missed.">		if (&quot;ALL&quot;.equals(name))</span>
		{
<span class="nc" id="L142">			resultList = noteList;</span>
		}
		else
		{
<span class="nc" id="L146">			resultList = new ArrayList&lt;&gt;();</span>
			try
			{
<span class="nc" id="L149">				int i = Integer.parseInt(name);</span>

<span class="nc" id="L151">				resultList.add(noteList.get(i));</span>
			}
<span class="nc" id="L153">			catch (NumberFormatException e)</span>
			{
<span class="nc" id="L155">				resultList = new ArrayList&lt;&gt;(noteList);</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">				for (int i = resultList.size() - 1; i &gt;= 0; --i)</span>
				{
<span class="nc" id="L159">					final NoteItem ni = resultList.get(i);</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">					if (!ni.getName().equalsIgnoreCase(name))</span>
					{
<span class="nc" id="L163">						resultList.remove(i);</span>
					}
				}
<span class="nc" id="L166">			}</span>
		}
<span class="nc" id="L168">		return resultList;</span>
	}

	/**
	 * Populate the target list with the children of the specified node.
	 * This will recursively build up a list of the nodes in the base
	 * list in breadth-first order. &lt;br&gt;
	 * The initial call should have a parentNode of -1. This will add all
	 * children of the hard-coded base nodes.
	 *
	 * @param targetList The list to be populated.
	 * @param baseList The source list for notes
	 * @param parentNode The id of the node to be processed.
	 */
	private static void buildSubTree(List&lt;NoteItem&gt; targetList, Collection&lt;NoteItem&gt; baseList, int parentNode)
	{
<span class="nc bnc" id="L184" title="All 2 branches missed.">		for (NoteItem note : baseList)</span>
		{
<span class="nc bnc" id="L186" title="All 6 branches missed.">			if (note.getParentId() == parentNode || (parentNode == -1 &amp;&amp; note.getParentId() &lt; 0))</span>
			{
<span class="nc" id="L188">				targetList.add(note);</span>
<span class="nc" id="L189">				buildSubTree(targetList, baseList, note.getId());</span>
			}
<span class="nc" id="L191">		}</span>
<span class="nc" id="L192">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>