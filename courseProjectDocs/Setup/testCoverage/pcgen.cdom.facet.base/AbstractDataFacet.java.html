<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractDataFacet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcgen</a> &gt; <a href="index.source.html" class="el_package">pcgen.cdom.facet.base</a> &gt; <span class="el_source">AbstractDataFacet.java</span></div><h1>AbstractDataFacet.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) Thomas Parker, 2009.
 * 
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA
 */
package pcgen.cdom.facet.base;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.TreeMap;

import pcgen.base.util.ArrayUtilities;
import pcgen.cdom.base.Category;
import pcgen.cdom.base.PCGenIdentifier;
import pcgen.cdom.enumeration.Nature;
import pcgen.cdom.facet.CategorizedDataFacetChangeEvent;
import pcgen.cdom.facet.event.DataFacetChangeEvent;
import pcgen.cdom.facet.event.DataFacetChangeListener;

/**
 * A AbstractDataFacet is a DataFacet that contains information about
 * CDOMObjects that are contained in a resource. This serves the basic functions
 * of managing the DataFacetChangeListeners for a DataFacet.
 * 
 * Note that DataFacetChangeListeners registered with the AbstractDataFacet
 * through the methods in AbstractDataFacet will receive events from the
 * AbstractDataFacet in the order of the priority given during their
 * registration. DataFacetChangeListeners with a lower priority (starting with
 * Integer.MIN_VALUE) will receive events first. All DataFacetChangeListeners at
 * a given priority will receive events before DataFacetChangeListeners at a
 * higher priority.
 * 
 * Note also that AbstractDataFacet makes no guarantees as to the order in which
 * DataFacetChangeListners of the &lt;b&gt;same&lt;/b&gt; priority will receive events from
 * the AbstractDataFacet.
 * 
 * @param &lt;IDT&gt;
 *            The Type of identifier used in this AbstractDataFacet
 * @param &lt;T&gt;
 *            The Type of object stored in this AbstractDataFacet
 */
<span class="fc" id="L57">public abstract class AbstractDataFacet&lt;IDT extends PCGenIdentifier, T&gt; extends AbstractStorageFacet&lt;IDT&gt;</span>
{
<span class="fc" id="L59">	private final Map&lt;Integer, DataFacetChangeListener&lt;IDT, ? super T&gt;[]&gt; listeners = new TreeMap&lt;&gt;();</span>

	/**
	 * Adds a new DataFacetChangeListener to receive DataFacetChangeEvents
	 * (EdgeChangeEvent and NodeChangeEvent) from the source DataFacet. The
	 * given DataFacetChangeListener is added at the default priority (zero).
	 * 
	 * Note that the DataFacetChangeListeners are a list, meaning a given
	 * DataFacetChangeListener can be added more than once at a given priority,
	 * and if that occurs, it must be removed an equivalent number of times in
	 * order to no longer receive events from this AbstractDataFacet.
	 * 
	 * @param listener
	 *            The DataFacetChangeListener to receive DataFacetChangeEvents
	 *            from this AbstractDataFacet
	 */
	public void addDataFacetChangeListener(DataFacetChangeListener&lt;IDT, ? super T&gt; listener)
	{
<span class="fc" id="L77">		addDataFacetChangeListener(0, listener);</span>
<span class="fc" id="L78">	}</span>

	/**
	 * Adds a new DataFacetChangeListener to receive DataFacetChangeEvents
	 * (EdgeChangeEvent and NodeChangeEvent) from the source DataFacet.
	 * 
	 * The DataFacetChangeListener is added at the given priority.
	 * 
	 * Note that the DataFacetChangeListeners are a list, meaning a given
	 * DataFacetChangeListener can be added more than once at a given priority,
	 * and if that occurs, it must be removed an equivalent number of times in
	 * order to no longer receive events from this AbstractDataFacet.
	 * 
	 * @param priority
	 *            The lower the priority the earlier in the list the new
	 *            listener will get advised of the change.
	 * @param listener
	 *            The DataFacetChangeListener to receive DataFacetChangeEvents
	 *            from this AbstractDataFacet
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public void addDataFacetChangeListener(int priority, DataFacetChangeListener&lt;IDT, ? super T&gt; listener)
	{
<span class="fc" id="L101">		DataFacetChangeListener&lt;IDT, ? super T&gt;[] dfcl = listeners.get(priority);</span>
<span class="fc" id="L102">		dfcl = Optional.ofNullable(dfcl).orElse(new DataFacetChangeListener[0]);</span>
<span class="fc" id="L103">		listeners.put(priority, ArrayUtilities.prependOnCopy(listener, dfcl,</span>
			DataFacetChangeListener.class));
<span class="fc" id="L105">	}</span>

	/**
	 * Removes a DataFacetChangeListener so that it will no longer receive
	 * DataFacetChangeEvents from the source DataFacet. This will remove the
	 * data facet change listener from the default priority (zero).
	 * 
	 * Note that if the given DataFacetChangeListener has been registered under
	 * a different priority, it will still receive events at that priority
	 * level.
	 * 
	 * @param listener
	 *            The DataFacetChangeListener to be removed
	 */
	public void removeDataFacetChangeListener(DataFacetChangeListener&lt;IDT, ? super T&gt; listener)
	{
<span class="fc" id="L121">		removeDataFacetChangeListener(0, listener);</span>
<span class="fc" id="L122">	}</span>

	/**
	 * Removes a DataFacetChangeListener so that it will no longer receive
	 * DataFacetChangeEvents from the source DataFacet. This will remove the
	 * data facet change listener from the given priority.
	 * 
	 * Note that if the given DataFacetChangeListener has been registered under
	 * a different priority, it will still receive events at that priority
	 * level.
	 * 
	 * @param listener
	 *            The DataFacetChangeListener to be removed
	 */
	public void removeDataFacetChangeListener(int priority, DataFacetChangeListener&lt;IDT, ? super T&gt; listener)
	{
<span class="fc" id="L138">		DataFacetChangeListener&lt;IDT, ? super T&gt;[] dfcl = listeners.get(priority);</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">		if (dfcl == null)</span>
		{
			// No worries
<span class="fc" id="L142">			return;</span>
		}
<span class="fc" id="L144">		int foundLoc = -1;</span>
<span class="fc" id="L145">		int newSize = dfcl.length - 1;</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">		for (int i = newSize; i &gt;= 0; i--)</span>
		{
<span class="fc bfc" id="L148" title="All 2 branches covered.">			if (dfcl[i] == listener)</span>
			{
<span class="fc" id="L150">				foundLoc = i;</span>
<span class="fc" id="L151">				break;</span>
			}
		}
<span class="fc bfc" id="L154" title="All 2 branches covered.">		if (foundLoc != -1)</span>
		{
<span class="fc bfc" id="L156" title="All 2 branches covered.">			if (dfcl.length == 1)</span>
			{
<span class="fc" id="L158">				listeners.remove(priority);</span>
			}
			else
			{
<span class="fc" id="L162">				DataFacetChangeListener&lt;IDT, ? super T&gt;[] newArray = new DataFacetChangeListener[newSize];</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">				if (foundLoc != 0)</span>
				{
<span class="fc" id="L165">					System.arraycopy(dfcl, 0, newArray, 0, foundLoc);</span>
				}
<span class="fc bfc" id="L167" title="All 2 branches covered.">				if (foundLoc != newSize)</span>
				{
<span class="fc" id="L169">					System.arraycopy(dfcl, foundLoc + 1, newArray, foundLoc, newSize - foundLoc);</span>
				}
<span class="fc" id="L171">				listeners.put(priority, newArray);</span>
			}
		}
<span class="fc" id="L174">	}</span>

	/**
	 * Sends a NodeChangeEvent to the DataFacetChangeListeners that are
	 * receiving DataFacetChangeEvents from the source DataFacet.
	 * 
	 * @param id
	 *            The PCGenIdentifier identifying the resource to which the
	 *            NodeChangeEvent relates.
	 * @param node
	 *            The Node that has been added to or removed from the source
	 *            DataFacet for the given PCGenIdentifier
	 * @param type
	 *            An identifier indicating whether the given CDOMObject was
	 *            added to or removed from the source DataFacet
	 */
	protected void fireDataFacetChangeEvent(IDT id, T node, int type)
	{
<span class="fc" id="L192">		fireDataFacetChangeEvent(id, node, type, null, null);</span>
<span class="fc" id="L193">	}</span>

	/**
	 * Sends a NodeChangeEvent to the DataFacetChangeListeners that are
	 * receiving DataFacetChangeEvents from the source DataFacet.
	 * 
	 * @param id
	 *            The PCGenIdentifier identifying the resource to which the
	 *            NodeChangeEvent relates.
	 * @param node
	 *            The Node that has been added to or removed from the source
	 *            DataFacet for the given PCGenIdentifier
	 * @param type
	 *            An identifier indicating whether the given CDOMObject was
	 *            added to or removed from the source DataFacet
	 * @param category
	 *            The category (e.g. AbilityCategory) in which the node has been
	 *            changed.
	 * @param nature
	 *            The optional nature in which the node has been changed.
	 */
	@SuppressWarnings(&quot;rawtypes&quot;)
	protected void fireDataFacetChangeEvent(IDT id, T node, int type, Category category, Nature nature)
	{
<span class="fc bfc" id="L217" title="All 2 branches covered.">		for (DataFacetChangeListener&lt;IDT, ? super T&gt;[] dfclArray : listeners.values())</span>
		{
			/*
			 * This list is decremented from the end of the list to the
			 * beginning in order to maintain consistent operation with how Java
			 * AWT and Swing listeners are notified of Events (they are in
			 * reverse order to how they were added to the Event-owning object).
			 * This is obviously subordinate to the priority (loop above).
			 */
<span class="fc" id="L226">			DataFacetChangeEvent&lt;IDT, T&gt; ccEvent = null;</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">			for (int i = dfclArray.length - 1; i &gt;= 0; i--)</span>
			{
				// Lazily create event
<span class="fc bfc" id="L230" title="All 2 branches covered.">				if (ccEvent == null)</span>
				{
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">					if (category == null)</span>
					{
<span class="fc" id="L234">						ccEvent = new DataFacetChangeEvent&lt;&gt;(id, node, this, type);</span>
					}
					else
					{
<span class="nc" id="L238">						ccEvent = new CategorizedDataFacetChangeEvent&lt;&gt;(id, node, this, type, category, nature);</span>
					}
				}
<span class="fc" id="L241">				DataFacetChangeListener dfcl = dfclArray[i];</span>
<span class="pc bpc" id="L242" title="1 of 3 branches missed.">				switch (ccEvent.getEventType())</span>
				{
<span class="fc" id="L244">					case DataFacetChangeEvent.DATA_ADDED -&gt; dfcl.dataAdded(ccEvent);</span>
<span class="fc" id="L245">					case DataFacetChangeEvent.DATA_REMOVED -&gt; dfcl.dataRemoved(ccEvent);</span>
					default -&gt; {
					}
				}
			}
<span class="fc" id="L250">		}</span>
<span class="fc" id="L251">	}</span>

	public DataFacetChangeListener&lt;IDT, ? super T&gt;[] getDataFacetChangeListeners()
	{
<span class="nc" id="L255">		List&lt;DataFacetChangeListener&lt;IDT, ? super T&gt;&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">		for (DataFacetChangeListener&lt;IDT, ? super T&gt;[] dfclArray : listeners.values())</span>
		{
<span class="nc" id="L258">			Collections.addAll(list, dfclArray);</span>
<span class="nc" id="L259">		}</span>
<span class="nc" id="L260">		return list.toArray(new DataFacetChangeListener[0]);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>